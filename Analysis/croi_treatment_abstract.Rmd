---
title: "croi_treatment_abstract"
output: html_document
date: "2024-09-23"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

The purpose of this notebook will be to prepare results for our CROI 2025 abstract on distributing treatment for CMD.

# Load Libraries

```{r}
library(tidyverse)
library(data.table)
library(magrittr)

```

# Load data

## Baseline data
```{r}
experiment.path = "/gpfs/scratch/citrod01/experiments/MATUMAINI/CROI2025/Baseline-campaign_MATUMAINI_202305-baseline___2024_09_23_12_05_01_062691"

sim.results.baseline <- EMODAnalyzeR::read.simulation.results.bigpurple(
  experiment_path = experiment.path,
  scenario_name = "baseline",
    summarize_columns = c("Population","Infected", "On_ART",
                        "Died", "Died_from_HIV",
                        "Newly.Infected","Diagnosed"),
  stratify_columns = c("Year", "Gender", "Age", "IP_Key.CMDStatus", "CMD_Treat_staging", "CMD_Treat"),
  min_age_inclusive = 0,
  max_age_inclusive = 99
)
```


## Universal treatment data

```{r}
experiment.path = "/gpfs/scratch/citrod01/experiments/MATUMAINI/CROI2025/Baseline-campaign_MATUMAINI_202305_uni-uni___2024_09_23_12_26_37_798115"

sim.results.uni <- EMODAnalyzeR::read.simulation.results.bigpurple(
  experiment_path = experiment.path,
  scenario_name = "uni",
    summarize_columns = c("Population","Infected", "On_ART",
                        "Died", "Died_from_HIV",
                        "Newly.Infected","Diagnosed"),
  stratify_columns = c("Year", "Gender", "Age", "IP_Key.CMDStatus", "CMD_Treat_staging", "CMD_Treat"),
  min_age_inclusive = 0,
  max_age_inclusive = 99
)
```


## Status Neutral Treatment data

```{r}
experiment.path <- "/gpfs/scratch/citrod01/experiments/MATUMAINI/CROI2025/Baseline-campaign_MATUMAINI_202305_neutral-neutral___2024_09_23_12_27_43_983388"

sim.results.neutral <- EMODAnalyzeR::read.simulation.results.bigpurple(
  experiment_path = experiment.path,
  scenario_name = "neutral",
    summarize_columns = c("Population","Infected", "On_ART",
                        "Died", "Died_from_HIV",
                        "Newly.Infected","Diagnosed"),
  stratify_columns = c("Year", "Gender", "Age", "IP_Key.CMDStatus", "CMD_Treat_staging", "CMD_Treat"),
  min_age_inclusive = 0,
  max_age_inclusive = 99
)
```

## ART support treatment
```{r}
experiment.path <- "/gpfs/scratch/citrod01/experiments/MATUMAINI/CROI2025/Baseline-campaign_MATUMAINI_202305_art-art___2024_09_23_17_06_00_394696"

sim.results.art <- EMODAnalyzeR::read.simulation.results.bigpurple(
  experiment_path = experiment.path,
  scenario_name = "art",
    summarize_columns = c("Population","Infected", "On_ART",
                        "Died", "Died_from_HIV",
                        "Newly.Infected","Diagnosed"),
  stratify_columns = c("Year", "Gender", "Age", "IP_Key.CMDStatus", "CMD_Treat_staging", "CMD_Treat"),
  min_age_inclusive = 0,
  max_age_inclusive = 99
)
```

## Join data together

```{r}
sim.results.all <- rbind(sim.results.baseline,
                         sim.results.uni,
                         sim.results.neutral,
                         sim.results.art)

CENSUS_YEAR = 2009
KEN_CENSUS_POP = 5352385

sim.results.pop.scaling <- sim.results.all %>% 
      filter(Year == CENSUS_YEAR) %>%
      group_by(sim.ix, scenario_name) %>%
      summarize(total.pop = sum(Population), .groups = 'keep') %>% 
      mutate(pop.scaling.factor = KEN_CENSUS_POP/total.pop)

sim.results.all <- sim.results.all %>% 
  inner_join(
    sim.results.pop.scaling,
    by = c("sim.ix", "scenario_name")
  )
```

# Analysis - Metrics

## Prevalence over time
```{r}
plhiv.data <- sim.results.all %>% 
  #filter(Age >= 15, Age < 50) %>% 
  group_by(Year, Gender, scenario_name, sim.id) %>% 
  summarize(PLHIV = sum(Infected*pop.scaling.factor), .groups = 'keep') %>% 
  ungroup() %>% 
  mutate(Gender = case_when(Gender==0 ~ "Male", Gender==1 ~ "Female"))
  
plhiv.data.mean <- plhiv.data %>% 
  group_by(Year, Gender, scenario_name) %>% 
  summarize(PLHIV = mean(PLHIV), .groups = "keep")

p <- ggplot() +
      geom_line(data= plhiv.data.mean %>% filter(Year > 1985),
              aes(x=Year, y=PLHIV, group=scenario_name, color=scenario_name), linewidth=.5) +
    facet_wrap(~ Gender, ncol=2) +
    #xlab("Year")+
    #xlim(c(date.start, date.end)) +
    #ylab("Prevalence") +
    theme_bw(base_size=16) +
    guides(color = guide_legend(ncol = 2, byrow = TRUE, keywidth = 2, keyheight = 1)) +
    theme(legend.position="top", legend.text=element_text(size=10)) +
    scale_x_continuous(breaks = seq(1985,2050,10)) +
    theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
    theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
    #scale_y_continuous(labels = scales::percent_format(accuracy = 1), breaks = seq(0,0.25,0.05), limits=c(0, 0.25)) +
    #ylab("HIV Prevalence (%)") + 
    scale_color_manual(values=c("blue","red","darkgreen","orange","black","purple", "pink"))

p
```

```{r}
p1 <- ggplot() +
      geom_line(data= plhiv.data.mean %>% filter(Year > 2020),
              aes(x=Year, y=PLHIV, group=scenario_name, color=scenario_name), linewidth=.5) +
    facet_wrap(~ Gender, ncol=2, scales = "free_y") +
    #xlab("Year")+
    #xlim(c(date.start, date.end)) +
    #ylab("Prevalence") +
    theme_bw(base_size=16) +
    guides(color = guide_legend(ncol = 2, byrow = TRUE, keywidth = 2, keyheight = 1)) +
    theme(legend.position="top", legend.text=element_text(size=10)) +
    scale_x_continuous(breaks = seq(1985,2050,10)) +
    theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
    theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
    #scale_y_continuous(labels = scales::percent_format(accuracy = 1), breaks = seq(0,0.25,0.05), limits=c(0, 0.25)) +
    #ylab("HIV Prevalence (%)") + 
    scale_color_manual(values=c("blue","red","darkgreen","orange","black","purple", "pink"))

p1
```


## New Infections Over Time

```{r}
cases.data <- sim.results.all %>% 
  dplyr::group_by(Year, Gender, sim.id, scenario_name) %>% 
  dplyr::summarize(Newly.Infected = sum(Newly.Infected * pop.scaling.factor), .groups = "keep") %>% 
  ungroup() %>% 
  mutate(Gender = case_when(Gender==0 ~ "Male", Gender==1 ~ "Female"))

cases.data.mean <- cases.data %>% 
  group_by(Year, Gender, scenario_name) %>% 
  summarize(Newly.Infected = mean(Newly.Infected), .groups = "keep")

p <- ggplot() +
      geom_line(data= cases.data.mean %>% filter(Year > 1985),
              aes(x=Year, y= Newly.Infected, group=scenario_name, color=scenario_name), linewidth=.5) +
    facet_wrap(~ Gender, ncol=2) +
    #xlab("Year")+
    #xlim(c(date.start, date.end)) +
    #ylab("Prevalence") +
    theme_bw(base_size=16) +
    guides(color = guide_legend(ncol = 2, byrow = TRUE, keywidth = 2, keyheight = 1)) +
    theme(legend.position="top", legend.text=element_text(size=10)) +
    scale_x_continuous(breaks = seq(1985,2050,10)) +
    theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
    theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
    #scale_y_continuous(labels = scales::percent_format(accuracy = 1), breaks = seq(0,0.25,0.05), limits=c(0, 0.25)) +
    #ylab("HIV Prevalence (%)") + 
    scale_color_manual(values=c("blue","red","darkgreen","orange","black","purple", "pink"))

p
```

```{r}
p1 <- ggplot() +
      geom_line(data= cases.data.mean %>% filter(Year > 2020),
              aes(x=Year, y= Newly.Infected, group=scenario_name, color=scenario_name), linewidth=.5) +
    facet_wrap(~ Gender, ncol=2, scales = "free_y") +
    #xlab("Year")+
    #xlim(c(date.start, date.end)) +
    #ylab("Prevalence") +
    theme_bw(base_size=16) +
    guides(color = guide_legend(ncol = 2, byrow = TRUE, keywidth = 2, keyheight = 1)) +
    theme(legend.position="top", legend.text=element_text(size=10)) +
    scale_x_continuous(breaks = seq(1985,2050,10)) +
    theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
    theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
    #scale_y_continuous(labels = scales::percent_format(accuracy = 1), breaks = seq(0,0.25,0.05), limits=c(0, 0.25)) +
    #ylab("HIV Prevalence (%)") + 
    scale_color_manual(values=c("blue","red","darkgreen","orange","black","purple", "pink"))

p1
```

## HIV mortality Over Time
```{r}
hivmort.data <- sim.results.all %>% 
  dplyr::group_by(Year, Gender, sim.id, scenario_name) %>% 
  dplyr::summarize(HIV.mort = sum(Died_from_HIV * pop.scaling.factor), .groups = "keep") %>% 
  ungroup() %>% 
  mutate(Gender = case_when(Gender==0 ~ "Male", Gender==1 ~ "Female"))

hivmort.data.mean <- hivmort.data %>% 
  group_by(Year, Gender, scenario_name) %>% 
  summarize(HIV.mort = mean(HIV.mort), .groups = "keep")

p <- ggplot() +
      geom_line(data= hivmort.data.mean %>% filter(Year > 1985),
              aes(x=Year, y= HIV.mort, group=scenario_name, color=scenario_name), linewidth=.5) +
    facet_wrap(~ Gender, ncol=2) +
    #xlab("Year")+
    #xlim(c(date.start, date.end)) +
    #ylab("Prevalence") +
    theme_bw(base_size=16) +
    guides(color = guide_legend(ncol = 2, byrow = TRUE, keywidth = 2, keyheight = 1)) +
    theme(legend.position="top", legend.text=element_text(size=10)) +
    scale_x_continuous(breaks = seq(1985,2050,10)) +
    theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
    theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
    #scale_y_continuous(labels = scales::percent_format(accuracy = 1), breaks = seq(0,0.25,0.05), limits=c(0, 0.25)) +
    #ylab("HIV Prevalence (%)") + 
    scale_color_manual(values=c("blue","red","darkgreen","orange","black","purple", "pink"))

p
```
```{r}
p1 <- ggplot() +
      geom_line(data= hivmort.data.mean %>% filter(Year > 2020),
              aes(x=Year, y= HIV.mort, group=scenario_name, color=scenario_name), linewidth=.5) +
    facet_wrap(~ Gender, ncol=2, scales = "free_y") +
    #xlab("Year")+
    #xlim(c(date.start, date.end)) +
    #ylab("Prevalence") +
    theme_bw(base_size=16) +
    guides(color = guide_legend(ncol = 2, byrow = TRUE, keywidth = 2, keyheight = 1)) +
    theme(legend.position="top", legend.text=element_text(size=10)) +
    scale_x_continuous(breaks = seq(1985,2050,10)) +
    theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
    theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
    #scale_y_continuous(labels = scales::percent_format(accuracy = 1), breaks = seq(0,0.25,0.05), limits=c(0, 0.25)) +
    #ylab("HIV Prevalence (%)") + 
    scale_color_manual(values=c("blue","red","darkgreen","orange","black","purple", "pink"))

p1
```

## CMD status prevalence over time

### Number of people living with depression
```{r}
cmdpos.pop.data <- sim.results.all %>% 
  group_by(Year, Gender, sim.id, scenario_name) %>% 
  filter(IP_Key.CMDStatus == "CMD_pos") %>% 
  summarize(Population = sum(Population*pop.scaling.factor), .groups = "keep") %>% 
  # group_by(Year, Gender,scenario_name) %>% 
  # summarize(Population = mean(Population), .groups = "keep") %>% 
  ungroup()

cmdpos.pop.data.mean <- cmdpos.pop.data %>% 
  group_by(Year, Gender, scenario_name) %>% 
  summarize(Population = mean(Population), .groups = "keep") %>% ungroup()

p <- ggplot() +
      geom_line(data= cmdpos.pop.data.mean %>% filter(Year > 1985),
              aes(x=Year, y= Population, group=scenario_name, color=scenario_name), linewidth=.5) +
    facet_wrap(~ Gender, ncol=2) +
    #xlab("Year")+
    #xlim(c(date.start, date.end)) +
    #ylab("Prevalence") +
    theme_bw(base_size=16) +
    guides(color = guide_legend(ncol = 2, byrow = TRUE, keywidth = 2, keyheight = 1)) +
    theme(legend.position="top", legend.text=element_text(size=10)) +
    scale_x_continuous(breaks = seq(1985,2050,10)) +
    theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
    theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
    #scale_y_continuous(labels = scales::percent_format(accuracy = 1), breaks = seq(0,0.25,0.05), limits=c(0, 0.25)) +
    #ylab("HIV Prevalence (%)") + 
    scale_color_manual(values=c("blue","red","darkgreen","orange","black","purple", "pink"))

p

```
```{r}
p1 <- ggplot() +
      geom_line(data= cmdpos.pop.data.mean %>% filter(Year > 2019),
              aes(x=Year, y= Population, group=scenario_name, color=scenario_name), linewidth=.5) +
    facet_wrap(~ Gender, ncol=2, scales = "free_y") +
    #xlab("Year")+
    #xlim(c(date.start, date.end)) +
    #ylab("Prevalence") +
    theme_bw(base_size=16) +
    guides(color = guide_legend(ncol = 2, byrow = TRUE, keywidth = 2, keyheight = 1)) +
    theme(legend.position="top", legend.text=element_text(size=10)) +
    scale_x_continuous(breaks = seq(1985,2050,10)) +
    theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
    theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
    #scale_y_continuous(labels = scales::percent_format(accuracy = 1), breaks = seq(0,0.25,0.05), limits=c(0, 0.25)) +
    #ylab("HIV Prevalence (%)") + 
    scale_color_manual(values=c("blue","red","darkgreen","orange","black","purple", "pink"))

p1

```
### CMD status prevalence over time
```{r}
cmd.data <- sim.results.all %>% filter(Age > 18) %>% 
  mutate(HIVneg = Population - Infected) %>% 
  group_by(Year, Gender, sim.ix, IP_Key.CMDStatus, scenario_name) %>% 
  summarize(Population = sum(Population),
            HIVneg = sum(HIVneg),
            Infected = sum(Infected), .groups = 'keep') %>% 
  ungroup() %>% 
  pivot_wider(id_cols = c(Year, Gender, sim.ix, scenario_name),
              names_from = c(IP_Key.CMDStatus),
              values_from = c(Population, HIVneg, Infected))  %>% 
  mutate(Population_total = Population_CMD_pos + Population_CMD_neg + Population_CMD_recovered + Population_CMD_treated,
         HIVneg_total = HIVneg_CMD_pos + HIVneg_CMD_neg + HIVneg_CMD_recovered + HIVneg_CMD_treated,
         Infected_total = Infected_CMD_pos + Infected_CMD_neg + Infected_CMD_recovered + Infected_CMD_treated) %>% 
  mutate(CMD_prev_overall = case_when(Population_total == 0 ~ 0,
                                    Population_total > 0 ~ Population_CMD_pos/Population_total),
         CMD_prev_HIVneg = case_when(HIVneg_total == 0 ~ 0,
                                    HIVneg_total > 0 ~ HIVneg_CMD_pos/HIVneg_total),
         CMD_prev_Infected = case_when(Infected_total == 0 ~ 0,
                                    Infected_total > 0 ~ Infected_CMD_pos/Infected_total)) %>% 
  mutate(Gender = case_when(Gender==0 ~ "Male", Gender==1 ~ "Female"))

cmd.data.mean <- cmd.data %>% 
  group_by(Year, Gender, scenario_name) %>%
  summarize(Overall = mean(CMD_prev_overall), Overall_sd = sd(CMD_prev_overall),
            HIVneg = mean(CMD_prev_HIVneg), HIVneg_sd = sd(CMD_prev_HIVneg),
            Infected = mean(CMD_prev_Infected), Infected_sd = sd(CMD_prev_Infected),
            .groups = "keep") %>% 
  ungroup()
```

```{r, fig.height=10}
# Plot  
p = ggplot() +
  geom_line( data = cmd.data.mean %>% 
             filter(Year > 2020) %>% 
              select(Year, Gender, Overall, Infected, HIVneg, scenario_name) %>% 
              pivot_longer(cols = c(Overall, Infected, HIVneg),
                           names_to = "Depression.Prevalence", 
                           values_to = "CMD_prev"),
    mapping = aes(x = Year, y = CMD_prev, color = Depression.Prevalence), 
    size = 1.0) + 
  scale_y_continuous(limits = c(0.0,.22)) + 
  facet_wrap(Gender ~ scenario_name, nrow = 2) +
  xlab("Year")+ylab("") + 
  ggtitle("Depression Prevalence by HIV status") + 
  theme_bw(base_size=16) +
  guides(fill = guide_legend(keywidth = 2, keyheight = 1)) +
  scale_x_continuous(breaks = seq(1980,2040,10)) +
  theme(legend.position="bottom") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  theme(strip.background = element_rect(colour="black", fill="white")) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())

p
```


## CMD status by HIV status

# Analysis - Plots
```{r}

```
