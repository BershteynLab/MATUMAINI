---
title: "croi_treatment_abstract" output: html_document date: "2024-09-23"
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
The purpose of this notebook will be to prepare results for our CROI 2025
abstract on distributing treatment for CMD.
# Load Libraries
```{r}
library(tidyverse)
library(data.table)
library(magrittr)
library(patchwork)
library(ggpubr)

library(rsample)

```
# Load data
## Baseline data
```{r}
#experiment.path = "/gpfs/scratch/citrod01/experiments/MATUMAINI/CROI2025/Baseline-campaign_MATUMAINI_202305-baseline___2024_09_23_12_05_01_062691"
experiment.path = "/gpfs/scratch/citrod01/experiments/MATUMAINI/CROI2025/Baseline-campaign_MATUMAINI_202305-baseline___2024_09_23_17_43_09_994878"
sim.results.baseline <- EMODAnalyzeR::read.simulation.results.bigpurple(
  experiment_path = experiment.path,
  scenario_name = "baseline",
    summarize_columns = c("Population","Infected", "On_ART",
                        "Died", "Died_from_HIV",
                        "Newly.Infected","Diagnosed"),
  stratify_columns = c("Year", "Gender", "Age", "IP_Key.CMDStatus", "CMD_Treat_staging", "CMD_Treat"),
  min_age_inclusive = 0,
  max_age_inclusive = 99
)
```
## Universal treatment data
```{r}
#experiment.path = "/gpfs/scratch/citrod01/experiments/MATUMAINI/CRaOI2025/Baseline-campaign_MATUMAINI_202305_uni-uni___2024_09_23_12_26_37_798115"
experiment.path = "/gpfs/scratch/citrod01/experiments/MATUMAINI/CROI2025/Baseline-campaign_MATUMAINI_202305_uni-uni___2024_09_23_17_35_53_515585"
sim.results.uni <- EMODAnalyzeR::read.simulation.results.bigpurple(
  experiment_path = experiment.path,
  scenario_name = "uni",
    summarize_columns = c("Population","Infected", "On_ART",
                        "Died", "Died_from_HIV",
                        "Newly.Infected","Diagnosed"),
  stratify_columns = c("Year", "Gender", "Age", "IP_Key.CMDStatus", "CMD_Treat_staging", "CMD_Treat"),
  min_age_inclusive = 0,
  max_age_inclusive = 99
)
```
## Status Neutral Treatment data
```{r}
#experiment.path <- "/gpfs/scratch/citrod01/experiments/MATUMAINI/CROI2025/Baseline-campaign_MATUMAINI_202305_neutral-neutral___2024_09_23_12_27_43_983388"
experiment.path <- "/gpfs/scratch/citrod01/experiments/MATUMAINI/CROI2025/Baseline-campaign_MATUMAINI_202305_neutral-neutral___2024_09_23_17_38_27_681705"
#experiment.path <- "/gpfs/scratch/citrod01/experiments/MATUMAINI/CROI2025/Baseline-campaign_MATUMAINI_202305_neutral-neutral___2024_09_25_15_55_29_591219"

sim.results.neutral <- EMODAnalyzeR::read.simulation.results.bigpurple(
  experiment_path = experiment.path,
  scenario_name = "neutral",
    summarize_columns = c("Population","Infected", "On_ART",
                        "Died", "Died_from_HIV",
                        "Newly.Infected","Diagnosed"),
  stratify_columns = c("Year", "Gender", "Age", "IP_Key.CMDStatus", "CMD_Treat_staging", "CMD_Treat"),
  min_age_inclusive = 0,
  max_age_inclusive = 99
)
```
## ART support treatment
```{r}
#experiment.path <- "/gpfs/scratch/citrod01/experiments/MATUMAINI/CROI2025/Baseline-campaign_MATUMAINI_202305_art-art___2024_09_23_17_06_00_394696"
experiment.path <- "/gpfs/scratch/citrod01/experiments/MATUMAINI/CROI2025/Baseline-campaign_MATUMAINI_202305_art-art___2024_09_23_17_40_34_719992"

sim.results.art <- EMODAnalyzeR::read.simulation.results.bigpurple(
  experiment_path = experiment.path,
  scenario_name = "art",
    summarize_columns = c("Population","Infected", "On_ART",
                        "Died", "Died_from_HIV",
                        "Newly.Infected","Diagnosed"),
  stratify_columns = c("Year", "Gender", "Age", "IP_Key.CMDStatus", "CMD_Treat_staging", "CMD_Treat"),
  min_age_inclusive = 0,
  max_age_inclusive = 99
)
```

## Join data together
```{r}
sim.results.all <- rbind(sim.results.baseline,
                         sim.results.uni,
                         sim.results.neutral,
                         sim.results.neutral.final,
                         sim.results.art)

CENSUS_YEAR = 2009
KEN_CENSUS_POP = 5352385

sim.results.pop.scaling <- sim.results.all %>%
      filter(Year == CENSUS_YEAR) %>%
      group_by(sim.ix, scenario_name) %>%
      summarize(total.pop = sum(Population), .groups = 'keep') %>%
      mutate(pop.scaling.factor = KEN_CENSUS_POP/total.pop)
sim.results.all <- sim.results.all %>%
  inner_join(
    sim.results.pop.scaling,
    by = c("sim.ix", "scenario_name")
  )
```

# Analysis - Plots

## Prevalence over time
```{r}
plhiv.data <- sim.results.all %>%
  #filter(Age >= 15, Age < 50) %>%
  group_by(Year, Gender, scenario_name, sim.id) %>%
  summarize(PLHIV = sum(Infected*pop.scaling.factor), .groups = 'keep') %>%
  ungroup() %>%
  mutate(Gender = case_when(Gender==0 ~ "Male", Gender==1 ~ "Female"))

plhiv.data.mean <- plhiv.data %>%
  group_by(Year, Gender, scenario_name) %>%
  summarize(PLHIV = mean(PLHIV), .groups = "keep")

p <- ggplot() +
      geom_line(data= plhiv.data.mean %>% filter(Year > 1985),
              aes(x=Year, y=PLHIV, group=scenario_name, color=scenario_name), linewidth=.5) +
    facet_wrap(~ Gender, ncol=2) +
    #xlab("Year")+
    #xlim(c(date.start, date.end)) +
    #ylab("Prevalence") +
    theme_bw(base_size=16) +
    guides(color = guide_legend(ncol = 2, byrow = TRUE, keywidth = 2, keyheight = 1)) +
    theme(legend.position="top", legend.text=element_text(size=10)) +
    scale_x_continuous(breaks = seq(1985,2050,10)) +
    theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
    theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
    #scale_y_continuous(labels = scales::percent_format(accuracy = 1), breaks = seq(0,0.25,0.05), limits=c(0, 0.25)) +
    #ylab("HIV Prevalence (%)") +
    scale_color_manual(values=c("blue","red","darkgreen","orange","black","purple", "pink"))
p
```

```{r}
p1 <- ggplot() +
      geom_line(data= plhiv.data.mean %>% filter(Year > 2020),
              aes(x=Year, y=PLHIV, group=scenario_name, color=scenario_name), linewidth=.5) +
    facet_wrap(~ Gender, ncol=2, scales = "free_y") +
    #xlab("Year")+
    #xlim(c(date.start, date.end)) +
    #ylab("Prevalence") +
    theme_bw(base_size=16) +
    guides(color = guide_legend(ncol = 2, byrow = TRUE, keywidth = 2, keyheight = 1)) +
    theme(legend.position="top", legend.text=element_text(size=10)) +
    scale_x_continuous(breaks = seq(1985,2050,10)) +
    theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
    theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
    #scale_y_continuous(labels = scales::percent_format(accuracy = 1), breaks = seq(0,0.25,0.05), limits=c(0, 0.25)) +
    #ylab("HIV Prevalence (%)") +
    scale_color_manual(values=c("blue","red","darkgreen","orange","black","purple", "pink"))
p1
```
## New Infections Over Time
```{r}
cases.data <- sim.results.all %>%
  dplyr::group_by(Year, Gender, sim.id, scenario_name) %>%
  dplyr::summarize(Newly.Infected = sum(Newly.Infected * pop.scaling.factor), .groups = "keep") %>%
  ungroup() %>%
  mutate(Gender = case_when(Gender==0 ~ "Male", Gender==1 ~ "Female"))

cases.data.mean <- cases.data %>%
  group_by(Year, Gender, scenario_name) %>%
  summarize(Newly.Infected = mean(Newly.Infected), .groups = "keep")

p <- ggplot() +
      geom_line(data= cases.data.mean %>% filter(Year > 1985),
              aes(x=Year, y= Newly.Infected, group=scenario_name, color=scenario_name), linewidth=.5) +
    facet_wrap(~ Gender, ncol=2) +
    #xlab("Year")+
    #xlim(c(date.start, date.end)) +
    #ylab("Prevalence") +
    theme_bw(base_size=16) +
    guides(color = guide_legend(ncol = 2, byrow = TRUE, keywidth = 2, keyheight = 1)) +
    theme(legend.position="top", legend.text=element_text(size=10)) +
    scale_x_continuous(breaks = seq(1985,2050,10)) +
    theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
    theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
    #scale_y_continuous(labels = scales::percent_format(accuracy = 1), breaks = seq(0,0.25,0.05), limits=c(0, 0.25)) +
    #ylab("HIV Prevalence (%)") +
    scale_color_manual(values=c("blue","red","darkgreen","orange","black","purple", "pink"))
p
```

```{r}
p1 <- ggplot() +
      geom_line(data= cases.data.mean %>% filter(Year > 2020),
              aes(x=Year, y= Newly.Infected, group=scenario_name, color=scenario_name), linewidth=.5) +
    facet_wrap(~ Gender, ncol=2, scales = "free_y") +
    #xlab("Year")+
    #xlim(c(date.start, date.end)) +
    #ylab("Prevalence") +
    theme_bw(base_size=16) +
    guides(color = guide_legend(ncol = 2, byrow = TRUE, keywidth = 2, keyheight = 1)) +
    theme(legend.position="top", legend.text=element_text(size=10)) +
    scale_x_continuous(breaks = seq(1985,2050,10)) +
    theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
    theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
    #scale_y_continuous(labels = scales::percent_format(accuracy = 1), breaks = seq(0,0.25,0.05), limits=c(0, 0.25)) +
    #ylab("HIV Prevalence (%)") +
    scale_color_manual(values=c("blue","red","darkgreen","orange","black","purple", "pink"))
p1
```

## HIV mortality Over Time
```{r}
hivmort.data <- sim.results.all %>%
  dplyr::group_by(Year, Gender, sim.id, scenario_name) %>%
  dplyr::summarize(HIV.mort = sum(Died_from_HIV * pop.scaling.factor), .groups = "keep") %>%
  ungroup() %>%
  mutate(Gender = case_when(Gender==0 ~ "Male", Gender==1 ~ "Female"))

hivmort.data.mean <- hivmort.data %>%
  group_by(Year, Gender, scenario_name) %>%
  summarize(HIV.mort = mean(HIV.mort), .groups = "keep")

p <- ggplot() +
      geom_line(data= hivmort.data.mean %>% filter(Year > 1985),
              aes(x=Year, y= HIV.mort, group=scenario_name, color=scenario_name), linewidth=.5) +
    facet_wrap(~ Gender, ncol=2) +
    #xlab("Year")+
    #xlim(c(date.start, date.end)) +
    #ylab("Prevalence") +
    theme_bw(base_size=16) +
    guides(color = guide_legend(ncol = 2, byrow = TRUE, keywidth = 2, keyheight = 1)) +
    theme(legend.position="top", legend.text=element_text(size=10)) +
    scale_x_continuous(breaks = seq(1985,2050,10)) +
    theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
    theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
    #scale_y_continuous(labels = scales::percent_format(accuracy = 1), breaks = seq(0,0.25,0.05), limits=c(0, 0.25)) +
    #ylab("HIV Prevalence (%)") +
    scale_color_manual(values=c("blue","red","darkgreen","orange","black","purple", "pink"))
p
```

```{r}
p1 <- ggplot() +
      geom_line(data= hivmort.data.mean %>% filter(Year > 2020),
              aes(x=Year, y= HIV.mort, group=scenario_name, color=scenario_name), linewidth=.5) +
    facet_wrap(~ Gender, ncol=2, scales = "free_y") +
    #xlab("Year")+
    #xlim(c(date.start, date.end)) +
    #ylab("Prevalence") +
    theme_bw(base_size=16) +
    guides(color = guide_legend(ncol = 2, byrow = TRUE, keywidth = 2, keyheight = 1)) +
    theme(legend.position="top", legend.text=element_text(size=10)) +
    scale_x_continuous(breaks = seq(1985,2050,10)) +
    theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
    theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
    #scale_y_continuous(labels = scales::percent_format(accuracy = 1), breaks = seq(0,0.25,0.05), limits=c(0, 0.25)) +
    #ylab("HIV Prevalence (%)") +
    scale_color_manual(values=c("blue","red","darkgreen","orange","black","purple", "pink"))
p1
```

## CMD status

### Number of people living with depression
```{r}
cmdpos.pop.data <- sim.results.all %>%
  group_by(Year, Gender, sim.id, scenario_name) %>%
  filter(IP_Key.CMDStatus == "CMD_pos") %>%
  summarize(Population = sum(Population*pop.scaling.factor), .groups = "keep") %>%
  # group_by(Year, Gender,scenario_name) %>%
  # summarize(Population = mean(Population), .groups = "keep") %>%
  ungroup()

cmdpos.pop.data.mean <- cmdpos.pop.data %>%
  group_by(Year, Gender, scenario_name) %>%
  summarize(Population = mean(Population), .groups = "keep") %>% ungroup()

p <- ggplot() +
      geom_line(data= cmdpos.pop.data.mean %>% filter(Year > 1985),
              aes(x=Year, y= Population, group=scenario_name, color=scenario_name), linewidth=.5) +
    facet_wrap(~ Gender, ncol=2) +
    #xlab("Year")+
    #xlim(c(date.start, date.end)) +
    #ylab("Prevalence") +
    theme_bw(base_size=16) +
    guides(color = guide_legend(ncol = 2, byrow = TRUE, keywidth = 2, keyheight = 1)) +
    theme(legend.position="top", legend.text=element_text(size=10)) +
    scale_x_continuous(breaks = seq(1985,2050,10)) +
    theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
    theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
    #scale_y_continuous(labels = scales::percent_format(accuracy = 1), breaks = seq(0,0.25,0.05), limits=c(0, 0.25)) +
    #ylab("HIV Prevalence (%)") +
    scale_color_manual(values=c("blue","red","darkgreen","orange","black","purple", "pink"))


p
```

```{r}
p1 <- ggplot() +
      geom_line(data= cmdpos.pop.data.mean %>% filter(Year > 2019),
              aes(x=Year, y= Population, group=scenario_name, color=scenario_name), linewidth=.5) +
    facet_wrap(~ Gender, ncol=2, scales = "free_y") +
    #xlab("Year")+
    #xlim(c(date.start, date.end)) +
    #ylab("Prevalence") +
    theme_bw(base_size=16) +
    guides(color = guide_legend(ncol = 2, byrow = TRUE, keywidth = 2, keyheight = 1)) +
    theme(legend.position="top", legend.text=element_text(size=10)) +
    scale_x_continuous(breaks = seq(1985,2050,10)) +
    theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
    theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
    #scale_y_continuous(labels = scales::percent_format(accuracy = 1), breaks = seq(0,0.25,0.05), limits=c(0, 0.25)) +
    #ylab("HIV Prevalence (%)") +
    scale_color_manual(values=c("blue","red","darkgreen","orange","black","purple", "pink"))

p1
```

### CMD status by HIV status
```{r}
cmd.data <- sim.results.all %>% filter(Age > 18) %>%
  mutate(HIVneg = Population - Infected) %>%
  group_by(Year, Gender, sim.ix, IP_Key.CMDStatus, scenario_name) %>%
  summarize(Population = sum(Population),
            HIVneg = sum(HIVneg),
            Infected = sum(Infected), .groups = 'keep') %>%
  ungroup() %>%
  pivot_wider(id_cols = c(Year, Gender, sim.ix, scenario_name),
              names_from = c(IP_Key.CMDStatus),
              values_from = c(Population, HIVneg, Infected))  %>%
  mutate(Population_total = Population_CMD_pos + Population_CMD_neg + Population_CMD_recovered + Population_CMD_treated,
         HIVneg_total = HIVneg_CMD_pos + HIVneg_CMD_neg + HIVneg_CMD_recovered + HIVneg_CMD_treated,
         Infected_total = Infected_CMD_pos + Infected_CMD_neg + Infected_CMD_recovered + Infected_CMD_treated) %>%
  mutate(CMD_prev_overall = case_when(Population_total == 0 ~ 0,
                                    Population_total > 0 ~ Population_CMD_pos/Population_total),
         CMD_prev_HIVneg = case_when(HIVneg_total == 0 ~ 0,
                                    HIVneg_total > 0 ~ HIVneg_CMD_pos/HIVneg_total),
         CMD_prev_Infected = case_when(Infected_total == 0 ~ 0,
                                    Infected_total > 0 ~ Infected_CMD_pos/Infected_total)) %>%
  mutate(Gender = case_when(Gender==0 ~ "Male", Gender==1 ~ "Female"))

cmd.data.mean <- cmd.data %>%
  group_by(Year, Gender, scenario_name) %>%
  summarize(Overall = mean(CMD_prev_overall), Overall_sd = sd(CMD_prev_overall),
            HIVneg = mean(CMD_prev_HIVneg), HIVneg_sd = sd(CMD_prev_HIVneg),
            Infected = mean(CMD_prev_Infected), Infected_sd = sd(CMD_prev_Infected),
            .groups = "keep") %>%
  ungroup()
```

```{r, fig.height=10}
# Plot
p = ggplot() +
  geom_line( data = cmd.data.mean %>%
             filter(Year > 2020) %>%
              select(Year, Gender, Overall, Infected, HIVneg, scenario_name) %>%
              pivot_longer(cols = c(Overall, Infected, HIVneg),
                           names_to = "Depression.Prevalence",
                           values_to = "CMD_prev"),
    mapping = aes(x = Year, y = CMD_prev, color = Depression.Prevalence),
    size = 1.0) +
  scale_y_continuous(limits = c(0.0,.22)) +
  facet_wrap(Gender ~ scenario_name, nrow = 2) +
  xlab("Year")+ylab("") +
  ggtitle("Depression Prevalence by HIV status") +
  theme_bw(base_size=16) +
  guides(fill = guide_legend(keywidth = 2, keyheight = 1)) +
  scale_x_continuous(breaks = seq(1980,2040,10)) +
  theme(legend.position="bottom") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  theme(strip.background = element_rect(colour="black", fill="white")) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())

p
```

## CMD Treatment over time

```{r}
cmdtreat.count <- sim.results.all %>% 
  filter(Year >= 2020) %>% 
  group_by(Year, Gender, scenario_name, sim.ix) %>% 
  summarize(CMD_Treat = sum(CMD_Treat), .groups = 'drop_last') %>% 
  group_by(Year, Gender, scenario_name) %>% 
  summarize(CMD_Treat = mean(CMD_Treat), .groups = 'drop_last')


cmdtreat.count %>% 
  ggplot() + 
  geom_line(mapping = aes(x = Year, y = CMD_Treat, color = scenario_name)) + 
  facet_grid(cols = vars(Gender))
```


# Analysis - Metrics for the article


## How many people are living with HIV, CMD in 2025?
```{r}
sim.results.all %>% 
  filter(Year == 2025, Age >= 15) %>% 
  group_by(Gender, scenario_name, sim.ix) %>% 
  summarize(Infected = sum(Infected * pop.scaling.factor)) %>% 
  group_by(Gender,scenario_name) %>% 
  summarize(Infected = mean(Infected)) %>%
  pivot_wider(id_cols = c("scenario_name"), values_from = c("Infected"), names_from = c("Gender"),
              names_prefix = "Infected_") %>% 
  select(scenario_name, Infected_Male = Infected_0, Infected_Female = Infected_1) %>% 
  mutate(Infected = Infected_Male + Infected_Female)

```

```{r}
sim.results.all %>% 
  filter(Year == 2025, Age >= 15) %>% 
  filter(IP_Key.CMDStatus == "CMD_pos") %>% 
  group_by(Gender, scenario_name, sim.ix) %>% 
  summarize(Population = sum(Population * pop.scaling.factor)) %>% 
  group_by(Gender,scenario_name) %>% 
  summarize(Population = mean(Population)) %>%
  pivot_wider(id_cols = c("scenario_name"), values_from = c("Population"), names_from = c("Gender"),
              names_prefix = "Depressed_") %>% 
  mutate(Depressed = Depressed_0 + Depressed_1)
```

```{r}
# CMD positive, numbers living with and without HIV
sim.results.all %>% 
  filter(Year == 2025, Age >= 15) %>% 
  filter(IP_Key.CMDStatus == "CMD_pos") %>% 
  group_by(Gender, scenario_name, sim.ix) %>% 
  summarize(Infected = sum(Infected * pop.scaling.factor)) %>% 
  group_by(Gender,scenario_name) %>% 
  summarize(Infected = mean(Infected)) %>%
  pivot_wider(id_cols = c("scenario_name"), values_from = c("Infected"), names_from = c("Gender"),
              names_prefix = "Infected_") %>% 
  mutate(Infected = Infected_0 + Infected_1)
```

## Count number of depression treatments administered

```{r}
cmd.treat.count <- sim.results.all %>% 
  filter(Year >= 2025, Year <= 2035, Age >=15) %>%
  group_by(scenario_name, sim.ix) %>% 
  summarize(CMD_Treat = sum(CMD_Treat*pop.scaling.factor),
            CMD_Treat_staging = sum(CMD_Treat_staging * pop.scaling.factor)) %>% 
  group_by(scenario_name) %>% 
  summarize(CMD_Treat = mean(CMD_Treat), 
            CMD_Treat_staging = mean(CMD_Treat_staging)) %>% 
  mutate(ratio = CMD_Treat/CMD_Treat_staging)

cmd.treat.count
```


## Count episodes of depression

```{r}
depression.eps.data <- sim.results.all %>% 
  filter(Year >= 2025, Year <= 2035, Age >=15) %>%
  filter(IP_Key.CMDStatus == "CMD_pos") %>%
  group_by(scenario_name, sim.ix) %>% 
  summarize(Population = sum(Population * pop.scaling.factor)) %>% 
  group_by(scenario_name) %>% 
  summarize(Depression = mean(Population)) %>% ungroup() %>% 
  mutate(Depression_baseline = 8841653) %>% 
  mutate(Depression_averted = Depression_baseline - Depression)

depression.eps.data
```


## Count Baseline infections and deaths

Adults, between the years 2025 and 2035

```{r}
hiv.averted.data <- sim.results.all %>% 
  filter(Year >= 2025, Year <= 2035, Age >=15) %>%
  group_by(scenario_name, sim.ix) %>% 
  summarize(Died_from_HIV = sum(Died_from_HIV * pop.scaling.factor),
            Newly.Infected = sum(Newly.Infected * pop.scaling.factor)) %>% 
  group_by(scenario_name) %>%
  summarize(Died_from_HIV = mean(Died_from_HIV),
            Newly.Infected = mean(Newly.Infected)) %>% 
  mutate(Died_from_HIV_baseline = 101247.75, Newly.Infected_baseline = 136377.1) %>% 
  mutate(Died_from_HIV_averted = Died_from_HIV_baseline - Died_from_HIV,
         Newly.Infected_averted = Newly.Infected_baseline - Newly.Infected) 

hiv.averted.data
```

## Calculate deaths averted per treatment
```{r}
all.stats <- merge(hiv.averted.data, depression.eps.data, by = c("scenario_name")) %>% 
  merge(cmd.treat.count %>% select(scenario_name, CMD_Treat), by = c("scenario_name")) %>% 
  mutate(Died_from_HIV_averted.pct = Died_from_HIV_averted/Died_from_HIV_baseline,
         Newly.Infected_averted.pct = Newly.Infected_averted/Newly.Infected_baseline,
         Depression_averted.pct = Depression_averted/Depression_baseline,
         n.to.treat.infection = CMD_Treat/Newly.Infected_averted,
         n.to.treat.deaths = CMD_Treat/Died_from_HIV_averted,
         n.to.treat.dep = CMD_Treat/Depression_averted) 

all.stats %>% select(scenario_name, Newly.Infected_averted.pct, Died_from_HIV_averted.pct, Depression_averted.pct) %>% 
  pivot_longer(cols = c(Newly.Infected_averted.pct, Died_from_HIV_averted.pct, Depression_averted.pct),names_to = "values")
```

# Make Plots

I am planning a two-panel plot. 

First panel is a set of bar charts on impact of treatment

## Need to generate error bars too

```{r}
hiv.averted.data.scatter <- sim.results.all %>% 
  filter(Year >= 2025, Year <= 2035, Age >= 15) %>% 
  group_by(scenario_name, sim.ix) %>% 
  summarize(Died_from_HIV = sum(Died_from_HIV * pop.scaling.factor),
            Newly.Infected = sum(Newly.Infected * pop.scaling.factor)) %>% 
  ungroup()

hiv.averted.data.scatter <- hiv.averted.data.scatter %>% 
  merge(
    hiv.averted.data.scatter %>% filter(scenario_name == "baseline") %>% 
      select(sim.ix, Died_from_HIV_baseline = Died_from_HIV, Newly.Infected_baseline = Newly.Infected), 
    by = c("sim.ix")
  ) %>% 
  mutate(Died_from_HIV_averted = Died_from_HIV_baseline - Died_from_HIV,
         Newly.Infected_averted = Newly.Infected_baseline - Newly.Infected) %>% 
  mutate(Died_from_HIV_averted.pct = Died_from_HIV_averted/Died_from_HIV_baseline,
         Newly.Infected_averted.pct = Newly.Infected_averted/Newly.Infected_baseline)


cmd.treat.data.scatter <- sim.results.all %>% 
  filter(Year >= 2025, Year <= 2035, Age >=15) %>%
  group_by(scenario_name, sim.ix) %>% 
  summarize(CMD_Treat = sum(CMD_Treat*pop.scaling.factor),
            CMD_Treat_staging = sum(CMD_Treat_staging * pop.scaling.factor))

all.stats = all.stats %>% 
  mutate(Died_from_HIV_averted.lb = 0,
         Died_from_HIV_averted.ub = 0,
         Died_from_HIV_averted.pct.lb = 0,
         Died_from_HIV_averted.pct.ub = 0,
         Newly.Infected_averted.lb = 0,
         Newly.Infected_averted.ub = 0,
         Newly.Infected_averted.pct.lb = 0,
         Newly.Infected_averted.pct.ub = 0,
         CMD_Treat.lb = 0,
         CMD_Treat.ub = 0)
```

```{r}
bt_mean <- function(splits, colname){
  x <- as.data.frame(analysis(splits))
  mean(x[[colname]])
}

# Deaths and Infections
bt_resamples <- bootstraps(hiv.averted.data.scatter %>% filter(scenario_name == "art"), times = 500)

bt_resamples$mean.infected <- map_dbl(bt_resamples$splits, bt_mean, "Newly.Infected_averted")
bt_resamples$mean.infected.pct <- map_dbl(bt_resamples$splits, bt_mean, "Newly.Infected_averted.pct")
bt_resamples$mean.deaths<- map_dbl(bt_resamples$splits, bt_mean, "Died_from_HIV_averted")
bt_resamples$mean.deaths.pct <- map_dbl(bt_resamples$splits, bt_mean, "Died_from_HIV_averted.pct")

infected_95 <- quantile(bt_resamples$mean.infected, probs = c(.025, .975))
deaths_95 <- quantile(bt_resamples$mean.deaths, probs = c(.025, .975))
infected.pct_95 <- quantile(bt_resamples$mean.infected.pct, probs = c(.025, .975))
deaths.pct_95 <- quantile(bt_resamples$mean.deaths.pct, probs = c(.025, .975))

all.stats[all.stats$scenario_name == "art",]$Newly.Infected_averted.lb = infected_95[[1]]
all.stats[all.stats$scenario_name == "art",]$Newly.Infected_averted.ub = infected_95[[2]]
all.stats[all.stats$scenario_name == "art",]$Newly.Infected_averted.pct.lb = infected.pct_95[[1]]
all.stats[all.stats$scenario_name == "art",]$Newly.Infected_averted.pct.ub = infected.pct_95[[2]]

all.stats[all.stats$scenario_name == "art",]$Died_from_HIV_averted.lb = deaths_95[[1]]
all.stats[all.stats$scenario_name == "art",]$Died_from_HIV_averted.ub = deaths_95[[2]]
all.stats[all.stats$scenario_name == "art",]$Died_from_HIV_averted.pct.lb = deaths.pct_95[[1]]
all.stats[all.stats$scenario_name == "art",]$Died_from_HIV_averted.pct.ub = deaths.pct_95[[2]]

bt_resamples <- bootstraps(hiv.averted.data.scatter %>% filter(scenario_name == "neutral"), times = 500)

bt_resamples$mean.infected <- map_dbl(bt_resamples$splits, bt_mean, "Newly.Infected_averted")
bt_resamples$mean.infected.pct <- map_dbl(bt_resamples$splits, bt_mean, "Newly.Infected_averted.pct")
bt_resamples$mean.deaths<- map_dbl(bt_resamples$splits, bt_mean, "Died_from_HIV_averted")
bt_resamples$mean.deaths.pct <- map_dbl(bt_resamples$splits, bt_mean, "Died_from_HIV_averted.pct")

infected_95 <- quantile(bt_resamples$mean.infected, probs = c(.025, .975))
deaths_95 <- quantile(bt_resamples$mean.deaths, probs = c(.025, .975))
infected.pct_95 <- quantile(bt_resamples$mean.infected.pct, probs = c(.025, .975))
deaths.pct_95 <- quantile(bt_resamples$mean.deaths.pct, probs = c(.025, .975))

all.stats[all.stats$scenario_name == "neutral",]$Newly.Infected_averted.lb = infected_95[[1]]
all.stats[all.stats$scenario_name == "neutral",]$Newly.Infected_averted.ub = infected_95[[2]]
all.stats[all.stats$scenario_name == "neutral",]$Newly.Infected_averted.pct.lb = infected.pct_95[[1]]
all.stats[all.stats$scenario_name == "neutral",]$Newly.Infected_averted.pct.ub = infected.pct_95[[2]]

all.stats[all.stats$scenario_name == "neutral",]$Died_from_HIV_averted.lb = deaths_95[[1]]
all.stats[all.stats$scenario_name == "neutral",]$Died_from_HIV_averted.ub = deaths_95[[2]]
all.stats[all.stats$scenario_name == "neutral",]$Died_from_HIV_averted.pct.lb = deaths.pct_95[[1]]
all.stats[all.stats$scenario_name == "neutral",]$Died_from_HIV_averted.pct.ub = deaths.pct_95[[2]]

bt_resamples <- bootstraps(hiv.averted.data.scatter %>% filter(scenario_name == "uni"), times = 500)

bt_resamples$mean.infected <- map_dbl(bt_resamples$splits, bt_mean, "Newly.Infected_averted")
bt_resamples$mean.infected.pct <- map_dbl(bt_resamples$splits, bt_mean, "Newly.Infected_averted.pct")
bt_resamples$mean.deaths<- map_dbl(bt_resamples$splits, bt_mean, "Died_from_HIV_averted")
bt_resamples$mean.deaths.pct <- map_dbl(bt_resamples$splits, bt_mean, "Died_from_HIV_averted.pct")

infected_95 <- quantile(bt_resamples$mean.infected, probs = c(.025, .975))
deaths_95 <- quantile(bt_resamples$mean.deaths, probs = c(.025, .975))
infected.pct_95 <- quantile(bt_resamples$mean.infected.pct, probs = c(.025, .975))
deaths.pct_95 <- quantile(bt_resamples$mean.deaths.pct, probs = c(.025, .975))

all.stats[all.stats$scenario_name == "uni",]$Newly.Infected_averted.lb = infected_95[[1]]
all.stats[all.stats$scenario_name == "uni",]$Newly.Infected_averted.ub = infected_95[[2]]
all.stats[all.stats$scenario_name == "uni",]$Newly.Infected_averted.pct.lb = infected.pct_95[[1]]
all.stats[all.stats$scenario_name == "uni",]$Newly.Infected_averted.pct.ub = infected.pct_95[[2]]

all.stats[all.stats$scenario_name == "uni",]$Died_from_HIV_averted.lb = deaths_95[[1]]
all.stats[all.stats$scenario_name == "uni",]$Died_from_HIV_averted.ub = deaths_95[[2]]
all.stats[all.stats$scenario_name == "uni",]$Died_from_HIV_averted.pct.lb = deaths.pct_95[[1]]
all.stats[all.stats$scenario_name == "uni",]$Died_from_HIV_averted.pct.ub = deaths.pct_95[[2]]

# cmd
bt_resamples <- bootstraps(cmd.treat.data.scatter %>% filter(scenario_name == "art"), times = 500)
bt_resamples$mean.cmd <- map_dbl(bt_resamples$splits, bt_mean, "CMD_Treat")
cmd_95 <- quantile(bt_resamples$mean.cmd, probs = c(.025, .975))
all.stats[all.stats$scenario_name == "art",]$CMD_Treat.lb = cmd_95[[1]]
all.stats[all.stats$scenario_name == "art",]$CMD_Treat.ub = cmd_95[[2]]

bt_resamples <- bootstraps(cmd.treat.data.scatter %>% filter(scenario_name == "neutral"), times = 500)
bt_resamples$mean.cmd <- map_dbl(bt_resamples$splits, bt_mean, "CMD_Treat")
cmd_95 <- quantile(bt_resamples$mean.cmd, probs = c(.025, .975))
all.stats[all.stats$scenario_name == "neutral",]$CMD_Treat.lb = cmd_95[[1]]
all.stats[all.stats$scenario_name == "neutral",]$CMD_Treat.ub = cmd_95[[2]]

bt_resamples <- bootstraps(cmd.treat.data.scatter %>% filter(scenario_name == "uni"), times = 500)
bt_resamples$mean.cmd <- map_dbl(bt_resamples$splits, bt_mean, "CMD_Treat")
cmd_95 <- quantile(bt_resamples$mean.cmd, probs = c(.025, .975))
all.stats[all.stats$scenario_name == "uni",]$CMD_Treat.lb = cmd_95[[1]]
all.stats[all.stats$scenario_name == "uni",]$CMD_Treat.ub = cmd_95[[2]]

all.stats
```


## Impact of treatment
```{r}
p <- all.stats %>% 
  mutate(scenario_ix = case_match(scenario_name, "baseline" ~ 0, "uni" ~ 1, "neutral" ~ 2, "art" ~ 3)) %>% 
  select(scenario_ix,scenario_name, Depression_averted.pct) %>% 
  filter(scenario_name %in% c("uni", "neutral", "art")) %>% 
  pivot_longer(cols = c(Depression_averted.pct), names_to = "metric") %>% 
  ggplot() +
  geom_bar(mapping = aes(x = metric, y = value*100, fill = factor(scenario_name)),
           position=position_dodge2(reverse = TRUE, padding = 0), stat = "identity") + 
  scale_y_continuous(breaks = seq(0,50,10), labels = c("0%", "10%", "20%", "30%", "40%","50%"), expand = expansion(mult = c(0.00,.1))) +
  scale_fill_manual("", values = c("#00671F", "#FF6600", "#0004E7"),
                    breaks = c("uni", "neutral", "art"), 
                    labels = c("Universal", "Status Neutral   ", "ART")) + 
  scale_x_discrete(breaks=c("Depression_averted.pct"),
                   labels=c("Depression Episodes")) + 
  theme_minimal() + theme_bw() +
  theme(panel.grid = element_blank(),
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        axis.text.x = element_blank(),
        legend.position = "top")
# + 
#   guides(fill=guide_legend("Depression Treatment Distribution"))

all.stats.plot <- all.stats %>% 
  mutate(scenario_ix = case_match(scenario_name, "baseline" ~ 0, "uni" ~ 1, "neutral" ~ 2, "art" ~ 3)) %>% 
  select(scenario_ix,scenario_name, Newly.Infected_averted.pct, Died_from_HIV_averted.pct) %>% 
  filter(scenario_name %in% c("uni", "neutral", "art")) %>% 
  pivot_longer(cols = c(Newly.Infected_averted.pct, Died_from_HIV_averted.pct), names_to = "metric", values_to = "mean") %>% 
  merge(
    all.stats %>% 
      mutate(scenario_ix = case_match(scenario_name, "baseline" ~ 0, "uni" ~ 1, "neutral" ~ 2, "art" ~ 3)) %>% 
      select(scenario_ix,scenario_name, Newly.Infected_averted.pct.lb, Died_from_HIV_averted.pct.lb) %>% 
      filter(scenario_name %in% c("uni", "neutral", "art")) %>% 
      mutate(Newly.Infected_averted.pct = Newly.Infected_averted.pct.lb,
             Died_from_HIV_averted.pct = Died_from_HIV_averted.pct.lb) %>% 
      select(scenario_ix, scenario_name, Newly.Infected_averted.pct,Died_from_HIV_averted.pct) %>% 
      pivot_longer(cols = c(Newly.Infected_averted.pct, Died_from_HIV_averted.pct), names_to = "metric", values_to =  "lb"),
    by = c("scenario_ix", "scenario_name", "metric")
  ) %>% 
  merge(
    all.stats %>% 
      mutate(scenario_ix = case_match(scenario_name, "baseline" ~ 0, "uni" ~ 1, "neutral" ~ 2, "art" ~ 3)) %>% 
      select(scenario_ix,scenario_name, Newly.Infected_averted.pct.ub, Died_from_HIV_averted.pct.ub) %>% 
      filter(scenario_name %in% c("uni", "neutral", "art")) %>% 
      mutate(Newly.Infected_averted.pct = Newly.Infected_averted.pct.ub,
             Died_from_HIV_averted.pct = Died_from_HIV_averted.pct.ub) %>% 
      select(scenario_ix, scenario_name, Newly.Infected_averted.pct,Died_from_HIV_averted.pct) %>% 
      pivot_longer(cols = c(Newly.Infected_averted.pct, Died_from_HIV_averted.pct), names_to = "metric", values_to =  "ub"),
    by = c("scenario_ix", "scenario_name", "metric")
  ) 


p1 <- all.stats.plot %>% 
  ggplot() +
  geom_bar(mapping = aes(x = metric, y = mean*100, fill = factor(scenario_name)),
           position=position_dodge2(reverse = TRUE, padding = 0), stat = "identity",
           show.legend = FALSE) + 
  geom_errorbar(mapping = aes(x = metric, ymin = lb*100, ymax = ub*100),
                position=position_dodge2(reverse = TRUE, padding = .25), stat = "identity",
                size = 1, color = "black",
                show.legend = FALSE) + 
  #geom_label(mapping = aes(x = metric, y = value*100, label = metric)) + 
  #geom_text(mapping = aes(x = 1, y = 4.1, label = "HIV Deaths Averted")) + 
  #geom_text(mapping = aes(x = 2, y = 7, label = "HIV Infections Averted")) + 
  scale_y_continuous(
    "% Averted",
    breaks = seq(0,10,2), 
    labels = c("0%", "2%", "4%", "6%", "8%","10%"), 
    expand = expansion(mult = c(0.00,.2))) +
  scale_fill_manual("", values = c("#00671F", "#FF6600", "#0004E7"),
                    breaks = c("uni", "neutral", "art"), 
                    labels = c("Universal", "Status Neutral   ", "ART")) + 
  scale_x_discrete( 
    breaks=c("Newly.Infected_averted.pct", "Died_from_HIV_averted.pct"),
    labels=c("HIV Infections", "HIV Deaths"),
      expand = expansion(mult = c(.6,.6))) +
  #ggtitle("HIV Outcome Improvements\nvs. Depression Treatment Strategy") + 
  theme_minimal() + theme_bw() +
  theme(panel.grid = element_blank(),
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        axis.text.x = element_blank(),
        legend.position = "bottom",
        plot.title = element_text(hjust = 0.5),
        text = element_text(family = "sans"))

p1 
# + 
#   guides(fill=guide_legend("Depression Treatment Distribution"))

#ggsave("croi2025_abstract_figure_v3_panel1.pdf", p1, width = 6, height = 6, units = "in")

```

```{r}
p1
```

```{r}
ggarrange(p, p1,  ncol=2, nrow=1, common.legend = TRUE, legend="top", widths = c(1,2))

```


## Efficiency frontier

```{r}
p2 <- all.stats %>% 
  mutate(scenario_id = case_match(scenario_name, "baseline" ~ "", "uni" ~ "Universal", "neutral" ~ "Status Neutral", "art" ~ "ART")) %>% 
  ggplot() +  
  geom_line(all.stats %>% filter(scenario_name != "neutral"),
            mapping = aes(x = CMD_Treat, y = Died_from_HIV_averted)) + 
  geom_point(mapping = aes(x = CMD_Treat, y = Died_from_HIV_averted, color = scenario_name), show.legend = FALSE,
             size = 3) + 
  geom_errorbar(all.stats %>% filter(scenario_name != "baseline"),
                mapping = aes(x = CMD_Treat, ymin = Died_from_HIV_averted.lb, ymax = Died_from_HIV_averted.ub)) + 
  # geom_errorbar(all.stats %>% filter(scenario_name != "baseline"),
  #               mapping = aes(xmin = CMD_Treat.lb, xmax = CMD_Treat.ub,  y = Died_from_HIV_averted)) + 
  #geom_text(mapping = aes(x = CMD_Treat, y = Died_from_HIV_averted, label = scenario_id),
  #          position = position_dodge(width = 1),  vjust =  -0.75) + 
  #ggtitle("HIV Outcome Improvements\nvs. Depression Treatments Administered") + 
  scale_color_manual("", values = c("black", "#00671F", "#FF6600", "#0004E7"),
                  breaks = c("baseline", "uni", "neutral", "art"), 
                  labels = c("", "Universal", "Status Neutral   ", "ART")) +
  scale_y_continuous(
    "HIV Infections Averted",
    breaks = seq(0,4000,1000), labels = seq(0,4000, 1000), expand = expansion(mult = c(0.01,.1))) +   scale_x_continuous(
    "Depression Treatments Administered", breaks = seq(0,4000000, 1000000), labels = c(0, "1M", "2M", "3M", "4M" ),
    expand = expansion(mult = c(0.01, .2))
  ) + 
  theme_minimal() + theme_bw() +
  theme(panel.grid = element_blank(),
        axis.title.x = element_blank(),
        axis.text.x = element_blank(),
        plot.title = element_text(hjust = 0.5),
        text = element_text(family = "sans"))


p3 <- all.stats %>% 
  mutate(scenario_id = case_match(scenario_name, "baseline" ~ "", "uni" ~ "Universal", "neutral" ~ "Status Neutral", "art" ~ "ART")) %>% 
  ggplot() +  
  geom_line(all.stats %>% filter(scenario_name != "neutral"),
            mapping = aes(x = CMD_Treat, y = Newly.Infected_averted)) + 
  geom_point(mapping = aes(x = CMD_Treat, y = Newly.Infected_averted, color = scenario_name), show.legend = FALSE,
             size = 3) + 
  geom_errorbar(all.stats %>% filter(scenario_name != "baseline"),
                mapping = aes(x = CMD_Treat, ymin = Newly.Infected_averted.lb, ymax = Newly.Infected_averted.ub)) + 
  # geom_text(mapping = aes(x = CMD_Treat, y = Newly.Infected_averted, label = scenario_id),
  #           position = position_dodge(width = 1),  vjust = -0.75) + 
  scale_color_manual("", values = c("black", "#00671F", "#FF6600", "#0004E7"),
                  breaks = c("baseline", "uni", "neutral", "art"), 
                  labels = c("", "Universal", "Status Neutral   ", "ART")) +
  scale_y_continuous(
    "HIV Deaths Averted",
    breaks = seq(0,10000,2000), labels = seq(0,10000, 2000), expand = expansion(mult = c(0.01,.1))) + 
  scale_x_continuous(
    "Depression Treatments Administered", breaks = seq(0,4000000, 1000000), labels = c(0, "1M", "2M", "3M", "4M" ),
    expand = expansion(mult = c(0.01, .2))
  ) + 
  theme_minimal() + theme_bw() +
  theme(panel.grid = element_blank(),
        plot.title = element_text(hjust = 0.5),
        text = element_text(family = "sans")
        )

p2/p3

#ggsave("croi2025_abstract_figure_v3_panel2.pdf", p2/p3, width = 6, height = 6, units = "in")
```

```{r}
p.final <- ggarrange(p1, (p2/p3), legend="top")
p.final

#ggsave("croi2025_abstract_figure_v2.pdf", p.final, width = 12, height = 6, units = "in")
```

