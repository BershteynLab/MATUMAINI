---
title: "impact_manuscript_figures.Rmd"
output: html_document
date: "2025-02-05"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


# Introduction

The purpose of this document is to build on the analysis that was done previously in 

* impact_manuscript_analysis.Rmd
* IAS_2025_Abstract_Impact.Rmd

in order to produce camera-ready metrics and figures for the upcoming manuscript 
on the impact and cost-effectiveness of depression treatment

## Load Libraries

```{r Load Libraries, echo = FALSE}
library(tidyverse)
library(data.table)
library(magrittr)
library(rsample)
library(readxl)
library(devtools)
library(ggpubr)
library(patchwork)

devtools::install_github("BershteynLab/EMODAnalyzeR", force = TRUE)
```

## Define some functions

### Confidence intervals
```{r}
# Confidence interval functions
lower_ci <- function(mean, se, n, conf_level = 0.95){
  lower_ci <- mean - qt(1 - ((1 - conf_level) / 2), n - 1) * se
  return(lower_ci)
}
upper_ci <- function(mean, se, n, conf_level = 0.95){
  upper_ci <- mean + qt(1 - ((1 - conf_level) / 2), n - 1) * se
  return(upper_ci)
}
```

### Bootstrapping
```{r}
bt_mean <- function(splits, colname){
  x <- as.data.frame(analysis(splits))
  mean(x[[colname]])
}

calculate.CI.by.metric = function(data, scenario.name, metric, n = 500){
  bt_resamples <- bootstraps(data %>% filter(scenario_name == scenario.name), times = n)
  
  bt_resamples$mean.metric <- map_dbl(bt_resamples$splits, bt_mean, metric)
  metric_95 <- quantile(bt_resamples$mean.metric, probs = c(0.025, 0.975))
  
  return(
      data.frame(
      scenario_name = scenario.name, 
      metric = metric,
      metric.mean = mean(bt_resamples$mean.metric),
      metric.lb = metric_95[[1]], 
      metric.ub = metric_95[[2]]
    )
  )
}
```

# Read data

Going to do this a little differently from before - I am going to loop over a 
dictionary of scenarios and accompanying file paths, and save the related data into a folder

## Lists of scenarios and file paths
```{r}
scenarios.list = data.frame(
  scenario_name = c(
    "baseline",
    "uni",
    "neutral",
    "art",
    "ceta"
  ),
  file.path = c(
    "/gpfs/scratch/citrod01/experiments/MATUMAINI/CMD_Impact/Baseline-campaign_MATUMAINI_202305-baseline___2025_02_09_10_17_34_073143",
    "/gpfs/scratch/citrod01/experiments/MATUMAINI/CMD_Impact/Baseline-campaign_MATUMAINI_202305_uni-uni___2025_02_02_16_05_18_568334",
    "/gpfs/scratch/citrod01/experiments/MATUMAINI/CMD_Impact/Baseline-campaign_MATUMAINI_202305_neutral_annual-annual___2025_02_01_20_12_50_699336",
    "/gpfs/scratch/citrod01/experiments/MATUMAINI/CMD_Impact/Baseline-campaign_MATUMAINI_202305_art-art___2025_02_01_20_18_16_484638",
    "/gpfs/scratch/citrod01/experiments/MATUMAINI/CMD_Impact/Baseline-campaign_MATUMAINI_202305_art_ceta-art_ceta___2025_02_01_20_15_44_165500"
  )
) %>% 
  mutate(scenario_ix = row_number())

```

## Load scenario
```{r}
scenario.ix = 5
scenarios.list %>% filter(scenario_ix == scenario.ix)
```


```{r}
experiment.path = scenarios.list[scenarios.list$scenario_ix == scenario.ix,]$file.path
scenario.name = scenarios.list[scenarios.list$scenario_ix == scenario.ix,]$scenario_name

sim.results <- NULL

sim.results <- EMODAnalyzeR::read.simulation.results.bigpurple(
  experiment_path = experiment.path,
  scenario_name = scenario.name,
    summarize_columns = c("Population","Infected", "On_ART",
                        "Died", "Died_from_HIV",
                        "Newly.Infected","Diagnosed",
                       "CMD_Treat_staging", "CMD_Treat", "CMD_Incidence2", "CMD_Relapse2"),
  stratify_columns = c("Year", "Gender", "Age", "IP_Key.CMDStatus"),
  min_age_inclusive = 0,
  max_age_inclusive = 99
)

CENSUS_YEAR = 2020.5
KEN_CENSUS_POP = 6953951

sim.results.pop.scaling <- sim.results %>%
    filter(Year == CENSUS_YEAR) %>%
    group_by(sim.ix, scenario_name) %>%
    summarize(total.pop = sum(Population), .groups = 'drop_last') %>%
    mutate(pop_scaling_factor = KEN_CENSUS_POP/total.pop)

sim.results <- sim.results %>%
  inner_join(
    sim.results.pop.scaling,
    by = c("sim.ix", "scenario_name")
  )
```

## Extract Metrics

List of metrics:

For scenarios Baseline, Uni, Neutral/Annual, ART, CETA:

* Population over Time
* HIV prevalence over time
* HIV new infections over time
* HIV mortality over time
* Depression episodes over time
* CMD prevalence over time
* CMD treatments over time
* CEAC curve

For all scenarios

* HIV infections averted (compare to baseline)
* HIV deaths averted
* Person-years on ART averted
* Depression episodes averted
* Depression treatments
* HIV-related DALYs averted
* Depression-related DALYs averted
* Total DALYs averted
* ICER

### Extract time series

```{r}

```


### Time series metrics

```{r}
scenario.name = 'art'
sim.results <- sim.results.all %>% filter(scenario_name == scenario.name)
```


```{r}
time.series.metrics <- sim.results %>% 
  filter(Year >= 2025.5, Age >= 15) %>% 
  mutate(Year = ceiling(Year) - 1) %>% 
  group_by(Year, sim.ix, scenario_name) %>% 
  summarize(Population = sum(Population*pop_scaling_factor)/2,
            PLHIV = sum(Infected * pop_scaling_factor)/2,
            Diagnosed = sum(Diagnosed * pop_scaling_factor)/2,
            On_ART = sum(On_ART * pop_scaling_factor)/2,
            Newly.Infected = sum(Newly.Infected * pop_scaling_factor),
            Died_from_HIV = sum(Died_from_HIV * pop_scaling_factor),
            Depression.episodes = sum( (CMD_Incidence2 + CMD_Relapse2) * pop_scaling_factor),
            CMD_Treat_staging = sum(CMD_Treat_staging * pop_scaling_factor), 
            CMD_Treat = sum(CMD_Treat * pop_scaling_factor), 
            .groups = 'drop_last'
  ) %>% 
  ungroup() %>% 
  merge(
    sim.results %>% 
      filter(Year >= 2025.5, IP_Key.CMDStatus == 'CMD_pos') %>% 
      mutate(Year = ceiling(Year) - 1) %>% 
      group_by(Year, sim.ix, scenario_name) %>% 
      summarize(CMD_pos = sum(Population*pop_scaling_factor)/2, .groups = 'drop_last') %>% 
      ungroup(),
    by = c("Year", "sim.ix", "scenario_name")
  )

```

### DALY calculation

#### HIV DALYs

```{r}
data_by_age_year <- sim.results %>%
  filter(Year >= 2025.5) %>% 
  dplyr::group_by(Year, Age, sim.ix, scenario_name) %>%
  dplyr::summarise(
    Died_from_HIV = sum(Died_from_HIV),
     Infected = sum(Infected),
     On_ART = sum(On_ART),
     pop_scaling_factor = mean(pop_scaling_factor),
     .groups = "drop_last"
   )

data_by_age_year$Year_Integer <- floor((data_by_age_year$Year-0.5))

m2 <- data_by_age_year %>%
        dplyr::group_by(Year_Integer, Age, sim.ix, scenario_name) %>%
        dplyr::summarise(
          Died_from_HIV = sum(Died_from_HIV),
          Infected = mean(Infected),
          On_ART = mean(On_ART),
          pop_scaling_factor = mean(pop_scaling_factor),
          .groups = "drop_last"
         )

m2 <- m2 %>%
        mutate(On_ART_calib = On_ART*pop_scaling_factor,
        Infected_calib = Infected*pop_scaling_factor,
        Died_from_HIV_calib = Died_from_HIV*pop_scaling_factor,
        Infected_off_ART_calib = (Infected - On_ART)*pop_scaling_factor)

life_expectancy = 80
m2$Age <- ifelse(m2$Age >life_expectancy, life_expectancy, m2$Age)

m3 <- m2 %>%
      dplyr::group_by(Year_Integer, Age, scenario_name, sim.ix) %>%
      dplyr::select(Year_Integer, Age, scenario_name, sim.ix, 
                    Died_from_HIV_calib, Infected_off_ART_calib, On_ART_calib) %>%
      dplyr::summarise_all(list(median=median))

disability.tibble <- m3 %>%
  dplyr::group_by(Year_Integer, scenario_name, sim.ix) %>%
  dplyr::summarize(
    infected_untreated = sum(Infected_off_ART_calib_median),
    on_art = sum(On_ART_calib_median)
    ) %>%
  dplyr::rename(year = Year_Integer)

m4 <- m3 %>% mutate(year_applied = Year_Integer - (Age - (life_expectancy + 1)))

daly.tibble <- merge(
  tibble(scenario_name_ = scenario.name),
  tibble(
    year = seq(min(m4$Year_Integer), max(m4$Year_Integer))
  ),
  all = TRUE
) %>% 
  merge(  tibble(sim.ix = seq(1,10)), all=TRUE)

daly_expanded <- tibble(
    year = seq(min(m4$Year_Integer), max(m4$Year_Integer))
  ) %>% 
  crossing(
    sim.ix = unique(m4$sim.ix),
    scenario_name = unique(m4$scenario_name)
  )

yll <- daly_expanded %>%
  left_join(m4, by = c("sim.ix", "scenario_name")) %>%
  filter(Year_Integer <= year, year_applied > year) %>%
  group_by(year, sim.ix, scenario_name) %>%
  summarize(
    yll = sum(Died_from_HIV_calib_median, na.rm = TRUE),
    .groups = "drop"
  )

daly = left_join(
  yll, 
  disability.tibble, 
  by=c("year", "sim.ix", "scenario_name")
  ) %>%
 replace(is.na(.), 0)

discount_percent = 0.03
discount_start_year = 2025
infected_weight = 0.274
art_weight = 0.078

daly <- daly %>% mutate(daly = infected_untreated*infected_weight + on_art*art_weight + yll)
daly <- daly %>% mutate(discount_factor = (1 - discount_percent)^(year - discount_start_year) )
daly[daly$year < discount_start_year,'discount_factor'] <- 1.0
daly <- daly %>% mutate(daly_future_discounted = daly*discount_factor )

HIV.DALYs <- daly %>% select(Year = year, 
                sim.ix,
                HIV.DALY = daly,
                HIV.DALY.discounted = daly_future_discounted)

```


#### Depression-related DALYs

```{r}
Depression.DALYs <- sim.results %>% 
  filter(Year >= 2025.5, IP_Key.CMDStatus == "CMD_pos") %>% 
  mutate(Year_Integer = floor(Year-0.5)) %>% 
  group_by(Year_Integer, sim.ix, scenario_name) %>% 
  summarize(Depressed = sum(Population * pop_scaling_factor), .groups = 'drop_last') %>% 
  ungroup()

Depression.DALYs <- Depression.DALYs %>% 
  mutate(discount_factor = (1 - 0.03)^(pmax(Year_Integer - 2025, 0)) ) %>% 
  mutate(Depression.YLD = Depressed/2) %>% 
  mutate(Depression.DALY = 0.396*Depression.YLD*discount_factor/2)

Depression.DALYs <- Depression.DALYs %>% 
  select(Year = Year_Integer, sim.ix, Depression.DALY)
```

### Join together and save

```{r}
sim.results.metrics <- time.series.metrics %>% 
  merge(HIV.DALYs,
        by = c("Year", 'sim.ix')) %>% 
  merge(Depression.DALYs,
        by = c("Year", 'sim.ix'))

 write_csv(sim.results.metrics, 
          paste0("Impact_Manuscript_Figures/Time_Series_data_for_figures/sim_results_metrics_",scenario.name,".csv"))
```


# Metrics

## Load data

```{r, echo = FALSE}

sim.results.treatment <- rbind(
  read_csv("Impact_Manuscript_Figures/Time_Series_data_for_figures/sim_results_metrics_baseline.csv"),
  read_csv("Impact_Manuscript_Figures/Time_Series_data_for_figures/sim_results_metrics_uni.csv"),
  read_csv("Impact_Manuscript_Figures/Time_Series_data_for_figures/sim_results_metrics_neutral.csv"),
  read_csv("Impact_Manuscript_Figures/Time_Series_data_for_figures/sim_results_metrics_art.csv"),
  read_csv("Impact_Manuscript_Figures/Time_Series_data_for_figures/sim_results_metrics_ceta.csv")
  )


```

## Calculate metrics

In the year 2025

1. Population
2. PLHIV
3. Number of people on ART
4. People with depression

```{r}
metric.names = c(
  "Population",
  "PLHIV",
  "On_ART",
  "CMD_pos"
)

scenario.names = sim.results.treatment$scenario_name %>% unique 

metrics.2025 = data.frame()

for (i in metric.names){
  for (j in scenario.names) {
    
    #print(c(i,j))
    h <- calculate.CI.by.metric(
      data = sim.results.treatment %>% filter(Year == 2025),
      scenario.name = j,
      metric = i)
    
    metrics.2025 = rbind(metrics.2025, h)
  }
}

metrics.2025
```


Between the years 2025-2035

1. New HIV infections
2. HIV related deaths
3. Person years lived on ART
4. Depression episodes
5. Depression treatments administered
6. HIV-related DALYs
7. Depression-related DALYs
8. Total DALYs

```{r}
data.2025.2035 <- sim.results.treatment %>% 
  group_by(scenario_name, sim.ix)  %>% 
  summarise(Newly.Infected = sum(Newly.Infected),
            Died_from_HIV = sum(Died_from_HIV),
            On_ART = sum(On_ART),
            Depression.episodes = sum(Depression.episodes),
            CMD_pos = sum(CMD_pos),
            CMD_Treat_staging = sum(CMD_Treat_staging),
            HIV.DALY = sum(HIV.DALY.discounted),
            Depression.DALY = sum(Depression.DALY),
            Total.DALY = sum(HIV.DALY + Depression.DALY)) %>% ungroup()

metric.names = c(
  "Newly.Infected",
  "Died_from_HIV",
  "On_ART",
  "Depression.episodes",
  "CMD_Treat_staging",
  "HIV.DALY",
  "Depression.DALY",
  "Total.DALY"
)

scenario.names = sim.results.treatment$scenario_name %>% unique 

metrics.2025.3035 = data.frame()

for (i in metric.names){
  for (j in scenario.names) {
    
    #print(c(i,j))
    h <- calculate.CI.by.metric(
      data = data.2025.2035,
      scenario.name = j,
      metric = i)
    
    metrics.2025.3035 = rbind(metrics.2025.3035, h)
  }
}

metrics.2025.3035
```

## Calculate Impact

Between the years 2025-2035

* Number of new HIV acquisitions
* Number of HIV-related deaths
* Person-years on ART
* Number of depression episodes
* HIV-related DALYs
* Depression-related DALYs

```{r}
hiv.averted.stats <- sim.results.treatment %>% 
  filter(Year >= 2025) %>%
  group_by(scenario_name, sim.ix) %>% 
  summarize(
    Newly.Infected = sum(Newly.Infected),
    Died_from_HIV = sum(Died_from_HIV),
    On_ART = sum(On_ART),
    Depression.episodes = sum(Depression.episodes),
    CMD_pos = sum(CMD_pos),
    HIV.DALY = sum(HIV.DALY.discounted),
    Depression.DALY = sum(Depression.DALY),
    .groups = 'drop_last') %>% 
  ungroup() %>% 
  mutate(Total.DALY = HIV.DALY + Depression.DALY)

hiv.averted.stats.baseline <- sim.results.treatment %>% 
  filter(Year >= 2025, scenario_name == 'baseline') %>%
  group_by(scenario_name, sim.ix) %>% 
  summarize(
    Newly.Infected.baseline = sum(Newly.Infected),
    Died_from_HIV.baseline = sum(Died_from_HIV),
    On_ART.baseline = sum(On_ART),
    Depression.episodes.baseline = sum(Depression.episodes),
    CMD_pos.baseline = sum(CMD_pos),
    HIV.DALY.baseline = sum(HIV.DALY.discounted),
    Depression.DALY.baseline = sum(Depression.DALY),
    .groups = 'drop_last') %>% 
  ungroup() %>% 
  mutate(Total.DALY.baseline = HIV.DALY.baseline + Depression.DALY.baseline)

hiv.averted.stats <- hiv.averted.stats %>% 
  merge(
    hiv.averted.stats.baseline[-1], 
    by = c("sim.ix")
  ) %>% 
  mutate(
    Died_from_HIV.averted = Died_from_HIV.baseline - Died_from_HIV,
    Newly.Infected.averted = Newly.Infected.baseline - Newly.Infected,
    On_ART.averted = On_ART.baseline - On_ART,
    Depression.episodes.averted = Depression.episodes.baseline - Depression.episodes,
    CMD_pos.averted = CMD_pos.baseline - CMD_pos,
    HIV.DALY.averted = HIV.DALY.baseline - HIV.DALY,
    Depression.DALY.averted = Depression.DALY.baseline - Depression.DALY,
    Total.DALY.averted = Total.DALY.baseline - Total.DALY
    ) %>% 
  mutate(
    Died_from_HIV.averted.pct = Died_from_HIV.averted/Died_from_HIV.baseline,
    Newly.Infected.averted.pct = Newly.Infected.averted/Newly.Infected.baseline,
    On_ART.averted.pct = On_ART.averted/On_ART.baseline,
    Depression.episodes.averted.pct = Depression.episodes.averted/Depression.episodes.baseline,
    CMD_pos.averted.pct = CMD_pos.averted/CMD_pos.baseline,
    HIV.DALY.averted.pct = HIV.DALY.averted/HIV.DALY.baseline,
    Depression.DALY.averted.pct = Depression.DALY.averted/Depression.DALY.baseline,
    Total.DALY.averted.pct = Total.DALY.averted/Total.DALY.baseline
  )

metric.names = c(
  "Died_from_HIV.averted",
  "Died_from_HIV.averted.pct",
  "Newly.Infected.averted",
  "Newly.Infected.averted.pct",
  "On_ART.averted",
  "On_ART.averted.pct",
  "Depression.episodes.averted",
  "Depression.episodes.averted.pct",
  "CMD_pos.averted",
  "CMD_pos.averted.pct",
  "HIV.DALY.averted",
  "HIV.DALY.averted.pct",
  "Depression.DALY.averted", 
  "Depression.DALY.averted.pct",
  "Total.DALY.averted",
  "Total.DALY.averted.pct"
)

scenario_names = hiv.averted.stats$scenario_name %>% unique 

metrics = data.frame()

for (i in metric.names){
  for (j in scenario_names) {
    
    #print(c(i,j))
    h <- calculate.CI.by.metric(
      data = hiv.averted.stats, 
      scenario.name = j,
      metric = i)
    
    metrics = rbind(metrics, h)
  }
}

HIV.Depression.Averted.Data <- metrics
```

## Calculate ICERs

### Cost parameters

```{r}
cost.onart = 319
cost.treatment = 14

```


What is the incremental cost of ART?
```{r}
cost.art.marginal <- metrics.2025.3035 %>% filter(metric == 'On_ART') %>% 
  mutate(On_ART.baseline = metrics.2025.3035 %>% filter(metric == 'On_ART', scenario_name == 'baseline') %>% .$metric.mean) %>% 
  mutate(On_ART.marginal = metric.mean - On_ART.baseline) %>% 
  mutate(On_ART.cost = On_ART.marginal * cost.onart) %>% 
  select(scenario_name, On_ART.cost)

cost.art.marginal
```


```{r}
HIV.Depression.Averted.Data %>% filter(metric == "HIV.DALY.averted") %>% 
  merge(
    metrics.2025.3035 %>% filter(metric == 'CMD_Treat_staging') %>% 
      select(scenario_name, treatments.mean = metric.mean),
    by = c('scenario_name')
  ) %>% 
  merge(
    cost.art.marginal, by = c("scenario_name")
  ) %>% 
  mutate(cost.mean = cost.treatment*treatments.mean) %>% 
  mutate(cost.total = cost.mean + On_ART.cost) %>% 
  mutate(ICER.HIV.mean = cost.total/metric.mean,
         ICER.HIV.lb = cost.total/metric.lb,
         ICER.HIV.ub = cost.total/metric.ub)

HIV.Depression.Averted.Data %>% filter(metric == "Total.DALY.averted") %>% 
  merge(
    metrics.2025.3035 %>% filter(metric == 'CMD_Treat_staging') %>% 
      select(scenario_name, treatments.mean = metric.mean),
    by = c('scenario_name')
  ) %>% 
  merge(
    cost.art.marginal, by = c("scenario_name")
  ) %>% 
  mutate(cost.mean = cost.treatment*treatments.mean) %>% 
  mutate(cost.total = cost.mean + On_ART.cost) %>% 
  mutate(ICER.total.mean = cost.total/metric.mean,
         ICER.total.lb = cost.total/metric.lb,
         ICER.total.ub = cost.total/metric.ub)

```


## Save

```{r}
HIV.Depression.Averted.Data %>% write_csv("Impact_Manuscript_Figures/HIV_Depression_Averted_Data.csv")

rbind(metrics.2025, metrics.2025.3035) %>% write_csv("Impact_Manuscript_Figures/HIV_Depression_Data.csv")
``` 

# Figures

## Figure 1: Time Series

### Load data

```{r}
sim.results.baseline <- EMODAnalyzeR::read.simulation.results.bigpurple(
  experiment_path = "/gpfs/scratch/citrod01/experiments/MATUMAINI/CMD_Impact/Baseline-campaign_MATUMAINI_202305-baseline___2025_02_09_10_17_34_073143",
  scenario_name = "baseline",
    summarize_columns = c("Population","Infected", "On_ART",
                        "Died", "Died_from_HIV",
                        "Newly.Infected","Diagnosed",
                       "CMD_Treat_staging", "CMD_Treat", "CMD_Incidence2", "CMD_Relapse2"),
  stratify_columns = c("Year", "Gender", "Age", "IP_Key.CMDStatus"),
  min_age_inclusive = 0,
  max_age_inclusive = 99
)

sim.results.uni <- EMODAnalyzeR::read.simulation.results.bigpurple(
  experiment_path = "/gpfs/scratch/citrod01/experiments/MATUMAINI/CMD_Impact/Baseline-campaign_MATUMAINI_202305_uni-uni___2025_02_02_16_05_18_568334",
  scenario_name = "uni",
    summarize_columns = c("Population","Infected", "On_ART",
                        "Died", "Died_from_HIV",
                        "Newly.Infected","Diagnosed",
                       "CMD_Treat_staging", "CMD_Treat", "CMD_Incidence2", "CMD_Relapse2"),
  stratify_columns = c("Year", "Gender", "Age", "IP_Key.CMDStatus"),
  min_age_inclusive = 0,
  max_age_inclusive = 99
)

sim.results.neutral <- EMODAnalyzeR::read.simulation.results.bigpurple(
  experiment_path = "/gpfs/scratch/citrod01/experiments/MATUMAINI/CMD_Impact/Baseline-campaign_MATUMAINI_202305_neutral_annual-annual___2025_02_01_20_12_50_699336",
  scenario_name = "neutral",
    summarize_columns = c("Population","Infected", "On_ART",
                        "Died", "Died_from_HIV",
                        "Newly.Infected","Diagnosed",
                       "CMD_Treat_staging", "CMD_Treat", "CMD_Incidence2", "CMD_Relapse2"),
  stratify_columns = c("Year", "Gender", "Age", "IP_Key.CMDStatus"),
  min_age_inclusive = 0,
  max_age_inclusive = 99
)

sim.results.art <- EMODAnalyzeR::read.simulation.results.bigpurple(
  experiment_path = "/gpfs/scratch/citrod01/experiments/MATUMAINI/CMD_Impact/Baseline-campaign_MATUMAINI_202305_art-art___2025_02_01_20_18_16_484638",
  scenario_name = "art",
    summarize_columns = c("Population","Infected", "On_ART",
                        "Died", "Died_from_HIV",
                        "Newly.Infected","Diagnosed",
                       "CMD_Treat_staging", "CMD_Treat", "CMD_Incidence2", "CMD_Relapse2"),
  stratify_columns = c("Year", "Gender", "Age", "IP_Key.CMDStatus"),
  min_age_inclusive = 0,
  max_age_inclusive = 99
)

sim.results.ceta <- EMODAnalyzeR::read.simulation.results.bigpurple(
  experiment_path = "/gpfs/scratch/citrod01/experiments/MATUMAINI/CMD_Impact/Baseline-campaign_MATUMAINI_202305_art_ceta-art_ceta___2025_02_01_20_15_44_165500",
  scenario_name = "ceta",
    summarize_columns = c("Population","Infected", "On_ART",
                        "Died", "Died_from_HIV",
                        "Newly.Infected","Diagnosed",
                       "CMD_Treat_staging", "CMD_Treat", "CMD_Incidence2", "CMD_Relapse2"),
  stratify_columns = c("Year", "Gender", "Age", "IP_Key.CMDStatus"),
  min_age_inclusive = 0,
  max_age_inclusive = 99
)

CENSUS_YEAR = 2020.5
KEN_CENSUS_POP = 6953951

sim.results.all <- rbind(sim.results.baseline, sim.results.uni, sim.results.neutral, sim.results.art, sim.results.ceta)

sim.results.pop.scaling <- sim.results.all %>%
    filter(Year == CENSUS_YEAR) %>%
    group_by(sim.ix, scenario_name) %>%
    summarize(total.pop = sum(Population), .groups = 'drop_last') %>%
    mutate(pop_scaling_factor = KEN_CENSUS_POP/total.pop)

sim.results.all <- sim.results.all %>%
  inner_join(
    sim.results.pop.scaling,
    by = c("sim.ix", "scenario_name")
  )
```


Load prevalence OBS data

```{r}
ingest.file.base = "/gpfs/data/bershteynlab/EMOD/citrod01/MATUMAINI/202301_Nyanza_Baseline_MalariaOngoing_original/Data/calibration_ingest_form_Nyanza.xlsm"

obs.prev.sheet.base <- EMODAnalyzeR::read.ingest.sheet(ingest.file.base, "Obs-Prevalence")

obs.prev.sheet.base
```

### Generate figure

This is going to be a four-panel figure
1. HIV prevalence over time
2. HIV new infections over time
3. HIV deaths over time
4. CMD prevalence over time + CMD treatment over time

## Figure 2: Impact/Averted

### Load data

```{r}
HIV.Depression.Averted.Data.new <- read_csv("Impact_Manuscript_Figures/HIV_Depression_Averted_Data.csv")
```

### Generate figure

This figure is going to have three separate panels
1. Impact on HIV acquisitions
2. Impact on HIV deaths
3. Impact on depression

Anna may decide she wants additional panels for DALYs, but that's completely separate

```{r}
HIV.Depression.Averted.Data.temp <- HIV.Depression.Averted.Data %>% 
  filter(scenario_name %in% c("art","uni", "neutral", "ceta")) %>% 
  filter(metric %in% c("Died_from_HIV.averted.pct",
                       "Depression.episodes.averted.pct", 
                       "Newly.Infected.averted.pct")) %>% 
    mutate(scenario_ix = case_match(scenario_name, 
                                    "uni" ~ 1,
                                    "neutral" ~ 2,
                                    "art" ~ 3,
                                    "ceta" ~ 4
                                    )
  )
HIV.Depression.Averted.Data.temp$scenario_ix = factor(HIV.Depression.Averted.Data.temp$scenario_ix, levels = c(4,3,2,1))

HIV.Depression.Averted.Data.temp <- HIV.Depression.Averted.Data.temp[order(HIV.Depression.Averted.Data.temp$metric, HIV.Depression.Averted.Data.temp$scenario_ix), ]

color.scheme = c("#EB2B42", "#2139D3", "#3DB34C", "#B326D3")
```


```{r}
plot.averted.panel1 <- HIV.Depression.Averted.Data.temp %>% filter(metric == "Newly.Infected.averted.pct") %>% 
  ggplot() +
  geom_bar(mapping = aes(x = metric, y = metric.mean * 100, fill = as.factor(scenario_ix)),
           position = position_dodge2(reverse = TRUE, padding = 0), 
           stat = "identity",
           show.legend = FALSE) + 
  geom_errorbar(mapping = aes(x = metric, 
                              ymin = metric.lb * 99.5, ymax = metric.ub * 100,
                              group = as.factor(scenario_ix)),
                position = position_dodge2(reverse = TRUE, padding = .25), 
                stat = "identity",
                size = 1, color = "black",
                show.legend = FALSE) + 

  scale_y_continuous(breaks = seq(0,4,1), 
                     labels = c("0%", "1%", "2%", "3%", "4%"), 
                     expand = expansion(mult = c(0.00,.1))) +
  scale_fill_manual("", values = color.scheme,
                    breaks = c("1", "2", "3", "4"), 
                    labels = c("Universal", "HIV Testing   ", "ART", "CETA")) + 
  scale_x_discrete(
    breaks=c("Depression.episodes.averted.pct",
             "Died_from_HIV.averted.pct", 
             "Newly.Infected.averted.pct"),
    labels=c("Depression Episodes\nAverted",
             "HIV Deaths\nAverted", 
             "HIV Infections\nAverted")) + 
  theme_minimal() + theme_bw() +
  theme(panel.grid = element_blank(),
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        #axis.text.x = element_blank(),
        legend.position = "top")
```

```{r}
plot.averted.panel2 <- HIV.Depression.Averted.Data.temp %>% filter(metric == "Died_from_HIV.averted.pct") %>% 
  ggplot() +
  geom_bar(mapping = aes(x = metric, y = metric.mean * 100, fill = as.factor(scenario_ix)),
           position = position_dodge2(reverse = TRUE, padding = 0), 
           stat = "identity",
           show.legend = FALSE) + 
  geom_errorbar(mapping = aes(x = metric, 
                              ymin = metric.lb * 99.5, ymax = metric.ub * 100,
                              group = as.factor(scenario_ix)),
                position = position_dodge2(reverse = TRUE, padding = .25), 
                stat = "identity",
                size = 1, color = "black",
                show.legend = FALSE) + 

  scale_y_continuous(breaks = seq(0,2,.5),
                     labels = c("0%", "0.5%", "1.0%", "1.5%", "2.0%"),
  expand = expansion(mult = c(0.00,.1))) +
  scale_fill_manual("", values = color.scheme,
                    breaks = c("1", "2", "3", "4"), 
                    labels = c("Universal", "HIV Testing   ", "ART", "CETA")) + 
  scale_x_discrete(
    breaks=c("Depression.episodes.averted.pct",
             "Died_from_HIV.averted.pct", 
             "Newly.Infected.averted.pct"),
    labels=c("Depression Episodes\nAverted",
             "HIV Deaths\nAverted", 
             "HIV Infections\nAverted")) + 
  theme_minimal() + theme_bw() +
  theme(panel.grid = element_blank(),
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        #axis.text.x = element_blank(),
        legend.position = "top")
```

```{r}
plot.averted.panel3 <- HIV.Depression.Averted.Data.temp %>% filter(metric == "Depression.episodes.averted.pct") %>% 
  ggplot() +
  geom_bar(mapping = aes(x = metric, y = metric.mean * 100, fill = as.factor(scenario_ix)),
           position = position_dodge2(reverse = TRUE, padding = 0), 
           stat = "identity",
           show.legend = FALSE) + 
  geom_errorbar(mapping = aes(x = metric, 
                              ymin = metric.lb * 99.5, ymax = metric.ub * 100,
                              group = as.factor(scenario_ix)),
                position = position_dodge2(reverse = TRUE, padding = .25), 
                stat = "identity",
                size = 1, color = "black",
                show.legend = FALSE) + 

  scale_y_continuous(breaks = seq(0,20,5), 
                     labels = c("0%", "5%", "10%", "15%", "20%"), 
                     expand = expansion(mult = c(0.00,.1))) +
  scale_fill_manual("", values = color.scheme,
                    breaks = c("1", "2", "3", "4"), 
                    labels = c("Universal", "HIV Testing   ", "ART", "CETA")) + 
  scale_x_discrete(
    breaks=c("Depression.episodes.averted.pct",
             "Died_from_HIV.averted.pct", 
             "Newly.Infected.averted.pct"),
    labels=c("Depression Episodes\nAverted",
             "HIV Deaths\nAverted", 
             "HIV Infections\nAverted")) + 
  theme_minimal() + theme_bw() +
  theme(panel.grid = element_blank(),
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        #axis.text.x = element_blank(),
        legend.position = "top")
```

```{r}
plot.averted.panel1 + plot.averted.panel2 + plot.averted.panel3
```

```{r}
plot.averted.all <- HIV.Depression.Averted.Data.temp %>% #filter(metric == "Depression.episodes.averted.pct") %>% 
  ggplot() +
  geom_bar(mapping = aes(x = metric, y = metric.mean * 100, fill = as.factor(scenario_ix)),
           position = position_dodge2(reverse = TRUE, padding = 0), 
           stat = "identity",
           show.legend = FALSE) + 
  geom_errorbar(mapping = aes(x = metric, 
                              ymin = metric.lb * 99.5, ymax = metric.ub * 100,
                              group = as.factor(scenario_ix)),
                position = position_dodge2(reverse = TRUE, padding = .25), 
                stat = "identity",
                size = 1, color = "black",
                show.legend = FALSE) + 

  scale_y_continuous(breaks = seq(0,6,2), 
                     labels = c("0%", "2%", "4%", "6%"), 
                     expand = expansion(mult = c(0.00,.2))) +
  scale_fill_manual("", values = color.scheme,
                    breaks = c("1", "2", "3", "4"), 
                    labels = c("Universal", "HIV Testing   ", "ART", "CETA")) + 
  scale_x_discrete(
    breaks=c("Depression.episodes.averted.pct",
             "Died_from_HIV.averted.pct", 
             "Newly.Infected.averted.pct"),
    labels=c("Depression Episodes\nAverted",
             "HIV Deaths\nAverted", 
             "HIV Infections\nAverted")) + 
  theme_minimal() + theme_bw() +
  theme(panel.grid = element_blank(),
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        #axis.text.x = element_blank(),
        legend.position = "top")

plot.averted.all

```

```{r}
ggsave("Impact_Manuscript_Figures/Figure_2_Averted_Plot.pdf", width = 8, height = 4, units = 'in')
```


## Figure 3: 

This figure will be two ICER curves.

The first panel is total DALYs averted per dollar, second panel is HIV-related DALYs averted per dollar

### Load data
```{r}

```

### Panel 1

### Panel 2

## Figure 4:

This figure is the CEAC curve