---
title: "Ad Hoc Analysis of MATUMAINI Mental Health Model"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

The purpose of this notebook is to be able to perform quick ad hoc analysis of the mental health model outputs.

Generally speaking, I will be using this notebook to compare different versions of the model. One version will be baseline, and the other version of the model will have one or more changes to the baseline model. We will compare to see whether the changes to the baseline model yield expected results.

```{r Load Libraries}
library(tidyverse)
library(tidyr)
library(data.table)
library(magrittr)
library(ggplot2)
library(devtools)
library(readxl)
devtools::install_github("BershteynLab/EMODAnalyzeR")
```

# Useful Functions

```{r}

calculate.prevalence <- function(data, stratify_columns = c("Year", "Gender", "sim.id"), numerator = 'Infected', denominator = 'Population'){
  data['num'] = data[numerator]
  data['den'] = data[denominator]
  data <- data %>% 
    dplyr::group_by_at(stratify_columns) %>% 
    dplyr::summarize_at(c('num', 'den'), sum, na.rm = T) %>% 
    ungroup() %>%
    dplyr::mutate(Prevalence = case_when(den == 0 ~ 0,
                                         den > 0 ~ num/den)) 
  
  colnames(data) <- c(stratify_columns, numerator, denominator, "Prevalence")
  
  return(data)
}

```


# Read in Data

```{r Baseline results}
res.path.base = "/gpfs/data/bershteynlab/EMOD/citrod01/MATUMAINI/202301_Nyanza_Baseline_MalariaOngoing/test_6/Baseline-campaign_MATUMAINI_202305-delay_base/ReportHIVByAgeAndGender"

sim.results.base <- EMODAnalyzeR::read.simulation.results(
  results_path  = res.path.base,
  scenario_name = 'prep',
  summarize_columns = c("Population","Infected", "On_ART",
                        "Died", "Died_from_HIV",
                        "Newly.Infected","Diagnosed", "Tested.Past.Year.or.On_ART", 
                        "Tested.Ever", "Newly.Tested.Positive", "Newly.Tested.Negative"),
  stratify_columns = c("Year", "Gender", "Age", "IP_Key.CMDStatus"),
  min_age_inclusive = 0,
  max_age_inclusive = 99
)

CENSUS_YEAR = 2009
KEN_CENSUS_POP = 5352385

sim.results.pop.scaling <- sim.results.base %>% 
      filter(Year == CENSUS_YEAR) %>%
      group_by(sim.id) %>%
      summarize(total.pop = sum(Population), .groups = 'keep') %>% 
      mutate(pop.scaling.factor = KEN_CENSUS_POP/total.pop)

sim.results.base <- sim.results.base %>% 
  inner_join(
    sim.results.pop.scaling,
    by = c("sim.id")
  )

```

```{r}
sim.results.sdrh %>% filter(Year == 2009) %>% 
  mutate(pop = Population * pop.scaling.factor) %>% 
  group_by(sim.id) %>% summarize(sum(pop))
```


```{r Changed model results}
res.path.new = "/gpfs/data/bershteynlab/EMOD/citrod01/MATUMAINI/202301_Nyanza_Baseline_MalariaOngoing/test_6/Baseline-campaign_MATUMAINI_202305-delay_new/ReportHIVByAgeAndGender/"

sim.results.new <- EMODAnalyzeR::read.simulation.results(
  results_path  = res.path.new,
  scenario_name = 'prep',
  summarize_columns = c("Population","Infected", "On_ART",
                        "Died", "Died_from_HIV",
                        "Newly.Infected","Diagnosed", "Tested.Past.Year.or.On_ART", 
                        "Tested.Ever", "Newly.Tested.Positive", "Newly.Tested.Negative"),
  stratify_columns = c("Year", "Gender", "Age", "IP_Key.CMDStatus"),
  min_age_inclusive = 0,
  max_age_inclusive = 99
)

CENSUS_YEAR = 2009
KEN_CENSUS_POP = 5352385

sim.results.pop.scaling <- sim.results.new %>% 
      filter(Year == CENSUS_YEAR) %>%
      group_by(sim.id) %>%
      summarize(total.pop = sum(Population), .groups = 'keep') %>% 
      mutate(pop.scaling.factor = KEN_CENSUS_POP/total.pop)

sim.results.new <- sim.results.new %>% 
  inner_join(
    sim.results.pop.scaling,
    by = c("sim.id")
  )

```


## Prevalence 
```{r}
base.prev <- sim.results.base %>% 
  calculate.prevalence(numerator = 'Infected', denominator = 'Population') %>% 
  # dplyr::group_by(Year, Gender) %>% dplyr::summarize(Prevalence = mean(Prevalence), .groups = 'keep') %>% 
  # ungroup %>% 
  mutate(scenario_name = 'blah')

EMODAnalyzeR::emodplot.by_gender(base.prev,
                   date.start = 1990, date.end = 2040,
                   col2plot = 'Prevalence',
                   title = 'CMD Prevalence'
)
```

### Prevalence by CMD status

Remember: the incidence of depression is twice as high for people who are HIV positive

```{r}
base.prev.cmd.pos <- sim.results.base %>% 
  filter(Age >= 15) %>% 
  filter(IP_Key.CMDStatus == 'CMD_pos') %>%
  group_by(Year, Gender, sim.id) %>% 
  dplyr::summarize(Infected = sum(Infected), 
                   Population = sum(Population), .groups = 'keep') %>% 
  ungroup() %>% 
  mutate(Prevalence = case_when(Population == 0 ~ 0,
                          Population > 0 ~ Infected / Population)) %>% 
  group_by(Year, Gender) %>% 
  dplyr::summarize(Prevalence.cmd.pos = mean(Prevalence), .groups = 'keep')

base.prev.cmd.neg <- sim.results.base %>% 
  filter(Age >= 15) %>% 
  filter(IP_Key.CMDStatus == 'CMD_neg') %>%
    group_by(Year, Gender, sim.id) %>% 
  dplyr::summarize(Infected = sum(Infected), 
                   Population = sum(Population), .groups = 'keep') %>% 
  ungroup() %>% 
  mutate(Prevalence = case_when(Population == 0 ~ 0,
                          Population > 0 ~ Infected / Population)) %>% 
  group_by(Year, Gender) %>% 
  dplyr::summarize(Prevalence.cmd.neg = mean(Prevalence), .groups = 'keep')

merge(
  base.prev.cmd.pos, base.prev.cmd.neg, by = c("Year", "Gender")
)
```

```{r}
new.prev.cmd.pos <- sim.results.new %>% 
  filter(Age >= 15) %>% 
  filter(IP_Key.CMDStatus == 'CMD_pos') %>%
  group_by(Year, Gender, sim.id) %>% 
  dplyr::summarize(Infected = sum(Infected), 
                   Population = sum(Population), .groups = 'keep') %>% 
  ungroup() %>% 
  mutate(Prevalence = case_when(Population == 0 ~ 0,
                          Population > 0 ~ Infected / Population)) %>% 
  group_by(Year, Gender) %>% 
  dplyr::summarize(Prevalence.cmd.pos = mean(Prevalence), .groups = 'keep')

new.prev.cmd.neg <- sim.results.new %>% 
  filter(Age >= 15) %>% 
  filter(IP_Key.CMDStatus != 'CMD_pos') %>%
  group_by(Year, Gender, sim.id) %>% 
  dplyr::summarize(Infected = sum(Infected), 
                   Population = sum(Population), .groups = 'keep') %>% 
  ungroup() %>% 
  mutate(Prevalence = case_when(Population == 0 ~ 0,
                          Population > 0 ~ Infected / Population)) %>% 
  group_by(Year, Gender) %>% 
  dplyr::summarize(Prevalence.cmd.neg = mean(Prevalence), .groups = 'keep')

merge(
  new.prev.cmd.pos, new.prev.cmd.neg, by = c("Year", "Gender")
) %>% tail(10)
```

## Diagnosis of PLHIV

```{r Diagnosis by CMD status - young adults}
## Baseline
base.diag.cmd.pos <- sim.results.base %>% 
  filter(Age >= 18, Age < 25) %>% 
  filter(IP_Key.CMDStatus == 'CMD_pos') %>%
  group_by(Year, Gender, sim.id) %>% 
  dplyr::summarize(Diagnosed = sum(Diagnosed), 
                   Infected = sum(Infected), .groups = 'keep') %>% 
  ungroup() %>% 
  mutate(Diagnosed = case_when(Infected == 0 ~ 0,
                          Infected > 0 ~ Diagnosed / Infected)) %>% 
  group_by(Year, Gender) %>% 
  dplyr::summarize(Diagnosed.cmd.pos = mean(Diagnosed), .groups = 'keep')

base.diag.cmd.neg <- sim.results.base %>% 
  filter(Age >= 18, Age < 25) %>% 
  filter(IP_Key.CMDStatus != 'CMD_pos') %>%
  group_by(Year, Gender, sim.id) %>% 
  dplyr::summarize(Diagnosed = sum(Diagnosed), 
                   Infected = sum(Infected), .groups = 'keep') %>% 
  ungroup() %>% 
  mutate(Diagnosed = case_when(Infected == 0 ~ 0,
                          Infected > 0 ~ Diagnosed / Infected)) %>% 
  group_by(Year, Gender) %>% 
  dplyr::summarize(Diagnosed.cmd.neg = mean(Diagnosed), .groups = 'keep')

# merge(
#   base.diag.cmd.pos, base.diag.cmd.neg, by = c("Year", "Gender")
# ) %>% head(10)

## New
new.diag.cmd.pos <- sim.results.new %>% 
  filter(Age >= 18, Age < 25) %>% 
  filter(IP_Key.CMDStatus == 'CMD_pos') %>%
  group_by(Year, Gender, sim.id) %>% 
  dplyr::summarize(Diagnosed = sum(Diagnosed), 
                   Infected = sum(Infected), .groups = 'keep') %>% 
  ungroup() %>% 
  mutate(Diagnosed = case_when(Infected == 0 ~ 0,
                          Infected > 0 ~ Diagnosed / Infected)) %>% 
  group_by(Year, Gender) %>% 
  dplyr::summarize(Diagnosed.cmd.pos = mean(Diagnosed), .groups = 'keep')

new.diag.cmd.neg <- sim.results.new %>% 
  filter(Age >= 18, Age < 25) %>% 
  filter(IP_Key.CMDStatus != 'CMD_pos') %>%
  group_by(Year, Gender, sim.id) %>% 
  dplyr::summarize(Diagnosed = sum(Diagnosed), 
                   Infected = sum(Infected), .groups = 'keep') %>% 
  ungroup() %>% 
  mutate(Diagnosed = case_when(Infected == 0 ~ 0,
                          Infected > 0 ~ Diagnosed / Infected)) %>% 
  group_by(Year, Gender) %>% 
  dplyr::summarize(Diagnosed.cmd.neg = mean(Diagnosed), .groups = 'keep')

# merge(
#   new.diag.cmd.pos, new.diag.cmd.neg, by = c("Year", "Gender")
# ) %>% head(10)

merge(
  merge(
    base.diag.cmd.pos, base.diag.cmd.neg, by = c("Year", "Gender")
  ),
  merge(
    new.diag.cmd.pos, new.diag.cmd.neg, by = c("Year", "Gender")
  ),
  by = c("Year", "Gender"),
  suffixes = c("base","new")
) %>% View

```


```{r Diagnosis by CMD status -  stratify by age}
## Baseline
base.diag.cmd.pos <- sim.results.base %>% 
  filter(Age > 18) %>% 
  filter(IP_Key.CMDStatus == 'CMD_pos') %>%
  group_by(Year, Gender, Age, sim.id) %>% 
  dplyr::summarize(Diagnosed = sum(Diagnosed), 
                   Infected = sum(Infected), .groups = 'keep') %>% 
  ungroup() %>% 
  mutate(Diagnosed = case_when(Infected == 0 ~ 0,
                          Infected > 0 ~ Diagnosed / Infected)) %>% 
  group_by(Year, Gender, Age) %>% 
  dplyr::summarize(Diagnosed.cmd.pos = mean(Diagnosed), .groups = 'keep')

base.diag.cmd.neg <- sim.results.base %>% 
  filter(Age > 18) %>% 
  filter(IP_Key.CMDStatus != 'CMD_pos') %>%
  group_by(Year, Gender, Age, sim.id) %>% 
  dplyr::summarize(Diagnosed = sum(Diagnosed), 
                   Infected = sum(Infected), .groups = 'keep') %>% 
  ungroup() %>% 
  mutate(Diagnosed = case_when(Infected == 0 ~ 0,
                          Infected > 0 ~ Diagnosed / Infected)) %>% 
  group_by(Year, Gender, Age) %>% 
  dplyr::summarize(Diagnosed.cmd.neg = mean(Diagnosed), .groups = 'keep')

# merge(
#   base.diag.cmd.pos, base.diag.cmd.neg, by = c("Year", "Gender")
# ) %>% head(10)

## New
new.diag.cmd.pos <- sim.results.new %>% 
  filter(Age > 18) %>% 
  filter(IP_Key.CMDStatus == 'CMD_pos') %>%
  group_by(Year, Gender, Age, sim.id) %>% 
  dplyr::summarize(Diagnosed = sum(Diagnosed), 
                   Infected = sum(Infected), .groups = 'keep') %>% 
  ungroup() %>% 
  mutate(Diagnosed = case_when(Infected == 0 ~ 0,
                          Infected > 0 ~ Diagnosed / Infected)) %>% 
  group_by(Year, Gender, Age) %>% 
  dplyr::summarize(Diagnosed.cmd.pos = mean(Diagnosed), .groups = 'keep')

new.diag.cmd.neg <- sim.results.new %>% 
  filter(Age > 18) %>% 
  filter(IP_Key.CMDStatus != 'CMD_pos') %>%
  group_by(Year, Gender, Age, sim.id) %>% 
  dplyr::summarize(Diagnosed = sum(Diagnosed), 
                   Infected = sum(Infected), .groups = 'keep') %>% 
  ungroup() %>% 
  mutate(Diagnosed = case_when(Infected == 0 ~ 0,
                          Infected > 0 ~ Diagnosed / Infected)) %>% 
  group_by(Year, Gender, Age) %>% 
  dplyr::summarize(Diagnosed.cmd.neg = mean(Diagnosed), .groups = 'keep')

# merge(
#   new.diag.cmd.pos, new.diag.cmd.neg, by = c("Year", "Gender")
# ) %>% head(10)

merge(
  merge(
    base.diag.cmd.pos, base.diag.cmd.neg, by = c("Year", "Gender", "Age")
  ),
  merge(
    new.diag.cmd.pos, new.diag.cmd.neg, by = c("Year", "Gender", "Age")
  ),
  by = c("Year", "Gender", "Age"),
  suffixes = c("base","new")
) %>% 
  arrange(Year, Gender, Age) %>% 
  View

```

### Testing uptake

This is the number of people tested in the past year, stratified by HIV status and depression status


```{r Testing uptake for baseline}
# HIV positive testing coverage by CMD status
test.uptake.pos <- sim.results.base %>% 
  filter(Age > 18, Age <= 25) %>% 
  filter(IP_Key.CMDStatus == 'CMD_pos') %>%
  group_by(Year, Gender, sim.id) %>% 
  dplyr::summarize(Newly.Tested.Positive = sum(Newly.Tested.Positive),
                   Newly.Tested.Negative = sum(Newly.Tested.Negative),
                   Population = sum(Population), .groups = 'keep') %>% 
  ungroup() %>% 
  mutate(uptake = case_when(Population == 0 ~ 0,
                          Population > 0 ~ (Newly.Tested.Positive + Newly.Tested.Negative)/Population)) %>%
  group_by(Year, Gender) %>% 
  dplyr::summarize(Newly.Tested.Positive = mean(Newly.Tested.Positive),
                   Newly.Tested.Negative = mean(Newly.Tested.Negative),
                   Population = mean(Population),
                   uptake = mean(uptake),
                   .groups = 'keep')

test.uptake.neg <- sim.results.base %>% 
  filter(Age > 18, Age <= 25) %>% 
  filter(IP_Key.CMDStatus == 'CMD_neg') %>%
  group_by(Year, Gender, sim.id) %>% 
  dplyr::summarize(Newly.Tested.Positive = sum(Newly.Tested.Positive),
                   Newly.Tested.Negative = sum(Newly.Tested.Negative),
                   Population = sum(Population), .groups = 'keep') %>% 
  ungroup() %>% 
  mutate(uptake = case_when(Population == 0 ~ 0,
                          Population > 0 ~ (Newly.Tested.Positive + Newly.Tested.Negative)/Population)) %>%
  group_by(Year, Gender) %>% 
  dplyr::summarize(Newly.Tested.Positive = mean(Newly.Tested.Positive),
                   Newly.Tested.Negative = mean(Newly.Tested.Negative),
                   Population = mean(Population),
                   uptake = mean(uptake),
                   .groups = 'keep')

merge(
  test.uptake.pos,
  test.uptake.neg,
  by = c("Year", "Gender"),
  suffixes = c(".pos",".neg")
) %>% 
  arrange(Year, Gender) %>% 
  View
```


This one seems to indicate that the testing uptake is higher in CMD negative people.
```{r Testing uptake for new}
# HIV positive testing coverage by CMD status
test.uptake.pos <- sim.results.new %>% 
  filter(Age > 18, Age <= 25) %>% 
  filter(IP_Key.CMDStatus == 'CMD_pos') %>%
  group_by(Year, Gender, sim.id) %>% 
  dplyr::summarize(Newly.Tested.Positive = sum(Newly.Tested.Positive),
                   Newly.Tested.Negative = sum(Newly.Tested.Negative),
                   Population = sum(Population), .groups = 'keep') %>% 
  ungroup() %>% 
  mutate(uptake = case_when(Population == 0 ~ 0,
                          Population > 0 ~ (Newly.Tested.Positive + Newly.Tested.Negative)/Population)) %>%
  group_by(Year, Gender) %>% 
  dplyr::summarize(Newly.Tested.Positive = mean(Newly.Tested.Positive),
                   Newly.Tested.Negative = mean(Newly.Tested.Negative),
                   Population = mean(Population),
                   uptake = mean(uptake),
                   .groups = 'keep')

test.uptake.neg <- sim.results.new %>% 
  filter(Age > 18, Age <= 25) %>% 
  filter(IP_Key.CMDStatus == 'CMD_neg') %>%
  group_by(Year, Gender, sim.id) %>% 
  dplyr::summarize(Newly.Tested.Positive = sum(Newly.Tested.Positive),
                   Newly.Tested.Negative = sum(Newly.Tested.Negative),
                   Population = sum(Population), .groups = 'keep') %>% 
  ungroup() %>% 
  mutate(uptake = case_when(Population == 0 ~ 0,
                          Population > 0 ~ (Newly.Tested.Positive + Newly.Tested.Negative)/Population)) %>%
  group_by(Year, Gender) %>% 
  dplyr::summarize(Newly.Tested.Positive = mean(Newly.Tested.Positive),
                   Newly.Tested.Negative = mean(Newly.Tested.Negative),
                   Population = mean(Population),
                   uptake = mean(uptake),
                   .groups = 'keep')

merge(
  test.uptake.pos,
  test.uptake.neg,
  by = c("Year", "Gender"),
  suffixes = c(".pos",".neg")
) %>% 
  arrange(Year, Gender) %>% 
  View
```

## PLHIV on ART
```{r Baseline Art Coverage among PLHIV }

base.artcov.cmd.pos <- sim.results.base %>% 
  filter(Age >= 15) %>% 
  filter(IP_Key.CMDStatus == 'CMD_pos') %>%
  group_by(Year, Gender, sim.id) %>% 
  dplyr::summarize(On_ART = sum(On_ART), 
                   Infected = sum(Infected), .groups = 'keep') %>% 
  ungroup() %>% 
  mutate(ARTcov = case_when(Infected == 0 ~ 0,
                          Infected > 0 ~ On_ART / Infected)) %>% 
  group_by(Year, Gender) %>% 
  dplyr::summarize(ARTcov.cmd.pos = mean(ARTcov), .groups = 'keep')

base.artcov.cmd.neg <- sim.results.base %>% 
  filter(Age >= 15) %>% 
  filter(IP_Key.CMDStatus != 'CMD_pos') %>%
  group_by(Year, Gender, sim.id) %>% 
  dplyr::summarize(On_ART = sum(On_ART), 
                   Infected = sum(Infected), .groups = 'keep') %>% 
  ungroup() %>% 
  mutate(ARTcov = case_when(Infected == 0 ~ 0,
                          Infected > 0 ~ On_ART / Infected)) %>% 
  group_by(Year, Gender) %>% 
  dplyr::summarize(ARTcov.cmd.neg = mean(ARTcov), .groups = 'keep')
```

```{r New Art Coverage among Diagnosed PLHIV}
new.artcov.cmd.pos <- sim.results.new %>% 
  filter(Age >= 15) %>% 
  filter(IP_Key.CMDStatus == 'CMD_pos') %>%
  group_by(Year, Gender, sim.id) %>% 
  dplyr::summarize(On_ART = sum(On_ART), 
                   Infected = sum(Infected), .groups = 'keep') %>% 
  ungroup() %>% 
  mutate(ARTcov = case_when(Infected == 0 ~ 0,
                          Infected > 0 ~ On_ART / Infected)) %>% 
  group_by(Year, Gender) %>% 
  dplyr::summarize(ARTcov.cmd.pos = mean(ARTcov), .groups = 'keep')

new.artcov.cmd.neg <- sim.results.new %>% 
  filter(Age >= 15) %>% 
  filter(IP_Key.CMDStatus != 'CMD_pos') %>%
  group_by(Year, Gender, sim.id) %>% 
  dplyr::summarize(On_ART = sum(On_ART), 
                   Infected = sum(Infected), .groups = 'keep') %>% 
  ungroup() %>% 
  mutate(ARTcov = case_when(Infected == 0 ~ 0,
                          Infected > 0 ~ On_ART / Infected)) %>% 
  group_by(Year, Gender) %>% 
  dplyr::summarize(ARTcov.cmd.neg = mean(ARTcov), .groups = 'keep')
 
```

```{r}
merge(
  merge(
  base.artcov.cmd.pos, base.artcov.cmd.neg, by = c("Year", "Gender")
),

merge(
  new.artcov.cmd.pos, new.artcov.cmd.neg, by = c("Year", "Gender")
),
by = c("Year", "Gender"),
suffixes = c(".base",".new")
) %>% tail(25)
```
## Diagnosed PLHIV on ART

```{r Baseline Art Coverage among Diagnosed PLHIV }

base.artcov.cmd.pos <- sim.results.base %>% 
  filter(Age >= 15) %>% 
  filter(IP_Key.CMDStatus == 'CMD_pos') %>%
  group_by(Year, Gender, sim.id) %>% 
  dplyr::summarize(On_ART = sum(On_ART), 
                   Diagnosed = sum(Diagnosed), .groups = 'keep') %>% 
  ungroup() %>% 
  mutate(ARTcov = case_when(Diagnosed == 0 ~ 0,
                          Diagnosed > 0 ~ On_ART / Diagnosed)) %>% 
  group_by(Year, Gender) %>% 
  dplyr::summarize(ARTcov.cmd.pos = mean(ARTcov), .groups = 'keep')

base.artcov.cmd.neg <- sim.results.base %>% 
  filter(Age >= 15) %>% 
  filter(IP_Key.CMDStatus != 'CMD_pos') %>%
  group_by(Year, Gender, sim.id) %>% 
  dplyr::summarize(On_ART = sum(On_ART), 
                   Diagnosed = sum(Diagnosed), .groups = 'keep') %>% 
  ungroup() %>% 
  mutate(ARTcov = case_when(Diagnosed == 0 ~ 0,
                          Diagnosed > 0 ~ On_ART / Diagnosed)) %>% 
  group_by(Year, Gender) %>% 
  dplyr::summarize(ARTcov.cmd.neg = mean(ARTcov), .groups = 'keep')
```

```{r New Art Coverage among Diagnosed PLHIV}
new.artcov.cmd.pos <- sim.results.new %>% 
  filter(Age >= 15) %>% 
  filter(IP_Key.CMDStatus == 'CMD_pos') %>%
  group_by(Year, Gender, sim.id) %>% 
  dplyr::summarize(On_ART = sum(On_ART), 
                   Diagnosed = sum(Diagnosed), .groups = 'keep') %>% 
  ungroup() %>% 
  mutate(ARTcov = case_when(Diagnosed == 0 ~ 0,
                          Diagnosed > 0 ~ On_ART / Diagnosed)) %>% 
  group_by(Year, Gender) %>% 
  dplyr::summarize(ARTcov.cmd.pos = mean(ARTcov), .groups = 'keep')

new.artcov.cmd.neg <- sim.results.new %>% 
  filter(Age >= 15) %>% 
  filter(IP_Key.CMDStatus != 'CMD_pos') %>%
  group_by(Year, Gender, sim.id) %>% 
  dplyr::summarize(On_ART = sum(On_ART), 
                   Diagnosed = sum(Diagnosed), .groups = 'keep') %>% 
  ungroup() %>% 
  mutate(ARTcov = case_when(Diagnosed == 0 ~ 0,
                          Diagnosed > 0 ~ On_ART / Diagnosed)) %>% 
  group_by(Year, Gender) %>% 
  dplyr::summarize(ARTcov.cmd.neg = mean(ARTcov), .groups = 'keep')
 
```

```{r}
merge(
  merge(
  base.artcov.cmd.pos, base.artcov.cmd.neg, by = c("Year", "Gender")
),

merge(
  new.artcov.cmd.pos, new.artcov.cmd.neg, by = c("Year", "Gender")
),
by = c("Year", "Gender"),
suffixes = c(".base",".new")
) %>% tail(25)
```

# SIS Model - 2023-06-21

This is a version of the SDRH model with `Target_Property_Value__KP_recovery_notreat = "CMD_neg"` so that we turn off everything except the SIS features. We have confirmed that this works okay.

```{r}

res.path.sis = "/gpfs/data/bershteynlab/EMOD/citrod01/MATUMAINI/202301_Nyanza_Baseline_MalariaOngoing/test_sis/Baseline-campaign_MATUMAINI_202305-sis/ReportHIVByAgeAndGender"

sim.results.sis <- EMODAnalyzeR::read.simulation.results(
  results_path  = res.path.sis,
  scenario_name = 'sis',
  summarize_columns = c("Population","Infected", "On_ART",
                        "Died", "Died_from_HIV",
                        "Newly.Infected","Diagnosed"),
  stratify_columns = c("Year", "Gender", "Age", "IP_Key.CMDStatus"),
  min_age_inclusive = 0,
  max_age_inclusive = 99
)

CENSUS_YEAR = 2009
KEN_CENSUS_POP = 5352385

sim.results.pop.scaling <- sim.results.sis %>% 
      filter(Year == CENSUS_YEAR) %>%
      group_by(sim.id) %>%
      summarize(total.pop = sum(Population), .groups = 'keep') %>% 
      mutate(pop.scaling.factor = KEN_CENSUS_POP/total.pop)

sim.results.sis <- sim.results.sis %>% 
  inner_join(
    sim.results.pop.scaling,
    by = c("sim.id")
  )

```

## Prevalence over time

```{r}
data <- sim.results.sis %>% filter(Age <= 50, Age >= 15, Year > 1990, Year <=2040) %>% 
  dplyr::group_by(Year, Gender, sim.id, scenario_name) %>%
  dplyr::summarize(Infected = sum(Infected), Population = sum(Population), .groups = 'keep') %>%
  ungroup( ) %>% 
  dplyr::mutate(Prevalence = case_when(Population == 0 ~ 0,
                                       Population > 0 ~ Infected / Population))%>% 
  mutate(Gender = case_when(Gender==0 ~ "Male", Gender==1 ~ "Female"))


data.mean <- data %>% group_by(Year, Gender) %>% summarize(std = sd(Prevalence), Prevalence = mean(Prevalence))%>% 
  mutate(lb = Prevalence + std, ub = Prevalence + std)

p = ggplot() +
  geom_line(data = data.mean, 
               size=2.0, aes(x=Year, y=Prevalence), color = 'darkred') +
  geom_line(data = data, 
            mapping = aes(x = Year, y = Prevalence, group = sim.id), color = 'darkred', 
            alpha = .01) + 
  #geom_errorbar(data= data.mean, mapping = aes(x = Year, ymin = lb, ymax = ub), color="black", width=2, size=1) + 
    facet_wrap(~ Gender, ncol=2) +
    xlab("Year")+ylab("") + 
    theme_bw(base_size=16) +
    guides(fill = guide_legend(keywidth = 2, keyheight = 1)) +
    scale_x_continuous(breaks = seq(1990,2040,10)) +
    theme(legend.position="bottom") +
    theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
    theme(strip.background = element_rect(colour="black", fill="white")) +
    theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())

p

```

## CMD prevalence over time

```{r}
# Aggregate CMD prevalence, to plot using EMODAnalyzer
cmd.data <- sim.results.sdrh %>% filter(Age >15) %>% 
  pivot_wider(id_cols = c(Year, Age, Gender, sim.id, scenario_name),
              names_from = c(IP_Key.CMDStatus),
              values_from = c(Population)) %>% 
  group_by(Year, Gender, sim.id, scenario_name) %>% 
  summarize(CMD_pos = sum(CMD_pos), 
            Population = sum(CMD_pos + CMD_neg + CMD_recovered + CMD_treated), 
            .groups = 'keep') %>% 
  ungroup() %>% 
  mutate(CMD_prev = case_when(Population == 0 ~ 0,
                              Population > 0 ~ CMD_pos / Population))%>% 
  mutate(Gender = case_when(Gender==0 ~ "Male", Gender==1 ~ "Female"))

cmd.data.mean <- cmd.data %>% 
  group_by(Year, Gender) %>% 
  summarize(CMD_prev = mean(CMD_prev))
  
p = ggplot() +
  geom_line(data = cmd.data.mean, 
               size=2.0, aes(x=Year, y=CMD_prev), color = 'darkgreen') +
  geom_line(data = cmd.data, 
            mapping = aes(x = Year, y = CMD_prev, group = sim.id), color = 'darkgreen', 
            alpha = .01) + 
  #geom_errorbar(data= data.mean, mapping = aes(x = Year, ymin = lb, ymax = ub), color="black", width=2, size=1) + 
    facet_wrap(~ Gender, ncol=2) +
    xlab("Year")+ylab("") + 
    theme_bw(base_size=16) +
    guides(fill = guide_legend(keywidth = 2, keyheight = 1)) +
    scale_x_continuous(breaks = seq(1990,2040,10)) +
    theme(legend.position="bottom") +
    theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
    theme(strip.background = element_rect(colour="black", fill="white")) +
    theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())

p
```


## CMD prevalence by age

```{r}
cmd.data.age <- sim.results.sdrh %>% 
  pivot_wider(id_cols = c(Year, Age, Gender, sim.id, scenario_name),
              names_from = c(IP_Key.CMDStatus),
              values_from = c(Population)) %>% 
  group_by(Year, Age, Gender, sim.id, scenario_name) %>% 
  summarize(CMD_pos = sum(CMD_pos), 
            Population = sum(CMD_pos + CMD_neg + CMD_recovered + CMD_treated), 
            .groups = 'keep') %>% 
  ungroup() %>% 
  mutate(CMD_prev = case_when(Population == 0 ~ 0,
                              Population > 0 ~ CMD_pos / Population)) %>% 
  mutate(Gender = case_when(Gender==0 ~ "Male", Gender==1 ~ "Female"))

age_bins = c(18, 25, 30, 40, 45, 50, 60, 99)
age_labels = c()
for (i in 1:(length(age_bins) - 1)){
  age_labels <- append(age_labels, paste0("[",age_bins[i],":",age_bins[i + 1],")"))
}

# Label each age by its bin
cmd.data.age <- cmd.data.age %>% mutate(
  AgeBin = cut(Age, breaks = age_bins, right = FALSE)
  ) %>%
  filter(!is.na(AgeBin))
cmd.data.age$AgeBin_index = factor(cmd.data.age$AgeBin,labels = 1:length(age_labels))

subset_years = c(2004)

cmd.data.age.mean <- cmd.data.age %>% group_by(Year, AgeBin_index, AgeBin, Gender, scenario_name) %>% 
  summarize(mean.CMD_prev = mean(CMD_prev),
              sd.CMD_prev = sd(CMD_prev),
              .groups = 'keep') %>% 
  mutate(lower = max(mean.CMD_prev - 2* sd.CMD_prev, 0), 
           upper = mean.CMD_prev + 2*sd.CMD_prev)

p <- cmd.data.age.mean %>% filter(Year == 2004) %>% 
    ggplot() + 
    # plot means
    geom_point(
      mapping = aes(x = AgeBin_index, y = mean.CMD_prev),
      size=2, color = 'darkgreen'
    ) + 
    geom_errorbar(
      mapping = aes(x=AgeBin_index, ymin=lower, ymax=upper),
      width=.3, size=2, color = 'darkgreen') + 
    facet_grid(cols = vars(Gender), rows = vars(Year)) + 
    xlab("Age") + ylab("") + 
    theme_bw(base_size=16) +
    guides(fill = guide_legend(keywidth = 2, keyheight = 1)) +
    scale_x_discrete(
      breaks = 1:length(age_labels),
      labels = age_labels
      ) +
    theme(legend.position="bottom") +
    theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
    theme(strip.background = element_rect(colour="black", fill="white")) +
    theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())

p 

 # +geom_point(obs.cmdprev.sheet,
 #             mapping = aes(x = AgeBin_index, y = CMDPrevalence), color = 'orange', size = 2)

```


## Examine the Event Recorder

```{r}
event.rec.path = "/gpfs/scratch/citrod01/experiments/MATUMAINI/Baseline-campaign_MATUMAINI_202305-sis___2023_06_20_17_12_49_667455/Simulation_0AM8J9GA/output/ReportEventRecorder.csv"

event.rec = read_csv(event.rec.path)

# event.rec %>% arrange(Individual_ID, Time) %>% View

merge(
  event.rec %>% filter(Event_Name != "HCTTestingLoopRapidTest"),
  event.rec %>% filter(Event_Name != "HCTTestingLoopRapidTest") %>% 
    group_by(Individual_ID) %>% summarize(n = n()) %>% filter(n >= 4),
  by = "Individual_ID"
) %>% 
  arrange(Individual_ID, Time) %>% View
```

# SDRH model - 2023-06-22

This model is the first time running the SDRH model, which includes recovery, relapse, and treatment history. 

There are two scenarios, one without treatment and one with treatment.

I am going to make some quick spot checks on whether or not the HIV prevalence appears to be matching closely, whether or not the CMD prevalence appears to be matching (at least ballpark, I expect this to be too high by a little bit). 

I am also going to make some quick spot checks on the event cascade, to see whether people who do and do not receive treatment end up in their appropriate cycles of relapse and recovery.

```{r  }

res.path.base =  "/gpfs/data/bershteynlab/EMOD/citrod01/MATUMAINI/202301_Nyanza_Baseline_MalariaOngoing/test_sdrh_2/Baseline-campaign_MATUMAINI_202305-sdrh_base/ReportHIVByAgeAndGender/"

sim.results.base <- EMODAnalyzeR::read.simulation.results(
  results_path  = res.path.base,
  scenario_name = 'treatall',
  summarize_columns = c("Population","Infected", "On_ART",
                        "Died", "Died_from_HIV",
                        "Newly.Infected","Diagnosed"),
  stratify_columns = c("Year", "Gender", "Age", "IP_Key.CMDStatus"),
  min_age_inclusive = 0,
  max_age_inclusive = 99
)

CENSUS_YEAR = 2009
KEN_CENSUS_POP = 5352385

sim.results.pop.scaling <- sim.results.base %>% 
      filter(Year == CENSUS_YEAR) %>%
      group_by(sim.id) %>%
      summarize(total.pop = sum(Population), .groups = 'keep') %>% 
      mutate(pop.scaling.factor = KEN_CENSUS_POP/total.pop)

sim.results.base <- sim.results.base %>% 
  inner_join(
    sim.results.pop.scaling,
    by = c("sim.id")
  )

```

```{r No Treatment}

res.path.notreat = "/gpfs/data/bershteynlab/EMOD/citrod01/MATUMAINI/202301_Nyanza_Baseline_MalariaOngoing/test_sdrh_3/Baseline-campaign_MATUMAINI_202305-sdrh_notreat/ReportHIVByAgeAndGender/"

res.path.notreat = "/gpfs/scratch/citrod01/experiments/MATUMAINI/Baseline-campaign_MATUMAINI_202305-sdrh_notreat___2023_06_27_17_10_09_046337"

#sim.results.sdrh <- EMODAnalyzeR::read.simulation.results(
sim.results.sdrh <- EMODAnalyzeR::read.simulation.results.bigpurple(
  #results_path  = res.path.notreat,
  res.path.notreat,
  scenario_name = 'sdrh',
  summarize_columns = c("Population","Infected", "On_ART",
                        "Died", "Died_from_HIV",
                        "Newly.Infected","Diagnosed"),
  stratify_columns = c("Year", "Gender", "Age", "IP_Key.CMDStatus"),
  min_age_inclusive = 0,
  max_age_inclusive = 99
)

# SummarizeEachSimByAgeAndGender <- function (data, summarize_columns, stratify_columns, min_age_inclusive = 0, max_age_inclusive = Inf) {
#   data %>%
#     filter( (Age >= min_age_inclusive) & (Age <= max_age_inclusive) ) %>%
#     group_by_at(stratify_columns) %>%
#     summarise_at(summarize_columns, sum, na.rm=T) %>%
#     ungroup()
# }
# 
# sim.results.sdrh <- EMODAnalyzeR::read.simulation.results.bigpurple(
#   experiment_path = "/gpfs/scratch/citrod01/experiments/MATUMAINI/Baseline-campaign_MATUMAINI_202305-sdrh_notreat___2023_06_23_12_46_40_194042",
#   scenario_name = 'sdrh',
#   summarize_columns = c("Population","Infected", "On_ART",
#                         "Died", "Died_from_HIV",
#                         "Newly.Infected","Diagnosed"),
#   stratify_columns = c("Year", "Gender", "Age", "IP_Key.CMDStatus"),
#   min_age_inclusive = 0,
#   max_age_inclusive = 99,
#   verbose = TRUE
# )

CENSUS_YEAR = 2009
KEN_CENSUS_POP = 5352385

sim.results.pop.scaling <- sim.results.sdrh %>% 
      filter(Year == CENSUS_YEAR) %>%
      group_by(sim.id) %>%
      summarize(total.pop = sum(Population), .groups = 'keep') %>% 
      mutate(pop.scaling.factor = KEN_CENSUS_POP/total.pop)

sim.results.sdrh <- sim.results.sdrh %>% 
  inner_join(
    sim.results.pop.scaling,
    by = c("sim.id")
  )

```


```{r Treat All}

res.path.treat = "/gpfs/data/bershteynlab/EMOD/citrod01/MATUMAINI/202301_Nyanza_Baseline_MalariaOngoing/test_sdrh_2/Baseline-campaign_MATUMAINI_202305-sdrh_treatall/ReportHIVByAgeAndGender"

sim.results.treat <- EMODAnalyzeR::read.simulation.results(
  results_path  = res.path.treat,
  scenario_name = 'treatall',
  summarize_columns = c("Population","Infected", "On_ART",
                        "Died", "Died_from_HIV",
                        "Newly.Infected","Diagnosed"),
  stratify_columns = c("Year", "Gender", "Age", "IP_Key.CMDStatus"),
  min_age_inclusive = 0,
  max_age_inclusive = 99
)

CENSUS_YEAR = 2009
KEN_CENSUS_POP = 5352385

sim.results.pop.scaling <- sim.results.treat %>% 
      filter(Year == CENSUS_YEAR) %>%
      group_by(sim.id) %>%
      summarize(total.pop = sum(Population), .groups = 'keep') %>% 
      mutate(pop.scaling.factor = KEN_CENSUS_POP/total.pop)

sim.results.treat <- sim.results.treat %>% 
  inner_join(
    sim.results.pop.scaling,
    by = c("sim.id")
  )

```

## HIV Prevalence Over Time

```{r}
xl.path = "/gpfs/data/bershteynlab/EMOD/citrod01/MATUMAINI/202301_Nyanza_Baseline_MalariaOngoing/Data/calibration_ingest_form_Nyanza_MATUMAINI.xlsm"

obs.prev.sheet <- readxl::read_excel(xl.path, sheet = "Obs-Prevalence", range = "A8:G173", col_names = TRUE)
```

```{r Baseline}
data.base <- sim.results.base %>% filter(Age <= 50, Age >= 15, Year > 1990, Year <=2040) %>% 
  dplyr::group_by(Year, Gender, sim.id, scenario_name) %>%
  dplyr::summarize(Infected = sum(Infected), Population = sum(Population), .groups = 'keep') %>%
  ungroup( ) %>% 
  dplyr::mutate(Prevalence = case_when(Population == 0 ~ 0,
                                       Population > 0 ~ Infected / Population))%>% 
  mutate(Gender = case_when(Gender==0 ~ "Male", Gender==1 ~ "Female"))

data.base.mean <- data.base %>% 
  group_by(Year, Gender) %>% 
  summarize(std = sd(Prevalence), Prevalence = mean(Prevalence)) %>% 
  mutate(lb = Prevalence + std, ub = Prevalence + std)

# p = ggplot() +
#   geom_line(data = data.base.mean, 
#                size=2.0, aes(x=Year, y=Prevalence), color = 'darkred') +
#   geom_line(data = data.base, 
#             mapping = aes(x = Year, y = Prevalence, group = sim.id), color = 'darkred', 
#             alpha = .01) +
#   #geom_errorbar(data= data.mean, mapping = aes(x = Year, ymin = lb, ymax = ub), color="black", width=2, size=1) + 
#     facet_wrap(~ Gender, ncol=2) +
#     xlab("Year")+ylab("") + 
#     theme_bw(base_size=16) +
#     guides(fill = guide_legend(keywidth = 2, keyheight = 1)) +
#     scale_x_continuous(breaks = seq(1990,2040,10)) +
#     theme(legend.position="bottom") +
#     theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
#     theme(strip.background = element_rect(colour="black", fill="white")) +
#     theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())
# 
# p + 
#   geom_point(data = obs.prev.sheet %>% 
#                filter(Province == 'All', AgeBin == "[15:50)", Gender %in% c("Male", "Female")), 
#              mapping = aes(x = Year, y = Prevalence))

```


```{r}
# Aggregate data without treatment
data.notreat <- sim.results.sdrh %>% filter(Age <= 50, Age >= 15, Year > 1990, Year <=2040) %>% 
  dplyr::group_by(Year, Gender, sim.id, scenario_name) %>%
  dplyr::summarize(Infected = sum(Infected), Population = sum(Population), .groups = 'keep') %>%
  ungroup( ) %>% 
  dplyr::mutate(Prevalence = case_when(Population == 0 ~ 0,
                                       Population > 0 ~ Infected / Population))%>% 
  mutate(Gender = case_when(Gender==0 ~ "Male", Gender==1 ~ "Female"))

data.notreat.mean <- data.notreat %>% 
  group_by(Year, Gender) %>% 
  summarize(std = sd(Prevalence), Prevalence = mean(Prevalence)) %>% 
  mutate(lb = Prevalence + std, ub = Prevalence + std)

# Aggregate data with treatment
data.treat <- sim.results.treat %>% filter(Age <= 50, Age >= 15, Year > 1990, Year <=2040) %>% 
  dplyr::group_by(Year, Gender, sim.id, scenario_name) %>%
  dplyr::summarize(Infected = sum(Infected), Population = sum(Population), .groups = 'keep') %>%
  ungroup( ) %>% 
  dplyr::mutate(Prevalence = case_when(Population == 0 ~ 0,
                                       Population > 0 ~ Infected / Population))%>% 
  mutate(Gender = case_when(Gender==0 ~ "Male", Gender==1 ~ "Female"))

data.treat.mean <- data.treat %>% 
  group_by(Year, Gender) %>% 
  summarize(std = sd(Prevalence), Prevalence = mean(Prevalence)) %>% 
  mutate(lb = Prevalence + std, ub = Prevalence + std)

p = ggplot() +
  geom_line(data = data.notreat.mean, 
               size=2.0, aes(x=Year, y=Prevalence), color = 'darkred') +
  geom_line(data = data.notreat, 
            mapping = aes(x = Year, y = Prevalence, group = sim.id), color = 'darkred', 
            alpha = .01) +
  # geom_line(data = data.treat.mean, 
  #              size=2.0, aes(x=Year, y=Prevalence), color = 'blue') +
  # geom_line(data = data.treat, 
  #           mapping = aes(x = Year, y = Prevalence, group = sim.id), color = 'blue', 
  #           alpha = .01) +
  # geom_line(data = data.base.mean, 
  #              size=2.0, aes(x=Year, y=Prevalence), color = 'black') +
  # geom_line(data = data.base, 
  #           mapping = aes(x = Year, y = Prevalence, group = sim.id), color = 'black', 
  #           alpha = .01) +  
  #geom_errorbar(data= data.mean, mapping = aes(x = Year, ymin = lb, ymax = ub), color="black", width=2, size=1) + 
    facet_wrap(~ Gender, ncol=2) +
    xlab("Year")+ylab("") + 
    theme_bw(base_size=16) +
    guides(fill = guide_legend(keywidth = 2, keyheight = 1)) +
    scale_x_continuous(breaks = seq(1990,2040,10)) +
    theme(legend.position="bottom") +
    theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
    theme(strip.background = element_rect(colour="black", fill="white")) +
    theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())

p + 
  geom_point(data = obs.prev.sheet %>% 
               filter(Province == 'All', AgeBin == "[15:50)", Gender %in% c("Male", "Female")), 
             mapping = aes(x = Year, y = Prevalence))

```

## HIV prevalence by age

```{r}
age_bins = c(15, 20, 25, 30, 35, 40, 45, 50)

data <- sim.results.sdrh %>% mutate(
    AgeBin = cut(Age, breaks = age_bins, right = FALSE)
    ) %>%
    filter(!is.na(AgeBin)) %>% 
  filter(Year == 2004) %>% 
  group_by(AgeBin, Gender, sim.id) %>% 
  dplyr::summarize(Infected = sum(Infected), Population = sum(Population), .groups = 'keep') %>%
  ungroup( ) %>% 
  dplyr::mutate(Prevalence = case_when(Population == 0 ~ 0,
                                       Population > 0 ~ Infected / Population)) %>% 
  group_by(AgeBin, Gender) %>% 
  summarize(Prevalence = mean(Prevalence), .groups = "keep")  %>% 
  ungroup()

data %>% arrange(Gender, AgeBin) %>% View
```


## ART over time

```{r}
obs.onart.sheet <- readxl::read_excel(xl.path, sheet = "Obs-OnART", range = "A8:G202", col_names = TRUE)

```

```{r}

data.base <- sim.results.base %>% 
  filter(Age > 15) %>% 
  group_by(Year, Gender, sim.id, scenario_name) %>% 
  summarize(On_ART = sum(On_ART*pop.scaling.factor), Population = sum(Population), .groups = 'keep')  %>% 
  ungroup( ) %>% 
  mutate(Gender = case_when(Gender==0 ~ "Male", Gender==1 ~ "Female"))

data.base.mean <- data.base %>% 
  group_by(Year, Gender) %>% 
  summarize(On_ART = mean(On_ART), .groups = "keep") %>% ungroup()

data.sdrh <- sim.results.sdrh %>% 
  filter(Age > 15) %>% 
  group_by(Year, Gender, sim.id, scenario_name) %>% 
  summarize(On_ART = sum(On_ART*pop.scaling.factor), Population = sum(Population), .groups = 'keep')  %>% 
  ungroup( ) %>% 
  mutate(Gender = case_when(Gender==0 ~ "Male", Gender==1 ~ "Female"))

data.sdrh.mean <- data.sdrh %>% 
  group_by(Year, Gender) %>% 
  summarize(On_ART = mean(On_ART), .groups = "keep") %>% ungroup()


data.treat <- sim.results.treat %>% 
  filter(Age > 15) %>% 
  group_by(Year, Gender, sim.id, scenario_name) %>% 
  summarize(On_ART = sum(On_ART*pop.scaling.factor), Population = sum(Population), .groups = 'keep')  %>% 
  ungroup( ) %>% 
  mutate(Gender = case_when(Gender==0 ~ "Male", Gender==1 ~ "Female"))

data.treat.mean <- data.treat %>% 
  group_by(Year, Gender) %>% 
  summarize(On_ART = mean(On_ART), .groups = "keep") %>% ungroup()

p = ggplot() +
  geom_line(data = data.sdrh.mean, 
               size=2.0, aes(x= Year, y= On_ART), color = 'darkred') +
  geom_line(data = data.sdrh, 
            mapping = aes(x = Year, y = On_ART, group = sim.id), color = 'darkred', 
            alpha = .01) +
  # geom_line(data = data.treat.mean, 
  #              size=2.0, aes(x=Year, y= On_ART), color = 'blue') +
  # geom_line(data = data.treat, 
  #           mapping = aes(x = Year, y = On_ART, group = sim.id), color = 'blue', 
  #           alpha = .01) +
  # geom_line(data = data.base.mean, 
  #              size=2.0, aes(x=Year, y= On_ART), color = 'black') +
  # geom_line(data = data.base, 
  #           mapping = aes(x = Year, y = On_ART, group = sim.id), color = 'black', 
  #           alpha = .01) +  
  #geom_errorbar(data= data.mean, mapping = aes(x = Year, ymin = lb, ymax = ub), color="black", width=2, size=1) + 
    facet_wrap(~ Gender, ncol=2) +
    xlab("Year")+ylab("") + 
    theme_bw(base_size=16) +
    guides(fill = guide_legend(keywidth = 2, keyheight = 1)) +
    scale_x_continuous(breaks = seq(1990,2040,10)) +
    theme(legend.position="bottom") +
    theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
    theme(strip.background = element_rect(colour="black", fill="white")) +
    theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())

p
```



```{r}
data <- sim.results.sdrh %>% 
  filter(Age > 15) %>% 
  group_by(Year, Gender, sim.id, scenario_name) %>% 
  summarize(On_ART = sum(On_ART*pop.scaling.factor), Population = sum(Population), .groups = 'keep')

p <- EMODAnalyzeR::emodplot.by_gender(data, 1990, 2040, 'On_ART', title="ART") 

p + 
  geom_point(data = obs.onart.sheet %>% filter(Province != "All", AgeBin == '[15:100)') %>% 
    group_by(Year, Gender) %>% 
    summarize(OnART = sum(OnART), .groups = 'keep'),
    mapping= aes(x = Year, y = OnART))
```

```{r}
data.base <- sim.results.base %>% 
  filter(Age > 15) %>% 
  group_by(Year, Gender, sim.id, scenario_name) %>% 
  summarize(On_ART = sum(On_ART*pop.scaling.factor), Population = sum(Population), .groups = 'keep')

p.1 <- EMODAnalyzeR::emodplot.by_gender(data.base, 1990, 2040, 'On_ART', title="ART") 

p.1 + 
  geom_point(data = obs.onart.sheet %>% filter(Province != "All", AgeBin == '[15:100)') %>% 
    group_by(Year, Gender) %>% 
    summarize(OnART = sum(OnART), .groups = 'keep'),
    mapping= aes(x = Year, y = OnART))
```
```{r}
data.base  %>% group_by(Gender, Year) %>% 
  summarize(On_ART = mean(On_ART))


data  %>% group_by(Gender, Year) %>% 
  summarize(On_ART = mean(On_ART))
```


## CMD dynamics

How many people in each of the different categories over time?

```{r}
cmd.sdrh <- sim.results.sdrh %>% filter(Age >18) %>% 
  pivot_wider(id_cols = c(Year, Age, Gender, sim.id, scenario_name),
              names_from = c(IP_Key.CMDStatus),
              values_from = c(Population)) %>% 
  group_by(Year, Gender, sim.id, scenario_name) %>% 
  summarize(CMD_pos = sum(CMD_pos), 
            CMD_neg = sum(CMD_neg), 
            CMD_recovered = sum(CMD_recovered),
            CMD_treated = sum(CMD_treated),
            Population = sum(CMD_pos + CMD_neg + CMD_recovered + CMD_treated), 
            .groups = 'keep') %>% 
  ungroup() %>% 
  mutate(CMD_pos = case_when(Population == 0 ~ 0,
                             Population > 0 ~ CMD_pos / Population),
         CMD_neg = case_when(Population == 0 ~ 0,
                             Population > 0 ~ CMD_neg / Population),
         CMD_recovered = case_when(Population == 0 ~ 0,
                             Population > 0 ~ CMD_recovered / Population),
         CMD_treated = case_when(Population == 0 ~ 0,
                             Population > 0 ~ CMD_treated / Population)                             
                             )%>% 
  mutate(Gender = case_when(Gender==0 ~ "Male", Gender==1 ~ "Female")) %>% 
  group_by(Year, Gender) %>% 
  summarize(CMD_pos = mean(CMD_pos), CMD_neg = mean(CMD_neg),
            CMD_recovered = mean(CMD_recovered), 
            CMD_treated = mean(CMD_treated), .groups = "keep")

cmd.treat <- sim.results.treat %>% filter(Age >18) %>% 
  pivot_wider(id_cols = c(Year, Age, Gender, sim.id, scenario_name),
              names_from = c(IP_Key.CMDStatus),
              values_from = c(Population)) %>% 
  group_by(Year, Gender, sim.id, scenario_name) %>% 
  summarize(CMD_pos = sum(CMD_pos), 
            CMD_neg = sum(CMD_neg), 
            CMD_recovered = sum(CMD_recovered),
            CMD_treated = sum(CMD_treated),
            Population = sum(CMD_pos + CMD_neg + CMD_recovered + CMD_treated), 
            .groups = 'keep') %>% 
  ungroup() %>% 
  mutate(CMD_pos = case_when(Population == 0 ~ 0,
                             Population > 0 ~ CMD_pos / Population),
         CMD_neg = case_when(Population == 0 ~ 0,
                             Population > 0 ~ CMD_neg / Population),
         CMD_recovered = case_when(Population == 0 ~ 0,
                             Population > 0 ~ CMD_recovered / Population),
         CMD_treated = case_when(Population == 0 ~ 0,
                             Population > 0 ~ CMD_treated / Population)                             
                             )%>% 
  mutate(Gender = case_when(Gender==0 ~ "Male", Gender==1 ~ "Female")) %>% 
  group_by(Year, Gender) %>% 
  summarize(CMD_pos = mean(CMD_pos), CMD_neg = mean(CMD_neg),
            CMD_recovered = mean(CMD_recovered), 
            CMD_treated = mean(CMD_treated), .groups = "keep")

rbind(
  cmd.treat %>% 
    mutate(treat = "Treat") %>% 
    pivot_longer(cols = c("CMD_pos", "CMD_neg", "CMD_recovered", "CMD_treated"),
                            values_to = c("prevalence")),
  cmd.sdrh %>% mutate(treat = "No Treat")%>% 
  pivot_longer(cols = c("CMD_pos", "CMD_neg", "CMD_recovered", "CMD_treated"),
                          values_to = c("prevalence"),
               names_to = "name")
) %>% 
  ggplot() + 
  geom_line(mapping = aes(x = Year, y = prevalence, color = name)) + 
  facet_wrap(treat ~ Gender, ncol = 2)
```


## CMD prevalence over time

```{r}
# Aggregate CMD prevalence, without treatment
cmd.sdrh <- sim.results.sdrh %>% filter(Age >18) %>% 
  pivot_wider(id_cols = c(Year, Age, Gender, sim.id, scenario_name),
              names_from = c(IP_Key.CMDStatus),
              values_from = c(Population)) %>% 
  group_by(Year, Gender, sim.id, scenario_name) %>% 
  summarize(CMD_pos = sum(CMD_pos), 
            Population = sum(CMD_pos + CMD_neg + CMD_recovered + CMD_treated), 
            .groups = 'keep') %>% 
  ungroup() %>% 
  mutate(CMD_prev = case_when(Population == 0 ~ 0,
                              Population > 0 ~ CMD_pos / Population))%>% 
  mutate(Gender = case_when(Gender==0 ~ "Male", Gender==1 ~ "Female"))

cmd.sdrh.mean <- cmd.sdrh %>% 
  group_by(Year, Gender) %>% 
  summarize(CMD_prev = mean(CMD_prev))

# Aggregate CMD prevalence, with treatment
cmd.treat <- sim.results.treat %>% filter(Age >18) %>% 
  pivot_wider(id_cols = c(Year, Age, Gender, sim.id, scenario_name),
              names_from = c(IP_Key.CMDStatus),
              values_from = c(Population)) %>% 
  group_by(Year, Gender, sim.id, scenario_name) %>% 
  summarize(CMD_pos = sum(CMD_pos), 
            Population = sum(CMD_pos + CMD_neg + CMD_recovered + CMD_treated), 
            .groups = 'keep') %>% 
  ungroup() %>% 
  mutate(CMD_prev = case_when(Population == 0 ~ 0,
                              Population > 0 ~ CMD_pos / Population))%>% 
  mutate(Gender = case_when(Gender==0 ~ "Male", Gender==1 ~ "Female"))

cmd.treat.mean <- cmd.treat %>% 
  group_by(Year, Gender) %>% 
  summarize(CMD_prev = mean(CMD_prev))

# Plot  
p = ggplot() +
  geom_line(data = cmd.sdrh.mean, 
               size=2.0, aes(x=Year, y=CMD_prev), color = 'darkgreen') +
  # geom_line(data = cmd.sdrh, 
  #           mapping = aes(x = Year, y = CMD_prev, group = sim.id), color = 'darkgreen', 
  #           alpha = .01) + 
  geom_line(data = cmd.treat.mean, 
               size=2.0, aes(x=Year, y=CMD_prev), color = 'purple') +
  
  #geom_errorbar(data= data.mean, mapping = aes(x = Year, ymin = lb, ymax = ub), color="black", width=2, size=1) + 
    facet_wrap(~ Gender, ncol=2) +
    xlab("Year")+ylab("") + 
    theme_bw(base_size=16) +
    guides(fill = guide_legend(keywidth = 2, keyheight = 1)) +
    scale_x_continuous(breaks = seq(1990,2040,10)) +
    theme(legend.position="bottom") +
    theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
    theme(strip.background = element_rect(colour="black", fill="white")) +
    theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())

p

```

## CMD prevalence by age

```{r}
cmd.data.age <- sim.results.sdrh %>% 
  pivot_wider(id_cols = c(Year, Age, Gender, sim.id, scenario_name),
              names_from = c(IP_Key.CMDStatus),
              values_from = c(Population)) %>% 
  group_by(Year, Age, Gender, sim.id, scenario_name) %>% 
  summarize(CMD_pos = sum(CMD_pos), 
            Population = sum(CMD_pos + CMD_neg + CMD_recovered + CMD_treated), 
            .groups = 'keep') %>% 
  ungroup() %>% 
  mutate(CMD_prev = case_when(Population == 0 ~ 0,
                              Population > 0 ~ CMD_pos / Population)) %>% 
  mutate(Gender = case_when(Gender==0 ~ "Male", Gender==1 ~ "Female"))

age_bins = c(18, 25, 30, 40, 45, 50, 60, 99)
age_labels = c()
for (i in 1:(length(age_bins) - 1)){
  age_labels <- append(age_labels, paste0("[",age_bins[i],":",age_bins[i + 1],")"))
}

# Label each age by its bin
cmd.data.age <- cmd.data.age %>% mutate(
  AgeBin = cut(Age, breaks = age_bins, right = FALSE)
  ) %>%
  filter(!is.na(AgeBin))
cmd.data.age$AgeBin_index = factor(cmd.data.age$AgeBin,labels = 1:length(age_labels))

cmd.data.age.mean <- cmd.data.age %>% group_by(Year, AgeBin_index, AgeBin, Gender, scenario_name) %>% 
  summarize(mean.CMD_prev = mean(CMD_prev),
              sd.CMD_prev = sd(CMD_prev),
              .groups = 'keep') %>% 
  mutate(lower = max(mean.CMD_prev - 2* sd.CMD_prev, 0), 
           upper = mean.CMD_prev + 2*sd.CMD_prev)

p <- cmd.data.age.mean %>% filter(Year %in% c(1994, 2004, 2014, 2024)) %>% 
    ggplot() + 
    # plot means
    geom_point(
      mapping = aes(x = AgeBin_index, y = mean.CMD_prev),
      size=2, color = 'darkgreen'
    ) + 
    geom_errorbar(
      mapping = aes(x=AgeBin_index, ymin=lower, ymax=upper),
      width=.3, size=2, color = 'darkgreen') + 
    facet_grid(cols = vars(Gender), rows = vars(Year)) + 
    xlab("Age") + ylab("") + 
    theme_bw(base_size=16) +
    guides(fill = guide_legend(keywidth = 2, keyheight = 1)) +
    scale_x_discrete(
      breaks = 1:length(age_labels),
      labels = age_labels
      ) +
    theme(legend.position="bottom") +
    theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
    theme(strip.background = element_rect(colour="black", fill="white")) +
    theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())

p
```

```{r}
cmd.data.age.mean %>% filter(Year == 2004) %>% arrange(Gender, AgeBin) %>% head(14)
```


```{r}
cmd.data.age.treat <- sim.results.treat %>% 
  pivot_wider(id_cols = c(Year, Age, Gender, sim.id, scenario_name),
              names_from = c(IP_Key.CMDStatus),
              values_from = c(Population)) %>% 
  group_by(Year, Age, Gender, sim.id, scenario_name) %>% 
  summarize(CMD_pos = sum(CMD_pos), 
            Population = sum(CMD_pos + CMD_neg + CMD_recovered + CMD_treated), 
            .groups = 'keep') %>% 
  ungroup() %>% 
  mutate(CMD_prev = case_when(Population == 0 ~ 0,
                              Population > 0 ~ CMD_pos / Population)) %>% 
  mutate(Gender = case_when(Gender==0 ~ "Male", Gender==1 ~ "Female"))

age_bins = c(18, 25, 30, 40, 45, 50, 60, 99)
age_labels = c()
for (i in 1:(length(age_bins) - 1)){
  age_labels <- append(age_labels, paste0("[",age_bins[i],":",age_bins[i + 1],")"))
}

# Label each age by its bin
cmd.data.age.treat <- cmd.data.age.treat %>% mutate(
  AgeBin = cut(Age, breaks = age_bins, right = FALSE)
  ) %>%
  filter(!is.na(AgeBin))
cmd.data.age.treat$AgeBin_index = factor(cmd.data.age.treat$AgeBin,labels = 1:length(age_labels))

cmd.data.age.treat.mean <- cmd.data.age.treat %>% group_by(Year, AgeBin_index, AgeBin, Gender, scenario_name) %>% 
  summarize(mean.CMD_prev = mean(CMD_prev),
              sd.CMD_prev = sd(CMD_prev),
              .groups = 'keep') %>% 
  mutate(lower = max(mean.CMD_prev - 2* sd.CMD_prev, 0), 
           upper = mean.CMD_prev + 2*sd.CMD_prev)

p <- cmd.data.age.treat.mean %>% filter(Year %in% c(1994, 2004, 2014, 2024)) %>% 
    ggplot() + 
    # plot means
    geom_point(
      mapping = aes(x = AgeBin_index, y = mean.CMD_prev),
      size=2, color = 'darkgreen'
    ) + 
    geom_errorbar(
      mapping = aes(x=AgeBin_index, ymin=lower, ymax=upper),
      width=.3, size=2, color = 'darkgreen') + 
    facet_grid(cols = vars(Gender), rows = vars(Year)) + 
    xlab("Age") + ylab("") + 
    theme_bw(base_size=16) +
    guides(fill = guide_legend(keywidth = 2, keyheight = 1)) +
    scale_x_discrete(
      breaks = 1:length(age_labels),
      labels = age_labels
      ) +
    theme(legend.position="bottom") +
    theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
    theme(strip.background = element_rect(colour="black", fill="white")) +
    theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())

p
```
```{r}
cmd.data.age.mean %>% filter(Year == 2024)
```

```{r}

cmd.data.age.treat.mean %>% filter(Year == 2024)
```


## Event records

### No Treatment

```{r}
event.rec.path <- "/gpfs/scratch/citrod01/experiments/MATUMAINI/Baseline-campaign_MATUMAINI_202305-sdrh_notreat___2023_06_22_16_32_29_228473/Simulation_1CZS1LP8/output/ReportEventRecorder.csv"

event.rec = read_csv(event.rec.path)

merge(
  event.rec %>% filter(Event_Name != "HCTTestingLoopRapidTest"),
  event.rec %>% filter(Event_Name != "HCTTestingLoopRapidTest") %>% 
    group_by(Individual_ID) %>% summarize(n = n()) %>% filter(n >= 4),
  by = "Individual_ID"
) %>% 
  arrange(Individual_ID, Time) %>% View
```

### Treatment

```{r}
event.rec.path <- "/gpfs/scratch/citrod01/experiments/MATUMAINI/Baseline-campaign_MATUMAINI_202305-sdrh_treatall___2023_06_22_16_33_05_739895/Simulation_1JBBS3G2/output/ReportEventRecorder.csv"

event.rec.treat = read_csv(event.rec.path)

merge(
  event.rec.treat %>% filter(Event_Name != "HCTTestingLoopRapidTest"),
  event.rec.treat %>% filter(Event_Name != "HCTTestingLoopRapidTest") %>% 
    group_by(Individual_ID) %>% summarize(n = n()) %>% filter(n >= 4),
  by = "Individual_ID"
) %>% 
  arrange(Individual_ID, Time) %>% View
```

# Baseline Nyanza model with no modifications

The problem I have run into is that I no longer understand which modifications that I have made to the model have changed the results and made the calibration more difficult. I am going to have to go back and methodically check on the modifications which were made, starting with the baseline case and moving on to ART mortality table change.

```{r}
res.path.base = "/gpfs/data/bershteynlab/EMOD/citrod01/MATUMAINI/202301_Nyanza_Baseline_MalariaOngoing_original/model_0/Baseline-campaign_Nyanza_baseline_202301-Baseline/ReportHIVByAgeAndGender/"
#res.path = "/gpfs/scratch/citrod01/experiments/MATUMAINI/Baseline-campaign_Nyanza_baseline_202301-Baseline___2023_06_28_15_07_37_768863"

sim.results.base <- EMODAnalyzeR::read.simulation.results(
  results_path  = res.path.base,
  scenario_name = 'base',
  summarize_columns = c("Population","Infected", "On_ART",
                        "Died", "Died_from_HIV",
                        "Newly.Infected","Diagnosed"),
  stratify_columns = c("Year", "Gender", "Age"),
  min_age_inclusive = 0,
  max_age_inclusive = 99
)

CENSUS_YEAR = 2009
KEN_CENSUS_POP = 5352385

sim.results.pop.scaling <- sim.results.base %>% 
      filter(Year == CENSUS_YEAR) %>%
      group_by(sim.id) %>%
      summarize(total.pop = sum(Population), .groups = 'keep') %>% 
      mutate(pop.scaling.factor = KEN_CENSUS_POP/total.pop)

sim.results.base <- sim.results.base %>% 
  inner_join(
    sim.results.pop.scaling,
    by = c("sim.id")
  )
```

## HIV Prevalence Over Time

```{r}
ingest.file.base = "/gpfs/data/bershteynlab/EMOD/citrod01/MATUMAINI/202301_Nyanza_Baseline_MalariaOngoing_original/Data/calibration_ingest_form_Nyanza.xlsm"

obs.prev.sheet.base <- EMODAnalyzeR::read.ingest.sheet(ingest.file.base, "Obs-Prevalence")
```


```{r}
data.base <- sim.results.base %>% filter(Age <= 50, Age >= 15, Year > 1990, Year <=2040) %>% 
  dplyr::group_by(Year, Gender, sim.id, scenario_name) %>%
  dplyr::summarize(Infected = sum(Infected), Population = sum(Population), .groups = 'keep') %>%
  ungroup( ) %>% 
  dplyr::mutate(Prevalence = case_when(Population == 0 ~ 0,
                                       Population > 0 ~ Infected / Population))%>% 
  mutate(Gender = case_when(Gender==0 ~ "Male", Gender==1 ~ "Female"))

data.base.mean <- data.base %>% 
  group_by(Year, Gender) %>% 
  summarize(std = sd(Prevalence), Prevalence = mean(Prevalence)) %>% 
  mutate(lb = Prevalence + std, ub = Prevalence + std)

p = ggplot() +
  geom_line(data = data.base.mean,
               size=2.0, aes(x=Year, y=Prevalence), color = 'darkred') +
  geom_line(data = data.base,
            mapping = aes(x = Year, y = Prevalence, group = sim.id), color = 'darkred',
            alpha = .01) +
  #geom_errorbar(data= data.mean, mapping = aes(x = Year, ymin = lb, ymax = ub), color="black", width=2, size=1) +
    facet_wrap(~ Gender, ncol=2) +
    xlab("Year")+ylab("") +
    theme_bw(base_size=16) +
    guides(fill = guide_legend(keywidth = 2, keyheight = 1)) +
    scale_x_continuous(breaks = seq(1990,2040,10)) +
    theme(legend.position="bottom") +
    theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
    theme(strip.background = element_rect(colour="black", fill="white")) +
    theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())

p +
  geom_point(data = obs.prev.sheet.base %>%
               filter(Province == 'All', AgeBin == "[15:50)", Gender %in% c("Male", "Female")),
             mapping = aes(x = Year, y = Prevalence)) + 
  geom_errorbar(data = obs.prev.sheet.base %>%
             filter(Province == 'All', AgeBin == "[15:50)", Gender %in% c("Male", "Female")),
             mapping = aes(x = Year, ymin = lb, ymax = ub))
  

```

## Numbers on ART Over Time


```{r}
ingest.file.base = "/gpfs/data/bershteynlab/EMOD/citrod01/MATUMAINI/202301_Nyanza_Baseline_MalariaOngoing_original/Data/calibration_ingest_form_Nyanza.xlsm"

obs.art.sheet.base <- EMODAnalyzeR::read.ingest.sheet(ingest.file.base, "Obs-OnART")
```

```{r}
data.base <- sim.results.base %>% 
  filter(Age > 15) %>% 
  group_by(Year, Gender, sim.id, scenario_name) %>% 
  summarize(On_ART = sum(On_ART*pop.scaling.factor), Population = sum(Population), .groups = 'keep')  %>% 
  ungroup( ) %>% 
  mutate(Gender = case_when(Gender==0 ~ "Male", Gender==1 ~ "Female"))

data.base.mean <- data.base %>% 
  group_by(Year, Gender) %>% 
  summarize(On_ART = mean(On_ART), .groups = "keep") %>% ungroup()

p = ggplot() +
  geom_line(data = data.base.mean, 
               size=2.0, aes(x= Year, y= On_ART), color = 'darkred') +
  geom_line(data = data.base, 
            mapping = aes(x = Year, y = On_ART, group = sim.id), color = 'darkred', 
            alpha = .01) +
    facet_wrap(~ Gender, ncol=2) +
    xlab("Year")+ylab("") + 
    theme_bw(base_size=16) +
    guides(fill = guide_legend(keywidth = 2, keyheight = 1)) +
    scale_x_continuous(breaks = seq(1990,2040,10)) +
    theme(legend.position="bottom") +
    theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
    theme(strip.background = element_rect(colour="black", fill="white")) +
    theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())

p + 
  geom_point(data = obs.art.sheet.base %>% filter(Province != "All", Gender %in% c("Male", "Female"), AgeBin == "[15:100)") %>%
              group_by(Year, Gender) %>% 
              summarize(OnART = sum(OnART)) %>% ungroup() %>% 
              mutate(lb = OnART - OnART/5,
                     ub = OnART + OnART/5),
             mapping = aes(x = Year, y = OnART)) + 
  geom_errorbar(data = obs.art.sheet.base %>% filter(Province != "All", Gender %in% c("Male", "Female"), AgeBin == "[15:100)") %>%
              group_by(Year, Gender) %>% 
              summarize(OnART = sum(OnART)) %>% ungroup() %>% 
              mutate(lb = OnART - OnART/5,
                     ub = OnART + OnART/5),
             mapping = aes(x = Year, ymin = lb, ymax = ub))
```

# Baseline Nyanza Model + ARTMortalityTable

The next step will be to create a new campaign file that only swaps out the normal ART for ART mortality table:


```{r}
res.path.artmort = "/gpfs/data/bershteynlab/EMOD/citrod01/MATUMAINI/202301_Nyanza_Baseline_MalariaOngoing_ARTMort/model_1/Baseline-campaign_Nyanza_baseline_202301-Baseline/ReportHIVByAgeAndGender/"
#res.path = "/gpfs/scratch/citrod01/experiments/MATUMAINI/Baseline-campaign_Nyanza_baseline_202301-Baseline___2023_06_28_15_07_37_768863"

sim.results.artmort <- EMODAnalyzeR::read.simulation.results(
  results_path  = res.path.artmort,
  scenario_name = 'artmort',
  summarize_columns = c("Population","Infected", "On_ART",
                        "Died", "Died_from_HIV",
                        "Newly.Infected","Diagnosed"),
  stratify_columns = c("Year", "Gender", "Age"),
  min_age_inclusive = 0,
  max_age_inclusive = 99
)

CENSUS_YEAR = 2009
KEN_CENSUS_POP = 5352385

sim.results.pop.scaling <- sim.results.artmort %>% 
      filter(Year == CENSUS_YEAR) %>%
      group_by(sim.id) %>%
      summarize(total.pop = sum(Population), .groups = 'keep') %>% 
      mutate(pop.scaling.factor = KEN_CENSUS_POP/total.pop)

sim.results.artmort <- sim.results.artmort %>% 
  inner_join(
    sim.results.pop.scaling,
    by = c("sim.id")
  )
```

## HIV prevalence over time

```{r}
ingest.file.base = "/gpfs/data/bershteynlab/EMOD/citrod01/MATUMAINI/202301_Nyanza_Baseline_MalariaOngoing_original/Data/calibration_ingest_form_Nyanza.xlsm"

obs.prev.sheet.base <- EMODAnalyzeR::read.ingest.sheet(ingest.file.base, "Obs-Prevalence")
```


```{r}
data.artmort <- sim.results.artmort %>% filter(Age <= 50, Age >= 15, Year > 1990, Year <=2040) %>% 
  dplyr::group_by(Year, Gender, sim.id, scenario_name) %>%
  dplyr::summarize(Infected = sum(Infected), Population = sum(Population), .groups = 'keep') %>%
  ungroup( ) %>% 
  dplyr::mutate(Prevalence = case_when(Population == 0 ~ 0,
                                       Population > 0 ~ Infected / Population))%>% 
  mutate(Gender = case_when(Gender==0 ~ "Male", Gender==1 ~ "Female"))

data.artmort.mean <- data.artmort %>% 
  group_by(Year, Gender) %>% 
  summarize(std = sd(Prevalence), Prevalence = mean(Prevalence)) %>% 
  mutate(lb = Prevalence + std, ub = Prevalence + std)

p = ggplot() +
  geom_line(data = data.artmort.mean,
               size=2.0, aes(x=Year, y=Prevalence), color = 'darkred') +
  geom_line(data = data.artmort,
            mapping = aes(x = Year, y = Prevalence, group = sim.id), color = 'darkred',
            alpha = .01) +
  #geom_errorbar(data= data.mean, mapping = aes(x = Year, ymin = lb, ymax = ub), color="black", width=2, size=1) +
    facet_wrap(~ Gender, ncol=2) +
    xlab("Year")+ylab("") +
    theme_bw(base_size=16) +
    guides(fill = guide_legend(keywidth = 2, keyheight = 1)) +
    scale_x_continuous(breaks = seq(1990,2040,10)) +
    theme(legend.position="bottom") +
    theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
    theme(strip.background = element_rect(colour="black", fill="white")) +
    theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())

p +
  geom_point(data = obs.prev.sheet.base %>%
               filter(Province == 'All', AgeBin == "[15:50)", Gender %in% c("Male", "Female")),
             mapping = aes(x = Year, y = Prevalence)) + 
  geom_errorbar(data = obs.prev.sheet.base %>%
             filter(Province == 'All', AgeBin == "[15:50)", Gender %in% c("Male", "Female")),
             mapping = aes(x = Year, ymin = lb, ymax = ub))
  

```

## Numbers diagnosed over time

```{r}
artmort.diag <- sim.results.artmort %>% filter(Age <= 50, Age >= 15, Year > 1990, Year <=2040) %>% 
  dplyr::group_by(Year, Gender, sim.id, scenario_name) %>%
  dplyr::summarize(Diagnosed = sum(Diagnosed), Infected = sum(Infected), .groups = 'keep') %>%
  ungroup( ) %>% 
  dplyr::mutate(Prevalence = case_when(Infected == 0 ~ 0,
                                       Infected > 0 ~ Diagnosed/Infected))%>% 
  mutate(Gender = case_when(Gender==0 ~ "Male", Gender==1 ~ "Female"))

artmort.diag.mean <- artmort.diag %>% 
  group_by(Year, Gender) %>% 
  summarize(std = sd(Prevalence), Prevalence = mean(Prevalence)) %>% 
  mutate(lb = Prevalence + std, ub = Prevalence + std)

p = ggplot() +
  geom_line(data = artmort.diag.mean,
               size=2.0, aes(x=Year, y=Prevalence), color = 'darkred') +
  geom_line(data = artmort.diag,
            mapping = aes(x = Year, y = Prevalence, group = sim.id), color = 'gray',
            alpha = .01) +
  #geom_errorbar(data= data.mean, mapping = aes(x = Year, ymin = lb, ymax = ub), color="black", width=2, size=1) +
    facet_wrap(~ Gender, ncol=2) +
    xlab("Year")+ylab("") +
    theme_bw(base_size=16) +
    guides(fill = guide_legend(keywidth = 2, keyheight = 1)) +
    scale_x_continuous(breaks = seq(1990,2040,10)) +
    theme(legend.position="bottom") +
    theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
    theme(strip.background = element_rect(colour="black", fill="white")) +
    theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())

p

```


## Numbers on ART over time

```{r}
ingest.file.base = "/gpfs/data/bershteynlab/EMOD/citrod01/MATUMAINI/202301_Nyanza_Baseline_MalariaOngoing_original/Data/calibration_ingest_form_Nyanza.xlsm"

obs.art.sheet.base <- EMODAnalyzeR::read.ingest.sheet(ingest.file.base, "Obs-OnART")
```

```{r}
data.artmort <- sim.results.artmort %>% 
  filter(Age > 15) %>% 
  group_by(Year, Gender, sim.id, scenario_name) %>% 
  summarize(On_ART = sum(On_ART*pop.scaling.factor), Population = sum(Population), .groups = 'keep')  %>% 
  ungroup( ) %>% 
  mutate(Gender = case_when(Gender==0 ~ "Male", Gender==1 ~ "Female"))

data.artmort.mean <- data.artmort %>% 
  group_by(Year, Gender) %>% 
  summarize(On_ART = mean(On_ART), .groups = "keep") %>% ungroup()

p = ggplot() +
  geom_line(data = data.artmort.mean, 
               size=2.0, aes(x= Year, y= On_ART), color = 'darkred') +
  geom_line(data = data.artmort, 
            mapping = aes(x = Year, y = On_ART, group = sim.id), color = 'darkred', 
            alpha = .01) +
    facet_wrap(~ Gender, ncol=2) +
    xlab("Year")+ylab("") + 
    theme_bw(base_size=16) +
    guides(fill = guide_legend(keywidth = 2, keyheight = 1)) +
    scale_x_continuous(breaks = seq(1990,2040,10)) +
    theme(legend.position="bottom") +
    theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
    theme(strip.background = element_rect(colour="black", fill="white")) +
    theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())

p + 
  geom_point(data = obs.art.sheet.base %>% filter(Province != "All", Gender %in% c("Male", "Female"), AgeBin == "[15:100)") %>%
              group_by(Year, Gender) %>% 
              summarize(OnART = sum(OnART)) %>% ungroup() %>% 
              mutate(lb = OnART - OnART/5,
                     ub = OnART + OnART/5),
             mapping = aes(x = Year, y = OnART)) + 
  geom_errorbar(data = obs.art.sheet.base %>% filter(Province != "All", Gender %in% c("Male", "Female"), AgeBin == "[15:100)") %>%
              group_by(Year, Gender) %>% 
              summarize(OnART = sum(OnART)) %>% ungroup() %>% 
              mutate(lb = OnART - OnART/5,
                     ub = OnART + OnART/5),
             mapping = aes(x = Year, ymin = lb, ymax = ub))
```

# Model with CMD added

Because the model with ARTMortality table worked just fine with the calibration, I am going to look at what happens when we add the CMD stuff as well. Just to double check that the issue does exist.

I am using a base population factor of 0.2 this time.

```{r}
#res.path.cmd2 = "/gpfs/scratch/citrod01/experiments/MATUMAINI/Baseline-campaign_MATUMAINI_202305-base___2023_06_29_18_36_17_673584"
#res.path.cmd2 = "/gpfs/scratch/citrod01/experiments/MATUMAINI/Baseline-campaign_MATUMAINI_202305-base___2023_06_30_11_26_55_784404"
res.path.cmd2 = "/gpfs/scratch/citrod01/experiments/MATUMAINI/Baseline-campaign_MATUMAINI_202305-base___2023_06_30_16_48_21_899525"

SummarizeEachSimByAgeAndGender <- function (data, summarize_columns, stratify_columns, min_age_inclusive = 0, max_age_inclusive = Inf) {
  data %>%
    filter( (Age >= min_age_inclusive) & (Age <= max_age_inclusive) ) %>%
    group_by_at(stratify_columns) %>%
    summarise_at(summarize_columns, sum, na.rm=T) %>%
    ungroup()
}

sim.results.cmd2 <- EMODAnalyzeR::read.simulation.results.bigpurple(
  #results_path  = res.path.notreat,
  res.path.cmd2,
  scenario_name = 'sdrh',
  summarize_columns = c("Population","Infected", "On_ART",
                        "Died", "Died_from_HIV",
                        "Newly.Infected","Diagnosed"),
  stratify_columns = c("Year", "Gender", "Age"),
  min_age_inclusive = 0,
  max_age_inclusive = 99
)

CENSUS_YEAR = 2009
KEN_CENSUS_POP = 5352385

sim.results.pop.scaling <- sim.results.cmd2 %>% 
      filter(Year == CENSUS_YEAR) %>%
      group_by(sim.id) %>%
      summarize(total.pop = sum(Population), .groups = 'keep') %>% 
      mutate(pop.scaling.factor = KEN_CENSUS_POP/total.pop)

sim.results.cmd2 <- sim.results.cmd2 %>% 
  inner_join(
    sim.results.pop.scaling,
    by = c("sim.id")
  )

```


## HIV Prevalence Over Time

```{r}
ingest.file.base = "/gpfs/data/bershteynlab/EMOD/citrod01/MATUMAINI/202301_Nyanza_Baseline_MalariaOngoing_original/Data/calibration_ingest_form_Nyanza.xlsm"

obs.prev.sheet.base <- EMODAnalyzeR::read.ingest.sheet(ingest.file.base, "Obs-Prevalence")
```


```{r}
data.cmd2 <- sim.results.cmd2 %>% filter(Age <= 50, Age >= 15, Year > 1990, Year <=2040) %>% 
  dplyr::group_by(Year, Gender, sim.id, scenario_name) %>%
  dplyr::summarize(Infected = sum(Infected), Population = sum(Population), .groups = 'keep') %>%
  ungroup( ) %>% 
  dplyr::mutate(Prevalence = case_when(Population == 0 ~ 0,
                                       Population > 0 ~ Infected / Population))%>% 
  mutate(Gender = case_when(Gender==0 ~ "Male", Gender==1 ~ "Female"))

data.cmd2.mean <- data.cmd2 %>% 
  group_by(Year, Gender) %>% 
  summarize(std = sd(Prevalence), Prevalence = mean(Prevalence)) %>% 
  mutate(lb = Prevalence + std, ub = Prevalence + std)

p = ggplot() +
  geom_line(data = data.cmd2.mean,
               size=2.0, aes(x=Year, y=Prevalence), color = 'darkred') +
  geom_line(data = data.cmd2,
            mapping = aes(x = Year, y = Prevalence, group = sim.id), color = 'darkred',
            alpha = .01) +
  #geom_errorbar(data= data.mean, mapping = aes(x = Year, ymin = lb, ymax = ub), color="black", width=2, size=1) +
    facet_wrap(~ Gender, ncol=2) +
    xlab("Year")+ylab("") +
    theme_bw(base_size=16) +
    guides(fill = guide_legend(keywidth = 2, keyheight = 1)) +
    scale_x_continuous(breaks = seq(1990,2040,10)) +
    theme(legend.position="bottom") +
    theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
    theme(strip.background = element_rect(colour="black", fill="white")) +
    theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())

p +
  geom_point(data = obs.prev.sheet.base %>%
               filter(Province == 'All', AgeBin == "[15:50)", Gender %in% c("Male", "Female")),
             mapping = aes(x = Year, y = Prevalence)) + 
  geom_errorbar(data = obs.prev.sheet.base %>%
             filter(Province == 'All', AgeBin == "[15:50)", Gender %in% c("Male", "Female")),
             mapping = aes(x = Year, ymin = lb, ymax = ub))
  

```

## Numbers on ART Over Time


```{r}
ingest.file.base = "/gpfs/data/bershteynlab/EMOD/citrod01/MATUMAINI/202301_Nyanza_Baseline_MalariaOngoing_original/Data/calibration_ingest_form_Nyanza.xlsm"

obs.art.sheet.base <- EMODAnalyzeR::read.ingest.sheet(ingest.file.base, "Obs-OnART")
```

```{r}
data.cmd2 <- sim.results.cmd2 %>% 
  filter(Age > 15) %>% 
  group_by(Year, Gender, sim.id, scenario_name) %>% 
  summarize(On_ART = sum(On_ART*pop.scaling.factor), Population = sum(Population), .groups = 'keep')  %>% 
  ungroup( ) %>% 
  mutate(Gender = case_when(Gender==0 ~ "Male", Gender==1 ~ "Female"))

data.cmd2.mean <- data.cmd2 %>% 
  group_by(Year, Gender) %>% 
  summarize(On_ART = mean(On_ART), .groups = "keep") %>% ungroup()

p = ggplot() +
  geom_line(data = data.cmd2.mean %>% filter(Year < 2020) ,
               size=2.0, aes(x= Year, y= On_ART), color = 'darkred') +
  geom_line(data = data.cmd2%>% filter(Year < 2020), 
            mapping = aes(x = Year, y = On_ART, group = sim.id), color = 'darkred', 
            alpha = .01) +
    facet_wrap(~ Gender, ncol=2) +
    xlab("Year")+ylab("") + 
    theme_bw(base_size=16) +
    guides(fill = guide_legend(keywidth = 2, keyheight = 1)) +
    scale_x_continuous(breaks = seq(1990,2040,10)) +
    theme(legend.position="bottom") +
    theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
    theme(strip.background = element_rect(colour="black", fill="white")) +
    theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())

p + 
  geom_point(data = obs.art.sheet.base %>% 
               filter(Province != "All", Gender %in% c("Male", "Female"), AgeBin == "[15:100)") %>%
              group_by(Year, Gender) %>% 
              summarize(OnART = sum(OnART)) %>% ungroup() %>% 
              mutate(lb = OnART - OnART/5,
                     ub = OnART + OnART/5),
             mapping = aes(x = Year, y = OnART)) + 
  geom_errorbar(data = obs.art.sheet.base %>% filter(Province != "All", Gender %in% c("Male", "Female"), AgeBin == "[15:100)") %>%
              group_by(Year, Gender) %>% 
              summarize(OnART = sum(OnART)) %>% ungroup() %>% 
              mutate(lb = OnART - OnART/5,
                     ub = OnART + OnART/5),
             mapping = aes(x = Year, ymin = lb, ymax = ub))
```
## Event recorder

What happens when we look at the event recorder?

```{r}
event.rec.path = "/gpfs/scratch/citrod01/experiments/MATUMAINI/Baseline-campaign_MATUMAINI_202305-base___2023_06_30_16_48_21_899525/Simulation_00L059JO/output/ReportEventRecorder.csv"

event.rec.cmd = read_csv(event.rec.path)

event.rec.cmd %>% head(100)

event.rec.cmd %>% filter(Event_Name %in% c("EffectiveART", "NonSuppressiveART")) %>% 
  arrange(Individual_ID, Time) %>% View

event.rec.cmd %>% filter(Event_Name %in% c("EffectiveART", "NonSuppressiveART")) %>% 
  merge(event.rec.cmd %>% filter(Event_Name %in% c("EffectiveART", "NonSuppressiveART")) %>% 
  group_by(Individual_ID) %>% count() %>% filter(n > 1), 
  by = "Individual_ID"
    ) %>% 
  arrange(Individual_ID, Time) %>% View


```

```{r}
event.rec.cmd %>% filter(Individual_ID ==921331) %>% arrange(Individual_ID, Time) %>% View
```

# New features

Adding final set of features, with interactions between HIV -> CMD

1. Trigger depression upon HIV diagnosis
2. Trigger depression screening/treatment upon HIV diagnosis
3. Trigger depression recovery upon VLS

```{r}
# 1. Trigger depression upon HIV diagnosis
res.path.cmd2 = "/gpfs/scratch/citrod01/experiments/MATUMAINI/Baseline-campaign_MATUMAINI_202305-CMDinc_diag___2023_07_26_17_48_13_039332"

SummarizeEachSimByAgeAndGender <- function (data, summarize_columns, stratify_columns, min_age_inclusive = 0, max_age_inclusive = Inf) {
  data %>%
    filter( (Age >= min_age_inclusive) & (Age <= max_age_inclusive) ) %>%
    group_by_at(stratify_columns) %>%
    summarise_at(summarize_columns, sum, na.rm=T) %>%
    ungroup()
}

sim.results.cmd2 <- EMODAnalyzeR::read.simulation.results.bigpurple(
  #results_path  = res.path.notreat,
  res.path.cmd2,
  scenario_name = 'sdrh',
  summarize_columns = c("Population","Infected", "On_ART",
                        "Died", "Died_from_HIV",
                        "Newly.Infected","Diagnosed"),
  stratify_columns = c("Year", "Gender", "Age", "IP_Key.CMDStatus"),
  min_age_inclusive = 0,
  max_age_inclusive = 99
)

CENSUS_YEAR = 2009
KEN_CENSUS_POP = 5352385

sim.results.pop.scaling <- sim.results.cmd2 %>% 
      filter(Year == CENSUS_YEAR) %>%
      group_by(sim.id) %>%
      summarize(total.pop = sum(Population), .groups = 'keep') %>% 
      mutate(pop.scaling.factor = KEN_CENSUS_POP/total.pop)

sim.results.cmd2 <- sim.results.cmd2 %>% 
  inner_join(
    sim.results.pop.scaling,
    by = c("sim.id")
  )

```


## HIV Prevalence Over Time

```{r}
data.cmd2 <- sim.results.cmd2 %>% filter(Age <= 50, Age >= 15, Year > 1990, Year <=2040) %>% 
  dplyr::group_by(Year, Gender, sim.id, scenario_name) %>%
  dplyr::summarize(Infected = sum(Infected), Population = sum(Population), .groups = 'keep') %>%
  ungroup( ) %>% 
  dplyr::mutate(Prevalence = case_when(Population == 0 ~ 0,
                                       Population > 0 ~ Infected / Population))%>% 
  mutate(Gender = case_when(Gender==0 ~ "Male", Gender==1 ~ "Female"))

data.cmd2.mean <- data.cmd2 %>% 
  group_by(Year, Gender) %>% 
  summarize(std = sd(Prevalence), Prevalence = mean(Prevalence)) %>% 
  mutate(lb = Prevalence + std, ub = Prevalence + std)

p = ggplot() +
  geom_line(data = data.cmd2.mean,
               size=2.0, aes(x=Year, y=Prevalence), color = 'darkred') +
  geom_line(data = data.cmd2,
            mapping = aes(x = Year, y = Prevalence, group = sim.id), color = 'darkred',
            alpha = .01) +
  #geom_errorbar(data= data.mean, mapping = aes(x = Year, ymin = lb, ymax = ub), color="black", width=2, size=1) +
    facet_wrap(~ Gender, ncol=2) +
    xlab("Year")+ylab("") +
    theme_bw(base_size=16) +
    guides(fill = guide_legend(keywidth = 2, keyheight = 1)) +
    scale_x_continuous(breaks = seq(1990,2040,10)) +
    theme(legend.position="bottom") +
    theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
    theme(strip.background = element_rect(colour="black", fill="white")) +
    theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())

p +
  geom_point(data = obs.prev.sheet.base %>%
               filter(Province == 'All', AgeBin == "[15:50)", Gender %in% c("Male", "Female")),
             mapping = aes(x = Year, y = Prevalence)) + 
  geom_errorbar(data = obs.prev.sheet.base %>%
             filter(Province == 'All', AgeBin == "[15:50)", Gender %in% c("Male", "Female")),
             mapping = aes(x = Year, ymin = lb, ymax = ub))
  

```

## Numbers on ART Over Time

```{r}
data.cmd2 <- sim.results.cmd2 %>% 
  filter(Age > 15) %>% 
  group_by(Year, Gender, sim.id, scenario_name) %>% 
  summarize(On_ART = sum(On_ART*pop.scaling.factor), Population = sum(Population), .groups = 'keep')  %>% 
  ungroup( ) %>% 
  mutate(Gender = case_when(Gender==0 ~ "Male", Gender==1 ~ "Female"))

data.cmd2.mean <- data.cmd2 %>% 
  group_by(Year, Gender) %>% 
  summarize(On_ART = mean(On_ART), .groups = "keep") %>% ungroup()

p = ggplot() +
  geom_line(data = data.cmd2.mean %>% filter(Year < 2020) ,
               size=2.0, aes(x= Year, y= On_ART), color = 'darkred') +
  geom_line(data = data.cmd2%>% filter(Year < 2020), 
            mapping = aes(x = Year, y = On_ART, group = sim.id), color = 'darkred', 
            alpha = .01) +
    facet_wrap(~ Gender, ncol=2) +
    xlab("Year")+ylab("") + 
    theme_bw(base_size=16) +
    guides(fill = guide_legend(keywidth = 2, keyheight = 1)) +
    scale_x_continuous(breaks = seq(1990,2040,10)) +
    theme(legend.position="bottom") +
    theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
    theme(strip.background = element_rect(colour="black", fill="white")) +
    theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())

p + 
  geom_point(data = obs.art.sheet.base %>% 
               filter(Province != "All", Gender %in% c("Male", "Female"), AgeBin == "[15:100)") %>%
              group_by(Year, Gender) %>% 
              summarize(OnART = sum(OnART)) %>% ungroup() %>% 
              mutate(lb = OnART - OnART/5,
                     ub = OnART + OnART/5),
             mapping = aes(x = Year, y = OnART)) + 
  geom_errorbar(data = obs.art.sheet.base %>% filter(Province != "All", Gender %in% c("Male", "Female"), AgeBin == "[15:100)") %>%
              group_by(Year, Gender) %>% 
              summarize(OnART = sum(OnART)) %>% ungroup() %>% 
              mutate(lb = OnART - OnART/5,
                     ub = OnART + OnART/5),
             mapping = aes(x = Year, ymin = lb, ymax = ub))
```
## CMD prevalence over time

```{r}
# Aggregate CMD prevalence, with treatment
dat.cmd <- sim.results.cmd2 %>% filter(Age >18) %>% 
  pivot_wider(id_cols = c(Year, Age, Gender, sim.id, scenario_name),
              names_from = c(IP_Key.CMDStatus),
              values_from = c(Population)) %>% 
  group_by(Year, Gender, sim.id, scenario_name) %>% 
  summarize(CMD_pos = sum(CMD_pos), 
            Population = sum(CMD_pos + CMD_neg + CMD_recovered + CMD_treated), 
            .groups = 'keep') %>% 
  ungroup() %>% 
  mutate(CMD_prev = case_when(Population == 0 ~ 0,
                              Population > 0 ~ CMD_pos / Population))%>% 
  mutate(Gender = case_when(Gender==0 ~ "Male", Gender==1 ~ "Female"))

dat.cmd.mean <- dat.cmd %>% 
  group_by(Year, Gender) %>% 
  summarize(CMD_prev = mean(CMD_prev))

# Plot  
p = ggplot() +
  geom_line(data = dat.cmd.mean, 
               size=2.0, aes(x=Year, y=CMD_prev), color = 'darkgreen') +
  # geom_line(data = cmd.sdrh, 
  #           mapping = aes(x = Year, y = CMD_prev, group = sim.id), color = 'darkgreen', 
  #           alpha = .01) + 
  geom_line(data = cmd.treat.mean, 
               size=2.0, aes(x=Year, y=CMD_prev), color = 'purple') +
  
  #geom_errorbar(data= data.mean, mapping = aes(x = Year, ymin = lb, ymax = ub), color="black", width=2, size=1) + 
    facet_wrap(~ Gender, ncol=2) +
    xlab("Year")+ylab("") + 
    theme_bw(base_size=16) +
    guides(fill = guide_legend(keywidth = 2, keyheight = 1)) +
    scale_x_continuous(breaks = seq(1990,2040,10)) +
    theme(legend.position="bottom") +
    theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
    theme(strip.background = element_rect(colour="black", fill="white")) +
    theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())

p
```

