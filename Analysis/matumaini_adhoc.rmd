---
title: "Ad Hoc Analysis of MATUMAINI Mental Health Model"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

The purpose of this notebook is to be able to perform quick ad hoc analysis of the mental health model outputs.

Generally speaking, I will be using this notebook to compare different versions of the model. One version will be baseline, and the other version of the model will have one or more changes to the baseline model. We will compare to see whether the changes to the baseline model yield expected results.

```{r Load Libraries}
library(tidyverse)
library(tidyr)
library(data.table)
library(magrittr)
library(ggplot2)
library(devtools)
library(readxl)
devtools::install_github("BershteynLab/EMODAnalyzeR")
```

# Useful Functions

```{r}

calculate.prevalence <- function(data, stratify_columns = c("Year", "Gender", "sim.id"), numerator = 'Infected', denominator = 'Population'){
  data['num'] = data[numerator]
  data['den'] = data[denominator]
  data <- data %>% 
    dplyr::group_by_at(stratify_columns) %>% 
    dplyr::summarize_at(c('num', 'den'), sum, na.rm = T) %>% 
    ungroup() %>%
    dplyr::mutate(Prevalence = case_when(den == 0 ~ 0,
                                         den > 0 ~ num/den)) 
  
  colnames(data) <- c(stratify_columns, numerator, denominator, "Prevalence")
  
  return(data)
}

```


# Read in Data

```{r Baseline results}
res.path.base = "/gpfs/data/bershteynlab/EMOD/citrod01/MATUMAINI/202301_Nyanza_Baseline_MalariaOngoing/test_6/Baseline-campaign_MATUMAINI_202305-delay_base/ReportHIVByAgeAndGender"

sim.results.base <- EMODAnalyzeR::read.simulation.results(
  results_path  = res.path.base,
  scenario_name = 'prep',
  summarize_columns = c("Population","Infected", "On_ART",
                        "Died", "Died_from_HIV",
                        "Newly.Infected","Diagnosed", "Tested.Past.Year.or.On_ART", 
                        "Tested.Ever", "Newly.Tested.Positive", "Newly.Tested.Negative"),
  stratify_columns = c("Year", "Gender", "Age", "IP_Key.CMDStatus"),
  min_age_inclusive = 0,
  max_age_inclusive = 99
)

CENSUS_YEAR = 2009
KEN_CENSUS_POP = 5352385

sim.results.pop.scaling <- sim.results.base %>% 
      filter(Year == CENSUS_YEAR) %>%
      group_by(sim.id) %>%
      summarize(total.pop = sum(Population), .groups = 'keep') %>% 
      mutate(pop.scaling.factor = KEN_CENSUS_POP/total.pop)

sim.results.base <- sim.results.base %>% 
  inner_join(
    sim.results.pop.scaling,
    by = c("sim.id")
  )

```

```{r Changed model results}
res.path.new = "/gpfs/data/bershteynlab/EMOD/citrod01/MATUMAINI/202301_Nyanza_Baseline_MalariaOngoing/test_6/Baseline-campaign_MATUMAINI_202305-delay_new/ReportHIVByAgeAndGender/"

sim.results.new <- EMODAnalyzeR::read.simulation.results(
  results_path  = res.path.new,
  scenario_name = 'prep',
  summarize_columns = c("Population","Infected", "On_ART",
                        "Died", "Died_from_HIV",
                        "Newly.Infected","Diagnosed", "Tested.Past.Year.or.On_ART", 
                        "Tested.Ever", "Newly.Tested.Positive", "Newly.Tested.Negative"),
  stratify_columns = c("Year", "Gender", "Age", "IP_Key.CMDStatus"),
  min_age_inclusive = 0,
  max_age_inclusive = 99
)

CENSUS_YEAR = 2009
KEN_CENSUS_POP = 5352385

sim.results.pop.scaling <- sim.results.new %>% 
      filter(Year == CENSUS_YEAR) %>%
      group_by(sim.id) %>%
      summarize(total.pop = sum(Population), .groups = 'keep') %>% 
      mutate(pop.scaling.factor = KEN_CENSUS_POP/total.pop)

sim.results.new <- sim.results.new %>% 
  inner_join(
    sim.results.pop.scaling,
    by = c("sim.id")
  )

```


## Prevalence 
```{r}
base.prev <- sim.results.base %>% 
  calculate.prevalence(numerator = 'Infected', denominator = 'Population') %>% 
  # dplyr::group_by(Year, Gender) %>% dplyr::summarize(Prevalence = mean(Prevalence), .groups = 'keep') %>% 
  # ungroup %>% 
  mutate(scenario_name = 'blah')

EMODAnalyzeR::emodplot.by_gender(base.prev,
                   date.start = 1990, date.end = 2040,
                   col2plot = 'Prevalence',
                   title = 'CMD Prevalence'
)
```

### Prevalence by CMD status

Remember: the incidence of depression is twice as high for people who are HIV positive

```{r}
base.prev.cmd.pos <- sim.results.base %>% 
  filter(Age >= 15) %>% 
  filter(IP_Key.CMDStatus == 'CMD_pos') %>%
  group_by(Year, Gender, sim.id) %>% 
  dplyr::summarize(Infected = sum(Infected), 
                   Population = sum(Population), .groups = 'keep') %>% 
  ungroup() %>% 
  mutate(Prevalence = case_when(Population == 0 ~ 0,
                          Population > 0 ~ Infected / Population)) %>% 
  group_by(Year, Gender) %>% 
  dplyr::summarize(Prevalence.cmd.pos = mean(Prevalence), .groups = 'keep')

base.prev.cmd.neg <- sim.results.base %>% 
  filter(Age >= 15) %>% 
  filter(IP_Key.CMDStatus == 'CMD_neg') %>%
    group_by(Year, Gender, sim.id) %>% 
  dplyr::summarize(Infected = sum(Infected), 
                   Population = sum(Population), .groups = 'keep') %>% 
  ungroup() %>% 
  mutate(Prevalence = case_when(Population == 0 ~ 0,
                          Population > 0 ~ Infected / Population)) %>% 
  group_by(Year, Gender) %>% 
  dplyr::summarize(Prevalence.cmd.neg = mean(Prevalence), .groups = 'keep')

merge(
  base.prev.cmd.pos, base.prev.cmd.neg, by = c("Year", "Gender")
)
```

```{r}
new.prev.cmd.pos <- sim.results.new %>% 
  filter(Age >= 15) %>% 
  filter(IP_Key.CMDStatus == 'CMD_pos') %>%
  group_by(Year, Gender, sim.id) %>% 
  dplyr::summarize(Infected = sum(Infected), 
                   Population = sum(Population), .groups = 'keep') %>% 
  ungroup() %>% 
  mutate(Prevalence = case_when(Population == 0 ~ 0,
                          Population > 0 ~ Infected / Population)) %>% 
  group_by(Year, Gender) %>% 
  dplyr::summarize(Prevalence.cmd.pos = mean(Prevalence), .groups = 'keep')

new.prev.cmd.neg <- sim.results.new %>% 
  filter(Age >= 15) %>% 
  filter(IP_Key.CMDStatus != 'CMD_pos') %>%
  group_by(Year, Gender, sim.id) %>% 
  dplyr::summarize(Infected = sum(Infected), 
                   Population = sum(Population), .groups = 'keep') %>% 
  ungroup() %>% 
  mutate(Prevalence = case_when(Population == 0 ~ 0,
                          Population > 0 ~ Infected / Population)) %>% 
  group_by(Year, Gender) %>% 
  dplyr::summarize(Prevalence.cmd.neg = mean(Prevalence), .groups = 'keep')

merge(
  new.prev.cmd.pos, new.prev.cmd.neg, by = c("Year", "Gender")
) %>% tail(10)
```

## Diagnosis of PLHIV

```{r Diagnosis by CMD status - young adults}
## Baseline
base.diag.cmd.pos <- sim.results.base %>% 
  filter(Age >= 18, Age < 25) %>% 
  filter(IP_Key.CMDStatus == 'CMD_pos') %>%
  group_by(Year, Gender, sim.id) %>% 
  dplyr::summarize(Diagnosed = sum(Diagnosed), 
                   Infected = sum(Infected), .groups = 'keep') %>% 
  ungroup() %>% 
  mutate(Diagnosed = case_when(Infected == 0 ~ 0,
                          Infected > 0 ~ Diagnosed / Infected)) %>% 
  group_by(Year, Gender) %>% 
  dplyr::summarize(Diagnosed.cmd.pos = mean(Diagnosed), .groups = 'keep')

base.diag.cmd.neg <- sim.results.base %>% 
  filter(Age >= 18, Age < 25) %>% 
  filter(IP_Key.CMDStatus != 'CMD_pos') %>%
  group_by(Year, Gender, sim.id) %>% 
  dplyr::summarize(Diagnosed = sum(Diagnosed), 
                   Infected = sum(Infected), .groups = 'keep') %>% 
  ungroup() %>% 
  mutate(Diagnosed = case_when(Infected == 0 ~ 0,
                          Infected > 0 ~ Diagnosed / Infected)) %>% 
  group_by(Year, Gender) %>% 
  dplyr::summarize(Diagnosed.cmd.neg = mean(Diagnosed), .groups = 'keep')

# merge(
#   base.diag.cmd.pos, base.diag.cmd.neg, by = c("Year", "Gender")
# ) %>% head(10)

## New
new.diag.cmd.pos <- sim.results.new %>% 
  filter(Age >= 18, Age < 25) %>% 
  filter(IP_Key.CMDStatus == 'CMD_pos') %>%
  group_by(Year, Gender, sim.id) %>% 
  dplyr::summarize(Diagnosed = sum(Diagnosed), 
                   Infected = sum(Infected), .groups = 'keep') %>% 
  ungroup() %>% 
  mutate(Diagnosed = case_when(Infected == 0 ~ 0,
                          Infected > 0 ~ Diagnosed / Infected)) %>% 
  group_by(Year, Gender) %>% 
  dplyr::summarize(Diagnosed.cmd.pos = mean(Diagnosed), .groups = 'keep')

new.diag.cmd.neg <- sim.results.new %>% 
  filter(Age >= 18, Age < 25) %>% 
  filter(IP_Key.CMDStatus != 'CMD_pos') %>%
  group_by(Year, Gender, sim.id) %>% 
  dplyr::summarize(Diagnosed = sum(Diagnosed), 
                   Infected = sum(Infected), .groups = 'keep') %>% 
  ungroup() %>% 
  mutate(Diagnosed = case_when(Infected == 0 ~ 0,
                          Infected > 0 ~ Diagnosed / Infected)) %>% 
  group_by(Year, Gender) %>% 
  dplyr::summarize(Diagnosed.cmd.neg = mean(Diagnosed), .groups = 'keep')

# merge(
#   new.diag.cmd.pos, new.diag.cmd.neg, by = c("Year", "Gender")
# ) %>% head(10)

merge(
  merge(
    base.diag.cmd.pos, base.diag.cmd.neg, by = c("Year", "Gender")
  ),
  merge(
    new.diag.cmd.pos, new.diag.cmd.neg, by = c("Year", "Gender")
  ),
  by = c("Year", "Gender"),
  suffixes = c("base","new")
) %>% View

```


```{r Diagnosis by CMD status -  stratify by age}
## Baseline
base.diag.cmd.pos <- sim.results.base %>% 
  filter(Age > 18) %>% 
  filter(IP_Key.CMDStatus == 'CMD_pos') %>%
  group_by(Year, Gender, Age, sim.id) %>% 
  dplyr::summarize(Diagnosed = sum(Diagnosed), 
                   Infected = sum(Infected), .groups = 'keep') %>% 
  ungroup() %>% 
  mutate(Diagnosed = case_when(Infected == 0 ~ 0,
                          Infected > 0 ~ Diagnosed / Infected)) %>% 
  group_by(Year, Gender, Age) %>% 
  dplyr::summarize(Diagnosed.cmd.pos = mean(Diagnosed), .groups = 'keep')

base.diag.cmd.neg <- sim.results.base %>% 
  filter(Age > 18) %>% 
  filter(IP_Key.CMDStatus != 'CMD_pos') %>%
  group_by(Year, Gender, Age, sim.id) %>% 
  dplyr::summarize(Diagnosed = sum(Diagnosed), 
                   Infected = sum(Infected), .groups = 'keep') %>% 
  ungroup() %>% 
  mutate(Diagnosed = case_when(Infected == 0 ~ 0,
                          Infected > 0 ~ Diagnosed / Infected)) %>% 
  group_by(Year, Gender, Age) %>% 
  dplyr::summarize(Diagnosed.cmd.neg = mean(Diagnosed), .groups = 'keep')

# merge(
#   base.diag.cmd.pos, base.diag.cmd.neg, by = c("Year", "Gender")
# ) %>% head(10)

## New
new.diag.cmd.pos <- sim.results.new %>% 
  filter(Age > 18) %>% 
  filter(IP_Key.CMDStatus == 'CMD_pos') %>%
  group_by(Year, Gender, Age, sim.id) %>% 
  dplyr::summarize(Diagnosed = sum(Diagnosed), 
                   Infected = sum(Infected), .groups = 'keep') %>% 
  ungroup() %>% 
  mutate(Diagnosed = case_when(Infected == 0 ~ 0,
                          Infected > 0 ~ Diagnosed / Infected)) %>% 
  group_by(Year, Gender, Age) %>% 
  dplyr::summarize(Diagnosed.cmd.pos = mean(Diagnosed), .groups = 'keep')

new.diag.cmd.neg <- sim.results.new %>% 
  filter(Age > 18) %>% 
  filter(IP_Key.CMDStatus != 'CMD_pos') %>%
  group_by(Year, Gender, Age, sim.id) %>% 
  dplyr::summarize(Diagnosed = sum(Diagnosed), 
                   Infected = sum(Infected), .groups = 'keep') %>% 
  ungroup() %>% 
  mutate(Diagnosed = case_when(Infected == 0 ~ 0,
                          Infected > 0 ~ Diagnosed / Infected)) %>% 
  group_by(Year, Gender, Age) %>% 
  dplyr::summarize(Diagnosed.cmd.neg = mean(Diagnosed), .groups = 'keep')

# merge(
#   new.diag.cmd.pos, new.diag.cmd.neg, by = c("Year", "Gender")
# ) %>% head(10)

merge(
  merge(
    base.diag.cmd.pos, base.diag.cmd.neg, by = c("Year", "Gender", "Age")
  ),
  merge(
    new.diag.cmd.pos, new.diag.cmd.neg, by = c("Year", "Gender", "Age")
  ),
  by = c("Year", "Gender", "Age"),
  suffixes = c("base","new")
) %>% 
  arrange(Year, Gender, Age) %>% 
  View

```

### Testing uptake

This is the number of people tested in the past year, stratified by HIV status and depression status


```{r Testing uptake for baseline}
# HIV positive testing coverage by CMD status
test.uptake.pos <- sim.results.base %>% 
  filter(Age > 18, Age <= 25) %>% 
  filter(IP_Key.CMDStatus == 'CMD_pos') %>%
  group_by(Year, Gender, sim.id) %>% 
  dplyr::summarize(Newly.Tested.Positive = sum(Newly.Tested.Positive),
                   Newly.Tested.Negative = sum(Newly.Tested.Negative),
                   Population = sum(Population), .groups = 'keep') %>% 
  ungroup() %>% 
  mutate(uptake = case_when(Population == 0 ~ 0,
                          Population > 0 ~ (Newly.Tested.Positive + Newly.Tested.Negative)/Population)) %>%
  group_by(Year, Gender) %>% 
  dplyr::summarize(Newly.Tested.Positive = mean(Newly.Tested.Positive),
                   Newly.Tested.Negative = mean(Newly.Tested.Negative),
                   Population = mean(Population),
                   uptake = mean(uptake),
                   .groups = 'keep')

test.uptake.neg <- sim.results.base %>% 
  filter(Age > 18, Age <= 25) %>% 
  filter(IP_Key.CMDStatus == 'CMD_neg') %>%
  group_by(Year, Gender, sim.id) %>% 
  dplyr::summarize(Newly.Tested.Positive = sum(Newly.Tested.Positive),
                   Newly.Tested.Negative = sum(Newly.Tested.Negative),
                   Population = sum(Population), .groups = 'keep') %>% 
  ungroup() %>% 
  mutate(uptake = case_when(Population == 0 ~ 0,
                          Population > 0 ~ (Newly.Tested.Positive + Newly.Tested.Negative)/Population)) %>%
  group_by(Year, Gender) %>% 
  dplyr::summarize(Newly.Tested.Positive = mean(Newly.Tested.Positive),
                   Newly.Tested.Negative = mean(Newly.Tested.Negative),
                   Population = mean(Population),
                   uptake = mean(uptake),
                   .groups = 'keep')

merge(
  test.uptake.pos,
  test.uptake.neg,
  by = c("Year", "Gender"),
  suffixes = c(".pos",".neg")
) %>% 
  arrange(Year, Gender) %>% 
  View
```


This one seems to indicate that the testing uptake is higher in CMD negative people.
```{r Testing uptake for new}
# HIV positive testing coverage by CMD status
test.uptake.pos <- sim.results.new %>% 
  filter(Age > 18, Age <= 25) %>% 
  filter(IP_Key.CMDStatus == 'CMD_pos') %>%
  group_by(Year, Gender, sim.id) %>% 
  dplyr::summarize(Newly.Tested.Positive = sum(Newly.Tested.Positive),
                   Newly.Tested.Negative = sum(Newly.Tested.Negative),
                   Population = sum(Population), .groups = 'keep') %>% 
  ungroup() %>% 
  mutate(uptake = case_when(Population == 0 ~ 0,
                          Population > 0 ~ (Newly.Tested.Positive + Newly.Tested.Negative)/Population)) %>%
  group_by(Year, Gender) %>% 
  dplyr::summarize(Newly.Tested.Positive = mean(Newly.Tested.Positive),
                   Newly.Tested.Negative = mean(Newly.Tested.Negative),
                   Population = mean(Population),
                   uptake = mean(uptake),
                   .groups = 'keep')

test.uptake.neg <- sim.results.new %>% 
  filter(Age > 18, Age <= 25) %>% 
  filter(IP_Key.CMDStatus == 'CMD_neg') %>%
  group_by(Year, Gender, sim.id) %>% 
  dplyr::summarize(Newly.Tested.Positive = sum(Newly.Tested.Positive),
                   Newly.Tested.Negative = sum(Newly.Tested.Negative),
                   Population = sum(Population), .groups = 'keep') %>% 
  ungroup() %>% 
  mutate(uptake = case_when(Population == 0 ~ 0,
                          Population > 0 ~ (Newly.Tested.Positive + Newly.Tested.Negative)/Population)) %>%
  group_by(Year, Gender) %>% 
  dplyr::summarize(Newly.Tested.Positive = mean(Newly.Tested.Positive),
                   Newly.Tested.Negative = mean(Newly.Tested.Negative),
                   Population = mean(Population),
                   uptake = mean(uptake),
                   .groups = 'keep')

merge(
  test.uptake.pos,
  test.uptake.neg,
  by = c("Year", "Gender"),
  suffixes = c(".pos",".neg")
) %>% 
  arrange(Year, Gender) %>% 
  View
```

## PLHIV on ART
```{r Baseline Art Coverage among PLHIV }

base.artcov.cmd.pos <- sim.results.base %>% 
  filter(Age >= 15) %>% 
  filter(IP_Key.CMDStatus == 'CMD_pos') %>%
  group_by(Year, Gender, sim.id) %>% 
  dplyr::summarize(On_ART = sum(On_ART), 
                   Infected = sum(Infected), .groups = 'keep') %>% 
  ungroup() %>% 
  mutate(ARTcov = case_when(Infected == 0 ~ 0,
                          Infected > 0 ~ On_ART / Infected)) %>% 
  group_by(Year, Gender) %>% 
  dplyr::summarize(ARTcov.cmd.pos = mean(ARTcov), .groups = 'keep')

base.artcov.cmd.neg <- sim.results.base %>% 
  filter(Age >= 15) %>% 
  filter(IP_Key.CMDStatus != 'CMD_pos') %>%
  group_by(Year, Gender, sim.id) %>% 
  dplyr::summarize(On_ART = sum(On_ART), 
                   Infected = sum(Infected), .groups = 'keep') %>% 
  ungroup() %>% 
  mutate(ARTcov = case_when(Infected == 0 ~ 0,
                          Infected > 0 ~ On_ART / Infected)) %>% 
  group_by(Year, Gender) %>% 
  dplyr::summarize(ARTcov.cmd.neg = mean(ARTcov), .groups = 'keep')
```

```{r New Art Coverage among Diagnosed PLHIV}
new.artcov.cmd.pos <- sim.results.new %>% 
  filter(Age >= 15) %>% 
  filter(IP_Key.CMDStatus == 'CMD_pos') %>%
  group_by(Year, Gender, sim.id) %>% 
  dplyr::summarize(On_ART = sum(On_ART), 
                   Infected = sum(Infected), .groups = 'keep') %>% 
  ungroup() %>% 
  mutate(ARTcov = case_when(Infected == 0 ~ 0,
                          Infected > 0 ~ On_ART / Infected)) %>% 
  group_by(Year, Gender) %>% 
  dplyr::summarize(ARTcov.cmd.pos = mean(ARTcov), .groups = 'keep')

new.artcov.cmd.neg <- sim.results.new %>% 
  filter(Age >= 15) %>% 
  filter(IP_Key.CMDStatus != 'CMD_pos') %>%
  group_by(Year, Gender, sim.id) %>% 
  dplyr::summarize(On_ART = sum(On_ART), 
                   Infected = sum(Infected), .groups = 'keep') %>% 
  ungroup() %>% 
  mutate(ARTcov = case_when(Infected == 0 ~ 0,
                          Infected > 0 ~ On_ART / Infected)) %>% 
  group_by(Year, Gender) %>% 
  dplyr::summarize(ARTcov.cmd.neg = mean(ARTcov), .groups = 'keep')
 
```

```{r}
merge(
  merge(
  base.artcov.cmd.pos, base.artcov.cmd.neg, by = c("Year", "Gender")
),

merge(
  new.artcov.cmd.pos, new.artcov.cmd.neg, by = c("Year", "Gender")
),
by = c("Year", "Gender"),
suffixes = c(".base",".new")
) %>% tail(25)
```
## Diagnosed PLHIV on ART

```{r Baseline Art Coverage among Diagnosed PLHIV }

base.artcov.cmd.pos <- sim.results.base %>% 
  filter(Age >= 15) %>% 
  filter(IP_Key.CMDStatus == 'CMD_pos') %>%
  group_by(Year, Gender, sim.id) %>% 
  dplyr::summarize(On_ART = sum(On_ART), 
                   Diagnosed = sum(Diagnosed), .groups = 'keep') %>% 
  ungroup() %>% 
  mutate(ARTcov = case_when(Diagnosed == 0 ~ 0,
                          Diagnosed > 0 ~ On_ART / Diagnosed)) %>% 
  group_by(Year, Gender) %>% 
  dplyr::summarize(ARTcov.cmd.pos = mean(ARTcov), .groups = 'keep')

base.artcov.cmd.neg <- sim.results.base %>% 
  filter(Age >= 15) %>% 
  filter(IP_Key.CMDStatus != 'CMD_pos') %>%
  group_by(Year, Gender, sim.id) %>% 
  dplyr::summarize(On_ART = sum(On_ART), 
                   Diagnosed = sum(Diagnosed), .groups = 'keep') %>% 
  ungroup() %>% 
  mutate(ARTcov = case_when(Diagnosed == 0 ~ 0,
                          Diagnosed > 0 ~ On_ART / Diagnosed)) %>% 
  group_by(Year, Gender) %>% 
  dplyr::summarize(ARTcov.cmd.neg = mean(ARTcov), .groups = 'keep')
```

```{r New Art Coverage among Diagnosed PLHIV}
new.artcov.cmd.pos <- sim.results.new %>% 
  filter(Age >= 15) %>% 
  filter(IP_Key.CMDStatus == 'CMD_pos') %>%
  group_by(Year, Gender, sim.id) %>% 
  dplyr::summarize(On_ART = sum(On_ART), 
                   Diagnosed = sum(Diagnosed), .groups = 'keep') %>% 
  ungroup() %>% 
  mutate(ARTcov = case_when(Diagnosed == 0 ~ 0,
                          Diagnosed > 0 ~ On_ART / Diagnosed)) %>% 
  group_by(Year, Gender) %>% 
  dplyr::summarize(ARTcov.cmd.pos = mean(ARTcov), .groups = 'keep')

new.artcov.cmd.neg <- sim.results.new %>% 
  filter(Age >= 15) %>% 
  filter(IP_Key.CMDStatus != 'CMD_pos') %>%
  group_by(Year, Gender, sim.id) %>% 
  dplyr::summarize(On_ART = sum(On_ART), 
                   Diagnosed = sum(Diagnosed), .groups = 'keep') %>% 
  ungroup() %>% 
  mutate(ARTcov = case_when(Diagnosed == 0 ~ 0,
                          Diagnosed > 0 ~ On_ART / Diagnosed)) %>% 
  group_by(Year, Gender) %>% 
  dplyr::summarize(ARTcov.cmd.neg = mean(ARTcov), .groups = 'keep')
 
```

```{r}
merge(
  merge(
  base.artcov.cmd.pos, base.artcov.cmd.neg, by = c("Year", "Gender")
),

merge(
  new.artcov.cmd.pos, new.artcov.cmd.neg, by = c("Year", "Gender")
),
by = c("Year", "Gender"),
suffixes = c(".base",".new")
) %>% tail(25)
```

# SIS Model - 2023-06-21

```{r}

res.path.sis = "/gpfs/data/bershteynlab/EMOD/citrod01/MATUMAINI/202301_Nyanza_Baseline_MalariaOngoing/test_sis/Baseline-campaign_MATUMAINI_202305-sis/ReportHIVByAgeAndGender"

sim.results.sis <- EMODAnalyzeR::read.simulation.results(
  results_path  = res.path.sis,
  scenario_name = 'sis',
  summarize_columns = c("Population","Infected", "On_ART",
                        "Died", "Died_from_HIV",
                        "Newly.Infected","Diagnosed"),
  stratify_columns = c("Year", "Gender", "Age", "IP_Key.CMDStatus"),
  min_age_inclusive = 0,
  max_age_inclusive = 99
)

CENSUS_YEAR = 2009
KEN_CENSUS_POP = 5352385

sim.results.pop.scaling <- sim.results.sis %>% 
      filter(Year == CENSUS_YEAR) %>%
      group_by(sim.id) %>%
      summarize(total.pop = sum(Population), .groups = 'keep') %>% 
      mutate(pop.scaling.factor = KEN_CENSUS_POP/total.pop)

sim.results.sis <- sim.results.sis %>% 
  inner_join(
    sim.results.pop.scaling,
    by = c("sim.id")
  )

```

## Prevalence over time

```{r}
data <- sim.results.sis %>% filter(Age <= 50, Age >= 15, Year > 1990, Year <=2040) %>% 
  dplyr::group_by(Year, Gender, sim.id, scenario_name) %>%
  dplyr::summarize(Infected = sum(Infected), Population = sum(Population), .groups = 'keep') %>%
  ungroup( ) %>% 
  dplyr::mutate(Prevalence = case_when(Population == 0 ~ 0,
                                       Population > 0 ~ Infected / Population))%>% 
  mutate(Gender = case_when(Gender==0 ~ "Male", Gender==1 ~ "Female"))


data.mean <- data %>% group_by(Year, Gender) %>% summarize(std = sd(Prevalence), Prevalence = mean(Prevalence))%>% 
  mutate(lb = Prevalence + std, ub = Prevalence + std)

p = ggplot() +
  geom_line(data = data.mean, 
               size=2.0, aes(x=Year, y=Prevalence), color = 'darkred') +
  geom_line(data = data, 
            mapping = aes(x = Year, y = Prevalence, group = sim.id), color = 'darkred', 
            alpha = .01) + 
  #geom_errorbar(data= data.mean, mapping = aes(x = Year, ymin = lb, ymax = ub), color="black", width=2, size=1) + 
    facet_wrap(~ Gender, ncol=2) +
    xlab("Year")+ylab("") + 
    theme_bw(base_size=16) +
    guides(fill = guide_legend(keywidth = 2, keyheight = 1)) +
    scale_x_continuous(breaks = seq(1990,2040,10)) +
    theme(legend.position="bottom") +
    theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
    theme(strip.background = element_rect(colour="black", fill="white")) +
    theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())

p

```

## CMD prevalence over time

```{r}
# Aggregate CMD prevalence, to plot using EMODAnalyzer
cmd.data <- sim.results.sis %>% filter(Age >15) %>% 
  pivot_wider(id_cols = c(Year, Age, Gender, sim.id, scenario_name),
              names_from = c(IP_Key.CMDStatus),
              values_from = c(Population)) %>% 
  group_by(Year, Gender, sim.id, scenario_name) %>% 
  summarize(CMD_pos = sum(CMD_pos), 
            Population = sum(CMD_pos + CMD_neg + CMD_recovered + CMD_treated), 
            .groups = 'keep') %>% 
  ungroup() %>% 
  mutate(CMD_prev = case_when(Population == 0 ~ 0,
                              Population > 0 ~ CMD_pos / Population))%>% 
  mutate(Gender = case_when(Gender==0 ~ "Male", Gender==1 ~ "Female"))

cmd.data.mean <- cmd.data %>% 
  group_by(Year, Gender) %>% 
  summarize(CMD_prev = mean(CMD_prev))
  
p = ggplot() +
  geom_line(data = cmd.data.mean, 
               size=2.0, aes(x=Year, y=CMD_prev), color = 'darkgreen') +
  geom_line(data = cmd.data, 
            mapping = aes(x = Year, y = CMD_prev, group = sim.id), color = 'darkgreen', 
            alpha = .01) + 
  #geom_errorbar(data= data.mean, mapping = aes(x = Year, ymin = lb, ymax = ub), color="black", width=2, size=1) + 
    facet_wrap(~ Gender, ncol=2) +
    xlab("Year")+ylab("") + 
    theme_bw(base_size=16) +
    guides(fill = guide_legend(keywidth = 2, keyheight = 1)) +
    scale_x_continuous(breaks = seq(1990,2040,10)) +
    theme(legend.position="bottom") +
    theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
    theme(strip.background = element_rect(colour="black", fill="white")) +
    theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())

p
```


## CMD prevalence by age

```{r}
cmd.data.age <- sim.results.sis %>% 
  pivot_wider(id_cols = c(Year, Age, Gender, sim.id, scenario_name),
              names_from = c(IP_Key.CMDStatus),
              values_from = c(Population)) %>% 
  group_by(Year, Age, Gender, sim.id, scenario_name) %>% 
  summarize(CMD_pos = sum(CMD_pos), 
            Population = sum(CMD_pos + CMD_neg + CMD_recovered + CMD_treated), 
            .groups = 'keep') %>% 
  ungroup() %>% 
  mutate(CMD_prev = case_when(Population == 0 ~ 0,
                              Population > 0 ~ CMD_pos / Population)) %>% 
  mutate(Gender = case_when(Gender==0 ~ "Male", Gender==1 ~ "Female"))

age_bins = c(18, 25, 30, 40, 45, 50, 60, 99)
age_labels = c()
for (i in 1:(length(age_bins) - 1)){
  age_labels <- append(age_labels, paste0("[",age_bins[i],":",age_bins[i + 1],")"))
}

# Label each age by its bin
cmd.data.age <- cmd.data.age %>% mutate(
  AgeBin = cut(Age, breaks = age_bins, right = FALSE)
  ) %>%
  filter(!is.na(AgeBin))
cmd.data.age$AgeBin_index = factor(cmd.data.age$AgeBin,labels = 1:length(age_labels))

subset_years = c(2004)

cmd.data.age.mean <- cmd.data.age %>% group_by(Year, AgeBin_index, AgeBin, Gender, scenario_name) %>% 
  summarize(mean.CMD_prev = mean(CMD_prev),
              sd.CMD_prev = sd(CMD_prev),
              .groups = 'keep') %>% 
  mutate(lower = max(mean.CMD_prev - 2* sd.CMD_prev, 0), 
           upper = mean.CMD_prev + 2*sd.CMD_prev)

p <- cmd.data.age.mean %>% filter(Year == 2004) %>% 
    ggplot() + 
    # plot means
    geom_point(
      mapping = aes(x = AgeBin_index, y = mean.CMD_prev),
      size=2, color = 'darkgreen'
    ) + 
    geom_errorbar(
      mapping = aes(x=AgeBin_index, ymin=lower, ymax=upper),
      width=.3, size=2, color = 'darkgreen') + 
    facet_grid(cols = vars(Gender), rows = vars(Year)) + 
    xlab("Age") + ylab("") + 
    theme_bw(base_size=16) +
    guides(fill = guide_legend(keywidth = 2, keyheight = 1)) +
    scale_x_discrete(
      breaks = 1:length(age_labels),
      labels = age_labels
      ) +
    theme(legend.position="bottom") +
    theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
    theme(strip.background = element_rect(colour="black", fill="white")) +
    theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())

p
```


## Examine the Event Recorder

```{r}
event.rec.path = "/gpfs/scratch/citrod01/experiments/MATUMAINI/Baseline-campaign_MATUMAINI_202305-sis___2023_06_20_17_12_49_667455/Simulation_0AM8J9GA/output/ReportEventRecorder.csv"

event.rec = read_csv(event.rec.path)

# event.rec %>% arrange(Individual_ID, Time) %>% View

merge(
  event.rec %>% filter(Event_Name != "HCTTestingLoopRapidTest"),
  event.rec %>% filter(Event_Name != "HCTTestingLoopRapidTest") %>% 
    group_by(Individual_ID) %>% summarize(n = n()) %>% filter(n >= 4),
  by = "Individual_ID"
) %>% 
  arrange(Individual_ID, Time) %>% View
```


