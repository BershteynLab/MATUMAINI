---
title: "croi_manuscript_analysis"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

The purpose of this notebook will be to perform the analysis post-CROI, in preparation for completing the manuscript of the CROI results


```{r Load Libraries}
library(tidyverse)
library(data.table)
library(magrittr)
library(ggplot2)
library(devtools)
library(readxl)
devtools::install_github("BershteynLab/EMODAnalyzeR", force = TRUE)
```


```{r}
# Confidence interval functions
lower_ci <- function(mean, se, n, conf_level = 0.95){
  lower_ci <- mean - qt(1 - ((1 - conf_level) / 2), n - 1) * se
  return(lower_ci)
}
upper_ci <- function(mean, se, n, conf_level = 0.95){
  upper_ci <- mean + qt(1 - ((1 - conf_level) / 2), n - 1) * se
  return(upper_ci)
}
```

# Context 

The "baseline scenario" set of HIV-CMD interactions
1. Depression dynamics
  1. Age/sex-specific annual incidence of depression
  2. HIV+ status also increases depression incidence
  3. Relapse rate equal to incidence rate
2. Depression-caused increase to incidence - CoitalActRiskFactor increases from 1 to 1.646
3. Depression-caused delays to diagnosis (2/3 of depressed skip diagnosis)
4. Depression-caused dropout from ART (mean time 5 years for depressed, 10 years for non-depressed)
5. Depression-caused non-adherence to ART


## 2024-03-18
At the moment we are stuck on trying to figure out how to show that depression reducing art adherence has been bad.

# Read in data

## Baseline, ART

```{r}
experiment_path = "/gpfs/scratch/citrod01/experiments/MATUMAINI/Baseline-campaign_MATUMAINI_202305-baseline_art___2024_04_11_14_41_55_316412/"

sim.results.baseline.art <- EMODAnalyzeR::read.simulation.results.bigpurple(
  experiment_path = experiment_path,
  scenario_name = 'baseline.art',
  summarize_columns = c("Population","Infected", "On_ART",
                        "Died", "Died_from_HIV",
                        "Newly.Infected","Diagnosed"),
  #stratify_columns = c("Year", "Gender", "Age", "IP_Key.CMDStatus"),
  stratify_columns = c("Year", "Gender","IP_Key.CMDStatus"),
  min_age_inclusive = 0,
  max_age_inclusive = 99
)

CENSUS_YEAR = 2009
KEN_CENSUS_POP = 5352385

sim.results.pop.scaling <- sim.results.baseline.art %>% 
      filter(Year == CENSUS_YEAR) %>%
      group_by(sim.id) %>%
      summarize(total.pop = sum(Population), .groups = 'keep') %>% 
      mutate(pop.scaling.factor = KEN_CENSUS_POP/total.pop)

sim.results.baseline.art <- sim.results.baseline.art %>% 
  inner_join(
    sim.results.pop.scaling,
    by = c("sim.id")
  )

```


```{r}
# up through 2000
# experiment_path = "/gpfs/scratch/citrod01/experiments/MATUMAINI/Baseline-campaign_MATUMAINI_202305-baseline_art_cmdinc___2024_04_23_10_23_41_913674"
# up through 2000, changed the cmd start date to 1990
#experiment_path = "/gpfs/scratch/citrod01/experiments/MATUMAINI/Baseline-campaign_MATUMAINI_202305_test-baseline_noart_cmdinc_test___2024_04_23_15_13_17_007588"

# up through 2020, with depression starting in 1990
experiment_path  = "/gpfs/scratch/citrod01/experiments/MATUMAINI/Baseline-campaign_MATUMAINI_202305_test-baseline_art_cmdinc_test___2024_04_23_16_38_15_171047"
sim.results.baseline.art.cmdinc.test <- EMODAnalyzeR::read.simulation.results.bigpurple(
  experiment_path = experiment_path,
  scenario_name = 'baseline.art.cmdinc.test',
  summarize_columns = c("Population","Infected", "On_ART",
                        "Died", "Died_from_HIV",
                        "Newly.Infected","Diagnosed"),
  #stratify_columns = c("Year", "Gender", "Age", "IP_Key.CMDStatus"),
  stratify_columns = c("Year", "Gender","IP_Key.CMDStatus"),
  min_age_inclusive = 0,
  max_age_inclusive = 99
)


```

## Baseline, no ART

```{r}
experiment_path = "/gpfs/scratch/citrod01/experiments/MATUMAINI/Baseline-campaign_MATUMAINI_202305-baseline_noart___2024_04_11_14_44_43_504278/"

sim.results.baseline.noart <- EMODAnalyzeR::read.simulation.results.bigpurple(
  experiment_path = experiment_path,
  scenario_name = 'baseline.noart',
  summarize_columns = c("Population","Infected", "On_ART",
                        "Died", "Died_from_HIV",
                        "Newly.Infected","Diagnosed"),
  #stratify_columns = c("Year", "Gender", "Age", "IP_Key.CMDStatus"),
  stratify_columns = c("Year", "Gender","IP_Key.CMDStatus"),
  min_age_inclusive = 0,
  max_age_inclusive = 99
)

CENSUS_YEAR = 2009
KEN_CENSUS_POP = 5352385

sim.results.pop.scaling <- sim.results.baseline.noart %>% 
      filter(Year == CENSUS_YEAR) %>%
      group_by(sim.id) %>%
      summarize(total.pop = sum(Population), .groups = 'keep') %>% 
      mutate(pop.scaling.factor = KEN_CENSUS_POP/total.pop)

sim.results.baseline.noart <- sim.results.baseline.noart %>% 
  inner_join(
    sim.results.pop.scaling,
    by = c("sim.id")
  )

```


## Decouple, ART
```{r}
# results used for CROI
# results_path = "/gpfs/data/bershteynlab/EMOD/citrod01/MATUMAINI/202301_Nyanza_MATUMAINI_MalariaOngoing/croi/Baseline-campaign_MATUMAINI_202305_decouple-decouple_adh_ART/ReportHIVByAgeAndGender/",

sim.results.decouple.art <- EMODAnalyzeR::read.simulation.results.bigpurple(
  # results from post-croi
  experiment_path = "/gpfs/scratch/citrod01/experiments/MATUMAINI/Baseline-campaign_MATUMAINI_202305_decouple-decouple_art___2024_04_17_18_51_35_650911",
  scenario_name = 'decouple.art',
  summarize_columns = c("Population","Infected", "On_ART",
                        "Died", "Died_from_HIV",
                        "Newly.Infected","Diagnosed"),
  #stratify_columns = c("Year", "Gender", "Age", "IP_Key.CMDStatus"),
  stratify_columns = c("Year", "Gender","IP_Key.CMDStatus"),
  min_age_inclusive = 0,
  max_age_inclusive = 99
)

CENSUS_YEAR = 2009
KEN_CENSUS_POP = 5352385

sim.results.pop.scaling <- sim.results.decouple.art %>% 
      filter(Year == CENSUS_YEAR) %>%
      group_by(sim.id) %>%
      summarize(total.pop = sum(Population), .groups = 'keep') %>% 
      mutate(pop.scaling.factor = KEN_CENSUS_POP/total.pop)

sim.results.decouple.art <- sim.results.decouple.art %>% 
  inner_join(
    sim.results.pop.scaling,
    by = c("sim.id")
  )
```

```{r}
# up through year 1990
#   #experiment_path = "/gpfs/scratch/citrod01/experiments/MATUMAINI/Baseline-campaign_MATUMAINI_202305_decouple-decouple_art___2024_04_23_10_21_49_057655",
# up through year 2000, after copy-pasting the baseline campaign file over
experiment_path = "/gpfs/scratch/citrod01/experiments/MATUMAINI/Baseline-campaign_MATUMAINI_202305_decouple_test-decouple_art___2024_04_23_12_52_05_739472"
# Starting depression in 1990
# experiment_path = "/gpfs/scratch/citrod01/experiments/MATUMAINI/Baseline-campaign_MATUMAINI_202305_decouple_test-decouple_art_test___2024_04_23_15_15_30_050866",

sim.results.decouple.art.test <- EMODAnalyzeR::read.simulation.results.bigpurple(
  experiment_path = experiment_path,
  scenario_name = 'decouple.art.test',
  summarize_columns = c("Population","Infected", "On_ART",
                        "Died", "Died_from_HIV",
                        "Newly.Infected","Diagnosed"),
  #stratify_columns = c("Year", "Gender", "Age", "IP_Key.CMDStatus"),
  stratify_columns = c("Year", "Gender","IP_Key.CMDStatus"),
  min_age_inclusive = 0,
  max_age_inclusive = 99
)

```


## Decouple, no ART
```{r}
# "/gpfs/scratch/citrod01/experiments/MATUMAINI/Baseline-campaign_MATUMAINI_202305_decouple-decouple_noart___2024_03_15_13_34_32_937184"
# results used for CROI
# 
sim.results.decouple.noart <- EMODAnalyzeR::read.simulation.results.bigpurple(
  experiment_path = "/gpfs/scratch/citrod01/experiments/MATUMAINI/Baseline-campaign_MATUMAINI_202305_decouple-decouple_noart___2024_04_17_18_53_39_748417",
  scenario_name = 'decouple.noart',
  summarize_columns = c("Population","Infected", "On_ART",
                        "Died", "Died_from_HIV",
                        "Newly.Infected","Diagnosed"),
  #stratify_columns = c("Year", "Gender", "Age", "IP_Key.CMDStatus"),
  stratify_columns = c("Year", "Gender","IP_Key.CMDStatus"),
  min_age_inclusive = 0,
  max_age_inclusive = 99
)

CENSUS_YEAR = 2009
KEN_CENSUS_POP = 5352385

sim.results.pop.scaling <- sim.results.decouple.noart %>% 
      filter(Year == CENSUS_YEAR) %>%
      group_by(sim.id) %>%
      summarize(total.pop = sum(Population), .groups = 'keep') %>% 
      mutate(pop.scaling.factor = KEN_CENSUS_POP/total.pop)

sim.results.decouple.noart <- sim.results.decouple.noart %>% 
  inner_join(
    sim.results.pop.scaling,
    by = c("sim.id")
  )


```

## Elevated CMD Incidence, ART

```{r}
experiment_path = "/gpfs/scratch/citrod01/experiments/MATUMAINI/Baseline-campaign_MATUMAINI_202305-baseline_art_cmdinc___2024_04_11_14_47_19_957569/"

sim.results.baseline.art.cmdinc <- EMODAnalyzeR::read.simulation.results.bigpurple(
  experiment_path = experiment_path,
  scenario_name = 'baseline.art.cmdinc',
  summarize_columns = c("Population","Infected", "On_ART",
                        "Died", "Died_from_HIV",
                        "Newly.Infected","Diagnosed"),
  #stratify_columns = c("Year", "Gender", "Age", "IP_Key.CMDStatus"),
  stratify_columns = c("Year", "Gender","IP_Key.CMDStatus"),
  min_age_inclusive = 0,
  max_age_inclusive = 99
)

CENSUS_YEAR = 2009
KEN_CENSUS_POP = 5352385

sim.results.pop.scaling <- sim.results.baseline.art.cmdinc %>% 
      filter(Year == CENSUS_YEAR) %>%
      group_by(sim.id) %>%
      summarize(total.pop = sum(Population), .groups = 'keep') %>% 
      mutate(pop.scaling.factor = KEN_CENSUS_POP/total.pop)

sim.results.baseline.art.cmdinc <- sim.results.baseline.art.cmdinc %>% 
  inner_join(
    sim.results.pop.scaling,
    by = c("sim.id")
  )
```


## Elevated CMD Incidence, No ART
```{r, eval=FALSE}
experiment_path = "/gpfs/scratch/citrod01/experiments/MATUMAINI/Baseline-campaign_MATUMAINI_202305-baseline_noart_cmdinc___2024_04_11_14_49_48_244240/"

sim.results.baseline.noart.cmdinc <- EMODAnalyzeR::read.simulation.results.bigpurple(
  experiment_path = experiment_path,
  scenario_name = 'baseline.noart.cmdinc',
  summarize_columns = c("Population","Infected", "On_ART",
                        "Died", "Died_from_HIV",
                        "Newly.Infected","Diagnosed"),
  #stratify_columns = c("Year", "Gender", "Age", "IP_Key.CMDStatus"),
  stratify_columns = c("Year", "Gender","IP_Key.CMDStatus"),
  min_age_inclusive = 0,
  max_age_inclusive = 99
)

CENSUS_YEAR = 2009
KEN_CENSUS_POP = 5352385

sim.results.pop.scaling <- sim.results.baseline.noart.cmdinc %>% 
      filter(Year == CENSUS_YEAR) %>%
      group_by(sim.id) %>%
      summarize(total.pop = sum(Population), .groups = 'keep') %>% 
      mutate(pop.scaling.factor = KEN_CENSUS_POP/total.pop)

sim.results.baseline.noart.cmdinc <- sim.results.baseline.noart.cmdinc %>% 
  inner_join(
    sim.results.pop.scaling,
    by = c("sim.id")
  )
```


## Decouple, ART, Increased HIV incidence

```{r}
experiment_path = "/gpfs/scratch/citrod01/experiments/MATUMAINI/Baseline-campaign_MATUMAINI_202305_decouple-decouple_art_hivinc___2024_04_11_14_52_01_213969/"

sim.results.decouple.art.hivinc <- EMODAnalyzeR::read.simulation.results.bigpurple(
  experiment_path = experiment_path,
  scenario_name = 'decouple.art.hivinc',
  summarize_columns = c("Population","Infected", "On_ART",
                        "Died", "Died_from_HIV",
                        "Newly.Infected","Diagnosed"),
  #stratify_columns = c("Year", "Gender", "Age", "IP_Key.CMDStatus"),
  stratify_columns = c("Year", "Gender","IP_Key.CMDStatus"),
  min_age_inclusive = 0,
  max_age_inclusive = 99
)

CENSUS_YEAR = 2009
KEN_CENSUS_POP = 5352385

sim.results.pop.scaling <- sim.results.decouple.art.hivinc %>% 
      filter(Year == CENSUS_YEAR) %>%
      group_by(sim.id) %>%
      summarize(total.pop = sum(Population), .groups = 'keep') %>% 
      mutate(pop.scaling.factor = KEN_CENSUS_POP/total.pop)

sim.results.decouple.art.hivinc <- sim.results.decouple.art.hivinc %>% 
  inner_join(
    sim.results.pop.scaling,
    by = c("sim.id")
  )
```


## Decouple, no ART, Increased HIV incidence

```{r}
experiment_path = "/gpfs/scratch/citrod01/experiments/MATUMAINI/Baseline-campaign_MATUMAINI_202305_decouple-decouple_noart_hivinc___2024_04_11_14_53_59_875226/"

sim.results.decouple.noart.hivinc <- EMODAnalyzeR::read.simulation.results.bigpurple(
  experiment_path = experiment_path,
  scenario_name = 'decouple.noart.hivinc',
  summarize_columns = c("Population","Infected", "On_ART",
                        "Died", "Died_from_HIV",
                        "Newly.Infected","Diagnosed"),
  #stratify_columns = c("Year", "Gender", "Age", "IP_Key.CMDStatus"),
  stratify_columns = c("Year", "Gender","IP_Key.CMDStatus"),
  min_age_inclusive = 0,
  max_age_inclusive = 99
)

CENSUS_YEAR = 2009
KEN_CENSUS_POP = 5352385

sim.results.pop.scaling <- sim.results.decouple.noart.hivinc %>% 
      filter(Year == CENSUS_YEAR) %>%
      group_by(sim.id) %>%
      summarize(total.pop = sum(Population), .groups = 'keep') %>% 
      mutate(pop.scaling.factor = KEN_CENSUS_POP/total.pop)

sim.results.decouple.noart.hivinc <- sim.results.decouple.noart.hivinc %>% 
  inner_join(
    sim.results.pop.scaling,
    by = c("sim.id")
  )
```

## Decouple, ART, Delay to testing
```{r}
experiment_path = "/gpfs/scratch/citrod01/experiments/MATUMAINI/Baseline-campaign_MATUMAINI_202305_decouple-decouple_art_delay___2024_04_11_14_55_42_362645/"

sim.results.decouple.art.delay <- EMODAnalyzeR::read.simulation.results.bigpurple(
  experiment_path = experiment_path,
  scenario_name = 'decouple.art.delay',
  summarize_columns = c("Population","Infected", "On_ART",
                        "Died", "Died_from_HIV",
                        "Newly.Infected","Diagnosed"),
  #stratify_columns = c("Year", "Gender", "Age", "IP_Key.CMDStatus"),
  stratify_columns = c("Year", "Gender","IP_Key.CMDStatus"),
  min_age_inclusive = 0,
  max_age_inclusive = 99
)

CENSUS_YEAR = 2009
KEN_CENSUS_POP = 5352385

sim.results.pop.scaling <- sim.results.decouple.art.delay %>% 
      filter(Year == CENSUS_YEAR) %>%
      group_by(sim.id) %>%
      summarize(total.pop = sum(Population), .groups = 'keep') %>% 
      mutate(pop.scaling.factor = KEN_CENSUS_POP/total.pop)

sim.results.decouple.art.delay <- sim.results.decouple.art.delay %>% 
  inner_join(
    sim.results.pop.scaling,
    by = c("sim.id")
  )
```

## Decouple, ART, Maximum Delay to testing
```{r}
experiment_path = "/gpfs/scratch/citrod01/experiments/MATUMAINI/Baseline-campaign_MATUMAINI_202305_decouple-decouple_art_delay_xtreem___2024_04_11_14_57_40_598727/"

sim.results.decouple.art.delay.xtreem <- EMODAnalyzeR::read.simulation.results.bigpurple(
  experiment_path = experiment_path,
  scenario_name = 'decouple.art.delay.xtreem',
  summarize_columns = c("Population","Infected", "On_ART",
                        "Died", "Died_from_HIV",
                        "Newly.Infected","Diagnosed"),
  #stratify_columns = c("Year", "Gender", "Age", "IP_Key.CMDStatus"),
  stratify_columns = c("Year", "Gender","IP_Key.CMDStatus"),
  min_age_inclusive = 0,
  max_age_inclusive = 99
)

CENSUS_YEAR = 2009
KEN_CENSUS_POP = 5352385

sim.results.pop.scaling <- sim.results.decouple.art.delay.xtreem %>% 
      filter(Year == CENSUS_YEAR) %>%
      group_by(sim.id) %>%
      summarize(total.pop = sum(Population), .groups = 'keep') %>% 
      mutate(pop.scaling.factor = KEN_CENSUS_POP/total.pop)

sim.results.decouple.art.delay.xtreem <- sim.results.decouple.art.delay.xtreem %>% 
  inner_join(
    sim.results.pop.scaling,
    by = c("sim.id")
  )
```

## Decouple, no ART, Delay to testing

```{r}
experiment_path = "/gpfs/scratch/citrod01/experiments/MATUMAINI/Baseline-campaign_MATUMAINI_202305_decouple-decouple_noart_delay___2024_04_11_14_59_23_332282/"

sim.results.decouple.noart.delay <- EMODAnalyzeR::read.simulation.results.bigpurple(
  experiment_path = experiment_path,
  scenario_name = 'decouple.noart.delay',
  summarize_columns = c("Population","Infected", "On_ART",
                        "Died", "Died_from_HIV",
                        "Newly.Infected","Diagnosed"),
  #stratify_columns = c("Year", "Gender", "Age", "IP_Key.CMDStatus"),
  stratify_columns = c("Year", "Gender","IP_Key.CMDStatus"),  min_age_inclusive = 0,
  max_age_inclusive = 99
)

CENSUS_YEAR = 2009
KEN_CENSUS_POP = 5352385

sim.results.pop.scaling <- sim.results.decouple.noart.delay %>% 
      filter(Year == CENSUS_YEAR) %>%
      group_by(sim.id) %>%
      summarize(total.pop = sum(Population), .groups = 'keep') %>% 
      mutate(pop.scaling.factor = KEN_CENSUS_POP/total.pop)

sim.results.decouple.noart.delay <- sim.results.decouple.noart.delay %>% 
  inner_join(
    sim.results.pop.scaling,
    by = c("sim.id")
  )
```


## Decouple, ART, ART Dropout

```{r}
experiment_path = "/gpfs/scratch/citrod01/experiments/MATUMAINI/Baseline-campaign_MATUMAINI_202305_decouple-decouple_art_artdrop___2024_04_11_15_01_19_935604/"

sim.results.decouple.art.artdrop <- EMODAnalyzeR::read.simulation.results.bigpurple(
  experiment_path = experiment_path,
  scenario_name = 'decouple.art.artdrop',
  summarize_columns = c("Population","Infected", "On_ART",
                        "Died", "Died_from_HIV",
                        "Newly.Infected","Diagnosed"),
  #stratify_columns = c("Year", "Gender", "Age", "IP_Key.CMDStatus"),
  stratify_columns = c("Year", "Gender","IP_Key.CMDStatus"),
  min_age_inclusive = 0,
  max_age_inclusive = 99
)

CENSUS_YEAR = 2009
KEN_CENSUS_POP = 5352385

sim.results.pop.scaling <- sim.results.decouple.art.artdrop %>% 
      filter(Year == CENSUS_YEAR) %>%
      group_by(sim.id) %>%
      summarize(total.pop = sum(Population), .groups = 'keep') %>% 
      mutate(pop.scaling.factor = KEN_CENSUS_POP/total.pop)

sim.results.decouple.art.artdrop <- sim.results.decouple.art.artdrop %>% 
  inner_join(
    sim.results.pop.scaling,
    by = c("sim.id")
  )
```

## Decouple, ART, Maximum ART Dropout

```{r}
experiment_path = "/gpfs/scratch/citrod01/experiments/MATUMAINI/Baseline-campaign_MATUMAINI_202305_decouple-decouple_noart_delay___2024_04_11_14_59_23_332282/"

sim.results.decouple.art.artdrop.xtreem <- EMODAnalyzeR::read.simulation.results.bigpurple(
  experiment_path = experiment_path,
  scenario_name = 'decouple.art.artdrop.xtreem',
  summarize_columns = c("Population","Infected", "On_ART",
                        "Died", "Died_from_HIV",
                        "Newly.Infected","Diagnosed"),
  #stratify_columns = c("Year", "Gender", "Age", "IP_Key.CMDStatus"),
  stratify_columns = c("Year", "Gender","IP_Key.CMDStatus"),
  min_age_inclusive = 0,
  max_age_inclusive = 99
)

CENSUS_YEAR = 2009
KEN_CENSUS_POP = 5352385

sim.results.pop.scaling <- sim.results.decouple.art.artdrop.xtreem %>% 
      filter(Year == CENSUS_YEAR) %>%
      group_by(sim.id) %>%
      summarize(total.pop = sum(Population), .groups = 'keep') %>% 
      mutate(pop.scaling.factor = KEN_CENSUS_POP/total.pop)

sim.results.decouple.art.artdrop.xtreem <- sim.results.decouple.art.artdrop.xtreem %>% 
  inner_join(
    sim.results.pop.scaling,
    by = c("sim.id")
  )
```

## Decouple, ART, Reduced ART Adherence
```{r}
# "/gpfs/data/bershteynlab/EMOD/citrod01/MATUMAINI/202301_Nyanza_MATUMAINI_MalariaOngoing/croi/Baseline-campaign_MATUMAINI_202305_decouple-decouple_adh_ART/ReportHIVByAgeAndGender/"
# results used for croi

sim.results.decouple.art.adh <- EMODAnalyzeR::read.simulation.results.bigpurple(
  experiment_path = "/gpfs/scratch/citrod01/experiments/MATUMAINI/Baseline-campaign_MATUMAINI_202305_decouple-decouple_art_artadh___2024_03_19_17_45_09_291000",
  scenario_name = 'decouple.art.adh',
  summarize_columns = c("Population","Infected", "On_ART",
                        "Died", "Died_from_HIV",
                        "Newly.Infected","Diagnosed"),
  #stratify_columns = c("Year", "Gender", "Age", "IP_Key.CMDStatus"),
  stratify_columns = c("Year", "Gender","IP_Key.CMDStatus"),
  min_age_inclusive = 0,
  max_age_inclusive = 99
)

CENSUS_YEAR = 2009
KEN_CENSUS_POP = 5352385

sim.results.pop.scaling <- sim.results.decouple.art.adh %>% 
      filter(Year == CENSUS_YEAR) %>%
      group_by(sim.id) %>%
      summarize(total.pop = sum(Population), .groups = 'keep') %>% 
      mutate(pop.scaling.factor = KEN_CENSUS_POP/total.pop)

sim.results.decouple.art.adh <- sim.results.decouple.art.adh %>% 
  inner_join(
    sim.results.pop.scaling,
    by = c("sim.id")
  )
```

## Decouple, ART, extreme Reduced ART Adherence
```{r}
# /gpfs/data/bershteynlab/EMOD/citrod01/MATUMAINI/202301_Nyanza_MATUMAINI_MalariaOngoing/croi/Baseline-campaign_MATUMAINI_202305_decouple-decouple_adh_ART_xtreem/ReportHIVByAgeAndGender/
# croi results path

sim.results.decouple.art.adh.xtreem <- EMODAnalyzeR::read.simulation.results.bigpurple(
  experiment_path = "/gpfs/scratch/citrod01/experiments/MATUMAINI/Baseline-campaign_MATUMAINI_202305_decouple-decouple_art_artadh_xtreem___2024_03_19_17_47_00_519738",
  scenario_name = 'decouple.art.adh.xtreem',
  summarize_columns = c("Population","Infected", "On_ART",
                        "Died", "Died_from_HIV",
                        "Newly.Infected","Diagnosed"),
  #stratify_columns = c("Year", "Gender", "Age", "IP_Key.CMDStatus"),
  stratify_columns = c("Year", "Gender","IP_Key.CMDStatus"),
  min_age_inclusive = 0,
  max_age_inclusive = 99
)

CENSUS_YEAR = 2009
KEN_CENSUS_POP = 5352385

sim.results.pop.scaling <- sim.results.decouple.art.adh.xtreem %>% 
      filter(Year == CENSUS_YEAR) %>%
      group_by(sim.id) %>%
      summarize(total.pop = sum(Population), .groups = 'keep') %>% 
      mutate(pop.scaling.factor = KEN_CENSUS_POP/total.pop)

sim.results.decouple.art.adh.xtreem <- sim.results.decouple.art.adh.xtreem %>% 
  inner_join(
    sim.results.pop.scaling,
    by = c("sim.id")
  )
```

## Decouple, ART, Lower ART Adherence after depression recovery

```{r}
sim.results.decouple.art.adh.recov <- EMODAnalyzeR::read.simulation.results.bigpurple(
  experiment_path = "/gpfs/scratch/citrod01/experiments/MATUMAINI/Baseline-campaign_MATUMAINI_202305_decouple-decouple_art_artadh_recov___2024_04_17_18_55_25_967541",
  scenario_name = 'decouple.art.adh.recov',
  summarize_columns = c("Population","Infected", "On_ART",
                        "Died", "Died_from_HIV",
                        "Newly.Infected","Diagnosed"),
  #stratify_columns = c("Year", "Gender", "Age", "IP_Key.CMDStatus"),
  stratify_columns = c("Year", "Gender","IP_Key.CMDStatus"),  min_age_inclusive = 0,
  max_age_inclusive = 99
)

CENSUS_YEAR = 2009
KEN_CENSUS_POP = 5352385

sim.results.pop.scaling <- sim.results.decouple.art.adh.recov %>% 
      filter(Year == CENSUS_YEAR) %>%
      group_by(sim.id) %>%
      summarize(total.pop = sum(Population), .groups = 'keep') %>% 
      mutate(pop.scaling.factor = KEN_CENSUS_POP/total.pop)

sim.results.decouple.art.adh.recov <- sim.results.decouple.art.adh.recov %>% 
  inner_join(
    sim.results.pop.scaling,
    by = c("sim.id")
  )
```

## All effects except for increased HIV incidence

```{r}
experiment_path = "/gpfs/scratch/citrod01/experiments/MATUMAINI/Baseline-campaign_MATUMAINI_202305-baseline_art_not_hivinc___2024_04_18_19_29_24_657884"

sim.results.baseline.art.not.hivmc <- EMODAnalyzeR::read.simulation.results.bigpurple(
  experiment_path = experiment_path,
  scenario_name = 'baseline.art.not.hivmc',
  summarize_columns = c("Population","Infected", "On_ART",
                        "Died", "Died_from_HIV",
                        "Newly.Infected","Diagnosed"),
  #stratify_columns = c("Year", "Gender", "Age", "IP_Key.CMDStatus"),
  stratify_columns = c("Year", "Gender","IP_Key.CMDStatus"),
  min_age_inclusive = 0,
  max_age_inclusive = 99
)

CENSUS_YEAR = 2009
KEN_CENSUS_POP = 5352385

sim.results.pop.scaling <- sim.results.baseline.art.not.hivmc %>% 
      filter(Year == CENSUS_YEAR) %>%
      group_by(sim.id) %>%
      summarize(total.pop = sum(Population), .groups = 'keep') %>% 
      mutate(pop.scaling.factor = KEN_CENSUS_POP/total.pop)

sim.results.baseline.art.not.hivmc <- sim.results.baseline.art.not.hivmc %>% 
  inner_join(
    sim.results.pop.scaling,
    by = c("sim.id")
  )
```



## Minimum/Maximum effect of ART

```{r}
sim.results.decouple.art.max <- EMODAnalyzeR::read.simulation.results.bigpurple(
  experiment_path = "/gpfs/scratch/citrod01/experiments/MATUMAINI/Baseline-campaign_MATUMAINI_202305_decouple-decouple_art_max___2024_04_04_10_59_05_565894",
  scenario_name = 'decouple.art.max',
  summarize_columns = c("Population","Infected", "On_ART",
                        "Died", "Died_from_HIV",
                        "Newly.Infected","Diagnosed"),
  stratify_columns = c("Year", "Gender", "Age", "IP_Key.CMDStatus"),
  min_age_inclusive = 0,
  max_age_inclusive = 99
)

CENSUS_YEAR = 2009
KEN_CENSUS_POP = 5352385

sim.results.pop.scaling <- sim.results.decouple.art.max %>% 
      filter(Year == CENSUS_YEAR) %>%
      group_by(sim.id) %>%
      summarize(total.pop = sum(Population), .groups = 'keep') %>% 
      mutate(pop.scaling.factor = KEN_CENSUS_POP/total.pop)

sim.results.decouple.art.max <- sim.results.decouple.art.max %>% 
  inner_join(
    sim.results.pop.scaling,
    by = c("sim.id")
  )
```

```{r}
sim.results.decouple.art.min <- EMODAnalyzeR::read.simulation.results.bigpurple(
  experiment_path = "/gpfs/scratch/citrod01/experiments/MATUMAINI/Baseline-campaign_MATUMAINI_202305_decouple-decouple_art_min___2024_04_04_11_01_11_057115",
  scenario_name = 'decouple.art.min',
  summarize_columns = c("Population","Infected", "On_ART",
                        "Died", "Died_from_HIV",
                        "Newly.Infected","Diagnosed"),
  stratify_columns = c("Year", "Gender", "Age", "IP_Key.CMDStatus"),
  min_age_inclusive = 0,
  max_age_inclusive = 99
)

CENSUS_YEAR = 2009
KEN_CENSUS_POP = 5352385

sim.results.pop.scaling <- sim.results.decouple.art.min %>% 
      filter(Year == CENSUS_YEAR) %>%
      group_by(sim.id) %>%
      summarize(total.pop = sum(Population), .groups = 'keep') %>% 
      mutate(pop.scaling.factor = KEN_CENSUS_POP/total.pop)

sim.results.decouple.art.min <- sim.results.decouple.art.min %>% 
  inner_join(
    sim.results.pop.scaling,
    by = c("sim.id")
  )
```



## Join data together

```{r}
sim.results.all <- rbind(sim.results.baseline.art,
                        sim.results.baseline.art.cmdinc,
                        sim.results.decouple.art.hivinc,
                        sim.results.decouple.art.delay,
                        sim.results.decouple.art.artdrop,
                        sim.results.decouple.art.adh.recov,
                        sim.results.baseline.art.not.hivmc,
                        sim.results.decouple.art)

sim.results.all <- rbind(sim.results.baseline.art,
                         sim.results.baseline.noart,
                         sim.results.decouple.art,
                         sim.results.decouple.noart)
# ,
#                          sim.results.baseline.art.cmdinc,
#                          sim.results.baseline.noart.cmdinc,
#                          sim.results.decouple.art.delay,
#                          sim.results.decouple.art.delay.xtreem,
#                          sim.results.decouple.noart.delay,
#                          sim.results.decouple.art.artdrop,
#                          sim.results.decouple.art.artdrop.xtreem,
#                          sim.results.decouple.art.hivinc,
#                          sim.results.decouple.noart.hivinc,
#                          sim.results.decouple.art.adh,
#                          sim.results.decouple.art.adh.xtreem,
#                          sim.results.decouple.art.adh.recov
#                          )

# sim.results.all <- rbind(sim.results.decouple.art,
#                          sim.results.decouple.art.max,
#                          sim.results.decouple.art.min,
#                          sim.results.decouple.noart)
```

# Plot

## Population

```{r, fig.width = 8}
data.pop <- sim.results.all %>% 
  group_by(Year, Gender, sim.id, scenario_name) %>% 
  summarize(Population = sum(Population*pop.scaling.factor), .groups = "keep") %>% 
  # group_by(Year, Gender,scenario_name) %>% 
  # summarize(Population = mean(Population), .groups = "keep") %>% 
  ungroup()

p <- EMODAnalyzeR::emodplot.by_gender(data.pop, 1985, 2025, "Population", title = "Population over Time")

p +
  ylab("HIV Prevalence (%)") + 
  scale_color_manual(values=c("blue","red","darkgreen","orange","black")) + 
  theme(legend.position = "right")
```

## PLHIV over time

```{r}
plhiv.data <- sim.results.all %>% 
  filter(Age >= 15, Age < 50) %>% 
  group_by(Year, Gender, scenario_name, sim.id) %>% 
  summarize(PLHIV = sum(Infected*pop.scaling.factor), .groups = 'keep') %>% 
  ungroup() %>% 
  mutate(Gender = case_when(Gender==0 ~ "Male", Gender==1 ~ "Female"))
  
plhiv.data.mean <- plhiv.data %>% 
  group_by(Year, Gender, scenario_name) %>% 
  summarize(PLHIV = mean(PLHIV), .groups = "keep")

p <- ggplot() +
      geom_line(data= plhiv.data.mean %>% filter(Year > 1985),
              aes(x=Year, y=PLHIV, group=scenario_name, color=scenario_name), linewidth=.5) +
    facet_wrap(~ Gender, ncol=2) +
    #xlab("Year")+
    #xlim(c(date.start, date.end)) +
    #ylab("Prevalence") +
    theme_bw(base_size=16) +
    guides(color = guide_legend(ncol = 2, byrow = TRUE, keywidth = 2, keyheight = 1)) +
    theme(legend.position="top", legend.text=element_text(size=10)) +
    scale_x_continuous(breaks = seq(1985,2050,10)) +
    theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
    theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
    #scale_y_continuous(labels = scales::percent_format(accuracy = 1), breaks = seq(0,0.25,0.05), limits=c(0, 0.25)) +
    #ylab("HIV Prevalence (%)") + 
    scale_color_manual(values=c("blue","red","darkgreen","orange","black","purple")) 

p 

```

## HIV Prevalence over time

```{r}
ingest.file.base = "/gpfs/data/bershteynlab/EMOD/citrod01/MATUMAINI/202301_Nyanza_Baseline_MalariaOngoing_original/Data/calibration_ingest_form_Nyanza.xlsm"

obs.prev.sheet.base <- EMODAnalyzeR::read.ingest.sheet(ingest.file.base, "Obs-Prevalence")

obs.prev.sheet.base
```


```{r, fig.width=8}
#p <- EMODAnalyzeR::emodplot.prevalence(sim.results %>% filter(Age <= 50, Age >=15), 
#                                       1990, 20240)
p <- EMODAnalyzeR::emodplot.prevalence(sim.results.all %>% filter(Age <= 50, Age >=15), 
                                       1980, 2040, plot.runs = FALSE)

p +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1), breaks = seq(0,0.25,0.05), limits=c(0, 0.25)) +
    ylab("HIV Prevalence (%)") + 
  scale_color_manual(values=c("blue","red","darkgreen","orange","black","purple")) +
  geom_point(data = obs.prev.sheet.base %>%
               filter(Province == 'All', AgeBin == "[15:50)", Gender %in% c("Male", "Female")),
             mapping = aes(x = Year, y = Prevalence)) + 
  geom_errorbar(data = obs.prev.sheet.base %>%
             filter(Province == 'All', AgeBin == "[15:50)", Gender %in% c("Male", "Female")),
             mapping = aes(x = Year, ymin = lb, ymax = ub)) + 
  theme(legend.position = "right")


# ggsave(filename = "/gpfs/data/bershteynlab/EMOD/citrod01/MATUMAINI/Analysis/minimal_HIV_prev.pdf",
#        width = 8, height = 6, units = "in")
```

```{r}
croi.prev.data <- sim.results.all %>% 
  filter(Age >= 15, Age < 50) %>% 
  group_by(Year, Gender, scenario_name, sim.id) %>% 
  summarize(Population = sum(Population*pop.scaling.factor), 
            Infected = sum(Infected*pop.scaling.factor), .groups = 'keep') %>% 
  ungroup() %>% 
  mutate(Prevalence = case_when(Population == 0 ~ 0,
                                Population > 0 ~ Infected/Population)) %>% 
  mutate(Gender = case_when(Gender==0 ~ "Male", Gender==1 ~ "Female"))
  
croi.prev.data.mean <- croi.prev.data %>% 
  group_by(Year, Gender, scenario_name) %>% 
  summarize(Prevalence = mean(Prevalence), .groups = "keep")

p <- ggplot() +
      geom_line(data= croi.prev.data.mean %>% filter(Year > 1985),
              aes(x=Year, y=Prevalence, group=scenario_name, color=scenario_name), linewidth=.5) +
    facet_wrap(~ Gender, ncol=2) +
    #xlab("Year")+
    #xlim(c(date.start, date.end)) +
    #ylab("Prevalence") +
    theme_bw(base_size=16) +
    guides(color = guide_legend(ncol = 2, byrow = TRUE, keywidth = 2, keyheight = 1)) +
    theme(legend.position="top", legend.text=element_text(size=10)) +
    scale_x_continuous(breaks = seq(1985,2050,10)) +
    theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
    theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
    scale_y_continuous(labels = scales::percent_format(accuracy = 1), breaks = seq(0,0.25,0.05), limits=c(0, 0.25)) +
    #ylab("HIV Prevalence (%)") + 
    scale_color_manual(values=c("blue","red","darkgreen","orange","black","purple")) +
    geom_point(data = obs.prev.sheet.base %>%
                 filter(Province == 'All', AgeBin == "[15:50)", Gender %in% c("Male", "Female")),
               mapping = aes(x = Year, y = Prevalence) , color = 'black', size = 3, shape = 15) + 
    geom_errorbar(data = obs.prev.sheet.base %>%
               filter(Province == 'All', AgeBin == "[15:50)", Gender %in% c("Male", "Female")),
               mapping = aes(x = Year, ymin = lb, ymax = ub), color = 'black', size = 1)

p 

```
## Number on ART over time

```{r}
ingest.file.base = "/gpfs/data/bershteynlab/EMOD/citrod01/MATUMAINI/202301_Nyanza_Baseline_MalariaOngoing_original/Data/calibration_ingest_form_Nyanza.xlsm"

obs.onart.sheet <- EMODAnalyzeR::read.ingest.sheet(ingest.file.base, "Obs-OnART")
```




```{r, fig.width=8}
sim.onart <- sim.results.all %>% 
  dplyr::group_by(Year, Gender, sim.id, scenario_name) %>% 
  dplyr::summarize(On_ART = sum(On_ART * pop.scaling.factor), .groups = "keep") %>% 
  ungroup() %>% 
  mutate(Gender = case_when(Gender==0 ~ "Male", Gender==1 ~ "Female"))

sim.onart.mean <- sim.onart %>% 
  group_by(Year, Gender, scenario_name) %>% 
  summarize(On_ART = mean(On_ART), .groups = "keep")

p <- ggplot() +
      geom_line(data= sim.onart.mean %>% filter(Year > 1985),
              aes(x=Year, y=On_ART, group=scenario_name, color=scenario_name), linewidth=.75) +
    facet_wrap(~ Gender, ncol=2) +
    #xlab("Year")+
    #xlim(c(date.start, date.end)) +
    #ylab("Prevalence") +
    theme_bw(base_size=16) +
    guides(color = guide_legend(ncol = 2, byrow = TRUE, keywidth = 2, keyheight = 1)) +
    theme(legend.position="top", legend.text=element_text(size=10)) +
    scale_x_continuous(breaks = seq(1985,2050,10)) +
    theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
    theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
    #scale_y_continuous(labels = scales::percent_format(accuracy = 1), breaks = seq(0,0.25,0.05), limits=c(0, 0.25)) +
    #ylab("HIV Prevalence (%)") + 
    scale_color_manual(values=c("blue","red","darkgreen","orange","black","purple"))
p 
```


## Number of New HIV cases

```{r}
sim.cases <- sim.results.all %>% 
  dplyr::group_by(Year, Gender, sim.id, scenario_name) %>% 
  dplyr::summarize(Newly.Infected = sum(Newly.Infected * pop.scaling.factor), .groups = "keep") %>% 
  ungroup() %>% 
  mutate(Gender = case_when(Gender==0 ~ "Male", Gender==1 ~ "Female"))

sim.cases.mean <- sim.cases %>% 
  group_by(Year, Gender, scenario_name) %>% 
  summarize(Newly.Infected = mean(Newly.Infected), .groups = "keep")

p <- ggplot() +
      geom_line(data= sim.cases.mean %>% filter(Year > 1985),
              aes(x=Year, y= Newly.Infected, group=scenario_name, color=scenario_name), linewidth=.5) +
    facet_wrap(~ Gender, ncol=2) +
    #xlab("Year")+
    #xlim(c(date.start, date.end)) +
    #ylab("Prevalence") +
    theme_bw(base_size=16) +
    guides(color = guide_legend(ncol = 2, byrow = TRUE, keywidth = 2, keyheight = 1)) +
    theme(legend.position="top", legend.text=element_text(size=10)) +
    scale_x_continuous(breaks = seq(1985,2050,10)) +
    theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
    theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
    #scale_y_continuous(labels = scales::percent_format(accuracy = 1), breaks = seq(0,0.25,0.05), limits=c(0, 0.25)) +
    #ylab("HIV Prevalence (%)") + 
    scale_color_manual(values=c("blue","red","darkgreen","orange","black","purple", "pink"))

p
```

```{r}
sim.cases.mean
```


## Number of HIV-related Deaths

```{r, fig.width=8}
sim.deaths <- sim.results.all %>% 
  dplyr::group_by(Year, Gender, sim.id, scenario_name) %>% 
  dplyr::summarize(Died_from_HIV = sum(Died_from_HIV * pop.scaling.factor), .groups = "keep") %>% 
  ungroup() %>% 
  mutate(Gender = case_when(Gender==0 ~ "Male", Gender==1 ~ "Female"))

sim.deaths.mean <- sim.deaths %>% 
  group_by(Year, Gender, scenario_name) %>% 
  summarize(Died_from_HIV = mean(Died_from_HIV), .groups = "keep")

p <- ggplot() +
      geom_line(data= sim.deaths.mean %>% filter(Year > 1985),
              aes(x=Year, y= Died_from_HIV, group=scenario_name, color=scenario_name), linewidth=.5) +
    facet_wrap(~ Gender, ncol=2) +
    #xlab("Year")+
    #xlim(c(date.start, date.end)) +
    #ylab("Prevalence") +
    theme_bw(base_size=16) +
    guides(color = guide_legend(ncol = 2, byrow = TRUE, keywidth = 2, keyheight = 1)) +
    theme(legend.position="top", legend.text=element_text(size=10)) +
    scale_x_continuous(breaks = seq(1985,2050,10)) +
    theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
    theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
    #scale_y_continuous(labels = scales::percent_format(accuracy = 1), breaks = seq(0,0.25,0.05), limits=c(0, 0.25)) +
    #ylab("HIV Prevalence (%)") + 
    scale_color_manual(values=c("blue","red","darkgreen","orange","black","purple", "pink"))

p
```

```{r}
sim.deaths.mean
```

## Depression Prevalence

### Depression Prevalence

```{r}
data.cmd <- sim.results.all %>% filter(Age > 18) %>% 
  mutate(HIVneg = Population - Infected) %>% 
  group_by(Year, Gender, sim.id, IP_Key.CMDStatus, scenario_name) %>% 
  summarize(Population = sum(Population),
            HIVneg = sum(HIVneg),
            Infected = sum(Infected), .groups = 'keep') %>% 
  ungroup() %>% 
  pivot_wider(id_cols = c(Year, Gender, sim.id, scenario_name),
              names_from = c(IP_Key.CMDStatus),
              values_from = c(Population, HIVneg, Infected))  %>% 
  mutate(Population_total = Population_CMD_pos + Population_CMD_neg + Population_CMD_recovered + Population_CMD_treated,
         HIVneg_total = HIVneg_CMD_pos + HIVneg_CMD_neg + HIVneg_CMD_recovered + HIVneg_CMD_treated,
         Infected_total = Infected_CMD_pos + Infected_CMD_neg + Infected_CMD_recovered + Infected_CMD_treated) %>% 
  mutate(CMD_prev_overall = case_when(Population_total == 0 ~ 0,
                                    Population_total > 0 ~ Population_CMD_pos/Population_total),
         CMD_prev_HIVneg = case_when(HIVneg_total == 0 ~ 0,
                                    HIVneg_total > 0 ~ HIVneg_CMD_pos/HIVneg_total),
         CMD_prev_Infected = case_when(Infected_total == 0 ~ 0,
                                    Infected_total > 0 ~ Infected_CMD_pos/Infected_total)) %>% 
  mutate(Gender = case_when(Gender==0 ~ "Male", Gender==1 ~ "Female"))

data.cmd.mean <- data.cmd %>% 
  group_by(Year, Gender, scenario_name) %>%
  summarize(Overall = mean(CMD_prev_overall), Overall_sd = sd(CMD_prev_overall),
            HIVneg = mean(CMD_prev_HIVneg), HIVneg_sd = sd(CMD_prev_HIVneg),
            Infected = mean(CMD_prev_Infected), Infected_sd = sd(CMD_prev_Infected),
            .groups = "keep") %>% 
  ungroup()

# Plot  
p = ggplot() +
  geom_line( data = data.cmd.mean %>% 
                    select(Year, Gender, Overall, Infected, HIVneg, scenario_name) %>% 
                    pivot_longer(cols = c(Overall, Infected, HIVneg),
                                 names_to = "Depression.Prevalence", 
                                 values_to = "CMD_prev"),
    mapping = aes(x = Year, y = CMD_prev, color = Depression.Prevalence), 
    size = 1.0) + 
  scale_y_continuous(limits = c(0.05,.22)) + 
  facet_wrap(Gender ~ scenario_name, nrow = 2) +
  xlab("Year")+ylab("") + 
  ggtitle("Depression Prevalence by HIV status") + 
  theme_bw(base_size=16) +
  guides(fill = guide_legend(keywidth = 2, keyheight = 1)) +
  scale_x_continuous(breaks = seq(1980,2040,10)) +
  theme(legend.position="bottom") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  theme(strip.background = element_rect(colour="black", fill="white")) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())

p
```


### Number of people living with Depression

```{r}
data.cmdpos.pop <- sim.results.all %>% 
  group_by(Year, Gender, sim.id, scenario_name) %>% 
  filter(IP_Key.CMDStatus == "CMD_pos") %>% 
  summarize(Population = sum(Population*pop.scaling.factor), .groups = "keep") %>% 
  # group_by(Year, Gender,scenario_name) %>% 
  # summarize(Population = mean(Population), .groups = "keep") %>% 
  ungroup()

data.cmdpos.pop %>% 
  group_by(Year, Gender, scenario_name) %>% 
  summarize(Population = mean(Population))
```


# Metrics

## Raw numbers

Count the number of cases, deaths, depression episodes for each of the following:

1. All effects: baseline.art
2. Elevated depression incidence for PLHIV: baseline.art.cmd
3. Elevated HIV incidence for people with depression: decouple.art.hivmc
4. Delays to testing decouple.art.delay
5. ART dropout: decouple.art.dropout
6. ART adherence: decouple.art.adh.recov
7. All effects turned off: decouple.art

```{r}
start_year = 1980
end_year = 1990
nruns = 250
```

### Join data together

```{r}
sim.results.all <- rbind(sim.results.baseline.art,
                        sim.results.baseline.art.cmdinc,
                        sim.results.decouple.art.hivinc,
                        sim.results.baseline.art.not.hivmc,
                        sim.results.decouple.art.delay,
                        sim.results.decouple.art.artdrop,
                        sim.results.decouple.art.adh.recov,
                        sim.results.decouple.art)

sim.results.all %>% write_csv("sensitivity_analysis_20240420.csv")
```


### Numbers

```{r}
## Aggregate across ages and years, but keep sim.ix
sim.results.all.agg <- sim.results.all %>% 
  filter(Year >= start_year, Year < end_year)  %>% 
  group_by(Gender, scenario_name, sim.ix) %>% 
  summarize(Newly.Infected = sum(Newly.Infected * pop.scaling.factor), 
            Died_from_HIV = sum(Died_from_HIV * pop.scaling.factor),
            Depression.eps = sum(Population/2),
            .groups = 'keep') %>%
  ungroup() 

sim.results.all.agg.numbers <- sim.results.all.agg %>% 
  group_by(Gender, scenario_name) %>% 
  summarize(
    Newly.Infected.sd = sd(Newly.Infected),
    Newly.Infected = mean(Newly.Infected), 
    Died_from_HIV.sd = sd(Died_from_HIV),
    Died_from_HIV = mean(Died_from_HIV),
    Depression.eps.sd = sd(Depression.eps),
    Depression.eps = mean(Depression.eps), .groups = "keep") %>% 
  ungroup() %>% 
  mutate(
    Newly.Infected_95LL = lower_ci(Newly.Infected, Newly.Infected.sd/sqrt(nruns), nruns, conf_level = .95),
    Newly.Infected_95UL = upper_ci(Newly.Infected, Newly.Infected.sd/sqrt(nruns), nruns, conf_level = .95),
    Died_from_HIV_95LL = lower_ci(Died_from_HIV, Died_from_HIV.sd/sqrt(nruns), nruns, conf_level = .95),
    Died_from_HIV_95UL = upper_ci(Died_from_HIV, Died_from_HIV.sd/sqrt(nruns), nruns, conf_level = .95),
    Depression.eps_95LL = lower_ci(Depression.eps, Depression.eps.sd/sqrt(nruns), nruns, conf_level = .95),
    Depression.eps_95UL = upper_ci(Depression.eps, Depression.eps.sd/sqrt(nruns), nruns, conf_level = .95)
  ) %>% 
  select(
    "Gender", "scenario_name",
    "Newly.Infected", "Newly.Infected.sd", "Newly.Infected_95LL","Newly.Infected_95UL",
    "Died_from_HIV", "Died_from_HIV.sd", "Died_from_HIV_95LL", "Died_from_HIV_95UL",
    "Depression.eps", "Depression.eps.sd", "Depression.eps_95LL", "Depression.eps_95UL"
  ) %>% 
  mutate(Gender = case_when(Gender==0 ~ "Male", Gender==1 ~ "Female"))

sim.results.all.agg.numbers

#write.csv(sim.results.all.agg.numbers, file = "croi_manuscript_numbers_table.csv")
```


```{r}
ggplot(data = sim.results.all.agg.numbers) + 
  geom_point(mapping = aes(x = scenario_name, y = Newly.Infected, color = Gender)) + 
  geom_errorbar(aes(x=scenario_name, ymin = Newly.Infected_95LL, ymax = Newly.Infected_95UL)) + 
  facet_wrap(~ Gender, ncol=2) + 
  scale_color_manual(values = c("red", "blue"))  + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) 
#+ 
#  scale_y_continuous(limits = c(5e5, 9e5)) 

```


### Differences
```{r}
sim.results.all.agg.differences = sim.results.all.agg %>% 
  filter(scenario_name == "decouple.art") %>% 
  select(Gender, sim.ix, 
         Newly.Infected.Decouple = Newly.Infected,
         Died_from_HIV.Decouple = Died_from_HIV,
         Depression.eps.Decouple = Depression.eps
         ) %>%
  merge(sim.results.all.agg,
        by = c("Gender", "sim.ix")) %>%
  mutate(
    Newly.Infected.diff = Newly.Infected - Newly.Infected.Decouple,
    Newly.Infected.pct = (Newly.Infected - Newly.Infected.Decouple)/Newly.Infected.Decouple,
    Died_from_HIV.diff = Died_from_HIV - Died_from_HIV.Decouple,
    Died_from_HIV.pct = (Died_from_HIV - Died_from_HIV.Decouple)/Died_from_HIV.Decouple,
    Depression.eps.diff = Depression.eps - Depression.eps.Decouple,
    Depression.eps.pct = (Depression.eps - Depression.eps.Decouple)/Depression.eps.Decouple,
) %>% 
  group_by(Gender, scenario_name) %>% 
  summarize(Newly.Infected.diff.sd = sd(Newly.Infected.diff),
            Newly.Infected.diff = mean(Newly.Infected.diff),
            Newly.Infected.pct.sd = sd(Newly.Infected.pct),
            Newly.Infected.pct = mean(Newly.Infected.pct),
            Died_from_HIV.diff.sd = sd(Died_from_HIV.diff),
            Died_from_HIV.diff = mean(Died_from_HIV.diff),
            Died_from_HIV.pct.sd = sd(Died_from_HIV.pct),
            Died_from_HIV.pct = mean(Died_from_HIV.pct),
            Depression.eps.diff.sd = sd(Depression.eps.diff),
            Depression.eps.diff = mean(Depression.eps.diff),
            Depression.eps.pct.sd = sd(Depression.eps.pct),
            Depression.eps.pct = mean(Depression.eps.pct), .groups = 'keep'
            ) %>% 
  ungroup() %>% 
  mutate(
    Newly.Infected.diff_95LL = lower_ci(Newly.Infected.diff, Newly.Infected.diff.sd/sqrt(nruns), nruns, conf_level = .95),
    Newly.Infected.diff_95UL = upper_ci(Newly.Infected.diff, Newly.Infected.diff.sd/sqrt(nruns), nruns, conf_level = .95),
    Newly.Infected.pct_95LL = lower_ci(Newly.Infected.pct, Newly.Infected.pct.sd/sqrt(nruns), nruns, conf_level = .95),
    Newly.Infected.pct_95UL = upper_ci(Newly.Infected.pct, Newly.Infected.pct.sd/sqrt(nruns), nruns, conf_level = .95),
    Died_from_HIV.diff_95LL = lower_ci(Died_from_HIV.diff, Died_from_HIV.diff.sd/sqrt(nruns), nruns, conf_level = .95),
    Died_from_HIV.diff_95UL = upper_ci(Died_from_HIV.diff, Died_from_HIV.diff.sd/sqrt(nruns), nruns, conf_level = .95),
    Died_from_HIV.pct_95LL = lower_ci(Died_from_HIV.pct, Died_from_HIV.pct.sd/sqrt(nruns), nruns, conf_level = .95),
    Died_from_HIV.pct_95UL = upper_ci(Died_from_HIV.pct, Died_from_HIV.pct.sd/sqrt(nruns), nruns, conf_level = .95),
    Depression.eps.diff_95LL = lower_ci(Depression.eps.diff, Depression.eps.diff.sd/sqrt(nruns), nruns, conf_level = .95),
    Depression.eps.diff_95UL = upper_ci(Depression.eps.diff, Depression.eps.diff.sd/sqrt(nruns), nruns, conf_level = .95),
    Depression.eps.pct_95LL = lower_ci(Depression.eps.pct, Depression.eps.pct.sd/sqrt(nruns), nruns, conf_level = .95),
    Depression.eps.pct_95UL = upper_ci(Depression.eps.pct, Depression.eps.pct.sd/sqrt(nruns), nruns, conf_level = .95) 
  )  %>% 
  mutate(Gender = case_when(Gender==0 ~ "Male", Gender==1 ~ "Female")) %>% 
  select(
    "Gender", "scenario_name",
    "Newly.Infected.diff", "Newly.Infected.diff.sd", "Newly.Infected.diff_95LL","Newly.Infected.diff_95UL",
    "Newly.Infected.pct" ,"Newly.Infected.pct.sd" , "Newly.Infected.pct_95LL",  "Newly.Infected.pct_95UL",
    "Died_from_HIV.diff", "Died_from_HIV.diff.sd", "Died_from_HIV.diff_95LL", "Died_from_HIV.diff_95UL",
    "Died_from_HIV.pct", "Died_from_HIV.pct.sd", "Died_from_HIV.pct_95LL", "Died_from_HIV.pct_95UL",
    "Depression.eps.diff", "Depression.eps.diff.sd", "Depression.eps.diff_95LL", "Depression.eps.diff_95UL",
    "Depression.eps.pct", "Depression.eps.pct.sd", "Depression.eps.pct_95LL", "Depression.eps.pct_95UL"
  )

sim.results.all.agg.differences

#write.csv(sim.results.all.agg.differences, file = "croi_manuscript_differences_table.csv")
```

```{r}
ggplot(data = sim.results.all.agg.differences) + 
  geom_point(mapping = aes(x = scenario_name, y = Newly.Infected.diff, color = Gender)) + 
  geom_errorbar(aes(x=scenario_name, ymin = Newly.Infected.diff_95LL, ymax = Newly.Infected.diff_95UL)) + 
  facet_wrap(~ Gender, ncol=2) + 
  scale_color_manual(values = c("red", "blue"))  + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) 

#ggsave("New_Cases_Difference.pdf", height = 4, width = 8, units = "in")
```

```{r}
ggplot(data = sim.results.all.agg.differences) + 
  geom_point(mapping = aes(x = scenario_name, y = Newly.Infected.pct, color = Gender)) + 
  geom_errorbar(aes(x=scenario_name, ymin = Newly.Infected.pct_95LL, ymax = Newly.Infected.pct_95UL)) + 
  facet_wrap(~ Gender, ncol=2) + 
  scale_color_manual(values = c("red", "blue"))  + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) 

ggsave("New_Cases_Percent_Difference.pdf", height = 4, width = 8, units = "in")
```

```{r}
ggplot(data = sim.results.all.agg.differences) + 
  geom_point(mapping = aes(x = scenario_name, y = Died_from_HIV.diff, color = Gender)) + 
  geom_errorbar(aes(x=scenario_name, ymin = Died_from_HIV.diff_95LL, ymax = Died_from_HIV.diff_95UL)) + 
  facet_wrap(~ Gender, ncol=2) + 
  scale_color_manual(values = c("red", "blue"))  + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) 

ggsave("HIV_Deaths_Difference.pdf", height = 4, width = 8, units = "in")
```

```{r}
ggplot(data = sim.results.all.agg.differences) + 
  geom_point(mapping = aes(x = scenario_name, y = Died_from_HIV.pct, color = Gender)) + 
  geom_errorbar(aes(x=scenario_name, ymin = Died_from_HIV.pct_95LL, ymax = Died_from_HIV.pct_95UL)) + 
  facet_wrap(~ Gender, ncol=2) + 
  scale_color_manual(values = c("red", "blue"))  + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) 


ggsave("HIV_Deaths_Percent_Difference.pdf", height = 4, width = 8, units = "in")
```
### Test
This is testing the difference between decouple.art and baseline.cmdinc

```{r}
sim.results.all <- rbind(sim.results.baseline.art.cmdinc.test,
                        sim.results.decouple.art.test)


test.comparison <- sim.results.all %>%
 group_by(Year, Gender, scenario_name, IP_Key.CMDStatus, sim.ix) %>% 
  summarize(Population = sum(Population), 
            Infected = sum(Infected),
            Died = sum(Died),
            Died_from_HIV = sum(Died_from_HIV),
            Newly.Infected = sum(Newly.Infected)) %>% ungroup()

test.comparison %>% 
  filter(sim.ix == 1, Year > 1989) %>% arrange(Year, Gender, scenario_name, IP_Key.CMDStatus) %>% View

test.comp.mean <- test.comparison %>% 
  group_by(Year, Gender, scenario_name) %>% 
  summarize(Population = mean(Population), 
            Infected = mean(Infected),
            Died = mean(Died),
            Died_from_HIV = mean(Died_from_HIV),
            Newly.Infected = mean(Newly.Infected)) %>% ungroup()


test.comp.mean %>% arrange(Year, Gender, scenario_name) %>% 
  filter(Year >= 1995, Year <= 2000) %>% 
  group_by(Gender, scenario_name) %>% 
  summarize(Infected = sum(Infected),
           Died_from_HIV = sum(Died_from_HIV),
           Newly.Infected = sum(Newly.Infected)) %>% View

test.comparison %>% 
  group_by(Year, Gender, scenario_name, IP_Key.CMDStatus) %>% 
  summarize(Population = mean(Population), 
            Infected = mean(Infected),
            Died = mean(Died),
            Died_from_HIV = mean(Died_from_HIV),
            Newly.Infected = mean(Newly.Infected)) %>% ungroup() %>% 
  ggplot() + 
  geom_line(mapping = aes(x = Year, y = Newly.Infected, color = scenario_name)) + 
  facet_wrap(IP_Key.CMDStatus ~ Gender, ncol=2)

test.comparison %>% 
  group_by(Year, Gender, scenario_name) %>% 
  summarize(Population = mean(Population), 
            Infected = mean(Infected),
            Died = mean(Died),
            Died_from_HIV = mean(Died_from_HIV),
            Newly.Infected = mean(Newly.Infected)) %>% ungroup() %>% 
  ggplot() + 
  geom_line(mapping = aes(x = Year, y = Infected, color = scenario_name)) + 
  facet_wrap( ~ Gender, ncol=2)

test.comparison %>% 
  group_by(Year, Gender, scenario_name) %>% 
  summarize(Population = mean(Population), 
            Infected = mean(Infected),
            Died = mean(Died),
            Died_from_HIV = mean(Died_from_HIV),
            Newly.Infected = mean(Newly.Infected)) %>% #ungroup() %>% arrange(Year, Gender, scenario_name) %>% View
  ggplot() + 
  geom_line(mapping = aes(x = Year, y = Died_from_HIV, color = scenario_name)) + 
  facet_wrap(~ Gender, ncol=2)

test.comparison %>% 
  group_by(Year, Gender, scenario_name) %>% 
  summarize(Population = mean(Population), 
            Infected = mean(Infected),
            Died = mean(Died),
            Died_from_HIV = mean(Died_from_HIV),
            Newly.Infected = mean(Newly.Infected)) %>% #ungroup() %>% arrange(Year, Gender, scenario_name) %>% View
  ggplot() + 
  geom_line(mapping = aes(x = Year, y = Infected, color = scenario_name)) + 
  facet_wrap(~ Gender, ncol=2)

```


### Cases 

### Deaths

### Episodes of depression

```{r}
cmd.episodes <- sim.results.all %>% 
  filter(Year >= start_year, Year < end_year) %>% 
  group_by(Year, Gender, sim.ix, scenario_name) %>% 
  filter(IP_Key.CMDStatus == "CMD_pos") %>% 
  summarize(Population = sum(Population*pop.scaling.factor), .groups = "keep") %>% 
  # group_by(Year, Gender,scenario_name) %>% 
  # summarize(Population = mean(Population), .groups = "keep") %>% 
  ungroup() %>% 
  mutate(Gender = case_when(Gender==0 ~ "Male", Gender==1 ~ "Female"))

cmd.episodes.sum <- cmd.episodes %>% 
  group_by(Gender, sim.ix, scenario_name) %>% 
  summarize(Depression.eps = sum(Population), .groups = 'keep') %>% 
  ungroup()

cmd.episodes.mean <- cmd.episodes.sum %>% 
  group_by(Gender, scenario_name) %>% 
  summarize(
    Depression.eps.sd = sd(Depression.eps),
    Depression.eps = mean(Depression.eps), .groups = "keep") %>% 
  ungroup() %>% 
  mutate(
    Depression.eps_95LL = lower_ci(Depression.eps, Depression.eps.sd/sqrt(nruns), nruns, conf_level = .95),
    Depression.eps_95UL = upper_ci(Depression.eps, Depression.eps.sd/sqrt(nruns), nruns, conf_level = .95)
  )

cmd.episodes.mean
```

### Reordering for presentation

```{r}
custom_order =c("baseline.art", "decouple.art.hivinc", "decouple.art.adh.recov", "decouple.art.delay", "decouple.art.artdrop",  "baseline.art.cmdinc", "decouple.art")
ix = c(1:7)

sim.cases.final <- sim.cases.mean %>% mutate(decouple.art = case_when(
  Gender == "Male" ~ sim.cases.mean %>% filter(Gender == "Male", scenario_name == "decouple.art") %>% .$Newly.Infected %>% unlist,
  Gender == "Female" ~ sim.cases.mean %>% filter(Gender == "Female", scenario_name == "decouple.art") %>% .$Newly.Infected %>% unlist)
  ) %>% 
  mutate(Difference = Newly.Infected - decouple.art) %>% 
  mutate(Pct.Difference = Difference/decouple.art) %>% 
  mutate(ix = ix[match(scenario_name, custom_order)]) %>% 
  arrange(Gender, ix) %>% 
  select("ix", "scenario_name", "Gender", "Newly.Infected", "Newly.Infected_95LL", "Newly.Infected_95UL", "Newly.Infected.sd", "Difference", "Pct.Difference")
sim.cases.final %>% View

sim.deaths.final <- sim.deaths.mean %>% mutate(decouple.art = case_when(
  Gender == "Male" ~ sim.deaths.mean %>% filter(Gender == "Male", scenario_name == "decouple.art") %>% .$Died_from_HIV %>% unlist,
  Gender == "Female" ~ sim.deaths.mean %>% filter(Gender == "Female", scenario_name == "decouple.art") %>% .$Died_from_HIV %>% unlist)
  ) %>% 
  mutate(Difference = Died_from_HIV - decouple.art) %>% 
  mutate(Pct.Difference = Difference/decouple.art) %>% mutate(ix = ix[match(scenario_name, custom_order)]) %>% 
  arrange(Gender, ix) %>% 
  select("ix", "scenario_name", "Gender", "Died_from_HIV", "Died_from_HIV_95LL", "Died_from_HIV_95UL", "Died_from_HIV.sd", "Difference", "Pct.Difference") %>% View

sim.deaths.final <- cmd.episodes.mean %>% mutate(decouple.art = case_when(
  Gender == "Male" ~ cmd.episodes.mean %>% filter(Gender == "Male", scenario_name == "decouple.art") %>% .$Depression.eps %>% unlist,
  Gender == "Female" ~ cmd.episodes.mean %>% filter(Gender == "Female", scenario_name == "decouple.art") %>% .$Depression.eps %>% unlist)
  ) %>% 
  mutate(Difference = Depression.eps - decouple.art) %>% 
  mutate(Pct.Difference = Difference/decouple.art) %>% mutate(ix = ix[match(scenario_name, custom_order)]) %>% 
  arrange(Gender, ix) %>% 
  select("ix", "scenario_name", "Gender", "Depression.eps", "Depression.eps_95LL", "Depression.eps_95UL", "Depression.eps.sd", "Difference", "Pct.Difference")
sim.deaths.final %>% View
```

## ART Benefit

Break down time into five periods:
* Entire epidemic: 1980-2025
* Period before ART: 1980-2005
* ART scale-up period: 2006-2015
* Universal ART: 2016-2025
* Future: 2025-2050

Things to measure
* New infections
  * New infections
  * New infections per person-year lived with HIV
  * New infections per person-year lived with ART
* Deaths
  * Deaths
  * Deaths per person-year lived with HIV
  * Deaths per person-year lived with ART
* Sources of transmission from people on/off ART
  * Transmissions
  * Transmissions per person-year lived with HIV
  * Transmissions per person-year lived with ART

Produce these metrics for each dataset that we have produced so far.

### Join Data together

```{r}

```


### Entire past epidemic 1980-2025

```{r}
# aggregate metrics by year and scenario
metrics.all <- sim.results.all %>% 
  filter(Year >= 1980, Year <= 2025) %>% 
  group_by(Year, scenario_name, sim.ix) %>% 
  summarize(
    Newly.Infected = sum(Newly.Infected * pop.scaling.factor),
    Died_from_HIV = sum(Died_from_HIV * pop.scaling.factor), 
    Infected = sum(Infected * pop.scaling.factor/2), 
    On_ART = sum(On_ART * pop.scaling.factor/2),
    .groups = "keep")

metrics.all %>% 
  group_by(Year, scenario_name) %>% 
  summarize(
    Newly.Infected = mean(Newly.Infected), 
    Died_from_HIV = mean(Died_from_HIV),
    Infected = mean(Infected),
    On_ART = mean(On_ART), 
    .groups = 'keep'
  )

metrics.1985.2025 <- metrics.all %>% 
  filter(Year >= 1985,Year <= 2025) %>%
  group_by(scenario_name, sim.ix) %>% 
  summarize(
    Newly.Infected = sum(Newly.Infected),
    Died_from_HIV = sum(Died_from_HIV), 
    Infected = sum(Infected), 
    On_ART = sum(On_ART),
    .groups = "keep") %>% 
  group_by(scenario_name) %>% 
  summarize(
    Newly.Infected = mean(Newly.Infected), 
    Died_from_HIV = mean(Died_from_HIV),
    Infected = mean(Infected),
    On_ART = mean(On_ART), 
    .groups = 'keep'
  )

metrics.1985.2025 %>% 
  cbind(metrics.1985.2025 %>% filter(scenario_name == "decouple.noart" ) %>% 
  ungroup() %>% 
  select( Newly.Infected.noart = Newly.Infected, Died_from_HIV.noart = Died_from_HIV, 
          Infected.noart = Infected, On_ART.noart = On_ART)) %>% 
  mutate(Period = "1985-2025") %>% 
  mutate(ART.infections.prevented = Newly.Infected.noart - Newly.Infected,
         ART.infections.prevented.per.yr.LHIV = (Newly.Infected.noart - Newly.Infected)/Infected,
         ART.infections.prevented.per.yr.ART = (Newly.Infected.noart - Newly.Infected)/On_ART,
         ART.HIVdeaths.prevented = Died_from_HIV.noart - Died_from_HIV,
         ART.HIVdeaths.prevented.per.yr.LHIV = (Died_from_HIV.noart - Died_from_HIV)/Infected,
         ART.HIVdeaths.prevented.per.yr.ART = (Died_from_HIV.noart - Died_from_HIV)/On_ART
         )
```

### Pre-ART 1985-2005

```{r}
# aggregate metrics by year and scenario
metrics.all <- sim.results.all %>% 
  filter(Year >= 1980, Year < 2006) %>% 
  group_by(Year, scenario_name, sim.ix) %>% 
  summarize(
    Newly.Infected = sum(Newly.Infected * pop.scaling.factor),
    Died_from_HIV = sum(Died_from_HIV * pop.scaling.factor), 
    Infected = sum(Infected * pop.scaling.factor/2), 
    On_ART = sum(On_ART * pop.scaling.factor/2),
    .groups = "keep")

metrics.all %>% 
  group_by(Year, scenario_name) %>% 
  summarize(
    Newly.Infected = mean(Newly.Infected), 
    Died_from_HIV = mean(Died_from_HIV),
    Infected = mean(Infected),
    On_ART = mean(On_ART), 
    .groups = 'keep'
  )

metrics.1985.2005 <- metrics.all %>% 
  filter(Year >= 1985,Year < 2006) %>%
  group_by(scenario_name, sim.ix) %>% 
  summarize(
    Newly.Infected = sum(Newly.Infected),
    Died_from_HIV = sum(Died_from_HIV), 
    Infected = sum(Infected), 
    On_ART = sum(On_ART),
    .groups = "keep") %>% 
  group_by(scenario_name) %>% 
  summarize(
    Newly.Infected = mean(Newly.Infected), 
    Died_from_HIV = mean(Died_from_HIV),
    Infected = mean(Infected),
    On_ART = mean(On_ART), 
    .groups = 'keep'
  )


metrics.1985.2005 %>% 
  cbind(metrics.1985.2005 %>% filter(scenario_name == "decouple.noart" ) %>% 
  ungroup() %>% 
  select( Newly.Infected.noart = Newly.Infected, Died_from_HIV.noart = Died_from_HIV, 
          Infected.noart = Infected, On_ART.noart = On_ART)) %>% 
  mutate(Period = "1985-2005") %>% 
  mutate(ART.infections.prevented = Newly.Infected.noart - Newly.Infected,
         ART.infections.prevented.per.yr.LHIV = (Newly.Infected.noart - Newly.Infected)/Infected,
         ART.infections.prevented.per.yr.ART = (Newly.Infected.noart - Newly.Infected)/On_ART,
         ART.HIVdeaths.prevented = Died_from_HIV.noart - Died_from_HIV,
         ART.HIVdeaths.prevented.per.yr.LHIV = (Died_from_HIV.noart - Died_from_HIV)/Infected,
         ART.HIVdeaths.prevented.per.yr.ART = (Died_from_HIV.noart - Died_from_HIV)/On_ART
         )
```

### ART Scaleup 2006-2015

```{r}
# aggregate metrics by year and scenario
metrics.all <- sim.results.all %>% 
  filter(Year >= 2006, Year < 2026) %>% 
  group_by(Year, scenario_name, sim.ix) %>% 
  summarize(
    Newly.Infected = sum(Newly.Infected * pop.scaling.factor),
    Died_from_HIV = sum(Died_from_HIV * pop.scaling.factor), 
    Infected = sum(Infected * pop.scaling.factor/2), 
    On_ART = sum(On_ART * pop.scaling.factor/2),
    .groups = "keep")

metrics.all %>% 
  group_by(Year, scenario_name) %>% 
  summarize(
    Newly.Infected = mean(Newly.Infected), 
    Died_from_HIV = mean(Died_from_HIV),
    Infected = mean(Infected),
    On_ART = mean(On_ART), 
    .groups = 'keep'
  )

metrics.2006.2015 <- metrics.all %>% 
  filter(Year >= 2006,Year < 2026) %>%
  group_by(scenario_name, sim.ix) %>% 
  summarize(
    Newly.Infected = sum(Newly.Infected),
    Died_from_HIV = sum(Died_from_HIV), 
    Infected = sum(Infected), 
    On_ART = sum(On_ART),
    .groups = "keep") %>% 
  group_by(scenario_name) %>% 
  summarize(
    Newly.Infected = mean(Newly.Infected), 
    Died_from_HIV = mean(Died_from_HIV),
    Infected = mean(Infected),
    On_ART = mean(On_ART), 
    .groups = 'keep'
  )


metrics.2006.2015 %>% 
  cbind(metrics.2006.2015 %>% filter(scenario_name == "decouple.noart" ) %>% 
  ungroup() %>% 
  select( Newly.Infected.noart = Newly.Infected, Died_from_HIV.noart = Died_from_HIV, 
          Infected.noart = Infected, On_ART.noart = On_ART)) %>% 
  mutate(Period = "2006-2015") %>% 
  mutate(ART.infections.prevented = Newly.Infected.noart - Newly.Infected,
         ART.infections.prevented.per.yr.LHIV = (Newly.Infected.noart - Newly.Infected)/Infected,
         ART.infections.prevented.per.yr.ART = (Newly.Infected.noart - Newly.Infected)/On_ART,
         ART.HIVdeaths.prevented = Died_from_HIV.noart - Died_from_HIV,
         ART.HIVdeaths.prevented.per.yr.LHIV = (Died_from_HIV.noart - Died_from_HIV)/Infected,
         ART.HIVdeaths.prevented.per.yr.ART = (Died_from_HIV.noart - Died_from_HIV)/On_ART
         )
```

### Universal ART 2016-2025

```{r}
# aggregate metrics by year and scenario
metrics.all <- sim.results.all %>% 
  filter(Year >= 2016, Year < 2026) %>% 
  group_by(Year, scenario_name, sim.ix) %>% 
  summarize(
    Newly.Infected = sum(Newly.Infected * pop.scaling.factor),
    Died_from_HIV = sum(Died_from_HIV * pop.scaling.factor), 
    Infected = sum(Infected * pop.scaling.factor/2), 
    On_ART = sum(On_ART * pop.scaling.factor/2),
    .groups = "keep")

metrics.all %>% 
  group_by(Year, scenario_name) %>% 
  summarize(
    Newly.Infected = mean(Newly.Infected), 
    Died_from_HIV = mean(Died_from_HIV),
    Infected = mean(Infected),
    On_ART = mean(On_ART), 
    .groups = 'keep'
  )

metrics.2016.2025 <- metrics.all %>% 
  filter(Year >= 2016,Year < 2026) %>%
  group_by(scenario_name, sim.ix) %>% 
  summarize(
    Newly.Infected = sum(Newly.Infected),
    Died_from_HIV = sum(Died_from_HIV), 
    Infected = sum(Infected), 
    On_ART = sum(On_ART),
    .groups = "keep") %>% 
  group_by(scenario_name) %>% 
  summarize(
    Newly.Infected = mean(Newly.Infected), 
    Died_from_HIV = mean(Died_from_HIV),
    Infected = mean(Infected),
    On_ART = mean(On_ART), 
    .groups = 'keep'
  )

metrics.2016.2025 %>% 
  cbind(metrics.2016.2025 %>% filter(scenario_name == "decouple.noart" ) %>% 
  ungroup() %>% 
  select( Newly.Infected.noart = Newly.Infected, Died_from_HIV.noart = Died_from_HIV, 
          Infected.noart = Infected, On_ART.noart = On_ART)) %>% 
  mutate(Period = "2016-2025") %>% 
  mutate(ART.infections.prevented = Newly.Infected.noart - Newly.Infected,
         ART.infections.prevented.per.yr.LHIV = (Newly.Infected.noart - Newly.Infected)/Infected,
         ART.infections.prevented.per.yr.ART = (Newly.Infected.noart - Newly.Infected)/On_ART,
         ART.HIVdeaths.prevented = Died_from_HIV.noart - Died_from_HIV,
         ART.HIVdeaths.prevented.per.yr.LHIV = (Died_from_HIV.noart - Died_from_HIV)/Infected,
         ART.HIVdeaths.prevented.per.yr.ART = (Died_from_HIV.noart - Died_from_HIV)/On_ART
         ) 
```


### Future 2026-2050

```{r}
# aggregate metrics by year and scenario
metrics.all <- sim.results.all %>% 
  filter(Year >= 2026, Year <= 2050) %>% 
  group_by(Year, scenario_name, sim.ix) %>% 
  summarize(
    Newly.Infected = sum(Newly.Infected * pop.scaling.factor),
    Died_from_HIV = sum(Died_from_HIV * pop.scaling.factor), 
    Infected = sum(Infected * pop.scaling.factor/2), 
    On_ART = sum(On_ART * pop.scaling.factor/2),
    .groups = "keep")

metrics.all %>% 
  group_by(Year, scenario_name) %>% 
  summarize(
    Newly.Infected = mean(Newly.Infected), 
    Died_from_HIV = mean(Died_from_HIV),
    Infected = mean(Infected),
    On_ART = mean(On_ART), 
    .groups = 'keep'
  )

metrics.2026.2050 <- metrics.all %>% 
  filter(Year >= 2026, Year <= 2050) %>%
  group_by(scenario_name, sim.ix) %>% 
  summarize(
    Newly.Infected = sum(Newly.Infected),
    Died_from_HIV = sum(Died_from_HIV), 
    Infected = sum(Infected), 
    On_ART = sum(On_ART),
    .groups = "keep") %>% 
  group_by(scenario_name) %>% 
  summarize(
    Newly.Infected = mean(Newly.Infected), 
    Died_from_HIV = mean(Died_from_HIV),
    Infected = mean(Infected),
    On_ART = mean(On_ART), 
    .groups = 'keep'
  )

metrics.2026.2050 %>% 
  cbind(metrics.2026.2050 %>% filter(scenario_name == "decouple.noart" ) %>% 
  ungroup() %>% 
  select( Newly.Infected.noart = Newly.Infected, Died_from_HIV.noart = Died_from_HIV, 
          Infected.noart = Infected, On_ART.noart = On_ART)) %>% 
  mutate(Period = "2026-2025") %>% 
  mutate(ART.infections.prevented = Newly.Infected.noart - Newly.Infected,
         ART.infections.prevented.per.yr.LHIV = (Newly.Infected.noart - Newly.Infected)/Infected,
         ART.infections.prevented.per.yr.ART = (Newly.Infected.noart - Newly.Infected)/On_ART,
         ART.HIVdeaths.prevented = Died_from_HIV.noart - Died_from_HIV,
         ART.HIVdeaths.prevented.per.yr.LHIV = (Died_from_HIV.noart - Died_from_HIV)/Infected,
         ART.HIVdeaths.prevented.per.yr.ART = (Died_from_HIV.noart - Died_from_HIV)/On_ART
         )
```

