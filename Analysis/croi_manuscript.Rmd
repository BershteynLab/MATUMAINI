---
title: "croi_manuscript_analysis"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

The purpose of this notebook will be to perform the analysis post-CROI, in preparation for completing the manuscript of the CROI results

# Load libraries

```{r Load Libraries}
library(tidyverse)
library(data.table)
library(magrittr)
library(rsample)
library(readxl)
library(devtools)
library(ggpubr)
library(patchwork)

devtools::install_github("BershteynLab/EMODAnalyzeR", force = TRUE)
```


```{r}
# Confidence interval functions
lower_ci <- function(mean, se, n, conf_level = 0.95){
  lower_ci <- mean - qt(1 - ((1 - conf_level) / 2), n - 1) * se
  return(lower_ci)
}
upper_ci <- function(mean, se, n, conf_level = 0.95){
  upper_ci <- mean + qt(1 - ((1 - conf_level) / 2), n - 1) * se
  return(upper_ci)
}
```

# Context 

The "baseline scenario" set of HIV-CMD interactions
1. Depression dynamics
  1. Age/sex-specific annual incidence of depression
  2. HIV+ status also increases depression incidence
  3. Relapse rate equal to incidence rate
2. Depression-caused increase to incidence - CoitalActRiskFactor increases from 1 to 1.646
3. Depression-caused delays to diagnosis (2/3 of depressed skip diagnosis)
4. Depression-caused dropout from ART (mean time 5 years for depressed, 10 years for non-depressed)
5. Depression-caused non-adherence to ART


## 2024-03-18
At the moment we are stuck on trying to figure out how to show that depression reducing art adherence has been bad.

# Read in data

## Decouple, ART
```{r}
# Version 4 post May 2024 model
# results_path = "/gpfs/data/bershteynlab/EMOD/citrod01/MATUMAINI/202301_Nyanza_MATUMAINI_MalariaOngoing/sensitivity_analysis/Baseline-campaign_MATUMAINI_202305_decouple-decouple_art/ReportHIVByAgeAndGender/"
# sim.results.decouple.art <- EMODAnalyzeR::read.simulation.results(
#   results_path = results_path,
#   scenario_name = 'decouple.art',
#   summarize_columns = c("Population","Infected", "On_ART",
#                         "Died", "Died_from_HIV",
#                         "Newly.Infected","Diagnosed"),
#   #stratify_columns = c("Year", "Gender", "IP_Key.CMDStatus"),
#   stratify_columns = c("Year", "Gender", "Age", "IP_Key.CMDStatus"),
#   min_age_inclusive = 0,
#   max_age_inclusive = 99
# )

# results used for CROI
# results_path = "/gpfs/data/bershteynlab/EMOD/citrod01/MATUMAINI/202301_Nyanza_MATUMAINI_MalariaOngoing/croi/Baseline-campaign_MATUMAINI_202305_decouple-decouple_adh_ART/ReportHIVByAgeAndGender/",
#   # results from post-croi
#   experiment_path = "/gpfs/scratch/citrod01/experiments/MATUMAINI/Baseline-campaign_MATUMAINI_202305_decouple-decouple_art___2024_04_17_18_51_35_650911",
# Version 5 May 2024
#experiment.path = "/gpfs/scratch/citrod01/experiments/MATUMAINI/Baseline-campaign_MATUMAINI_202305_decouple-decouple_art___2024_05_29_10_56_12_042206"

# Version 6 July 2024
experiment.path = "/gpfs/scratch/citrod01/experiments/MATUMAINI/manuscript/Baseline-campaign_MATUMAINI_202305_decouple-decouple_art___2024_07_04_12_57_51_112851"

sim.results.decouple.art <- EMODAnalyzeR::read.simulation.results.bigpurple(
  experiment_path = experiment.path,
  scenario_name = "decouple.art",
    summarize_columns = c("Population","Infected", "On_ART",
                        "Died", "Died_from_HIV",
                        "Newly.Infected","Diagnosed"),
  stratify_columns = c("Year", "Gender", "Age", "IP_Key.CMDStatus"),
  min_age_inclusive = 0,
  max_age_inclusive = 99
)

```

## Elevated CMD Incidence, ART
```{r}
# Version 4 
# results_path = "/gpfs/data/bershteynlab/EMOD/citrod01/MATUMAINI/202301_Nyanza_MATUMAINI_MalariaOngoing/sensitivity_analysis/Baseline-campaign_MATUMAINI_202305-baseline_art_cmdinc/ReportHIVByAgeAndGender"
# 
# sim.results.baseline.art.cmdinc <- EMODAnalyzeR::read.simulation.results(
#   results_path = results_path,
#   scenario_name = 'baseline.art.cmdinc',
#   summarize_columns = c("Population","Infected", "On_ART",
#                         "Died", "Died_from_HIV",
#                         "Newly.Infected","Diagnosed"),
#   #stratify_columns = c("Year", "Gender", "IP_Key.CMDStatus"),
#   stratify_columns = c("Year", "Gender", "Age", "IP_Key.CMDStatus"),
#   min_age_inclusive = 0,
#   max_age_inclusive = 99
# )


# experiment_path = "/gpfs/scratch/citrod01/experiments/MATUMAINI/Baseline-campaign_MATUMAINI_202305-baseline_art_cmdinc___2024_04_11_14_47_19_957569/"
# Version 5 post May 2024 model
#experiment_path = "/gpfs/scratch/citrod01/experiments/MATUMAINI/Baseline-campaign_MATUMAINI_202305-baseline_art_cmdinc___2024_05_31_15_03_01_888750"

# Version 6 July 2024
experiment.path = "/gpfs/scratch/citrod01/experiments/MATUMAINI/manuscript/Baseline-campaign_MATUMAINI_202305-baseline_art___2024_07_04_13_17_52_169973"

sim.results.baseline.art.cmdinc <- EMODAnalyzeR::read.simulation.results.bigpurple(
  experiment_path = experiment.path,
  scenario_name = 'baseline.art.cmdinc',
  summarize_columns = c("Population","Infected", "On_ART",
                        "Died", "Died_from_HIV",
                        "Newly.Infected","Diagnosed"),
  stratify_columns = c("Year", "Gender", "Age", "IP_Key.CMDStatus"),
  #stratify_columns = c("Year", "Gender","IP_Key.CMDStatus"),
  min_age_inclusive = 0,
  max_age_inclusive = 99
)
```


## Decouple, ART, Increased HIV acquisition
```{r}
# Version 4 of model
# results_path = "/gpfs/data/bershteynlab/EMOD/citrod01/MATUMAINI/202301_Nyanza_MATUMAINI_MalariaOngoing/sensitivity_analysis/Baseline-campaign_MATUMAINI_202305_decouple-decouple_art_hivinc/ReportHIVByAgeAndGender"
# sim.results.decouple.art.hivinc <- EMODAnalyzeR::read.simulation.results(
#   results_path = results_path,
#   scenario_name = 'decouple.art.hivinc',
#   summarize_columns = c("Population","Infected", "On_ART",
#                         "Died", "Died_from_HIV",
#                         "Newly.Infected","Diagnosed"),
#   #stratify_columns = c("Year", "Gender", "IP_Key.CMDStatus"),
#   stratify_columns = c("Year", "Gender", "Age", "IP_Key.CMDStatus"),
#   min_age_inclusive = 0,
#   max_age_inclusive = 99
# )

# experiment_path = "/gpfs/scratch/citrod01/experiments/MATUMAINI/Baseline-campaign_MATUMAINI_202305_decouple-decouple_art_hivinc___2024_04_11_14_52_01_213969/"
# Version 5 of model
#experiment_path = "/gpfs/scratch/citrod01/experiments/MATUMAINI/Baseline-campaign_MATUMAINI_202305_decouple-decouple_art_hivinc___2024_05_31_15_07_04_198113"

# Version 6 July 2024
experiment.path = "/gpfs/scratch/citrod01/experiments/MATUMAINI/manuscript/Baseline-campaign_MATUMAINI_202305_decouple-decouple_art_hivinc___2024_07_04_13_03_05_010841"

sim.results.decouple.art.hivinc <- EMODAnalyzeR::read.simulation.results.bigpurple(
  experiment_path = experiment.path,
  scenario_name = 'decouple.art.hivinc',
  summarize_columns = c("Population","Infected", "On_ART",
                        "Died", "Died_from_HIV",
                        "Newly.Infected","Diagnosed"),
  stratify_columns = c("Year", "Gender", "Age", "IP_Key.CMDStatus"),
  #stratify_columns = c("Year", "Gender","IP_Key.CMDStatus"),
  min_age_inclusive = 0,
  max_age_inclusive = 99
)
```

## Decouple, ART, Increased HIV transmission
```{r}
# Version 6 July 2024
experiment.path = "/gpfs/scratch/citrod01/experiments/MATUMAINI/manuscript/Baseline-campaign_MATUMAINI_202305_decouple-decouple_art_hivtr___2024_07_04_13_05_28_217309/"

sim.results.decouple.art.hivtr <- EMODAnalyzeR::read.simulation.results.bigpurple(
  experiment_path = experiment.path,
  scenario_name = 'decouple.art.hivtr',
  summarize_columns = c("Population","Infected", "On_ART",
                        "Died", "Died_from_HIV",
                        "Newly.Infected","Diagnosed"),
  stratify_columns = c("Year", "Gender", "Age", "IP_Key.CMDStatus"),
  #stratify_columns = c("Year", "Gender","IP_Key.CMDStatus"),
  min_age_inclusive = 0,
  max_age_inclusive = 99
)
```

## Decouple, ART, Increased HIV acquisition and transmission
```{r}
# Version 6 July 2024
experiment.path = "/gpfs/scratch/citrod01/experiments/MATUMAINI/manuscript/Baseline-campaign_MATUMAINI_202305_decouple-decouple_art_hivinc_hivtr___2024_07_08_10_39_54_210607"

sim.results.decouple.art.hivinc.hivtr <- EMODAnalyzeR::read.simulation.results.bigpurple(
  experiment_path = experiment.path,
  scenario_name = 'decouple.art.hivinc.hivtr',
  summarize_columns = c("Population","Infected", "On_ART",
                        "Died", "Died_from_HIV",
                        "Newly.Infected","Diagnosed"),
  stratify_columns = c("Year", "Gender", "Age", "IP_Key.CMDStatus"),
  #stratify_columns = c("Year", "Gender","IP_Key.CMDStatus"),
  min_age_inclusive = 0,
  max_age_inclusive = 99
)
```

## Decouple, ART, Delay to testing
```{r}
# Version 4 of model
# results_path = "/gpfs/data/bershteynlab/EMOD/citrod01/MATUMAINI/202301_Nyanza_MATUMAINI_MalariaOngoing/sensitivity_analysis/Baseline-campaign_MATUMAINI_202305_decouple-decouple_art_delay/ReportHIVByAgeAndGender"
# 
# sim.results.decouple.art.delay <- EMODAnalyzeR::read.simulation.results(
#   results_path = results_path,
#   scenario_name = 'decouple.art.delay',
#   summarize_columns = c("Population","Infected", "On_ART",
#                         "Died", "Died_from_HIV",
#                         "Newly.Infected","Diagnosed"),
#   #stratify_columns = c("Year", "Gender", "IP_Key.CMDStatus"),
#   stratify_columns = c("Year", "Gender", "Age", "IP_Key.CMDStatus"),
#   min_age_inclusive = 0,
#   max_age_inclusive = 99
# )

# experiment_path = "/gpfs/scratch/citrod01/experiments/MATUMAINI/Baseline-campaign_MATUMAINI_202305_decouple-decouple_art_hivinc___2024_04_11_14_52_01_213969/"
# Version 5 of model
#experiment_path = "/gpfs/scratch/citrod01/experiments/MATUMAINI/Baseline-campaign_MATUMAINI_202305_decouple-decouple_art_delay___2024_05_31_15_10_02_993271"

# Version 6 of model
#experiment.path = "/gpfs/scratch/citrod01/experiments/MATUMAINI/manuscript/Baseline-campaign_MATUMAINI_202305_decouple-decouple_art_delay___2024_07_04_13_07_55_906504"
# Version 6 of model, updated delay parameter
experiment.path = "/gpfs/scratch/citrod01/experiments/MATUMAINI/manuscript/Baseline-campaign_MATUMAINI_202305_decouple-decouple_art_delay___2024_08_08_13_50_29_434904"

sim.results.decouple.art.delay <- EMODAnalyzeR::read.simulation.results.bigpurple(
  experiment_path = experiment.path,
  scenario_name = 'decouple.art.delay',
  summarize_columns = c("Population","Infected", "On_ART",
                        "Died", "Died_from_HIV",
                        "Newly.Infected","Diagnosed"),
  stratify_columns = c("Year", "Gender", "Age", "IP_Key.CMDStatus"),
  #stratify_columns = c("Year", "Gender", "IP_Key.CMDStatus"),
  min_age_inclusive = 0,
  max_age_inclusive = 99
)
```


## Decouple, ART, ART Dropout
```{r}

# Version 4 of model
# results_path = "/gpfs/data/bershteynlab/EMOD/citrod01/MATUMAINI/202301_Nyanza_MATUMAINI_MalariaOngoing/sensitivity_analysis/Baseline-campaign_MATUMAINI_202305_decouple-decouple_art_artdrop/ReportHIVByAgeAndGender"
# 
# sim.results.decouple.art.artdrop <- EMODAnalyzeR::read.simulation.results(
#   results_path = results_path,
#   scenario_name = 'decouple.art.artdrop',
#   summarize_columns = c("Population","Infected", "On_ART",
#                         "Died", "Died_from_HIV",
#                         "Newly.Infected","Diagnosed"),
#   #stratify_columns = c("Year", "Gender", "IP_Key.CMDStatus"),
#   stratify_columns = c("Year", "Gender", "Age", "IP_Key.CMDStatus"),
#   min_age_inclusive = 0,
#   max_age_inclusive = 99
# )

#experiment_path = "/gpfs/scratch/citrod01/experiments/MATUMAINI/Baseline-campaign_MATUMAINI_202305_decouple-decouple_art_artdrop___2024_04_11_15_01_19_935604/"
# Version 5 of model
# experiment_path = "/gpfs/scratch/citrod01/experiments/MATUMAINI/Baseline-campaign_MATUMAINI_202305_decouple-decouple_art_artdrop___2024_05_31_15_14_19_276415"

# Version 6 July 2024
experiment.path = "/gpfs/scratch/citrod01/experiments/MATUMAINI/manuscript/Baseline-campaign_MATUMAINI_202305_decouple-decouple_art_artdrop___2024_07_04_13_10_26_490924/"

sim.results.decouple.art.artdrop <- EMODAnalyzeR::read.simulation.results.bigpurple(
  experiment_path = experiment.path,
  scenario_name = 'decouple.art.artdrop',
  summarize_columns = c("Population","Infected", "On_ART",
                        "Died", "Died_from_HIV",
                        "Newly.Infected","Diagnosed"),
  #stratify_columns = c("Year", "Gender", "IP_Key.CMDStatus"),
  stratify_columns = c("Year", "Gender", "Age", "IP_Key.CMDStatus"),
  min_age_inclusive = 0,
  max_age_inclusive = 99
)
```


## Decouple, ART, Reduced ART Adherence
```{r}
# Version 4
# results_path = "/gpfs/data/bershteynlab/EMOD/citrod01/MATUMAINI/202301_Nyanza_MATUMAINI_MalariaOngoing/sensitivity_analysis/Baseline-campaign_MATUMAINI_202305_decouple-decouple_art_artadh_recov/ReportHIVByAgeAndGender"
# 
# sim.results.decouple.art.adh <- EMODAnalyzeR::read.simulation.results(
#   results_path = results_path,
#   scenario_name = 'decouple.art.adh',
#   summarize_columns = c("Population","Infected", "On_ART",
#                         "Died", "Died_from_HIV",
#                         "Newly.Infected","Diagnosed"),
#   #stratify_columns = c("Year", "Gender", "IP_Key.CMDStatus"),
#   stratify_columns = c("Year", "Gender", "Age", "IP_Key.CMDStatus"),
#   min_age_inclusive = 0,
#   max_age_inclusive = 99
# )

# results used for croi
# experiment_path = "/gpfs/scratch/citrod01/experiments/MATUMAINI/Baseline-campaign_MATUMAINI_202305_decouple-decouple_art_artadh___2024_03_19_17_45_09_291000",
# Version 5 May 2024 model
#experiment_path = "/gpfs/scratch/citrod01/experiments/MATUMAINI/Baseline-campaign_MATUMAINI_202305_decouple-decouple_art_artadh_recov___2024_05_31_15_17_04_815603"

# Version 6 July 2024
experiment.path = "/gpfs/scratch/citrod01/experiments/MATUMAINI/manuscript/Baseline-campaign_MATUMAINI_202305_decouple-decouple_art_artadh_recov___2024_07_04_13_12_51_619809/"

sim.results.decouple.art.adh <- EMODAnalyzeR::read.simulation.results.bigpurple(
  experiment_path = experiment.path,
  scenario_name = 'decouple.art.adh',
  summarize_columns = c("Population","Infected", "On_ART",
                        "Died", "Died_from_HIV",
                        "Newly.Infected","Diagnosed"),
  stratify_columns = c("Year", "Gender", "Age", "IP_Key.CMDStatus"),
  #stratify_columns = c("Year", "Gender","IP_Key.CMDStatus"),
  min_age_inclusive = 0,
  max_age_inclusive = 99
)
```

## Decouple, ART, ART Switch upon CMD status change
```{r}
# Version 4
# results_path = "/gpfs/data/bershteynlab/EMOD/citrod01/MATUMAINI/202301_Nyanza_MATUMAINI_MalariaOngoing/sensitivity_analysis/Baseline-campaign_MATUMAINI_202305_decouple-decouple_art_artswitch/ReportHIVByAgeAndGender"
# # experiment_path = "/gpfs/scratch/citrod01/experiments/MATUMAINI/Baseline-campaign_MATUMAINI_202305_decouple-decouple_art_artswitch___2024_05_07_18_43_17_185298"
# sim.results.decouple.art.artswitch <- EMODAnalyzeR::read.simulation.results(
#   results_path = results_path,
#   scenario_name = 'decouple.art.artswitch',
#   summarize_columns = c("Population","Infected", "On_ART",
#                         "Died", "Died_from_HIV",
#                         "Newly.Infected","Diagnosed"),
#   #stratify_columns = c("Year", "Gender", "IP_Key.CMDStatus"),
#   stratify_columns = c("Year", "Gender", "Age", "IP_Key.CMDStatus"),
#   min_age_inclusive = 0,
#   max_age_inclusive = 99
# )

# Version 5
#experiment.path = "/gpfs/scratch/citrod01/experiments/MATUMAINI/Baseline-campaign_MATUMAINI_202305_decouple-decouple_art_artswitch___2024_05_31_15_20_54_758123"

# Version 6 July 2024
experiment.path = "/gpfs/scratch/citrod01/experiments/MATUMAINI/manuscript/Baseline-campaign_MATUMAINI_202305_decouple-decouple_art_artswitch___2024_07_04_13_15_22_665525/"

sim.results.decouple.art.artswitch <- EMODAnalyzeR::read.simulation.results.bigpurple(
  experiment_path = experiment.path,
  scenario_name = 'decouple.art.artswitch',
  summarize_columns = c("Population","Infected", "On_ART",
                        "Died", "Died_from_HIV",
                        "Newly.Infected","Diagnosed"),
  #stratify_columns = c("Year", "Gender", "IP_Key.CMDStatus"),
  stratify_columns = c("Year", "Gender", "Age", "IP_Key.CMDStatus"),
  min_age_inclusive = 0,
  max_age_inclusive = 99
)
```

## Baseline, ART
```{r}
# experiment_path = "/gpfs/scratch/citrod01/experiments/MATUMAINI/Baseline-campaign_MATUMAINI_202305-baseline_art___2024_04_11_14_41_55_316412/"

#experiment.path = "/gpfs/scratch/citrod01/experiments/MATUMAINI/Baseline-campaign_MATUMAINI_202305-baseline_art___2024_05_29_10_58_40_605127"

# Version 6 July 2024
#experiment.path = "/gpfs/scratch/citrod01/experiments/MATUMAINI/manuscript/Baseline-campaign_MATUMAINI_202305-baseline_art___2024_07_04_13_17_52_169973/"
# Version 6, updated delay constant
experiment.path = "/gpfs/scratch/citrod01/experiments/MATUMAINI/manuscript/Baseline-campaign_MATUMAINI_202305-baseline_art___2024_08_13_17_46_27_682239"


sim.results.baseline.art <- EMODAnalyzeR::read.simulation.results.bigpurple(
  experiment_path = experiment.path,
  scenario_name = "baseline.art",
    summarize_columns = c("Population","Infected", "On_ART",
                        "Died", "Died_from_HIV",
                        "Newly.Infected","Diagnosed"),
  stratify_columns = c("Year", "Gender", "Age", "IP_Key.CMDStatus"),
  min_age_inclusive = 0,
  max_age_inclusive = 99
)
# sim.results.baseline.art <- EMODAnalyzeR::read.simulation.results.bigpurple(
#   experiment_path = experiment_path,
#   scenario_name = 'baseline.art',
#   summarize_columns = c("Population","Infected", "On_ART",
#                         "Died", "Died_from_HIV",
#                         "Newly.Infected","Diagnosed"),
#   #stratify_columns = c("Year", "Gender", "Age", "IP_Key.CMDStatus"),
#   stratify_columns = c("Year", "Gender","IP_Key.CMDStatus"),
#   min_age_inclusive = 0,
#   max_age_inclusive = 99
# )

# experiment_path = "/gpfs/scratch/citrod01/experiments/MATUMAINI/Baseline-campaign_MATUMAINI_202305-baseline_art___2024_05_07_18_45_36_283403
# Version 4 post May 2024
# results_path = "/gpfs/data/bershteynlab/EMOD/citrod01/MATUMAINI/202301_Nyanza_MATUMAINI_MalariaOngoing/sensitivity_analysis/Baseline-campaign_MATUMAINI_202305-baseline_art/ReportHIVByAgeAndGender"
# sim.results.baseline.art <- EMODAnalyzeR::read.simulation.results(
#   results_path = results_path,
#   scenario_name = 'baseline.art',
#   summarize_columns = c("Population","Infected", "On_ART",
#                         "Died", "Died_from_HIV",
#                         "Newly.Infected","Diagnosed"),
#   #stratify_columns = c("Year", "Gender", "IP_Key.CMDStatus"),
#   stratify_columns = c("Year", "Gender", "Age", "IP_Key.CMDStatus"),
#   min_age_inclusive = 0,
#   max_age_inclusive = 99
# )

```

## All effects except for increased HIV incidence

```{r}
# Version 4
# results_path = "/gpfs/data/bershteynlab/EMOD/citrod01/MATUMAINI/202301_Nyanza_MATUMAINI_MalariaOngoing/sensitivity_analysis/Baseline-campaign_MATUMAINI_202305-baseline_art_not_hivinc/ReportHIVByAgeAndGender/"
# sim.results.baseline.art.not.hivmc <- EMODAnalyzeR::read.simulation.results(
#   results_path = results_path,
#   scenario_name = 'baseline.art.not.hivmc',
#   summarize_columns = c("Population","Infected", "On_ART",
#                         "Died", "Died_from_HIV",
#                         "Newly.Infected","Diagnosed"),
#   #stratify_columns = c("Year", "Gender", "Age", "IP_Key.CMDStatus"),
#   stratify_columns = c("Year", "Gender", "Age", "IP_Key.CMDStatus"),
#   min_age_inclusive = 0,
#   max_age_inclusive = 99
# )

#experiment_path = "/gpfs/scratch/citrod01/experiments/MATUMAINI/Baseline-campaign_MATUMAINI_202305-baseline_art_not_hivinc___2024_04_18_19_29_24_657884"
# Version 5 of model
#experiment_path = "/gpfs/scratch/citrod01/experiments/MATUMAINI/Baseline-campaign_MATUMAINI_202305-baseline_art_not_hivinc___2024_05_31_15_23_37_536366"

# sim.results.baseline.art.not.hivmc <- EMODAnalyzeR::read.simulation.results.bigpurple(
#   experiment_path = experiment_path,
#   scenario_name = 'baseline.art.not.hivmc',
#   summarize_columns = c("Population","Infected", "On_ART",
#                         "Died", "Died_from_HIV",
#                         "Newly.Infected","Diagnosed"),
#   stratify_columns = c("Year", "Gender", "Age", "IP_Key.CMDStatus"),
#   #stratify_columns = c("Year", "Gender","IP_Key.CMDStatus"),
#   min_age_inclusive = 0,
#   max_age_inclusive = 99
# )
```

## All treatment effects

```{r}
# Version 5 of model
#experiment_path = "/gpfs/scratch/citrod01/experiments/MATUMAINI/Baseline-campaign_MATUMAINI_202305_decouple-decouple_art_tx___2024_06_05_05_04_34_591762/"

# Version 6 July 2024
#experiment.path = "/gpfs/scratch/citrod01/experiments/MATUMAINI/manuscript/Baseline-campaign_MATUMAINI_202305_decouple-decouple_art_tx___2024_07_08_16_12_07_655869"
experiment.path = "/gpfs/scratch/citrod01/experiments/MATUMAINI/manuscript/Baseline-campaign_MATUMAINI_202305_decouple-decouple_art_tx___2024_08_08_13_57_30_505599"

sim.results.decouple.art.tx <- EMODAnalyzeR::read.simulation.results.bigpurple(
  experiment_path = experiment.path,
  scenario_name = 'decouple.art.tx',
  summarize_columns = c("Population","Infected", "On_ART",
                        "Died", "Died_from_HIV",
                        "Newly.Infected","Diagnosed"),
  stratify_columns = c("Year", "Gender", "Age", "IP_Key.CMDStatus"),
  #stratify_columns = c("Year", "Gender","IP_Key.CMDStatus"),
  min_age_inclusive = 0,
  max_age_inclusive = 99
)
```

## All ART adherence effects
```{r}
#experiment_path = "/gpfs/scratch/citrod01/experiments/MATUMAINI/Baseline-campaign_MATUMAINI_202305_decouple-decouple_art_artswitch_artadh___2024_06_05_05_02_23_390019"

# Version 6 July 2024
experiment.path = "/gpfs/scratch/citrod01/experiments/MATUMAINI/manuscript/Baseline-campaign_MATUMAINI_202305_decouple-decouple_art_artswitch_artadh___2024_07_04_13_27_53_559251/"

sim.results.decouple.art.artswitch.artadh <- EMODAnalyzeR::read.simulation.results.bigpurple(
  experiment_path = experiment.path,
  scenario_name = 'decouple.art.artswitch.artadh',
  summarize_columns = c("Population","Infected", "On_ART",
                        "Died", "Died_from_HIV",
                        "Newly.Infected","Diagnosed"),
  stratify_columns = c("Year", "Gender", "Age", "IP_Key.CMDStatus"),
  #stratify_columns = c("Year", "Gender","IP_Key.CMDStatus"),
  min_age_inclusive = 0,
  max_age_inclusive = 99
)
```


## All effects except for elevated CMD incidence

```{r}
# experiment_path = "/gpfs/scratch/citrod01/experiments/MATUMAINI/Baseline-campaign_MATUMAINI_202305_decouple-decouple_art_not_cmdinc___2024_06_05_04_59_42_220845"

# Version 6 July 2024
#experiment.path = "/gpfs/scratch/citrod01/experiments/MATUMAINI/manuscript/Baseline-campaign_MATUMAINI_202305_decouple-decouple_art_not_cmdinc___2024_07_04_13_25_27_489933/"
experiment.path = "/gpfs/scratch/citrod01/experiments/MATUMAINI/manuscript/Baseline-campaign_MATUMAINI_202305_decouple-decouple_art_not_cmdinc___2024_08_08_13_55_09_456687"

sim.results.baseline.art.not.cmdinc <- EMODAnalyzeR::read.simulation.results.bigpurple(
  experiment_path = experiment.path,
  scenario_name = 'baseline.art.not.cmdinc',
  summarize_columns = c("Population","Infected", "On_ART",
                        "Died", "Died_from_HIV",
                        "Newly.Infected","Diagnosed"),
  stratify_columns = c("Year", "Gender", "Age", "IP_Key.CMDStatus"),
  #stratify_columns = c("Year", "Gender","IP_Key.CMDStatus"),
  min_age_inclusive = 0,
  max_age_inclusive = 99
)
```


## Elevated CMD Incidence, ART Adherence
```{r}
# results_path = "/gpfs/data/bershteynlab/EMOD/citrod01/MATUMAINI/202301_Nyanza_MATUMAINI_MalariaOngoing/sensitivity_analysis/Baseline-campaign_MATUMAINI_202305-baseline_art_cmdinc_artadh_recov/ReportHIVByAgeAndGender/"
# sim.results.baseline.art.cmdinc.adh <- EMODAnalyzeR::read.simulation.results(
#   results_path = results_path,
#   scenario_name = 'baseline.art.cmdinc.adh',
#   summarize_columns = c("Population","Infected", "On_ART",
#                         "Died", "Died_from_HIV",
#                         "Newly.Infected","Diagnosed"),
#   #stratify_columns = c("Year", "Gender","IP_Key.CMDStatus"),
#   stratify_columns = c("Year", "Gender", "Age", "IP_Key.CMDStatus"),
#   min_age_inclusive = 0,
#   max_age_inclusive = 99
# )

```


## Baseline, no ART

```{r}
# experiment_path = "/gpfs/scratch/citrod01/experiments/MATUMAINI/Baseline-campaign_MATUMAINI_202305-baseline_noart___2024_04_11_14_44_43_504278/"
# 
# sim.results.baseline.noart <- EMODAnalyzeR::read.simulation.results.bigpurple(
#   experiment_path = experiment_path,
#   scenario_name = 'baseline.noart',
#   summarize_columns = c("Population","Infected", "On_ART",
#                         "Died", "Died_from_HIV",
#                         "Newly.Infected","Diagnosed"),
#   #stratify_columns = c("Year", "Gender", "Age", "IP_Key.CMDStatus"),
#   stratify_columns = c("Year", "Gender","IP_Key.CMDStatus"),
#   min_age_inclusive = 0,
#   max_age_inclusive = 99
# )

# results_path = "/gpfs/data/bershteynlab/EMOD/citrod01/MATUMAINI/202301_Nyanza_MATUMAINI_MalariaOngoing/sensitivity_analysis/Baseline-campaign_MATUMAINI_202305-baseline_noart/ReportHIVByAgeAndGender"

# Version 6 July 2024
#experiment.path = "/gpfs/scratch/citrod01/experiments/MATUMAINI/manuscript/Baseline-campaign_MATUMAINI_202305-baseline_noart___2024_07_04_13_22_57_531426/"
experiment.path = "/gpfs/scratch/citrod01/experiments/MATUMAINI/manuscript/Baseline-campaign_MATUMAINI_202305-baseline_noart___2024_08_13_17_48_58_945893"

sim.results.baseline.noart <- EMODAnalyzeR::read.simulation.results.bigpurple(
  experiment_path = experiment.path,
  scenario_name = 'baseline.noart',
  summarize_columns = c("Population","Infected", "On_ART",
                        "Died", "Died_from_HIV",
                        "Newly.Infected","Diagnosed"),
  #stratify_columns = c("Year", "Gender", "IP_Key.CMDStatus"),
  stratify_columns = c("Year", "Gender", "Age", "IP_Key.CMDStatus"),
  min_age_inclusive = 0,
  max_age_inclusive = 99
)

```

## Decouple, no ART
```{r}
# "/gpfs/scratch/citrod01/experiments/MATUMAINI/Baseline-campaign_MATUMAINI_202305_decouple-decouple_noart___2024_03_15_13_34_32_937184"
# results used for CROI
#   experiment_path = "/gpfs/scratch/citrod01/experiments/MATUMAINI/Baseline-campaign_MATUMAINI_202305_decouple-decouple_noart___2024_04_17_18_53_39_748417",
# Version 5 of model May 2024
#experiment.path = "/gpfs/scratch/citrod01/experiments/MATUMAINI/Baseline-campaign_MATUMAINI_202305_decouple-decouple_noart___2024_05_29_11_00_44_305507/"

# Version 6 July 2024
experiment.path = "/gpfs/scratch/citrod01/experiments/MATUMAINI/manuscript/Baseline-campaign_MATUMAINI_202305_decouple-decouple_noart___2024_07_04_13_20_33_313665/"

sim.results.decouple.noart <- EMODAnalyzeR::read.simulation.results.bigpurple(
  experiment_path = experiment.path,
  scenario_name = 'decouple.noart',
  summarize_columns = c("Population","Infected", "On_ART",
                        "Died", "Died_from_HIV",
                        "Newly.Infected","Diagnosed"),
  #stratify_columns = c("Year", "Gender", "Age", "IP_Key.CMDStatus"),
  stratify_columns = c("Year", "Gender", "Age", "IP_Key.CMDStatus"),
  min_age_inclusive = 0,
  max_age_inclusive = 99
)

# results_path = "/gpfs/data/bershteynlab/EMOD/citrod01/MATUMAINI/202301_Nyanza_MATUMAINI_MalariaOngoing/sensitivity_analysis/Baseline-campaign_MATUMAINI_202305_decouple-decouple_noart/ReportHIVByAgeAndGender/"
# # On scratch
# # "/gpfs/scratch/citrod01/experiments/MATUMAINI/Baseline-campaign_MATUMAINI_202305_decouple-decouple_noart___2024_05_10_13_29_44_883143"
# sim.results.decouple.noart <- EMODAnalyzeR::read.simulation.results(
#   results_path = results_path,
#   scenario_name = "decouple.noart",
#   summarize_columns = c("Population","Infected", "On_ART",
#                         "Died", "Died_from_HIV",
#                         "Newly.Infected","Diagnosed"),
#   #stratify_columns = c("Year", "Gender", "IP_Key.CMDStatus"),
#   stratify_columns = c("Year", "Gender", "Age", "IP_Key.CMDStatus"),
#   min_age_inclusive = 0,
#   max_age_inclusive = 99
# )

```

## Elevated CMD Incidence, No ART
```{r, eval=FALSE}
# experiment_path = "/gpfs/scratch/citrod01/experiments/MATUMAINI/Baseline-campaign_MATUMAINI_202305-baseline_noart_cmdinc___2024_04_11_14_49_48_244240/"

# sim.results.baseline.noart.cmdinc <- EMODAnalyzeR::read.simulation.results.bigpurple(
#   experiment_path = experiment_path,
#   scenario_name = 'baseline.noart.cmdinc',
#   summarize_columns = c("Population","Infected", "On_ART",
#                         "Died", "Died_from_HIV",
#                         "Newly.Infected","Diagnosed"),
#   #stratify_columns = c("Year", "Gender", "Age", "IP_Key.CMDStatus"),
#   stratify_columns = c("Year", "Gender","IP_Key.CMDStatus"),
#   min_age_inclusive = 0,
#   max_age_inclusive = 99
# )
# 
# CENSUS_YEAR = 2009
# KEN_CENSUS_POP = 5352385
# 
# sim.results.pop.scaling <- sim.results.baseline.noart.cmdinc %>% 
#       filter(Year == CENSUS_YEAR) %>%
#       group_by(sim.id) %>%
#       summarize(total.pop = sum(Population), .groups = 'keep') %>% 
#       mutate(pop.scaling.factor = KEN_CENSUS_POP/total.pop)
# 
# sim.results.baseline.noart.cmdinc <- sim.results.baseline.noart.cmdinc %>% 
#   inner_join(
#     sim.results.pop.scaling,
#     by = c("sim.id")
#   )
```

## Decouple, no ART, Increased HIV incidence
```{r}
# experiment_path = "/gpfs/scratch/citrod01/experiments/MATUMAINI/Baseline-campaign_MATUMAINI_202305_decouple-decouple_noart_hivinc___2024_04_11_14_53_59_875226/"
# 
# sim.results.decouple.noart.hivinc <- EMODAnalyzeR::read.simulation.results.bigpurple(
#   experiment_path = experiment_path,
#   scenario_name = 'decouple.noart.hivinc',
#   summarize_columns = c("Population","Infected", "On_ART",
#                         "Died", "Died_from_HIV",
#                         "Newly.Infected","Diagnosed"),
#   #stratify_columns = c("Year", "Gender", "Age", "IP_Key.CMDStatus"),
#   stratify_columns = c("Year", "Gender","IP_Key.CMDStatus"),
#   min_age_inclusive = 0,
#   max_age_inclusive = 99
# )
# 
# CENSUS_YEAR = 2009
# KEN_CENSUS_POP = 5352385
# 
# sim.results.pop.scaling <- sim.results.decouple.noart.hivinc %>% 
#       filter(Year == CENSUS_YEAR) %>%
#       group_by(sim.id) %>%
#       summarize(total.pop = sum(Population), .groups = 'keep') %>% 
#       mutate(pop.scaling.factor = KEN_CENSUS_POP/total.pop)
# 
# sim.results.decouple.noart.hivinc <- sim.results.decouple.noart.hivinc %>% 
#   inner_join(
#     sim.results.pop.scaling,
#     by = c("sim.id")
#   )
```

## Decouple, no ART, Delay to testing
```{r}
# experiment_path = "/gpfs/scratch/citrod01/experiments/MATUMAINI/Baseline-campaign_MATUMAINI_202305_decouple-decouple_noart_delay___2024_04_11_14_59_23_332282/"
# 
# sim.results.decouple.noart.delay <- EMODAnalyzeR::read.simulation.results.bigpurple(
#   experiment_path = experiment_path,
#   scenario_name = 'decouple.noart.delay',
#   summarize_columns = c("Population","Infected", "On_ART",
#                         "Died", "Died_from_HIV",
#                         "Newly.Infected","Diagnosed"),
#   #stratify_columns = c("Year", "Gender", "Age", "IP_Key.CMDStatus"),
#   stratify_columns = c("Year", "Gender","IP_Key.CMDStatus"),  min_age_inclusive = 0,
#   max_age_inclusive = 99
# )
# 
# CENSUS_YEAR = 2009
# KEN_CENSUS_POP = 5352385
# 
# sim.results.pop.scaling <- sim.results.decouple.noart.delay %>% 
#       filter(Year == CENSUS_YEAR) %>%
#       group_by(sim.id) %>%
#       summarize(total.pop = sum(Population), .groups = 'keep') %>% 
#       mutate(pop.scaling.factor = KEN_CENSUS_POP/total.pop)
# 
# sim.results.decouple.noart.delay <- sim.results.decouple.noart.delay %>% 
#   inner_join(
#     sim.results.pop.scaling,
#     by = c("sim.id")
#   )
```


## Minimum/Maximum effect of ART

```{r}
# sim.results.decouple.art.max <- EMODAnalyzeR::read.simulation.results.bigpurple(
#   experiment_path = "/gpfs/scratch/citrod01/experiments/MATUMAINI/Baseline-campaign_MATUMAINI_202305_decouple-decouple_art_max___2024_04_04_10_59_05_565894",
#   scenario_name = 'decouple.art.max',
#   summarize_columns = c("Population","Infected", "On_ART",
#                         "Died", "Died_from_HIV",
#                         "Newly.Infected","Diagnosed"),
#   stratify_columns = c("Year", "Gender", "Age", "IP_Key.CMDStatus"),
#   min_age_inclusive = 0,
#   max_age_inclusive = 99
# )
# 
# CENSUS_YEAR = 2009
# KEN_CENSUS_POP = 5352385
# 
# sim.results.pop.scaling <- sim.results.decouple.art.max %>% 
#       filter(Year == CENSUS_YEAR) %>%
#       group_by(sim.id) %>%
#       summarize(total.pop = sum(Population), .groups = 'keep') %>% 
#       mutate(pop.scaling.factor = KEN_CENSUS_POP/total.pop)
# 
# sim.results.decouple.art.max <- sim.results.decouple.art.max %>% 
#   inner_join(
#     sim.results.pop.scaling,
#     by = c("sim.id")
#   )
```

```{r}
# sim.results.decouple.art.min <- EMODAnalyzeR::read.simulation.results.bigpurple(
#   experiment_path = "/gpfs/scratch/citrod01/experiments/MATUMAINI/Baseline-campaign_MATUMAINI_202305_decouple-decouple_art_min___2024_04_04_11_01_11_057115",
#   scenario_name = 'decouple.art.min',
#   summarize_columns = c("Population","Infected", "On_ART",
#                         "Died", "Died_from_HIV",
#                         "Newly.Infected","Diagnosed"),
#   stratify_columns = c("Year", "Gender", "Age", "IP_Key.CMDStatus"),
#   min_age_inclusive = 0,
#   max_age_inclusive = 99
# )
# 
# CENSUS_YEAR = 2009
# KEN_CENSUS_POP = 5352385
# 
# sim.results.pop.scaling <- sim.results.decouple.art.min %>% 
#       filter(Year == CENSUS_YEAR) %>%
#       group_by(sim.id) %>%
#       summarize(total.pop = sum(Population), .groups = 'keep') %>% 
#       mutate(pop.scaling.factor = KEN_CENSUS_POP/total.pop)
# 
# sim.results.decouple.art.min <- sim.results.decouple.art.min %>% 
#   inner_join(
#     sim.results.pop.scaling,
#     by = c("sim.id")
#   )
```





## Join data together
```{r}
sim.results.all <- rbind(sim.results.decouple.art,
                         sim.results.baseline.art.not.cmdinc,
                         sim.results.decouple.art.hivinc,
                         sim.results.decouple.art.hivtr,
                         sim.results.decouple.art.hivinc.hivtr,
                         sim.results.decouple.art.tx,
                         sim.results.decouple.art.artswitch.artadh,
                         sim.results.decouple.art.delay,
                         sim.results.decouple.art.artdrop,
                         sim.results.baseline.art)
```

## Rescaling

```{r}
CENSUS_YEAR = 2009
KEN_CENSUS_POP = 5352385

sim.results.pop.scaling <- sim.results.all %>% 
      filter(Year == CENSUS_YEAR) %>%
      group_by(sim.ix, scenario_name) %>%
      summarize(total.pop = sum(Population), .groups = 'keep') %>% 
      mutate(pop.scaling.factor = KEN_CENSUS_POP/total.pop)

sim.results.all <- sim.results.all %>% 
  inner_join(
    sim.results.pop.scaling,
    by = c("sim.ix", "scenario_name")
  )
```

# Plot

## Population

```{r, fig.width = 8}
data.pop <- sim.results.all %>% 
  group_by(Year, Gender, sim.id, scenario_name) %>% 
  summarize(Population = sum(Population*pop.scaling.factor), .groups = "keep") %>% 
  # group_by(Year, Gender,scenario_name) %>% 
  # summarize(Population = mean(Population), .groups = "keep") %>% 
  ungroup()

p <- EMODAnalyzeR::emodplot.by_gender(data.pop, 1985, 2025, "Population", title = "Population over Time")

p +
  ylab("HIV Prevalence (%)") + 
  #scale_color_manual(values=c("blue","red","darkgreen","orange","black")) + 
  theme(legend.position = "right")
```

## PLHIV over time

```{r}
plhiv.data <- sim.results.all %>% 
  #filter(Age >= 15, Age < 50) %>% 
  group_by(Year, Gender, scenario_name, sim.id) %>% 
  summarize(PLHIV = sum(Infected*pop.scaling.factor), .groups = 'keep') %>% 
  ungroup() %>% 
  mutate(Gender = case_when(Gender==0 ~ "Male", Gender==1 ~ "Female"))
  
plhiv.data.mean <- plhiv.data %>% 
  group_by(Year, Gender, scenario_name) %>% 
  summarize(PLHIV = mean(PLHIV), .groups = "keep")

p <- ggplot() +
      geom_line(data= plhiv.data.mean %>% filter(Year > 1985),
              aes(x=Year, y=PLHIV, group=scenario_name, color=scenario_name), linewidth=.5) +
    facet_wrap(~ Gender, ncol=2) +
    #xlab("Year")+
    #xlim(c(date.start, date.end)) +
    #ylab("Prevalence") +
    theme_bw(base_size=16) +
    guides(color = guide_legend(ncol = 2, byrow = TRUE, keywidth = 2, keyheight = 1)) +
    theme(legend.position="top", legend.text=element_text(size=10)) +
    scale_x_continuous(breaks = seq(1985,2050,10)) +
    theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
    theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())# +
    #scale_y_continuous(labels = scales::percent_format(accuracy = 1), breaks = seq(0,0.25,0.05), limits=c(0, 0.25)) +
    #ylab("HIV Prevalence (%)") + 
    #scale_color_manual(values=c("blue","red","darkgreen","orange","black","purple")) 

p 

```

## HIV Prevalence over time

```{r}
ingest.file.base = "/gpfs/data/bershteynlab/EMOD/citrod01/MATUMAINI/202301_Nyanza_Baseline_MalariaOngoing_original/Data/calibration_ingest_form_Nyanza.xlsm"

obs.prev.sheet.base <- EMODAnalyzeR::read.ingest.sheet(ingest.file.base, "Obs-Prevalence")

obs.prev.sheet.base
```


```{r, fig.width=8}
#p <- EMODAnalyzeR::emodplot.prevalence(sim.results %>% filter(Age <= 50, Age >=15), 
#                                       1990, 20240)
p <- EMODAnalyzeR::emodplot.prevalence(sim.results.all,# %>% filter(Age <= 50, Age >=15), 
                                       1980, 2040, plot.runs = FALSE)

p +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1), breaks = seq(0,0.25,0.05), limits=c(0, 0.25)) +
    ylab("HIV Prevalence (%)") + 
  #scale_color_manual(values=c("blue","red","darkgreen","orange","black","purple")) +
  geom_point(data = obs.prev.sheet.base %>%
               filter(Province == 'All', AgeBin == "[15:50)", Gender %in% c("Male", "Female")),
             mapping = aes(x = Year, y = Prevalence)) + 
  geom_errorbar(data = obs.prev.sheet.base %>%
             filter(Province == 'All', AgeBin == "[15:50)", Gender %in% c("Male", "Female")),
             mapping = aes(x = Year, ymin = lb, ymax = ub)) + 
  theme(legend.position = "right")


# ggsave(filename = "/gpfs/data/bershteynlab/EMOD/citrod01/MATUMAINI/Analysis/minimal_HIV_prev.pdf",
#        width = 8, height = 6, units = "in")
```

```{r}
croi.prev.data <- sim.results.all %>% 
  filter(Age >= 15, Age < 50) %>% 
  group_by(Year, Gender, scenario_name, sim.id) %>% 
  summarize(Population = sum(Population*pop.scaling.factor), 
            Infected = sum(Infected*pop.scaling.factor), .groups = 'keep') %>% 
  ungroup() %>% 
  mutate(Prevalence = case_when(Population == 0 ~ 0,
                                Population > 0 ~ Infected/Population)) %>% 
  mutate(Gender = case_when(Gender==0 ~ "Male", Gender==1 ~ "Female"))
  
croi.prev.data.mean <- croi.prev.data %>% 
  group_by(Year, Gender, scenario_name) %>% 
  summarize(Prevalence = mean(Prevalence), .groups = "keep")

p <- ggplot() +
      geom_line(data= croi.prev.data.mean %>% filter(Year > 1985),
              aes(x=Year, y=Prevalence, group=scenario_name, color=scenario_name), linewidth=.5) +
    facet_wrap(~ Gender, ncol=2) +
    #xlab("Year")+
    #xlim(c(date.start, date.end)) +
    #ylab("Prevalence") +
    theme_bw(base_size=16) +
    guides(color = guide_legend(ncol = 2, byrow = TRUE, keywidth = 2, keyheight = 1)) +
    theme(legend.position="top", legend.text=element_text(size=10)) +
    scale_x_continuous(breaks = seq(1985,2050,10)) +
    theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
    theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
    scale_y_continuous(labels = scales::percent_format(accuracy = 1), breaks = seq(0,0.25,0.05), limits=c(0, 0.25)) +
    #ylab("HIV Prevalence (%)") + 
    scale_color_manual(values=c("blue","red","darkgreen","orange","black","purple")) +
    geom_point(data = obs.prev.sheet.base %>%
                 filter(Province == 'All', AgeBin == "[15:50)", Gender %in% c("Male", "Female")),
               mapping = aes(x = Year, y = Prevalence) , color = 'black', size = 3, shape = 15) + 
    geom_errorbar(data = obs.prev.sheet.base %>%
               filter(Province == 'All', AgeBin == "[15:50)", Gender %in% c("Male", "Female")),
               mapping = aes(x = Year, ymin = lb, ymax = ub), color = 'black', size = 1)

p 

```
## Number on ART over time

```{r}
ingest.file.base = "/gpfs/data/bershteynlab/EMOD/citrod01/MATUMAINI/202301_Nyanza_Baseline_MalariaOngoing_original/Data/calibration_ingest_form_Nyanza.xlsm"

obs.onart.sheet <- EMODAnalyzeR::read.ingest.sheet(ingest.file.base, "Obs-OnART")
```




```{r, fig.width=8}
sim.onart <- sim.results.all %>% 
  dplyr::group_by(Year, Gender, sim.id, scenario_name) %>% 
  dplyr::summarize(On_ART = sum(On_ART * pop.scaling.factor), .groups = "keep") %>% 
  ungroup() %>% 
  mutate(Gender = case_when(Gender==0 ~ "Male", Gender==1 ~ "Female"))

sim.onart.mean <- sim.onart %>% 
  group_by(Year, Gender, scenario_name) %>% 
  summarize(On_ART = mean(On_ART), .groups = "keep")

p <- ggplot() +
      geom_line(data= sim.onart.mean %>% filter(Year > 1985),
              aes(x=Year, y=On_ART, group=scenario_name, color=scenario_name), linewidth=.75) +
    facet_wrap(~ Gender, ncol=2) +
    #xlab("Year")+
    #xlim(c(date.start, date.end)) +
    #ylab("Prevalence") +
    theme_bw(base_size=16) +
    guides(color = guide_legend(ncol = 2, byrow = TRUE, keywidth = 2, keyheight = 1)) +
    theme(legend.position="top", legend.text=element_text(size=10)) +
    scale_x_continuous(breaks = seq(1985,2050,10)) +
    theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
    theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
    #scale_y_continuous(labels = scales::percent_format(accuracy = 1), breaks = seq(0,0.25,0.05), limits=c(0, 0.25)) +
    #ylab("HIV Prevalence (%)") + 
    scale_color_manual(values=c("blue","red","darkgreen","orange","black","purple"))
p 
```


## Number of New HIV cases

```{r}
sim.cases <- sim.results.all %>% 
  dplyr::group_by(Year, Gender, sim.id, scenario_name) %>% 
  dplyr::summarize(Newly.Infected = sum(Newly.Infected * pop.scaling.factor), .groups = "keep") %>% 
  ungroup() %>% 
  mutate(Gender = case_when(Gender==0 ~ "Male", Gender==1 ~ "Female"))

sim.cases.mean <- sim.cases %>% 
  group_by(Year, Gender, scenario_name) %>% 
  summarize(Newly.Infected = mean(Newly.Infected), .groups = "keep")

p <- ggplot() +
      geom_line(data= sim.cases.mean %>% filter(Year > 1985),
              aes(x=Year, y= Newly.Infected, group=scenario_name, color=scenario_name), linewidth=.5) +
    facet_wrap(~ Gender, ncol=2) +
    #xlab("Year")+
    #xlim(c(date.start, date.end)) +
    #ylab("Prevalence") +
    theme_bw(base_size=16) +
    guides(color = guide_legend(ncol = 2, byrow = TRUE, keywidth = 2, keyheight = 1)) +
    theme(legend.position="top", legend.text=element_text(size=10)) +
    scale_x_continuous(breaks = seq(1985,2050,10)) +
    theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
    theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
    #scale_y_continuous(labels = scales::percent_format(accuracy = 1), breaks = seq(0,0.25,0.05), limits=c(0, 0.25)) +
    #ylab("HIV Prevalence (%)") + 
    scale_color_manual(values=c("blue","red","darkgreen","orange","black","purple", "pink"))

p
```

```{r}
sim.cases.mean
```


## Number of HIV-related Deaths

```{r, fig.width=8}
sim.deaths <- sim.results.all %>% 
  dplyr::group_by(Year, Gender, sim.id, scenario_name) %>% 
  dplyr::summarize(Died_from_HIV = sum(Died_from_HIV * pop.scaling.factor), .groups = "keep") %>% 
  ungroup() %>% 
  mutate(Gender = case_when(Gender==0 ~ "Male", Gender==1 ~ "Female"))

sim.deaths.mean <- sim.deaths %>% 
  group_by(Year, Gender, scenario_name) %>% 
  summarize(Died_from_HIV = mean(Died_from_HIV), .groups = "keep")

p <- ggplot() +
      geom_line(data= sim.deaths.mean %>% filter(Year > 1985),
              aes(x=Year, y= Died_from_HIV, group=scenario_name, color=scenario_name), linewidth=.5) +
    facet_wrap(~ Gender, ncol=2) +
    #xlab("Year")+
    #xlim(c(date.start, date.end)) +
    #ylab("Prevalence") +
    theme_bw(base_size=16) +
    guides(color = guide_legend(ncol = 2, byrow = TRUE, keywidth = 2, keyheight = 1)) +
    theme(legend.position="top", legend.text=element_text(size=10)) +
    scale_x_continuous(breaks = seq(1985,2050,10)) +
    theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
    theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
    #scale_y_continuous(labels = scales::percent_format(accuracy = 1), breaks = seq(0,0.25,0.05), limits=c(0, 0.25)) +
    #ylab("HIV Prevalence (%)") + 
    scale_color_manual(values=c("blue","red","darkgreen","orange","black","purple", "pink"))

p
```

```{r}
sim.deaths.mean
```

## Depression Prevalence

### Depression Prevalence

```{r}
data.cmd <- sim.results.all %>% filter(Age > 18) %>% 
  mutate(HIVneg = Population - Infected) %>% 
  group_by(Year, Gender, sim.id, IP_Key.CMDStatus, scenario_name) %>% 
  summarize(Population = sum(Population),
            HIVneg = sum(HIVneg),
            Infected = sum(Infected), .groups = 'keep') %>% 
  ungroup() %>% 
  pivot_wider(id_cols = c(Year, Gender, sim.id, scenario_name),
              names_from = c(IP_Key.CMDStatus),
              values_from = c(Population, HIVneg, Infected))  %>% 
  mutate(Population_total = Population_CMD_pos + Population_CMD_neg + Population_CMD_recovered + Population_CMD_treated,
         HIVneg_total = HIVneg_CMD_pos + HIVneg_CMD_neg + HIVneg_CMD_recovered + HIVneg_CMD_treated,
         Infected_total = Infected_CMD_pos + Infected_CMD_neg + Infected_CMD_recovered + Infected_CMD_treated) %>% 
  mutate(CMD_prev_overall = case_when(Population_total == 0 ~ 0,
                                    Population_total > 0 ~ Population_CMD_pos/Population_total),
         CMD_prev_HIVneg = case_when(HIVneg_total == 0 ~ 0,
                                    HIVneg_total > 0 ~ HIVneg_CMD_pos/HIVneg_total),
         CMD_prev_Infected = case_when(Infected_total == 0 ~ 0,
                                    Infected_total > 0 ~ Infected_CMD_pos/Infected_total)) %>% 
  mutate(Gender = case_when(Gender==0 ~ "Male", Gender==1 ~ "Female"))

data.cmd.mean <- data.cmd %>% 
  group_by(Year, Gender, scenario_name) %>%
  summarize(Overall = mean(CMD_prev_overall), Overall_sd = sd(CMD_prev_overall),
            HIVneg = mean(CMD_prev_HIVneg), HIVneg_sd = sd(CMD_prev_HIVneg),
            Infected = mean(CMD_prev_Infected), Infected_sd = sd(CMD_prev_Infected),
            .groups = "keep") %>% 
  ungroup()

# Plot  
p = ggplot() +
  geom_line( data = data.cmd.mean %>% 
                    select(Year, Gender, Overall, Infected, HIVneg, scenario_name) %>% 
                    pivot_longer(cols = c(Overall, Infected, HIVneg),
                                 names_to = "Depression.Prevalence", 
                                 values_to = "CMD_prev"),
    mapping = aes(x = Year, y = CMD_prev, color = Depression.Prevalence), 
    size = 1.0) + 
  scale_y_continuous(limits = c(0.05,.22)) + 
  facet_wrap(Gender ~ scenario_name, nrow = 2) +
  xlab("Year")+ylab("") + 
  ggtitle("Depression Prevalence by HIV status") + 
  theme_bw(base_size=16) +
  guides(fill = guide_legend(keywidth = 2, keyheight = 1)) +
  scale_x_continuous(breaks = seq(1980,2040,10)) +
  theme(legend.position="bottom") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  theme(strip.background = element_rect(colour="black", fill="white")) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())

p
```


### Number of people living with Depression

```{r}
data.cmdpos.pop <- sim.results.all %>% 
  group_by(Year, Gender, sim.id, scenario_name) %>% 
  filter(IP_Key.CMDStatus == "CMD_pos") %>% 
  summarize(Population = sum(Population*pop.scaling.factor), .groups = "keep") %>% 
  # group_by(Year, Gender,scenario_name) %>% 
  # summarize(Population = mean(Population), .groups = "keep") %>% 
  ungroup()

data.cmdpos.pop %>% 
  group_by(Year, Gender, scenario_name) %>% 
  summarize(Population = mean(Population))
```


# Analysis of Metrics

```{r}
test.comparison <- sim.results.all %>%
 group_by(Year, Gender, scenario_name, sim.ix) %>% 
  summarize(Population = sum(Population), 
            Infected = sum(Infected ),
            Died = sum(Died  ),
            Died_from_HIV = sum(Died_from_HIV  ),
            Newly.Infected = sum(Newly.Infected )) %>% ungroup()

test.comp.mean <- test.comparison %>% 
  group_by(Year, Gender, scenario_name) %>% 
  summarize(Population = mean(Population), 
            Infected = mean(Infected),
            Died = mean(Died),
            Died_from_HIV = mean(Died_from_HIV),
            Newly.Infected = mean(Newly.Infected)) %>% ungroup()
```

## Check aggregated mean:

### 1980-1990 (pre=art)
```{r}
test.comp.mean %>% arrange(Year, Gender, scenario_name) %>% 
  filter(Year >= 1980, Year < 1990) %>% 
  group_by(Gender, scenario_name) %>% 
  summarize(Infected = sum(Infected),
           Died_from_HIV = sum(Died_from_HIV),
           Newly.Infected = sum(Newly.Infected)) 

```

### 1990-2000 (pre-art)
```{r}
test.comp.mean %>% arrange(Year, Gender, scenario_name) %>% 
  filter(Year >= 1990, Year < 2000) %>% 
  group_by(Gender, scenario_name) %>% 
  summarize(Infected = sum(Infected),
           Died_from_HIV = sum(Died_from_HIV),
           Newly.Infected = sum(Newly.Infected))
```

### 2000-2020 (ART)
```{r}
test.comp.mean %>% arrange(Year, Gender, scenario_name) %>% 
  filter(Year >= 2000, Year < 2020) %>% 
  group_by(Gender, scenario_name) %>% 
  summarize(Infected = sum(Infected),
           Died_from_HIV = sum(Died_from_HIV),
           Newly.Infected = sum(Newly.Infected))
```
## Calculate totals with error bars

```{r}
start_year = 1980
end_year = 2021
nruns = 250
```

```{r}
sim.results.all.agg <- sim.results.all %>% 
  filter(Year >= start_year, Year < end_year)  %>% 
  group_by(Gender, scenario_name, sim.ix) %>% 
  summarize(Newly.Infected = sum(Newly.Infected * pop.scaling.factor), 
            Died_from_HIV = sum(Died_from_HIV * pop.scaling.factor),
            Depression.eps = sum(Population/2 * pop.scaling.factor),
            .groups = 'keep') %>%
  ungroup() 

sim.results.all.agg.numbers <- sim.results.all.agg %>% 
  group_by(Gender, scenario_name) %>% 
  summarize(
    Newly.Infected.sd = sd(Newly.Infected),
    Newly.Infected = mean(Newly.Infected), 
    Died_from_HIV.sd = sd(Died_from_HIV),
    Died_from_HIV = mean(Died_from_HIV),
    Depression.eps.sd = sd(Depression.eps),
    Depression.eps = mean(Depression.eps), .groups = "keep") %>% 
  ungroup() %>% 
  mutate(
    Newly.Infected_95LL = lower_ci(Newly.Infected, Newly.Infected.sd/sqrt(nruns), nruns, conf_level = .95),
    Newly.Infected_95UL = upper_ci(Newly.Infected, Newly.Infected.sd/sqrt(nruns), nruns, conf_level = .95),
    Died_from_HIV_95LL = lower_ci(Died_from_HIV, Died_from_HIV.sd/sqrt(nruns), nruns, conf_level = .95),
    Died_from_HIV_95UL = upper_ci(Died_from_HIV, Died_from_HIV.sd/sqrt(nruns), nruns, conf_level = .95),
    Depression.eps_95LL = lower_ci(Depression.eps, Depression.eps.sd/sqrt(nruns), nruns, conf_level = .95),
    Depression.eps_95UL = upper_ci(Depression.eps, Depression.eps.sd/sqrt(nruns), nruns, conf_level = .95)
  ) %>% 
  select(
    "Gender", "scenario_name",
    "Newly.Infected", "Newly.Infected.sd", "Newly.Infected_95LL","Newly.Infected_95UL",
    "Died_from_HIV", "Died_from_HIV.sd", "Died_from_HIV_95LL", "Died_from_HIV_95UL",
    "Depression.eps", "Depression.eps.sd", "Depression.eps_95LL", "Depression.eps_95UL"
  ) %>% 
  mutate(Gender = case_when(Gender==0 ~ "Male", Gender==1 ~ "Female"))

sim.results.all.agg.numbers

```

```{r}
ggplot(data = sim.results.all.agg.numbers) + 
  geom_point(mapping = aes(x = scenario_name, y = Newly.Infected, color = Gender)) + 
  geom_errorbar(aes(x=scenario_name, ymin = Newly.Infected_95LL, ymax = Newly.Infected_95UL)) + 
  facet_wrap(~ Gender, ncol=2) + 
  scale_color_manual(values = c("red", "blue"))  + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) 
```

```{r}
ggplot(data = sim.results.all.agg.numbers) + 
  geom_point(mapping = aes(x = scenario_name, y = Died_from_HIV, color = Gender)) + 
  geom_errorbar(aes(x=scenario_name, ymin = Died_from_HIV_95LL, ymax = Died_from_HIV_95UL)) + 
  facet_wrap(~ Gender, ncol=2) + 
  scale_color_manual(values = c("red", "blue"))  + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) 
```

## Calculate differences
```{r}
sim.results.all.agg.differences = sim.results.all.agg %>% 
  filter(scenario_name == "decouple.art") %>% 
  select(Gender, sim.ix, 
         Newly.Infected.Decouple = Newly.Infected,
         Died_from_HIV.Decouple = Died_from_HIV,
         Depression.eps.Decouple = Depression.eps
         ) %>%
  merge(sim.results.all.agg,
        by = c("Gender", "sim.ix")) %>%
  mutate(
    Newly.Infected.diff = Newly.Infected - Newly.Infected.Decouple,
    Newly.Infected.pct = (Newly.Infected - Newly.Infected.Decouple)/Newly.Infected.Decouple,
    Died_from_HIV.diff = Died_from_HIV - Died_from_HIV.Decouple,
    Died_from_HIV.pct = (Died_from_HIV - Died_from_HIV.Decouple)/Died_from_HIV.Decouple,
    Depression.eps.diff = Depression.eps - Depression.eps.Decouple,
    Depression.eps.pct = (Depression.eps - Depression.eps.Decouple)/Depression.eps.Decouple,
) %>% 
  group_by(Gender, scenario_name) %>% 
  summarize(Newly.Infected.diff.sd = sd(Newly.Infected.diff),
            Newly.Infected.diff = mean(Newly.Infected.diff),
            Newly.Infected.pct.sd = sd(Newly.Infected.pct),
            Newly.Infected.pct = mean(Newly.Infected.pct),
            Died_from_HIV.diff.sd = sd(Died_from_HIV.diff),
            Died_from_HIV.diff = mean(Died_from_HIV.diff),
            Died_from_HIV.pct.sd = sd(Died_from_HIV.pct),
            Died_from_HIV.pct = mean(Died_from_HIV.pct),
            Depression.eps.diff.sd = sd(Depression.eps.diff),
            Depression.eps.diff = mean(Depression.eps.diff),
            Depression.eps.pct.sd = sd(Depression.eps.pct),
            Depression.eps.pct = mean(Depression.eps.pct), .groups = 'keep'
            ) %>% 
  ungroup() %>% 
  mutate(
    Newly.Infected.diff_95LL = lower_ci(Newly.Infected.diff, Newly.Infected.diff.sd/sqrt(nruns), nruns, conf_level = .95),
    Newly.Infected.diff_95UL = upper_ci(Newly.Infected.diff, Newly.Infected.diff.sd/sqrt(nruns), nruns, conf_level = .95),
    Newly.Infected.pct_95LL = lower_ci(Newly.Infected.pct, Newly.Infected.pct.sd/sqrt(nruns), nruns, conf_level = .95),
    Newly.Infected.pct_95UL = upper_ci(Newly.Infected.pct, Newly.Infected.pct.sd/sqrt(nruns), nruns, conf_level = .95),
    Died_from_HIV.diff_95LL = lower_ci(Died_from_HIV.diff, Died_from_HIV.diff.sd/sqrt(nruns), nruns, conf_level = .95),
    Died_from_HIV.diff_95UL = upper_ci(Died_from_HIV.diff, Died_from_HIV.diff.sd/sqrt(nruns), nruns, conf_level = .95),
    Died_from_HIV.pct_95LL = lower_ci(Died_from_HIV.pct, Died_from_HIV.pct.sd/sqrt(nruns), nruns, conf_level = .95),
    Died_from_HIV.pct_95UL = upper_ci(Died_from_HIV.pct, Died_from_HIV.pct.sd/sqrt(nruns), nruns, conf_level = .95),
    Depression.eps.diff_95LL = lower_ci(Depression.eps.diff, Depression.eps.diff.sd/sqrt(nruns), nruns, conf_level = .95),
    Depression.eps.diff_95UL = upper_ci(Depression.eps.diff, Depression.eps.diff.sd/sqrt(nruns), nruns, conf_level = .95),
    Depression.eps.pct_95LL = lower_ci(Depression.eps.pct, Depression.eps.pct.sd/sqrt(nruns), nruns, conf_level = .95),
    Depression.eps.pct_95UL = upper_ci(Depression.eps.pct, Depression.eps.pct.sd/sqrt(nruns), nruns, conf_level = .95) 
  )  %>% 
  mutate(Gender = case_when(Gender==0 ~ "Male", Gender==1 ~ "Female")) %>% 
  select(
    "Gender", "scenario_name",
    "Newly.Infected.diff", "Newly.Infected.diff.sd", "Newly.Infected.diff_95LL","Newly.Infected.diff_95UL",
    "Newly.Infected.pct" ,"Newly.Infected.pct.sd" , "Newly.Infected.pct_95LL",  "Newly.Infected.pct_95UL",
    "Died_from_HIV.diff", "Died_from_HIV.diff.sd", "Died_from_HIV.diff_95LL", "Died_from_HIV.diff_95UL",
    "Died_from_HIV.pct", "Died_from_HIV.pct.sd", "Died_from_HIV.pct_95LL", "Died_from_HIV.pct_95UL",
    "Depression.eps.diff", "Depression.eps.diff.sd", "Depression.eps.diff_95LL", "Depression.eps.diff_95UL",
    "Depression.eps.pct", "Depression.eps.pct.sd", "Depression.eps.pct_95LL", "Depression.eps.pct_95UL"
  )

sim.results.all.agg.differences
```


```{r}
ggplot(data = sim.results.all.agg.differences) + 
  geom_point(mapping = aes(x = scenario_name, y = Newly.Infected.diff, color = Gender)) + 
  geom_errorbar(aes(x=scenario_name, ymin = Newly.Infected.diff_95LL, ymax = Newly.Infected.diff_95UL)) + 
  facet_wrap(~ Gender, ncol=2) + 
  scale_color_manual(values = c("red", "blue"))  + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) 
```

```{r}
ggplot(data = sim.results.all.agg.differences) + 
  geom_point(mapping = aes(x = scenario_name, y = Newly.Infected.pct, color = Gender)) + 
  geom_errorbar(aes(x=scenario_name, ymin = Newly.Infected.pct_95LL, ymax = Newly.Infected.pct_95UL)) + 
  geom_text(mapping = aes(x = scenario_name, y = Newly.Infected.pct + .015, label=round(Newly.Infected.pct,3)), color = 'black') + 
  facet_wrap(~ Gender, ncol=2) + 
  scale_color_manual(values = c("red", "blue"))  + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) 

ggsave("hiv_infs_pct_change_above_decoupled.pdf", width = 8, height = 6, units = 'in')
```

```{r}
ggplot(data = sim.results.all.agg.differences) + 
  geom_point(mapping = aes(x = scenario_name, y = Died_from_HIV.diff, color = Gender)) + 
  geom_errorbar(aes(x=scenario_name, ymin = Died_from_HIV.diff_95LL, ymax = Died_from_HIV.diff_95UL)) + 
  facet_wrap(~ Gender, ncol=2) + 
  scale_color_manual(values = c("red", "blue"))  + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) 
```

```{r}
ggplot(data = sim.results.all.agg.differences) + 
  geom_point(mapping = aes(x = scenario_name, y = Died_from_HIV.pct, color = Gender)) + 
  geom_errorbar(aes(x=scenario_name, ymin = Died_from_HIV.pct_95LL, ymax = Died_from_HIV.pct_95UL)) + 
  geom_text(mapping = aes(x = scenario_name, y = Died_from_HIV.pct + .015, label=round(Newly.Infected.pct,3)), color = 'black') + 
  facet_wrap(~ Gender, ncol=2) + 
  scale_color_manual(values = c("red", "blue"))  + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) 

ggsave("hiv_deaths_pct_change_above_decoupled.pdf", width = 8, height = 6, units = 'in')
```
# Metrics

Count the number of cases, deaths, depression episodes for each of the following:

1. All effects: baseline.art
2. Elevated depression incidence for PLHIV: baseline.art.cmd
3. Elevated HIV incidence for people with depression: decouple.art.hivmc
4. Delays to testing decouple.art.delay
5. ART dropout: decouple.art.dropout
6. ART adherence: decouple.art.adh.recov
7. All effects turned off: decouple.art


## Define some functions

The challenge here is that the bootstrapping method only allows stratifying across one column. For the sake of bootstrapping itself, the most important column is scenario_name, but we also will need to stratify by gender at times.

What I am going to do is create a function which simply stratifies by scenario name. I will aggregate and split out the data set by gender when needed.

Just kidding, I can't do that, I'm just going to need to write a function that subsets the part of sim.results.all and calculates the error bars accordingly. Don't bother stratifying.

### Function for calculating number counts

```{r}
bt_mean <- function(splits, colname){
  x <- as.data.frame(analysis(splits))
  mean(x[[colname]])
}

aggregate.data <- function(data, scenario.name, start_year, end_year, age_min, age_max){
  
  data.agg <- data %>% 
    filter(scenario_name == scenario.name) %>% 
    filter(Year >= start_year, 
           Year < end_year,
           Age >= age_min,
           Age < age_max)  %>% 
    group_by(scenario_name, sim.ix) %>% 
    summarize(Newly.Infected = sum(Newly.Infected * pop.scaling.factor), 
            Died_from_HIV = sum(Died_from_HIV * pop.scaling.factor),
            .groups = 'keep') %>%
    ungroup() %>% merge(
        data %>% 
          filter(scenario_name == scenario.name) %>% 
          filter(Year >= start_year, 
                 Year < end_year,
                 Age >= age_min,
                 Age < age_max)  %>% 
          filter(IP_Key.CMDStatus == "CMD_pos") %>% 
            group_by(scenario_name, sim.ix) %>% 
            summarize( Depression.eps = sum(Population/2* pop.scaling.factor),
                    .groups = 'keep') %>%
            ungroup(), 
        by = c("scenario_name", "sim.ix")
    )
  
  data.agg.numbers <- data.agg %>%
    filter(scenario_name == scenario.name)  %>% 
    group_by(scenario_name) %>%
    summarize(
      Newly.Infected.sd = sd(Newly.Infected),
      Newly.Infected = mean(Newly.Infected),
      Died_from_HIV.sd = sd(Died_from_HIV),
      Died_from_HIV = mean(Died_from_HIV),
      Depression.eps.sd = sd(Depression.eps),
      Depression.eps = mean(Depression.eps), .groups = "keep") %>%
    ungroup()
  
  bt_resamples <- bootstraps(data.agg, times = 500)
  bt_resamples$mean.infected <- map_dbl(bt_resamples$splits, bt_mean, "Newly.Infected")
  bt_resamples$mean.deaths <- map_dbl(bt_resamples$splits, bt_mean, "Died_from_HIV")
  bt_resamples$mean.eps <- map_dbl(bt_resamples$splits, bt_mean, "Depression.eps")
  
  infected_95 <- quantile(bt_resamples$mean.infected, probs = c(.025, .975))
  deaths_95 <- quantile(bt_resamples$mean.deaths, probs = c(.025, .975))
  eps_95 <- quantile(bt_resamples$mean.eps, probs = c(.025, .975))
  
  data.agg.numbers$Newly.Infected_95LL <- infected_95[[1]]
  data.agg.numbers$Newly.Infected_95UL <- infected_95[[2]]
  data.agg.numbers$Died_from_HIV_95LL <- deaths_95[[1]]
  data.agg.numbers$Died_from_HIV_95UL <- deaths_95[[2]]
  data.agg.numbers$Depression.eps_95LL <- eps_95[[1]]
  data.agg.numbers$Depression.eps_95UL <- eps_95[[2]]
  
  data.agg.numbers <- data.agg.numbers %>% select(
        "scenario_name",
        "Newly.Infected", "Newly.Infected_95LL","Newly.Infected_95UL", "Newly.Infected.sd",
        "Died_from_HIV", "Died_from_HIV_95LL", "Died_from_HIV_95UL", "Died_from_HIV.sd",
        "Depression.eps", "Depression.eps_95LL", "Depression.eps_95UL", "Depression.eps.sd"
      )
  
  data.agg.numbers
}

```

### Function for calculating differences between scenarios

```{r}
aggregate.data.differences <- function(data, scenario.name, start_year, end_year, age_min, age_max,
                                       comparison_scenario = "decouple.art"){
  
  data.agg <- data %>% 
    filter(Year >= start_year, 
           Year < end_year,
           Age >= age_min,
           Age < age_max)  %>% 
    group_by(scenario_name, sim.ix) %>% 
    summarize(Newly.Infected = sum(Newly.Infected * pop.scaling.factor), 
            Died_from_HIV = sum(Died_from_HIV * pop.scaling.factor),
            .groups = 'keep') %>%
    ungroup() %>% merge( 
      # Here is where we calculate depression episodes
        data %>% 
          filter(Year >= start_year, 
                 Year < end_year,
                 Age >= age_min,
                 Age < age_max)  %>% 
          filter(IP_Key.CMDStatus == "CMD_pos") %>% 
            group_by(scenario_name, sim.ix) %>% 
            summarize( Depression.eps = sum(Population/2* pop.scaling.factor),
                    .groups = 'keep') %>%
            ungroup() %>% 
          select(scenario_name, sim.ix, Depression.eps), 
        by = c("scenario_name", "sim.ix")
    )
  
  data.agg.2 <- data.agg %>% filter(scenario_name == comparison_scenario) %>% 
    select(sim.ix, 
         Newly.Infected.Decouple = Newly.Infected,
         Died_from_HIV.Decouple = Died_from_HIV,
         Depression.eps.Decouple = Depression.eps
         ) %>% 
    merge(data.agg %>% filter(scenario_name == scenario.name),
          by = c("sim.ix")) %>%
    mutate(
      Newly.Infected.diff = Newly.Infected - Newly.Infected.Decouple,
      Newly.Infected.pct = (Newly.Infected - Newly.Infected.Decouple)/Newly.Infected.Decouple,
      Died_from_HIV.diff = Died_from_HIV - Died_from_HIV.Decouple,
      Died_from_HIV.pct = (Died_from_HIV - Died_from_HIV.Decouple)/Died_from_HIV.Decouple,
      Depression.eps.diff = Depression.eps - Depression.eps.Decouple,
      Depression.eps.pct = (Depression.eps - Depression.eps.Decouple)/Depression.eps.Decouple,
    ) 
  
  data.agg.diffs <- data.agg.2 %>%
    group_by(scenario_name) %>%
    summarize(Newly.Infected.diff.sd = sd(Newly.Infected.diff),
              Newly.Infected.diff = mean(Newly.Infected.diff),
              Newly.Infected.pct.sd = sd(Newly.Infected.pct),
              Newly.Infected.pct = mean(Newly.Infected.pct),
              Died_from_HIV.diff.sd = sd(Died_from_HIV.diff),
              Died_from_HIV.diff = mean(Died_from_HIV.diff),
              Died_from_HIV.pct.sd = sd(Died_from_HIV.pct),
              Died_from_HIV.pct = mean(Died_from_HIV.pct),
              Depression.eps.diff.sd = sd(Depression.eps.diff),
              Depression.eps.diff = mean(Depression.eps.diff),
              Depression.eps.pct.sd = sd(Depression.eps.pct),
              Depression.eps.pct = mean(Depression.eps.pct), .groups = 'keep'
              )

  bt_resamples <- bootstraps(data.agg.2, times = 500)
  bt_resamples$mean.infected.diff <- map_dbl(bt_resamples$splits, bt_mean, "Newly.Infected.diff")
  bt_resamples$mean.infected.pct <- map_dbl(bt_resamples$splits, bt_mean, "Newly.Infected.pct")
  bt_resamples$mean.deaths.diff <- map_dbl(bt_resamples$splits, bt_mean, "Died_from_HIV.diff")
  bt_resamples$mean.deaths.pct <- map_dbl(bt_resamples$splits, bt_mean, "Died_from_HIV.pct")
  bt_resamples$mean.eps.diff <- map_dbl(bt_resamples$splits, bt_mean, "Depression.eps.diff")
  bt_resamples$mean.eps.pct <- map_dbl(bt_resamples$splits, bt_mean, "Depression.eps.pct")
  
  infected.diff_95 <- quantile(bt_resamples$mean.infected.diff, probs = c(.025, .975))
  infected.pct_95 <- quantile(bt_resamples$mean.infected.pct, probs = c(.025, .975))
  deaths.diff_95 <- quantile(bt_resamples$mean.deaths.diff, probs = c(.025, .975))
  deaths.pct_95 <- quantile(bt_resamples$mean.deaths.pct, probs = c(.025, .975))
  eps.diff_95 <- quantile(bt_resamples$mean.eps.diff, probs = c(.025, .975))
  eps.pct_95 <- quantile(bt_resamples$mean.eps.pct, probs = c(.025, .975))
  
  data.agg.diffs$Newly.Infected.diff_95LL <- infected.diff_95[[1]]
  data.agg.diffs$Newly.Infected.diff_95UL <- infected.diff_95[[2]]
  data.agg.diffs$Newly.Infected.pct_95LL <- infected.pct_95[[1]]
  data.agg.diffs$Newly.Infected.pct_95UL <- infected.pct_95[[2]]
  data.agg.diffs$Died_from_HIV.diff_95LL <- deaths.diff_95[[1]]
  data.agg.diffs$Died_from_HIV.diff_95UL <- deaths.diff_95[[2]]
  data.agg.diffs$Died_from_HIV.pct_95LL <- deaths.pct_95[[1]]
  data.agg.diffs$Died_from_HIV.pct_95UL <- deaths.pct_95[[2]]
  data.agg.diffs$Depression.eps.diff_95LL <- eps.diff_95[[1]]
  data.agg.diffs$Depression.eps.diff_95UL <- eps.diff_95[[2]]
  data.agg.diffs$Depression.eps.pct_95LL <- eps.pct_95[[1]]
  data.agg.diffs$Depression.eps.pct_95UL <- eps.pct_95[[2]]
  
  data.agg.diffs <- data.agg.diffs %>% select(
        "scenario_name",
        "Newly.Infected.diff", "Newly.Infected.diff.sd", "Newly.Infected.diff_95LL","Newly.Infected.diff_95UL",
        "Newly.Infected.pct", "Newly.Infected.pct.sd", "Newly.Infected.pct_95LL","Newly.Infected.pct_95UL",
        "Died_from_HIV.diff", "Died_from_HIV.diff.sd", "Died_from_HIV.diff_95LL", "Died_from_HIV.diff_95UL",
        "Died_from_HIV.pct", "Died_from_HIV.pct.sd", "Died_from_HIV.pct_95LL", "Died_from_HIV.pct_95UL",
        "Depression.eps.diff", "Depression.eps.diff.sd", "Depression.eps.diff_95LL", "Depression.eps.diff_95UL",
        "Depression.eps.pct", "Depression.eps.pct.sd", "Depression.eps.pct_95LL", "Depression.eps.pct_95UL"
      )

  data.agg.diffs
  
}

```

```{r}
data.agg.diffs <- aggregate.data.differences(sim.results.all,
                                             scenario.name = 'baseline.art',
                                             1985, 2035, 15,100)

data.agg.diffs

```
Check against numbers table:

```{r}
numbers.table %>% filter(scenario_name %in% c("baseline.art", "decouple.art"),
                         Ages == "15-100", Years == "1985-2035")

c(1240952- 1092231, 666422.5 - 584969.2, 12705881 - 11739158)
```


## Calculate Numbers
```{r}
aggregate.data(sim.results.all, 
               "baseline.art",
               1980, 2021, 0, 100)
```
```{r}
aggregate.data(sim.results.all, 
               "decouple.art",
               1980, 2021, 0, 100)
```



```{r}
age_min_list = c(15, 25, 15, 50)
age_max_list = c(25, 50, 100, 100)

start_year_list = c(1985, 2005, 2015, 2025, 1985, 1985)
end_year_list = c(2005, 2015, 2025, 2035, 2025, 2035)
label_list = c("Pre-ART", "ART Scaleup", "Universal ART", "Future", "Past Pandemic", "Past+Future")

scenario_names = sim.results.all$scenario_name %>% unique

numbers.table <- data.table()
for (i in seq(1:length(age_min_list))){
  for (j in seq(1:length(start_year_list)) ){
    for (k in seq(1:length(scenario_names))) {

      age_min = age_min_list[[i]]
      age_max = age_max_list[[i]]
      start_year = start_year_list[[j]]
      end_year = end_year_list[[j]]
      holder <- aggregate.data(sim.results.all, 
                     scenario_names[[k]],
                     start_year, end_year, age_min,age_max) %>% 
        mutate(Ages = paste0(age_min, "-", age_max),
               Years = paste0(start_year,"-",end_year),
               Period = label_list[[j]])
      
      numbers.table <- rbind(numbers.table, holder)      
      
    }
  }
} 

numbers.table <- numbers.table %>% 
  select(
    "Ages", "Period", "Years", "scenario_name",
    "Newly.Infected", "Newly.Infected_95LL", "Newly.Infected_95UL", "Newly.Infected.sd", 
    "Died_from_HIV", "Died_from_HIV_95LL", "Died_from_HIV_95UL",  "Died_from_HIV.sd", 
    "Depression.eps", "Depression.eps_95LL", "Depression.eps_95UL", "Depression.eps.sd"
  )  %>% arrange(Period, Ages, scenario_name)

# write_csv(numbers.table, "numbers_table_20240531.csv")

# write_csv(numbers.table, "numbers_table_20240606.csv")
# write_csv(numbers.table, "numbers_table_20240709.csv")
#write_csv(numbers.table, "numbers_table_20240719.csv")
write_csv(numbers.table, "numbers_table_20240819.csv")
```

## Calculate Differences

Differences here are between each scenario and the decouple.art scenario. We assume there will be the least problems with decouple.noart.

```{r}
age_min_list = c(15, 25, 15, 50)
age_max_list = c(25, 50, 100, 100)

start_year_list = c(1985, 2005, 2015, 2025, 1985, 1985)
end_year_list = c(2005, 2015, 2025, 2035, 2025, 2035)
label_list = c("Pre-ART", "ART Scaleup", "Universal ART", "Future", "Past Pandemic", "Past+Future")

scenario_names <- sim.results.all$scenario_name %>% unique
scenario_names <- scenario_names[scenario_names != "decouple.art"]
scenario_names <- scenario_names[scenario_names != "baseline.art.not.cmdinc"]

# First, calculate differences between all scenarios and decouple.art
differences.table <- data.table()
for (i in seq(1:length(age_min_list))){
  for (j in seq(1:length(start_year_list)) ){
    for (k in seq(1:length(scenario_names))) {

      age_min = age_min_list[[i]]
      age_max = age_max_list[[i]]
      start_year = start_year_list[[j]]
      end_year = end_year_list[[j]]
      
      holder <- aggregate.data.differences(sim.results.all,
                                           scenario.name = scenario_names[[k]],
                                           start_year, end_year, age_min,age_max,
                                           comparison_scenario = "decouple.art") %>% 
               mutate(Ages = paste0(age_min, "-", age_max),
                      Years = paste0(start_year,"-",end_year),
                      Period = label_list[[j]])
      
      differences.table <- rbind(differences.table, holder)      
      
    }
  }
} 

# Next, calculate differences between baseline.art and baseline.art.not.cmdinc
for (i in seq(1:length(age_min_list))){
  for (j in seq(1:length(start_year_list)) ){

    age_min = age_min_list[[i]]
    age_max = age_max_list[[i]]
    start_year = start_year_list[[j]]
    end_year = end_year_list[[j]]
    
    holder <- aggregate.data.differences(sim.results.all,
                                         scenario.name = "baseline.art",
                                         start_year, end_year, age_min,age_max,
                                         comparison_scenario = "baseline.art.not.cmdinc") %>% 
             mutate(Ages = paste0(age_min, "-", age_max),
                    Years = paste0(start_year,"-",end_year),
                    Period = label_list[[j]])
    
    # I know this is confusing but we're labeling by the denominator
    holder$scenario_name <- "baseline.art.not.cmdinc"
    
    differences.table <- rbind(differences.table, holder)      
      
  }
} 

differences.table <- differences.table %>% 
  select(
    "Ages", "Period", "Years", "scenario_name",
    "Newly.Infected.diff", "Newly.Infected.diff_95LL", "Newly.Infected.diff_95UL", "Newly.Infected.diff.sd", 
    "Newly.Infected.pct", "Newly.Infected.pct_95LL", "Newly.Infected.pct_95UL", "Newly.Infected.pct.sd" ,
    "Died_from_HIV.diff", "Died_from_HIV.diff_95LL", "Died_from_HIV.diff_95UL" , "Died_from_HIV.diff.sd",
    "Died_from_HIV.pct", "Died_from_HIV.pct_95LL" ,  "Died_from_HIV.pct_95UL", "Died_from_HIV.pct.sd",
    "Depression.eps.diff", "Depression.eps.diff_95LL", "Depression.eps.diff_95UL", "Depression.eps.diff.sd",
    "Depression.eps.pct", "Depression.eps.pct_95LL", "Depression.eps.pct_95UL",  "Depression.eps.pct.sd"
  ) %>% arrange(Period, Ages, scenario_name)

# write_csv(differences.table, "differences_table_20240531.csv")
#write_csv(differences.table, "differences_table_20240606.csv")
#write_csv(differences.table, "differences_table_20240709.csv")
#write_csv(differences.table, "differences_table_20240719.csv")
write_csv(differences.table, "differences_table_20240819.csv")

#differences.table %>% View
```

Check the differences table
```{r}
numbers.table %>% filter(Ages == "15-100", Years == "1985-2035",
                         scenario_name %in% c("baseline.art", "decouple.art"))
```
```{r}
differences.table %>% filter(Ages == "15-100", Years == "1985-2035",
                         scenario_name %in% c("baseline.art", "decouple.art"))
```



```{r, fig.height= 20}
differences.table %>% 
  ggplot() + 
  geom_point(mapping = aes(x = scenario_name, y = Newly.Infected.diff)) + 
  geom_errorbar(mapping = aes(x = scenario_name, ymin = Newly.Infected.diff_95LL, ymax = Newly.Infected.diff_95UL)) + 
  facet_wrap(vars(Ages, Years)) + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) 

# ggplot(data = sim.results.all.agg.differences) + 
#   geom_point(mapping = aes(x = scenario_name, y = Newly.Infected.diff, color = Gender)) + 
#   geom_errorbar(aes(x=scenario_name, ymin = Newly.Infected.diff_95LL, ymax = Newly.Infected.diff_95UL)) + 
#   facet_wrap(~ Gender, ncol=2) + 
#   scale_color_manual(values = c("red", "blue"))  + 
#   theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) 

#ggsave("New_Cases_Difference.pdf", height = 4, width = 8, units = "in")
```

```{r, fig.height = 20}
differences.table %>% 
  ggplot() + 
  geom_point(mapping = aes(x = scenario_name, y = Newly.Infected.pct)) + 
  geom_errorbar(mapping = aes(x = scenario_name, ymin = Newly.Infected.pct_95LL, ymax = Newly.Infected.pct_95UL)) + 
  facet_wrap(vars(Ages, Years)) + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) 


# ggplot(data = sim.results.all.agg.differences) + 
#   geom_point(mapping = aes(x = scenario_name, y = Newly.Infected.pct, color = Gender)) + 
#   geom_errorbar(aes(x=scenario_name, ymin = Newly.Infected.pct_95LL, ymax = Newly.Infected.pct_95UL)) + 
#   geom_label(mapping = aes(x = scenario_name, y = Newly.Infected.pct + .015, label = round(Newly.Infected.pct,3))) + 
#   facet_wrap(~ Gender, ncol=2) + 
#   scale_color_manual(values = c("red", "blue"))  + 
#   theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) 

# ggsave("/gpfs/data/bershteynlab/EMOD/citrod01/MATUMAINI/Analysis/hiv_infs_pct_change_above_decoupled.pdf", height = 6, width = 12, units = "in")
```

```{r, fig.height = 20}
differences.table %>% 
  ggplot() + 
  geom_point(mapping = aes(x = scenario_name, y = Died_from_HIV.diff)) + 
  geom_errorbar(mapping = aes(x = scenario_name, ymin = Died_from_HIV.diff_95LL, ymax = Died_from_HIV.diff_95UL)) + 
  facet_wrap(vars(Ages, Years)) + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) 

# ggplot(data = sim.results.all.agg.differences) + 
#   geom_point(mapping = aes(x = scenario_name, y = Died_from_HIV.diff, color = Gender)) + 
#   geom_errorbar(aes(x=scenario_name, ymin = Died_from_HIV.diff_95LL, ymax = Died_from_HIV.diff_95UL)) + 
#   facet_wrap(~ Gender, ncol=2) + 
#   scale_color_manual(values = c("red", "blue"))  + 
#   theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) 
# 
# ggsave("HIV_Deaths_Difference.pdf", height = 4, width = 8, units = "in")
```

```{r, fig.height = 20}
differences.table %>% 
  ggplot() + 
  geom_point(mapping = aes(x = scenario_name, y = Died_from_HIV.pct)) + 
  geom_errorbar(mapping = aes(x = scenario_name, ymin = Died_from_HIV.pct_95LL, ymax = Died_from_HIV.pct_95UL)) + 
  facet_wrap(vars(Ages, Years)) + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) 


# ggplot(data = sim.results.all.agg.differences) + 
#   geom_point(mapping = aes(x = scenario_name, y = Died_from_HIV.pct, color = Gender)) + 
#   geom_errorbar(aes(x=scenario_name, ymin = Died_from_HIV.pct_95LL, ymax = Died_from_HIV.pct_95UL)) + 
#   geom_label(mapping = aes(x = scenario_name, y = Died_from_HIV.pct + .015, label = round(Died_from_HIV.pct,3))) + 
#   facet_wrap(~ Gender, ncol=2) + 
#   scale_color_manual(values = c("red", "blue"))  + 
#   theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) 
# 
# 
# ggsave("/gpfs/data/bershteynlab/EMOD/citrod01/MATUMAINI/Analysis/hiv_deaths_pct_change_above_decoupled.pdf", height = 6, width = 12, units = "in")
```

## Impact of ART

### Importing data

The difference here is that we will import data with the column which stratifies by ART adherence

```{r}
# Decouple, art
# Version 5
# experiment.path = "/gpfs/scratch/citrod01/experiments/MATUMAINI/Baseline-campaign_MATUMAINI_202305_decouple-decouple_art___2024_05_29_10_56_12_042206"
# Version 6
experiment.path = "/gpfs/scratch/citrod01/experiments/MATUMAINI/manuscript/Baseline-campaign_MATUMAINI_202305_decouple-decouple_art___2024_07_04_12_57_51_112851"

impact.results.decouple.art <- EMODAnalyzeR::read.simulation.results.bigpurple(
  experiment_path = experiment.path,
  scenario_name = "decouple.art",
    summarize_columns = c("Population","Infected", "On_ART",
                        "Died", "Died_from_HIV",
                        "Newly.Infected","Diagnosed"),
  stratify_columns = c("Year", "Gender", "Age", "IP_Key.CMDStatus"),
  min_age_inclusive = 0,
  max_age_inclusive = 99
)

# Decouple, No art
# Version 5
#experiment.path = "/gpfs/scratch/citrod01/experiments/MATUMAINI/Baseline-campaign_MATUMAINI_202305_decouple-decouple_noart___2024_05_29_11_00_44_305507/"
# Version 6
experiment.path = "/gpfs/scratch/citrod01/experiments/MATUMAINI/manuscript/Baseline-campaign_MATUMAINI_202305_decouple-decouple_noart___2024_07_04_13_20_33_313665/"

impact.results.decouple.noart <- EMODAnalyzeR::read.simulation.results.bigpurple(
  experiment_path = experiment.path,
  scenario_name = "decouple.noart",
    summarize_columns = c("Population","Infected", "On_ART",
                        "Died", "Died_from_HIV",
                        "Newly.Infected","Diagnosed"),
  stratify_columns = c("Year", "Gender", "Age", "IP_Key.CMDStatus"),
  min_age_inclusive = 0,
  max_age_inclusive = 99
)

# Baseline art
# Version 5
# experiment.path = "/gpfs/scratch/citrod01/experiments/MATUMAINI/Baseline-campaign_MATUMAINI_202305-baseline_art___2024_05_29_10_58_40_605127"
# Version 6
experiment.path = "/gpfs/scratch/citrod01/experiments/MATUMAINI/manuscript/Baseline-campaign_MATUMAINI_202305-baseline_art___2024_07_04_13_17_52_169973"

impact.results.baseline.art <- EMODAnalyzeR::read.simulation.results.bigpurple(
  experiment_path = experiment.path,
  scenario_name = "baseline.art",
    summarize_columns = c("Population","Infected", "On_ART",
                        "Died", "Died_from_HIV",
                        "Newly.Infected","Diagnosed"),
  stratify_columns = c("Year", "Gender", "Age", "IP_Key.CMDStatus"),
  min_age_inclusive = 0,
  max_age_inclusive = 99
)

# Baseline, no art
# Version 5
#experiment.path = "/gpfs/scratch/citrod01/experiments/MATUMAINI/Baseline-campaign_MATUMAINI_202305-baseline_noart___2024_05_29_11_02_47_731450/"
experiment.path = "/gpfs/scratch/citrod01/experiments/MATUMAINI/manuscript/Baseline-campaign_MATUMAINI_202305-baseline_noart___2024_07_04_13_22_57_531426"

impact.results.baseline.noart <- EMODAnalyzeR::read.simulation.results.bigpurple(
  experiment_path = experiment.path,
  scenario_name = "baseline.noart",
    summarize_columns = c("Population","Infected", "On_ART",
                        "Died", "Died_from_HIV",
                        "Newly.Infected","Diagnosed"),
  stratify_columns = c("Year", "Gender", "Age", "IP_Key.CMDStatus"),
  min_age_inclusive = 0,
  max_age_inclusive = 99
)

```


```{r}
# Join together
sim.results.impact <- rbind(impact.results.decouple.art,
                         impact.results.decouple.noart,
                         impact.results.baseline.art,
                         impact.results.baseline.noart)

# sim.results.impact <- rbind(sim.results.decouple.art,
#                          sim.results.decouple.noart,
#                          sim.results.baseline.art,
#                          sim.results.baseline.noart)

CENSUS_YEAR = 2009
KEN_CENSUS_POP = 5352385

sim.results.pop.scaling <- sim.results.impact %>% 
      filter(Year == CENSUS_YEAR) %>%
      group_by(sim.ix, scenario_name) %>%
      summarize(total.pop = sum(Population), .groups = 'keep') %>% 
      mutate(pop.scaling.factor = KEN_CENSUS_POP/total.pop)

sim.results.impact <- sim.results.impact %>% 
  inner_join(
    sim.results.pop.scaling,
    by = c("sim.ix", "scenario_name")
  )
```

### Define function

```{r}
bt_mean <- function(splits, colname){
  x <- as.data.frame(analysis(splits))
  mean(x[[colname]], na.rm = TRUE)
}


measure.art.impact <- function(data, colname, start_year, end_year, age_min, age_max){
  
  data['column.of.interest'] = data[colname]

  art.impact.data <- data %>% 
    filter(Year >= start_year, Year < end_year,
           Age >= age_min, Age < age_max) %>% 
    group_by(scenario_name, sim.ix) %>% 
    summarize(column.of.interest = sum(column.of.interest * pop.scaling.factor), .groups = "keep") %>% 
    ungroup() %>% 
    pivot_wider(id_cols = c(sim.ix), names_from = c(scenario_name), values_from = c(column.of.interest)) %>% 
    merge(
      data %>% 
        filter(Year >= start_year, Year < end_year,
               Age >= age_min, Age < age_max) %>% 
        group_by(scenario_name, sim.ix) %>% 
        summarize(On_ART = sum(On_ART * pop.scaling.factor), .groups = "keep") %>%
        ungroup() %>% 
        pivot_wider(id_cols = c(sim.ix), names_from = c(scenario_name), values_from = c(On_ART)) %>% 
        select(sim.ix = sim.ix, baseline.art.pyoa = baseline.art, decouple.art.pyoa = decouple.art)
    ) %>%
    mutate(baseline.art.impact = baseline.noart - baseline.art,
           decouple.art.impact = decouple.noart - decouple.art,
           baseline.art.ppyoa = case_when(
             baseline.art.pyoa >  0 ~ (baseline.noart - baseline.art)/baseline.art.pyoa,
             baseline.art.pyoa == 0 ~ 0
           ),
           decouple.art.ppyoa = case_when(
             decouple.art.pyoa >  0 ~ (decouple.noart - decouple.art)/decouple.art.pyoa,
             decouple.art.pyoa == 0 ~ 0
           )
     ) %>% 
    mutate(art.impact = baseline.art.impact - decouple.art.impact,
           art.impact.ppyoa = baseline.art.ppyoa - decouple.art.ppyoa) %>% 
    mutate(art.impact.pct = case_when(
              decouple.art.impact > 0 ~ art.impact/decouple.art.impact,
              decouple.art.impact == 0 ~ 0),
           art.impact.ppyoa.pct = case_when(
              decouple.art.ppyoa > 0 ~ art.impact.ppyoa/decouple.art.ppyoa,
              decouple.art.ppyoa == 0 ~ 0)
    )

  art.impact.data.agg <- art.impact.data %>% 
      summarize(baseline.art.impact.sd = sd(baseline.art.impact, na.rm = TRUE),
                baseline.art.impact = mean(baseline.art.impact, na.rm = TRUE),
                decouple.art.impact.sd = sd(decouple.art.impact, na.rm = TRUE),
                decouple.art.impact = mean(decouple.art.impact, na.rm = TRUE),
                art.impact.sd = sd(art.impact, na.rm = TRUE),
                art.impact = mean(art.impact, na.rm = TRUE),
                art.impact.pct.sd = sd(art.impact.pct, na.rm = TRUE),
                art.impact.pct = mean(art.impact.pct, na.rm = TRUE),
                baseline.art.ppyoa.sd = sd(baseline.art.ppyoa, na.rm = TRUE),
                baseline.art.ppyoa = mean(baseline.art.ppyoa, na.rm = TRUE), 
                decouple.art.ppyoa.sd = sd(decouple.art.ppyoa, na.rm = TRUE),
                decouple.art.ppyoa = mean(decouple.art.ppyoa, na.rm = TRUE),
                art.impact.ppyoa.sd = sd(art.impact.ppyoa, na.rm = TRUE),
                art.impact.ppyoa = mean(art.impact.ppyoa, na.rm = TRUE),
                art.impact.ppyoa.pct.sd = sd(art.impact.ppyoa.pct, na.rm = TRUE),
                art.impact.ppyoa.pct = mean(art.impact.ppyoa.pct, na.rm = TRUE),
                .groups = "keep"
                ) %>%
      ungroup()
  
  bt_resamples <- bootstraps(art.impact.data, times = 500)
  bt_resamples$baseline.art.impact <- map_dbl(bt_resamples$splits, bt_mean, "baseline.art.impact")
  bt_resamples$decouple.art.impact <- map_dbl(bt_resamples$splits, bt_mean, "decouple.art.impact")
  bt_resamples$art.impact <- map_dbl(bt_resamples$splits, bt_mean, "art.impact")
  bt_resamples$art.impact.pct <- map_dbl(bt_resamples$splits, bt_mean, "art.impact.pct")
  bt_resamples$baseline.art.ppyoa <- map_dbl(bt_resamples$splits, bt_mean, "baseline.art.ppyoa")
  bt_resamples$decouple.art.ppyoa <- map_dbl(bt_resamples$splits, bt_mean, "decouple.art.ppyoa")
  bt_resamples$art.impact.ppyoa <- map_dbl(bt_resamples$splits, bt_mean, "art.impact.ppyoa")
  bt_resamples$art.impact.ppyoa.pct <- map_dbl(bt_resamples$splits, bt_mean, "art.impact.ppyoa.pct")
  
  baseline.art.impact_95 <- quantile(bt_resamples$baseline.art.impact, probs = c(.025, .975))
  decouple.art.impact_95 <- quantile(bt_resamples$decouple.art.impact, probs = c(.025, .975))
  art.impact_95 <- quantile(bt_resamples$art.impact, probs = c(.025, .975))
  art.impact.pct_95 <- quantile(bt_resamples$art.impact.pct, probs = c(.025, .975))
  baseline.art.ppyoa_95 <- quantile(bt_resamples$baseline.art.ppyoa, probs = c(.025, .975))
  decouple.art.ppyoa_95 <- quantile(bt_resamples$decouple.art.ppyoa, probs = c(.025, .975))
  art.impact.ppyoa_95 <- quantile(bt_resamples$art.impact.ppyoa, probs = c(.025, .975))
  art.impact.ppyoa.pct_95 <- quantile(bt_resamples$art.impact.ppyoa.pct, probs = c(.025, .975))
    
  art.impact.data.agg$baseline.art.impact_95LL <- baseline.art.impact_95[[1]]
  art.impact.data.agg$baseline.art.impact_95UL <- baseline.art.impact_95[[2]]
  art.impact.data.agg$decouple.art.impact_95LL <- decouple.art.impact_95[[1]]
  art.impact.data.agg$decouple.art.impact_95UL <- decouple.art.impact_95[[2]]
  art.impact.data.agg$art.impact_95LL <- art.impact_95[[1]]
  art.impact.data.agg$art.impact_95UL <- art.impact_95[[2]]
  art.impact.data.agg$art.impact.pct_95LL <- art.impact.pct_95[[1]]
  art.impact.data.agg$art.impact.pct_95UL <- art.impact.pct_95[[2]]
  art.impact.data.agg$baseline.art.ppyoa_95LL <- baseline.art.ppyoa_95[[1]]
  art.impact.data.agg$baseline.art.ppyoa_95UL <- baseline.art.ppyoa_95[[2]]
  art.impact.data.agg$decouple.art.ppyoa_95LL <- decouple.art.ppyoa_95[[1]]
  art.impact.data.agg$decouple.art.ppyoa_95UL <- decouple.art.ppyoa_95[[2]]
  art.impact.data.agg$art.impact.ppyoa_95LL <- art.impact.ppyoa_95[[1]]
  art.impact.data.agg$art.impact.ppyoa_95UL <- art.impact.ppyoa_95[[2]]
  art.impact.data.agg$art.impact.ppyoa.pct_95LL <- art.impact.ppyoa.pct_95[[1]]
  art.impact.data.agg$art.impact.ppyoa.pct_95UL <- art.impact.ppyoa.pct_95[[2]]
  
  art.impact.data.agg <- art.impact.data.agg %>% select(
        "baseline.art.impact", "baseline.art.impact.sd", "baseline.art.impact_95LL", "baseline.art.impact_95UL",
        "decouple.art.impact", "decouple.art.impact.sd", "decouple.art.impact_95LL", "decouple.art.impact_95UL",
        "art.impact", "art.impact.sd", "art.impact_95LL", "art.impact_95UL",
        "art.impact.pct", "art.impact.pct.sd", "art.impact.pct_95LL", "art.impact.pct_95UL",
        "baseline.art.ppyoa", "baseline.art.ppyoa.sd", "baseline.art.ppyoa_95LL", "baseline.art.ppyoa_95UL",
        "decouple.art.ppyoa", "decouple.art.ppyoa.sd", "decouple.art.ppyoa_95LL", "decouple.art.ppyoa_95UL",
        "art.impact.ppyoa", "art.impact.ppyoa.sd", "art.impact.ppyoa_95LL", "art.impact.ppyoa_95UL",
        "art.impact.ppyoa.pct", "art.impact.ppyoa.pct.sd", "art.impact.ppyoa.pct_95LL", "art.impact.ppyoa.pct_95UL"
      )
  
  art.impact.data.agg
}

```

### Calculate impact of ART
```{r}
measure.art.impact(sim.results.impact, "Died_from_HIV", 1985, 2000, 15, 25)
```

```{r}
age_min_list = c(15, 25, 15, 50)
age_max_list = c(25, 100, 100, 100)

# Note that for the pre-art period we use 2000 instead of 2005, because ART does start before 2005 
# and using 2005 will mess up the plots, make it look like art impact is negative
start_year_list = c(1985, 2000, 2015, 2025, 1985, 1985)
end_year_list = c(2000, 2015, 2025, 2035, 2025, 2035)
label_list = c("Pre-ART", "ART Scaleup", "Universal ART", "Future", "Past Pandemic", "Past+Future")

metrics = c("Newly.Infected", "Died_from_HIV")

impact.table <- data.table()
for (i in seq(1:length(age_min_list))){
  for (j in seq(1:length(start_year_list)) ){
    for (k in seq(1:length(metrics))) {
      holder <- measure.art.impact(sim.results.impact, metrics[[k]], 
                                   start_year_list[[j]], end_year_list[[j]], 
                                   age_min_list[[i]], age_max_list[[i]]) %>% 
        mutate(Ages = paste0(age_min_list[[i]], "-", age_max_list[[i]]),
               Years = paste0(start_year_list[[j]],"-",end_year_list[[j]]),
               Period = label_list[[j]],
               Metric = metrics[[k]])
      
      impact.table <- rbind(impact.table, holder)
    }
  }
}
#colnames(impact.table)

impact.table <- impact.table %>% 
  select("Period", "Years", "Ages", "Metric",
         "art.impact.ppyoa", "art.impact.ppyoa.sd", "art.impact.ppyoa_95LL", "art.impact.ppyoa_95UL", 
         "art.impact.ppyoa.pct", "art.impact.ppyoa.pct.sd", "art.impact.ppyoa.pct_95LL", "art.impact.ppyoa.pct_95UL",
         "art.impact.pct", "art.impact.pct.sd", "art.impact.pct_95LL", "art.impact.pct_95UL", 
         "baseline.art.ppyoa", "baseline.art.ppyoa.sd", "baseline.art.ppyoa_95LL", "baseline.art.ppyoa_95UL",
         "decouple.art.ppyoa", "decouple.art.ppyoa.sd", "decouple.art.ppyoa_95LL", "decouple.art.ppyoa_95UL",
         "baseline.art.impact","baseline.art.impact.sd","baseline.art.impact_95LL", "baseline.art.impact_95UL", "decouple.art.impact","decouple.art.impact.sd",
         "decouple.art.impact_95LL","decouple.art.impact_95UL","art.impact","art.impact.sd","art.impact_95LL", "art.impact_95UL")  %>% 
  arrange(Years, Ages, Metric)

#impact.table %>% View
```


```{r}
#write_csv(impact.table, "impact_of_art_table_20240606.csv")

write_csv(impact.table, "impact_of_art_table_20240709.csv")

impact.table.20240709 <- read_csv("impact_of_art_table_20240719.csv")
```


### 90-90-90 Metrics

# Figures

```{r}
#numbers.table <- read_csv("numbers_table_20240531.csv")

differences.table <- read_csv("differences_table_20240709.csv")

impact.table <- read_csv("impact_of_art_table_20240709.csv")
```

## Numbers table

```{r}
numbers.table %>% head

numbers.table$Period %>% unique 
```

```{r, fig.height=8}
numbers.table %>% 
  filter(Period == "Entire Past Pandemic") %>% 
  ggplot() + 
  geom_point(mapping = aes(x = scenario_name, y = Newly.Infected)) + 
  geom_errorbar(mapping = aes(x = scenario_name, ymin = Newly.Infected_95LL, ymax = Newly.Infected_95UL)) + 
  facet_grid(cols = vars(Ages), rows = vars(Period)) + 
  expand_limits(x = 0, y = 0) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))


numbers.table %>% 
  filter(Period == "Universal ART") %>% 
  ggplot() + 
  geom_point(mapping = aes(x = scenario_name, y = Newly.Infected)) + 
  geom_errorbar(mapping = aes(x = scenario_name, ymin = Newly.Infected_95LL, ymax = Newly.Infected_95UL)) + 
  facet_grid(cols = vars(Ages), rows = vars(Period)) + 
  #ylim(0,2.1e5) + 
  expand_limits(x = 0, y = 0) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

# ggplot(data = sim.results.all.agg.numbers) + 
#   geom_point(mapping = aes(x = scenario_name, y = Newly.Infected, color = Gender)) + 
#   geom_errorbar(aes(x=scenario_name, ymin = Newly.Infected_95LL, ymax = Newly.Infected_95UL)) + 
#   facet_wrap(~ Gender, ncol=2) + 
#   scale_color_manual(values = c("red", "blue"))  + 
#   theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) 
# #+ 
# #  scale_y_continuous(limits = c(5e5, 9e5)) 

```

## Differences Figure

There are going to be three panels.

Top panel will have baseline.art differences
Middle panel will have not.cmdinc, decouple.art.tx, and decouple.art.hivmc
Bottom panel will split out treatment effects

X axis is time, y axis is whatever metric we want
Age bracket is 15+, relegate 15-25 and 25+ to the appendix...

```{r, fig.height=8}
differences.table %>% head

differences.table$Period %>% unique 

differences.table <- differences.table %>% 
  mutate(Time =case_match(
    Period,
    "Pre-ART" ~ 1,
    "ART Scaleup" ~ 2,
    "Universal ART" ~ 3,
    "Future" ~ 4,
    "Past Pandemic" ~ 5,
    "Past+Future" ~ 6
  )) %>% 
  mutate(divisor = case_match(
    Period,
    "Pre-ART" ~ 15,
    "ART Scaleup" ~ 10,
    "Universal ART" ~ 10,
    "Future" ~ 10,
    "Past Pandemic" ~ 40,
    "Past+Future" ~ 50
  )) %>% 
  mutate(scenario_ix = case_match(
    scenario_name,
    "baseline.art" ~ 1,
    "decouple.art.hivinc.hivtr" ~ 2,
    "baseline.art.not.cmdinc" ~ 3,
    "decouple.art.tx" ~ 4,
    "decouple.art.artswitch.artadh" ~ 5,
    "decouple.art.artdrop"~ 6,
    "decouple.art.delay" ~ 7
  )) %>% filter(!is.na(scenario_ix))

colors = c("black","#5C91F5","#E68600","#7D52CD","#089011","#202FD2","#C9140A")
```

### HIV deaths differences for all scenarios


```{r}
p.overall.deaths.pct <- differences.table %>% filter(Ages == "15-100", Period == "Past+Future") %>% 
  ggplot() + 
  geom_col(mapping = aes(x = -scenario_ix + 1, y = 100 * Died_from_HIV.pct, color = factor(scenario_ix)), 
           size = .5, fill = "white",  show.legend = FALSE, position = "dodge") + 
  geom_errorbar(mapping = aes(x = -scenario_ix + 1, 
                              ymin = 100*Died_from_HIV.pct_95LL, ymax = 100*Died_from_HIV.pct_95UL, 
                              color = factor(scenario_ix)),
                size = .75, width = .75,  show.legend = FALSE) +
  labs(x = "", y = "") +  #"HIV Deaths Attributable to\nHIV-Depression Interactions\n(1985-2035)") + 
  expand_limits(x = 1, y = 0) + 
  scale_color_manual(breaks = seq(1,7,1), values=colors) +
  scale_y_continuous(breaks = seq(0,20,4), labels = c("0%", "4%", "8%", "12%", "16%", "20%"), expand = c(0.01,0.01)) + 
  #scale_y_continuous(breaks = seq(0,20,5), labels = c("0%", "5%", "10%", "15%", "20%")) + 
  # scale_x_continuous(breaks = seq(1,7,1), labels = c("All Interactions", "Elevated HIV\nIncidence","Elevated Depression\nIncidence",
  #                                                  "HIV Treatment\nDisruptions","Reduced ART\nAdherence", "Reduced ART\nRetention",
  #                                                  "Delays to\nART Uptake"
  #                                                  )) +
  scale_x_continuous(expand = expansion(mult = c(0.02, -.05))) + 
  #xlim(-6.5,.5)+
  theme_bw(base_size=16) + 
  theme(panel.grid.major = element_blank(), 
      panel.grid.minor = element_blank(),
      axis.ticks.y = element_blank(),
      axis.text.y = element_blank(),
      plot.margin = unit(c(0,0,0,0), "cm")) + coord_flip()

p.overall.deaths.pct
```


```{r}
p.overall.deaths.diff <- differences.table %>% filter(Ages == "15-100", Period == "Past+Future") %>% 
  ggplot() + 
  geom_col(mapping = aes(x = -scenario_ix + 1, y = Died_from_HIV.diff, color = factor(scenario_ix)), 
           size = .5, fill = "white",  show.legend = FALSE, position = "dodge") + 
  geom_errorbar(mapping = aes(x = -scenario_ix + 1, 
                              ymin = Died_from_HIV.diff_95LL, ymax = Died_from_HIV.diff_95UL, 
                              color = factor(scenario_ix)),
                size = .75, width = .75,  show.legend = FALSE) +
  labs(x = "", y = "") +  #HIV Deaths Attributable to\nHIV-Depression Interactions\n(1985-2035)") + 
  expand_limits(x = 1, y = 0) + 
  scale_color_manual(breaks = seq(1,7,1), values=colors) +
  #scale_y_continuous(breaks = seq(0,20,4), labels = c("0%", "4%", "8%", "12%", "16%", "20%"), expand = c(0.01,0.01)) + 
  #scale_y_continuous(breaks = seq(0,20,5), labels = c("0%", "5%", "10%", "15%", "20%")) + 
  # scale_x_continuous(breaks = seq(1,7,1), labels = c("All Interactions", "Elevated HIV\nIncidence","Elevated Depression\nIncidence",
  #                                                  "HIV Treatment\nDisruptions","Reduced ART\nAdherence", "Reduced ART\nRetention",
  #                                                  "Delays to\nART Uptake"
  #                                                  )) +
  scale_x_continuous(expand = expansion(mult = c(0.02, -.05))) + 
  scale_y_continuous(expand = expansion(mult = c(0.01,.05))) + 
  #xlim(-6.5,.5)+
  theme_bw(base_size=16) + 
  theme(panel.grid.major = element_blank(), 
      panel.grid.minor = element_blank(),
      axis.ticks.y = element_blank(),
      axis.text.y = element_blank(),
      axis.text.x = element_text(hjust = .5),
      plot.margin = ) + coord_flip()

p.overall.deaths.diff
```


### HIV deaths differences percentages panel 1
```{r}
p.panel1.deaths.pct <- differences.table %>% 
  filter(scenario_name == "baseline.art",
         Ages == "15-100",
         Time < 5) %>% 
  ggplot() + 
  geom_point(mapping = aes(x = Time, y = 100*Died_from_HIV.pct),
                size = 2) + 
  geom_line(mapping = aes(x = Time, y = 100*Died_from_HIV.pct),
                size = 1) + 
  geom_errorbar(mapping = aes(x = Time, ymin = 100*Died_from_HIV.pct_95LL, ymax = 100*Died_from_HIV.pct_95UL),
                size = 1, width = .5) + 
  expand_limits(x = 1, y = 0) +
  labs(x = "", y = "") + # "HIV Deaths Attributable to\nHIV-Depression Interactions") + 
  scale_color_manual("All Interactions", values=c("black")) +
  scale_x_continuous(breaks = c(1,2,3,4), 
                     labels = c("Pre-ART\n1985-2005", "ART Scale-up\n2005-2015", "Universal ART\n2015-2025","Future\n2025-2035"),
                     expand = expansion(mult = c(0.01,.01))) + 
  scale_y_continuous(breaks = seq(0,25,5), labels = c("0%", "5%", "10%", "15%", "20%", "25%"), expand = expansion(mult = c(0.01,.2))) + 
  theme_bw(base_size=16) +
  theme(panel.grid.major = element_blank(), 
      panel.grid.minor = element_blank(),
      axis.text.x = element_text(color = 'black', angle = 45, vjust = 0.5))

p.panel1.deaths.pct
```
### HIV deaths differences percentages panel 2
```{r}
p.panel2.deaths.pct <- differences.table %>% 
  filter(scenario_name %in% c("baseline.art.not.cmdinc", "decouple.art.tx", "decouple.art.hivinc.hivtr"),
         Ages == "15-100",
         Time < 5) %>% 
  ggplot() + 
  geom_point(mapping = aes(x = Time, y = 100*Died_from_HIV.pct, color = factor(scenario_ix)),  show.legend = FALSE, size = 2) + 
  geom_line(mapping = aes(x = Time, y = 100*Died_from_HIV.pct, color = factor(scenario_ix)),  show.legend = FALSE, size = 1) + 
  geom_errorbar(mapping = aes(x = Time, ymin = 100*Died_from_HIV.pct_95LL, ymax = 100*Died_from_HIV.pct_95UL, color = factor(scenario_ix)),
                size = 1, width = .5,
                show.legend = FALSE) + 
  expand_limits(x = 1, y = 0) +
  scale_color_manual(values=colors[2:4]) + 
  scale_x_continuous(breaks = c(1,2,3,4), 
                     labels = c("Pre-ART\n1985-2005", "ART Scale-up\n2005-2015", "Universal ART\n2015-2025","Future\n2025-2035"),
                     expand = expansion(mult = c(0.01,.01))) + 
  scale_y_continuous(breaks = c(0,3,6,9,12), labels = c("0%", "3%", "6%", "9%", "12%"), expand = expansion(mult = c(0.01,.2))) + 
  #ylim(0,12) +
  labs(x = "", y = "") + 
  theme_bw(base_size=16) + 
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        axis.text.x = element_text(color = 'black', angle = 45, vjust = 0.5))

p.panel2.deaths.pct
```

### HIV deaths differences percentages panel 3
```{r}
p.panel3.deaths.pct <- differences.table %>% 
  filter(scenario_name %in% c("decouple.art.artdrop", "decouple.art.delay", "decouple.art.artswitch.artadh"),
         Ages == "15-100",
         Time < 5) %>% 
  ggplot() + 
  geom_point(mapping = aes(x = Time, y = 100*Died_from_HIV.pct, color = , color = factor(scenario_ix)), show.legend = FALSE, size = 2) +
  geom_line(mapping = aes(x = Time, y = 100*Died_from_HIV.pct, color = , color = factor(scenario_ix)), show.legend = FALSE, size = 1) +
  geom_errorbar(mapping = aes(x = Time, ymin = 100*Died_from_HIV.pct_95LL, ymax = 100*Died_from_HIV.pct_95UL, color = factor(scenario_ix)), 
                size = 1, width = .5,
                show.legend = FALSE) + 
  expand_limits(x = 1, y = 0) +
  scale_color_manual(values=colors[5:7]) + 
  scale_x_continuous(breaks = c(1,2,3,4), 
                     labels = c("Pre-ART\n1985-2005", "ART Scale-up\n2005-2015", "Universal ART\n2015-2025","Future\n2025-2035"),
                     expand = expansion(mult = c(0.01,.01))) + 
  scale_y_continuous(breaks = seq(0,5,1), labels = c("0%", "1%", "2%", "3%", "4%","5%"), expand = expansion(mult = c(0.01,.05))) + 
  labs(x = "", y = "") + 
  theme_bw(base_size=16) + 
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        axis.text.x = element_text(color = 'black', angle = 45, vjust = 0.5))

p.panel3.deaths.pct
```
### Combine in a grid and export
```{r}
#ggsave("hiv_deaths_overall_pct.pdf", p.overall.deaths.pct, width = 6, height = 4, units = 'in')

p <- (p.panel1.deaths.pct + p.panel2.deaths.pct + p.panel3.deaths.pct) +  plot_annotation(title = 'Proportion of HIV Deaths Attributable to Effects of Depression', theme = theme(plot.title = element_text(hjust = 0.5, size=24)))

#ggsave("hiv_deaths_figure_pct.pdf", p, width = 16, height = 8, units = "in")
ggsave("hiv_deaths_figure_pct_20240819.pdf", p, width = 16, height = 8, units = "in")
```


```{r}
p <- p.overall.deaths.pct + ggpubr::ggarrange("", "", "")/(p.panel1.deaths.pct + p.panel2.deaths.pct + p.panel3.deaths.pct) +  plot_layout(widths = c(1, 3))
p
#ggsave("hiv_deaths_figure_pct_v2.pdf", p, width = 20, height = 10, units = "in")
ggsave("hiv_deaths_figure_pct_v2_20240819.pdf", p, width = 20, height = 10, units = "in")
```

```{r}
p <- (p.overall.deaths.pct + p.panel1.deaths.pct + p.panel2.deaths.pct + p.panel3.deaths.pct) +  plot_layout(ncol = 4)
p
#ggsave("hiv_deaths_figure_pct_v3.pdf", p, width = 20, height = 6, units = "in")
ggsave("hiv_deaths_figure_pct_v3_20240819.pdf", p, width = 20, height = 6, units = "in")
```


### HIV deaths difference panel 1
```{r}
p.panel1.deaths.diff <- differences.table %>% 
  filter(scenario_name == "baseline.art",
         Ages == "15-100",
         Time < 5) %>% 
  ggplot() + 
  geom_point(mapping = aes(x = Time, y = Died_from_HIV.diff),
                size = 2) + 
  geom_line(mapping = aes(x = Time, y = Died_from_HIV.diff),
                size = 1) + 
  geom_errorbar(mapping = aes(x = Time, ymin = Died_from_HIV.diff_95LL, ymax = Died_from_HIV.diff_95UL),
                size = 1, width = .5) + 
  expand_limits(x = 1, y = 0) +
  labs(x = "", y ="") + #  "HIV Deaths Attributable to\nHIV-Depression Interactions") + 
  scale_color_manual("All Interactions", values=c("black")) +
  scale_x_continuous(breaks = c(1,2,3,4), 
                     labels = c("Pre-ART\n1985-2005", "ART Scale-up\n2005-2015", "Universal ART\n2015-2025","Future\n2025-2035"),
                      expand = expansion(mult = c(0.01,.01))) + 
  #scale_y_continuous(breaks = seq(0,20,5), labels = c("0%", "5%", "10%", "15%", "20%")) + 
  scale_y_continuous(n.breaks = 6, expand = expansion(mult = c(0.01,.1)))+
  theme_bw(base_size=16) +
  theme(panel.grid.major = element_blank(),  
      panel.grid.minor = element_blank(),
      axis.text.x = element_text(color = 'black', angle = 45, vjust = 0.5))

p.panel1.deaths.diff

#ggsave("hiv_deaths_panel1.pdf", width = 8, height = 4, units = "in")
```


### HIV deaths differences panel 2
```{r}
p.panel2.deaths.diff <- differences.table %>% 
  filter(scenario_name %in% c("baseline.art.not.cmdinc", "decouple.art.tx", "decouple.art.hivinc.hivtr"),
         Ages == "15-100",
         Time < 5) %>% 
  ggplot() + 
  geom_point(mapping = aes(x = Time, y = Died_from_HIV.diff, color = factor(scenario_ix)),  show.legend = FALSE, size = 2) + 
  geom_line(mapping = aes(x = Time, y = Died_from_HIV.diff, color = factor(scenario_ix)),  show.legend = FALSE, size = 1) + 
  geom_errorbar(mapping = aes(x = Time, ymin = Died_from_HIV.diff_95LL, ymax = Died_from_HIV.diff_95UL, color = factor(scenario_ix)),
                size = 1, width = .5,
                show.legend = FALSE) + 
  expand_limits(x = 1, y = 0) +
  scale_color_manual(values=colors[2:4]) + 
  scale_x_continuous(breaks = c(1,2,3,4), 
                     labels = c("Pre-ART\n1985-2005", "ART Scale-up\n2005-2015", "Universal ART\n2015-2025","Future\n2025-2035"),
                     expand = expansion(mult = c(0.01,.01))) + 
  scale_y_continuous(n.breaks = 5, expand = expansion(mult = c(0.01,.05))) + 
  labs(x = "", y = "") + 
  theme_bw(base_size=16) + 
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        axis.text.x = element_text(color = 'black', angle = 45, vjust = 0.5))

p.panel2.deaths.diff

#ggsave("hiv_deaths_panel2.pdf", width = 8, height = 4, units = "in")
```

### HIV deaths differences panel 3
```{r}
p.panel3.deaths.diff <- differences.table %>% 
  filter(scenario_name %in% c("decouple.art.artdrop", "decouple.art.delay", "decouple.art.artswitch.artadh"),
         Ages == "15-100",
         Time < 5) %>% 
  ggplot() + 
  geom_point(mapping = aes(x = Time, y = Died_from_HIV.diff, color = factor(scenario_ix)), show.legend = FALSE, size = 2) +
  geom_line(mapping = aes(x = Time, y = Died_from_HIV.diff, color = factor(scenario_ix)), show.legend = FALSE, size = 1) +
  geom_errorbar(mapping = aes(x = Time, ymin = Died_from_HIV.diff_95LL, ymax = Died_from_HIV.diff_95UL, color = factor(scenario_ix)), 
                size = 1, width = .5,
                show.legend = FALSE) + 
  expand_limits(x = 1, y = 0) +
  scale_color_manual(values=colors[5:7]) + 
  scale_x_continuous(breaks = c(1,2,3,4), 
                     labels = c("Pre-ART\n1985-2005", "ART Scale-up\n2005-2015", "Universal ART\n2015-2025","Future\n2025-2035"),
                     expand = expansion(mult = c(0.01,.01))) + 
  scale_y_continuous(n.breaks = 5, expand = expansion(mult = c(0.01,.05))) + 
  labs(x = "", y = "") + 
  theme_bw(base_size=16) + 
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        axis.text.x = element_text(color = 'black', angle = 45, vjust = 0.5))

p.panel3.deaths.diff

#ggsave("hiv_deaths_panel3.pdf", width = 8, height = 4, units = "in")
```
### Combine in a grid and export
```{r}
#ggsave("hiv_deaths_overall_pct.pdf", p.overall.deaths.pct, width = 6, height = 4, units = 'in')

p <- (p.panel1.deaths.diff + p.panel2.deaths.diff + p.panel3.deaths.diff) +  plot_annotation(title = 'HIV Deaths Attributable to Effects of Depression', theme = theme(plot.title = element_text(hjust = 0.5, size=24)))

#ggsave("hiv_deaths_figure_diff.pdf", p, width = 16, height = 8, units = "in")
ggsave("hiv_deaths_figure_diff_202040819.pdf", p, width = 16, height = 8, units = "in")
```


```{r}
p <- p.overall.deaths.diff + ggpubr::ggarrange("", "", "")/(p.panel1.deaths.diff + p.panel2.deaths.diff + p.panel3.deaths.diff) +  plot_layout(widths = c(1, 3))
p
#ggsave("hiv_deaths_figure_diff_v2.pdf", p, width = 20, height = 10, units = "in")
ggsave("hiv_deaths_figure_diff_v2_20240819.pdf", p, width = 20, height = 10, units = "in")
```




## New Infections

### Infections differences for all scenarios
```{r}
p.overall.infections.pct <- differences.table %>% filter(Ages == "15-100", Period == "Past+Future") %>% 
  ggplot() + 
  geom_col(mapping = aes(x = -scenario_ix + 1, y = 100 * Newly.Infected.pct, color = factor(scenario_ix)), 
           size = .5, fill = "white",  show.legend = FALSE, position = "dodge") + 
  geom_errorbar(mapping = aes(x = -scenario_ix + 1, 
                              ymin = 100*Newly.Infected.pct_95LL, ymax = 100*Newly.Infected.pct_95UL, 
                              color = factor(scenario_ix)),
                size = .75, width = .75,  show.legend = FALSE) +
  labs(x = "", y = "") +  #"HIV Deaths Attributable to\nHIV-Depression Interactions\n(1985-2035)") + 
  expand_limits(x = 1, y = 0) + 
  scale_color_manual(breaks = seq(1,7,1), values=colors) +
  scale_y_continuous(breaks = seq(0,20,4), labels = c("0%", "4%", "8%", "12%", "16%", "20%"), expand = c(0.01,0.01)) + 
  #scale_y_continuous(breaks = seq(0,20,5), labels = c("0%", "5%", "10%", "15%", "20%")) + 
  # scale_x_continuous(breaks = seq(1,7,1), labels = c("All Interactions", "Elevated HIV\nIncidence","Elevated Depression\nIncidence",
  #                                                  "HIV Treatment\nDisruptions","Reduced ART\nAdherence", "Reduced ART\nRetention",
  #                                                  "Delays to\nART Uptake"
  #                                                  )) +
  scale_x_continuous(expand = expansion(mult = c(0.02, -.05))) + 
  #xlim(-6.5,.5)+
  theme_bw(base_size=16) + 
  theme(panel.grid.major = element_blank(), 
      panel.grid.minor = element_blank(),
      axis.ticks.y = element_blank(),
      axis.text.y = element_blank(),
      plot.margin = unit(c(0,0,0,0), "cm")) + coord_flip()

p.overall.infections.pct
```

```{r}
p.overall.infections.diff <- differences.table %>% filter(Ages == "15-100", Period == "Past+Future") %>% 
  ggplot() + 
  geom_col(mapping = aes(x = -scenario_ix + 1, y = Newly.Infected.diff, color = factor(scenario_ix)), 
           size = .5, fill = "white",  show.legend = FALSE, position = "dodge") + 
  geom_errorbar(mapping = aes(x = -scenario_ix + 1, 
                              ymin = Newly.Infected.diff_95LL, ymax = Newly.Infected.diff_95UL, 
                              color = factor(scenario_ix)),
                size = .75, width = .75,  show.legend = FALSE) +
  labs(x = "", y = "") +  #HIV Deaths Attributable to\nHIV-Depression Interactions\n(1985-2035)") + 
  expand_limits(x = 1, y = 0) + 
  scale_color_manual(breaks = seq(1,7,1), values=colors) +
  #scale_y_continuous(breaks = seq(0,20,4), labels = c("0%", "4%", "8%", "12%", "16%", "20%"), expand = c(0.01,0.01)) + 
  #scale_y_continuous(breaks = seq(0,20,5), labels = c("0%", "5%", "10%", "15%", "20%")) + 
  # scale_x_continuous(breaks = seq(1,7,1), labels = c("All Interactions", "Elevated HIV\nIncidence","Elevated Depression\nIncidence",
  #                                                  "HIV Treatment\nDisruptions","Reduced ART\nAdherence", "Reduced ART\nRetention",
  #                                                  "Delays to\nART Uptake"
  #                                                  )) +
  scale_x_continuous(expand = expansion(mult = c(0.02, -.05))) + 
  scale_y_continuous(expand = expansion(mult = c(0.01,.05))) + 
  #xlim(-6.5,.5)+
  theme_bw(base_size=16) + 
  theme(panel.grid.major = element_blank(), 
      panel.grid.minor = element_blank(),
      axis.ticks.y = element_blank(),
      axis.text.y = element_blank(),
      axis.text.x = element_text(hjust = .5),
      plot.margin = ) + coord_flip()

p.overall.infections.diff
```


### New Infections percentages panel 1
```{r}
p.panel1.infections.pct <- differences.table %>% 
  filter(scenario_name == "baseline.art",
         Ages == "15-100",
         Time < 5) %>% 
  ggplot() + 
  geom_point(mapping = aes(x = Time, y = 100*Newly.Infected.pct),
                size = 2) + 
  geom_line(mapping = aes(x = Time, y = 100*Newly.Infected.pct),
                size = 1) + 
  geom_errorbar(mapping = aes(x = Time, ymin = 100*Newly.Infected.pct_95LL, ymax = 100*Newly.Infected.pct_95UL),
                size = 1, width = .5) + 
  expand_limits(x = 1, y = 0) +
  labs(x = "", y = "") + # "HIV Deaths Attributable to\nHIV-Depression Interactions") + 
  scale_color_manual("All Interactions", values=c("black")) +
  scale_x_continuous(breaks = c(1,2,3,4), 
                     labels = c("Pre-ART\n1985-2005", "ART Scale-up\n2005-2015", "Universal ART\n2015-2025","Future\n2025-2035")) + 
  scale_y_continuous(breaks = seq(0,40,10), labels = c("0%", "10%", "20%", "30%", "40%"), expand = expansion(mult = c(0.01,.1))) + 
  theme_bw(base_size=16) +
  theme(panel.grid.major = element_blank(), 
      panel.grid.minor = element_blank(),
      axis.text.x = element_text(color = 'black', angle = 45, vjust = 0.5))

p.panel1.infections.pct

#ggsave("hiv_infections_panel1.pdf", width = 8, height = 4, units = "in")
```

### New Infections percentages panel 2
```{r}
p.panel2.infections.pct <- differences.table %>% 
  filter(scenario_name %in% c("baseline.art.not.cmdinc", "decouple.art.tx", "decouple.art.hivinc.hivtr"),
         Ages == "15-100",
         Time < 5) %>% 
  ggplot() + 
  geom_point(mapping = aes(x = Time, y = 100*Newly.Infected.pct, color = factor(scenario_ix)),  show.legend = FALSE, size = 2) + 
  geom_line(mapping = aes(x = Time, y = 100*Newly.Infected.pct, color = factor(scenario_ix)),  show.legend = FALSE, size = 1) + 
  geom_errorbar(mapping = aes(x = Time, ymin = 100*Newly.Infected.pct_95LL, ymax = 100*Newly.Infected.pct_95UL, color = factor(scenario_ix)),
                size = 1, width = .5,
                show.legend = FALSE) + 
  expand_limits(x = 1, y = 0) +
  scale_color_manual(values=colors[2:4]) + 
  scale_x_continuous(breaks = c(1,2,3,4), 
                     labels = c("Pre-ART\n1985-2005", "ART Scale-up\n2005-2015", "Universal ART\n2015-2025","Future\n2025-2035")) + 
  scale_y_continuous(breaks = c(0,4,8,12), labels = c("0%", "4%", "8%", "12%"), expand = expansion(mult = c(0.01,.2))) + 
  #ylim(0,12) +
  labs(x = "", y = "") + 
  theme_bw(base_size=16) + 
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        axis.text.x = element_text(color = 'black', angle = 45, vjust = 0.5))

p.panel2.infections.pct

#ggsave("hiv_infections_panel2.pdf", width = 8, height = 4, units = "in")
```

### New Infections percentages panel 3
```{r}
p.panel3.infections.pct <- differences.table %>% 
  filter(scenario_name %in% c("decouple.art.artdrop", "decouple.art.delay", "decouple.art.artswitch.artadh"),
         Ages == "15-100",
         Time < 5) %>% 
  ggplot() + 
  geom_point(mapping = aes(x = Time, y = 100*Newly.Infected.pct, color = factor(scenario_ix)), show.legend = FALSE, size = 2) +
  geom_line(mapping = aes(x = Time, y = 100*Newly.Infected.pct, color = factor(scenario_ix)), show.legend = FALSE, size = 1) +
  geom_errorbar(mapping = aes(x = Time, ymin = 100*Newly.Infected.pct_95LL, ymax = 100*Newly.Infected.pct_95UL, color = factor(scenario_ix)), 
                size = 1, width = .5,
                show.legend = FALSE) + 
  expand_limits(x = 1, y = 0) +
  scale_color_manual(values=colors[5:7]) + 
  scale_x_continuous(breaks = c(1,2,3,4), 
                     labels = c("Pre-ART\n1985-2005", "ART Scale-up\n2005-2015", "Universal ART\n2015-2025","Future\n2025-2035")) + 
  scale_y_continuous(breaks = seq(0,9,3), labels = c("0%", "3%", "6%", "9%"), expand = expansion(mult = c(0.01,.2))) + 
  labs(x = "", y = "") + 
  theme_bw(base_size=16) + 
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        axis.text.x = element_text(color = 'black', angle = 45, vjust = 0.5))

p.panel3.infections.pct
#ggsave("hiv_infections_panel3.pdf", width = 8, height = 4, units = "in")
```
### Combine in a grid and export
```{r}
#ggsave("hiv_deaths_overall_pct.pdf", p.overall.deaths.pct, width = 6, height = 4, units = 'in')

p <- (p.panel1.infections.pct + p.panel2.infections.pct + p.panel3.infections.pct) +  plot_annotation(title = 'Proportion of HIV Infections Attributable to Effects of Depression', theme = theme(plot.title = element_text(hjust = 0.5, size=24)))

#ggsave("hiv_infections_figure_pct.pdf", p, width = 16, height = 8, units = "in")
ggsave("hiv_infections_figure_pct_20240819.pdf", p, width = 16, height = 8, units = "in")
```

```{r}
p <- p.overall.infections.pct + ggpubr::ggarrange("", "", "")/(p.panel1.infections.pct + p.panel2.infections.pct + p.panel3.infections.pct) +  plot_layout(widths = c(1, 3))
p
#ggsave("hiv_infections_figure_pct_v2.pdf", p, width = 20, height = 10, units = "in")
ggsave("hiv_infections_figure_pct_v2_20240819.pdf", p, width = 20, height = 10, units = "in")
```
```{r}
p <- (p.overall.infections.pct + p.panel1.infections.pct + p.panel2.infections.pct + p.panel3.infections.pct) +  plot_layout(ncol = 4)
p
#ggsave("hiv_infections_figure_pct_v3.pdf", p, width = 20, height = 6, units = "in")
ggsave("hiv_infections_figure_pct_v3_20240819.pdf", p, width = 20, height = 6, units = "in")
```

### Grid with all panels together
```{r}
p1 <- ((p.panel1.deaths.pct + p.panel2.deaths.pct + p.panel3.deaths.pct) +  
         plot_annotation(title = 'Proportion of HIV Deaths Attributable to Effects of Depression', 
                         theme = theme(plot.title = element_text(hjust = 0.5, size=24))))
       
p2 <- ((p.panel1.infections.pct + p.panel2.infections.pct + p.panel3.infections.pct) +  
  plot_annotation(title = 'Proportion of HIV Infections Attributable to Effects of Depression', 
                  theme = theme(plot.title = element_text(hjust = 0.5, size=24))))

p = p1/p2
p
#ggsave("hiv_pct_figure.pdf", p, width = 16, height = 20, units = "in")
ggsave("hiv_pct_figure_20240819.pdf", p, width = 16, height = 20, units = "in")
```

### New Infections difference panel 1
```{r}
p.panel1.infs.diff <- differences.table %>% 
  filter(scenario_name == "baseline.art",
         Ages == "15-100",
         Time < 5) %>% 
  ggplot() + 
  geom_point(mapping = aes(x = Time, y = Newly.Infected.diff),
                size = 2) + 
  geom_line(mapping = aes(x = Time, y = Newly.Infected.diff),
                size = 1) + 
  geom_errorbar(mapping = aes(x = Time, ymin = Newly.Infected.diff_95LL, ymax = Newly.Infected.diff_95UL),
                size = 1, width = .5) + 
  expand_limits(x = 1, y = 0) +
  labs(x = "", y ="") + #  "HIV Deaths Attributable to\nHIV-Depression Interactions") + 
  scale_color_manual("All Interactions", values=c("black")) +
  scale_x_continuous(breaks = c(1,2,3,4), 
                     labels = c("Pre-ART\n1985-2005", "ART Scale-up\n2005-2015", "Universal ART\n2015-2025","Future\n2025-2035"),
                      expand = expansion(mult = c(0.01,.01))) + 
  #scale_y_continuous(breaks = seq(0,20,5), labels = c("0%", "5%", "10%", "15%", "20%")) + 
  scale_y_continuous(n.breaks = 6, expand = expansion(mult = c(0.01,.1)))+
  theme_bw(base_size=16) +
  theme(panel.grid.major = element_blank(), 
      panel.grid.minor = element_blank(),
      axis.text.x = element_text(color = 'black', angle = 45, vjust = 0.5))

p.panel1.infs.diff
```


### New Infections difference panel 2
```{r}
p.panel2.infs.diff <- differences.table %>% 
  filter(scenario_name %in% c("baseline.art.not.cmdinc", "decouple.art.tx", "decouple.art.hivinc.hivtr"),
         Ages == "15-100",
         Time < 5) %>% 
  ggplot() + 
  geom_point(mapping = aes(x = Time, y = Newly.Infected.diff, color = factor(scenario_ix)),  show.legend = FALSE, size = 2) + 
  geom_line(mapping = aes(x = Time, y = Newly.Infected.diff, color = factor(scenario_ix)),  show.legend = FALSE, size = 1) + 
  geom_errorbar(mapping = aes(x = Time, ymin = Newly.Infected.diff_95LL, ymax = Newly.Infected.diff_95UL, color = factor(scenario_ix)),
                size = 1, width = .5,
                show.legend = FALSE) + 
  expand_limits(x = 1, y = 0) +
  scale_color_manual(values=colors[2:4]) + 
  scale_x_continuous(breaks = c(1,2,3,4), 
                     labels = c("Pre-ART\n1985-2005", "ART Scale-up\n2005-2015", "Universal ART\n2015-2025","Future\n2025-2035"),
                     expand = expansion(mult = c(0.01,.01))) + 
  scale_y_continuous(n.breaks = 5, expand = expansion(mult = c(0.01,.05))) + 
  labs(x = "", y = "") + 
  theme_bw(base_size=16) + 
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        axis.text.x = element_text(color = 'black', angle = 45, vjust = 0.5))

p.panel2.infs.diff
```

### New Infections difference panel 3
```{r}
p.panel3.infs.diff <- differences.table %>% 
  filter(scenario_name %in% c("decouple.art.artdrop", "decouple.art.delay", "decouple.art.artswitch.artadh"),
         Ages == "15-100",
         Time < 5) %>% 
  ggplot() + 
  geom_point(mapping = aes(x = Time, y = Newly.Infected.diff, color = factor(scenario_ix)), show.legend = FALSE, size = 2) +
  geom_line(mapping = aes(x = Time, y = Newly.Infected.diff, color = factor(scenario_ix)), show.legend = FALSE, size = 1) +
  geom_errorbar(mapping = aes(x = Time, ymin = Newly.Infected.diff_95LL, ymax = Newly.Infected.diff_95UL, color = factor(scenario_ix)), 
                size = 1, width = .5,
                show.legend = FALSE) + 
  expand_limits(x = 1, y = 0) +
  scale_color_manual(values=colors[5:7]) + 
  scale_x_continuous(breaks = c(1,2,3,4), 
                     labels = c("Pre-ART\n1985-2005", "ART Scale-up\n2005-2015", "Universal ART\n2015-2025","Future\n2025-2035"),
                     expand = expansion(mult = c(0.01,.01))) + 
  scale_y_continuous(breaks = c(0, 2500, 5000, 7500, 10000), expand = expansion(mult = c(0.01,.05))) + 
  ylim(0,10000) + 
  labs(x = "", y = "") + 
  theme_bw(base_size=16) + 
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        axis.text.x = element_text(color = 'black', angle = 45, vjust = 0.5))

p.panel3.infs.diff
```
### Combine in a grid and export
```{r}
p <- (p.panel1.infs.diff + p.panel2.infs.diff + p.panel3.infs.diff) +  plot_annotation(title = 'HIV Infections Attributable to Effects of Depression', theme = theme(plot.title = element_text(hjust = 0.5, size=24)))

#ggsave("hiv_infections_figure_diff.pdf", p, width = 16, height = 8, units = "in")
ggsave("hiv_infections_figure_diff_20240819.pdf", p, width = 16, height = 8, units = "in")
```

```{r}
p <- p.overall.infections.diff + ggpubr::ggarrange("", "", "")/(p.panel1.infs.diff + p.panel2.infs.diff + p.panel3.infs.diff) +  plot_layout(widths = c(1, 3))
p
#ggsave("hiv_infections_figure_diff_v2.pdf", p, width = 20, height = 10, units = "in")
ggsave("hiv_infections_figure_diff_v2_20240819.pdf", p, width = 20, height = 10, units = "in")
```


## Impact of ART Figures

```{r}
#impact.table %>% View

impact.table <- read.csv("impact_of_art_table_20240719.csv")

impact.table <- impact.table %>% 
  mutate(Time =case_match(
    Period,
    "Pre-ART" ~ 1,
    "ART Scaleup" ~ 2,
    "Universal ART" ~ 3,
    "Future" ~ 4
  ))

```

```{r}
p.impact.deaths <- impact.table %>% 
  filter(Ages == "15-100",
         Metric == "Died_from_HIV",
         Time <5) %>% 
  group_by(Period, Years, Ages, Metric) %>% slice(1) %>% ungroup( ) %>% 
  ggplot() + 
  geom_point(mapping = aes(x = Time, y = -art.impact.ppyoa),
                size = 2) + 
  geom_line(mapping = aes(x = Time, y = -art.impact.ppyoa),
                size = 1) + 
  geom_errorbar(mapping = aes(x = Time, ymin = -art.impact.ppyoa_95LL, ymax = -art.impact.ppyoa_95UL),
                size = 1) + 
  expand_limits(x = 1, y = 0) +
  #labs(x = "", y = "Reduction in HIV Deaths Averted \nPer Person-Year on ART") + 
  labs(x = "", y = "") + 
  scale_color_manual("All Interactions", values=c("black")) +
  scale_x_continuous(breaks = c(1,2,3,4), 
                    labels = c("Pre-ART\n1985-2005", "ART Scale-up\n2005-2015", "Universal ART\n2015-2025","Future\n2025-2035")) + 
  #scale_y_continuous(breaks = seq(0,-20,-5), labels = c("0%", "-5%", "-10%", "-15%", "-20%")) + 
  theme_bw(base_size=16) + 
  theme(panel.grid.major = element_blank(), 
      panel.grid.minor = element_blank(),
      axis.text = element_text(color = 'black'))

p.impact.deaths

#ggsave("hiv_impact_deaths.pdf", width = 8, height = 4, units = "in")
ggsave("hiv_impact_deaths_20240819.pdf", width = 8, height = 4, units = "in")
```

```{r}
p.impact.infections <- impact.table %>% 
  filter(Ages == "15-100",
         Metric == "Newly.Infected",
         Time <5) %>% 
  group_by(Period, Years, Ages, Metric) %>% slice(1) %>% ungroup( ) %>% 
  ggplot() + 
  geom_point(mapping = aes(x = Time, y = -art.impact.ppyoa),
                size = 2) + 
  geom_line(mapping = aes(x = Time, y = -art.impact.ppyoa),
                size = 1) + 
  geom_errorbar(mapping = aes(x = Time, ymin = -art.impact.ppyoa_95LL, ymax = -art.impact.ppyoa_95UL),
                size = 1) + 
  expand_limits(x = 1, y = 0) +
  #labs(x = "", y = "Reduction in HIV Infections Averted \nPer Person-Year on ART") + 
  labs(x = "", y = "") + 
  scale_color_manual("All Interactions", values=c("black")) +
  scale_x_continuous(breaks = c(1,2,3,4), 
                     labels = c("Pre-ART\n1985-2005", "ART Scale-up\n2005-2015", "Universal ART\n2015-2025","Future\n2025-2035")) + 
  #scale_y_continuous(breaks = seq(0,-20,-5), labels = c("0%", "-5%", "-10%", "-15%", "-20%")) + 
  scale_y_continuous(n.breaks = 4)+ 
  ylim(0,.003) + 
  theme_bw(base_size=16) + 
  theme(panel.grid.major = element_blank(), 
      panel.grid.minor = element_blank(),
      axis.text = element_text(color = 'black'))

p.impact.infections

#ggsave("hiv_impact_infections.pdf", width = 8, height = 4, units = "in")
ggsave("hiv_impact_infections_20240819.pdf", width = 8, height = 4, units = "in")

```

```{r}
p.impact.deaths.pct <- impact.table %>% 
  filter(Ages == "15-100",
         Metric == "Died_from_HIV",
         Time <5) %>% 
  group_by(Period, Years, Ages, Metric) %>% slice(1) %>% ungroup( ) %>% 
  ggplot() + 
  geom_point(mapping = aes(x = Time, y = -100*art.impact.ppyoa.pct),
                size = 2) + 
  geom_line(mapping = aes(x = Time, y = -100*art.impact.ppyoa.pct),
                size = 1) + 
  geom_errorbar(mapping = aes(x = Time, ymin = -100*art.impact.ppyoa.pct_95LL, ymax = -100*art.impact.ppyoa.pct_95UL),
                size = 1) + 
  expand_limits(x = 1, y = 0) +
  #labs(x = "", y = "% Reduction in HIV Deaths Averted \nPer Person-Year on ART") + 
  labs(x = "", y = "") + 
  scale_color_manual("All Interactions", values=c("black")) +
  scale_x_continuous(breaks = c(1,2,3,4), 
                     labels = c("Pre-ART\n1985-2005", "ART Scale-up\n2005-2015", "Universal ART\n2015-2025","Future\n2025-2035")) + 
  ylim(0,12) + 
  scale_y_continuous(breaks = seq(0,5,1), labels = c("0%", "1%", "2%", "3%", "4%", "5%"), expand = expansion(mult = c(0.01,.1))) + 
  theme_bw(base_size=16) + 
  theme(panel.grid.major = element_blank(), 
      panel.grid.minor = element_blank(),
      axis.text = element_text(color = 'black'))

p.impact.deaths.pct

#ggsave("hiv_impact_deaths_pct.pdf", width = 8, height = 4, units = "in")
ggsave("hiv_impact_deaths_pct_20240819.pdf", width = 8, height = 4, units = "in")

```

```{r}
p.impact.infections.pct <- impact.table %>% 
  filter(Ages == "15-100",
         Metric == "Newly.Infected",
         Time <5) %>% 
  group_by(Period, Years, Ages, Metric) %>% slice(1) %>% ungroup( ) %>% 
  ggplot() + 
  geom_point(mapping = aes(x = Time, y = -100*art.impact.ppyoa.pct),
                size = 2) + 
  geom_line(mapping = aes(x = Time, y = -100*art.impact.ppyoa.pct),
                size = 1) + 
  geom_errorbar(mapping = aes(x = Time, ymin = -100*art.impact.ppyoa.pct_95LL, ymax = -100*art.impact.ppyoa.pct_95UL),
                size = 1) + 
  expand_limits(x = 1, y = 0) +
  #labs(x = "", y = "% Reduction in HIV Infections Averted \nPer Person-Year on ART") + 
  labs(x = "", y = "") + 
  scale_color_manual("All Interactions", values=c("black")) +
  scale_x_continuous(breaks = c(1,2,3,4), 
                     labels = c("Pre-ART\n1985-2005", "ART Scale-up\n2005-2015", "Universal ART\n2015-2025","Future\n2025-2035")) + 
  ylim(0,12) + 
  scale_y_continuous(breaks = seq(0,12,3), labels = c("0%", "3%", "6%", "9%", "12%"), expand = expansion(mult = c(0.01,.1))) + 
  theme_bw(base_size=16) + 
  theme(panel.grid.major = element_blank(), 
      panel.grid.minor = element_blank(),
      axis.text = element_text(color = 'black'))

p.impact.infections.pct

#ggsave("hiv_impact_infections_pct.pdf", width = 8, height = 4, units = "in")
ggsave("hiv_impact_infections_pct_20240819.pdf", width = 8, height = 4, units = "in")
```

## Figure 2 - Time Series

### HIV Prevalence
```{r}
croi.prev.data <- sim.results.all %>% 
  filter(scenario_name %in% c("decouple.art", "baseline.art")) %>% 
  filter(Age >= 15, Age < 50) %>% 
  group_by(Year, Gender, scenario_name, sim.id) %>% 
  summarize(Population = sum(Population*pop.scaling.factor), 
            Infected = sum(Infected*pop.scaling.factor), .groups = 'keep') %>% 
  ungroup() %>% 
  mutate(Prevalence = case_when(Population == 0 ~ 0,
                                Population > 0 ~ Infected/Population)) %>% 
  mutate(Gender = case_when(Gender==0 ~ "Male", Gender==1 ~ "Female"))
  
croi.prev.data.mean <- croi.prev.data %>% 
  group_by(Year, Gender, scenario_name) %>% 
  summarize(Prevalence = mean(Prevalence), .groups = "keep")

p <- ggplot() +
  geom_line(data= croi.prev.data.mean %>% filter(Year > 1985, Year <=2035),
          aes(x=Year, y=Prevalence, group=scenario_name, color=scenario_name), 
          linewidth=2,  show.legend = FALSE) +
  geom_point(data = obs.prev.sheet.base %>%
               filter(Province == 'All', AgeBin == "[15:50)", Gender %in% c("Male", "Female")),
             mapping = aes(x = Year, y = Prevalence) , color = 'black', size = 3, shape = 15) + 
  geom_errorbar(data = obs.prev.sheet.base %>%
             filter(Province == 'All', AgeBin == "[15:50)", Gender %in% c("Male", "Female")),
             mapping = aes(x = Year, ymin = lb, ymax = ub), color = 'black', size = 1)+
  facet_wrap(~ Gender, ncol=2) +
  theme_bw(base_size=16) +
  guides(fill = guide_legend(keywidth = 2, keyheight = 1)) +
  scale_x_continuous(breaks = seq(1985,2035,10)) +
  scale_color_manual(values=c("orange", "darkgreen"))  +
  theme(legend.position="bottom") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, size = 20),
        axis.text.y = element_text(size = 20)) +
  theme(strip.background = element_blank(),
        strip.text.x = element_blank(),
        axis.title.x=element_blank(),
        axis.title.y=element_blank()) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1), 
                     breaks = seq(0,0.25,0.05), limits=c(0, 0.25))

p

#ggsave(filename = "/gpfs/data/bershteynlab/EMOD/citrod01/MATUMAINI/Analysis/Figures_manuscript/Figure_2_HIV_prev_time.pdf", width = 10, height = 5, units = "in")
```
### HIV Infections
```{r}
data <- sim.results.all %>% 
  filter(scenario_name %in% c("baseline.art", "decouple.art"))%>% 
  mutate(Year = ceiling(Year)) %>%
  filter(Year >= 1985, Year <=2035) %>% 
  group_by(Year, Gender, sim.id, sim.ix, scenario_name) %>% 
  summarize(NewCases = sum(Newly.Infected * pop.scaling.factor), .groups = 'keep') %>%  
  ungroup() %>% 
  group_by(Year, Gender,scenario_name) %>% 
  summarize(NewCases.sd = sd(NewCases), NewCases = mean(NewCases)) %>% 
  ungroup()# %>% 

p <- ggplot() +
     geom_line(data,
               mapping = aes(x=Year, y=NewCases, group=scenario_name, color=scenario_name), linewidth=2,  show.legend = FALSE) +
    facet_wrap(~ Gender, ncol=2) +
    #xlab("Year")+
    #xlim(c(date.start, date.end)) +
    #ylab("Prevalence") +
    theme_bw(base_size=16) +
    guides(fill = guide_legend(keywidth = 2, keyheight = 1)) +
    scale_x_continuous(breaks = seq(1985,2035,10)) + 
  ylab("") + 
  scale_color_manual(values=c("orange", "darkgreen"))  +
  theme(legend.position="bottom") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, size = 20),
        axis.text.y = element_text(size = 20)) +
  theme(strip.background = element_blank(),
        strip.text.x = element_blank(),
        axis.title.x=element_blank(),
        axis.title.y=element_blank()) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) + 
  scale_y_continuous(limits = c(0, 30000), breaks = seq(0,30000,10000), labels = c("0","10,000","20,000", "30,000"))
# +
#   scale_y_continuous(labels = scales::percent_format(accuracy = 1), 
#                      breaks = seq(0,0.25,0.05), limits=c(0, 0.25))

p

ggsave(filename = "/gpfs/data/bershteynlab/EMOD/citrod01/MATUMAINI/Analysis/Figures_manuscript/Figure_2_HIV_newcases.pdf", width = 10, height = 5, units = "in")
```

### HIV deaths

```{r}
data <- sim.results.all %>% 
  filter(scenario_name %in% c("baseline.art", "decouple.art"))%>% 
  mutate(Year = ceiling(Year)) %>%
  filter(Year >= 1985, Year <=2035) %>% 
  group_by(Year, Gender, sim.ix, sim.id, scenario_name) %>% 
  summarize(Deaths = sum(Died_from_HIV * pop.scaling.factor), .groups = 'keep') %>%  
  ungroup() %>% 
  group_by(Year, Gender, scenario_name) %>% 
  summarize(Deaths.sd = sd(Deaths), Deaths = mean(Deaths)) %>% 
  ungroup()# %>% 

p <- ggplot() +
     geom_line(data,
               mapping = aes(x=Year, y=Deaths, group=scenario_name, color=scenario_name), linewidth=2,  show.legend = FALSE) +
    facet_wrap(~ Gender, ncol=2) +
    #xlab("Year")+
    #xlim(c(date.start, date.end)) +
    #ylab("Prevalence") +
    theme_bw(base_size=16) +
    guides(fill = guide_legend(keywidth = 2, keyheight = 1)) +
    scale_x_continuous(breaks = seq(1985,2035,10)) + 
  ylab("") + 
  scale_color_manual(values=c("orange", "darkgreen"))  +
  theme(legend.position="bottom") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, size = 20),
        axis.text.y = element_text(size = 20)) +
  theme(strip.background = element_blank(),
        strip.text.x = element_blank(),
        axis.title.x=element_blank(),
        axis.title.y=element_blank()) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) + 
  scale_y_continuous(limits = c(0, 18000), breaks = seq(0,18000,4000), labels = c(0,"4,000","8,000","12,000","16,000"))
# +
#   scale_y_continuous(labels = scales::percent_format(accuracy = 1), 
#                      breaks = seq(0,0.25,0.05), limits=c(0, 0.25))

p

ggsave(filename = "/gpfs/data/bershteynlab/EMOD/citrod01/MATUMAINI/Analysis/Figures_manuscript/Figure_2_HIV_deaths.pdf", width = 10, height = 5, units = "in")
```

### Depression prevalence

```{r}
data.cmd <- sim.results.all %>% 
  filter(Age > 18) %>% 
  mutate(Year = floor(Year)) %>% 
  mutate(HIVneg = Population - Infected) %>% 
  group_by(Year, Gender, sim.id, IP_Key.CMDStatus, scenario_name) %>% 
  summarize(Population = sum(Population),
            HIVneg = sum(HIVneg),
            Infected = sum(Infected), .groups = 'keep') %>% 
  ungroup() %>% 
  pivot_wider(id_cols = c(Year, Gender, sim.id, scenario_name),
              names_from = c(IP_Key.CMDStatus),
              values_from = c(Population, HIVneg, Infected))  %>% 
  mutate(Population_total = Population_CMD_pos + Population_CMD_neg + Population_CMD_recovered + Population_CMD_treated,
         HIVneg_total = HIVneg_CMD_pos + HIVneg_CMD_neg + HIVneg_CMD_recovered + HIVneg_CMD_treated,
         Infected_total = Infected_CMD_pos + Infected_CMD_neg + Infected_CMD_recovered + Infected_CMD_treated) %>% 
  mutate(CMD_prev_overall = case_when(Population_total == 0 ~ 0,
                                    Population_total > 0 ~ Population_CMD_pos/Population_total),
         CMD_prev_HIVneg = case_when(HIVneg_total == 0 ~ 0,
                                    HIVneg_total > 0 ~ HIVneg_CMD_pos/HIVneg_total),
         CMD_prev_Infected = case_when(Infected_total == 0 ~ 0,
                                    Infected_total > 0 ~ Infected_CMD_pos/Infected_total)) %>% 
  mutate(Gender = case_when(Gender==0 ~ "Male", Gender==1 ~ "Female"))

data.cmd.mean <- data.cmd %>% 
  group_by(Year, Gender, scenario_name) %>%
  summarize(Overall = mean(CMD_prev_overall), Overall_sd = sd(CMD_prev_overall),
            HIVneg = mean(CMD_prev_HIVneg), HIVneg_sd = sd(CMD_prev_HIVneg),
            Infected = mean(CMD_prev_Infected), Infected_sd = sd(CMD_prev_Infected),
            .groups = "keep") %>% 
  ungroup()

p <- data.cmd.mean %>% filter(
  scenario_name %in% c("baseline.art", "decouple.art"),
  Year >=1985, Year <=2035) %>% 
                  select(Year, Gender, Overall, scenario_name) %>% 
                  pivot_longer(cols = c(Overall),
                               names_to = "Depression.Prevalence", 
                               values_to = "CMD_prev") %>% 
  ggplot() + 
  geom_line(mapping = aes(x = Year, y = CMD_prev, color = scenario_name, groups = scenario_name), 
            linewidth = 2, show.legend = FALSE) + 
  scale_y_continuous(limits = c(0.05,.22)) + 
  ylab("Depression Prevalence (%)") + 
  facet_wrap(~ Gender, ncol=2) +
  #ggtitle("Depression Prevalence by HIV status") + 
  theme_bw(base_size=16) +
  guides(fill = guide_legend(keywidth = 2, keyheight = 1)) +
  scale_x_continuous(breaks = seq(1985,2035,10)) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1), breaks = seq(0,0.1,0.05), limits=c(0, 0.12))  + 
  #scale_color_manual(values=c("#B633B0", "#2578A4")) +
  scale_color_manual(values=c("orange", "darkgreen")) +
  theme(legend.position="bottom") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, size = 20),
        axis.text.y = element_text(size = 20)) +
  #theme(strip.background = element_rect(colour="black", fill="white")) +
  theme(strip.background = element_blank(),
        strip.text.x = element_blank(),
        axis.title.x=element_blank(),
        axis.title.y=element_blank()) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())

p

ggsave(filename = "/gpfs/data/bershteynlab/EMOD/citrod01/MATUMAINI/Analysis/Figures_manuscript/Figure_2_CMD_prev.pdf",
       width = 10, height = 5, units = "in")
```



## Sensitivity Analysis

### Importing data

#### Increased CMD incidence, LL

```{r}
sim.results.sa.cmdinc.LL <- sim.results.baseline.art.not.cmdinc

sim.results.sa.cmdinc.LL$scenario_name <-  "sa.cmdinc.LL"
```


#### Increased CMD incidence, UL

```{r}
# August 2024
experiment.path = "/gpfs/scratch/citrod01/experiments/MATUMAINI/manuscript/Baseline-campaign_MATUMAINI_202305_cmdinc_UL-sa_cmdinc_UL___2024_08_14_19_56_52_052418"

sim.results.sa.cmdinc.UL <- EMODAnalyzeR::read.simulation.results.bigpurple(
  experiment_path = experiment.path,
  scenario_name = 'sa.cmdinc.UL',
  summarize_columns = c("Population","Infected", "On_ART",
                        "Died", "Died_from_HIV",
                        "Newly.Infected","Diagnosed"),
  stratify_columns = c("Year", "Gender", "Age", "IP_Key.CMDStatus"),
  min_age_inclusive = 0,
  max_age_inclusive = 99
)
```


#### Increased HIV incidence, LL

```{r}
# August 2024
experiment.path = "/gpfs/scratch/citrod01/experiments/MATUMAINI/manuscript/Baseline-campaign_MATUMAINI_202305-sa_hivinc_LL___2024_08_14_19_59_22_393749"

sim.results.sa.hivinc.LL <- EMODAnalyzeR::read.simulation.results.bigpurple(
  experiment_path = experiment.path,
  scenario_name = 'sa.hivinc.LL',
  summarize_columns = c("Population","Infected", "On_ART",
                        "Died", "Died_from_HIV",
                        "Newly.Infected","Diagnosed"),
  stratify_columns = c("Year", "Gender", "Age", "IP_Key.CMDStatus"),
  min_age_inclusive = 0,
  max_age_inclusive = 99
)
```

#### Increased HIV incidence, UL

```{r}
# August 2024
experiment.path = "/gpfs/scratch/citrod01/experiments/MATUMAINI/manuscript/Baseline-campaign_MATUMAINI_202305-sa_hivinc_UL___2024_08_14_20_01_27_108439"

sim.results.sa.hivinc.UL <- EMODAnalyzeR::read.simulation.results.bigpurple(
  experiment_path = experiment.path,
  scenario_name = 'sa.hivinc.UL',
  summarize_columns = c("Population","Infected", "On_ART",
                        "Died", "Died_from_HIV",
                        "Newly.Infected","Diagnosed"),
  stratify_columns = c("Year", "Gender", "Age", "IP_Key.CMDStatus"),
  min_age_inclusive = 0,
  max_age_inclusive = 99
)
```

#### ART Adherence, LL

```{r}
# August 2024
experiment.path = "/gpfs/scratch/citrod01/experiments/MATUMAINI/manuscript/Baseline-campaign_MATUMAINI_202305-sa_artadh_LL___2024_08_14_20_03_52_900803"

sim.results.sa.artadh.LL <- EMODAnalyzeR::read.simulation.results.bigpurple(
  experiment_path = experiment.path,
  scenario_name = 'sa.artadh.LL',
  summarize_columns = c("Population","Infected", "On_ART",
                        "Died", "Died_from_HIV",
                        "Newly.Infected","Diagnosed"),
  stratify_columns = c("Year", "Gender", "Age", "IP_Key.CMDStatus"),
  min_age_inclusive = 0,
  max_age_inclusive = 99
)
```

#### ART Adherence, UL

```{r}
# August 2024
experiment.path = "/gpfs/scratch/citrod01/experiments/MATUMAINI/manuscript/Baseline-campaign_MATUMAINI_202305-sa_artadh_UL___2024_08_14_20_06_01_641842"

sim.results.sa.artadh.UL <- EMODAnalyzeR::read.simulation.results.bigpurple(
  experiment_path = experiment.path,
  scenario_name = 'sa.artadh.UL',
  summarize_columns = c("Population","Infected", "On_ART",
                        "Died", "Died_from_HIV",
                        "Newly.Infected","Diagnosed"),
  stratify_columns = c("Year", "Gender", "Age", "IP_Key.CMDStatus"),
  min_age_inclusive = 0,
  max_age_inclusive = 99
)
```

#### ART Dropout, LL

```{r}
# August 2024
experiment.path = "/gpfs/scratch/citrod01/experiments/MATUMAINI/manuscript/Baseline-campaign_MATUMAINI_202305-sa_artdrop_LL___2024_08_14_20_08_04_821122"

sim.results.sa.artdrop.LL <- EMODAnalyzeR::read.simulation.results.bigpurple(
  experiment_path = experiment.path,
  scenario_name = 'sa.artdrop.LL',
  summarize_columns = c("Population","Infected", "On_ART",
                        "Died", "Died_from_HIV",
                        "Newly.Infected","Diagnosed"),
  stratify_columns = c("Year", "Gender", "Age", "IP_Key.CMDStatus"),
  min_age_inclusive = 0,
  max_age_inclusive = 99
)
```

#### ART Dropout, UL

```{r}
# August 2024
experiment.path = "/gpfs/scratch/citrod01/experiments/MATUMAINI/manuscript/Baseline-campaign_MATUMAINI_202305-sa_artdrop_UL___2024_08_14_20_10_14_203861"

sim.results.sa.artdrop.UL <- EMODAnalyzeR::read.simulation.results.bigpurple(
  experiment_path = experiment.path,
  scenario_name = 'sa.artdrop.UL',
  summarize_columns = c("Population","Infected", "On_ART",
                        "Died", "Died_from_HIV",
                        "Newly.Infected","Diagnosed"),
  stratify_columns = c("Year", "Gender", "Age", "IP_Key.CMDStatus"),
  min_age_inclusive = 0,
  max_age_inclusive = 99
)
```

#### Delay to testing, LL

```{r}
# August 2024
experiment.path = "/gpfs/scratch/citrod01/experiments/MATUMAINI/manuscript/Baseline-campaign_MATUMAINI_202305-sa_delay_LL___2024_08_14_20_12_19_011832"

sim.results.sa.delay.LL <- EMODAnalyzeR::read.simulation.results.bigpurple(
  experiment_path = experiment.path,
  scenario_name = 'sa.delay.LL',
  summarize_columns = c("Population","Infected", "On_ART",
                        "Died", "Died_from_HIV",
                        "Newly.Infected","Diagnosed"),
  stratify_columns = c("Year", "Gender", "Age", "IP_Key.CMDStatus"),
  min_age_inclusive = 0,
  max_age_inclusive = 99
)
```

#### Delay to testing, UL

```{r}
# August 2024
experiment.path = "/gpfs/scratch/citrod01/experiments/MATUMAINI/manuscript/Baseline-campaign_MATUMAINI_202305-sa_delay_UL___2024_08_14_20_14_47_027346"

sim.results.sa.delay.UL <- EMODAnalyzeR::read.simulation.results.bigpurple(
  experiment_path = experiment.path,
  scenario_name = 'sa.delay.UL',
  summarize_columns = c("Population","Infected", "On_ART",
                        "Died", "Died_from_HIV",
                        "Newly.Infected","Diagnosed"),
  stratify_columns = c("Year", "Gender", "Age", "IP_Key.CMDStatus"),
  min_age_inclusive = 0,
  max_age_inclusive = 99
)
```

#### Join data together and rescale

```{r}
sa.results.all <- rbind(
  sim.results.baseline.art,
  sim.results.sa.cmdinc.LL,
  sim.results.sa.cmdinc.UL,
  sim.results.sa.hivinc.LL,
  sim.results.sa.hivinc.UL,
  sim.results.sa.artadh.LL,
  sim.results.sa.artadh.UL,
  sim.results.sa.artdrop.LL,
  sim.results.sa.artdrop.UL,
  sim.results.sa.delay.LL,
  sim.results.sa.delay.UL
)

CENSUS_YEAR = 2009
KEN_CENSUS_POP = 5352385

sim.results.pop.scaling <- sa.results.all %>% 
      filter(Year == CENSUS_YEAR) %>%
      group_by(sim.ix, scenario_name) %>%
      summarize(total.pop = sum(Population), .groups = 'keep') %>% 
      mutate(pop.scaling.factor = KEN_CENSUS_POP/total.pop)

sa.results.all <- sa.results.all %>% 
  inner_join(
    sim.results.pop.scaling,
    by = c("sim.ix", "scenario_name")
  )
```

### Calculate metrics

We are going to make tornado plots, which show the difference between baseline and each of these sensitivity analysis scenarios.

We are going to do this for a bunch of different time periods and a bunch of different age groups, for the sake of being thorough.

```{r}
age_min_list = c(15, 25, 15, 50)
age_max_list = c(25, 50, 100, 100)

start_year_list = c(1985, 2005, 2015, 2025, 1985, 1985)
end_year_list = c(2005, 2015, 2025, 2035, 2025, 2035)
label_list = c("Pre-ART", "ART Scaleup", "Universal ART", "Future", "Past Pandemic", "Past+Future")

scenario_names <- sa.results.all$scenario_name %>% unique
scenario_names <- scenario_names[scenario_names != "baseline.art"]

sa.differences.table <- data.table()

for (i in seq(1:length(age_min_list))){
  for (j in seq(1:length(start_year_list)) ){
    for (k in seq(1:length(scenario_names))) {

      age_min = age_min_list[[i]]
      age_max = age_max_list[[i]]
      start_year = start_year_list[[j]]
      end_year = end_year_list[[j]]
      
      holder <- aggregate.data.differences(sa.results.all,
                                           scenario.name = scenario_names[[k]],
                                           start_year, end_year, age_min,age_max,
                                           comparison_scenario = "baseline.art") %>% 
               mutate(Ages = paste0(age_min, "-", age_max),
                      Years = paste0(start_year,"-",end_year),
                      Period = label_list[[j]])
      
      sa.differences.table <- rbind(sa.differences.table, holder)      
      
    }
  }
} 

```


```{r}
sa.differences.table <- sa.differences.table %>% 
  select(
    "Ages", "Period", "Years", "scenario_name",
    "Newly.Infected.diff", "Newly.Infected.diff_95LL", "Newly.Infected.diff_95UL", "Newly.Infected.diff.sd", 
    "Newly.Infected.pct", "Newly.Infected.pct_95LL", "Newly.Infected.pct_95UL", "Newly.Infected.pct.sd" ,
    "Died_from_HIV.diff", "Died_from_HIV.diff_95LL", "Died_from_HIV.diff_95UL" , "Died_from_HIV.diff.sd",
    "Died_from_HIV.pct", "Died_from_HIV.pct_95LL" ,  "Died_from_HIV.pct_95UL", "Died_from_HIV.pct.sd",
    "Depression.eps.diff", "Depression.eps.diff_95LL", "Depression.eps.diff_95UL", "Depression.eps.diff.sd",
    "Depression.eps.pct", "Depression.eps.pct_95LL", "Depression.eps.pct_95UL",  "Depression.eps.pct.sd"
  ) %>% arrange(Period, Ages, scenario_name)
```


```{r}
sa.differences.table <- sa.differences.table %>% 
   mutate(ix =case_match(
    scenario_name,
    "sa.hivinc.LL" ~ 1,
    "sa.hivinc.UL" ~ 1,
    "baseline.art.not.cmdinc" ~ 2,
    "sa.cmdinc.UL" ~ 2,
    "sa.artdrop.LL" ~ 3,
    "sa.artdrop.UL" ~ 3,
    "sa.delay.LL" ~ 4,
    "sa.delay.UL" ~ 4,
    "sa.artadh.LL" ~ 5,
    "sa.artadh.UL" ~ 5
  ),
  limitsign = case_match(
    scenario_name,
    "sa.hivinc.LL" ~ 0,
    "sa.hivinc.UL" ~ 1,
    "baseline.art.not.cmdinc" ~ 0,
    "sa.cmdinc.UL" ~ 1,
    "sa.artdrop.LL" ~ 0,
    "sa.artdrop.UL" ~ 1,
    "sa.delay.LL" ~ 0,
    "sa.delay.UL" ~ 1,
    "sa.artadh.LL" ~ 0,
    "sa.artadh.UL" ~ 1
  )
  )

#sa.differences.table %>% write_csv("sensitivity_analysis_table_20240819.csv")

sa.differences.table %>% filter(Period == "Past Pandemic", Ages == "15-100" ) %>% 
  ggplot() + 
  geom_rect(mapping = aes(xmin = ix, xmax = ix + 1, ymin = 0, ymax = Newly.Infected.pct))
              
```

