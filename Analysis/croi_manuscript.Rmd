---
title: "croi_manuscript_analysis"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

The purpose of this notebook will be to perform the analysis post-CROI, in preparation for completing the manuscript of the CROI results

# Load libraries

```{r Load Libraries}
library(tidyverse)
library(data.table)
library(magrittr)
library(rsample)
library(readxl)
library(devtools)
devtools::install_github("BershteynLab/EMODAnalyzeR", force = TRUE)
```


```{r}
# Confidence interval functions
lower_ci <- function(mean, se, n, conf_level = 0.95){
  lower_ci <- mean - qt(1 - ((1 - conf_level) / 2), n - 1) * se
  return(lower_ci)
}
upper_ci <- function(mean, se, n, conf_level = 0.95){
  upper_ci <- mean + qt(1 - ((1 - conf_level) / 2), n - 1) * se
  return(upper_ci)
}
```

# Context 

The "baseline scenario" set of HIV-CMD interactions
1. Depression dynamics
  1. Age/sex-specific annual incidence of depression
  2. HIV+ status also increases depression incidence
  3. Relapse rate equal to incidence rate
2. Depression-caused increase to incidence - CoitalActRiskFactor increases from 1 to 1.646
3. Depression-caused delays to diagnosis (2/3 of depressed skip diagnosis)
4. Depression-caused dropout from ART (mean time 5 years for depressed, 10 years for non-depressed)
5. Depression-caused non-adherence to ART


## 2024-03-18
At the moment we are stuck on trying to figure out how to show that depression reducing art adherence has been bad.

# Read in data


## Decouple, ART
```{r}
# Version 4 post May 2024 model
# results_path = "/gpfs/data/bershteynlab/EMOD/citrod01/MATUMAINI/202301_Nyanza_MATUMAINI_MalariaOngoing/sensitivity_analysis/Baseline-campaign_MATUMAINI_202305_decouple-decouple_art/ReportHIVByAgeAndGender/"
# sim.results.decouple.art <- EMODAnalyzeR::read.simulation.results(
#   results_path = results_path,
#   scenario_name = 'decouple.art',
#   summarize_columns = c("Population","Infected", "On_ART",
#                         "Died", "Died_from_HIV",
#                         "Newly.Infected","Diagnosed"),
#   #stratify_columns = c("Year", "Gender", "IP_Key.CMDStatus"),
#   stratify_columns = c("Year", "Gender", "Age", "IP_Key.CMDStatus"),
#   min_age_inclusive = 0,
#   max_age_inclusive = 99
# )

# results used for CROI
# results_path = "/gpfs/data/bershteynlab/EMOD/citrod01/MATUMAINI/202301_Nyanza_MATUMAINI_MalariaOngoing/croi/Baseline-campaign_MATUMAINI_202305_decouple-decouple_adh_ART/ReportHIVByAgeAndGender/",
#   # results from post-croi
#   experiment_path = "/gpfs/scratch/citrod01/experiments/MATUMAINI/Baseline-campaign_MATUMAINI_202305_decouple-decouple_art___2024_04_17_18_51_35_650911",
# Version 5 May 2024
experiment.path = "/gpfs/scratch/citrod01/experiments/MATUMAINI/Baseline-campaign_MATUMAINI_202305_decouple-decouple_art___2024_05_29_10_56_12_042206"

sim.results.decouple.art <- EMODAnalyzeR::read.simulation.results.bigpurple(
  experiment_path = experiment.path,
  scenario_name = "decouple.art",
    summarize_columns = c("Population","Infected", "On_ART",
                        "Died", "Died_from_HIV",
                        "Newly.Infected","Diagnosed"),
  stratify_columns = c("Year", "Gender", "Age", "IP_Key.CMDStatus"),
  min_age_inclusive = 0,
  max_age_inclusive = 99
)

```

## Elevated CMD Incidence, ART
```{r}
# Version 4 
# results_path = "/gpfs/data/bershteynlab/EMOD/citrod01/MATUMAINI/202301_Nyanza_MATUMAINI_MalariaOngoing/sensitivity_analysis/Baseline-campaign_MATUMAINI_202305-baseline_art_cmdinc/ReportHIVByAgeAndGender"
# 
# sim.results.baseline.art.cmdinc <- EMODAnalyzeR::read.simulation.results(
#   results_path = results_path,
#   scenario_name = 'baseline.art.cmdinc',
#   summarize_columns = c("Population","Infected", "On_ART",
#                         "Died", "Died_from_HIV",
#                         "Newly.Infected","Diagnosed"),
#   #stratify_columns = c("Year", "Gender", "IP_Key.CMDStatus"),
#   stratify_columns = c("Year", "Gender", "Age", "IP_Key.CMDStatus"),
#   min_age_inclusive = 0,
#   max_age_inclusive = 99
# )


# experiment_path = "/gpfs/scratch/citrod01/experiments/MATUMAINI/Baseline-campaign_MATUMAINI_202305-baseline_art_cmdinc___2024_04_11_14_47_19_957569/"
# Version 5 post May 2024 model
experiment_path = "/gpfs/scratch/citrod01/experiments/MATUMAINI/Baseline-campaign_MATUMAINI_202305-baseline_art_cmdinc___2024_05_31_15_03_01_888750"

sim.results.baseline.art.cmdinc <- EMODAnalyzeR::read.simulation.results.bigpurple(
  experiment_path = experiment_path,
  scenario_name = 'baseline.art.cmdinc',
  summarize_columns = c("Population","Infected", "On_ART",
                        "Died", "Died_from_HIV",
                        "Newly.Infected","Diagnosed"),
  stratify_columns = c("Year", "Gender", "Age", "IP_Key.CMDStatus"),
  #stratify_columns = c("Year", "Gender","IP_Key.CMDStatus"),
  min_age_inclusive = 0,
  max_age_inclusive = 99
)
```


## Decouple, ART, Increased HIV incidence
```{r}
# Version 4 of model
# results_path = "/gpfs/data/bershteynlab/EMOD/citrod01/MATUMAINI/202301_Nyanza_MATUMAINI_MalariaOngoing/sensitivity_analysis/Baseline-campaign_MATUMAINI_202305_decouple-decouple_art_hivinc/ReportHIVByAgeAndGender"
# sim.results.decouple.art.hivinc <- EMODAnalyzeR::read.simulation.results(
#   results_path = results_path,
#   scenario_name = 'decouple.art.hivinc',
#   summarize_columns = c("Population","Infected", "On_ART",
#                         "Died", "Died_from_HIV",
#                         "Newly.Infected","Diagnosed"),
#   #stratify_columns = c("Year", "Gender", "IP_Key.CMDStatus"),
#   stratify_columns = c("Year", "Gender", "Age", "IP_Key.CMDStatus"),
#   min_age_inclusive = 0,
#   max_age_inclusive = 99
# )

# experiment_path = "/gpfs/scratch/citrod01/experiments/MATUMAINI/Baseline-campaign_MATUMAINI_202305_decouple-decouple_art_hivinc___2024_04_11_14_52_01_213969/"
# Version 5 of model
experiment_path = "/gpfs/scratch/citrod01/experiments/MATUMAINI/Baseline-campaign_MATUMAINI_202305_decouple-decouple_art_hivinc___2024_05_31_15_07_04_198113"

sim.results.decouple.art.hivinc <- EMODAnalyzeR::read.simulation.results.bigpurple(
  experiment_path = experiment_path,
  scenario_name = 'decouple.art.hivinc',
  summarize_columns = c("Population","Infected", "On_ART",
                        "Died", "Died_from_HIV",
                        "Newly.Infected","Diagnosed"),
  stratify_columns = c("Year", "Gender", "Age", "IP_Key.CMDStatus"),
  #stratify_columns = c("Year", "Gender","IP_Key.CMDStatus"),
  min_age_inclusive = 0,
  max_age_inclusive = 99
)
```




## Decouple, ART, Delay to testing
```{r}
# Version 4 of model
# results_path = "/gpfs/data/bershteynlab/EMOD/citrod01/MATUMAINI/202301_Nyanza_MATUMAINI_MalariaOngoing/sensitivity_analysis/Baseline-campaign_MATUMAINI_202305_decouple-decouple_art_delay/ReportHIVByAgeAndGender"
# 
# sim.results.decouple.art.delay <- EMODAnalyzeR::read.simulation.results(
#   results_path = results_path,
#   scenario_name = 'decouple.art.delay',
#   summarize_columns = c("Population","Infected", "On_ART",
#                         "Died", "Died_from_HIV",
#                         "Newly.Infected","Diagnosed"),
#   #stratify_columns = c("Year", "Gender", "IP_Key.CMDStatus"),
#   stratify_columns = c("Year", "Gender", "Age", "IP_Key.CMDStatus"),
#   min_age_inclusive = 0,
#   max_age_inclusive = 99
# )

# experiment_path = "/gpfs/scratch/citrod01/experiments/MATUMAINI/Baseline-campaign_MATUMAINI_202305_decouple-decouple_art_hivinc___2024_04_11_14_52_01_213969/"
# Version 5 of model
experiment_path = "/gpfs/scratch/citrod01/experiments/MATUMAINI/Baseline-campaign_MATUMAINI_202305_decouple-decouple_art_delay___2024_05_31_15_10_02_993271"

sim.results.decouple.art.delay <- EMODAnalyzeR::read.simulation.results.bigpurple(
  experiment_path = experiment_path,
  scenario_name = 'decouple.art.delay',
  summarize_columns = c("Population","Infected", "On_ART",
                        "Died", "Died_from_HIV",
                        "Newly.Infected","Diagnosed"),
  stratify_columns = c("Year", "Gender", "Age", "IP_Key.CMDStatus"),
  #stratify_columns = c("Year", "Gender", "IP_Key.CMDStatus"),
  min_age_inclusive = 0,
  max_age_inclusive = 99
)
```


## Decouple, ART, ART Dropout
```{r}

# Version 4 of model
# results_path = "/gpfs/data/bershteynlab/EMOD/citrod01/MATUMAINI/202301_Nyanza_MATUMAINI_MalariaOngoing/sensitivity_analysis/Baseline-campaign_MATUMAINI_202305_decouple-decouple_art_artdrop/ReportHIVByAgeAndGender"
# 
# sim.results.decouple.art.artdrop <- EMODAnalyzeR::read.simulation.results(
#   results_path = results_path,
#   scenario_name = 'decouple.art.artdrop',
#   summarize_columns = c("Population","Infected", "On_ART",
#                         "Died", "Died_from_HIV",
#                         "Newly.Infected","Diagnosed"),
#   #stratify_columns = c("Year", "Gender", "IP_Key.CMDStatus"),
#   stratify_columns = c("Year", "Gender", "Age", "IP_Key.CMDStatus"),
#   min_age_inclusive = 0,
#   max_age_inclusive = 99
# )

#experiment_path = "/gpfs/scratch/citrod01/experiments/MATUMAINI/Baseline-campaign_MATUMAINI_202305_decouple-decouple_art_artdrop___2024_04_11_15_01_19_935604/"
# Version 5 of model
experiment_path = "/gpfs/scratch/citrod01/experiments/MATUMAINI/Baseline-campaign_MATUMAINI_202305_decouple-decouple_art_artdrop___2024_05_31_15_14_19_276415"

sim.results.decouple.art.artdrop <- EMODAnalyzeR::read.simulation.results.bigpurple(
  experiment_path = experiment_path,
  scenario_name = 'decouple.art.artdrop',
  summarize_columns = c("Population","Infected", "On_ART",
                        "Died", "Died_from_HIV",
                        "Newly.Infected","Diagnosed"),
  #stratify_columns = c("Year", "Gender", "IP_Key.CMDStatus"),
  stratify_columns = c("Year", "Gender", "Age", "IP_Key.CMDStatus"),
  min_age_inclusive = 0,
  max_age_inclusive = 99
)
```


## Decouple, ART, Reduced ART Adherence
```{r}
# Version 4
# results_path = "/gpfs/data/bershteynlab/EMOD/citrod01/MATUMAINI/202301_Nyanza_MATUMAINI_MalariaOngoing/sensitivity_analysis/Baseline-campaign_MATUMAINI_202305_decouple-decouple_art_artadh_recov/ReportHIVByAgeAndGender"
# 
# sim.results.decouple.art.adh <- EMODAnalyzeR::read.simulation.results(
#   results_path = results_path,
#   scenario_name = 'decouple.art.adh',
#   summarize_columns = c("Population","Infected", "On_ART",
#                         "Died", "Died_from_HIV",
#                         "Newly.Infected","Diagnosed"),
#   #stratify_columns = c("Year", "Gender", "IP_Key.CMDStatus"),
#   stratify_columns = c("Year", "Gender", "Age", "IP_Key.CMDStatus"),
#   min_age_inclusive = 0,
#   max_age_inclusive = 99
# )

# results used for croi
# experiment_path = "/gpfs/scratch/citrod01/experiments/MATUMAINI/Baseline-campaign_MATUMAINI_202305_decouple-decouple_art_artadh___2024_03_19_17_45_09_291000",
# Version 5 May 2024 model
experiment_path = "/gpfs/scratch/citrod01/experiments/MATUMAINI/Baseline-campaign_MATUMAINI_202305_decouple-decouple_art_artadh_recov___2024_05_31_15_17_04_815603"

sim.results.decouple.art.adh <- EMODAnalyzeR::read.simulation.results.bigpurple(
  experiment_path = experiment_path,
  scenario_name = 'decouple.art.adh',
  summarize_columns = c("Population","Infected", "On_ART",
                        "Died", "Died_from_HIV",
                        "Newly.Infected","Diagnosed"),
  stratify_columns = c("Year", "Gender", "Age", "IP_Key.CMDStatus"),
  #stratify_columns = c("Year", "Gender","IP_Key.CMDStatus"),
  min_age_inclusive = 0,
  max_age_inclusive = 99
)
```

## Decouple, ART, ART Switch upon CMD status change
```{r}
# Version 4
# results_path = "/gpfs/data/bershteynlab/EMOD/citrod01/MATUMAINI/202301_Nyanza_MATUMAINI_MalariaOngoing/sensitivity_analysis/Baseline-campaign_MATUMAINI_202305_decouple-decouple_art_artswitch/ReportHIVByAgeAndGender"
# # experiment_path = "/gpfs/scratch/citrod01/experiments/MATUMAINI/Baseline-campaign_MATUMAINI_202305_decouple-decouple_art_artswitch___2024_05_07_18_43_17_185298"
# sim.results.decouple.art.artswitch <- EMODAnalyzeR::read.simulation.results(
#   results_path = results_path,
#   scenario_name = 'decouple.art.artswitch',
#   summarize_columns = c("Population","Infected", "On_ART",
#                         "Died", "Died_from_HIV",
#                         "Newly.Infected","Diagnosed"),
#   #stratify_columns = c("Year", "Gender", "IP_Key.CMDStatus"),
#   stratify_columns = c("Year", "Gender", "Age", "IP_Key.CMDStatus"),
#   min_age_inclusive = 0,
#   max_age_inclusive = 99
# )

# Version 5
experiment.path = "/gpfs/scratch/citrod01/experiments/MATUMAINI/Baseline-campaign_MATUMAINI_202305_decouple-decouple_art_artswitch___2024_05_31_15_20_54_758123"

sim.results.decouple.art.artswitch <- EMODAnalyzeR::read.simulation.results.bigpurple(
  experiment_path = experiment.path,
  scenario_name = 'decouple.art.artswitch',
  summarize_columns = c("Population","Infected", "On_ART",
                        "Died", "Died_from_HIV",
                        "Newly.Infected","Diagnosed"),
  #stratify_columns = c("Year", "Gender", "IP_Key.CMDStatus"),
  stratify_columns = c("Year", "Gender", "Age", "IP_Key.CMDStatus"),
  min_age_inclusive = 0,
  max_age_inclusive = 99
)
```

## Baseline, ART
```{r}
# experiment_path = "/gpfs/scratch/citrod01/experiments/MATUMAINI/Baseline-campaign_MATUMAINI_202305-baseline_art___2024_04_11_14_41_55_316412/"

experiment.path = "/gpfs/scratch/citrod01/experiments/MATUMAINI/Baseline-campaign_MATUMAINI_202305-baseline_art___2024_05_29_10_58_40_605127"

sim.results.baseline.art <- EMODAnalyzeR::read.simulation.results.bigpurple(
  experiment_path = experiment.path,
  scenario_name = "baseline.art",
    summarize_columns = c("Population","Infected", "On_ART",
                        "Died", "Died_from_HIV",
                        "Newly.Infected","Diagnosed"),
  stratify_columns = c("Year", "Gender", "Age", "IP_Key.CMDStatus"),
  min_age_inclusive = 0,
  max_age_inclusive = 99
)
# sim.results.baseline.art <- EMODAnalyzeR::read.simulation.results.bigpurple(
#   experiment_path = experiment_path,
#   scenario_name = 'baseline.art',
#   summarize_columns = c("Population","Infected", "On_ART",
#                         "Died", "Died_from_HIV",
#                         "Newly.Infected","Diagnosed"),
#   #stratify_columns = c("Year", "Gender", "Age", "IP_Key.CMDStatus"),
#   stratify_columns = c("Year", "Gender","IP_Key.CMDStatus"),
#   min_age_inclusive = 0,
#   max_age_inclusive = 99
# )

# experiment_path = "/gpfs/scratch/citrod01/experiments/MATUMAINI/Baseline-campaign_MATUMAINI_202305-baseline_art___2024_05_07_18_45_36_283403
# Version 4 post May 2024
# results_path = "/gpfs/data/bershteynlab/EMOD/citrod01/MATUMAINI/202301_Nyanza_MATUMAINI_MalariaOngoing/sensitivity_analysis/Baseline-campaign_MATUMAINI_202305-baseline_art/ReportHIVByAgeAndGender"
# sim.results.baseline.art <- EMODAnalyzeR::read.simulation.results(
#   results_path = results_path,
#   scenario_name = 'baseline.art',
#   summarize_columns = c("Population","Infected", "On_ART",
#                         "Died", "Died_from_HIV",
#                         "Newly.Infected","Diagnosed"),
#   #stratify_columns = c("Year", "Gender", "IP_Key.CMDStatus"),
#   stratify_columns = c("Year", "Gender", "Age", "IP_Key.CMDStatus"),
#   min_age_inclusive = 0,
#   max_age_inclusive = 99
# )

```

## All effects except for increased HIV incidence

```{r}
# Version 4
# results_path = "/gpfs/data/bershteynlab/EMOD/citrod01/MATUMAINI/202301_Nyanza_MATUMAINI_MalariaOngoing/sensitivity_analysis/Baseline-campaign_MATUMAINI_202305-baseline_art_not_hivinc/ReportHIVByAgeAndGender/"
# sim.results.baseline.art.not.hivmc <- EMODAnalyzeR::read.simulation.results(
#   results_path = results_path,
#   scenario_name = 'baseline.art.not.hivmc',
#   summarize_columns = c("Population","Infected", "On_ART",
#                         "Died", "Died_from_HIV",
#                         "Newly.Infected","Diagnosed"),
#   #stratify_columns = c("Year", "Gender", "Age", "IP_Key.CMDStatus"),
#   stratify_columns = c("Year", "Gender", "Age", "IP_Key.CMDStatus"),
#   min_age_inclusive = 0,
#   max_age_inclusive = 99
# )

#experiment_path = "/gpfs/scratch/citrod01/experiments/MATUMAINI/Baseline-campaign_MATUMAINI_202305-baseline_art_not_hivinc___2024_04_18_19_29_24_657884"
# Version 5 of model
experiment_path = "/gpfs/scratch/citrod01/experiments/MATUMAINI/Baseline-campaign_MATUMAINI_202305-baseline_art_not_hivinc___2024_05_31_15_23_37_536366"

sim.results.baseline.art.not.hivmc <- EMODAnalyzeR::read.simulation.results.bigpurple(
  experiment_path = experiment_path,
  scenario_name = 'baseline.art.not.hivmc',
  summarize_columns = c("Population","Infected", "On_ART",
                        "Died", "Died_from_HIV",
                        "Newly.Infected","Diagnosed"),
  stratify_columns = c("Year", "Gender", "Age", "IP_Key.CMDStatus"),
  #stratify_columns = c("Year", "Gender","IP_Key.CMDStatus"),
  min_age_inclusive = 0,
  max_age_inclusive = 99
)
```

## Elevated CMD Incidence, ART Adherence
```{r}
# results_path = "/gpfs/data/bershteynlab/EMOD/citrod01/MATUMAINI/202301_Nyanza_MATUMAINI_MalariaOngoing/sensitivity_analysis/Baseline-campaign_MATUMAINI_202305-baseline_art_cmdinc_artadh_recov/ReportHIVByAgeAndGender/"
# sim.results.baseline.art.cmdinc.adh <- EMODAnalyzeR::read.simulation.results(
#   results_path = results_path,
#   scenario_name = 'baseline.art.cmdinc.adh',
#   summarize_columns = c("Population","Infected", "On_ART",
#                         "Died", "Died_from_HIV",
#                         "Newly.Infected","Diagnosed"),
#   #stratify_columns = c("Year", "Gender","IP_Key.CMDStatus"),
#   stratify_columns = c("Year", "Gender", "Age", "IP_Key.CMDStatus"),
#   min_age_inclusive = 0,
#   max_age_inclusive = 99
# )

```


## Baseline, no ART

```{r}
# experiment_path = "/gpfs/scratch/citrod01/experiments/MATUMAINI/Baseline-campaign_MATUMAINI_202305-baseline_noart___2024_04_11_14_44_43_504278/"
# 
# sim.results.baseline.noart <- EMODAnalyzeR::read.simulation.results.bigpurple(
#   experiment_path = experiment_path,
#   scenario_name = 'baseline.noart',
#   summarize_columns = c("Population","Infected", "On_ART",
#                         "Died", "Died_from_HIV",
#                         "Newly.Infected","Diagnosed"),
#   #stratify_columns = c("Year", "Gender", "Age", "IP_Key.CMDStatus"),
#   stratify_columns = c("Year", "Gender","IP_Key.CMDStatus"),
#   min_age_inclusive = 0,
#   max_age_inclusive = 99
# )

results_path = "/gpfs/data/bershteynlab/EMOD/citrod01/MATUMAINI/202301_Nyanza_MATUMAINI_MalariaOngoing/sensitivity_analysis/Baseline-campaign_MATUMAINI_202305-baseline_noart/ReportHIVByAgeAndGender"

sim.results.baseline.noart <- EMODAnalyzeR::read.simulation.results(
  results_path = results_path,
  scenario_name = 'baseline.noart',
  summarize_columns = c("Population","Infected", "On_ART",
                        "Died", "Died_from_HIV",
                        "Newly.Infected","Diagnosed"),
  #stratify_columns = c("Year", "Gender", "IP_Key.CMDStatus"),
  stratify_columns = c("Year", "Gender", "Age", "IP_Key.CMDStatus"),
  min_age_inclusive = 0,
  max_age_inclusive = 99
)

```

## Decouple, no ART
```{r}
# "/gpfs/scratch/citrod01/experiments/MATUMAINI/Baseline-campaign_MATUMAINI_202305_decouple-decouple_noart___2024_03_15_13_34_32_937184"
# results used for CROI
#   experiment_path = "/gpfs/scratch/citrod01/experiments/MATUMAINI/Baseline-campaign_MATUMAINI_202305_decouple-decouple_noart___2024_04_17_18_53_39_748417",
# Version 5 of model May 2024
experiment.path = "/gpfs/scratch/citrod01/experiments/MATUMAINI/Baseline-campaign_MATUMAINI_202305_decouple-decouple_noart___2024_05_29_11_00_44_305507/"

sim.results.decouple.noart <- EMODAnalyzeR::read.simulation.results.bigpurple(
  scenario_name = 'decouple.noart',
  summarize_columns = c("Population","Infected", "On_ART",
                        "Died", "Died_from_HIV",
                        "Newly.Infected","Diagnosed"),
  #stratify_columns = c("Year", "Gender", "Age", "IP_Key.CMDStatus"),
  stratify_columns = c("Year", "Gender","IP_Key.CMDStatus"),
  min_age_inclusive = 0,
  max_age_inclusive = 99
)

results_path = "/gpfs/data/bershteynlab/EMOD/citrod01/MATUMAINI/202301_Nyanza_MATUMAINI_MalariaOngoing/sensitivity_analysis/Baseline-campaign_MATUMAINI_202305_decouple-decouple_noart/ReportHIVByAgeAndGender/"
# On scratch
# "/gpfs/scratch/citrod01/experiments/MATUMAINI/Baseline-campaign_MATUMAINI_202305_decouple-decouple_noart___2024_05_10_13_29_44_883143"
sim.results.decouple.noart <- EMODAnalyzeR::read.simulation.results(
  results_path = results_path,
  scenario_name = "decouple.noart",
  summarize_columns = c("Population","Infected", "On_ART",
                        "Died", "Died_from_HIV",
                        "Newly.Infected","Diagnosed"),
  #stratify_columns = c("Year", "Gender", "IP_Key.CMDStatus"),
  stratify_columns = c("Year", "Gender", "Age", "IP_Key.CMDStatus"),
  min_age_inclusive = 0,
  max_age_inclusive = 99
)

```

## Elevated CMD Incidence, No ART
```{r, eval=FALSE}
experiment_path = "/gpfs/scratch/citrod01/experiments/MATUMAINI/Baseline-campaign_MATUMAINI_202305-baseline_noart_cmdinc___2024_04_11_14_49_48_244240/"

sim.results.baseline.noart.cmdinc <- EMODAnalyzeR::read.simulation.results.bigpurple(
  experiment_path = experiment_path,
  scenario_name = 'baseline.noart.cmdinc',
  summarize_columns = c("Population","Infected", "On_ART",
                        "Died", "Died_from_HIV",
                        "Newly.Infected","Diagnosed"),
  #stratify_columns = c("Year", "Gender", "Age", "IP_Key.CMDStatus"),
  stratify_columns = c("Year", "Gender","IP_Key.CMDStatus"),
  min_age_inclusive = 0,
  max_age_inclusive = 99
)

CENSUS_YEAR = 2009
KEN_CENSUS_POP = 5352385

sim.results.pop.scaling <- sim.results.baseline.noart.cmdinc %>% 
      filter(Year == CENSUS_YEAR) %>%
      group_by(sim.id) %>%
      summarize(total.pop = sum(Population), .groups = 'keep') %>% 
      mutate(pop.scaling.factor = KEN_CENSUS_POP/total.pop)

sim.results.baseline.noart.cmdinc <- sim.results.baseline.noart.cmdinc %>% 
  inner_join(
    sim.results.pop.scaling,
    by = c("sim.id")
  )
```

## Decouple, no ART, Increased HIV incidence
```{r}
experiment_path = "/gpfs/scratch/citrod01/experiments/MATUMAINI/Baseline-campaign_MATUMAINI_202305_decouple-decouple_noart_hivinc___2024_04_11_14_53_59_875226/"

sim.results.decouple.noart.hivinc <- EMODAnalyzeR::read.simulation.results.bigpurple(
  experiment_path = experiment_path,
  scenario_name = 'decouple.noart.hivinc',
  summarize_columns = c("Population","Infected", "On_ART",
                        "Died", "Died_from_HIV",
                        "Newly.Infected","Diagnosed"),
  #stratify_columns = c("Year", "Gender", "Age", "IP_Key.CMDStatus"),
  stratify_columns = c("Year", "Gender","IP_Key.CMDStatus"),
  min_age_inclusive = 0,
  max_age_inclusive = 99
)

CENSUS_YEAR = 2009
KEN_CENSUS_POP = 5352385

sim.results.pop.scaling <- sim.results.decouple.noart.hivinc %>% 
      filter(Year == CENSUS_YEAR) %>%
      group_by(sim.id) %>%
      summarize(total.pop = sum(Population), .groups = 'keep') %>% 
      mutate(pop.scaling.factor = KEN_CENSUS_POP/total.pop)

sim.results.decouple.noart.hivinc <- sim.results.decouple.noart.hivinc %>% 
  inner_join(
    sim.results.pop.scaling,
    by = c("sim.id")
  )
```

## Decouple, no ART, Delay to testing
```{r}
experiment_path = "/gpfs/scratch/citrod01/experiments/MATUMAINI/Baseline-campaign_MATUMAINI_202305_decouple-decouple_noart_delay___2024_04_11_14_59_23_332282/"

sim.results.decouple.noart.delay <- EMODAnalyzeR::read.simulation.results.bigpurple(
  experiment_path = experiment_path,
  scenario_name = 'decouple.noart.delay',
  summarize_columns = c("Population","Infected", "On_ART",
                        "Died", "Died_from_HIV",
                        "Newly.Infected","Diagnosed"),
  #stratify_columns = c("Year", "Gender", "Age", "IP_Key.CMDStatus"),
  stratify_columns = c("Year", "Gender","IP_Key.CMDStatus"),  min_age_inclusive = 0,
  max_age_inclusive = 99
)

CENSUS_YEAR = 2009
KEN_CENSUS_POP = 5352385

sim.results.pop.scaling <- sim.results.decouple.noart.delay %>% 
      filter(Year == CENSUS_YEAR) %>%
      group_by(sim.id) %>%
      summarize(total.pop = sum(Population), .groups = 'keep') %>% 
      mutate(pop.scaling.factor = KEN_CENSUS_POP/total.pop)

sim.results.decouple.noart.delay <- sim.results.decouple.noart.delay %>% 
  inner_join(
    sim.results.pop.scaling,
    by = c("sim.id")
  )
```


## Minimum/Maximum effect of ART

```{r}
sim.results.decouple.art.max <- EMODAnalyzeR::read.simulation.results.bigpurple(
  experiment_path = "/gpfs/scratch/citrod01/experiments/MATUMAINI/Baseline-campaign_MATUMAINI_202305_decouple-decouple_art_max___2024_04_04_10_59_05_565894",
  scenario_name = 'decouple.art.max',
  summarize_columns = c("Population","Infected", "On_ART",
                        "Died", "Died_from_HIV",
                        "Newly.Infected","Diagnosed"),
  stratify_columns = c("Year", "Gender", "Age", "IP_Key.CMDStatus"),
  min_age_inclusive = 0,
  max_age_inclusive = 99
)

CENSUS_YEAR = 2009
KEN_CENSUS_POP = 5352385

sim.results.pop.scaling <- sim.results.decouple.art.max %>% 
      filter(Year == CENSUS_YEAR) %>%
      group_by(sim.id) %>%
      summarize(total.pop = sum(Population), .groups = 'keep') %>% 
      mutate(pop.scaling.factor = KEN_CENSUS_POP/total.pop)

sim.results.decouple.art.max <- sim.results.decouple.art.max %>% 
  inner_join(
    sim.results.pop.scaling,
    by = c("sim.id")
  )
```

```{r}
sim.results.decouple.art.min <- EMODAnalyzeR::read.simulation.results.bigpurple(
  experiment_path = "/gpfs/scratch/citrod01/experiments/MATUMAINI/Baseline-campaign_MATUMAINI_202305_decouple-decouple_art_min___2024_04_04_11_01_11_057115",
  scenario_name = 'decouple.art.min',
  summarize_columns = c("Population","Infected", "On_ART",
                        "Died", "Died_from_HIV",
                        "Newly.Infected","Diagnosed"),
  stratify_columns = c("Year", "Gender", "Age", "IP_Key.CMDStatus"),
  min_age_inclusive = 0,
  max_age_inclusive = 99
)

CENSUS_YEAR = 2009
KEN_CENSUS_POP = 5352385

sim.results.pop.scaling <- sim.results.decouple.art.min %>% 
      filter(Year == CENSUS_YEAR) %>%
      group_by(sim.id) %>%
      summarize(total.pop = sum(Population), .groups = 'keep') %>% 
      mutate(pop.scaling.factor = KEN_CENSUS_POP/total.pop)

sim.results.decouple.art.min <- sim.results.decouple.art.min %>% 
  inner_join(
    sim.results.pop.scaling,
    by = c("sim.id")
  )
```




## Join data together
```{r}
sim.results.all <- rbind(sim.results.decouple.art,
                         sim.results.baseline.art.cmdinc,
                         sim.results.decouple.art.hivinc,
                         sim.results.decouple.art.delay,
                         sim.results.decouple.art.artdrop,
                         sim.results.decouple.art.adh,
                         sim.results.decouple.art.artswitch,
                         #sim.results.baseline.art.cmdinc.adh,
                         sim.results.baseline.art.not.hivmc,
                         sim.results.baseline.art)
```

## Rescaling

```{r}
CENSUS_YEAR = 2009
KEN_CENSUS_POP = 5352385

sim.results.pop.scaling <- sim.results.all %>% 
      filter(Year == CENSUS_YEAR) %>%
      group_by(sim.ix, scenario_name) %>%
      summarize(total.pop = sum(Population), .groups = 'keep') %>% 
      mutate(pop.scaling.factor = KEN_CENSUS_POP/total.pop)

sim.results.all <- sim.results.all %>% 
  inner_join(
    sim.results.pop.scaling,
    by = c("sim.ix", "scenario_name")
  )
```

# Plot

## Population

```{r, fig.width = 8}
data.pop <- sim.results.all %>% 
  group_by(Year, Gender, sim.id, scenario_name) %>% 
  summarize(Population = sum(Population*pop.scaling.factor), .groups = "keep") %>% 
  # group_by(Year, Gender,scenario_name) %>% 
  # summarize(Population = mean(Population), .groups = "keep") %>% 
  ungroup()

p <- EMODAnalyzeR::emodplot.by_gender(data.pop, 1985, 2025, "Population", title = "Population over Time")

p +
  ylab("HIV Prevalence (%)") + 
  #scale_color_manual(values=c("blue","red","darkgreen","orange","black")) + 
  theme(legend.position = "right")
```

## PLHIV over time

```{r}
plhiv.data <- sim.results.all %>% 
  #filter(Age >= 15, Age < 50) %>% 
  group_by(Year, Gender, scenario_name, sim.id) %>% 
  summarize(PLHIV = sum(Infected*pop.scaling.factor), .groups = 'keep') %>% 
  ungroup() %>% 
  mutate(Gender = case_when(Gender==0 ~ "Male", Gender==1 ~ "Female"))
  
plhiv.data.mean <- plhiv.data %>% 
  group_by(Year, Gender, scenario_name) %>% 
  summarize(PLHIV = mean(PLHIV), .groups = "keep")

p <- ggplot() +
      geom_line(data= plhiv.data.mean %>% filter(Year > 1985),
              aes(x=Year, y=PLHIV, group=scenario_name, color=scenario_name), linewidth=.5) +
    facet_wrap(~ Gender, ncol=2) +
    #xlab("Year")+
    #xlim(c(date.start, date.end)) +
    #ylab("Prevalence") +
    theme_bw(base_size=16) +
    guides(color = guide_legend(ncol = 2, byrow = TRUE, keywidth = 2, keyheight = 1)) +
    theme(legend.position="top", legend.text=element_text(size=10)) +
    scale_x_continuous(breaks = seq(1985,2050,10)) +
    theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
    theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())# +
    #scale_y_continuous(labels = scales::percent_format(accuracy = 1), breaks = seq(0,0.25,0.05), limits=c(0, 0.25)) +
    #ylab("HIV Prevalence (%)") + 
    #scale_color_manual(values=c("blue","red","darkgreen","orange","black","purple")) 

p 

```

## HIV Prevalence over time

```{r}
ingest.file.base = "/gpfs/data/bershteynlab/EMOD/citrod01/MATUMAINI/202301_Nyanza_Baseline_MalariaOngoing_original/Data/calibration_ingest_form_Nyanza.xlsm"

obs.prev.sheet.base <- EMODAnalyzeR::read.ingest.sheet(ingest.file.base, "Obs-Prevalence")

obs.prev.sheet.base
```


```{r, fig.width=8}
#p <- EMODAnalyzeR::emodplot.prevalence(sim.results %>% filter(Age <= 50, Age >=15), 
#                                       1990, 20240)
p <- EMODAnalyzeR::emodplot.prevalence(sim.results.all,# %>% filter(Age <= 50, Age >=15), 
                                       1980, 2040, plot.runs = FALSE)

p +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1), breaks = seq(0,0.25,0.05), limits=c(0, 0.25)) +
    ylab("HIV Prevalence (%)") + 
  #scale_color_manual(values=c("blue","red","darkgreen","orange","black","purple")) +
  geom_point(data = obs.prev.sheet.base %>%
               filter(Province == 'All', AgeBin == "[15:50)", Gender %in% c("Male", "Female")),
             mapping = aes(x = Year, y = Prevalence)) + 
  geom_errorbar(data = obs.prev.sheet.base %>%
             filter(Province == 'All', AgeBin == "[15:50)", Gender %in% c("Male", "Female")),
             mapping = aes(x = Year, ymin = lb, ymax = ub)) + 
  theme(legend.position = "right")


# ggsave(filename = "/gpfs/data/bershteynlab/EMOD/citrod01/MATUMAINI/Analysis/minimal_HIV_prev.pdf",
#        width = 8, height = 6, units = "in")
```

```{r}
croi.prev.data <- sim.results.all %>% 
  filter(Age >= 15, Age < 50) %>% 
  group_by(Year, Gender, scenario_name, sim.id) %>% 
  summarize(Population = sum(Population*pop.scaling.factor), 
            Infected = sum(Infected*pop.scaling.factor), .groups = 'keep') %>% 
  ungroup() %>% 
  mutate(Prevalence = case_when(Population == 0 ~ 0,
                                Population > 0 ~ Infected/Population)) %>% 
  mutate(Gender = case_when(Gender==0 ~ "Male", Gender==1 ~ "Female"))
  
croi.prev.data.mean <- croi.prev.data %>% 
  group_by(Year, Gender, scenario_name) %>% 
  summarize(Prevalence = mean(Prevalence), .groups = "keep")

p <- ggplot() +
      geom_line(data= croi.prev.data.mean %>% filter(Year > 1985),
              aes(x=Year, y=Prevalence, group=scenario_name, color=scenario_name), linewidth=.5) +
    facet_wrap(~ Gender, ncol=2) +
    #xlab("Year")+
    #xlim(c(date.start, date.end)) +
    #ylab("Prevalence") +
    theme_bw(base_size=16) +
    guides(color = guide_legend(ncol = 2, byrow = TRUE, keywidth = 2, keyheight = 1)) +
    theme(legend.position="top", legend.text=element_text(size=10)) +
    scale_x_continuous(breaks = seq(1985,2050,10)) +
    theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
    theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
    scale_y_continuous(labels = scales::percent_format(accuracy = 1), breaks = seq(0,0.25,0.05), limits=c(0, 0.25)) +
    #ylab("HIV Prevalence (%)") + 
    scale_color_manual(values=c("blue","red","darkgreen","orange","black","purple")) +
    geom_point(data = obs.prev.sheet.base %>%
                 filter(Province == 'All', AgeBin == "[15:50)", Gender %in% c("Male", "Female")),
               mapping = aes(x = Year, y = Prevalence) , color = 'black', size = 3, shape = 15) + 
    geom_errorbar(data = obs.prev.sheet.base %>%
               filter(Province == 'All', AgeBin == "[15:50)", Gender %in% c("Male", "Female")),
               mapping = aes(x = Year, ymin = lb, ymax = ub), color = 'black', size = 1)

p 

```
## Number on ART over time

```{r}
ingest.file.base = "/gpfs/data/bershteynlab/EMOD/citrod01/MATUMAINI/202301_Nyanza_Baseline_MalariaOngoing_original/Data/calibration_ingest_form_Nyanza.xlsm"

obs.onart.sheet <- EMODAnalyzeR::read.ingest.sheet(ingest.file.base, "Obs-OnART")
```




```{r, fig.width=8}
sim.onart <- sim.results.all %>% 
  dplyr::group_by(Year, Gender, sim.id, scenario_name) %>% 
  dplyr::summarize(On_ART = sum(On_ART * pop.scaling.factor), .groups = "keep") %>% 
  ungroup() %>% 
  mutate(Gender = case_when(Gender==0 ~ "Male", Gender==1 ~ "Female"))

sim.onart.mean <- sim.onart %>% 
  group_by(Year, Gender, scenario_name) %>% 
  summarize(On_ART = mean(On_ART), .groups = "keep")

p <- ggplot() +
      geom_line(data= sim.onart.mean %>% filter(Year > 1985),
              aes(x=Year, y=On_ART, group=scenario_name, color=scenario_name), linewidth=.75) +
    facet_wrap(~ Gender, ncol=2) +
    #xlab("Year")+
    #xlim(c(date.start, date.end)) +
    #ylab("Prevalence") +
    theme_bw(base_size=16) +
    guides(color = guide_legend(ncol = 2, byrow = TRUE, keywidth = 2, keyheight = 1)) +
    theme(legend.position="top", legend.text=element_text(size=10)) +
    scale_x_continuous(breaks = seq(1985,2050,10)) +
    theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
    theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
    #scale_y_continuous(labels = scales::percent_format(accuracy = 1), breaks = seq(0,0.25,0.05), limits=c(0, 0.25)) +
    #ylab("HIV Prevalence (%)") + 
    scale_color_manual(values=c("blue","red","darkgreen","orange","black","purple"))
p 
```


## Number of New HIV cases

```{r}
sim.cases <- sim.results.all %>% 
  dplyr::group_by(Year, Gender, sim.id, scenario_name) %>% 
  dplyr::summarize(Newly.Infected = sum(Newly.Infected * pop.scaling.factor), .groups = "keep") %>% 
  ungroup() %>% 
  mutate(Gender = case_when(Gender==0 ~ "Male", Gender==1 ~ "Female"))

sim.cases.mean <- sim.cases %>% 
  group_by(Year, Gender, scenario_name) %>% 
  summarize(Newly.Infected = mean(Newly.Infected), .groups = "keep")

p <- ggplot() +
      geom_line(data= sim.cases.mean %>% filter(Year > 1985),
              aes(x=Year, y= Newly.Infected, group=scenario_name, color=scenario_name), linewidth=.5) +
    facet_wrap(~ Gender, ncol=2) +
    #xlab("Year")+
    #xlim(c(date.start, date.end)) +
    #ylab("Prevalence") +
    theme_bw(base_size=16) +
    guides(color = guide_legend(ncol = 2, byrow = TRUE, keywidth = 2, keyheight = 1)) +
    theme(legend.position="top", legend.text=element_text(size=10)) +
    scale_x_continuous(breaks = seq(1985,2050,10)) +
    theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
    theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
    #scale_y_continuous(labels = scales::percent_format(accuracy = 1), breaks = seq(0,0.25,0.05), limits=c(0, 0.25)) +
    #ylab("HIV Prevalence (%)") + 
    scale_color_manual(values=c("blue","red","darkgreen","orange","black","purple", "pink"))

p
```

```{r}
sim.cases.mean
```


## Number of HIV-related Deaths

```{r, fig.width=8}
sim.deaths <- sim.results.all %>% 
  dplyr::group_by(Year, Gender, sim.id, scenario_name) %>% 
  dplyr::summarize(Died_from_HIV = sum(Died_from_HIV * pop.scaling.factor), .groups = "keep") %>% 
  ungroup() %>% 
  mutate(Gender = case_when(Gender==0 ~ "Male", Gender==1 ~ "Female"))

sim.deaths.mean <- sim.deaths %>% 
  group_by(Year, Gender, scenario_name) %>% 
  summarize(Died_from_HIV = mean(Died_from_HIV), .groups = "keep")

p <- ggplot() +
      geom_line(data= sim.deaths.mean %>% filter(Year > 1985),
              aes(x=Year, y= Died_from_HIV, group=scenario_name, color=scenario_name), linewidth=.5) +
    facet_wrap(~ Gender, ncol=2) +
    #xlab("Year")+
    #xlim(c(date.start, date.end)) +
    #ylab("Prevalence") +
    theme_bw(base_size=16) +
    guides(color = guide_legend(ncol = 2, byrow = TRUE, keywidth = 2, keyheight = 1)) +
    theme(legend.position="top", legend.text=element_text(size=10)) +
    scale_x_continuous(breaks = seq(1985,2050,10)) +
    theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
    theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
    #scale_y_continuous(labels = scales::percent_format(accuracy = 1), breaks = seq(0,0.25,0.05), limits=c(0, 0.25)) +
    #ylab("HIV Prevalence (%)") + 
    scale_color_manual(values=c("blue","red","darkgreen","orange","black","purple", "pink"))

p
```

```{r}
sim.deaths.mean
```

## Depression Prevalence

### Depression Prevalence

```{r}
data.cmd <- sim.results.all %>% filter(Age > 18) %>% 
  mutate(HIVneg = Population - Infected) %>% 
  group_by(Year, Gender, sim.id, IP_Key.CMDStatus, scenario_name) %>% 
  summarize(Population = sum(Population),
            HIVneg = sum(HIVneg),
            Infected = sum(Infected), .groups = 'keep') %>% 
  ungroup() %>% 
  pivot_wider(id_cols = c(Year, Gender, sim.id, scenario_name),
              names_from = c(IP_Key.CMDStatus),
              values_from = c(Population, HIVneg, Infected))  %>% 
  mutate(Population_total = Population_CMD_pos + Population_CMD_neg + Population_CMD_recovered + Population_CMD_treated,
         HIVneg_total = HIVneg_CMD_pos + HIVneg_CMD_neg + HIVneg_CMD_recovered + HIVneg_CMD_treated,
         Infected_total = Infected_CMD_pos + Infected_CMD_neg + Infected_CMD_recovered + Infected_CMD_treated) %>% 
  mutate(CMD_prev_overall = case_when(Population_total == 0 ~ 0,
                                    Population_total > 0 ~ Population_CMD_pos/Population_total),
         CMD_prev_HIVneg = case_when(HIVneg_total == 0 ~ 0,
                                    HIVneg_total > 0 ~ HIVneg_CMD_pos/HIVneg_total),
         CMD_prev_Infected = case_when(Infected_total == 0 ~ 0,
                                    Infected_total > 0 ~ Infected_CMD_pos/Infected_total)) %>% 
  mutate(Gender = case_when(Gender==0 ~ "Male", Gender==1 ~ "Female"))

data.cmd.mean <- data.cmd %>% 
  group_by(Year, Gender, scenario_name) %>%
  summarize(Overall = mean(CMD_prev_overall), Overall_sd = sd(CMD_prev_overall),
            HIVneg = mean(CMD_prev_HIVneg), HIVneg_sd = sd(CMD_prev_HIVneg),
            Infected = mean(CMD_prev_Infected), Infected_sd = sd(CMD_prev_Infected),
            .groups = "keep") %>% 
  ungroup()

# Plot  
p = ggplot() +
  geom_line( data = data.cmd.mean %>% 
                    select(Year, Gender, Overall, Infected, HIVneg, scenario_name) %>% 
                    pivot_longer(cols = c(Overall, Infected, HIVneg),
                                 names_to = "Depression.Prevalence", 
                                 values_to = "CMD_prev"),
    mapping = aes(x = Year, y = CMD_prev, color = Depression.Prevalence), 
    size = 1.0) + 
  scale_y_continuous(limits = c(0.05,.22)) + 
  facet_wrap(Gender ~ scenario_name, nrow = 2) +
  xlab("Year")+ylab("") + 
  ggtitle("Depression Prevalence by HIV status") + 
  theme_bw(base_size=16) +
  guides(fill = guide_legend(keywidth = 2, keyheight = 1)) +
  scale_x_continuous(breaks = seq(1980,2040,10)) +
  theme(legend.position="bottom") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  theme(strip.background = element_rect(colour="black", fill="white")) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())

p
```


### Number of people living with Depression

```{r}
data.cmdpos.pop <- sim.results.all %>% 
  group_by(Year, Gender, sim.id, scenario_name) %>% 
  filter(IP_Key.CMDStatus == "CMD_pos") %>% 
  summarize(Population = sum(Population*pop.scaling.factor), .groups = "keep") %>% 
  # group_by(Year, Gender,scenario_name) %>% 
  # summarize(Population = mean(Population), .groups = "keep") %>% 
  ungroup()

data.cmdpos.pop %>% 
  group_by(Year, Gender, scenario_name) %>% 
  summarize(Population = mean(Population))
```


 # Analysis of Metrics

```{r}
test.comparison <- sim.results.all %>%
 group_by(Year, Gender, scenario_name, sim.ix) %>% 
  summarize(Population = sum(Population), 
            Infected = sum(Infected ),
            Died = sum(Died  ),
            Died_from_HIV = sum(Died_from_HIV  ),
            Newly.Infected = sum(Newly.Infected )) %>% ungroup()

test.comp.mean <- test.comparison %>% 
  group_by(Year, Gender, scenario_name) %>% 
  summarize(Population = mean(Population), 
            Infected = mean(Infected),
            Died = mean(Died),
            Died_from_HIV = mean(Died_from_HIV),
            Newly.Infected = mean(Newly.Infected)) %>% ungroup()
```

## Check aggregated mean:

### 1980-1990 (pre=art)
```{r}
test.comp.mean %>% arrange(Year, Gender, scenario_name) %>% 
  filter(Year >= 1980, Year < 1990) %>% 
  group_by(Gender, scenario_name) %>% 
  summarize(Infected = sum(Infected),
           Died_from_HIV = sum(Died_from_HIV),
           Newly.Infected = sum(Newly.Infected)) 

```

### 1990-2000 (pre-art)
```{r}
test.comp.mean %>% arrange(Year, Gender, scenario_name) %>% 
  filter(Year >= 1990, Year < 2000) %>% 
  group_by(Gender, scenario_name) %>% 
  summarize(Infected = sum(Infected),
           Died_from_HIV = sum(Died_from_HIV),
           Newly.Infected = sum(Newly.Infected))
```

### 2000-2020 (ART)
```{r}
test.comp.mean %>% arrange(Year, Gender, scenario_name) %>% 
  filter(Year >= 2000, Year < 2020) %>% 
  group_by(Gender, scenario_name) %>% 
  summarize(Infected = sum(Infected),
           Died_from_HIV = sum(Died_from_HIV),
           Newly.Infected = sum(Newly.Infected))
```
## Calculate totals with error bars

```{r}
start_year = 1980
end_year = 2021
nruns = 250
```

```{r}
sim.results.all.agg <- sim.results.all %>% 
  filter(Year >= start_year, Year < end_year)  %>% 
  group_by(Gender, scenario_name, sim.ix) %>% 
  summarize(Newly.Infected = sum(Newly.Infected * pop.scaling.factor), 
            Died_from_HIV = sum(Died_from_HIV * pop.scaling.factor),
            Depression.eps = sum(Population/2 * pop.scaling.factor),
            .groups = 'keep') %>%
  ungroup() 

sim.results.all.agg.numbers <- sim.results.all.agg %>% 
  group_by(Gender, scenario_name) %>% 
  summarize(
    Newly.Infected.sd = sd(Newly.Infected),
    Newly.Infected = mean(Newly.Infected), 
    Died_from_HIV.sd = sd(Died_from_HIV),
    Died_from_HIV = mean(Died_from_HIV),
    Depression.eps.sd = sd(Depression.eps),
    Depression.eps = mean(Depression.eps), .groups = "keep") %>% 
  ungroup() %>% 
  mutate(
    Newly.Infected_95LL = lower_ci(Newly.Infected, Newly.Infected.sd/sqrt(nruns), nruns, conf_level = .95),
    Newly.Infected_95UL = upper_ci(Newly.Infected, Newly.Infected.sd/sqrt(nruns), nruns, conf_level = .95),
    Died_from_HIV_95LL = lower_ci(Died_from_HIV, Died_from_HIV.sd/sqrt(nruns), nruns, conf_level = .95),
    Died_from_HIV_95UL = upper_ci(Died_from_HIV, Died_from_HIV.sd/sqrt(nruns), nruns, conf_level = .95),
    Depression.eps_95LL = lower_ci(Depression.eps, Depression.eps.sd/sqrt(nruns), nruns, conf_level = .95),
    Depression.eps_95UL = upper_ci(Depression.eps, Depression.eps.sd/sqrt(nruns), nruns, conf_level = .95)
  ) %>% 
  select(
    "Gender", "scenario_name",
    "Newly.Infected", "Newly.Infected.sd", "Newly.Infected_95LL","Newly.Infected_95UL",
    "Died_from_HIV", "Died_from_HIV.sd", "Died_from_HIV_95LL", "Died_from_HIV_95UL",
    "Depression.eps", "Depression.eps.sd", "Depression.eps_95LL", "Depression.eps_95UL"
  ) %>% 
  mutate(Gender = case_when(Gender==0 ~ "Male", Gender==1 ~ "Female"))

sim.results.all.agg.numbers

```

```{r}
ggplot(data = sim.results.all.agg.numbers) + 
  geom_point(mapping = aes(x = scenario_name, y = Newly.Infected, color = Gender)) + 
  geom_errorbar(aes(x=scenario_name, ymin = Newly.Infected_95LL, ymax = Newly.Infected_95UL)) + 
  facet_wrap(~ Gender, ncol=2) + 
  scale_color_manual(values = c("red", "blue"))  + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) 
```

```{r}
ggplot(data = sim.results.all.agg.numbers) + 
  geom_point(mapping = aes(x = scenario_name, y = Died_from_HIV, color = Gender)) + 
  geom_errorbar(aes(x=scenario_name, ymin = Died_from_HIV_95LL, ymax = Died_from_HIV_95UL)) + 
  facet_wrap(~ Gender, ncol=2) + 
  scale_color_manual(values = c("red", "blue"))  + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) 
```

## Calculate differences
```{r}
sim.results.all.agg.differences = sim.results.all.agg %>% 
  filter(scenario_name == "decouple.art") %>% 
  select(Gender, sim.ix, 
         Newly.Infected.Decouple = Newly.Infected,
         Died_from_HIV.Decouple = Died_from_HIV,
         Depression.eps.Decouple = Depression.eps
         ) %>%
  merge(sim.results.all.agg,
        by = c("Gender", "sim.ix")) %>%
  mutate(
    Newly.Infected.diff = Newly.Infected - Newly.Infected.Decouple,
    Newly.Infected.pct = (Newly.Infected - Newly.Infected.Decouple)/Newly.Infected.Decouple,
    Died_from_HIV.diff = Died_from_HIV - Died_from_HIV.Decouple,
    Died_from_HIV.pct = (Died_from_HIV - Died_from_HIV.Decouple)/Died_from_HIV.Decouple,
    Depression.eps.diff = Depression.eps - Depression.eps.Decouple,
    Depression.eps.pct = (Depression.eps - Depression.eps.Decouple)/Depression.eps.Decouple,
) %>% 
  group_by(Gender, scenario_name) %>% 
  summarize(Newly.Infected.diff.sd = sd(Newly.Infected.diff),
            Newly.Infected.diff = mean(Newly.Infected.diff),
            Newly.Infected.pct.sd = sd(Newly.Infected.pct),
            Newly.Infected.pct = mean(Newly.Infected.pct),
            Died_from_HIV.diff.sd = sd(Died_from_HIV.diff),
            Died_from_HIV.diff = mean(Died_from_HIV.diff),
            Died_from_HIV.pct.sd = sd(Died_from_HIV.pct),
            Died_from_HIV.pct = mean(Died_from_HIV.pct),
            Depression.eps.diff.sd = sd(Depression.eps.diff),
            Depression.eps.diff = mean(Depression.eps.diff),
            Depression.eps.pct.sd = sd(Depression.eps.pct),
            Depression.eps.pct = mean(Depression.eps.pct), .groups = 'keep'
            ) %>% 
  ungroup() %>% 
  mutate(
    Newly.Infected.diff_95LL = lower_ci(Newly.Infected.diff, Newly.Infected.diff.sd/sqrt(nruns), nruns, conf_level = .95),
    Newly.Infected.diff_95UL = upper_ci(Newly.Infected.diff, Newly.Infected.diff.sd/sqrt(nruns), nruns, conf_level = .95),
    Newly.Infected.pct_95LL = lower_ci(Newly.Infected.pct, Newly.Infected.pct.sd/sqrt(nruns), nruns, conf_level = .95),
    Newly.Infected.pct_95UL = upper_ci(Newly.Infected.pct, Newly.Infected.pct.sd/sqrt(nruns), nruns, conf_level = .95),
    Died_from_HIV.diff_95LL = lower_ci(Died_from_HIV.diff, Died_from_HIV.diff.sd/sqrt(nruns), nruns, conf_level = .95),
    Died_from_HIV.diff_95UL = upper_ci(Died_from_HIV.diff, Died_from_HIV.diff.sd/sqrt(nruns), nruns, conf_level = .95),
    Died_from_HIV.pct_95LL = lower_ci(Died_from_HIV.pct, Died_from_HIV.pct.sd/sqrt(nruns), nruns, conf_level = .95),
    Died_from_HIV.pct_95UL = upper_ci(Died_from_HIV.pct, Died_from_HIV.pct.sd/sqrt(nruns), nruns, conf_level = .95),
    Depression.eps.diff_95LL = lower_ci(Depression.eps.diff, Depression.eps.diff.sd/sqrt(nruns), nruns, conf_level = .95),
    Depression.eps.diff_95UL = upper_ci(Depression.eps.diff, Depression.eps.diff.sd/sqrt(nruns), nruns, conf_level = .95),
    Depression.eps.pct_95LL = lower_ci(Depression.eps.pct, Depression.eps.pct.sd/sqrt(nruns), nruns, conf_level = .95),
    Depression.eps.pct_95UL = upper_ci(Depression.eps.pct, Depression.eps.pct.sd/sqrt(nruns), nruns, conf_level = .95) 
  )  %>% 
  mutate(Gender = case_when(Gender==0 ~ "Male", Gender==1 ~ "Female")) %>% 
  select(
    "Gender", "scenario_name",
    "Newly.Infected.diff", "Newly.Infected.diff.sd", "Newly.Infected.diff_95LL","Newly.Infected.diff_95UL",
    "Newly.Infected.pct" ,"Newly.Infected.pct.sd" , "Newly.Infected.pct_95LL",  "Newly.Infected.pct_95UL",
    "Died_from_HIV.diff", "Died_from_HIV.diff.sd", "Died_from_HIV.diff_95LL", "Died_from_HIV.diff_95UL",
    "Died_from_HIV.pct", "Died_from_HIV.pct.sd", "Died_from_HIV.pct_95LL", "Died_from_HIV.pct_95UL",
    "Depression.eps.diff", "Depression.eps.diff.sd", "Depression.eps.diff_95LL", "Depression.eps.diff_95UL",
    "Depression.eps.pct", "Depression.eps.pct.sd", "Depression.eps.pct_95LL", "Depression.eps.pct_95UL"
  )

sim.results.all.agg.differences
```


```{r}
ggplot(data = sim.results.all.agg.differences) + 
  geom_point(mapping = aes(x = scenario_name, y = Newly.Infected.diff, color = Gender)) + 
  geom_errorbar(aes(x=scenario_name, ymin = Newly.Infected.diff_95LL, ymax = Newly.Infected.diff_95UL)) + 
  facet_wrap(~ Gender, ncol=2) + 
  scale_color_manual(values = c("red", "blue"))  + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) 
```

```{r}
ggplot(data = sim.results.all.agg.differences) + 
  geom_point(mapping = aes(x = scenario_name, y = Newly.Infected.pct, color = Gender)) + 
  geom_errorbar(aes(x=scenario_name, ymin = Newly.Infected.pct_95LL, ymax = Newly.Infected.pct_95UL)) + 
  geom_text(mapping = aes(x = scenario_name, y = Newly.Infected.pct + .015, label=round(Newly.Infected.pct,3)), color = 'black') + 
  facet_wrap(~ Gender, ncol=2) + 
  scale_color_manual(values = c("red", "blue"))  + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) 

ggsave("hiv_infs_pct_change_above_decoupled.pdf", width = 8, height = 6, units = 'in')
```

```{r}
ggplot(data = sim.results.all.agg.differences) + 
  geom_point(mapping = aes(x = scenario_name, y = Died_from_HIV.diff, color = Gender)) + 
  geom_errorbar(aes(x=scenario_name, ymin = Died_from_HIV.diff_95LL, ymax = Died_from_HIV.diff_95UL)) + 
  facet_wrap(~ Gender, ncol=2) + 
  scale_color_manual(values = c("red", "blue"))  + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) 
```

```{r}
ggplot(data = sim.results.all.agg.differences) + 
  geom_point(mapping = aes(x = scenario_name, y = Died_from_HIV.pct, color = Gender)) + 
  geom_errorbar(aes(x=scenario_name, ymin = Died_from_HIV.pct_95LL, ymax = Died_from_HIV.pct_95UL)) + 
  geom_text(mapping = aes(x = scenario_name, y = Died_from_HIV.pct + .015, label=round(Newly.Infected.pct,3)), color = 'black') + 
  facet_wrap(~ Gender, ncol=2) + 
  scale_color_manual(values = c("red", "blue"))  + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) 

ggsave("hiv_deaths_pct_change_above_decoupled.pdf", width = 8, height = 6, units = 'in')
```
# Metrics

Count the number of cases, deaths, depression episodes for each of the following:

1. All effects: baseline.art
2. Elevated depression incidence for PLHIV: baseline.art.cmd
3. Elevated HIV incidence for people with depression: decouple.art.hivmc
4. Delays to testing decouple.art.delay
5. ART dropout: decouple.art.dropout
6. ART adherence: decouple.art.adh.recov
7. All effects turned off: decouple.art


## Define some functions

The challenge here is that the bootstrapping method only allows stratifying across one column. For the sake of bootstrapping itself, the most important column is scenario_name, but we also will need to stratify by gender at times.

What I am going to do is create a function which simply stratifies by scenario name. I will aggregate and split out the data set by gender when needed.

Just kidding, I can't do that, I'm just going to need to write a function that subsets the part of sim.results.all and calculates the error bars accordingly. Don't bother stratifying.

### Function for calculating number counts

```{r}
bt_mean <- function(splits, colname){
  x <- as.data.frame(analysis(splits))
  mean(x[[colname]])
}

aggregate.data <- function(data, scenario.name, start_year, end_year, age_min, age_max){
  
  data.agg <- data %>% 
    filter(scenario_name == scenario.name) %>% 
    filter(Year >= start_year, 
           Year < end_year,
           Age >= age_min,
           Age < age_max)  %>% 
    group_by(scenario_name, sim.ix) %>% 
    summarize(Newly.Infected = sum(Newly.Infected * pop.scaling.factor), 
            Died_from_HIV = sum(Died_from_HIV * pop.scaling.factor),
            .groups = 'keep') %>%
    ungroup() %>% merge(
        data %>% 
          filter(scenario_name == scenario.name) %>% 
          filter(Year >= start_year, 
                 Year < end_year,
                 Age >= age_min,
                 Age < age_max)  %>% 
          filter(IP_Key.CMDStatus == "CMD_pos") %>% 
            group_by(scenario_name, sim.ix) %>% 
            summarize( Depression.eps = sum(Population/2* pop.scaling.factor),
                    .groups = 'keep') %>%
            ungroup(), 
        by = c("scenario_name", "sim.ix")
    )
  
  data.agg.numbers <- data.agg %>%
    filter(scenario_name == scenario.name)  %>% 
    group_by(scenario_name) %>%
    summarize(
      Newly.Infected.sd = sd(Newly.Infected),
      Newly.Infected = mean(Newly.Infected),
      Died_from_HIV.sd = sd(Died_from_HIV),
      Died_from_HIV = mean(Died_from_HIV),
      Depression.eps.sd = sd(Depression.eps),
      Depression.eps = mean(Depression.eps), .groups = "keep") %>%
    ungroup()
  
  bt_resamples <- bootstraps(data.agg, times = 500)
  bt_resamples$mean.infected <- map_dbl(bt_resamples$splits, bt_mean, "Newly.Infected")
  bt_resamples$mean.deaths <- map_dbl(bt_resamples$splits, bt_mean, "Died_from_HIV")
  bt_resamples$mean.eps <- map_dbl(bt_resamples$splits, bt_mean, "Depression.eps")
  
  infected_95 <- quantile(bt_resamples$mean.infected, probs = c(.025, .975))
  deaths_95 <- quantile(bt_resamples$mean.deaths, probs = c(.025, .975))
  eps_95 <- quantile(bt_resamples$mean.eps, probs = c(.025, .975))
  
  data.agg.numbers$Newly.Infected_95LL <- infected_95[[1]]
  data.agg.numbers$Newly.Infected_95UL <- infected_95[[2]]
  data.agg.numbers$Died_from_HIV_95LL <- deaths_95[[1]]
  data.agg.numbers$Died_from_HIV_95UL <- deaths_95[[2]]
  data.agg.numbers$Depression.eps_95LL <- eps_95[[1]]
  data.agg.numbers$Depression.eps_95UL <- eps_95[[2]]
  
  data.agg.numbers <- data.agg.numbers %>% select(
        "scenario_name",
        "Newly.Infected", "Newly.Infected_95LL","Newly.Infected_95UL", "Newly.Infected.sd",
        "Died_from_HIV", "Died_from_HIV_95LL", "Died_from_HIV_95UL", "Died_from_HIV.sd",
        "Depression.eps", "Depression.eps_95LL", "Depression.eps_95UL", "Depression.eps.sd"
      )
  
  data.agg.numbers
}

```

### Function for calculating differences between scenarios

```{r}

    group_by(scenario_name, sim.ix) %>% 
    summarize(Newly.Infected = sum(Newly.Infected * pop.scaling.factor), 
            Died_from_HIV = sum(Died_from_HIV * pop.scaling.factor),
            .groups = 'keep') %>%
    ungroup() %>% merge(
        sim.results.all %>% 
          filter(scenario_name=="baseline.art") %>% 
          filter(Year >= 1980, 
                 Year < 2021,
                 Age >= 0,
                 Age < 100)  %>% 
          filter(IP_Key.CMDStatus == "CMD_pos") %>% 
            group_by(scenario_name, sim.ix) %>% 
            summarize( Depression.eps = sum(Population/2* pop.scaling.factor),
                    .groups = 'keep') %>%
            ungroup() %>% 
          select(sim.ix, Depression.eps), 
        by = c("sim.ix")
    )


data.agg <- sim.results.all %>%
    filter(Year >= 1980, 
           Year < 2021,
           Age >= 0,
           Age < 100)  %>% 
    group_by(scenario_name, sim.ix) %>% 
    summarize(Newly.Infected = sum(Newly.Infected * pop.scaling.factor), 
            Died_from_HIV = sum(Died_from_HIV * pop.scaling.factor),
            .groups = 'keep') %>%
    ungroup() %>% merge(
        sim.results.all %>% 
          filter(scenario_name== "baseline.art") %>% 
          filter(Year >= 1980, 
                 Year < 2021,
                 Age >= 0,
                 Age < 100)  %>% 
          filter(IP_Key.CMDStatus == "CMD_pos") %>% 
            group_by(scenario_name, sim.ix) %>% 
            summarize( Depression.eps = sum(Population/2* pop.scaling.factor),
                    .groups = 'keep') %>%
            ungroup() %>% 
          select(sim.ix, Depression.eps), 
        by = c("sim.ix")
    )

  data.agg.2 <- data.agg %>% filter(scenario_name == "decouple.art") %>% 
    select(sim.ix, 
         Newly.Infected.Decouple = Newly.Infected,
         Died_from_HIV.Decouple = Died_from_HIV,
         Depression.eps.Decouple = Depression.eps
         ) %>% 
    merge(data.agg %>% filter(scenario_name == "baseline.art"),
          by = c("sim.ix")) %>%
    mutate(
      Newly.Infected.diff = Newly.Infected - Newly.Infected.Decouple,
      Newly.Infected.pct = (Newly.Infected - Newly.Infected.Decouple)/Newly.Infected.Decouple,
      Died_from_HIV.diff = Died_from_HIV - Died_from_HIV.Decouple,
      Died_from_HIV.pct = (Died_from_HIV - Died_from_HIV.Decouple)/Died_from_HIV.Decouple,
      Depression.eps.diff = Depression.eps - Depression.eps.Decouple,
      Depression.eps.pct = (Depression.eps - Depression.eps.Decouple)/Depression.eps.Decouple,
    ) 
  
data.agg.diffs <- data.agg.2 %>%
  group_by(scenario_name) %>%
  summarize(Newly.Infected.diff.sd = sd(Newly.Infected.diff),
            Newly.Infected.diff = mean(Newly.Infected.diff),
            Newly.Infected.pct.sd = sd(Newly.Infected.pct),
            Newly.Infected.pct = mean(Newly.Infected.pct),
            Died_from_HIV.diff.sd = sd(Died_from_HIV.diff),
            Died_from_HIV.diff = mean(Died_from_HIV.diff),
            Died_from_HIV.pct.sd = sd(Died_from_HIV.pct),
            Died_from_HIV.pct = mean(Died_from_HIV.pct),
            Depression.eps.diff.sd = sd(Depression.eps.diff),
            Depression.eps.diff = mean(Depression.eps.diff),
            Depression.eps.pct.sd = sd(Depression.eps.pct),
            Depression.eps.pct = mean(Depression.eps.pct), .groups = 'keep'
            )

  bt_resamples <- bootstraps(data.agg.2, times = 500)
  bt_resamples$mean.infected.diff <- map_dbl(bt_resamples$splits, bt_mean, "Newly.Infected.diff")
  bt_resamples$mean.infected.pct <- map_dbl(bt_resamples$splits, bt_mean, "Newly.Infected.pct")
  bt_resamples$mean.deaths.diff <- map_dbl(bt_resamples$splits, bt_mean, "Died_from_HIV.diff")
  bt_resamples$mean.deaths.pct <- map_dbl(bt_resamples$splits, bt_mean, "Died_from_HIV.pct")
  bt_resamples$mean.eps.diff <- map_dbl(bt_resamples$splits, bt_mean, "Depression.eps.diff")
  bt_resamples$mean.eps.pct <- map_dbl(bt_resamples$splits, bt_mean, "Depression.eps.pct")
  
  infected.diff_95 <- quantile(bt_resamples$mean.infected.diff, probs = c(.025, .975))
  infected.pct_95 <- quantile(bt_resamples$mean.infected.pct, probs = c(.025, .975))
  deaths.diff_95 <- quantile(bt_resamples$mean.deaths.diff, probs = c(.025, .975))
  deaths.pct_95 <- quantile(bt_resamples$mean.deaths.pct, probs = c(.025, .975))
  eps.diff_95 <- quantile(bt_resamples$mean.eps.diff, probs = c(.025, .975))
  eps.pct_95 <- quantile(bt_resamples$mean.eps.pct, probs = c(.025, .975))
```


```{r}
aggregate.data.differences <- function(data, scenario.name, start_year, end_year, age_min, age_max){
  
  data.agg <- data %>% 
    filter(Year >= start_year, 
           Year < end_year,
           Age >= age_min,
           Age < age_max)  %>% 
    group_by(scenario_name, sim.ix) %>% 
    summarize(Newly.Infected = sum(Newly.Infected * pop.scaling.factor), 
            Died_from_HIV = sum(Died_from_HIV * pop.scaling.factor),
            .groups = 'keep') %>%
    ungroup() %>% merge(
        data %>% 
          filter(scenario_name==scenario.name) %>% 
          filter(Year >= start_year, 
                 Year < end_year,
                 Age >= age_min,
                 Age < age_max)  %>% 
          filter(IP_Key.CMDStatus == "CMD_pos") %>% 
            group_by(scenario_name, sim.ix) %>% 
            summarize( Depression.eps = sum(Population/2* pop.scaling.factor),
                    .groups = 'keep') %>%
            ungroup() %>% 
          select(sim.ix, Depression.eps), 
        by = c("sim.ix")
    )
  
  data.agg.2 <- data.agg %>% filter(scenario_name == "decouple.art") %>% 
    select(sim.ix, 
         Newly.Infected.Decouple = Newly.Infected,
         Died_from_HIV.Decouple = Died_from_HIV,
         Depression.eps.Decouple = Depression.eps
         ) %>% 
    merge(data.agg %>% filter(scenario_name == scenario.name),
          by = c("sim.ix")) %>%
    mutate(
      Newly.Infected.diff = Newly.Infected - Newly.Infected.Decouple,
      Newly.Infected.pct = (Newly.Infected - Newly.Infected.Decouple)/Newly.Infected.Decouple,
      Died_from_HIV.diff = Died_from_HIV - Died_from_HIV.Decouple,
      Died_from_HIV.pct = (Died_from_HIV - Died_from_HIV.Decouple)/Died_from_HIV.Decouple,
      Depression.eps.diff = Depression.eps - Depression.eps.Decouple,
      Depression.eps.pct = (Depression.eps - Depression.eps.Decouple)/Depression.eps.Decouple,
    ) 
  
  data.agg.diffs <- data.agg.2 %>%
    group_by(scenario_name) %>%
    summarize(Newly.Infected.diff.sd = sd(Newly.Infected.diff),
              Newly.Infected.diff = mean(Newly.Infected.diff),
              Newly.Infected.pct.sd = sd(Newly.Infected.pct),
              Newly.Infected.pct = mean(Newly.Infected.pct),
              Died_from_HIV.diff.sd = sd(Died_from_HIV.diff),
              Died_from_HIV.diff = mean(Died_from_HIV.diff),
              Died_from_HIV.pct.sd = sd(Died_from_HIV.pct),
              Died_from_HIV.pct = mean(Died_from_HIV.pct),
              Depression.eps.diff.sd = sd(Depression.eps.diff),
              Depression.eps.diff = mean(Depression.eps.diff),
              Depression.eps.pct.sd = sd(Depression.eps.pct),
              Depression.eps.pct = mean(Depression.eps.pct), .groups = 'keep'
              )

  bt_resamples <- bootstraps(data.agg.2, times = 500)
  bt_resamples$mean.infected.diff <- map_dbl(bt_resamples$splits, bt_mean, "Newly.Infected.diff")
  bt_resamples$mean.infected.pct <- map_dbl(bt_resamples$splits, bt_mean, "Newly.Infected.pct")
  bt_resamples$mean.deaths.diff <- map_dbl(bt_resamples$splits, bt_mean, "Died_from_HIV.diff")
  bt_resamples$mean.deaths.pct <- map_dbl(bt_resamples$splits, bt_mean, "Died_from_HIV.pct")
  bt_resamples$mean.eps.diff <- map_dbl(bt_resamples$splits, bt_mean, "Depression.eps.diff")
  bt_resamples$mean.eps.pct <- map_dbl(bt_resamples$splits, bt_mean, "Depression.eps.pct")
  
  infected.diff_95 <- quantile(bt_resamples$mean.infected.diff, probs = c(.025, .975))
  infected.pct_95 <- quantile(bt_resamples$mean.infected.pct, probs = c(.025, .975))
  deaths.diff_95 <- quantile(bt_resamples$mean.deaths.diff, probs = c(.025, .975))
  deaths.pct_95 <- quantile(bt_resamples$mean.deaths.pct, probs = c(.025, .975))
  eps.diff_95 <- quantile(bt_resamples$mean.eps.diff, probs = c(.025, .975))
  eps.pct_95 <- quantile(bt_resamples$mean.eps.pct, probs = c(.025, .975))
  
  data.agg.diffs$Newly.Infected.diff_95LL <- infected.diff_95[[1]]
  data.agg.diffs$Newly.Infected.diff_95UL <- infected.diff_95[[2]]
  data.agg.diffs$Newly.Infected.pct_95LL <- infected.pct_95[[1]]
  data.agg.diffs$Newly.Infected.pct_95UL <- infected.pct_95[[2]]
  data.agg.diffs$Died_from_HIV.diff_95LL <- deaths.diff_95[[1]]
  data.agg.diffs$Died_from_HIV.diff_95UL <- deaths.diff_95[[2]]
  data.agg.diffs$Died_from_HIV.pct_95LL <- deaths.pct_95[[1]]
  data.agg.diffs$Died_from_HIV.pct_95UL <- deaths.pct_95[[2]]
  data.agg.diffs$Depression.eps.diff_95LL <- eps.diff_95[[1]]
  data.agg.diffs$Depression.eps.diff_95UL <- eps.diff_95[[2]]
  data.agg.diffs$Depression.eps.pct_95LL <- eps.pct_95[[1]]
  data.agg.diffs$Depression.eps.pct_95UL <- eps.pct_95[[2]]
  
  data.agg.diffs <- data.agg.diffs %>% select(
        "scenario_name",
        "Newly.Infected.diff", "Newly.Infected.diff.sd", "Newly.Infected.diff_95LL","Newly.Infected.diff_95UL",
        "Newly.Infected.pct", "Newly.Infected.pct.sd", "Newly.Infected.pct_95LL","Newly.Infected.pct_95UL",
        "Died_from_HIV.diff", "Died_from_HIV.diff.sd", "Died_from_HIV.diff_95LL", "Died_from_HIV.diff_95UL",
        "Died_from_HIV.pct", "Died_from_HIV.pct.sd", "Died_from_HIV.pct_95LL", "Died_from_HIV.pct_95UL",
        "Depression.eps.diff", "Depression.eps.diff.sd", "Depression.eps.diff_95LL", "Depression.eps.diff_95UL",
        "Depression.eps.pct", "Depression.eps.pct.sd", "Depression.eps.pct_95LL", "Depression.eps.pct_95UL"
      )

  data.agg.diffs
  
}
```

```{r}
data.agg.diffs <- aggregate.data.differences(sim.results.all,
                                             scenario.name = 'baseline.art',
                                             1980, 2005, 15,25)

data.agg.diffs

```


## Calculate Numbers
```{r}
aggregate.data(sim.results.all, 
               "baseline.art",
               1980, 2021, 0, 100)
```


```{r}
age_min_list = c(0, 15, 25)
age_max_list = c(100, 25, 100)

start_year_list = c(1985, 1985, 2000, 2015, 2025, 1985)
end_year_list = c(2025, 2000, 2015, 2025, 2050, 2050)
label_list = c("Entire Past Pandemic", "Pre-ART", "ART Scaleup", "Universal ART", "Future Pandemic", "Past+Future Pandemic")

scenario_names = sim.results.all$scenario_name %>% unique

numbers.table <- data.table()
for (i in seq(1:length(age_min_list))){
  for (j in seq(1:length(start_year_list)) ){
    for (k in seq(1:length(scenario_names))) {

      age_min = age_min_list[[i]]
      age_max = age_max_list[[i]]
      start_year = start_year_list[[j]]
      end_year = end_year_list[[j]]
      holder <- aggregate.data(sim.results.all, 
                     scenario_names[[k]],
                     start_year, end_year, age_min,age_max) %>% 
        mutate(Ages = paste0(age_min, "-", age_max),
               Years = paste0(start_year,"-",end_year),
               Period = label_list[[j]])
      
      numbers.table <- rbind(numbers.table, holder)      
      
    }
  }
} 

numbers.table <- numbers.table %>% 
  select(
    "Ages", "Period", "Years", "scenario_name",
    "Newly.Infected", "Newly.Infected_95LL", "Newly.Infected_95UL", "Newly.Infected.sd", 
    "Died_from_HIV", "Died_from_HIV_95LL", "Died_from_HIV_95UL",  "Died_from_HIV.sd", 
    "Depression.eps", "Depression.eps_95LL", "Depression.eps_95UL", "Depression.eps.sd"
  )

numbers.table %>% arrange(Period, Ages, scenario_name)

write_csv(numbers.table, "numbers_table_20240531.csv")
```


```{r, fig.height=16}
numbers.table %>% 
  ggplot() + 
  geom_point(mapping = aes(x = scenario_name, y = Newly.Infected)) + 
  geom_errorbar(mapping = aes(x = scenario_name, ymin = Newly.Infected_95LL, ymax = Newly.Infected_95UL)) + 
  facet_grid(cols = vars(Ages), rows = vars(Period)) + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

# ggplot(data = sim.results.all.agg.numbers) + 
#   geom_point(mapping = aes(x = scenario_name, y = Newly.Infected, color = Gender)) + 
#   geom_errorbar(aes(x=scenario_name, ymin = Newly.Infected_95LL, ymax = Newly.Infected_95UL)) + 
#   facet_wrap(~ Gender, ncol=2) + 
#   scale_color_manual(values = c("red", "blue"))  + 
#   theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) 
# #+ 
# #  scale_y_continuous(limits = c(5e5, 9e5)) 

```

```{r}
numbers.table %>% 
  ggplot() + 
  geom_point(mapping = aes(x = scenario_name, y = Died_from_HIV)) + 
  geom_errorbar(mapping = aes(x = scenario_name, ymin = Died_from_HIV_95LL, ymax = Died_from_HIV_95UL)) + 
  facet_wrap(vars(Ages, Years)) + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) 
#+ 
#  scale_y_continuous(limits = c(5e5, 9e5)) 
```


## Calculate Differences

Differences here are between each scenario and the decouple.art scenario. We assume there will be the least problems with decouple.noart.

```{r}
aggregate.data.differences(sim.results.all,
                           scenario.name = "baseline.art",
                           1980, 2025, 
                           0,100)
```


```{r}
age_min_list = c(0, 15, 25)
age_max_list = c(100, 25, 100)

start_year_list = c(1985, 1985, 2000, 2015, 2025, 1985)
end_year_list = c(2025, 2000, 2015, 2025, 2050, 2050)
label_list = c("Entire Past Pandemic", "Pre-ART", "ART Scaleup", "Universal ART", "Future Pandemic", "Past+Future Pandemic")

scenario_names <- sim.results.all$scenario_name %>% unique
scenario_names <- scenario_names[scenario_names != "decouple.art"]

differences.table <- data.table()
for (i in seq(1:length(age_min_list))){
  for (j in seq(1:length(start_year_list)) ){
    for (k in seq(1:length(scenario_names))) {

      age_min = age_min_list[[i]]
      age_max = age_max_list[[i]]
      start_year = start_year_list[[j]]
      end_year = end_year_list[[j]]
      
      holder <- aggregate.data.differences(sim.results.all,
                                           scenario.name = scenario_names[[k]],
                                           start_year, end_year, age_min,age_max) %>% 
               mutate(Ages = paste0(age_min, "-", age_max),
                      Years = paste0(start_year,"-",end_year),
                      Period = label_list[[j]])
      
      differences.table <- rbind(differences.table, holder)      
      
    }
  }
} 

differences.table <- differences.table %>% 
  select(
    "Ages", "Period", "Years", "scenario_name",
    "Newly.Infected.diff", "Newly.Infected.diff_95LL", "Newly.Infected.diff_95UL", "Newly.Infected.diff.sd", 
    "Newly.Infected.pct", "Newly.Infected.pct_95LL", "Newly.Infected.pct_95UL", "Newly.Infected.pct.sd" ,
    "Died_from_HIV.diff", "Died_from_HIV.diff_95LL", "Died_from_HIV.diff_95UL" , "Died_from_HIV.diff.sd",
    "Died_from_HIV.pct", "Died_from_HIV.pct_95LL" ,  "Died_from_HIV.pct_95UL", "Died_from_HIV.pct.sd",
    "Depression.eps.diff", "Depression.eps.diff_95LL", "Depression.eps.diff_95UL", "Depression.eps.diff.sd",
    "Depression.eps.pct", "Depression.eps.pct_95LL", "Depression.eps.pct_95UL",  "Depression.eps.pct.sd"
  ) %>% arrange(Period, Ages, scenario_name)

write_csv(differences.table, "differences_table_20240531.csv")

differences.table %>% View
```

```{r}
differences.table %>% 
  ggplot() + 
  geom_point(mapping = aes(x = scenario_name, y = Newly.Infected.diff)) + 
  geom_errorbar(mapping = aes(x = scenario_name, ymin = Newly.Infected.diff_95LL, ymax = Newly.Infected.diff_95UL)) + 
  facet_wrap(vars(Ages, Years)) + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) 

# ggplot(data = sim.results.all.agg.differences) + 
#   geom_point(mapping = aes(x = scenario_name, y = Newly.Infected.diff, color = Gender)) + 
#   geom_errorbar(aes(x=scenario_name, ymin = Newly.Infected.diff_95LL, ymax = Newly.Infected.diff_95UL)) + 
#   facet_wrap(~ Gender, ncol=2) + 
#   scale_color_manual(values = c("red", "blue"))  + 
#   theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) 

#ggsave("New_Cases_Difference.pdf", height = 4, width = 8, units = "in")
```

```{r}
differences.table %>% 
  ggplot() + 
  geom_point(mapping = aes(x = scenario_name, y = Newly.Infected.pct)) + 
  geom_errorbar(mapping = aes(x = scenario_name, ymin = Newly.Infected.pct_95LL, ymax = Newly.Infected.pct_95UL)) + 
  facet_wrap(vars(Ages, Years)) + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) 


# ggplot(data = sim.results.all.agg.differences) + 
#   geom_point(mapping = aes(x = scenario_name, y = Newly.Infected.pct, color = Gender)) + 
#   geom_errorbar(aes(x=scenario_name, ymin = Newly.Infected.pct_95LL, ymax = Newly.Infected.pct_95UL)) + 
#   geom_label(mapping = aes(x = scenario_name, y = Newly.Infected.pct + .015, label = round(Newly.Infected.pct,3))) + 
#   facet_wrap(~ Gender, ncol=2) + 
#   scale_color_manual(values = c("red", "blue"))  + 
#   theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) 

# ggsave("/gpfs/data/bershteynlab/EMOD/citrod01/MATUMAINI/Analysis/hiv_infs_pct_change_above_decoupled.pdf", height = 6, width = 12, units = "in")
```

```{r}
differences.table %>% 
  ggplot() + 
  geom_point(mapping = aes(x = scenario_name, y = Died_from_HIV.diff)) + 
  geom_errorbar(mapping = aes(x = scenario_name, ymin = Died_from_HIV.diff_95LL, ymax = Died_from_HIV.diff_95UL)) + 
  facet_wrap(vars(Ages, Years)) + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) 

# ggplot(data = sim.results.all.agg.differences) + 
#   geom_point(mapping = aes(x = scenario_name, y = Died_from_HIV.diff, color = Gender)) + 
#   geom_errorbar(aes(x=scenario_name, ymin = Died_from_HIV.diff_95LL, ymax = Died_from_HIV.diff_95UL)) + 
#   facet_wrap(~ Gender, ncol=2) + 
#   scale_color_manual(values = c("red", "blue"))  + 
#   theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) 
# 
# ggsave("HIV_Deaths_Difference.pdf", height = 4, width = 8, units = "in")
```

```{r}
differences.table %>% 
  ggplot() + 
  geom_point(mapping = aes(x = scenario_name, y = Died_from_HIV.pct)) + 
  geom_errorbar(mapping = aes(x = scenario_name, ymin = Died_from_HIV.pct_95LL, ymax = Died_from_HIV.pct_95UL)) + 
  facet_wrap(vars(Ages, Years)) + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) 


# ggplot(data = sim.results.all.agg.differences) + 
#   geom_point(mapping = aes(x = scenario_name, y = Died_from_HIV.pct, color = Gender)) + 
#   geom_errorbar(aes(x=scenario_name, ymin = Died_from_HIV.pct_95LL, ymax = Died_from_HIV.pct_95UL)) + 
#   geom_label(mapping = aes(x = scenario_name, y = Died_from_HIV.pct + .015, label = round(Died_from_HIV.pct,3))) + 
#   facet_wrap(~ Gender, ncol=2) + 
#   scale_color_manual(values = c("red", "blue"))  + 
#   theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) 
# 
# 
# ggsave("/gpfs/data/bershteynlab/EMOD/citrod01/MATUMAINI/Analysis/hiv_deaths_pct_change_above_decoupled.pdf", height = 6, width = 12, units = "in")
```

## Impact of ART

### Importing data

The difference here is that we will import data with the column which stratifies by ART adherence

```{r}
# Decouple, art
experiment.path = "/gpfs/scratch/citrod01/experiments/MATUMAINI/Baseline-campaign_MATUMAINI_202305_decouple-decouple_art___2024_05_29_10_56_12_042206"

impact.results.decouple.art <- EMODAnalyzeR::read.simulation.results.bigpurple(
  experiment_path = experiment.path,
  scenario_name = "decouple.art",
    summarize_columns = c("Population","Infected", "On_ART",
                        "Died", "Died_from_HIV",
                        "Newly.Infected","Diagnosed"),
  stratify_columns = c("Year", "Gender", "Age", "IP_Key.CMDStatus", "HasIntervention.SuppressedOnART"),
  min_age_inclusive = 0,
  max_age_inclusive = 99
)

# Decouple, No art
experiment.path = "/gpfs/scratch/citrod01/experiments/MATUMAINI/Baseline-campaign_MATUMAINI_202305_decouple-decouple_noart___2024_05_29_11_00_44_305507/"

impact.results.decouple.noart <- EMODAnalyzeR::read.simulation.results.bigpurple(
  experiment_path = experiment.path,
  scenario_name = "decouple.noart",
    summarize_columns = c("Population","Infected", "On_ART",
                        "Died", "Died_from_HIV",
                        "Newly.Infected","Diagnosed"),
  stratify_columns = c("Year", "Gender", "Age", "IP_Key.CMDStatus", "HasIntervention.SuppressedOnART"),
  min_age_inclusive = 0,
  max_age_inclusive = 99
)

# Baseline art
experiment.path = "/gpfs/scratch/citrod01/experiments/MATUMAINI/Baseline-campaign_MATUMAINI_202305-baseline_art___2024_05_29_10_58_40_605127"

impact.results.baseline.art <- EMODAnalyzeR::read.simulation.results.bigpurple(
  experiment_path = experiment.path,
  scenario_name = "baseline.art",
    summarize_columns = c("Population","Infected", "On_ART",
                        "Died", "Died_from_HIV",
                        "Newly.Infected","Diagnosed"),
  stratify_columns = c("Year", "Gender", "Age", "IP_Key.CMDStatus", "HasIntervention.SuppressedOnART"),
  min_age_inclusive = 0,
  max_age_inclusive = 99
)

# Baseline, no art
experiment.path = "/gpfs/scratch/citrod01/experiments/MATUMAINI/Baseline-campaign_MATUMAINI_202305-baseline_noart___2024_05_29_11_02_47_731450/"

impact.results.baseline.noart <- EMODAnalyzeR::read.simulation.results.bigpurple(
  experiment_path = experiment.path,
  scenario_name = "baseline.noart",
    summarize_columns = c("Population","Infected", "On_ART",
                        "Died", "Died_from_HIV",
                        "Newly.Infected","Diagnosed"),
  stratify_columns = c("Year", "Gender", "Age", "IP_Key.CMDStatus", "HasIntervention.SuppressedOnART"),
  min_age_inclusive = 0,
  max_age_inclusive = 99
)

```


```{r}
# Join together
sim.results.impact <- rbind(impact.results.decouple.art,
                         impact.results.decouple.noart,
                         impact.results.baseline.art,
                         impact.results.baseline.noart)

CENSUS_YEAR = 2009
KEN_CENSUS_POP = 5352385

sim.results.pop.scaling <- sim.results.impact %>% 
      filter(Year == CENSUS_YEAR) %>%
      group_by(sim.ix, scenario_name) %>%
      summarize(total.pop = sum(Population), .groups = 'keep') %>% 
      mutate(pop.scaling.factor = KEN_CENSUS_POP/total.pop)

sim.results.impact <- sim.results.impact %>% 
  inner_join(
    sim.results.pop.scaling,
    by = c("sim.ix", "scenario_name")
  )
```

### Define function

```{r}
bt_mean <- function(splits, colname){
  x <- as.data.frame(analysis(splits))
  mean(x[[colname]])
}


measure.art.impact <- function(data, colname, start_year, end_year, age_min, age_max){
  
  data['column.of.interest'] = data[colname]

  art.impact.data <- data %>% 
    filter(Year >= start_year, Year < end_year,
           Age >= age_min, Age < age_max) %>% 
    group_by(scenario_name, sim.ix) %>% 
    summarize(column.of.interest = sum(column.of.interest * pop.scaling.factor), .groups = "keep") %>% 
    ungroup() %>% 
    pivot_wider(id_cols = c(sim.ix), names_from = c(scenario_name), values_from = c(column.of.interest)) %>% 
    merge(
      data %>% 
        filter(Year >= start_year, Year < end_year,
               Age >= age_min, Age < age_max) %>% 
        group_by(scenario_name, sim.ix) %>% 
        summarize(On_ART = sum(On_ART * pop.scaling.factor), .groups = "keep") %>%
        ungroup() %>% 
        pivot_wider(id_cols = c(sim.ix), names_from = c(scenario_name), values_from = c(On_ART)) %>% 
        select(sim.ix = sim.ix, baseline.art.pyoa = baseline.art, decouple.art.pyoa = decouple.art)
    ) %>%
    mutate(baseline.art.impact = baseline.noart - baseline.art,
           decouple.art.impact = decouple.noart - decouple.art,
           baseline.art.ppyoa = case_when(
             baseline.art.pyoa > 0 ~ (baseline.noart - baseline.art)/baseline.art.pyoa,
             baseline.art.pyoa == 0 ~ 0
           ),
           decouple.art.ppyoa = case_when(
             decouple.art.pyoa > 0 ~ (decouple.noart - decouple.art)/decouple.art.pyoa,
             decouple.art.pyoa == 0 ~ 0
           )
     ) %>% 
    mutate(art.impact = baseline.art.impact - decouple.art.impact,
           art.impact.ppyoa = baseline.art.ppyoa - decouple.art.ppyoa) %>% 
    mutate(art.impact.pct = case_when(
              decouple.art.impact >0 ~ art.impact/decouple.art.impact,
              decouple.art.impact == 0 ~ 0),
           art.impact.ppyoa.pct = case_when(
              decouple.art.ppyoa > 0 ~ art.impact.ppyoa/decouple.art.ppyoa,
              decouple.art.ppyoa == 0 ~ 0)
    )

  art.impact.data.agg <- art.impact.data %>% 
      summarize(baseline.art.impact.sd = sd(baseline.art.impact),
                baseline.art.impact = mean(baseline.art.impact),
                decouple.art.impact.sd = sd(decouple.art.impact),
                decouple.art.impact = mean(decouple.art.impact),
                art.impact.sd = sd(art.impact),
                art.impact = mean(art.impact),
                art.impact.pct.sd = sd(art.impact.pct),
                art.impact.pct = mean(art.impact.pct),
                baseline.art.ppyoa.sd = sd(baseline.art.ppyoa),
                baseline.art.ppyoa = mean(baseline.art.ppyoa), 
                decouple.art.ppyoa.sd = sd(decouple.art.ppyoa),
                decouple.art.ppyoa = mean(decouple.art.ppyoa),
                art.impact.ppyoa.sd = sd(art.impact.ppyoa),
                art.impact.ppyoa = mean(art.impact.ppyoa),
                art.impact.ppyoa.pct.sd = sd(art.impact.ppyoa.pct),
                art.impact.ppyoa.pct = mean(art.impact.ppyoa.pct),
                .groups = "keep"
                ) %>%
      ungroup()
  
  bt_resamples <- bootstraps(art.impact.data, times = 500)
  bt_resamples$baseline.art.impact <- map_dbl(bt_resamples$splits, bt_mean, "baseline.art.impact")
  bt_resamples$decouple.art.impact <- map_dbl(bt_resamples$splits, bt_mean, "decouple.art.impact")
  bt_resamples$art.impact <- map_dbl(bt_resamples$splits, bt_mean, "art.impact")
  bt_resamples$art.impact.pct <- map_dbl(bt_resamples$splits, bt_mean, "art.impact.pct")
  bt_resamples$baseline.art.ppyoa <- map_dbl(bt_resamples$splits, bt_mean, "baseline.art.ppyoa")
  bt_resamples$decouple.art.ppyoa <- map_dbl(bt_resamples$splits, bt_mean, "decouple.art.ppyoa")
  bt_resamples$art.impact.ppyoa <- map_dbl(bt_resamples$splits, bt_mean, "art.impact.ppyoa")
  bt_resamples$art.impact.ppyoa.pct <- map_dbl(bt_resamples$splits, bt_mean, "art.impact.ppyoa.pct")
  
  baseline.art.impact_95 <- quantile(bt_resamples$baseline.art.impact, probs = c(.025, .975))
  decouple.art.impact_95 <- quantile(bt_resamples$decouple.art.impact, probs = c(.025, .975))
  art.impact_95 <- quantile(bt_resamples$art.impact, probs = c(.025, .975))
  art.impact.pct_95 <- quantile(bt_resamples$art.impact.pct, probs = c(.025, .975))
  baseline.art.ppyoa_95 <- quantile(bt_resamples$baseline.art.ppyoa, probs = c(.025, .975))
  decouple.art.ppyoa_95 <- quantile(bt_resamples$decouple.art.ppyoa, probs = c(.025, .975))
  art.impact.ppyoa_95 <- quantile(bt_resamples$art.impact.ppyoa, probs = c(.025, .975))
  art.impact.ppyoa.pct_95 <- quantile(bt_resamples$art.impact.ppyoa.pct, probs = c(.025, .975))
    
  art.impact.data.agg$baseline.art.impact_95LL <- baseline.art.impact_95[[1]]
  art.impact.data.agg$baseline.art.impact_95UL <- baseline.art.impact_95[[2]]
  art.impact.data.agg$decouple.art.impact_95LL <- decouple.art.impact_95[[1]]
  art.impact.data.agg$decouple.art.impact_95UL <- decouple.art.impact_95[[2]]
  art.impact.data.agg$art.impact_95LL <- art.impact_95[[1]]
  art.impact.data.agg$art.impact_95UL <- art.impact_95[[2]]
  art.impact.data.agg$art.impact.pct_95LL <- art.impact.pct_95[[1]]
  art.impact.data.agg$art.impact.pct_95UL <- art.impact.pct_95[[2]]
  art.impact.data.agg$baseline.art.ppyoa_95LL <- baseline.art.ppyoa_95[[1]]
  art.impact.data.agg$baseline.art.ppyoa_95UL <- baseline.art.ppyoa_95[[2]]
  art.impact.data.agg$decouple.art.ppyoa_95LL <- decouple.art.ppyoa_95[[1]]
  art.impact.data.agg$decouple.art.ppyoa_95UL <- decouple.art.ppyoa_95[[2]]
  art.impact.data.agg$art.impact.ppyoa_95LL <- art.impact.ppyoa_95[[1]]
  art.impact.data.agg$art.impact.ppyoa_95UL <- art.impact.ppyoa_95[[2]]
  art.impact.data.agg$art.impact.ppyoa.pct_95LL <- art.impact.ppyoa.pct_95[[1]]
  art.impact.data.agg$art.impact.ppyoa.pct_95UL <- art.impact.ppyoa.pct_95[[2]]
  
  art.impact.data.agg <- art.impact.data.agg %>% select(
        "baseline.art.impact", "baseline.art.impact.sd", "baseline.art.impact_95LL", "baseline.art.impact_95UL",
        "decouple.art.impact", "decouple.art.impact.sd", "decouple.art.impact_95LL", "decouple.art.impact_95UL",
        "art.impact", "art.impact.sd", "art.impact_95LL", "art.impact_95UL",
        "art.impact.pct", "art.impact.pct.sd", "art.impact.pct_95LL", "art.impact.pct_95UL",
        "baseline.art.ppyoa", "baseline.art.ppyoa.sd", "baseline.art.ppyoa_95LL", "baseline.art.ppyoa_95UL",
        "decouple.art.ppyoa", "decouple.art.ppyoa.sd", "decouple.art.ppyoa_95LL", "decouple.art.ppyoa_95UL",
        "art.impact.ppyoa", "art.impact.ppyoa.sd", "art.impact.ppyoa_95LL", "art.impact.ppyoa_95UL",
        "art.impact.ppyoa.pct", "art.impact.ppyoa.pct.sd", "art.impact.ppyoa.pct_95LL", "art.impact.ppyoa.pct_95UL"
      )
  
  art.impact.data.agg
}

```

### Calculate impact of ART

```{r}
measure.art.impact(sim.results.impact, "Died_from_HIV", 1980, 2015, 0, 15)
```


```{r}
age_min_list = c(0, 15, 25)
age_max_list = c(100, 25, 100)

start_year_list = c(1985, 1985, 2000, 2015, 2025, 1985)
end_year_list = c(2025, 2000, 2015, 2025, 2050, 2050)
label_list = c("Entire Past Pandemic", "Pre-ART", "ART Scaleup", "Universal ART", "Future Pandemic", "Past+Future Pandemic")

metrics = c("Newly.Infected", "Died_from_HIV")

start_years = c()
end_years = c()

impact.table <- data.table()
for (i in seq(1:length(age_min_list))){
  for (j in seq(1:length(start_year_list)) ){
    for (k in seq(1:length(metrics))) {
      holder <- measure.art.impact(sim.results.impact, metrics[[k]], start_year_list[[j]], end_year_list[[j]], age_min_list[[i]], age_max_list[[i]]) %>% 
        mutate(Ages = paste0(age_min_list[[i]], "-", age_max_list[[i]]),
               Years = paste0(start_year_list[[j]],"-",end_year_list[[j]]),
               Period = label_list[[j]],
               Metric = metrics[[k]])
      
      impact.table <- rbind(impact.table, holder)
    }
  }
}
colnames(impact.table)

impact.table <- impact.table %>% 
  select("Period", "Years", "Ages", "Metric",
         "art.impact.ppyoa", "art.impact.ppyoa.sd", "art.impact.ppyoa_95LL", "art.impact.ppyoa_95UL", 
         "art.impact.ppyoa.pct", "art.impact.ppyoa.pct.sd", "art.impact.ppyoa.pct_95LL", "art.impact.ppyoa.pct_95UL",
         "art.impact.pct", "art.impact.pct.sd", "art.impact.pct_95LL", "art.impact.pct_95UL", 
         "baseline.art.ppyoa", "baseline.art.ppyoa.sd", "baseline.art.ppyoa_95LL", "baseline.art.ppyoa_95UL",
         "decouple.art.ppyoa", "decouple.art.ppyoa.sd", "decouple.art.ppyoa_95LL", "decouple.art.ppyoa_95UL",
         "baseline.art.impact","baseline.art.impact.sd","baseline.art.impact_95LL", "baseline.art.impact_95UL", "decouple.art.impact","decouple.art.impact.sd",
         "decouple.art.impact_95LL","decouple.art.impact_95UL","art.impact","art.impact.sd","art.impact_95LL", "art.impact_95UL")  %>% 
  arrange(Years, Ages, Metric)
```


```{r}
impact.table %>% View

write_csv(impact.table, "impact_of_art_table_20240531.csv")
```

### 90-90-90 Metrics

```{r}

```

## Figures

```{r}
numbers.table <- read_csv("numbers_table_20240531.csv")

differences.table <- read_csv("differences_table_20240531.csv")

impact.table <- read_csv("impact_of_art_table_20240531.csv")
```

### Numbers table

```{r}
numbers.table %>% head

numbers.table$Period %>% unique 
```

```{r, fig.height=8}
numbers.table %>% 
  filter(Period == "Entire Past Pandemic") %>% 
  ggplot() + 
  geom_point(mapping = aes(x = scenario_name, y = Newly.Infected)) + 
  geom_errorbar(mapping = aes(x = scenario_name, ymin = Newly.Infected_95LL, ymax = Newly.Infected_95UL)) + 
  facet_grid(cols = vars(Ages), rows = vars(Period)) + 
  expand_limits(x = 0, y = 0) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))


numbers.table %>% 
  filter(Period == "Universal ART") %>% 
  ggplot() + 
  geom_point(mapping = aes(x = scenario_name, y = Newly.Infected)) + 
  geom_errorbar(mapping = aes(x = scenario_name, ymin = Newly.Infected_95LL, ymax = Newly.Infected_95UL)) + 
  facet_grid(cols = vars(Ages), rows = vars(Period)) + 
  #ylim(0,2.1e5) + 
  expand_limits(x = 0, y = 0) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

# ggplot(data = sim.results.all.agg.numbers) + 
#   geom_point(mapping = aes(x = scenario_name, y = Newly.Infected, color = Gender)) + 
#   geom_errorbar(aes(x=scenario_name, ymin = Newly.Infected_95LL, ymax = Newly.Infected_95UL)) + 
#   facet_wrap(~ Gender, ncol=2) + 
#   scale_color_manual(values = c("red", "blue"))  + 
#   theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) 
# #+ 
# #  scale_y_continuous(limits = c(5e5, 9e5)) 

```

## Differences Table

```{r, fig.height=8}
differences.table %>% head

differences.table$Period %>% unique 
```

### HIV deaths differences
```{r fig.height=12}
differences.table %>% 
  filter(Period == "Universal ART") %>% 
  ggplot() + 
  geom_point(mapping = aes(x = scenario_name, y = Died_from_HIV.pct)) + 
  geom_errorbar(mapping = aes(x = scenario_name, ymin = Died_from_HIV.pct_95LL, ymax = Died_from_HIV.pct_95UL)) + 
  facet_grid(cols = vars(Ages), rows = vars(Period)) + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) 

differences.table %>% 
  filter(Period == "Entire Past Pandemic") %>% 
  ggplot() + 
  geom_point(mapping = aes(x = scenario_name, y = Died_from_HIV.pct)) + 
  geom_errorbar(mapping = aes(x = scenario_name, ymin = Died_from_HIV.pct_95LL, ymax = Died_from_HIV.pct_95UL)) + 
  facet_grid(cols = vars(Ages), rows = vars(Period)) + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) 


differences.table %>% 
  filter(Period == "Future Pandemic") %>%   
  ggplot() + 
  geom_point(mapping = aes(x = scenario_name, y = Died_from_HIV.pct)) + 
  geom_errorbar(mapping = aes(x = scenario_name, ymin = Died_from_HIV.pct_95LL, ymax = Died_from_HIV.pct_95UL)) + 
  facet_grid(cols = vars(Ages), rows = vars(Period)) + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) 


differences.table %>% 
  filter(! Period %in% c("Entire Past Pandemic", "Past+Future Pandemic")) %>% 
  ggplot() + 
  geom_point(mapping = aes(x = scenario_name, y = Died_from_HIV.pct)) + 
  geom_errorbar(mapping = aes(x = scenario_name, ymin = Died_from_HIV.pct_95LL, ymax = Died_from_HIV.pct_95UL)) + 
  facet_grid(cols = vars(Ages), rows = vars(Years)) + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) 


```

```{r, fig.height = 8}
differences.table %>% 
  filter(! Period %in% c("Entire Past Pandemic", "Past+Future Pandemic")) %>% 
  filter(scenario_name == "baseline.art") %>% 
  ggplot() + 
  geom_point(mapping = aes(x = Years, y = Died_from_HIV.pct, color = scenario_name)) + 
  geom_errorbar(mapping = aes(x = Years, ymin = Died_from_HIV.pct_95LL, ymax = Died_from_HIV.pct_95UL)) + 
  facet_grid(rows = vars(Ages)) + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) 

differences.table %>% 
  filter(! Period %in% c("Entire Past Pandemic", "Past+Future Pandemic")) %>% 
  filter(scenario_name == "decouple.art.hivinc") %>% 
  ggplot() + 
  geom_point(mapping = aes(x = Years, y = Died_from_HIV.pct, color = scenario_name)) + 
  geom_errorbar(mapping = aes(x = Years, ymin = Died_from_HIV.pct_95LL, ymax = Died_from_HIV.pct_95UL)) + 
  facet_grid(rows = vars(Ages)) + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) 


differences.table %>% 
  filter(! Period %in% c("Entire Past Pandemic", "Past+Future Pandemic")) %>% 
  filter(scenario_name == "decouple.art.hivinc") %>% 
  ggplot() + 
  geom_point(mapping = aes(x = Years, y = Died_from_HIV.diff, color = scenario_name)) + 
  geom_errorbar(mapping = aes(x = Years, ymin = Died_from_HIV.diff_95LL, ymax = Died_from_HIV.diff_95UL)) + 
  facet_grid(rows = vars(Ages)) + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
```


### New Infections

```{r, fig.height=8}
differences.table %>% 
  filter(Period == "Universal ART") %>% 
  ggplot() + 
  geom_point(mapping = aes(x = scenario_name, y = Newly.Infected.pct)) + 
  geom_errorbar(mapping = aes(x = scenario_name, ymin = Newly.Infected.pct_95LL, ymax = Newly.Infected.pct_95UL)) + 
  facet_grid(cols = vars(Ages), rows = vars(Period)) + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) 

differences.table %>% 
  filter(Period == "Entire Past Pandemic") %>% 
  ggplot() + 
  geom_point(mapping = aes(x = scenario_name, y = Newly.Infected.pct)) + 
  geom_errorbar(mapping = aes(x = scenario_name, ymin = Newly.Infected.pct_95LL, ymax = Newly.Infected.pct_95UL)) + 
  facet_grid(cols = vars(Ages), rows = vars(Period)) + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) 

differences.table %>% 
  filter(Period == "Future Pandemic") %>% 
  ggplot() + 
  geom_point(mapping = aes(x = scenario_name, y = Newly.Infected.pct)) + 
  geom_errorbar(mapping = aes(x = scenario_name, ymin = Newly.Infected.pct_95LL, ymax = Newly.Infected.pct_95UL)) + 
  facet_grid(cols = vars(Ages), rows = vars(Period)) + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) 


differences.table %>% 
  ggplot() + 
  geom_point(mapping = aes(x = scenario_name, y = Newly.Infected.pct)) + 
  geom_errorbar(mapping = aes(x = scenario_name, ymin = Newly.Infected.pct_95LL, ymax = Newly.Infected.pct_95UL)) + 
  facet_grid(cols = vars(Ages), rows = vars(Period), scales = "free") + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) 

```

## Impact of ART

```{r}
impact.table %>% View
```

### Impact of ART 

```{r fig.height=10}
impact.table %>% 
  ggplot() + 
  geom_point(mapping = aes(x = Ages, y = art.impact.ppyoa)) + 
  geom_errorbar(mapping = aes(x = Ages, ymin = art.impact.ppyoa_95LL, ymax = art.impact.ppyoa_95UL)) + 
  facet_grid(cols = vars(Metric), rows = vars(Period), scales = "free") + 
  expand_limits(x = 0, y = 0) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) 

```

### Percentage impact of ART Per-Person-Year-OnART
```{r fig.height=10}
impact.table %>% 
  ggplot() + 
  geom_point(mapping = aes(x = Ages, y = art.impact.ppyoa.pct)) + 
  geom_errorbar(mapping = aes(x = Ages, ymin = art.impact.ppyoa.pct_95LL, ymax = art.impact.ppyoa.pct_95UL)) + 
  facet_grid(cols = vars(Metric), rows = vars(Period), scales = "free") + 
  expand_limits(x = 0, y = 0) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) 

```