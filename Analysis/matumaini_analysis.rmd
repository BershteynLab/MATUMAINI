---
title: "Matumaini_Analysis"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# MATUMAINI Analysis

The purpose of this notebook is to spot check some of the results from our MATUMAINI mental health model.

```{r Load Libraries}
library(tidyverse)
library(tidyr)
library(data.table)
library(magrittr)
library(ggplot2)
library(devtools)
library(readxl)
devtools::install_github("BershteynLab/EMODAnalyzeR")
```

```{r}
usethis::create_github_token()

usethis::edit_r_environ()

gitcreds::gitcreds_set()
```

# Checking on events in the new cascade

```{r}
event.recorder = read.csv("/gpfs/scratch/citrod01/experiments/MATUMAINI/Baseline-campaign_MATUMAINI_202305-IDM_MH___2023_05_18_11_32_56_337030/Simulation_0R4P9SX6/output/ReportEventRecorder.csv",
                          skip = 920000)

event.recorder = read.csv("/gpfs/scratch/citrod01/experiments/MATUMAINI/Baseline-campaign_MATUMAINI_202305-IDM_base___2023_05_18_11_32_23_752627/Simulation_2JTFHYYM/output/ReportEventRecorder.csv", 
                          skip = 920000)

colnames(event.recorder) <- c("Time","Year","Node_ID","Event_Name","Individual_ID","Age","Gender","Infected","Infectiousness","HasHIV","OnART","CD4","WHO_Stage","HIV_Stage","InterventionStatus")

event.recorder %>% filter(Year >= 2015) %>% arrange(Individual_ID, Year) %>% View
```
Wow, it'll be really hard to check on some of these things, in particular the testing loop

I can check on the low risk vs medium risk thing
I can try checking on the duration of depression, which may be tough



# Duration of Depression Episode

```{r Duration of depression episode}

event.recorder = fread("/gpfs/scratch/citrod01/experiments/MATUMAINI/Baseline-campaign_Nyanza_baseline_202301-Baseline___2023_03_20_20_06_13_372862/Simulation_6F9M2RC4/output/ReportEventRecorder.csv")

a = event.recorder %>% select( "Year", "Event_Name", "Individual_ID") %>% 
  filter(Event_Name %in% c("CMD_NoTreat", "CMD_NoTreat_Recovery")) %>% 
  filter(Year > 1992) %>% 
  filter(Year < 2025) %>% 
  arrange(Year) %>% 
  group_by(Event_Name, Individual_ID) %>% 
  slice(1) %>% 
  pivot_wider(id_cols = c(Individual_ID), values_from = c(Year), names_from = Event_Name) %>% 
  filter(!is.na(CMD_NoTreat_Recovery)) %>% 
  filter(!is.na(CMD_NoTreat)) %>% 
  mutate(diff = CMD_NoTreat_Recovery - CMD_NoTreat ) 

a %>% 
  filter(diff > 0) %>% 
  .$diff %>% hist()

a %>% 
  filter(diff > 0) %>% 
  .$diff %>% summary()
```

I dunno, close enough?

# Plotting first successful calibration

2023-03-30 - ran the first calibration of the new model, featuring mental health as one of the calibration targets.

```{r Read in simulation results}

# res_path = "/gpfs/scratch/citrod01/experiments/MATUMAINI/Baseline-campaign_MATUMAINI_202305-MH_test___2023_05_13_12_04_46_863189"
sim.cmd <- EMODAnalyzeR::read.simulation.results(
  results_path = res_path,
  scenario_name = 'baseline',
  summarize_columns = c("Newly.Infected", "Newly.Tested.Positive",
    "Newly.Tested.Negative", "Population", "Infected", "On_ART", "Died", "Died_from_HIV",
    "Tested.Past.Year.or.On_ART", "Tested.Ever", "Diagnosed"),
  stratify_columns = c("Year", "Age", "Gender", "IP_Key.CMDStatus"),
  min_age_inclusive = 18,
  max_age_inclusive = 99
)

CENSUS_YEAR = 2009
ZWE_CENSUS_POP = 2697858 

sim.results.pop.scaling <- sim.cmd %>% 
      filter(Year == CENSUS_YEAR) %>%
      group_by(sim.id) %>%
      summarize(total.pop = sum(Population), .groups = 'keep') %>% 
      mutate(pop.scaling.factor = ZWE_CENSUS_POP/total.pop)

sim.cmd <- sim.cmd %>% 
  inner_join(
    sim.results.pop.scaling,
    by = c("sim.id")
  )
```

## Read in the calibration targets

Need to figure out how to read an excel file.
```{r}
xl.path = "/gpfs/data/bershteynlab/EMOD/citrod01/MATUMAINI/202301_Nyanza_Baseline_MalariaOngoing/Data/calibration_ingest_form_Nyanza_MATUMAINI.xlsm"

obs.prev.sheet <- readxl::read_excel(xl.path, sheet = "Obs-Prevalence", range = "A8:G173", col_names = TRUE)

obs.onart.sheet <- readxl::read_excel(xl.path, sheet = "Obs-OnART", range = "A8:G202", col_names = TRUE)

obs.cmdprev.sheet <- readxl::read_excel(xl.path, sheet = "Obs-CMDPrevalence", range = "A8:G22", col_names = TRUE)
```


## Prevalence
```{r}
emodplot.prevalence <- function(data,
                           date.start,
                           date.end,
                           title = "HIV prevalence") {
  data <- data %>% 
    group_by(Year, Gender, sim.id, scenario_name) %>% 
    summarize(Infected = sum(Infected), Population = sum(Population), .groups = 'keep') %>% 
    mutate(Prevalence = case_when(Population == 0 ~ 0,
                                  Population > 0 ~ Infected / Population))
  y.lim.max <- min(max(data$Prevalence) * 1.2, 1)
  p <- EMODAnalyzeR::emodplot.by_gender(data, date.start, date.end, 'Prevalence', title=title ) +
    scale_y_continuous(labels = scales::percent_format(accuracy = 1), breaks = seq(0, y.lim.max,0.05), limits=c(0,y.lim.max)) +
    ylab("HIV Prevalence (%)")
  return(p)
}

p <- emodplot.prevalence(sim.cmd %>% filter(Age <= 50, Age >= 15), 
                          1990, 2040, 
                          title = 'All Ages Prevalence')

p + 
  geom_point(data = obs.prev.sheet %>% 
               filter(Province == 'All', AgeBin == "[15:50)", Gender %in% c("Male", "Female")), 
             mapping = aes(x = Year, y = Prevalence))
```
## OnArt coverage

```{r}
data <- sim.cmd %>% 
    group_by(Year, Gender, sim.id, scenario_name) %>% 
    summarize(On_ART = sum(On_ART), Population = sum(Population), .groups = 'keep') %>% 
    mutate(ARTCov = case_when(Population == 0 ~ 0,
                              Population > 0 ~ On_ART / Population))

p <- EMODAnalyzeR::emodplot.by_gender(data, 1990, 2040, 'ARTCov', title="ART Coverage") 
  

p


```
## Number on ART

```{r Number on ART}

data <- sim.cmd %>% 
    group_by(Year, Gender, sim.id, scenario_name) %>% 
    summarize(On_ART = sum(On_ART*pop.scale.factor), Population = sum(Population), .groups = 'keep')

p <- EMODAnalyzeR::emodplot.by_gender(data, 1990, 2040, 'On_ART', title="ART") 

p + 
  geom_point(data = obs.onart.sheet %>% filter(Province != "All", AgeBin == '[15:100)') %>% 
    group_by(Year, Gender) %>% 
    summarize(OnART = sum(OnART), .groups = 'keep'),
    mapping= aes(x = Year, y = OnART))
```


## Incidence

```{r}
EMODAnalyzeR::emodplot.incidence(sim.cmd,
                                 1990, 2040)
```

## Population
```{r Population}
EMODAnalyzeR::emodplot.by_gender(sim.cmd,
                                 1990,2040,
                                 col2plot = 'Population',
                                 title = "Population")
```



## CMD Prevalence

```{r Calculate CMD Prevalence}
# Aggregate CMD prevalence, to plot using EMODAnalyzer
p <- sim.cmd %>% 
  pivot_wider(id_cols = c(Year, Age, Gender, sim.id, scenario_name),
              names_from = c(IP_Key.CMDStatus),
              values_from = c(Population)) %>% 
  group_by(Year, Gender, sim.id, scenario_name) %>% 
  summarize(CMD_pos = sum(CMD_pos), 
            Population = sum(CMD_pos + CMD_neg + CMD_remission + CMD_remission_treated), 
            .groups = 'keep') %>% 
  mutate(CMD_prev = case_when(Population == 0 ~ 0,
                              Population > 0 ~ CMD_pos / Population))

# Calculate means across year and gender
p1 <- p %>%
  group_by(Year, Gender, scenario_name) %>% 
  summarize(CMD_prev = mean(CMD_prev), 
            CMD_pos = mean(CMD_pos),
            Population = mean(Population), 
            .groups = 'keep')  
```

```{r Plot CMD Prevalence}
EMODAnalyzeR::emodplot.by_gender(p,
                   date.start = 2000, date.end = 2020,
                   col2plot = 'CMD_prev',
                   title = 'CMD Prevalence'
)
```

```{r CMD Prevalence by Age}

p.age <- sim.cmd %>% 
  pivot_wider(id_cols = c(Year, Age, Gender, sim.id, scenario_name),
              names_from = c(IP_Key.CMDStatus),
              values_from = c(Population)) %>% 
  group_by(Year, Age, Gender, sim.id, scenario_name) %>% 
  summarize(CMD_pos = sum(CMD_pos), 
            Population = sum(CMD_pos + CMD_neg + CMD_remission + CMD_remission_treated), 
            .groups = 'keep') %>% 
  mutate(CMD_prev = case_when(Population == 0 ~ 0,
                              Population > 0 ~ CMD_pos / Population))

p1.age <- p.age %>%
  group_by(Year, Age, Gender, scenario_name) %>% 
  summarize(CMD_prev = mean(CMD_prev), 
            CMD_pos = mean(CMD_pos),
            Population = mean(Population), 
            .groups = 'keep')

```

```{r Functions for age prevalence curves}

emodplot.by_age_gender <- function(data, 
                                   numerator = "Infected", 
                                   denominator = "Population", 
                                   subset_years = c(2005), 
                                   age_bins = c(15,20,25,30,35,40,45,50,55,60,65,99), 
                                   yaxis_lab = "", 
                                   title = "") {
  # Build color mapping function, each scenario gets its own color
  nScenarios = length(unique(data$scenario_name))
  if (nScenarios == 1) {
    colors2plot <- c('blue3')
  } else {
    colors2plot <- colors[1:nScenarios]
  }
  
  # Subset data on years
  data <- data %>% filter(Year %in% subset_years)
  
  # Age bins
  age_labels = c()
  for (i in 1:(length(age_bins) - 1)){
    age_labels <- append(age_labels, paste0("[",age_bins[i],":",age_bins[i + 1],")"))
  }
  
  # Label each age by its bin
  data <- data %>% mutate(
    AgeBin = cut(Age, breaks = age_bins, right = FALSE)
    ) %>%
    filter(!is.na(AgeBin))
  
  data$AgeBin_index = factor(data$AgeBin,labels = 1:length(7))
  
  # Pick out the numerator and denominator
  data['Numerator'] = data[numerator]
  data['Denominator'] = data[denominator]
  
  # Calculate prevalence, grouping by age bin
  data.prev <- data %>% group_by(Year, AgeBin_index, AgeBin, Gender, scenario_name, sim.id) %>% 
    summarize(num = sum(Numerator), denom = sum(Denominator), .groups = 'keep') %>% 
    mutate(Prevalence = num/denom)
  # Calculate mean prevalence across all sim runs
  data.mean <- data.prev %>% group_by(Year, AgeBin_index, AgeBin, Gender, scenario_name) %>% 
    summarize(mean.Prevalence = mean(Prevalence),
              sd.Prevalence = sd(Prevalence),
              .groups = 'keep') %>% 
    mutate(lower = max(mean.Prevalence - 2* sd.Prevalence, 0), 
           upper = mean.Prevalence + 2*sd.Prevalence)
  
  # Transform data
  data.prev <- data.prev %>% mutate(Gender = case_when(Gender==0 ~ "Male", Gender==1 ~ "Female"))
  data.mean <- data.mean %>% mutate(Gender = case_when(Gender==0 ~ "Male", Gender==1 ~ "Female"))
  
  p <- data.mean %>% 
    ggplot() + 
    # plot means
    geom_point(
      mapping = aes(x = AgeBin_index, y = mean.Prevalence, color = scenario_name),
      size=1
    ) + 
    geom_errorbar(
      mapping = aes(x=AgeBin_index, ymin=lower, ymax=upper, color=scenario_name),
      width=.15, size=1) + 
    facet_grid(cols = vars(Gender), rows = vars(Year)) + 
    xlab("Age") + 
    ylab(yaxis_lab) +
    theme_bw(base_size=16) +
    guides(fill = guide_legend(keywidth = 2, keyheight = 1)) +
    scale_x_discrete(
      breaks = 1:length(age_labels),
      labels = age_labels
      ) +
    theme(legend.position="bottom") +
    theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
    theme(strip.background = element_rect(colour="black", fill="white")) +
    theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) + 
    scale_color_manual(values=colors2plot) + 
    labs(title = title)
  return(p)
}


emodplot.age_prevalence <- function(data,
                                    subset_years = c(2005), 
                                    age_bins = c(15,20,25,30,35,40,45,50,55,60,65,99),
                                    title = "Age-Prevalence Curves") {
  p <- emodplot.by_age_gender(data, "Infected", "Population",
                              subset_years, age_bins,
                              yaxis_lab = "Prevalence",
                              title = title)
  return(p)
}

subset_years = c(2006, 2011, 2015, 2016)
age_bins = c(18,25,30,40,45,50,60,99)

emodplot.by_age_gender(sim.cmd, "Infected", "Population", 
                       subset_years, age_bins, yaxis_lab = "Prevalence", 
                       title = "Age Prevalence Curves")
```
 

```{r Plot CMD Prevalence by Age}

age_bins = c(18, 25, 30, 40, 45, 50, 60, 99)
subset_years = c(2004)

p <- sim.cmd %>% pivot_wider(
  id_cols = c(Year, Age, Gender, scenario_name, sim.id), 
  names_from= "IP_Key.CMDStatus",
  values_from = "Population"
) %>% 
  mutate(Population = CMD_neg + CMD_pos + CMD_remission +CMD_remission_treated) %>% 
  emodplot.by_age_gender("CMD_pos", "Population", 
                       subset_years, age_bins, 
                       yaxis_lab = "CMD Prevalence", 
                       title = "CMD Prevalence by Age")

data <- obs.cmdprev.sheet
data$AgeBin_index = factor(data$AgeBin,labels = 1:length(age_labels))

p + 
  geom_point(data = data, 
             mapping = aes(x = AgeBin_index, y = CMDPrevalence))
```

# Plotting calibration of age-prevalence CMD curves

2023-05-10 - attempting to hit calibration targets for CMD


```{r Read in simulation results}
# Baseline, without treatment for CMD
res_path = "/gpfs/data/bershteynlab/EMOD/citrod01/MATUMAINI/202301_Nyanza_Baseline_MalariaOngoing/IDM_test_2/Baseline-campaign_MATUMAINI_202305-IDMtest_base/ReportHIVByAgeAndGender"


res_path = "/gpfs/data/bershteynlab/EMOD/citrod01/MATUMAINI/202301_Nyanza_Baseline_MalariaOngoing/IDM_test_3/Baseline-campaign_MATUMAINI_202305-IDMtest_base/ReportHIVByAgeAndGender"

res_path = "/gpfs/data/bershteynlab/EMOD/citrod01/MATUMAINI/202301_Nyanza_Baseline_MalariaOngoing/IDM_test_4/Baseline-campaign_MATUMAINI_202305-IDMtest_base/ReportHIVByAgeAndGender"

sim.cmd <- EMODAnalyzeR::read.simulation.results.bigpurple(
  experiment_path = res_path,
  scenario_name = 'baseline',
  summarize_columns = c("Newly.Infected", "Newly.Tested.Positive",
    "Newly.Tested.Negative", "Population", "Infected", "On_ART", "Died", "Died_from_HIV",
    "Tested.Past.Year.or.On_ART", "Tested.Ever", "Diagnosed"),
  stratify_columns = c("Year", "Age", "Gender", "IP_Key.CMDStatus"),
  min_age_inclusive = 0,
  max_age_inclusive = 99
)

CENSUS_YEAR = 2009
KEN_CENSUS_POP = 5352385

sim.results.pop.scaling <- sim.cmd %>% 
      filter(Year == CENSUS_YEAR) %>%
      group_by(sim.id) %>%
      summarize(total.pop = sum(Population), .groups = 'keep') %>% 
      mutate(pop.scaling.factor = KEN_CENSUS_POP/total.pop)

sim.cmd <- sim.cmd %>% 
  inner_join(
    sim.results.pop.scaling,
    by = c("sim.id")
  )


# Adding treatment for CMD
#res_path = "/gpfs/data/bershteynlab/EMOD/citrod01/MATUMAINI/202301_Nyanza_Baseline_MalariaOngoing/IDM_test_2/Baseline-campaign_MATUMAINI_202305-IDMtest_MH/ReportHIVByAgeAndGender/"
res_path = "/gpfs/data/bershteynlab/EMOD/citrod01/MATUMAINI/202301_Nyanza_Baseline_MalariaOngoing/IDM_test_3/Baseline-campaign_MATUMAINI_202305-IDMtest_MH/ReportHIVByAgeAndGender"

sim.cmd.mh <- EMODAnalyzeR::read.simulation.results(
  results_path = res_path,
  scenario_name = 'baseline',
  summarize_columns = c("Newly.Infected", "Newly.Tested.Positive",
    "Newly.Tested.Negative", "Population", "Infected", "On_ART", "Died", "Died_from_HIV",
    "Tested.Past.Year.or.On_ART", "Tested.Ever", "Diagnosed"),
  stratify_columns = c("Year", "Age", "Gender", "IP_Key.CMDStatus"),
  min_age_inclusive = 0,
  max_age_inclusive = 99
)

CENSUS_YEAR = 2009
KEN_CENSUS_POP = 5352385

sim.results.pop.scaling <- sim.cmd.mh %>% 
      filter(Year == CENSUS_YEAR) %>%
      group_by(sim.id) %>%
      summarize(total.pop = sum(Population), .groups = 'keep') %>% 
      mutate(pop.scaling.factor = KEN_CENSUS_POP/total.pop)

sim.cmd.mh <- sim.cmd.mh %>% 
  inner_join(
    sim.results.pop.scaling,
    by = c("sim.id")
  )
```

```{r Read CMD data off big purple}
#experiment_path = "/gpfs/scratch/citrod01/experiments/MATUMAINI/Baseline-campaign_MATUMAINI_202305-IDMtest_base___2023_05_22_20_50_57_759592/"
experiment_path = "/gpfs/scratch/citrod01/experiments/MATUMAINI/Baseline-campaign_MATUMAINI_202305-IDMtest_base___2023_05_23_14_12_17_546199"
summarize_columns = c("Newly.Infected", "Newly.Tested.Positive",
    "Newly.Tested.Negative", "Population", "Infected", "On_ART", "Died", "Died_from_HIV",
    "Tested.Past.Year.or.On_ART", "Tested.Ever", "Diagnosed")
stratify_columns = c("Year", "Age", "Gender", "IP_Key.CMDStatus")

folder.list = Sys.glob(paste0(experiment_path, "/Simulation_*"))
n_runs_to_analyze = length(folder.list)
print(paste('Found',as.character(n_runs_to_analyze),'output files '))
data.list = list()
for (i in seq(1,length(folder.list),1)){
  f <- paste(folder.list[i], "output/ReportHIVByAgeAndGender.csv", sep="/")
  raw.data <- fread(f, check.names = TRUE)
  data.list[[i]] <- EMODAnalyzeR::read.each_sim_by_age_and_gender(f, summarize_columns, stratify_columns, 0, 99 )
  data.list[[i]]$sim.id <- paste0(i)
  if (TRUE) print(paste0("Done Reading File ", i))
}

sim.cmd = bind_rows(data.list)

CENSUS_YEAR = 2009
KEN_CENSUS_POP = 5352385

sim.results.pop.scaling <- sim.cmd %>% 
      filter(Year == CENSUS_YEAR) %>%
      group_by(sim.id) %>%
      summarize(total.pop = sum(Population), .groups = 'keep') %>% 
      mutate(pop.scaling.factor = KEN_CENSUS_POP/total.pop)

sim.cmd <- sim.cmd %>% 
  inner_join(
    sim.results.pop.scaling,
    by = c("sim.id")
  )
sim.cmd$scenario_name = 'baseline'

experiment_path = "/gpfs/scratch/citrod01/experiments/MATUMAINI/Baseline-campaign_MATUMAINI_202305-IDMtest_MH___2023_05_23_02_26_12_247135"
folder.list = Sys.glob(paste0(experiment_path, "/Simulation_*"))
n_runs_to_analyze = length(folder.list)
print(paste('Found',as.character(n_runs_to_analyze),'output files '))
data.list = list()
for (i in seq(1,length(folder.list),1)){
  f <- paste(folder.list[i], "output/ReportHIVByAgeAndGender.csv", sep="/")
  raw.data <- fread(f, check.names = TRUE)
  data.list[[i]] <- EMODAnalyzeR::read.each_sim_by_age_and_gender(f, summarize_columns, stratify_columns, 0, 99 )
  data.list[[i]]$sim.id <- paste0(i)
  if (TRUE) print(paste0("Done Reading File ", i))
}

sim.cmd.mh = bind_rows(data.list)

CENSUS_YEAR = 2009
KEN_CENSUS_POP = 5352385

sim.results.pop.scaling <- sim.cmd.mh %>% 
      filter(Year == CENSUS_YEAR) %>%
      group_by(sim.id) %>%
      summarize(total.pop = sum(Population), .groups = 'keep') %>% 
      mutate(pop.scaling.factor = KEN_CENSUS_POP/total.pop)

sim.cmd.mh <- sim.cmd.mh %>% 
  inner_join(
    sim.results.pop.scaling,
    by = c("sim.id")
  )
sim.cmd.mh$scenario_name = 'mh'

```


## Read in the calibration targets

```{r}
xl.path = "/gpfs/data/bershteynlab/EMOD/citrod01/MATUMAINI/202301_Nyanza_Baseline_MalariaOngoing/Data/calibration_ingest_form_Nyanza_MATUMAINI.xlsm"

obs.prev.sheet <- readxl::read_excel(xl.path, sheet = "Obs-Prevalence", range = "A8:G173", col_names = TRUE)

obs.onart.sheet <- readxl::read_excel(xl.path, sheet = "Obs-OnART", range = "A8:G202", col_names = TRUE)

#obs.cmdprev.sheet <- readxl::read_excel(xl.path, sheet = "Obs-CMDPrevalence", range = "A8:G22", col_names = TRUE)

obs.pop.sheet <- readxl::read_excel(xl.path, sheet = "Obs-Population", range = "A8:G224", col_names = TRUE)
```


## Prevalence
```{r Fixed prevalence functions}

emodplot.prevalence <- function(data,
                           date.start,
                           date.end,
                           title = "HIV prevalence") {
  data <- data %>% 
    group_by(Year, Gender, sim.id, scenario_name) %>% 
    summarize(Infected = sum(Infected), Population = sum(Population), .groups = 'keep') %>% 
    mutate(Prevalence = case_when(Population == 0 ~ 0,
                                  Population > 0 ~ Infected / Population))
  y.lim.max <- min(max(data$Prevalence) * 1.2, 1)
  p <- EMODAnalyzeR::emodplot.by_gender(data, date.start, date.end, 'Prevalence', title=title ) +
    scale_y_continuous(labels = scales::percent_format(accuracy = 1), breaks = seq(0, y.lim.max,0.05), limits=c(0,y.lim.max)) +
    ylab("HIV Prevalence (%)")
  return(p)
}


emodplot.by_age_gender.cmd <- function(data, 
                                   numerator = "Infected", 
                                   denominator = "Population", 
                                   subset_years = c(2005), 
                                   age_bins = c(15,20,25,30,35,40,45,50,55,60,65,99), 
                                   yaxis_lab = "", 
                                   title = "") {
  # Build color mapping function, each scenario gets its own color
    nScenarios = length(unique(data$scenario_name))
  if (nScenarios == 1) {
    colors2plot <- c('blue3')
  } else {
    colors2plot <- colors[1:nScenarios]
  }
  
  # Subset data on years
  data <- data %>% filter(Year %in% subset_years)
  
  # Age bins  
  age_labels = c()
  for (i in 1:(length(age_bins) - 1)){
    age_labels <- append(age_labels, paste0("[",age_bins[i],":",age_bins[i + 1],")"))
  }
  
  # Label each age by its bin
  data <- data %>% mutate(
    AgeBin = cut(Age, breaks = age_bins, right = FALSE)
    ) %>%
    filter(!is.na(AgeBin))
  data$AgeBin_index = factor(data$AgeBin,labels = 1:length(age_labels))
  
  # Pick out the numerator and denominator
  data['Numerator'] = data[numerator]
  data['Denominator'] = data[denominator]
    
  # Calculate prevalence, grouping by age bin
  data.prev <- data %>% group_by(Year, AgeBin_index, AgeBin, Gender, scenario_name, sim.id) %>% 
    summarize(num = sum(Numerator), denom = sum(Denominator), .groups = 'keep') %>% 
    mutate(Prevalence = num/denom)
  # Calculate mean prevalence across all sim runs
  data.mean <- data.prev %>% group_by(Year, AgeBin_index, AgeBin, Gender, scenario_name) %>% 
    summarize(mean.Prevalence = mean(Prevalence),
              sd.Prevalence = sd(Prevalence),
              .groups = 'keep') %>% 
    mutate(lower = max(mean.Prevalence - 2* sd.Prevalence, 0), 
           upper = mean.Prevalence + 2*sd.Prevalence)
  
  # Transform data
  data.prev <- data.prev %>% ungroup() %>% mutate(Gender = case_when(Gender==0 ~ "Male", Gender==1 ~ "Female"))
  data.mean <- data.mean %>% ungroup() %>% mutate(Gender = case_when(Gender==0 ~ "Male", Gender==1 ~ "Female"))
  
  p <- data.mean %>% 
    ggplot() + 
    # plot means
    geom_point(
      mapping = aes(x = AgeBin_index, y = mean.Prevalence, color = scenario_name),
      size=1
    ) + 
    geom_errorbar(
      mapping = aes(x=AgeBin_index, ymin=lower, ymax=upper, color=scenario_name),
      width=.15, size=1) + 
    facet_grid(cols = vars(Gender), rows = vars(Year)) + 
    xlab("Age") + 
    ylab(yaxis_lab) +
    theme_bw(base_size=16) +
    guides(fill = guide_legend(keywidth = 2, keyheight = 1)) +
    scale_x_discrete(
      breaks = 1:length(age_labels),
      labels = age_labels
      ) +
    theme(legend.position="bottom") +
    theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
    theme(strip.background = element_rect(colour="black", fill="white")) +
    theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) + 
    scale_color_manual(values=colors2plot) + 
    labs(title = title)
  
  return(p)
  }

```

```{r}
sim.cmd %>% filter(Age <= 50, Age >= 15) %>% 
  filter(Year == 2004) %>% 
  group_by(Year, Age, Gender, sim.id) %>% 
  summarize(Infected = sum(Infected), Population = sum(Population), .groups = 'keep') %>% 
  ungroup() %>% 
  mutate(Prevalence = case_when(Population == 0 ~ 0, 
                                Population >0 ~ Infected/Population)) %>% 
  group_by(Year, Age, Gender) %>%
  summarize(Prevalence = mean(Prevalence), .groups = 'keep') %>% View
```

```{r All ages prevalence for baseline}
p <- emodplot.prevalence(sim.cmd %>% filter(Age <= 50, Age >= 15), 
                          1990, 2040, 
                          title = 'All Ages Prevalence')

p + 
  geom_point(data = obs.prev.sheet %>% 
               filter(Province == 'All', AgeBin == "[15:50)", Gender %in% c("Male", "Female")), 
             mapping = aes(x = Year, y = Prevalence))
```

```{r All ages prevalence with treatment}
p <- emodplot.prevalence(sim.cmd.mh %>% filter(Age <= 50, Age >= 15), 
                          1990, 2040, 
                          title = 'All Ages Prevalence')

p + 
  geom_point(data = obs.prev.sheet %>% 
               filter(Province == 'All', AgeBin == "[15:50)", Gender %in% c("Male", "Female")), 
             mapping = aes(x = Year, y = Prevalence))
```

```{r}
base.prev <- sim.cmd %>% filter(Age <= 50, Age >= 15, Year >= 1990, Year <= 2040) %>% 
  group_by(Year, Gender, sim.id, scenario_name) %>% 
  summarize(Infected = sum(Infected), Population = sum(Population), .groups = 'keep') %>% 
  ungroup %>% 
  mutate(Prevalence = case_when(Population == 0 ~ 0,
                                  Population > 0 ~ Infected / Population))  %>% 
  group_by(Year, Gender) %>% 
  summarize(Prevalence = mean(Prevalence))


mh.prev <- sim.cmd.mh %>% filter(Age <= 50, Age >= 15, Year >= 1990, Year <= 2040) %>% 
  group_by(Year, Gender, sim.id, scenario_name) %>% 
  summarize(Infected = sum(Infected), Population = sum(Population), .groups = 'keep') %>% 
  ungroup %>% 
  mutate(Prevalence = case_when(Population == 0 ~ 0,
                                  Population > 0 ~ Infected / Population))  %>% 
  group_by(Year, Gender) %>% 
  summarize(Prevalence = mean(Prevalence))


merge(
  base.prev,
  mh.prev,by = c("Year", "Gender")
)
```


```{r Age-prevalence curves}
age_bins = c(15,20,25,30,35,40,45,50,55,60)
age_labels = c()
for (i in 1:(length(age_bins) - 1)){
  age_labels <- append(age_labels, paste0("[",age_bins[i],":",age_bins[i + 1],")"))
}

p <- emodplot.by_age_gender.cmd(data = sim.cmd,
                           numerator = "Infected",
                           denominator = "Population",
                           subset_years = c(2003, 2007, 2008, 2012, 2018),
                           age_bins = c(15,20,25,30,35,40,45,50,55,60),
                           yaxis_lab = "",
                           title = "Age Prevalence Curves"
                           )

# ggplot() + geom_point(data = obs.prev.sheet %>% 
#                  filter(Province == "All", AgeBin %in% age_labels, Gender %in% c("Male", "Female")) %>% 
#                  mutate(AgeBin_index = factor(AgeBin, labels = 1:length(age_labels))),
#            mapping = aes(x = AgeBin_index, y = Prevalence)
#              ) + facet_grid(cols = vars(Gender), rows = vars(Year)) + scale_x_discrete()

p1 <- p + geom_point(data = obs.prev.sheet %>% 
                 filter(Province == "All", AgeBin %in% age_labels, Gender %in% c("Male", "Female")) %>% 
                 mutate(AgeBin_index = factor(AgeBin, labels = 1:length(age_labels))),
           mapping = aes(x = AgeBin_index, y = Prevalence)
             )
p1

# ggsave("/gpfs/data/bershteynlab/EMOD/citrod01/MATUMAINI/Analysis/age_prev_plot.pdf",
#        p1, width = 8, height = 8, units = c("in"))

```




## CMD Prevalence

### CMD prevalence

```{r Calculate CMD Prevalence - baseline}
# Aggregate CMD prevalence, to plot using EMODAnalyzer
cmd.data <- sim.cmd %>% filter(Age > 15) %>% 
  pivot_wider(id_cols = c(Year, Age, Gender, sim.id, scenario_name),
              names_from = c(IP_Key.CMDStatus),
              values_from = c(Population)) %>% 
  group_by(Year, Gender, sim.id, scenario_name) %>% 
  summarize(CMD_pos = sum(CMD_pos), 
            Population = sum(CMD_pos + CMD_neg + CMD_remission + CMD_remission_treated), 
            .groups = 'keep') %>% 
  ungroup %>% 
  mutate(CMD_prev = case_when(Population == 0 ~ 0,
                              Population > 0 ~ CMD_pos / Population))

# Calculate means across year and gender
cmd.data.means <- cmd.data %>%
  group_by(Year, Gender, scenario_name) %>% 
  summarize(CMD_prev = mean(CMD_prev), 
            CMD_pos = mean(CMD_pos),
            Population = mean(Population), 
            .groups = 'keep')  

cmd.data.means


```


```{r Calculate CMD Prevalence - treatment}
# Aggregate CMD prevalence, to plot using EMODAnalyzer
cmd.data.mh <- sim.cmd.mh %>% filter(Age > 15) %>%
  pivot_wider(id_cols = c(Year, Age, Gender, sim.id, scenario_name),
              names_from = c(IP_Key.CMDStatus),
              values_from = c(Population)) %>% 
  group_by(Year, Gender, sim.id, scenario_name) %>% 
  summarize(CMD_pos = sum(CMD_pos), 
            Population = sum(CMD_pos + CMD_neg + CMD_remission + CMD_remission_treated), 
            .groups = 'keep') %>% 
  ungroup() %>% 
  mutate(CMD_prev = case_when(Population == 0 ~ 0,
                              Population > 0 ~ CMD_pos / Population))

# Calculate means across year and gender
cmd.data.mh.means <- cmd.data.mh %>% 
  group_by(Year, Gender, scenario_name) %>% 
  summarize(CMD_prev = mean(CMD_prev), 
            CMD_pos = mean(CMD_pos),
            Population = mean(Population), 
            .groups = 'keep')  

merge(cmd.data.means, cmd.data.mh.means,
      by = c("Year", "Gender"))



```

```{r Plot CMD Prevalence baseline}
# Aggregate CMD prevalence, to plot using EMODAnalyzer
cmd.data <- sim.cmd %>% filter(Age >15) %>% 
  pivot_wider(id_cols = c(Year, Age, Gender, sim.id, scenario_name),
              names_from = c(IP_Key.CMDStatus),
              values_from = c(Population)) %>% 
  group_by(Year, Gender, sim.id, scenario_name) %>% 
  summarize(CMD_pos = sum(CMD_pos), 
            Population = sum(CMD_pos + CMD_neg + CMD_remission + CMD_remission_treated), 
            .groups = 'keep') %>% 
  ungroup() %>% 
  mutate(CMD_prev = case_when(Population == 0 ~ 0,
                              Population > 0 ~ CMD_pos / Population))

EMODAnalyzeR::emodplot.by_gender(cmd.data,
                   date.start = 1990, date.end = 2040,
                   col2plot = 'CMD_prev',
                   title = 'CMD Prevalence'
)

```
```{r}
cmd.data %>% group_by(Year, Gender) %>% summarize(CMD_prev = mean(CMD_prev))
```
 

```{r Plot CMD Prevalence with treatment}
cmd.data.mh <- sim.cmd.mh %>% filter(Age >15) %>% 
  pivot_wider(id_cols = c(Year, Age, Gender, sim.id, scenario_name),
              names_from = c(IP_Key.CMDStatus),
              values_from = c(Population)) %>% 
  group_by(Year, Gender, sim.id, scenario_name) %>% 
  summarize(CMD_pos = sum(CMD_pos), 
            Population = sum(CMD_pos + CMD_neg + CMD_remission + CMD_remission_treated), 
            .groups = 'keep') %>% 
  ungroup() %>% 
  mutate(CMD_prev = case_when(Population == 0 ~ 0,
                              Population > 0 ~ CMD_pos / Population))

EMODAnalyzeR::emodplot.by_gender(cmd.data.mh,
                   date.start = 1990, date.end = 2040,
                   col2plot = 'CMD_prev',
                   title = 'CMD Prevalence'
)
```

### CMD prevalence by age


```{r CMD prevalence by age}

cmd.data.age <- sim.cmd %>% 
  pivot_wider(id_cols = c(Year, Age, Gender, sim.id, scenario_name),
              names_from = c(IP_Key.CMDStatus),
              values_from = c(Population)) %>% 
  group_by(Year, Age, Gender, sim.id, scenario_name) %>% 
  summarize(CMD_pos = sum(CMD_pos), 
            Population = sum(CMD_pos + CMD_neg + CMD_remission + CMD_remission_treated), 
            .groups = 'keep') %>% 
  ungroup() %>% 
  mutate(CMD_prev = case_when(Population == 0 ~ 0,
                              Population > 0 ~ CMD_pos / Population))

cmd.data.age.mean <- cmd.data.age %>%
  group_by(Year, Age, Gender, scenario_name) %>% 
  summarize(CMD_prev = mean(CMD_prev), 
            CMD_pos = mean(CMD_pos),
            Population = mean(Population), 
            .groups = 'keep')

cmd.data.age.mean %>% filter(Year == 2004)
```

```{r CMD prevalence by age for baseline}

cmd.data.age <- sim.cmd %>% 
  pivot_wider(id_cols = c(Year, Age, Gender, sim.id, scenario_name),
              names_from = c(IP_Key.CMDStatus),
              values_from = c(Population)) %>% 
  group_by(Year, Age, Gender, sim.id, scenario_name) %>% 
  summarize(CMD_pos = sum(CMD_pos), 
            Population = sum(CMD_pos + CMD_neg + CMD_remission + CMD_remission_treated), 
            .groups = 'keep') %>% 
  ungroup() %>% 
  mutate(CMD_prev = case_when(Population == 0 ~ 0,
                              Population > 0 ~ CMD_pos / Population))

cmd.data.age.mean <- cmd.data.age %>%
  group_by(Year, Age, Gender, scenario_name) %>% 
  summarize(CMD_prev = mean(CMD_prev), 
            CMD_pos = mean(CMD_pos),
            Population = mean(Population), 
            .groups = 'keep')

cmd.data.age.mean %>% filter(Year == 2004)
```





```{r Plot CMD Prevalence by Age}

age_bins = c(18, 25, 30, 40, 45, 50, 60, 99)
age_labels = c()
for (i in 1:(length(age_bins) - 1)){
  age_labels <- append(age_labels, paste0("[",age_bins[i],":",age_bins[i + 1],")"))
}

subset_years = c(2004)

p <- cmd.data.age %>% EMODAnalyzeR::emodplot.by_age_gender("CMD_pos", "Population", 
                       subset_years, 
                       age_bins, 
                       yaxis_lab = "CMD Prevalence", 
                       title = "CMD Prevalence by Age")

obs.cmdprev.sheet$AgeBin_index = factor(obs.cmdprev.sheet$AgeBin,labels = 1:length(age_labels))

p + 
  geom_point(obs.cmdprev.sheet,
             mapping = aes(x = AgeBin_index, y = CMDPrevalence))
```

```{r Plot CMD Prevalence by Age with treatment}

age_bins = c(18, 25, 30, 40, 45, 50, 60, 99)
age_labels = c()
for (i in 1:(length(age_bins) - 1)){
  age_labels <- append(age_labels, paste0("[",age_bins[i],":",age_bins[i + 1],")"))
}

subset_years = c(2004)

p <- cmd.data.age.mh %>% EMODAnalyzeR::emodplot.by_age_gender("CMD_pos", "Population", 
                       subset_years, 
                       age_bins, 
                       yaxis_lab = "CMD Prevalence", 
                       title = "CMD Prevalence by Age")

obs.cmdprev.sheet$AgeBin_index = factor(obs.cmdprev.sheet$AgeBin,labels = 1:length(age_labels))

p + 
  geom_point(obs.cmdprev.sheet,
             mapping = aes(x = AgeBin_index, y = CMDPrevalence))
```

### CMD prevalence by HIV status

```{r Calculate CMD prevalence by HIV status}

cmd.prev.hiv.pos <- sim.cmd %>% filter(Age >= 15) %>%  
   pivot_wider(id_cols = c(Year, Age, Gender, sim.id),
              names_from = c(IP_Key.CMDStatus),
              values_from = c(Infected)) %>% 
  group_by(Year, Gender, sim.id) %>% 
  summarize(HIVpos.CMD.pos = sum(CMD_pos),
            HIVpos.pop = sum(CMD_pos + CMD_neg + CMD_remission + CMD_remission_treated), 
            .groups = 'keep') %>% 
  ungroup() %>% 
  mutate(HIVpos.CMD.prev = case_when(HIVpos.pop == 0 ~ 0,
                              HIVpos.pop > 0 ~ HIVpos.CMD.pos / HIVpos.pop)) %>% 
  group_by(Year, Gender) %>% 
  summarize(HIVpos.CMD.prev = mean(HIVpos.CMD.prev))

cmd.prev.hiv.neg <- sim.cmd %>% filter(Age >= 15) %>% 
  mutate(HIVneg = Population - Infected) %>% 
   pivot_wider(id_cols = c(Year, Age, Gender, sim.id),
              names_from = c(IP_Key.CMDStatus),
              values_from = c(HIVneg)) %>% 
  group_by(Year, Gender, sim.id) %>% 
  summarize(HIVneg.CMD.pos = sum(CMD_pos),
            HIVneg.pop = sum(CMD_pos + CMD_neg + CMD_remission + CMD_remission_treated), 
            .groups = 'keep') %>% 
  ungroup() %>% 
  mutate(HIVneg.CMD.prev = case_when(HIVneg.pop == 0 ~ 0,
                              HIVneg.pop > 0 ~ HIVneg.CMD.pos / HIVneg.pop)) %>% 
  group_by(Year, Gender) %>% 
  summarize(HIVneg.CMD.prev = mean(HIVneg.CMD.prev))



merge(cmd.prev.hiv.pos, cmd.prev.hiv.neg,
      by = c("Year","Gender"))
```

```{r Calculate CMD prevalence by HIV status with treatment}

cmd.prev.hiv.pos <- sim.cmd.mh %>% filter(Age >= 15) %>%  
   pivot_wider(id_cols = c(Year, Age, Gender, sim.id),
              names_from = c(IP_Key.CMDStatus),
              values_from = c(Infected)) %>% 
  group_by(Year, Gender, sim.id) %>% 
  summarize(HIVpos.CMD.pos = sum(CMD_pos),
            HIVpos.pop = sum(CMD_pos + CMD_neg + CMD_remission + CMD_remission_treated), 
            .groups = 'keep') %>% 
  ungroup() %>% 
  mutate(HIVpos.CMD.prev = case_when(HIVpos.pop == 0 ~ 0,
                              HIVpos.pop > 0 ~ HIVpos.CMD.pos / HIVpos.pop)) %>% 
  group_by(Year, Gender) %>% 
  summarize(HIVpos.CMD.prev = mean(HIVpos.CMD.prev))

cmd.prev.hiv.neg <- sim.cmd.mh %>% filter(Age >= 15) %>% 
  mutate(HIVneg = Population - Infected) %>% 
   pivot_wider(id_cols = c(Year, Age, Gender, sim.id),
              names_from = c(IP_Key.CMDStatus),
              values_from = c(HIVneg)) %>% 
  group_by(Year, Gender, sim.id) %>% 
  summarize(HIVneg.CMD.pos = sum(CMD_pos),
            HIVneg.pop = sum(CMD_pos + CMD_neg + CMD_remission + CMD_remission_treated), 
            .groups = 'keep') %>% 
  ungroup() %>% 
  mutate(HIVneg.CMD.prev = case_when(HIVneg.pop == 0 ~ 0,
                              HIVneg.pop > 0 ~ HIVneg.CMD.pos / HIVneg.pop)) %>% 
  group_by(Year, Gender) %>% 
  summarize(HIVneg.CMD.prev = mean(HIVneg.CMD.prev))



merge(cmd.prev.hiv.pos, cmd.prev.hiv.neg,
      by = c("Year","Gender"))
```

## Diagnosis coverage

```{r Diagnosis overall baseline}
diag.cov.base <- sim.cmd %>% 
    filter(Age >= 15) %>% 
    group_by(Year, Gender, sim.id, scenario_name) %>% 
    summarize(Diagnosed = sum(Diagnosed), Infected = sum(Infected), .groups = 'keep') %>% 
  ungroup %>% 
  mutate(diag.cov = case_when(Infected == 0 ~ 0 ,
                              Infected > 0 ~ Diagnosed/Infected)) %>% 
  group_by(Year, Gender) %>% 
  summarize(diag.cov = mean(diag.cov), .groups = 'keep')


diag.cov.mh <- sim.cmd.mh %>% 
    filter(Age >= 15) %>% 
    group_by(Year, Gender, sim.id, scenario_name) %>% 
    summarize(Diagnosed = sum(Diagnosed), Infected = sum(Infected), .groups = 'keep') %>% 
  ungroup %>% 
  mutate(diag.cov = case_when(Infected == 0 ~ 0 ,
                              Infected > 0 ~ Diagnosed/Infected)) %>% 
  group_by(Year, Gender) %>% 
  summarize(diag.cov = mean(diag.cov), .groups = 'keep')

merge(
  diag.cov.base,
  diag.cov.mh,
  by = c("Year", "Gender")
  )
```


```{r Diagnosis among CMD positive}

diag.cov.base.pos <- sim.cmd %>% 
    filter(Age >= 15) %>% 
  filter(IP_Key.CMDStatus == 'CMD_pos') %>%
    group_by(Year, Gender, sim.id, scenario_name) %>% 
    summarize(Diagnosed = sum(Diagnosed), Infected = sum(Infected), .groups = 'keep') %>% 
  ungroup %>% 
  mutate(diag.cov = case_when(Infected == 0 ~ 0 ,
                              Infected > 0 ~ Diagnosed/Infected)) %>% 
  group_by(Year, Gender) %>% 
  summarize(diag.cov = mean(diag.cov), .groups = 'keep')


diag.cov.base.neg <- sim.cmd %>% 
    filter(Age >= 15) %>% 
  filter(IP_Key.CMDStatus == 'CMD_neg') %>%
    group_by(Year, Gender, sim.id, scenario_name) %>% 
    summarize(Diagnosed = sum(Diagnosed), Infected = sum(Infected), .groups = 'keep') %>% 
  ungroup %>% 
  mutate(diag.cov = case_when(Infected == 0 ~ 0 ,
                              Infected > 0 ~ Diagnosed/Infected)) %>% 
  group_by(Year, Gender) %>% 
  summarize(diag.cov = mean(diag.cov), .groups = 'keep')

 merge(diag.cov.base.pos, diag.cov.base.neg, by = c("Year", "Gender"))

```


## OnArt coverage

```{r}
data <- sim.cmd %>% 
    group_by(Year, Gender, sim.id, scenario_name) %>% 
    summarize(On_ART = sum(On_ART), Population = sum(Population), .groups = 'keep') %>% 
    mutate(ARTCov = case_when(Population == 0 ~ 0,
                              Population > 0 ~ On_ART / Population))

p <- EMODAnalyzeR::emodplot.by_gender(data, 1990, 2040, 'ARTCov', title="ART Coverage") 
  

p
```

### Number on ART

```{r Number on ART, baseline}

art.data.base <- sim.cmd %>% 
  filter(Age >= 15) %>% 
    group_by(Year, Gender, sim.id, scenario_name) %>% 
    summarize(On_ART = sum(On_ART*pop.scaling.factor), Population = sum(Population), .groups = 'keep')

# ggplot() + 
#   geom_point(data = data %>% group_by(Year, Gender) %>% summarize(On_Art1 = mean(On_ART), .groups = 'keep') %>% ungroup() , 
#              mapping = aes(x = Year, y = On_Art1)) + 
#   facet_grid(cols = vars(Gender) )

p <- EMODAnalyzeR::emodplot.by_gender(art.data.base, 1990, 2040, 'On_ART', title="ART") 

p + 
  geom_point(data = obs.onart.sheet %>% filter(Province != "All", AgeBin == '[15:100)') %>% 
    group_by(Year, Gender) %>% 
    summarize(OnART = sum(OnART), .groups = 'keep'),
    mapping= aes(x = Year, y = OnART)) + 
  ylim(0,300000)

```

```{r Number on ART, mh care}

art.data.mh <- sim.cmd.mh %>% 
  filter(Age >= 15) %>% 
    group_by(Year, Gender, sim.id, scenario_name) %>% 
    summarize(On_ART = sum(On_ART*pop.scaling.factor), Population = sum(Population), .groups = 'keep')

# ggplot() + 
#   geom_point(data = data %>% group_by(Year, Gender) %>% summarize(On_Art1 = mean(On_ART), .groups = 'keep') %>% ungroup() , 
#              mapping = aes(x = Year, y = On_Art1)) + 
#   facet_grid(cols = vars(Gender) )

p <- EMODAnalyzeR::emodplot.by_gender(art.data.mh, 1990, 2040, 'On_ART', title="ART") 

p + 
  geom_point(data = obs.onart.sheet %>% filter(Province != "All", AgeBin == '[15:100)') %>% 
    group_by(Year, Gender) %>% 
    summarize(OnART = sum(OnART), .groups = 'keep'),
    mapping= aes(x = Year, y = OnART)) + 
  ylim(0,300000)

```

```{r}
merge(
  art.data.base %>% group_by(Year, Gender) %>% summarize(On_ART = mean(On_ART)), 
  art.data.mh %>% group_by(Year, Gender) %>% summarize(On_ART = mean(On_ART)), 
  by = c("Year","Gender")
)
```
### Coverage of ART

```{r}
art.data.base <- sim.cmd %>% 
  filter(Age >= 15) %>% 
    group_by(Year, Gender, sim.id, scenario_name) %>% 
    summarize(On_ART = sum(On_ART*pop.scaling.factor), Infected = sum(Infected*pop.scaling.factor), .groups = 'keep') %>%
  ungroup %>% 
  mutate(OnART_coverage = case_when(Infected == 0 ~ 0,
                                    Infected > 0 ~ On_ART/Infected)) %>% 
  group_by(Year, Gender) %>% 
  summarize(On_ART = mean(On_ART), OnART_coverage = mean(OnART_coverage))


art.data.mh <- sim.cmd.mh %>% 
  filter(Age >= 15) %>% 
    group_by(Year, Gender, sim.id, scenario_name) %>% 
    summarize(On_ART = sum(On_ART*pop.scaling.factor), Infected = sum(Infected*pop.scaling.factor), .groups = 'keep') %>%
  ungroup %>% 
  mutate(OnART_coverage = case_when(Infected == 0 ~ 0,
                                    Infected > 0 ~ On_ART/Infected)) %>% 
  group_by(Year, Gender) %>% 
  summarize(On_ART = mean(On_ART), OnART_coverage = mean(OnART_coverage))

merge(art.data.base, art.data.mh,
      by = c("Year","Gender"))

```
### Coverage of ART by CMD status

```{r}
onart.cov.cmd.pos <- sim.cmd %>% filter(Age >= 15) %>%
  filter(IP_Key.CMDStatus == "CMD_pos") %>% 
  group_by(Year, Gender, sim.id) %>% 
  summarize(On_ART = sum(On_ART*pop.scaling.factor), Infected = sum(Infected*pop.scaling.factor), .groups = 'keep') %>%
  ungroup %>% 
  mutate(OnART_coverage = case_when(Infected == 0 ~ 0,
                                    Infected > 0 ~ On_ART/Infected)) %>% 
  group_by(Year, Gender) %>% 
  summarize(On_ART = mean(On_ART), OnART_coverage = mean(OnART_coverage))


onart.cov.cmd.neg <- sim.cmd %>% filter(Age >= 15) %>% 
  filter(IP_Key.CMDStatus == "CMD_neg") %>% 
  group_by(Year, Gender, sim.id) %>% 
  summarize(On_ART = sum(On_ART*pop.scaling.factor), Infected = sum(Infected*pop.scaling.factor), .groups = 'keep') %>%
  ungroup %>% 
  mutate(OnART_coverage = case_when(Infected == 0 ~ 0,
                                    Infected > 0 ~ On_ART/Infected)) %>% 
  group_by(Year, Gender) %>% 
  summarize(On_ART = mean(On_ART), OnART_coverage = mean(OnART_coverage))

merge(onart.cov.cmd.pos, onart.cov.cmd.neg, 
      by = c("Year", "Gender"))

```


## Incidence

```{r}
EMODAnalyzeR::emodplot.incidence(sim.cmd,
                                 1990, 2040)
```

## Population
```{r Population}
data <- sim.cmd %>% 
  mutate(pop.scaled = Population * pop.scaling.factor) %>% 
  filter(Year >= 1990, Year <= 2040) %>% 
  group_by(Year, Gender, sim.id) %>% 
  summarize(total.pop = sum(Population* pop.scaling.factor), .groups = 'keep') %>% 
  mutate(Gender = case_when(Gender==0 ~ "Male", Gender==1 ~ "Female"))

data.mean <- data %>% group_by(Year, Gender) %>% summarize(mean.pop = mean(total.pop), .groups = 'keep')

ggplot() + 
  geom_point(data, mapping = aes(x = Year, y = total.pop), color = 'gray', alpha = .005) + 
  geom_line(data.mean, mapping = aes(x = Year, y = mean.pop), color = 'blue', size=1.5) + 
  facet_wrap(~ Gender, ncol=2) +
  xlab("Year") +
  ylab("Population All Ages") + 
  theme_bw(base_size=16) +
  guides(fill = guide_legend(keywidth = 2, keyheight = 1)) +
  theme(legend.position="bottom") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  theme(strip.background = element_rect(colour="black", fill="white")) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())
  
```

# HIV-Depression model postprocessing

Test case will be the "minimal scenario," which includes
1. Depression dynamics
  1. Age/sex-specific annual incidence of depression
  2. HIV+ status also increases depression incidence
  3. Relapse rate equal to incidence rate
2. Depression-caused increased risky sexual behavior (promoting LOW to MEDIUM risk upon depression incidence)
3. Depression-caused delays to diagnosis (2/3 of depressed skip diagnosis)
3. Depression-caused dropout from ART (mean time 5 years for depressed, 10 years for non-depressed)
4. Depression-caused non-adherence to ART
Treatment and effects of HIV on depression are not included

## Read in the data
```{r}
res.path.cmd = "/gpfs/scratch/citrod01/experiments/MATUMAINI/Baseline-campaign_MATUMAINI_202305-minimal___2023_07_31_18_44_08_900970"

sim.results <- EMODAnalyzeR::read.simulation.results.bigpurple(
  #results_path  = res.path.notreat,
  res.path.cmd2,
  scenario_name = 'minimal',
  summarize_columns = c("Population","Infected", "On_ART",
                        "Died", "Died_from_HIV",
                        "Newly.Infected","Diagnosed"),
  stratify_columns = c("Year", "Gender", "Age", "IP_Key.CMDStatus"),
  min_age_inclusive = 0,
  max_age_inclusive = 99
)

CENSUS_YEAR = 2009
KEN_CENSUS_POP = 5352385

sim.results.pop.scaling <- sim.results %>% 
      filter(Year == CENSUS_YEAR) %>%
      group_by(sim.id) %>%
      summarize(total.pop = sum(Population), .groups = 'keep') %>% 
      mutate(pop.scaling.factor = KEN_CENSUS_POP/total.pop)

sim.results <- sim.results %>% 
  inner_join(
    sim.results.pop.scaling,
    by = c("sim.id")
  )

```

## HIV Prevalence over time

```{r}
ingest.file.base = "/gpfs/data/bershteynlab/EMOD/citrod01/MATUMAINI/202301_Nyanza_Baseline_MalariaOngoing_original/Data/calibration_ingest_form_Nyanza.xlsm"

obs.prev.sheet.base <- EMODAnalyzeR::read.ingest.sheet(ingest.file.base, "Obs-Prevalence")
```


```{r, fig.width=8}
p <- EMODAnalyzeR::emodplot.prevalence(sim.results %>% filter(Age <= 50, Age >=15), 
                                       1990, 2040)

p +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1), breaks = seq(0,0.25,0.05), limits=c(0, 0.25)) +
    ylab("HIV Prevalence (%)") + 
  geom_point(data = obs.prev.sheet.base %>%
               filter(Province == 'All', AgeBin == "[15:50)", Gender %in% c("Male", "Female")),
             mapping = aes(x = Year, y = Prevalence)) + 
  geom_errorbar(data = obs.prev.sheet.base %>%
             filter(Province == 'All', AgeBin == "[15:50)", Gender %in% c("Male", "Female")),
             mapping = aes(x = Year, ymin = lb, ymax = ub))
```

## HIV Age-Prevalence Curves

```{r, fig.width=8, fig.height=8}
age_bins = c(15, 20, 25, 30, 35, 40, 45, 50, 55, 60, 65)
subset_years = c(2003, 2007, 2008, 2012, 2018)

p <- EMODAnalyzeR::emodplot.age_prevalence(sim.results, 
                                           subset_years = subset_years, 
                                           age_bins = age_bins,
                                           title = "HIV Age-Prevalence Curves")

p + theme(aspect.ratio = .15) + 
  geom_point(data = obs.prev.sheet %>% 
    filter(Province == "All", 
           Gender %in% c("Male", "Female"), 
           AgeBin != "[15:50)") %>% 
    mutate(AgeBin_index = factor(AgeBin, labels = 1:10)),
  mapping = aes(x = AgeBin_index, y = Prevalence))


```

## Numbers on ART over time 

```{r}
ingest.file.base = "/gpfs/data/bershteynlab/EMOD/citrod01/MATUMAINI/202301_Nyanza_Baseline_MalariaOngoing_original/Data/calibration_ingest_form_Nyanza.xlsm"

obs.onart.sheet <- EMODAnalyzeR::read.ingest.sheet(ingest.file.base, "Obs-OnART")
```


```{r, fig.width=8}
sim.onart <- sim.results %>% 
  dplyr::group_by(Year, Gender, sim.id, scenario_name) %>% 
  dplyr::summarize(On_ART = sum(On_ART * pop.scaling.factor), .groups = "keep") %>% 
  ungroup()

p <- EMODAnalyzeR::emodplot.by_gender(sim.onart, 2000, 2040, 
                        "On_ART", title = "Population on ART") + 
    ylab("Number on ART")

p + 
  geom_point(data = obs.onart.sheet %>% 
               filter(Province != "All", 
                      Gender %in% c("Male", "Female"), 
                      AgeBin == "[15:100)") %>%
              group_by(Year, Gender) %>% 
              summarize(OnART = sum(OnART)) %>% ungroup(),
              mapping = aes(x = Year, y = OnART)) + 
  geom_errorbar(data = obs.onart.sheet %>% 
                  filter(Province != "All", 
                         Gender %in% c("Male", "Female"), 
                         AgeBin == "[15:100)") %>%
              group_by(Year, Gender) %>% 
              summarize(OnART = sum(OnART)) %>% ungroup() %>% 
              mutate(lb = OnART - OnART/5,
                     ub = OnART + OnART/5),
              mapping = aes(x = Year, ymin = lb, ymax = ub))
```
## 90-90-90 

### Diagnosis coverage over time

```{r}
data <- sim.results %>% 
  filter(Age >=15) %>% 
  group_by(Year, Gender,sim.id,scenario_name) %>% 
  summarize(Diagnosed = sum(Diagnosed), Infected = sum(Infected), .groups = "keep") %>% 
  ungroup() %>% 
  mutate(Diagnosed = case_when(Infected == 0 ~ 0,
                               Infected > 0 ~ Diagnosed/Infected)) 

p <- EMODAnalyzeR::emodplot.by_gender(data, 2000, 2040, 
                        "Diagnosed", title = "Diagnosed PLHIV") 

p + scale_y_continuous(labels = scales::percent_format(accuracy = 1)) + 
    ylab("% PLHIV Diagnosed")
```

### ART coverage over time

```{r}
data <- sim.results %>% 
  filter(Age >=15) %>% 
  group_by(Year, Gender,sim.id,scenario_name) %>% 
  summarize(On_ART = sum(On_ART), Diagnosed = sum(Diagnosed), .groups = "keep") %>% 
  ungroup() %>% 
  mutate(On_ART = case_when(On_ART == 0 ~ 0,
                               On_ART > 0 ~ On_ART/Diagnosed)) 

p <- EMODAnalyzeR::emodplot.by_gender(data, 2000, 2040, 
                        "On_ART", title = "ART Coverage") 

p + scale_y_continuous(labels = scales::percent_format(accuracy = 1)) + 
    ylab("% Diagnosed and On ART")
```

## Incidence

### New HIV Infections

```{r}
 data <- sim.results %>% 
  mutate(Year = ceiling(Year)) %>% 
  group_by(Year, Gender, sim.id, scenario_name) %>% 
  summarize(NewCases = sum(Newly.Infected * pop.scaling.factor), .groups = 'keep') %>%  
  ungroup() %>% 
  group_by(Year, Gender, sim.id, scenario_name) %>% 
  summarize(NewCases.sd = sd(NewCases), NewCases = mean(NewCases)) %>% 
  ungroup()# %>% 
  # mutate(Gender = case_when(Gender==0 ~ "Male", Gender==1 ~ "Female")) %>% 
  # mutate(lb = NewCases - NewCases.sd, ub = NewCases + NewCases.sd)

p <- EMODAnalyzeR::emodplot.by_gender(data, 1990, 2040, 
                        "NewCases", title = "New HIV Infections") 

p + #scale_y_continuous(labels = scales::percent_format(accuracy = 1)) + 
    ylab("")
```


### HIV Deaths

```{r}
 data <- sim.results %>% 
  mutate(Year = ceiling(Year)) %>% 
  group_by(Year, Gender, sim.id, scenario_name) %>% 
  summarize(NewCases = sum(Died_from_HIV * pop.scaling.factor), .groups = 'keep') %>%  
  ungroup() %>% 
  group_by(Year, Gender, sim.id, scenario_name) %>% 
  summarize(NewCases.sd = sd(NewCases), NewCases = mean(NewCases)) %>% 
  ungroup()# %>% 
  
p <- EMODAnalyzeR::emodplot.by_gender(data, 1990, 2040, 
                        "NewCases", title = "HIV deaths") 

p + #scale_y_continuous(labels = scales::percent_format(accuracy = 1)) + 
    ylab("")
```


## Depression Prevalence over time
```{r}
data.cmd <- sim.results %>% filter(Age > 18) %>% 
  mutate(HIVneg = Population - Infected) %>% 
  group_by(Year, Gender, sim.id, IP_Key.CMDStatus, scenario_name) %>% 
  summarize(Population = sum(Population),
            HIVneg = sum(HIVneg),
            Infected = sum(Infected), .groups = 'keep') %>% 
  ungroup() %>% 
  pivot_wider(id_cols = c(Year, Gender, sim.id, scenario_name),
              names_from = c(IP_Key.CMDStatus),
              values_from = c(Population, HIVneg, Infected))  %>% 
  mutate(Population_total = Population_CMD_pos + Population_CMD_neg + Population_CMD_recovered + Population_CMD_treated,
         HIVneg_total = HIVneg_CMD_pos + HIVneg_CMD_neg + HIVneg_CMD_recovered + HIVneg_CMD_treated,
         Infected_total = Infected_CMD_pos + Infected_CMD_neg + Infected_CMD_recovered + Infected_CMD_treated) %>% 
  mutate(CMD_prev_overall = case_when(Population_total == 0 ~ 0,
                                    Population_total > 0 ~ Population_CMD_pos/Population_total),
         CMD_prev_HIVneg = case_when(HIVneg_total == 0 ~ 0,
                                    HIVneg_total > 0 ~ HIVneg_CMD_pos/HIVneg_total),
         CMD_prev_Infected = case_when(Infected_total == 0 ~ 0,
                                    Infected_total > 0 ~ Infected_CMD_pos/Infected_total)) %>% 
  mutate(Gender = case_when(Gender==0 ~ "Male", Gender==1 ~ "Female"))

data.cmd.mean <- data.cmd %>% 
  group_by(Year, Gender) %>%
  summarize(Overall = mean(CMD_prev_overall), Overall_sd = sd(CMD_prev_overall),
            HIVneg = mean(CMD_prev_HIVneg), HIVneg_sd = sd(CMD_prev_HIVneg),
            Infected = mean(CMD_prev_Infected), Infected_sd = sd(CMD_prev_Infected),
            .groups = "keep") %>% 
  ungroup()

# Plot  
p = ggplot() +
  geom_line( data = data.cmd.mean %>% 
                    select(Year, Gender, Overall, Infected, HIVneg) %>% 
                    pivot_longer(cols = c(Overall, Infected, HIVneg),
                                 names_to = "Depression.Prevalence", 
                                 values_to = "CMD_prev"),
    mapping = aes(x = Year, y = CMD_prev, color = Depression.Prevalence), 
    size = 1.0) + 
  scale_y_continuous(limits = c(0.05,.22)) + 
  facet_wrap(~ Gender, ncol=2) +
  xlab("Year")+ylab("") + 
  ggtitle("Depression Prevalence by HIV status") + 
  theme_bw(base_size=16) +
  guides(fill = guide_legend(keywidth = 2, keyheight = 1)) +
  scale_x_continuous(breaks = seq(1990,2040,10)) +
  theme(legend.position="bottom") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  theme(strip.background = element_rect(colour="black", fill="white")) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())

p
```

```{r}
p = ggplot() +
  geom_line( data = data.cmd.mean, size=1.0, 
             aes(x=Year, y=Overall), color = 'darkgreen') +
  geom_errorbar(data= data.cmd.mean %>% mutate(lb = Overall - Overall_sd, ub = Overall + Overall_sd), 
                mapping = aes(x = Year, ymin = lb, ymax = ub), color="darkgreen", width=.5, size=.5) +
  scale_y_continuous(limits = c(0.07,.11)) + 
  facet_wrap(~ Gender, ncol=2) +
  xlab("Year") + ylab("Depression Prevalence") + 
  ggtitle("Depression Prevalence, general population") + 
  theme_bw(base_size=16) +
  guides(fill = guide_legend(keywidth = 2, keyheight = 1)) +
  scale_x_continuous(breaks = seq(1990,2040,10)) +
  theme(legend.position="bottom") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  theme(strip.background = element_rect(colour="black", fill="white")) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())

p
```


## Depression Age-Prevalence Curves

In 2004, the year of the WHO health survey in Kenya
```{r}
obs.cmdprev.sheet <- data.frame(Year = 2004, 
           Gender = c("Male", "Male", "Male", "Male", "Male", "Male", "Male", 
                    "Female", "Female", "Female", "Female", "Female", "Female", "Female"),
           AgeBin =  c("[18:24)", "[25:29)", "[30:39)", "[40:44)", "[45:49)", "[50:59)", "[60:99)",
                      "[18:24)", "[25:29)", "[30:39)", "[40:44)", "[45:49)", "[50:59)", "[60:99)"),
           CMDPrevalence = c(0.03, 0.069, 0.098, 0.087, 0.11, 0.13, 0.2, 
                             0.065, 0.086, 0.067, 0.12, 0.13, 0.079, 0.051)
)
obs.cmdprev.sheet$AgeBin_index = factor(obs.cmdprev.sheet$AgeBin,labels = 1:length(age_labels))
```



```{r, fig.height=8, fig.width =8}
cmd.data.age <- sim.results %>% 
  filter(Age > 18) %>% 
  filter(Year %in% c(1994, 2004, 2014, 2024)) %>% 
  mutate(HIVneg = Population - Infected) %>% 
  group_by(Year, Gender, Age, sim.id, IP_Key.CMDStatus, scenario_name) %>% 
  summarize(Population = sum(Population),
            HIVneg = sum(HIVneg),
            Infected = sum(Infected), .groups = 'keep') %>% 
  ungroup() %>% 
  pivot_wider(id_cols = c(Year, Gender, Age, sim.id, scenario_name),
              names_from = c(IP_Key.CMDStatus),
              values_from = c(Population, HIVneg, Infected))  %>% 
  mutate(Population_total = Population_CMD_pos + Population_CMD_neg + Population_CMD_recovered + Population_CMD_treated,
         HIVneg_total = HIVneg_CMD_pos + HIVneg_CMD_neg + HIVneg_CMD_recovered + HIVneg_CMD_treated,
         Infected_total = Infected_CMD_pos + Infected_CMD_neg + Infected_CMD_recovered + Infected_CMD_treated) %>% 
  mutate(CMD_prev_overall = case_when(Population_total == 0 ~ 0,
                                    Population_total > 0 ~ Population_CMD_pos/Population_total),
         CMD_prev_HIVneg = case_when(HIVneg_total == 0 ~ 0,
                                    HIVneg_total > 0 ~ HIVneg_CMD_pos/HIVneg_total),
         CMD_prev_Infected = case_when(Infected_total == 0 ~ 0,
                                    Infected_total > 0 ~ Infected_CMD_pos/Infected_total)) %>% 
  mutate(Gender = case_when(Gender==0 ~ "Male", Gender==1 ~ "Female"))

# Define age bins
age_bins = c(18, 25, 30, 40, 45, 50, 60, 99)
age_labels = c()
for (i in 1:(length(age_bins) - 1)){
  age_labels <- append(age_labels, paste0("[",age_bins[i],":",age_bins[i + 1],")"))
}

# Label each age by its bin
cmd.data.age <- cmd.data.age %>% mutate(
  AgeBin = cut(Age, breaks = age_bins, right = FALSE)
  ) %>%
  filter(!is.na(AgeBin))
cmd.data.age$AgeBin_index = factor(cmd.data.age$AgeBin,labels = 1:length(age_labels))

cmd.data.age.mean <- cmd.data.age %>% 
  group_by(Year, AgeBin_index, AgeBin, Gender, scenario_name) %>% 
  summarize(mean.Overall = mean(CMD_prev_overall), sd.Overall = sd(CMD_prev_overall),
            mean.HIVneg = mean(CMD_prev_HIVneg), sd.HIVneg = sd(CMD_prev_HIVneg),
            mean.Infected = mean(CMD_prev_Infected), sd.Infected = sd(CMD_prev_Infected),
              .groups = 'keep') %>% 
  mutate(lb.Overall = max(mean.Overall - 2* sd.Overall, 0), ub.Overall = mean.Overall + 2*sd.Overall,
         lb.HIVneg = max(mean.HIVneg - 2* sd.HIVneg, 0), ub.HIVneg = mean.HIVneg + 2*sd.HIVneg,
         lb.Infected = max(mean.Infected - 2* sd.Infected, 0), ub.Infected = mean.Infected + 2*sd.Infected
)

p <- cmd.data.age.mean %>% 
  ggplot() + 
  geom_point(mapping = aes(x = AgeBin_index, y = mean.Overall), 
             size = 2, color = 'darkgreen') + 
  geom_errorbar(mapping = aes(x = AgeBin_index, ymin = lb.Overall, ymax = ub.Overall),
                width = .3, size =2, color = 'darkgreen') + 
  facet_grid(cols = vars(Gender), rows = vars(Year)) + 
  xlab("Age") + ylab("") + 
  theme_bw(base_size=16) +
  guides(fill = guide_legend(keywidth = 2, keyheight = 1)) +
  scale_x_discrete(
    breaks = 1:length(age_labels),
    labels = age_labels
    ) +
  theme(legend.position="bottom") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  theme(strip.background = element_rect(colour="black", fill="white")) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())

p + 
  geom_point(obs.cmdprev.sheet,
             mapping = aes(x = AgeBin_index, y = CMDPrevalence), color = 'orange', size = 3)

```

