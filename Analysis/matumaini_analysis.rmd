---
title: "Matumaini_Analysis"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# MATUMAINI Analysis

The purpose of this notebook is to spot check some of the results from our MATUMAINI mental health model.

```{r Load Libraries}
library(tidyverse)
library(tidyr)
library(data.table)
library(magrittr)
library(ggplot2)
library(devtools)
library(readxl)
devtools::install_github("BershteynLab/EMODAnalyzeR")
```

# Checking on events in the new cascade

```{r}
event.recorder = read.csv("/gpfs/scratch/citrod01/experiments/MATUMAINI/Baseline-campaign_MATUMAINI_202305-IDM_MH___2023_05_18_11_32_56_337030/Simulation_0R4P9SX6/output/ReportEventRecorder.csv",
                          skip = 920000)

event.recorder = read.csv("/gpfs/scratch/citrod01/experiments/MATUMAINI/Baseline-campaign_MATUMAINI_202305-IDM_base___2023_05_18_11_32_23_752627/Simulation_2JTFHYYM/output/ReportEventRecorder.csv", 
                          skip = 920000)

colnames(event.recorder) <- c("Time","Year","Node_ID","Event_Name","Individual_ID","Age","Gender","Infected","Infectiousness","HasHIV","OnART","CD4","WHO_Stage","HIV_Stage","InterventionStatus")

event.recorder %>% filter(Year >= 2015) %>% arrange(Individual_ID, Year) %>% View
```
Wow, it'll be really hard to check on some of these things, in particular the testing loop

I can check on the low risk vs medium risk thing
I can try checking on the duration of depression, which may be tough



# Duration of Depression Episode

```{r Duration of depression episode}

event.recorder = fread("/gpfs/scratch/citrod01/experiments/MATUMAINI/Baseline-campaign_Nyanza_baseline_202301-Baseline___2023_03_20_20_06_13_372862/Simulation_6F9M2RC4/output/ReportEventRecorder.csv")

a = event.recorder %>% select( "Year", "Event_Name", "Individual_ID") %>% 
  filter(Event_Name %in% c("CMD_NoTreat", "CMD_NoTreat_Recovery")) %>% 
  filter(Year > 1992) %>% 
  filter(Year < 2025) %>% 
  arrange(Year) %>% 
  group_by(Event_Name, Individual_ID) %>% 
  slice(1) %>% 
  pivot_wider(id_cols = c(Individual_ID), values_from = c(Year), names_from = Event_Name) %>% 
  filter(!is.na(CMD_NoTreat_Recovery)) %>% 
  filter(!is.na(CMD_NoTreat)) %>% 
  mutate(diff = CMD_NoTreat_Recovery - CMD_NoTreat ) 

a %>% 
  filter(diff > 0) %>% 
  .$diff %>% hist()

a %>% 
  filter(diff > 0) %>% 
  .$diff %>% summary()
```

I dunno, close enough?

# Plotting first successful calibration

2023-03-30 - ran the first calibration of the new model, featuring mental health as one of the calibration targets.

```{r Read in simulation results}

# res_path = "/gpfs/scratch/citrod01/experiments/MATUMAINI/Baseline-campaign_MATUMAINI_202305-MH_test___2023_05_13_12_04_46_863189"
sim.cmd <- EMODAnalyzeR::read.simulation.results(
  results_path = res_path,
  scenario_name = 'baseline',
  summarize_columns = c("Newly.Infected", "Newly.Tested.Positive",
    "Newly.Tested.Negative", "Population", "Infected", "On_ART", "Died", "Died_from_HIV",
    "Tested.Past.Year.or.On_ART", "Tested.Ever", "Diagnosed"),
  stratify_columns = c("Year", "Age", "Gender", "IP_Key.CMDStatus"),
  min_age_inclusive = 18,
  max_age_inclusive = 99
)

CENSUS_YEAR = 2009
ZWE_CENSUS_POP = 2697858 

sim.results.pop.scaling <- sim.cmd %>% 
      filter(Year == CENSUS_YEAR) %>%
      group_by(sim.id) %>%
      summarize(total.pop = sum(Population), .groups = 'keep') %>% 
      mutate(pop.scaling.factor = ZWE_CENSUS_POP/total.pop)

sim.cmd <- sim.cmd %>% 
  inner_join(
    sim.results.pop.scaling,
    by = c("sim.id")
  )
```

## Read in the calibration targets

Need to figure out how to read an excel file.
```{r}
xl.path = "/gpfs/data/bershteynlab/EMOD/citrod01/MATUMAINI/202301_Nyanza_Baseline_MalariaOngoing/Data/calibration_ingest_form_Nyanza_MATUMAINI.xlsm"

obs.prev.sheet <- readxl::read_excel(xl.path, sheet = "Obs-Prevalence", range = "A8:G173", col_names = TRUE)

obs.onart.sheet <- readxl::read_excel(xl.path, sheet = "Obs-OnART", range = "A8:G202", col_names = TRUE)

obs.cmdprev.sheet <- readxl::read_excel(xl.path, sheet = "Obs-CMDPrevalence", range = "A8:G22", col_names = TRUE)
```


## Prevalence
```{r}
emodplot.prevalence <- function(data,
                           date.start,
                           date.end,
                           title = "HIV prevalence") {
  data <- data %>% 
    group_by(Year, Gender, sim.id, scenario_name) %>% 
    summarize(Infected = sum(Infected), Population = sum(Population), .groups = 'keep') %>% 
    mutate(Prevalence = case_when(Population == 0 ~ 0,
                                  Population > 0 ~ Infected / Population))
  y.lim.max <- min(max(data$Prevalence) * 1.2, 1)
  p <- EMODAnalyzeR::emodplot.by_gender(data, date.start, date.end, 'Prevalence', title=title ) +
    scale_y_continuous(labels = scales::percent_format(accuracy = 1), breaks = seq(0, y.lim.max,0.05), limits=c(0,y.lim.max)) +
    ylab("HIV Prevalence (%)")
  return(p)
}

p <- emodplot.prevalence(sim.cmd %>% filter(Age <= 50, Age >= 15), 
                          1990, 2040, 
                          title = 'All Ages Prevalence')

p + 
  geom_point(data = obs.prev.sheet %>% 
               filter(Province == 'All', AgeBin == "[15:50)", Gender %in% c("Male", "Female")), 
             mapping = aes(x = Year, y = Prevalence))
```
## OnArt coverage

```{r}
data <- sim.cmd %>% 
    group_by(Year, Gender, sim.id, scenario_name) %>% 
    summarize(On_ART = sum(On_ART), Population = sum(Population), .groups = 'keep') %>% 
    mutate(ARTCov = case_when(Population == 0 ~ 0,
                              Population > 0 ~ On_ART / Population))

p <- EMODAnalyzeR::emodplot.by_gender(data, 1990, 2040, 'ARTCov', title="ART Coverage") 
  

p


```
## Number on ART

```{r Number on ART}

data <- sim.cmd %>% 
    group_by(Year, Gender, sim.id, scenario_name) %>% 
    summarize(On_ART = sum(On_ART*pop.scale.factor), Population = sum(Population), .groups = 'keep')

p <- EMODAnalyzeR::emodplot.by_gender(data, 1990, 2040, 'On_ART', title="ART") 

p + 
  geom_point(data = obs.onart.sheet %>% filter(Province != "All", AgeBin == '[15:100)') %>% 
    group_by(Year, Gender) %>% 
    summarize(OnART = sum(OnART), .groups = 'keep'),
    mapping= aes(x = Year, y = OnART))
```


## Incidence

```{r}
EMODAnalyzeR::emodplot.incidence(sim.cmd,
                                 1990, 2040)
```

## Population
```{r Population}
EMODAnalyzeR::emodplot.by_gender(sim.cmd,
                                 1990,2040,
                                 col2plot = 'Population',
                                 title = "Population")
```



## CMD Prevalence

```{r Calculate CMD Prevalence}
# Aggregate CMD prevalence, to plot using EMODAnalyzer
p <- sim.cmd %>% 
  pivot_wider(id_cols = c(Year, Age, Gender, sim.id, scenario_name),
              names_from = c(IP_Key.CMDStatus),
              values_from = c(Population)) %>% 
  group_by(Year, Gender, sim.id, scenario_name) %>% 
  summarize(CMD_pos = sum(CMD_pos), 
            Population = sum(CMD_pos + CMD_neg + CMD_remission + CMD_remission_treated), 
            .groups = 'keep') %>% 
  mutate(CMD_prev = case_when(Population == 0 ~ 0,
                              Population > 0 ~ CMD_pos / Population))

# Calculate means across year and gender
p1 <- p %>%
  group_by(Year, Gender, scenario_name) %>% 
  summarize(CMD_prev = mean(CMD_prev), 
            CMD_pos = mean(CMD_pos),
            Population = mean(Population), 
            .groups = 'keep')  
```

```{r Plot CMD Prevalence}
EMODAnalyzeR::emodplot.by_gender(p,
                   date.start = 2000, date.end = 2020,
                   col2plot = 'CMD_prev',
                   title = 'CMD Prevalence'
)
```

```{r CMD Prevalence by Age}

p.age <- sim.cmd %>% 
  pivot_wider(id_cols = c(Year, Age, Gender, sim.id, scenario_name),
              names_from = c(IP_Key.CMDStatus),
              values_from = c(Population)) %>% 
  group_by(Year, Age, Gender, sim.id, scenario_name) %>% 
  summarize(CMD_pos = sum(CMD_pos), 
            Population = sum(CMD_pos + CMD_neg + CMD_remission + CMD_remission_treated), 
            .groups = 'keep') %>% 
  mutate(CMD_prev = case_when(Population == 0 ~ 0,
                              Population > 0 ~ CMD_pos / Population))

p1.age <- p.age %>%
  group_by(Year, Age, Gender, scenario_name) %>% 
  summarize(CMD_prev = mean(CMD_prev), 
            CMD_pos = mean(CMD_pos),
            Population = mean(Population), 
            .groups = 'keep')

```

```{r Functions for age prevalence curves}

emodplot.by_age_gender <- function(data, 
                                   numerator = "Infected", 
                                   denominator = "Population", 
                                   subset_years = c(2005), 
                                   age_bins = c(15,20,25,30,35,40,45,50,55,60,65,99), 
                                   yaxis_lab = "", 
                                   title = "") {
  # Build color mapping function, each scenario gets its own color
  nScenarios = length(unique(data$scenario_name))
  if (nScenarios == 1) {
    colors2plot <- c('blue3')
  } else {
    colors2plot <- colors[1:nScenarios]
  }
  
  # Subset data on years
  data <- data %>% filter(Year %in% subset_years)
  
  # Age bins
  age_labels = c()
  for (i in 1:(length(age_bins) - 1)){
    age_labels <- append(age_labels, paste0("[",age_bins[i],":",age_bins[i + 1],")"))
  }
  
  # Label each age by its bin
  data <- data %>% mutate(
    AgeBin = cut(Age, breaks = age_bins, right = FALSE)
    ) %>%
    filter(!is.na(AgeBin))
  
  data$AgeBin_index = factor(data$AgeBin,labels = 1:length(7))
  
  # Pick out the numerator and denominator
  data['Numerator'] = data[numerator]
  data['Denominator'] = data[denominator]
  
  # Calculate prevalence, grouping by age bin
  data.prev <- data %>% group_by(Year, AgeBin_index, AgeBin, Gender, scenario_name, sim.id) %>% 
    summarize(num = sum(Numerator), denom = sum(Denominator), .groups = 'keep') %>% 
    mutate(Prevalence = num/denom)
  # Calculate mean prevalence across all sim runs
  data.mean <- data.prev %>% group_by(Year, AgeBin_index, AgeBin, Gender, scenario_name) %>% 
    summarize(mean.Prevalence = mean(Prevalence),
              sd.Prevalence = sd(Prevalence),
              .groups = 'keep') %>% 
    mutate(lower = max(mean.Prevalence - 2* sd.Prevalence, 0), 
           upper = mean.Prevalence + 2*sd.Prevalence)
  
  # Transform data
  data.prev <- data.prev %>% mutate(Gender = case_when(Gender==0 ~ "Male", Gender==1 ~ "Female"))
  data.mean <- data.mean %>% mutate(Gender = case_when(Gender==0 ~ "Male", Gender==1 ~ "Female"))
  
  p <- data.mean %>% 
    ggplot() + 
    # plot means
    geom_point(
      mapping = aes(x = AgeBin_index, y = mean.Prevalence, color = scenario_name),
      size=1
    ) + 
    geom_errorbar(
      mapping = aes(x=AgeBin_index, ymin=lower, ymax=upper, color=scenario_name),
      width=.15, size=1) + 
    facet_grid(cols = vars(Gender), rows = vars(Year)) + 
    xlab("Age") + 
    ylab(yaxis_lab) +
    theme_bw(base_size=16) +
    guides(fill = guide_legend(keywidth = 2, keyheight = 1)) +
    scale_x_discrete(
      breaks = 1:length(age_labels),
      labels = age_labels
      ) +
    theme(legend.position="bottom") +
    theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
    theme(strip.background = element_rect(colour="black", fill="white")) +
    theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) + 
    scale_color_manual(values=colors2plot) + 
    labs(title = title)
  return(p)
}


emodplot.age_prevalence <- function(data,
                                    subset_years = c(2005), 
                                    age_bins = c(15,20,25,30,35,40,45,50,55,60,65,99),
                                    title = "Age-Prevalence Curves") {
  p <- emodplot.by_age_gender(data, "Infected", "Population",
                              subset_years, age_bins,
                              yaxis_lab = "Prevalence",
                              title = title)
  return(p)
}

subset_years = c(2006, 2011, 2015, 2016)
age_bins = c(18,25,30,40,45,50,60,99)

emodplot.by_age_gender(sim.cmd, "Infected", "Population", 
                       subset_years, age_bins, yaxis_lab = "Prevalence", 
                       title = "Age Prevalence Curves")
```
 

```{r Plot CMD Prevalence by Age}

age_bins = c(18, 25, 30, 40, 45, 50, 60, 99)
subset_years = c(2004)

p <- sim.cmd %>% pivot_wider(
  id_cols = c(Year, Age, Gender, scenario_name, sim.id), 
  names_from= "IP_Key.CMDStatus",
  values_from = "Population"
) %>% 
  mutate(Population = CMD_neg + CMD_pos + CMD_remission +CMD_remission_treated) %>% 
  emodplot.by_age_gender("CMD_pos", "Population", 
                       subset_years, age_bins, 
                       yaxis_lab = "CMD Prevalence", 
                       title = "CMD Prevalence by Age")

data <- obs.cmdprev.sheet
data$AgeBin_index = factor(data$AgeBin,labels = 1:length(age_labels))

p + 
  geom_point(data = data, 
             mapping = aes(x = AgeBin_index, y = CMDPrevalence))
```

# Plotting calibration of age-prevalence CMD curves

2023-05-10 - attempting to hit calibration targets for CMD


```{r Read in simulation results}
# Baseline, without treatment for CMD
res_path = "/gpfs/data/bershteynlab/EMOD/citrod01/MATUMAINI/202301_Nyanza_Baseline_MalariaOngoing/IDM_test_1/Baseline-campaign_MATUMAINI_202305-IDMtest_base/ReportHIVByAgeAndGender"

sim.cmd <- EMODAnalyzeR::read.simulation.results(
  results_path = res_path,
  scenario_name = 'baseline',
  summarize_columns = c("Newly.Infected", "Newly.Tested.Positive",
    "Newly.Tested.Negative", "Population", "Infected", "On_ART", "Died", "Died_from_HIV",
    "Tested.Past.Year.or.On_ART", "Tested.Ever", "Diagnosed"),
  stratify_columns = c("Year", "Age", "Gender", "IP_Key.CMDStatus"),
  min_age_inclusive = 0,
  max_age_inclusive = 99
)

CENSUS_YEAR = 2009
KEN_CENSUS_POP = 5352385

sim.results.pop.scaling <- sim.cmd %>% 
      filter(Year == CENSUS_YEAR) %>%
      group_by(sim.id) %>%
      summarize(total.pop = sum(Population), .groups = 'keep') %>% 
      mutate(pop.scaling.factor = KEN_CENSUS_POP/total.pop)

sim.cmd <- sim.cmd %>% 
  inner_join(
    sim.results.pop.scaling,
    by = c("sim.id")
  )


# Adding treatment for CMD
res_path = "/gpfs/data/bershteynlab/EMOD/citrod01/MATUMAINI/202301_Nyanza_Baseline_MalariaOngoing/IDM_test_1/Baseline-campaign_MATUMAINI_202305-IDMtest_MH/ReportHIVByAgeAndGender/"

sim.cmd.mh <- EMODAnalyzeR::read.simulation.results(
  results_path = res_path,
  scenario_name = 'baseline',
  summarize_columns = c("Newly.Infected", "Newly.Tested.Positive",
    "Newly.Tested.Negative", "Population", "Infected", "On_ART", "Died", "Died_from_HIV",
    "Tested.Past.Year.or.On_ART", "Tested.Ever", "Diagnosed"),
  stratify_columns = c("Year", "Age", "Gender", "IP_Key.CMDStatus"),
  min_age_inclusive = 0,
  max_age_inclusive = 99
)

CENSUS_YEAR = 2009
KEN_CENSUS_POP = 5352385

sim.results.pop.scaling <- sim.cmd.mh %>% 
      filter(Year == CENSUS_YEAR) %>%
      group_by(sim.id) %>%
      summarize(total.pop = sum(Population), .groups = 'keep') %>% 
      mutate(pop.scaling.factor = KEN_CENSUS_POP/total.pop)

sim.cmd.mh <- sim.cmd.mh %>% 
  inner_join(
    sim.results.pop.scaling,
    by = c("sim.id")
  )
```

## Read in the calibration targets

```{r}
xl.path = "/gpfs/data/bershteynlab/EMOD/citrod01/MATUMAINI/202301_Nyanza_Baseline_MalariaOngoing/Data/calibration_ingest_form_Nyanza_MATUMAINI.xlsm"

obs.prev.sheet <- readxl::read_excel(xl.path, sheet = "Obs-Prevalence", range = "A8:G173", col_names = TRUE)

obs.onart.sheet <- readxl::read_excel(xl.path, sheet = "Obs-OnART", range = "A8:G202", col_names = TRUE)

#obs.cmdprev.sheet <- readxl::read_excel(xl.path, sheet = "Obs-CMDPrevalence", range = "A8:G22", col_names = TRUE)

obs.pop.sheet <- readxl::read_excel(xl.path, sheet = "Obs-Population", range = "A8:G224", col_names = TRUE)
```


## Prevalence
```{r Fixed prevalence functions}

emodplot.prevalence <- function(data,
                           date.start,
                           date.end,
                           title = "HIV prevalence") {
  data <- data %>% 
    group_by(Year, Gender, sim.id, scenario_name) %>% 
    summarize(Infected = sum(Infected), Population = sum(Population), .groups = 'keep') %>% 
    mutate(Prevalence = case_when(Population == 0 ~ 0,
                                  Population > 0 ~ Infected / Population))
  y.lim.max <- min(max(data$Prevalence) * 1.2, 1)
  p <- EMODAnalyzeR::emodplot.by_gender(data, date.start, date.end, 'Prevalence', title=title ) +
    scale_y_continuous(labels = scales::percent_format(accuracy = 1), breaks = seq(0, y.lim.max,0.05), limits=c(0,y.lim.max)) +
    ylab("HIV Prevalence (%)")
  return(p)
}


emodplot.by_age_gender.cmd <- function(data, 
                                   numerator = "Infected", 
                                   denominator = "Population", 
                                   subset_years = c(2005), 
                                   age_bins = c(15,20,25,30,35,40,45,50,55,60,65,99), 
                                   yaxis_lab = "", 
                                   title = "") {
  # Build color mapping function, each scenario gets its own color
    nScenarios = length(unique(data$scenario_name))
  if (nScenarios == 1) {
    colors2plot <- c('blue3')
  } else {
    colors2plot <- colors[1:nScenarios]
  }
  
  # Subset data on years
  data <- data %>% filter(Year %in% subset_years)
  
  # Age bins  
  age_labels = c()
  for (i in 1:(length(age_bins) - 1)){
    age_labels <- append(age_labels, paste0("[",age_bins[i],":",age_bins[i + 1],")"))
  }
  
  # Label each age by its bin
  data <- data %>% mutate(
    AgeBin = cut(Age, breaks = age_bins, right = FALSE)
    ) %>%
    filter(!is.na(AgeBin))
  data$AgeBin_index = factor(data$AgeBin,labels = 1:length(age_labels))
  
  # Pick out the numerator and denominator
  data['Numerator'] = data[numerator]
  data['Denominator'] = data[denominator]
    
  # Calculate prevalence, grouping by age bin
  data.prev <- data %>% group_by(Year, AgeBin_index, AgeBin, Gender, scenario_name, sim.id) %>% 
    summarize(num = sum(Numerator), denom = sum(Denominator), .groups = 'keep') %>% 
    mutate(Prevalence = num/denom)
  # Calculate mean prevalence across all sim runs
  data.mean <- data.prev %>% group_by(Year, AgeBin_index, AgeBin, Gender, scenario_name) %>% 
    summarize(mean.Prevalence = mean(Prevalence),
              sd.Prevalence = sd(Prevalence),
              .groups = 'keep') %>% 
    mutate(lower = max(mean.Prevalence - 2* sd.Prevalence, 0), 
           upper = mean.Prevalence + 2*sd.Prevalence)
  
  # Transform data
  data.prev <- data.prev %>% ungroup() %>% mutate(Gender = case_when(Gender==0 ~ "Male", Gender==1 ~ "Female"))
  data.mean <- data.mean %>% ungroup() %>% mutate(Gender = case_when(Gender==0 ~ "Male", Gender==1 ~ "Female"))
  
  p <- data.mean %>% 
    ggplot() + 
    # plot means
    geom_point(
      mapping = aes(x = AgeBin_index, y = mean.Prevalence, color = scenario_name),
      size=1
    ) + 
    geom_errorbar(
      mapping = aes(x=AgeBin_index, ymin=lower, ymax=upper, color=scenario_name),
      width=.15, size=1) + 
    facet_grid(cols = vars(Gender), rows = vars(Year)) + 
    xlab("Age") + 
    ylab(yaxis_lab) +
    theme_bw(base_size=16) +
    guides(fill = guide_legend(keywidth = 2, keyheight = 1)) +
    scale_x_discrete(
      breaks = 1:length(age_labels),
      labels = age_labels
      ) +
    theme(legend.position="bottom") +
    theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
    theme(strip.background = element_rect(colour="black", fill="white")) +
    theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) + 
    scale_color_manual(values=colors2plot) + 
    labs(title = title)
  
  return(p)
  }

```


```{r All ages prevalence for baseline}
p <- emodplot.prevalence(sim.cmd %>% filter(Age <= 50, Age >= 15), 
                          1990, 2040, 
                          title = 'All Ages Prevalence')

p + 
  geom_point(data = obs.prev.sheet %>% 
               filter(Province == 'All', AgeBin == "[15:50)", Gender %in% c("Male", "Female")), 
             mapping = aes(x = Year, y = Prevalence))
```

```{r All ages prevalence with treatment}
p <- emodplot.prevalence(sim.cmd.mh %>% filter(Age <= 50, Age >= 15), 
                          1990, 2040, 
                          title = 'All Ages Prevalence')

p + 
  geom_point(data = obs.prev.sheet %>% 
               filter(Province == 'All', AgeBin == "[15:50)", Gender %in% c("Male", "Female")), 
             mapping = aes(x = Year, y = Prevalence))
```

```{r}
base.prev <- sim.cmd %>% filter(Age <= 50, Age >= 15, Year >= 1990, Year <= 2020) %>% 
  group_by(Year, Gender, sim.id, scenario_name) %>% 
  summarize(Infected = sum(Infected), Population = sum(Population), .groups = 'keep') %>% 
  ungroup %>% 
  mutate(Prevalence = case_when(Population == 0 ~ 0,
                                  Population > 0 ~ Infected / Population))  %>% 
  group_by(Year, Gender) %>% 
  summarize(Prevalence = mean(Prevalence))


mh.prev <- sim.cmd.mh %>% filter(Age <= 50, Age >= 15, Year >= 1990, Year <= 2020) %>% 
  group_by(Year, Gender, sim.id, scenario_name) %>% 
  summarize(Infected = sum(Infected), Population = sum(Population), .groups = 'keep') %>% 
  ungroup %>% 
  mutate(Prevalence = case_when(Population == 0 ~ 0,
                                  Population > 0 ~ Infected / Population))  %>% 
  group_by(Year, Gender) %>% 
  summarize(Prevalence = mean(Prevalence))


merge(
  base.prev,
  mh.prev,by = c("Year", "Gender")
)
```


```{r Age-prevalence curves}
age_bins = c(15,20,25,30,35,40,45,50,55,60)
age_labels = c()
for (i in 1:(length(age_bins) - 1)){
  age_labels <- append(age_labels, paste0("[",age_bins[i],":",age_bins[i + 1],")"))
}

p <- emodplot.by_age_gender.cmd(data = sim.cmd,
                           numerator = "Infected",
                           denominator = "Population",
                           subset_years = c(2003, 2007, 2008, 2012, 2018),
                           age_bins = c(15,20,25,30,35,40,45,50,55,60),
                           yaxis_lab = "",
                           title = "Age Prevalence Curves"
                           )

# ggplot() + geom_point(data = obs.prev.sheet %>% 
#                  filter(Province == "All", AgeBin %in% age_labels, Gender %in% c("Male", "Female")) %>% 
#                  mutate(AgeBin_index = factor(AgeBin, labels = 1:length(age_labels))),
#            mapping = aes(x = AgeBin_index, y = Prevalence)
#              ) + facet_grid(cols = vars(Gender), rows = vars(Year)) + scale_x_discrete()

p1 <- p + geom_point(data = obs.prev.sheet %>% 
                 filter(Province == "All", AgeBin %in% age_labels, Gender %in% c("Male", "Female")) %>% 
                 mutate(AgeBin_index = factor(AgeBin, labels = 1:length(age_labels))),
           mapping = aes(x = AgeBin_index, y = Prevalence)
             )
p1

# ggsave("/gpfs/data/bershteynlab/EMOD/citrod01/MATUMAINI/Analysis/age_prev_plot.pdf",
#        p1, width = 8, height = 8, units = c("in"))

```


## OnArt coverage

```{r}
data <- sim.cmd %>% 
    group_by(Year, Gender, sim.id, scenario_name) %>% 
    summarize(On_ART = sum(On_ART), Population = sum(Population), .groups = 'keep') %>% 
    mutate(ARTCov = case_when(Population == 0 ~ 0,
                              Population > 0 ~ On_ART / Population))

p <- EMODAnalyzeR::emodplot.by_gender(data, 1990, 2040, 'ARTCov', title="ART Coverage") 
  

p
```
## Number on ART

```{r Number on ART, baseline}

data <- sim.cmd %>% 
  filter(Age >= 15) %>% 
    group_by(Year, Gender, sim.id, scenario_name) %>% 
    summarize(On_ART = sum(On_ART*pop.scaling.factor), Population = sum(Population), .groups = 'keep')

# ggplot() + 
#   geom_point(data = data %>% group_by(Year, Gender) %>% summarize(On_Art1 = mean(On_ART), .groups = 'keep') %>% ungroup() , 
#              mapping = aes(x = Year, y = On_Art1)) + 
#   facet_grid(cols = vars(Gender) )

p <- EMODAnalyzeR::emodplot.by_gender(data, 1990, 2040, 'On_ART', title="ART") 

p + 
  geom_point(data = obs.onart.sheet %>% filter(Province != "All", AgeBin == '[15:100)') %>% 
    group_by(Year, Gender) %>% 
    summarize(OnART = sum(OnART), .groups = 'keep'),
    mapping= aes(x = Year, y = OnART)) + 
  ylim(0,300000)

```

```{r Number on ART, mh care}

data <- sim.cmd.mh %>% 
  filter(Age >= 15) %>% 
    group_by(Year, Gender, sim.id, scenario_name) %>% 
    summarize(On_ART = sum(On_ART*pop.scaling.factor), Population = sum(Population), .groups = 'keep')

# ggplot() + 
#   geom_point(data = data %>% group_by(Year, Gender) %>% summarize(On_Art1 = mean(On_ART), .groups = 'keep') %>% ungroup() , 
#              mapping = aes(x = Year, y = On_Art1)) + 
#   facet_grid(cols = vars(Gender) )

p <- EMODAnalyzeR::emodplot.by_gender(data, 1990, 2040, 'On_ART', title="ART") 

p + 
  geom_point(data = obs.onart.sheet %>% filter(Province != "All", AgeBin == '[15:100)') %>% 
    group_by(Year, Gender) %>% 
    summarize(OnART = sum(OnART), .groups = 'keep'),
    mapping= aes(x = Year, y = OnART)) + 
  ylim(0,300000)

```

```{r}
onart.mh <- sim.cmd.mh %>% 
  filter(Age >= 15) %>% 
    group_by(Year, Gender, sim.id, scenario_name) %>% 
    summarize(On_ART = sum(On_ART*pop.scaling.factor), Population = sum(Population), .groups = 'keep') %>%
  group_by(Year, Gender) %>% 
  summarize(On_ART = mean(On_ART))


onart.base <- sim.cmd %>% 
  filter(Age >= 15) %>% 
    group_by(Year, Gender, sim.id, scenario_name) %>% 
    summarize(On_ART = sum(On_ART*pop.scaling.factor), Population = sum(Population), .groups = 'keep') %>%
  group_by(Year, Gender) %>% 
  summarize(On_ART = mean(On_ART))

merge(onart.base, onart.mh,
      by = c("Year","Gender"))

```


## Incidence

```{r}
EMODAnalyzeR::emodplot.incidence(sim.cmd,
                                 1990, 2040)
```

## Population
```{r Population}
data <- sim.cmd %>% 
  mutate(pop.scaled = Population * pop.scaling.factor) %>% 
  filter(Year >= 1990, Year <= 2040) %>% 
  group_by(Year, Gender, sim.id) %>% 
  summarize(total.pop = sum(Population* pop.scaling.factor), .groups = 'keep') %>% 
  mutate(Gender = case_when(Gender==0 ~ "Male", Gender==1 ~ "Female"))

data.mean <- data %>% group_by(Year, Gender) %>% summarize(mean.pop = mean(total.pop), .groups = 'keep')

ggplot() + 
  geom_point(data, mapping = aes(x = Year, y = total.pop), color = 'gray', alpha = .005) + 
  geom_line(data.mean, mapping = aes(x = Year, y = mean.pop), color = 'blue', size=1.5) + 
  facet_wrap(~ Gender, ncol=2) +
  xlab("Year") +
  ylab("Population All Ages") + 
  theme_bw(base_size=16) +
  guides(fill = guide_legend(keywidth = 2, keyheight = 1)) +
  theme(legend.position="bottom") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  theme(strip.background = element_rect(colour="black", fill="white")) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())
  
```



## CMD Prevalence

```{r Calculate CMD Prevalence - baseline}
# Aggregate CMD prevalence, to plot using EMODAnalyzer
cmd.data <- sim.cmd %>% 
  pivot_wider(id_cols = c(Year, Age, Gender, sim.id, scenario_name),
              names_from = c(IP_Key.CMDStatus),
              values_from = c(Population)) %>% 
  group_by(Year, Gender, sim.id, scenario_name) %>% 
  summarize(CMD_pos = sum(CMD_pos), 
            Population = sum(CMD_pos + CMD_neg + CMD_remission + CMD_remission_treated), 
            .groups = 'keep') %>% 
  mutate(CMD_prev = case_when(Population == 0 ~ 0,
                              Population > 0 ~ CMD_pos / Population))

# Calculate means across year and gender
cmd.data.means <- cmd.data %>%
  group_by(Year, Gender, scenario_name) %>% 
  summarize(CMD_prev = mean(CMD_prev), 
            CMD_pos = mean(CMD_pos),
            Population = mean(Population), 
            .groups = 'keep')  

cmd.data.means


```


```{r Calculate CMD Prevalence - treatment}
# Aggregate CMD prevalence, to plot using EMODAnalyzer
cmd.data.mh <- sim.cmd.mh %>% 
  pivot_wider(id_cols = c(Year, Age, Gender, sim.id, scenario_name),
              names_from = c(IP_Key.CMDStatus),
              values_from = c(Population)) %>% 
  group_by(Year, Gender, sim.id, scenario_name) %>% 
  summarize(CMD_pos = sum(CMD_pos), 
            Population = sum(CMD_pos + CMD_neg + CMD_remission + CMD_remission_treated), 
            .groups = 'keep') %>% 
  mutate(CMD_prev = case_when(Population == 0 ~ 0,
                              Population > 0 ~ CMD_pos / Population))

# Calculate means across year and gender
cmd.data.mh.means <- cmd.data.mh %>%
  group_by(Year, Gender, scenario_name) %>% 
  summarize(CMD_prev = mean(CMD_prev), 
            CMD_pos = mean(CMD_pos),
            Population = mean(Population), 
            .groups = 'keep')  

merge(cmd.data.means, cmd.data.mh.means,
      by = c("Year", "Gender"))



```

```{r Calculate CMD prevalence by HIV status}

cmd.prev.hiv.pos <- sim.cmd %>% 
   pivot_wider(id_cols = c(Year, Age, Gender, sim.id, scenario_name),
              names_from = c(IP_Key.CMDStatus),
              values_from = c(Infected)) %>% 
  group_by(Year, Gender, sim.id, scenario_name) %>% 
  summarize(HIVpos.CMD.pos = sum(CMD_pos),
            HIVpos.pop = sum(CMD_pos + CMD_neg + CMD_remission + CMD_remission_treated), 
            .groups = 'keep') %>% 
  ungroup() %>% 
  mutate(HIVpos.CMD.prev = case_when(HIVpos.pop == 0 ~ 0,
                              HIVpos.pop > 0 ~ HIVpos.CMD.pos / HIVpos.pop)) %>% 
  group_by(Year, Gender) %>% 
  summarize(HIVpos.CMD.prev = mean(HIVpos.CMD.prev))

cmd.prev.hiv.neg <- sim.cmd %>% 
  mutate(HIVneg = Population - Infected) %>% 
   pivot_wider(id_cols = c(Year, Age, Gender, sim.id, scenario_name),
              names_from = c(IP_Key.CMDStatus),
              values_from = c(HIVneg)) %>% 
  group_by(Year, Gender, sim.id, scenario_name) %>% 
  summarize(HIVneg.CMD.pos = sum(CMD_pos),
            HIVneg.pop = sum(CMD_pos + CMD_neg + CMD_remission + CMD_remission_treated), 
            .groups = 'keep') %>% 
  ungroup() %>% 
  mutate(HIVneg.CMD.prev = case_when(HIVneg.pop == 0 ~ 0,
                              HIVneg.pop > 0 ~ HIVneg.CMD.pos / HIVneg.pop)) %>% 
  group_by(Year, Gender) %>% 
  summarize(HIVneg.CMD.prev = mean(HIVneg.CMD.prev))


cmd.prev.hiv <- sim.cmd %>% mutate(HIVneg = Population - Infected) %>% 
  pivot_wider(id_cols = c(Year, Age, Gender, sim.id, scenario_name),
              names_from = c(IP_Key.CMDStatus),
              values_from = c(Infected, HIVneg)) %>% 
  group_by(Year, Gender, sim.id, scenario_name) %>% 
  summarize(Infected_CMD_pos = sum(Infected_CMD_pos), 
            Infected_Population = sum(Infected_CMD_pos + Infected_CMD_neg + Infected_CMD_remission + Infected_CMD_remission_treated),
            HIVneg_CMD_pos = sum(HIVneg_CMD_pos),
            HIVneg_Population = sum(HIVneg_CMD_pos + HIVneg_CMD_neg + HIVneg_CMD_remission + HIVneg_CMD_remission_treated),
            .groups = 'keep') %>% 
  ungroup() %>% 
  mutate(HIVpos.CMD.prev = Infected_CMD_pos/(Infected_Population), 
         HIVneg.CMD.prev = HIVneg_CMD_pos/HIVneg_Population
         ) %>% 
  group_by(Year, Gender) %>% 
  summarize(
    HIVpos.CMD.prev = mean(HIVpos.CMD.prev), 
    HIVneg.CMD.prev = mean(HIVneg.CMD.prev),
    Infected_CMD_pos = mean(Infected_CMD_pos), Infected_Population = mean(Infected_Population),
    HIVneg_CMD_pos = mean(HIVneg_CMD_pos), HIVneg_Population = mean(HIVneg_Population))

cmd.prev.hiv 

cmd.data %>% group_by(Year, Gender) %>% 
  summarize(CMD_prev = mean(CMD_prev))

```
```{r}
merge(cmd.prev.hiv.pos, cmd.prev.hiv.neg,
      by = c("Year","Gender"))
```


```{r}
cmd.prev.hiv.mh <- sim.cmd.mh %>% mutate(HIVneg = Population - Infected) %>% 
  pivot_wider(id_cols = c(Year, Age, Gender, sim.id, scenario_name),
              names_from = c(IP_Key.CMDStatus),
              values_from = c(Infected, HIVneg)) %>% 
  group_by(Year, Gender, sim.id, scenario_name) %>% 
  summarize(Infected_CMD_pos = sum(Infected_CMD_pos), 
            Infected_Population = sum(Infected_CMD_pos + Infected_CMD_neg + Infected_CMD_remission + Infected_CMD_remission_treated),
            HIVneg_CMD_pos = sum(HIVneg_CMD_pos),
            HIVneg_Population = sum(HIVneg_CMD_pos + HIVneg_CMD_neg + HIVneg_CMD_remission + HIVneg_CMD_remission_treated),
            .groups = 'keep') %>% 
  ungroup() %>% 
  mutate(HIVpos.CMD.prev = Infected_CMD_pos/(Infected_Population), 
         HIVneg.CMD.prev = HIVneg_CMD_pos/HIVneg_Population
         ) %>% 
  group_by(Year, Gender) %>% 
  summarize(
    HIVpos.CMD.prev = mean(HIVpos.CMD.prev), 
    HIVneg.CMD.prev = mean(HIVneg.CMD.prev),
    Infected_CMD_pos = mean(Infected_CMD_pos), Infected_Population = mean(Infected_Population),
    HIVneg_CMD_pos = mean(HIVneg_CMD_pos), HIVneg_Population = mean(HIVneg_Population))

cmd.prev.hiv.mh
```


```{r CMD prevalence by age}

cmd.data.age <- sim.cmd %>% 
  pivot_wider(id_cols = c(Year, Age, Gender, sim.id, scenario_name),
              names_from = c(IP_Key.CMDStatus),
              values_from = c(Population)) %>% 
  group_by(Year, Age, Gender, sim.id, scenario_name) %>% 
  summarize(CMD_pos = sum(CMD_pos), 
            Population = sum(CMD_pos + CMD_neg + CMD_remission + CMD_remission_treated), 
            .groups = 'keep') %>% 
  ungroup() %>% 
  mutate(CMD_prev = case_when(Population == 0 ~ 0,
                              Population > 0 ~ CMD_pos / Population))

cmd.data.age.mean <- cmd.data.age %>%
  group_by(Year, Age, Gender, scenario_name) %>% 
  summarize(CMD_prev = mean(CMD_prev), 
            CMD_pos = mean(CMD_pos),
            Population = mean(Population), 
            .groups = 'keep')

cmd.data.age.mean %>% filter(Year == 2004)
```

```{r CMD prevalence by age for baseline}

cmd.data.age.mh <- sim.cmd.mh %>% 
  pivot_wider(id_cols = c(Year, Age, Gender, sim.id, scenario_name),
              names_from = c(IP_Key.CMDStatus),
              values_from = c(Population)) %>% 
  group_by(Year, Age, Gender, sim.id, scenario_name) %>% 
  summarize(CMD_pos = sum(CMD_pos), 
            Population = sum(CMD_pos + CMD_neg + CMD_remission + CMD_remission_treated), 
            .groups = 'keep') %>% 
  ungroup() %>% 
  mutate(CMD_prev = case_when(Population == 0 ~ 0,
                              Population > 0 ~ CMD_pos / Population))

cmd.data.age.mh.mean <- cmd.data.age.mh %>%
  group_by(Year, Age, Gender, scenario_name) %>% 
  summarize(CMD_prev = mean(CMD_prev), 
            CMD_pos = mean(CMD_pos),
            Population = mean(Population), 
            .groups = 'keep')

cmd.data.age.mh.mean %>% filter(Year == 2004)
```


```{r Plot CMD Prevalence baseline}
# Aggregate CMD prevalence, to plot using EMODAnalyzer
cmd.data <- sim.cmd %>% 
  pivot_wider(id_cols = c(Year, Age, Gender, sim.id, scenario_name),
              names_from = c(IP_Key.CMDStatus),
              values_from = c(Population)) %>% 
  group_by(Year, Gender, sim.id, scenario_name) %>% 
  summarize(CMD_pos = sum(CMD_pos), 
            Population = sum(CMD_pos + CMD_neg + CMD_remission + CMD_remission_treated), 
            .groups = 'keep') %>% 
  ungroup() %>% 
  mutate(CMD_prev = case_when(Population == 0 ~ 0,
                              Population > 0 ~ CMD_pos / Population))

EMODAnalyzeR::emodplot.by_gender(cmd.data,
                   date.start = 1990, date.end = 2020,
                   col2plot = 'CMD_prev',
                   title = 'CMD Prevalence'
)

# actual number should be around .05 for both genders
# we are too low by a factor of 5

```
 

```{r}
cmd.data.mh <- sim.cmd.mh %>% 
  pivot_wider(id_cols = c(Year, Age, Gender, sim.id, scenario_name),
              names_from = c(IP_Key.CMDStatus),
              values_from = c(Population)) %>% 
  group_by(Year, Gender, sim.id, scenario_name) %>% 
  summarize(CMD_pos = sum(CMD_pos), 
            Population = sum(CMD_pos + CMD_neg + CMD_remission + CMD_remission_treated), 
            .groups = 'keep') %>% 
  ungroup() %>% 
  mutate(CMD_prev = case_when(Population == 0 ~ 0,
                              Population > 0 ~ CMD_pos / Population))

EMODAnalyzeR::emodplot.by_gender(cmd.data.mh,
                   date.start = 1990, date.end = 2020,
                   col2plot = 'CMD_prev',
                   title = 'CMD Prevalence'
)
```


```{r Plot CMD Prevalence by Age}

age_bins = c(18, 25, 30, 40, 45, 50, 60, 99)
age_labels = c()
for (i in 1:(length(age_bins) - 1)){
  age_labels <- append(age_labels, paste0("[",age_bins[i],":",age_bins[i + 1],")"))
}

subset_years = c(2004)


cmd.data.age <- sim.cmd.mh %>% 
  pivot_wider(id_cols = c(Year, Age, Gender, sim.id, scenario_name),
              names_from = c(IP_Key.CMDStatus),
              values_from = c(Population)) %>% 
  group_by(Year, Age, Gender, sim.id, scenario_name) %>% 
  mutate(Population = CMD_pos + CMD_neg + CMD_remission + CMD_remission_treated) %>% 
  summarize(CMD_pos = sum(CMD_pos), 
            Population = sum(Population), 
            .groups = 'keep') %>% 
  ungroup() %>% 
  mutate(CMD_prev = case_when(Population == 0 ~ 0,
                              Population > 0 ~ CMD_pos / Population))

p <- cmd.data.age %>% EMODAnalyzeR::emodplot.by_age_gender("CMD_pos", "Population", 
                       subset_years, 
                       age_bins, 
                       yaxis_lab = "CMD Prevalence", 
                       title = "CMD Prevalence by Age")

obs.cmdprev.sheet$AgeBin_index = factor(obs.cmdprev.sheet$AgeBin,labels = 1:length(age_labels))

p + 
  geom_point(obs.cmdprev.sheet,
             mapping = aes(x = AgeBin_index, y = CMDPrevalence))
```

