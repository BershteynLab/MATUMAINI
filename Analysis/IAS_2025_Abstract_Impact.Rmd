---
title: "IAS_2025_Abstract_Impact"
output: html_document
date: "2025-01-17"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Introduction

The purpose of this notebook is to track the work done in preparation for 
abstract submission to IAS 2025.

The main focus of the notebook is measuring the impact of depression treatment
on HIV outcomes

# Libraries

```{r Load Libraries, echo = FALSE}
library(tidyverse)
library(data.table)
library(magrittr)
library(rsample)
library(readxl)
library(devtools)
library(ggpubr)
library(patchwork)

devtools::install_github("BershteynLab/EMODAnalyzeR", force = TRUE)
```

```{r}
# Confidence interval functions
lower_ci <- function(mean, se, n, conf_level = 0.95){
  lower_ci <- mean - qt(1 - ((1 - conf_level) / 2), n - 1) * se
  return(lower_ci)
}
upper_ci <- function(mean, se, n, conf_level = 0.95){
  upper_ci <- mean + qt(1 - ((1 - conf_level) / 2), n - 1) * se
  return(upper_ci)
}
```


# Results for DALY calculations

### Baseline

```{r}
experiment.path = "/gpfs/scratch/citrod01/experiments/MATUMAINI/CROI2025/Baseline-campaign_MATUMAINI_202305-baseline___2024_12_27_12_25_54_409114/"

daly.results.baseline <- EMODAnalyzeR::read.simulation.results.bigpurple(
  experiment_path = experiment.path,
  scenario_name = "baseline",
    summarize_columns = c("Population","Infected", "On_ART",
                        "Died", "Died_from_HIV",
                        "Newly.Infected","Diagnosed"),
  stratify_columns = c("Year", "Gender", "Age", "IP_Key.CMDStatus", "HasHIV",
                       "CMD_Treat_staging", "CMD_Treat", "CMD_Incidence2", "CMD_Relapse2"),
  min_age_inclusive = 0,
  max_age_inclusive = 99
)
```

### Universal Treatment

```{r}
experiment.path = "/gpfs/scratch/citrod01/experiments/MATUMAINI/CROI2025/Baseline-campaign_MATUMAINI_202305_uni-uni___2024_12_26_18_23_40_050060/"

daly.results.uni <- EMODAnalyzeR::read.simulation.results.bigpurple(
  experiment_path = experiment.path,
  scenario_name = "uni",
    summarize_columns = c("Population","Infected", "On_ART",
                        "Died", "Died_from_HIV",
                        "Newly.Infected","Diagnosed"),
  stratify_columns = c("Year", "Gender", "Age", "IP_Key.CMDStatus",  "HasHIV",
                       "CMD_Treat_staging", "CMD_Treat", "CMD_Incidence2", "CMD_Relapse2"),
  min_age_inclusive = 0,
  max_age_inclusive = 99
)
```

### ART Annual CMD Treatment


```{r}
#experiment.path = "/gpfs/scratch/citrod01/experiments/MATUMAINI/CROI2025/Baseline-campaign_MATUMAINI_202305_art-art___2024_12_26_18_21_11_286438/"
experiment.path = "/gpfs/scratch/citrod01/experiments/MATUMAINI/CROI2025/Baseline-campaign_MATUMAINI_202305_art-art___2025_01_14_15_36_49_614944/"

daly.results.art <- EMODAnalyzeR::read.simulation.results.bigpurple(
  experiment_path = experiment.path,
  scenario_name = "art",
    summarize_columns = c("Population","Infected", "On_ART",
                        "Died", "Died_from_HIV",
                        "Newly.Infected","Diagnosed"),
  stratify_columns = c("Year", "Gender", "Age", "IP_Key.CMDStatus",  "HasHIV",
                       "CMD_Treat_staging", "CMD_Treat", "CMD_Incidence2", "CMD_Relapse2"),
  min_age_inclusive = 0,
  max_age_inclusive = 99
)
```


### Status Neutral Annual CMD Treatment

```{r}
experiment.path <- "/gpfs/scratch/citrod01/experiments/MATUMAINI/CROI2025/Baseline-campaign_MATUMAINI_202305_neutral_annual-annual___2024_12_26_18_15_58_639286/"

daly.results.neutral.annual <- EMODAnalyzeR::read.simulation.results.bigpurple(
  experiment_path = experiment.path,
  scenario_name = "neutral.annual",
    summarize_columns = c("Population","Infected", "On_ART",
                        "Died", "Died_from_HIV",
                        "Newly.Infected","Diagnosed"),
  stratify_columns = c("Year", "Gender", "Age", "IP_Key.CMDStatus",  "HasHIV",
                       "CMD_Treat_staging", "CMD_Treat", "CMD_Incidence2", "CMD_Relapse2"),
  min_age_inclusive = 0,
  max_age_inclusive = 99
)
```

### Status Neutral CMD upon HIV test
Deprecating this scenario for now, it seems to affect fewer people and is not very impactful. Annual treatment enrollment is more optimistic and emphasizes that it really is less effective.

```{r}
# experiment.path <- "/gpfs/scratch/citrod01/experiments/MATUMAINI/CROI2025/Baseline-campaign_MATUMAINI_202305_neutral_testing-testing___2024_12_26_18_18_41_867421/"
# 
# daly.results.neutral.testing <- EMODAnalyzeR::read.simulation.results.bigpurple(
#   experiment_path = experiment.path,
#   scenario_name = "neutral.testing",
#     summarize_columns = c("Population","Infected", "On_ART",
#                         "Died", "Died_from_HIV",
#                         "Newly.Infected","Diagnosed"),
#   stratify_columns = c("Year", "Gender", "Age", "IP_Key.CMDStatus",  "HasHIV",
#                        "CMD_Treat_staging", "CMD_Treat", "CMD_Incidence2", "CMD_Relapse2"),
#   min_age_inclusive = 0,
#   max_age_inclusive = 99
# )
```

### ART-CETA - treatment for unsuppressed PLHIV on ART
```{r}
experiment.path <- "/gpfs/scratch/citrod01/experiments/MATUMAINI/CROI2025/Baseline-campaign_MATUMAINI_202305_art_ceta-art_ceta___2025_01_14_00_46_13_096598/"

daly.results.art.ceta <- EMODAnalyzeR::read.simulation.results.bigpurple(
  experiment_path = experiment.path,
  scenario_name = "art.ceta",
    summarize_columns = c("Population","Infected", "On_ART",
                        "Died", "Died_from_HIV",
                        "Newly.Infected","Diagnosed"),
  stratify_columns = c("Year", "Gender", "Age", "IP_Key.CMDStatus",  "HasHIV",
                       "CMD_Treat_staging", "CMD_Treat", "CMD_Incidence2", "CMD_Relapse2"),
  min_age_inclusive = 0,
  max_age_inclusive = 99
)
```

### ART-Neutral - combine these together, just for comparison's sake

```{r}
experiment.path <- "/gpfs/scratch/citrod01/experiments/MATUMAINI/CROI2025/Baseline-campaign_MATUMAINI_202305_art_neutral-art_neutral___2025_01_14_00_43_19_000664/"

daly.results.art.neutral <- EMODAnalyzeR::read.simulation.results.bigpurple(
  experiment_path = experiment.path,
  scenario_name = "art.neutral",
    summarize_columns = c("Population","Infected", "On_ART",
                        "Died", "Died_from_HIV",
                        "Newly.Infected","Diagnosed"),
  stratify_columns = c("Year", "Gender", "Age", "IP_Key.CMDStatus",  "HasHIV",
                       "CMD_Treat_staging", "CMD_Treat", "CMD_Incidence2", "CMD_Relapse2"),
  min_age_inclusive = 0,
  max_age_inclusive = 99
)
```


### Join Together

```{r}
# sim.results.all %>% 
#   filter(Year == 2020.5, scenario_name == 'baseline.art') %>% 
#   group_by(scenario_name, sim.ix) %>% 
#   summarize(Population = sum(Population * pop_scaling_factor)) %>% 
#   group_by(scenario_name) %>% 
#   summarize(Population = mean(Population))

daly.results.treatment <- rbind(
  daly.results.baseline, 
  daly.results.uni,
  daly.results.art,
  daly.results.neutral.annual, 
  daly.results.art.ceta,
  daly.results.art.neutral
  #daly.results.neutral.testing
)

#CENSUS_YEAR = 2009
#KEN_CENSUS_POP = 5352385

CENSUS_YEAR = 2020.5
KEN_CENSUS_POP = 6953951

sim.results.pop.scaling <- daly.results.treatment %>%
    filter(Year == CENSUS_YEAR) %>%
    group_by(sim.ix, scenario_name) %>%
    summarize(total.pop = sum(Population), .groups = 'drop_last') %>%
    mutate(pop_scaling_factor = KEN_CENSUS_POP/total.pop)

daly.results.treatment <- daly.results.treatment %>%
  inner_join(
    sim.results.pop.scaling,
    by = c("sim.ix", "scenario_name")
  )
```

# Metrics

## What's going on in 2025?

### Population
```{r}
pop.2025 <- daly.results.treatment %>% 
  filter(Year == 2025, Age >= 15) %>% 
  group_by(scenario_name, sim.ix) %>% 
  summarize(Population = sum(Population * pop_scaling_factor), .groups = 'keep') %>% 
  group_by(scenario_name) %>% 
  summarize(Population = mean(Population), .groups = "keep") %>% ungroup()

pop.2025
```


### PLHIV 

```{r}
plhiv.2025 <- daly.results.treatment %>% 
  filter(Year == 2025, Age >= 15) %>% 
  group_by(Gender, scenario_name, sim.ix) %>% 
  summarize(Infected = sum(Infected * pop_scaling_factor), .groups = 'keep') %>% 
  group_by(Gender,scenario_name) %>% 
  summarize(Infected = mean(Infected), .groups = "keep") %>%
  pivot_wider(id_cols = c("scenario_name"), values_from = c("Infected"), names_from = c("Gender"),
              names_prefix = "Infected_") %>% 
  select(scenario_name, Infected_Male = Infected_0, Infected_Female = Infected_1) %>% 
  mutate(Infected = Infected_Male + Infected_Female)

plhiv.2025
```

### On ART

```{r}
onart.2025 <- daly.results.treatment %>% 
  filter(Year == 2025, Age >= 15) %>% 
  group_by(Gender, scenario_name, sim.ix) %>% 
  summarize(On_ART = sum(On_ART * pop_scaling_factor), .groups = 'keep') %>% 
  group_by(Gender,scenario_name) %>% 
  summarize(On_ART = mean(On_ART), .groups = "keep") %>%
  pivot_wider(id_cols = c("scenario_name"), values_from = c("On_ART"), names_from = c("Gender"),
              names_prefix = "On_ART_") %>% 
  select(scenario_name, On_ART_Male = On_ART_0, On_ART_Female = On_ART_1) %>% 
  mutate(On_ART = On_ART_Male + On_ART_Female)

onart.2025
```

```{r}
# Person-years lived on ART

onart.2025 <- daly.results.treatment %>% 
  filter(Year >= 2025, Age >= 15) %>% 
  group_by(Gender, scenario_name, sim.ix) %>% 
  summarize(On_ART = sum(On_ART * pop_scaling_factor), .groups = 'keep') %>% 
  group_by(Gender,scenario_name) %>% 
  summarize(On_ART = mean(On_ART), .groups = "keep") %>%
  pivot_wider(id_cols = c("scenario_name"), values_from = c("On_ART"), names_from = c("Gender"),
              names_prefix = "On_ART_") %>% 
  select(scenario_name, On_ART_Male = On_ART_0, On_ART_Female = On_ART_1) %>% 
  mutate(On_ART = On_ART_Male + On_ART_Female)

onart.2025
```



### People living with depression

```{r}
pldep.2025 <- daly.results.treatment %>% 
  filter(Year == 2025, Age >=15) %>%
  filter(IP_Key.CMDStatus == "CMD_pos") %>%
  group_by(scenario_name, sim.ix) %>% 
  summarize(Population = sum(Population * pop_scaling_factor), .groups = "drop_last" ) %>% 
  group_by(scenario_name) %>% 
  summarize(Depression = mean(Population), .groups = "drop_last")

pldep.2025
```

### People with HIV living with depression

```{r}
plhiv.dep.2025 <-  daly.results.treatment %>% 
  filter(Year == 2025, Age >= 15) %>% 
  group_by(scenario_name, IP_Key.CMDStatus, sim.ix) %>% 
  summarize(Population = sum(Population * pop_scaling_factor),
            Infected = sum(Infected * pop_scaling_factor),
            .groups = 'drop_last') %>% 
  group_by(scenario_name, IP_Key.CMDStatus) %>% 
  summarize(Population = mean(Population),
            PLHIV = mean(Infected), .groups = 'drop_last') %>% 
  pivot_wider(
    id_cols = scenario_name,
    values_from = c("Population", "PLHIV"), 
    names_from = IP_Key.CMDStatus)

plhiv.dep.2025
```


## Calculate HIV infections and deaths averted, 2025-2035

```{r}
hiv.averted.data <- daly.results.treatment %>% 
  filter(Age >=15) %>%
  group_by(Year, Gender, scenario_name, sim.ix) %>% 
  summarize(Died_from_HIV = sum(Died_from_HIV * pop_scaling_factor),
            Newly.Infected = sum(Newly.Infected * pop_scaling_factor), .groups = 'drop_last') %>% 
  group_by(Year, Gender, scenario_name) %>%
  summarize(Died_from_HIV = mean(Died_from_HIV),
            Newly.Infected = mean(Newly.Infected), .groups = 'drop_last') %>%
  mutate(Gender = case_when(Gender==0 ~ "Male", Gender==1 ~ "Female"))


hiv.averted.data %>% 
  filter(Year >= 2025) %>% 
  group_by(scenario_name) %>% 
  summarize(Died_from_HIV = sum(Died_from_HIV),
            Newly.Infected = sum(Newly.Infected))
```

```{r}
hiv.averted.data.agg <- hiv.averted.data %>% 
  filter(Year >= 2025) %>% 
  group_by(Gender, scenario_name) %>% 
  summarize(Died_from_HIV = sum(Died_from_HIV), 
            Newly.Infected = sum(Newly.Infected), .groups = 'drop_last')

hiv.averted.data.agg <- hiv.averted.data.agg %>% 
  merge(
    hiv.averted.data.agg %>% 
      filter(scenario_name == 'baseline') %>% 
      select(Gender, Died_from_HIV.baseline = Died_from_HIV, Newly.Infected.baseline = Newly.Infected), 
    by = c("Gender")
  ) %>% 
  mutate(
    Died_from_HIV.averted = Died_from_HIV.baseline - Died_from_HIV,
    Newly.Infected.averted = Newly.Infected.baseline - Newly.Infected,
    )

hiv.averted.data.agg %>% 
  group_by(scenario_name) %>% 
  summarize(Died_from_HIV.averted = sum(Died_from_HIV.averted),
            Newly.Infected.averted = sum(Newly.Infected.averted), .groups = 'drop_last')
```


## Calculate Depression episodes averted, 2025-2035

```{r}
cmd.prev.time.data <- daly.results.treatment %>% 
  mutate(Year = floor(Year)) %>% 
  filter(Age >= 15) %>% 
  group_by(Year, Gender, scenario_name, IP_Key.CMDStatus, sim.ix) %>% 
  summarize(Population = sum(Population* pop_scaling_factor), .groups = 'drop_last') %>% 
  pivot_wider(
    id_cols = c(Year, Gender, scenario_name, sim.ix) , 
    values_from = c(Population), 
    names_from = c(IP_Key.CMDStatus)
  ) %>% 
  mutate(Population = CMD_neg + CMD_pos + CMD_recovered + CMD_treated) %>% 
  mutate(CMD.prev = CMD_pos/Population) %>% 
  group_by(Year, Gender, scenario_name) %>% 
  summarize(
    CMD.prev = mean(CMD.prev), 
    Population = mean(Population), 
    CMD_neg = mean(CMD_neg), 
    CMD_pos = mean(CMD_pos), 
    CMD_recovered = mean(CMD_recovered), 
    CMD_treated = mean(CMD_treated), 
    .groups = 'drop_last') %>%
  mutate(Gender = case_when(Gender==0 ~ "Male", Gender==1 ~ "Female"))
```

```{r}
cmd.prev.time.data %>% 
  filter(Year >= 2025) %>% 
  group_by(scenario_name) %>% 
  summarize(CMD_pos = sum(CMD_pos))
```

```{r}
depression.eps.data <- daly.results.treatment %>% 
  filter(Year >= 2025, Year <= 2035, Age >=15) %>%
  filter(IP_Key.CMDStatus == "CMD_pos") %>%
  group_by(scenario_name, sim.ix) %>% 
  summarize(Population = sum(Population * pop_scaling_factor)) %>% 
  group_by(scenario_name) %>% 
  summarize(Population = mean(Population), .groups = 'drop_last')

depression.eps.data
```

## Calculate Impact

### Define some functions

```{r}
bt_mean <- function(splits, colname){
  x <- as.data.frame(analysis(splits))
  mean(x[[colname]])
}

calculate.CI.by.metric = function(data, scenario.name, metric, n = 500){
  bt_resamples <- bootstraps(data %>% filter(scenario_name == scenario.name), times = n)
  
  bt_resamples$mean.metric <- map_dbl(bt_resamples$splits, bt_mean, metric)
  metric_95 <- quantile(bt_resamples$mean.metric, probs = c(0.025, 0.975))
  
  return(
      data.frame(
      scenario_name = scenario.name, 
      metric = metric,
      metric.mean = mean(bt_resamples$mean.metric),
      metric.lb = metric_95[[1]], 
      metric.ub = metric_95[[2]]
    )
  )
}
```


### HIV deaths and infections averted

```{r}
hiv.averted.stats <- daly.results.treatment %>% 
  filter(Age >=15, Year >= 2025) %>%
  group_by(scenario_name, sim.ix) %>% 
  summarize(Died_from_HIV = sum(Died_from_HIV * pop_scaling_factor),
            Newly.Infected = sum(Newly.Infected * pop_scaling_factor), 
            Depression.episodes = sum((CMD_Incidence2 + CMD_Relapse2) * pop_scaling_factor),
            .groups = 'drop_last') %>% 
  ungroup()

hiv.averted.stats <- hiv.averted.stats %>% 
  merge(
    hiv.averted.stats %>% 
      filter(scenario_name == 'baseline') %>% 
      select(sim.ix, 
             Died_from_HIV.baseline = Died_from_HIV, 
             Newly.Infected.baseline = Newly.Infected,
             Depression.episodes.baseline = Depression.episodes), 
    by = c("sim.ix")
  ) %>% 
  mutate(
    Died_from_HIV.averted = Died_from_HIV.baseline - Died_from_HIV,
    Newly.Infected.averted = Newly.Infected.baseline - Newly.Infected,
    Depression.episodes.averted = Depression.episodes.baseline - Depression.episodes
    ) %>% 
  mutate(
    Died_from_HIV.averted.pct = Died_from_HIV.averted/Died_from_HIV.baseline,
    Newly.Infected.averted.pct = Newly.Infected.averted/Newly.Infected.baseline,
    Depression.episodes.averted.pct = Depression.episodes.averted/Depression.episodes.baseline
  )



metric.names = c(
  "Died_from_HIV.averted",
  "Died_from_HIV.averted.pct",
  "Newly.Infected.averted",
  "Newly.Infected.averted.pct",
  "Depression.episodes.averted",
  "Depression.episodes.averted.pct"
)

scenario_names = hiv.averted.stats$scenario_name %>% unique 

metrics = data.frame()

for (i in metric.names){
  for (j in scenario_names) {
    
    #print(c(i,j))
    h <- calculate.CI.by.metric(
      data = hiv.averted.stats, 
      scenario.name = j,
      metric = i)
    
    metrics = rbind(metrics, h)
  }
}

HIV.Depression.Averted.Data <- metrics
```

```{r}
HIV.Depression.Averted.Data
```

### Depression Episodes Averted

## Calculate DALYs

### HIV-related DALYs

#### DALY calculation

```{r}
data <- daly.results.treatment

data_by_age_year <- data %>%
  dplyr::group_by(Year, Age, sim.ix, scenario_name) %>%
  dplyr::summarise(
    Died_from_HIV = sum(Died_from_HIV),
     Infected = sum(Infected),
     On_ART = sum(On_ART),
     pop_scaling_factor = mean(pop_scaling_factor),
     .groups = "drop_last"
   )

data_by_age_year$Year_Integer <- floor((data_by_age_year$Year-0.5))

m2 <- data_by_age_year %>%
        dplyr::group_by(Year_Integer, Age, sim.ix, scenario_name) %>%
        dplyr::summarise(
          Died_from_HIV = sum(Died_from_HIV),
          Infected = mean(Infected),
          On_ART = mean(On_ART),
          pop_scaling_factor = mean(pop_scaling_factor),
          .groups = "drop_last"
         )

m2 <- m2 %>%
        mutate(On_ART_calib = On_ART*pop_scaling_factor,
        Infected_calib = Infected*pop_scaling_factor,
        Died_from_HIV_calib = Died_from_HIV*pop_scaling_factor,
        Infected_off_ART_calib = (Infected - On_ART)*pop_scaling_factor)

life_expectancy = 80
m2$Age <- ifelse(m2$Age >life_expectancy, life_expectancy, m2$Age)

m3 <- m2 %>%
      dplyr::group_by(Year_Integer, Age, scenario_name, sim.ix) %>%
      dplyr::select(Year_Integer, Age, scenario_name, sim.ix, 
                    Died_from_HIV_calib, Infected_off_ART_calib, On_ART_calib) %>%
      dplyr::summarise_all(list(median=median))

disability.tibble <- m3 %>%
  dplyr::group_by(Year_Integer, scenario_name, sim.ix) %>%
  dplyr::summarize(
    infected_untreated = sum(Infected_off_ART_calib_median),
    on_art = sum(On_ART_calib_median)
    ) %>%
  dplyr::rename(year = Year_Integer)

m4 <- m3 %>% mutate(year_applied = Year_Integer - (Age - (life_expectancy + 1)))


daly.tibble <- merge(
  tibble(scenario_name_ = scenario_names),
  tibble(
    year = seq(min(m4$Year_Integer), max(m4$Year_Integer))
  ),
  all = TRUE
) %>% 
  merge(  tibble(sim.ix = seq(1,10)), all=TRUE)

daly_expanded <- tibble(
    year = seq(min(m4$Year_Integer), max(m4$Year_Integer))
  ) %>% 
  crossing(
    sim.ix = unique(m4$sim.ix),
    scenario_name = unique(m4$scenario_name)
  )

yll <- daly_expanded %>%
  left_join(m4, by = c("sim.ix", "scenario_name")) %>%
  filter(Year_Integer <= year, year_applied > year) %>%
  group_by(year, sim.ix, scenario_name) %>%
  summarize(
    yll = sum(Died_from_HIV_calib_median, na.rm = TRUE),
    .groups = "drop"
  )

daly = left_join(
  yll, 
  disability.tibble, 
  by=c("year", "sim.ix", "scenario_name")
  ) %>%
 replace(is.na(.), 0)

discount_percent = 0.03
discount_start_year = 2025
infected_weight = 0.274
art_weight = 0.078

daly <- daly %>% mutate(daly = infected_untreated*infected_weight + on_art*art_weight + yll)
daly <- daly %>% mutate(discount_factor = (1 - discount_percent)^(year - discount_start_year) )
daly[daly$year < discount_start_year,'discount_factor'] <- 1.0
daly <- daly %>% mutate(daly_future_discounted = daly*discount_factor )

daly
```


#### HIV DALYs averted

```{r}
HIV.DALYs.averted <- daly %>% 
  filter(year >= 2025) %>% 
  group_by(sim.ix, scenario_name) %>% 
  summarize(HIV.DALY = sum(daly_future_discounted),
            .groups = 'drop_last')

HIV.DALYs.averted <- HIV.DALYs.averted %>% 
  merge(
    HIV.DALYs.averted %>% 
      filter(scenario_name == 'baseline') %>% 
      select(sim.ix, HIV.DALY.baseline = HIV.DALY),
    by = c("sim.ix")
  ) %>% 
  mutate(HIV.DALY.averted = HIV.DALY.baseline - HIV.DALY)

HIV.DALYs.averted
```

```{r}
HIV.DALYs.averted.CI <- data.table()

for (i in scenario_names){
  h <- calculate.CI.by.metric(
    data = HIV.DALYs.averted,
    scenario.name = i,
    metric = "HIV.DALY"
  )
  
  HIV.DALYs.averted.CI = rbind(HIV.DALYs.averted.CI, h)
}

for (i in scenario_names){
  h <- calculate.CI.by.metric(
    data = HIV.DALYs.averted,
    scenario.name = i,
    metric = "HIV.DALY.averted"
  )
  
  HIV.DALYs.averted.CI = rbind(HIV.DALYs.averted.CI, h)
}

HIV.DALYs.averted.CI
```


### Depression-related DALYs

```{r}
Depression.DALYs <- daly.results.treatment %>% 
  filter(IP_Key.CMDStatus == "CMD_pos") %>% 
  mutate(Year_Integer = floor(Year-0.5)) %>% 
  group_by(Year_Integer, sim.ix, scenario_name) %>% 
  summarize(Depressed = sum(Population * pop_scaling_factor), .groups = 'drop_last') %>% 
  ungroup()

Depression.DALYs <- Depression.DALYs %>% 
  mutate(discount_factor = (1 - 0.03)^(pmax(Year_Integer - 2025, 0)) ) %>% 
  mutate(Depression.YLD = Depressed/2) %>% 
  mutate(Depression.DALY = 0.396*Depression.YLD*discount_factor/2)

Depression.DALYs.averted <- Depression.DALYs %>% 
  filter(Year_Integer >= 2025) %>% 
  group_by(sim.ix, scenario_name) %>% 
  summarize(Depression.DALY = sum(Depression.DALY), .groups = 'drop_last') %>% 
  merge(
    Depression.DALYs %>% 
      filter(Year_Integer >= 2025, scenario_name == "baseline") %>% 
      group_by(sim.ix) %>% 
      summarize(Depression.DALY.baseline = sum(Depression.DALY)),
    by = c("sim.ix")
  ) %>% 
  mutate(
    Depression.DALY.averted = Depression.DALY.baseline - Depression.DALY
  )

Depression.DALYs.averted
```

```{r}
Depression.DALYs.averted.CI <- data.frame()

for (i in scenario_names){
  h <- calculate.CI.by.metric(
    data = Depression.DALYs.averted,
    scenario.name = i,
    metric = "Depression.DALY"
  )
  
  Depression.DALYs.averted.CI = rbind(Depression.DALYs.averted.CI, h)
}

for (i in scenario_names){
  h <- calculate.CI.by.metric(
    data = Depression.DALYs.averted,
    scenario.name = i,
    metric = "Depression.DALY.averted"
  )
  
  Depression.DALYs.averted.CI = rbind(Depression.DALYs.averted.CI, h)
}

Depression.DALYs.averted.CI
```


## Calculate ICERs

### Count number of depression treatments

Also calculate error bars on this because why not

```{r}
cmdtreat.count <- daly.results.treatment %>% 
  mutate(Year = floor(Year)) %>% 
  filter(Year >= 2025) %>% 
  group_by(scenario_name, sim.ix) %>% 
  summarize(CMD_Treat = sum(CMD_Treat_staging*pop_scaling_factor), .groups = 'drop_last')

#cmdtreat.count

CMD.Treatment.CI <- data.frame()

for (i in scenario_names){
  h <- calculate.CI.by.metric(
    data = cmdtreat.count,
    scenario.name = i,
    metric = "CMD_Treat"
  )
  
  CMD.Treatment.CI = rbind(CMD.Treatment.CI, h)
}

CMD.Treatment.CI
```


### ICER calculations


```{r}
ICER.calculation <- merge(
  HIV.DALYs.averted,
  daly.results.treatment %>% 
    mutate(Year = floor(Year)) %>% 
    filter(Year >= 2025) %>%
    group_by(sim.ix, scenario_name) %>% 
    summarize(CMD_Treatment = sum(CMD_Treat_staging*pop_scaling_factor*14), .groups = 'drop_last'),
  by = c("sim.ix", "scenario_name")
) %>% 
  mutate(ICER = case_when(
    HIV.DALY.averted != 0 ~ CMD_Treatment/HIV.DALY.averted,
    HIV.DALY.averted == 0 ~ 0))

ICER.calculation
```

```{r}
ICER.calculation %>% 
  group_by(scenario_name) %>% 
  summarize(HIV.DALY.averted = mean(HIV.DALY.averted),
            CMD_Treatment = mean(CMD_Treatment)) %>% 
  mutate(ICER = CMD_Treatment/HIV.DALY.averted)
```

```{r}
cmdtreat.count <- daly.results.treatment %>% 
  mutate(Year = floor(Year)) %>% 
  filter(Year >= 2025) %>% 
  group_by(Year, scenario_name, sim.ix) %>% 
  summarize(CMD_Treat = sum(CMD_Treat_staging*pop_scaling_factor), .groups = 'drop_last')

cmdtreat.count %>% group_by(scenario_name) %>% summarize(CMD_Treatment = mean(CMD_Treat)*14)


cmdtreat.count %>% filter(scenario_name == 'art', sim.ix == 1)
```



## Save your work

```{r}
impact.DALYs.averted <- rbind(
  HIV.DALYs.averted.CI, 
  Depression.DALYs.averted.CI, 
  CMD.Treatment.CI
  )

write_csv(
  rbind(impact.DALYs.averted),
  file = "impact_DALY_calculated.csv"
)

#impact.DALYs.averted <- read_csv("impact_DALY_calculated.csv")
```

## Load work
```{r}

impact.DALYs.averted <- read_csv("impact_DALY_calculated.csv")

HIV.Depression.Averted.Data <- read_csv( "impact_HIV_Depression_averted.csv")

```


# Figure: Impact

```{r}
HIV.Depression.Averted.Data.temp <- HIV.Depression.Averted.Data %>% 
  filter(scenario_name %in% c("art","uni", "neutral.annual", "art.ceta")) %>% 
  filter(metric %in% c("Died_from_HIV.averted.pct", 
                       "Newly.Infected.averted.pct",
                       "Depression.episodes.averted.pct")) %>% 
    mutate(scenario_ix = case_match(scenario_name, 
                                    "uni" ~ 4,
                                    "neutral.annual" ~ 3,
                                    "art" ~ 2,
                                    "art.ceta" ~ 1
                                    )
  )
HIV.Depression.Averted.Data.temp$scenario_ix = factor(HIV.Depression.Averted.Data.temp$scenario_ix, levels = c(1,2,3,4))

HIV.Depression.Averted.Data.temp <- HIV.Depression.Averted.Data.temp[order(HIV.Depression.Averted.Data.temp$metric, HIV.Depression.Averted.Data.temp$scenario_ix), ]

plot.averted <- HIV.Depression.Averted.Data.temp %>% 
  ggplot() +
  # geom_bar(mapping = aes(x = metric, y = metric.mean*100, fill = factor(scenario_name)),
  #          position=position_dodge2(reverse = TRUE, padding = 0), 
  #          stat = "identity",
  #          show.legend = TRUE) + 
  # geom_errorbar(mapping = aes(x = metric, 
  #                             ymin = metric.lb*99.5, ymax = metric.ub*100),
  #               position=position_dodge2(reverse = TRUE, padding = .25), 
  #               stat = "identity",
  #               size = 1, color = "black",
  #               show.legend = FALSE) + 
  
  geom_bar(mapping = aes(x = metric, y = metric.mean * 100, fill = as.factor(scenario_ix)),
           position = position_dodge2(reverse = TRUE, padding = 0), 
           stat = "identity",
           show.legend = TRUE) + 
  geom_errorbar(mapping = aes(x = metric, 
                              ymin = metric.lb * 99.5, ymax = metric.ub * 100,
                              group = as.factor(scenario_ix)),
                position = position_dodge2(reverse = TRUE, padding = .25), 
                stat = "identity",
                size = 1, color = "black",
                show.legend = FALSE) + 

  scale_y_continuous(breaks = seq(0,20,5), 
                     labels = c("0%", "5%", "10%", "15%", "20%"), 
                     expand = expansion(mult = c(0.00,.1))) +
  scale_fill_manual("", values = c("#00671F", "#FF6600", "#0004E7", "red", "purple"),
                    breaks = c("1", "2", "3", "4", "art.neutral"), 
                    labels = c("Universal", "HIV Testing   ", "ART", "CETA", "ART & HIV Testing")) + 
  scale_x_discrete(
    breaks=c("Depression.episodes.averted.pct",
             "Died_from_HIV.averted.pct", 
             "Newly.Infected.averted.pct"),
    labels=c("Depression Episodes\nAverted",
             "HIV Deaths\nAverted", 
             "HIV Infections\nAverted")) + 
  theme_minimal() + theme_bw() +
  theme(panel.grid = element_blank(),
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        #axis.text.x = element_blank(),
        legend.position = "top")

plot.averted
```


# Figure: Efficiency frontier

```{r}
impact.pivot <- impact.DALYs.averted %>% 
  filter(scenario_name %in% c("baseline", "art", "uni", "art.ceta", "neutral.annual") ) %>% 
  filter(metric %in% c("HIV.DALY.averted", "Depression.DALY.averted", "CMD_Treat")) %>%
  # mutate(scenario_id = case_match(
  #   scenario_name, 
  #   "baseline" ~ "", "uni" ~ "Universal", 
  #   "neutral.annual" ~ "HIV Testing", 
  #   "art" ~ "ART",
  #   "art.ceta" ~ "CETA",
  #   "art.neutral" ~ "ART & HIV Testing")) %>% 
  pivot_wider(
    id_cols = scenario_name,
    names_from = metric,
    values_from = c("metric.mean", "metric.lb", "metric.ub")
  )

plot.HIV.ICER <-  ggplot() + 
  geom_errorbar(
    data = impact.pivot %>% filter(scenario_name != 'baseline'),
    mapping = aes(x = metric.mean_CMD_Treat*14/1e6,
                  ymin = metric.lb_HIV.DALY.averted, 
                  ymax = metric.ub_HIV.DALY.averted),
    width = 2
    ) +
  geom_line(
    data = impact.pivot %>% 
      filter(scenario_name %in% c("baseline", "art.ceta", "art", "uni")),
    mapping = aes(x = metric.mean_CMD_Treat*14/1e6, 
                  y = metric.mean_HIV.DALY.averted)) + 
  geom_point(
    data = impact.pivot,
    mapping = aes(
      x = metric.mean_CMD_Treat*14/1e6,
      y = metric.mean_HIV.DALY.averted,
      color = scenario_name), 
    show.legend = FALSE, size = 3) + 
  scale_color_manual("", values = c("black", "#0004E7", "#800080", "#2EC129", "#FF6600", "purple"),
                    breaks = c("baseline",  "uni", "neutral.annual", "art", "art.ceta", "art.neutral"), 
                    labels = c("Baseline", "Universal", "HIV Testing   ", "ART", "CETA", "ART & HIV Testing")) + 
  scale_x_continuous("Incremental Cost (Million USD)", expand = expansion(mult = c(0.01,.1))) + 
  scale_y_continuous("Incremental HIV-Related DALYs", 
                     breaks = c(0, 10000, 20000, 30000),
                     labels = c("0", "10,000", "20,000", "30,000"),
                     expand = expansion(mult = c(0.01,.1))) + 
  theme_minimal() + theme_bw() +
  theme(panel.grid = element_blank(),
        #axis.title.x = element_blank(),
        #axis.text.x = element_blank(),
        plot.title = element_text(hjust = 0.5),
        text = element_text(family = "sans"))

plot.HIV.ICER 
```

```{r}
plot.HIV.ICER %>% 
  ggsave(filename = "IAS_efficiency_frontier_plot.pdf", width = 6, height = 4, unit = 'in')
```
## Figure: Efficiency frontier for HIV + Depression

```{r}
plot.HIV.DEP.ICER <- ggplot() + 
  geom_errorbar(
    data = impact.pivot %>% filter(scenario_name != 'baseline') %>% 
      mutate(lb = (metric.mean_HIV.DALY.averted+ metric.mean_Depression.DALY.averted) - 2e4,
             ub = (metric.mean_HIV.DALY.averted+ metric.mean_Depression.DALY.averted) + 2e4),
    mapping = aes(x = metric.mean_CMD_Treat*14/1e6,
                  ymin = lb,
                  ymax = ub),
    width = 2
    ) +
  geom_line(
    data = impact.pivot %>% 
      filter(scenario_name %in% c("baseline", "art.ceta", "art", "uni")),
    mapping = aes(x = metric.mean_CMD_Treat*14/1e6, 
                  y = metric.mean_Depression.DALY.averted + metric.mean_HIV.DALY.averted)) + 
  geom_point(
    data = impact.pivot,
    mapping = aes(
      x = metric.mean_CMD_Treat*14/1e6,
      y = metric.mean_HIV.DALY.averted+ metric.mean_Depression.DALY.averted,
      color = scenario_name), 
    show.legend = FALSE, size = 3) + 
  scale_color_manual("", values = c("black", "#0004E7", "#800080", "#2EC129", "#FF6600", "purple"),
                    breaks = c("baseline",  "uni", "neutral.annual", "art", "art.ceta", "art.neutral"), 
                    labels = c("Baseline", "Universal", "HIV Testing   ", "ART", "CETA", "ART & HIV Testing")) + 
  scale_x_continuous("Incremental Cost (Million USD)", expand = expansion(mult = c(0.01,.1))) + 
  scale_y_continuous("Incremental Total DALYs", 
                     breaks = c(0, 100000, 200000, 300000, 400000),
                     labels = c("0", "100,000", "200,000", "300,000", "400,000"),
                     expand = expansion(mult = c(0.01,.1))) + 
  theme_minimal() + theme_bw() +
  theme(panel.grid = element_blank(),
        #axis.title.x = element_blank(),
        #axis.text.x = element_blank(),
        plot.title = element_text(hjust = 0.5),
        text = element_text(family = "sans"))

plot.HIV.DEP.ICER
```

```{r}
plot.HIV.DEP.ICER %>% 
  ggsave(filename = "IAS_efficiency_frontier_plot_total.pdf", width = 6, height = 4, unit = 'in')
```

## ICER

```{r}
impact.pivot %>% 
  mutate(ICER = metric.mean_CMD_Treat*14/metric.mean_HIV.DALY.averted,
         ICER.lb = metric.mean_CMD_Treat*14/metric.lb_HIV.DALY.averted,
         ICER.ub = metric.mean_CMD_Treat*14/metric.ub_HIV.DALY.averted) %>% 
  dplyr::select(scenario_name, ICER, ICER.lb, ICER.ub)
```

```{r}
impact.pivot
```

```{r}
ICER.calculation %>% 
  group_by(scenario_name) %>% 
  summarize(HIV.DALY.averted = mean(HIV.DALY.averted),
            CMD_Treatment = mean(CMD_Treatment)) %>% 
  mutate(ICER = CMD_Treatment/HIV.DALY.averted)
```

