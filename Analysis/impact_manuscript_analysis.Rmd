---
title: "impact_manuscript_analysis"
output: html_document
date: "2024-12-12"
---

# Introduction

The purpose of this notebook is exploratory analysis for the upcoming impact of
depression treatment on HIV outcomes manuscript

# Libraries

```{r Load Libraries, echo = FALSE}
library(tidyverse)
library(data.table)
library(magrittr)
library(rsample)
library(readxl)
library(devtools)
library(ggpubr)
library(patchwork)

devtools::install_github("BershteynLab/EMODAnalyzeR", force = TRUE)
```

# Checking results

There was a strange error with distribution in the status neutral HIV scenario, 
conducted in October of 2024 in preparation for the now-rejected CROI 2025 abstract.

Somehow, status neutral depression care wasn't being distributed at the expected scale.

Let's first compare and contract the two ways that distribution occurred:

## Baseline

```{r}
#experiment.path = "/gpfs/scratch/citrod01/experiments/MATUMAINI/CROI2025/Baseline-campaign_MATUMAINI_202305-baseline___2024_09_23_12_05_01_062691"
experiment.path = "/gpfs/scratch/citrod01/experiments/MATUMAINI/CROI2025/Baseline-campaign_MATUMAINI_202305-baseline___2024_09_23_17_43_09_994878"
sim.results.baseline <- EMODAnalyzeR::read.simulation.results.bigpurple(
  experiment_path = experiment.path,
  scenario_name = "baseline",
    summarize_columns = c("Population","Infected", "On_ART",
                        "Died", "Died_from_HIV",
                        "Newly.Infected","Diagnosed"),
  stratify_columns = c("Year", "Genderf", "Age", "IP_Key.CMDStatus", "CMD_Treat_staging", "CMD_Treat"),
  min_age_inclusive = 0,
  max_age_inclusive = 99
)
```


## "Initial"

This is the one that I tried that seemed incorrect

The way that Status Neutral depression care was distributed was 

```{r}
experiment.path <- "/gpfs/scratch/citrod01/experiments/MATUMAINI/CROI2025/Baseline-campaign_MATUMAINI_202305_neutral-neutral___2024_09_23_17_38_27_681705"

sim.results.neutral.initial <- EMODAnalyzeR::read.simulation.results.bigpurple(
  experiment_path = experiment.path,
  scenario_name = "neutral",
    summarize_columns = c("Population","Infected", "On_ART",
                        "Died", "Died_from_HIV",
                        "Newly.Infected","Diagnosed"),
  stratify_columns = c("Year", "Gender", "Age", "IP_Key.CMDStatus", "CMD_Treat_staging", "CMD_Treat"),
  min_age_inclusive = 0,
  max_age_inclusive = 99
)
```


## "Final"

This is the one that ended up in the abstract. 

The way that Status Neutral depression care was distributed was 
```{r}
experiment.path <- "/gpfs/scratch/citrod01/experiments/MATUMAINI/CROI2025/Baseline-campaign_MATUMAINI_202305_neutral-neutral___2024_09_25_15_55_29_591219"

sim.results.neutral.final <- EMODAnalyzeR::read.simulation.results.bigpurple(
  experiment_path = experiment.path,
  scenario_name = "final",
    summarize_columns = c("Population","Infected", "On_ART",
                        "Died", "Died_from_HIV",
                        "Newly.Infected","Diagnosed"),
  stratify_columns = c("Year", "Gender", "Age", "IP_Key.CMDStatus", "CMD_Treat_staging", "CMD_Treat"),
  min_age_inclusive = 0,
  max_age_inclusive = 99
)
```

## 

```{r}
sim.results.all <- rbind(sim.results.neutral.initial, sim.results.neutral.final, sim.results.baseline)

CENSUS_YEAR = 2009
KEN_CENSUS_POP = 5352385

sim.results.pop.scaling <- sim.results.all %>%
      filter(Year == CENSUS_YEAR) %>%
      group_by(sim.ix, scenario_name) %>%
      summarize(total.pop = sum(Population), .groups = 'keep') %>%
      mutate(pop.scaling.factor = KEN_CENSUS_POP/total.pop)

sim.results.all <- sim.results.all %>%
  inner_join(
    sim.results.pop.scaling,
    by = c("sim.ix", "scenario_name")
  )
```

## Analyze.

### CMD_Treat over time
```{r}
cmdtreat.count <- sim.results.all %>% 
  filter(Year >= 2020) %>% 
  group_by(Year, Gender, scenario_name, sim.ix) %>% 
  summarize(CMD_Treat = sum(CMD_Treat), .groups = 'drop_last') %>% 
  group_by(Year, Gender, scenario_name) %>% 
  summarize(CMD_Treat = mean(CMD_Treat), .groups = 'drop_last')


cmdtreat.count %>% 
  ggplot() + 
  geom_line(mapping = aes(x = Year, y = CMD_Treat, color = scenario_name)) + 
  facet_grid(cols = vars(Gender))
            

```
## How many people are living with HIV, CMD in 2025?
```{r}
sim.results.all %>% 
  filter(Year == 2025, Age >= 15) %>% 
  group_by(Gender, scenario_name, sim.ix) %>% 
  summarize(Infected = sum(Infected * pop.scaling.factor)) %>% 
  group_by(Gender,scenario_name) %>% 
  summarize(Infected = mean(Infected)) %>%
  pivot_wider(id_cols = c("scenario_name"), values_from = c("Infected"), names_from = c("Gender"),
              names_prefix = "Infected_") %>% 
  mutate(Infected = Infected_0 + Infected_1)
```

```{r}
sim.results.all %>% 
  filter(Year == 2025, Age >= 15) %>% 
  filter(IP_Key.CMDStatus == "CMD_pos") %>% 
  group_by(Gender, scenario_name, sim.ix) %>% 
  summarize(Population = sum(Population * pop.scaling.factor)) %>% 
  group_by(Gender,scenario_name) %>% 
  summarize(Population = mean(Population)) %>%
  pivot_wider(id_cols = c("scenario_name"), values_from = c("Population"), names_from = c("Gender"),
              names_prefix = "Depressed_") %>% 
  mutate(Depressed = Depressed_0 + Depressed_1)
```

```{r}
sim.results.all %>% 
  filter(Year == 2025, Age >= 15) %>% 
  filter(IP_Key.CMDStatus == "CMD_pos") %>% 
  group_by(Gender, scenario_name, sim.ix) %>% 
  summarize(Infected = sum(Infected * pop.scaling.factor)) %>% 
  group_by(Gender,scenario_name) %>% 
  summarize(Infected = mean(Infected)) %>%
  pivot_wider(id_cols = c("scenario_name"), values_from = c("Infected"), names_from = c("Gender"),
              names_prefix = "Infected_") %>% 
  mutate(Infected = Infected_0 + Infected_1)
```

### Impact calculations

```{r}
bt_mean <- function(splits, colname){
  x <- as.data.frame(analysis(splits))
  mean(x[[colname]])
}

# Deaths and Infections
bt_resamples <- bootstraps(hiv.averted.data.scatter %>% filter(scenario_name == "final"), times = 500)

bt_resamples$mean.infected <- map_dbl(bt_resamples$splits, bt_mean, "Newly.Infected_averted")
bt_resamples$mean.infected.pct <- map_dbl(bt_resamples$splits, bt_mean, "Newly.Infected_averted.pct")
bt_resamples$mean.deaths<- map_dbl(bt_resamples$splits, bt_mean, "Died_from_HIV_averted")
bt_resamples$mean.deaths.pct <- map_dbl(bt_resamples$splits, bt_mean, "Died_from_HIV_averted.pct")

infected_95 <- quantile(bt_resamples$mean.infected, probs = c(.025, .975))
deaths_95 <- quantile(bt_resamples$mean.deaths, probs = c(.025, .975))
infected.pct_95 <- quantile(bt_resamples$mean.infected.pct, probs = c(.025, .975))
deaths.pct_95 <- quantile(bt_resamples$mean.deaths.pct, probs = c(.025, .975))

all.stats[all.stats$scenario_name == "final",]$Newly.Infected_averted.lb = infected_95[[1]]
all.stats[all.stats$scenario_name == "final",]$Newly.Infected_averted.ub = infected_95[[2]]
all.stats[all.stats$scenario_name == "final",]$Newly.Infected_averted.pct.lb = infected.pct_95[[1]]
all.stats[all.stats$scenario_name == "final",]$Newly.Infected_averted.pct.ub = infected.pct_95[[2]]

all.stats[all.stats$scenario_name == "final",]$Died_from_HIV_averted.lb = deaths_95[[1]]
all.stats[all.stats$scenario_name == "final",]$Died_from_HIV_averted.ub = deaths_95[[2]]
all.stats[all.stats$scenario_name == "final",]$Died_from_HIV_averted.pct.lb = deaths.pct_95[[1]]
all.stats[all.stats$scenario_name == "final",]$Died_from_HIV_averted.pct.ub = deaths.pct_95[[2]]

bt_resamples <- bootstraps(hiv.averted.data.scatter %>% filter(scenario_name == "neutral"), times = 500)

bt_resamples$mean.infected <- map_dbl(bt_resamples$splits, bt_mean, "Newly.Infected_averted")
bt_resamples$mean.infected.pct <- map_dbl(bt_resamples$splits, bt_mean, "Newly.Infected_averted.pct")
bt_resamples$mean.deaths<- map_dbl(bt_resamples$splits, bt_mean, "Died_from_HIV_averted")
bt_resamples$mean.deaths.pct <- map_dbl(bt_resamples$splits, bt_mean, "Died_from_HIV_averted.pct")

infected_95 <- quantile(bt_resamples$mean.infected, probs = c(.025, .975))
deaths_95 <- quantile(bt_resamples$mean.deaths, probs = c(.025, .975))
infected.pct_95 <- quantile(bt_resamples$mean.infected.pct, probs = c(.025, .975))
deaths.pct_95 <- quantile(bt_resamples$mean.deaths.pct, probs = c(.025, .975))

all.stats[all.stats$scenario_name == "neutral",]$Newly.Infected_averted.lb = infected_95[[1]]
all.stats[all.stats$scenario_name == "neutral",]$Newly.Infected_averted.ub = infected_95[[2]]
all.stats[all.stats$scenario_name == "neutral",]$Newly.Infected_averted.pct.lb = infected.pct_95[[1]]
all.stats[all.stats$scenario_name == "neutral",]$Newly.Infected_averted.pct.ub = infected.pct_95[[2]]

all.stats[all.stats$scenario_name == "neutral",]$Died_from_HIV_averted.lb = deaths_95[[1]]
all.stats[all.stats$scenario_name == "neutral",]$Died_from_HIV_averted.ub = deaths_95[[2]]
all.stats[all.stats$scenario_name == "neutral",]$Died_from_HIV_averted.pct.lb = deaths.pct_95[[1]]
all.stats[all.stats$scenario_name == "neutral",]$Died_from_HIV_averted.pct.ub = deaths.pct_95[[2]]

# cmd
bt_resamples <- bootstraps(cmd.treat.data.scatter %>% filter(scenario_name == "final"), times = 500)
bt_resamples$mean.cmd <- map_dbl(bt_resamples$splits, bt_mean, "CMD_Treat")
cmd_95 <- quantile(bt_resamples$mean.cmd, probs = c(.025, .975))
all.stats[all.stats$scenario_name == "final",]$CMD_Treat.lb = cmd_95[[1]]
all.stats[all.stats$scenario_name == "final",]$CMD_Treat.ub = cmd_95[[2]]

bt_resamples <- bootstraps(cmd.treat.data.scatter %>% filter(scenario_name == "neutral"), times = 500)
bt_resamples$mean.cmd <- map_dbl(bt_resamples$splits, bt_mean, "CMD_Treat")
cmd_95 <- quantile(bt_resamples$mean.cmd, probs = c(.025, .975))
all.stats[all.stats$scenario_name == "neutral",]$CMD_Treat.lb = cmd_95[[1]]
all.stats[all.stats$scenario_name == "neutral",]$CMD_Treat.ub = cmd_95[[2]]

all.stats
```

### Impact of treatment

```{r}
p <- all.stats %>% 
  mutate(scenario_ix = case_match(scenario_name, "baseline" ~ 0, "final" ~ 1, "neutral" ~ 2)) %>% 
  select(scenario_ix,scenario_name, Depression_averted.pct) %>% 
  filter(scenario_name %in% c("uni", "neutral", "art")) %>% 
  pivot_longer(cols = c(Depression_averted.pct), names_to = "metric") %>% 
  ggplot() +
  geom_bar(mapping = aes(x = metric, y = value*100, fill = factor(scenario_name)),
           position=position_dodge2(reverse = TRUE, padding = 0), stat = "identity") + 
  scale_y_continuous(breaks = seq(0,50,10), labels = c("0%", "10%", "20%", "30%", "40%","50%"), expand = expansion(mult = c(0.00,.1))) +
  scale_fill_manual("", values = c("#00671F", "#FF6600", "#0004E7"),
                    breaks = c("baseline", "final", "neutral"), 
                    labels = c("baseline", "final   ", "neutral")) + 
  scale_x_discrete(breaks=c("Depression_averted.pct"),
                   labels=c("Depression Episodes")) + 
  theme_minimal() + theme_bw() +
  theme(panel.grid = element_blank(),
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        axis.text.x = element_blank(),
        legend.position = "top")
# + 
#   guides(fill=guide_legend("Depression Treatment Distribution"))

all.stats.plot <- all.stats %>% 
  mutate(scenario_ix = case_match(scenario_name, "baseline" ~ 0, "final" ~ 1, "neutral" ~ 2)) %>% 
  select(scenario_ix,scenario_name, Newly.Infected_averted.pct, Died_from_HIV_averted.pct) %>% 
  filter(scenario_name %in% c("baseline", "final", "neutral")) %>% 
  pivot_longer(cols = c(Newly.Infected_averted.pct, Died_from_HIV_averted.pct), names_to = "metric", values_to = "mean") %>% 
  merge(
    all.stats %>% 
      mutate(scenario_ix = case_match(scenario_name, "baseline" ~ 0, "final" ~ 1, "neutral" ~ 2)) %>% 
      select(scenario_ix,scenario_name, Newly.Infected_averted.pct.lb, Died_from_HIV_averted.pct.lb) %>% 
  filter(scenario_name %in% c("baseline", "final", "neutral")) %>% 
      mutate(Newly.Infected_averted.pct = Newly.Infected_averted.pct.lb,
             Died_from_HIV_averted.pct = Died_from_HIV_averted.pct.lb) %>% 
      select(scenario_ix, scenario_name, Newly.Infected_averted.pct,Died_from_HIV_averted.pct) %>% 
      pivot_longer(cols = c(Newly.Infected_averted.pct, Died_from_HIV_averted.pct), names_to = "metric", values_to =  "lb"),
    by = c("scenario_ix", "scenario_name", "metric")
  ) %>% 
  merge(
    all.stats %>% 
      mutate(scenario_ix = case_match(scenario_name, "baseline" ~ 0, "final" ~ 1, "neutral" ~ 2)) %>% 
      select(scenario_ix,scenario_name, Newly.Infected_averted.pct.ub, Died_from_HIV_averted.pct.ub) %>% 
      filter(scenario_name %in% c("baseline", "final", "neutral")) %>% 
      mutate(Newly.Infected_averted.pct = Newly.Infected_averted.pct.ub,
             Died_from_HIV_averted.pct = Died_from_HIV_averted.pct.ub) %>% 
      select(scenario_ix, scenario_name, Newly.Infected_averted.pct,Died_from_HIV_averted.pct) %>% 
      pivot_longer(cols = c(Newly.Infected_averted.pct, Died_from_HIV_averted.pct), names_to = "metric", values_to =  "ub"),
    by = c("scenario_ix", "scenario_name", "metric")
  ) 


p1 <- all.stats.plot %>% 
  ggplot() +
  geom_bar(mapping = aes(x = metric, y = mean*100, fill = factor(scenario_name)),
           position=position_dodge2(reverse = TRUE, padding = 0), stat = "identity",
           show.legend = FALSE) + 
  geom_errorbar(mapping = aes(x = metric, ymin = lb*100, ymax = ub*100),
                position=position_dodge2(reverse = TRUE, padding = .25), stat = "identity",
                size = 1, color = "black",
                show.legend = FALSE) + 
  #geom_label(mapping = aes(x = metric, y = value*100, label = metric)) + 
  #geom_text(mapping = aes(x = 1, y = 4.1, label = "HIV Deaths Averted")) + 
  #geom_text(mapping = aes(x = 2, y = 7, label = "HIV Infections Averted")) + 
  scale_y_continuous(
    "% Averted",
    breaks = seq(0,10,2), 
    labels = c("0%", "2%", "4%", "6%", "8%","10%"), 
    expand = expansion(mult = c(0.00,.2))) +
  scale_fill_manual("", values = c("#00671F", "#FF6600", "#0004E7"),
                    breaks = c("baseline", "final", "neutral"), 
                    labels = c("baseline", "final   ", "neutral")) + 
  scale_x_discrete( 
    breaks=c("Newly.Infected_averted.pct", "Died_from_HIV_averted.pct"),
    labels=c("HIV Infections", "HIV Deaths"),
      expand = expansion(mult = c(.6,.6))) +
  #ggtitle("HIV Outcome Improvements\nvs. Depression Treatment Strategy") + 
  theme_minimal() + theme_bw() +
  theme(panel.grid = element_blank(),
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        axis.text.x = element_blank(),
        legend.position = "bottom",
        plot.title = element_text(hjust = 0.5),
        text = element_text(family = "sans"))

p1 
# + 
#   guides(fill=guide_legend("Depression Treatment Distribution"))
```


