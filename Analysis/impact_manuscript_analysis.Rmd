---
title: "impact_manuscript_analysis"
output: html_document
date: "2024-12-12"
---

# Introduction

The purpose of this notebook is exploratory analysis for the upcoming impact of
depression treatment on HIV outcomes manuscript

# Libraries

```{r Load Libraries, echo = FALSE}
library(tidyverse)
library(data.table)
library(magrittr)
library(rsample)
library(readxl)
library(devtools)
library(ggpubr)
library(patchwork)

devtools::install_github("BershteynLab/EMODAnalyzeR", force = TRUE)
```

```{r}
# Confidence interval functions
lower_ci <- function(mean, se, n, conf_level = 0.95){
  lower_ci <- mean - qt(1 - ((1 - conf_level) / 2), n - 1) * se
  return(lower_ci)
}
upper_ci <- function(mean, se, n, conf_level = 0.95){
  upper_ci <- mean + qt(1 - ((1 - conf_level) / 2), n - 1) * se
  return(upper_ci)
}
```

# 


# Checking results

* 2025-01-27 - As of today, checking the EMOD results will refer to the shorter "summary" simulations that were completed in order to analyze which age groups were receiving depression treatment, without being so unwieldy (ie, stratifying by single-year ages) that it fills up memory and I can't actually work. I can also use this to figure out the right base population scale factors.

## Baseline

```{r}
#experiment.path = "/gpfs/scratch/citrod01/experiments/MATUMAINI/CROI2025/Baseline-campaign_MATUMAINI_202305-baseline___2024_09_23_12_05_01_062691"
#experiment.path = "/gpfs/scratch/citrod01/experiments/MATUMAINI/CROI2025/Baseline-campaign_MATUMAINI_202305-baseline___2024_09_23_17_43_09_994878"
experiment.path = "/gpfs/scratch/citrod01/experiments/MATUMAINI/CROI2025/Baseline-campaign_MATUMAINI_202305-summary_baseline___2025_01_27_16_35_54_645520"

sim.results.baseline <- EMODAnalyzeR::read.simulation.results.bigpurple(
  experiment_path = experiment.path,
  scenario_name = "baseline",
    summarize_columns = c("Population","Infected", "On_ART",
                        "Died", "Died_from_HIV",
                        "Newly.Infected","Diagnosed"),
  stratify_columns = c("Year", "Gender", "Age", "IP_Key.CMDStatus", "HasHIV",
                       "CMD_Treat_staging", "CMD_Treat"),
  min_age_inclusive = 0,
  max_age_inclusive = 99
)
```

## Universal treatment data
```{r}
#experiment.path = "/gpfs/scratch/citrod01/experiments/MATUMAINI/CRaOI2025/Baseline-campaign_MATUMAINI_202305_uni-uni___2024_09_23_12_26_37_798115"
#experiment.path = "/gpfs/scratch/citrod01/experiments/MATUMAINI/CROI2025/Baseline-campaign_MATUMAINI_202305_uni-uni___2024_09_23_17_35_53_515585"
experiment.path = "/gpfs/scratch/citrod01/experiments/MATUMAINI/CROI2025/Baseline-campaign_MATUMAINI_202305_uni-summary_uni___2025_01_16_10_08_42_557839"

sim.results.uni <- EMODAnalyzeR::read.simulation.results.bigpurple(
  experiment_path = experiment.path,
  scenario_name = "uni",
    summarize_columns = c("Population","Infected", "On_ART",
                        "Died", "Died_from_HIV",
                        "Newly.Infected","Diagnosed"),
  stratify_columns = c("Year", "Gender", "Age", "HasHIV",
                       "IP_Key.CMDStatus", "CMD_Treat_staging", "CMD_Treat"),
  min_age_inclusive = 0,
  max_age_inclusive = 99
)
```

## CMD for all on ART

```{r}
#experiment.path = "/gpfs/scratch/citrod01/experiments/MATUMAINI/CROI2025/Baseline-campaign_MATUMAINI_202305_art-art___2024_12_19_14_55_54_577717"
#experiment.path = "/gpfs/scratch/citrod01/experiments/MATUMAINI/CROI2025/Baseline-campaign_MATUMAINI_202305_art-art___2024_12_24_17_38_15_018856/"
experiment.path <- "/gpfs/scratch/citrod01/experiments/MATUMAINI/CROI2025/Baseline-campaign_MATUMAINI_202305_art-summary_art___2025_01_16_10_06_17_419582"

sim.results.art <- EMODAnalyzeR::read.simulation.results.bigpurple(
  experiment_path = experiment.path,
  scenario_name = "art",
    summarize_columns = c("Population","Infected", "On_ART",
                        "Died", "Died_from_HIV",
                        "Newly.Infected","Diagnosed"),
  stratify_columns = c("Year", "Gender", "Age", "HasHIV",
                       "IP_Key.CMDStatus", "CMD_Treat_staging", "CMD_Treat"),
  min_age_inclusive = 0,
  max_age_inclusive = 99
)
```

## Unsuppressed On ART (CETA) distribution

```{r}
experiment.path = "/gpfs/scratch/citrod01/experiments/MATUMAINI/CROI2025/Baseline-campaign_MATUMAINI_202305_art_ceta-summary_art_ceta___2025_01_16_10_01_21_321482"

sim.results.art.ceta <- EMODAnalyzeR::read.simulation.results.bigpurple(
  experiment_path = experiment.path,
  scenario_name = "art.ceta",
    summarize_columns = c("Population","Infected", "On_ART",
                        "Died", "Died_from_HIV",
                        "Newly.Infected","Diagnosed"),
  stratify_columns = c("Year", "Gender", "Age", "HasHIV", 
                       "IP_Key.CMDStatus", "CMD_Treat_staging", "CMD_Treat"),
  min_age_inclusive = 0,
  max_age_inclusive = 99
)
```


## Status neutral CMD treatment upon HIV test
Deprecated for now; doesn't seem to do much
```{r}
#experiment.path <- "/gpfs/scratch/citrod01/experiments/MATUMAINI/CROI2025/Baseline-campaign_MATUMAINI_202305_neutral_testing-testing___2024_12_18_17_37_10_681523"
# experiment.path <- "/gpfs/scratch/citrod01/experiments/MATUMAINI/CROI2025/Baseline-campaign_MATUMAINI_202305_neutral_testing-testing___2024_12_20_15_52_54_176586"
experiment.path <- "/gpfs/scratch/citrod01/experiments/MATUMAINI/CROI2025/Baseline-campaign_MATUMAINI_202305_neutral_testing-summary_testing___2025_01_28_14_43_29_538096"

sim.results.neutral.testing <- EMODAnalyzeR::read.simulation.results.bigpurple(
  experiment_path = experiment.path,
  scenario_name = "neutral.testing",
    summarize_columns = c("Population","Infected", "On_ART",
                        "Died", "Died_from_HIV",
                        "Newly.Infected","Diagnosed"),
  stratify_columns = c("Year", "Gender", "Age", "HasHIV",
                       "IP_Key.CMDStatus", "CMD_Treat_staging", "CMD_Treat"),
  min_age_inclusive = 0,
  max_age_inclusive = 99
)
```


## Annual Status Neutral CMD treatment 
For all in the HCT Testing Loop

```{r}
#experiment.path <- "/gpfs/scratch/citrod01/experiments/MATUMAINI/CROI2025/Baseline-campaign_MATUMAINI_202305_neutral_annual-annual___2024_12_19_14_52_41_589804"
#experiment.path <- "/gpfs/scratch/citrod01/experiments/MATUMAINI/CROI2025/Baseline-campaign_MATUMAINI_202305_neutral_annual-annual___2024_12_25_12_53_07_907145/"
experiment.path <- "/gpfs/scratch/citrod01/experiments/MATUMAINI/CROI2025/Baseline-campaign_MATUMAINI_202305_art_neutral-summary_art_neutral___2025_01_16_09_58_22_080008"

sim.results.neutral.annual <- EMODAnalyzeR::read.simulation.results.bigpurple(
  experiment_path = experiment.path,
  scenario_name = "neutral.annual",
    summarize_columns = c("Population","Infected", "On_ART",
                        "Died", "Died_from_HIV",
                        "Newly.Infected","Diagnosed"),
  stratify_columns = c("Year", "Gender", "Age", "HasHIV", 
                       "IP_Key.CMDStatus", "CMD_Treat_staging", "CMD_Treat"),
  min_age_inclusive = 0,
  max_age_inclusive = 99
)
```

## Join together

```{r}
sim.results.treatment <- rbind(
  #sim.results.neutral.testing, 
  sim.results.neutral.annual, 
  sim.results.baseline, 
  sim.results.art,
  sim.results.art.ceta,
  sim.results.uni)

CENSUS_YEAR = 2009
KEN_CENSUS_POP = 5352385

# CENSUS_YEAR = 2020
# 6878762

sim.results.pop.scaling <- sim.results.treatment %>%
      filter(Year == CENSUS_YEAR) %>%
      group_by(sim.ix, scenario_name) %>%
      summarize(total.pop = sum(Population), .groups = 'keep') %>%
      mutate(pop_scaling_factor = KEN_CENSUS_POP/total.pop)

# sim.results.all %>% 
#   filter(Year == 2020) %>% 
#   group_by(scenario_name, sim.ix) %>% 
#   summarize(Population = sum(Population*pop_scaling_factor)) %>% 
#   group_by(scenario_name) %>% 
#   summarize(Population = mean(Population))

sim.results.treatment <- sim.results.treatment %>%
  inner_join(
    sim.results.pop.scaling,
    by = c("sim.ix", "scenario_name")
  )
```


### Who is receiving CMD treatment?

Break down treatment delivery by age and sex and HIV status

```{r}
cmd.treat.by.age <- sim.results.treatment %>% 
  mutate(Year = floor(Year)) %>%
  filter(Year >=2020, Age >= 15, IP_Key.CMDStatus == "CMD_pos") %>% 
  group_by(scenario_name, sim.ix, Year, Age, HasHIV) %>% 
  summarize(Population = sum(Population * pop_scaling_factor),
            CMD_Treat_staging = sum(CMD_Treat_staging * pop_scaling_factor), .groups = 'drop_last') %>% 
  group_by(scenario_name, Year, Age, HasHIV) %>% 
  summarize(Population = mean(Population),
            CMD_Treat_Staging = mean(CMD_Treat_staging))

# Percent pop coverage of treatment by age and HIV status and gender
cmd.treat.by.age %>%
  mutate(cov = CMD_Treat_Staging/Population,
         CMD_Treatments = CMD_Treat_Staging) %>% 
  pivot_wider(id_cols = c(Year, Age, HasHIV),
              values_from = c(cov, CMD_Treatments),
              names_from = c(scenario_name, ))  %>% 
  arrange(Age, Year, HasHIV) %>% View


```

How many people are depressed/not depressed by age bracket?
```{r}
plhiv.dep.2020 <-  sim.results.treatment %>% 
  filter(Year == 2020, Age >= 15) %>% 
  group_by(scenario_name, Age, IP_Key.CMDStatus, sim.ix) %>% 
  summarize(Population = sum(Population * pop_scaling_factor),
            Infected = sum(Infected * pop_scaling_factor),
            .groups = 'drop_last') %>% 
  mutate(PLWHIV = Population - Infected) %>% 
  group_by(scenario_name, Age, IP_Key.CMDStatus) %>% 
  summarize(Population = mean(Population),
            PLWHIV = mean(PLWHIV),
            PLHIV = mean(Infected), .groups = 'drop_last') 

sim.results.treatment %>% 
  filter(Year == 2025, Age >= 15) %>% 
  group_by(scenario_name, Age, HasHIV, IP_Key.CMDStatus, sim.ix) %>% 
  summarize(Population = sum(Population * pop_scaling_factor),
            Infected = sum(Infected * pop_scaling_factor),
            .groups = 'drop_last') %>% 
  mutate(PLWHIV = Population - Infected) %>% 
    group_by(scenario_name, Age, HasHIV, IP_Key.CMDStatus) %>%
  summarize(Population = mean(Population),
            .groups = 'drop_last') %>% 
  pivot_wider(
    id_cols = c(scenario_name, Age, HasHIV), 
    values_from = Population,
    names_from = IP_Key.CMDStatus
  ) %>% 
  mutate(
    Population = CMD_neg + CMD_pos + CMD_recovered + CMD_treated,
    CMD_neg = CMD_neg + CMD_recovered + CMD_treated
  ) %>% 
  mutate(CMDprev = CMD_pos/Population) %>% View

```


Compare: where are infections actually happening?

```{r}
sim.results.treatment %>% 
  filter(Year == 2005) %>% 
  group_by(scenario_name, Age, IP_Key.CMDStatus, sim.ix) %>% 
  summarize(Population = sum(Population * pop_scaling_factor), 
            Infected = sum(Infected * pop_scaling_factor),
            Newly.Infected = sum(Newly.Infected * pop_scaling_factor),
            .groups = 'drop_last') %>% 
  group_by(scenario_name, Age, IP_Key.CMDStatus) %>% 
  summarize(
    Population = mean(Population),
    Infected = mean(Infected), 
    Newly.Infected = mean(Newly.Infected), .groups = 'drop_last') %>%
  pivot_wider(
    id_cols = c(scenario_name, Age),
    names_from = c(IP_Key.CMDStatus),
    values_from = c(Population, Infected, Newly.Infected)
  ) %>% 
  mutate(Population_CMD_neg = Population_CMD_neg + Population_CMD_recovered + Population_CMD_treated,
         Infected_CMD_neg = Infected_CMD_neg + Infected_CMD_recovered + Infected_CMD_treated,
         Newly.Infected_CMD_neg = Newly.Infected_CMD_neg + Newly.Infected_CMD_recovered + Newly.Infected_CMD_treated) %>% 
  select(scenario_name, Age,
         Population_CMD_neg, Population_CMD_pos,
         Infected_CMD_neg, Infected_CMD_pos,
         Newly.Infected_CMD_neg, Newly.Infected_CMD_pos) %>% 
  mutate(PLWHIV_CMD_neg = Population_CMD_neg - Infected_CMD_neg,
         PLWHIV_CMD_pos = Population_CMD_pos - Infected_CMD_pos) %>% 
  mutate(Incidence_CMD_neg = Newly.Infected_CMD_neg/PLWHIV_CMD_neg,
         Incidence_CMD_pos = Newly.Infected_CMD_pos/PLWHIV_CMD_pos) %>% 
  arrange(Age, scenario_name) %>% View

```

Incidence by CMD status over time:
```{r}
sim.results.treatment %>% 
  filter(Year >= 2005, Age == 25) %>% 
  group_by(Year, scenario_name, IP_Key.CMDStatus, sim.ix) %>% 
  summarize(Population = sum(Population * pop_scaling_factor), 
            Infected = sum(Infected * pop_scaling_factor),
            Newly.Infected = sum(Newly.Infected * pop_scaling_factor),
            .groups = 'drop_last') %>% 
  group_by(Year, scenario_name, IP_Key.CMDStatus) %>% 
  summarize(
    Population = mean(Population),
    Infected = mean(Infected), 
    Newly.Infected = mean(Newly.Infected), .groups = 'drop_last') %>% 
  pivot_wider(
    id_cols = c(Year, scenario_name),
    values_from = c(Population, Infected, Newly.Infected),
    names_from = IP_Key.CMDStatus
  ) %>% 
  mutate(Population_neg = Population_CMD_neg + Population_CMD_recovered + Population_CMD_treated,
         Infected_neg = Infected_CMD_neg + Infected_CMD_recovered + Infected_CMD_treated,
         Newly.Infected_neg = Newly.Infected_CMD_neg + Newly.Infected_CMD_recovered + Newly.Infected_CMD_treated) %>% 
  select(scenario_name, 
         Population_neg, Population_CMD_pos,
         Infected_neg, Infected_CMD_pos,
         Newly.Infected_neg, Newly.Infected_CMD_pos) %>% 
  mutate(PLWHIV_neg = Population_neg - Infected_neg,
         PLWHIV_pos = Population_CMD_pos - Infected_CMD_pos) %>% 
  mutate(Incidence_neg = Newly.Infected_neg/PLWHIV_neg,
         Incidence_pos = Newly.Infected_CMD_pos/PLWHIV_pos) %>% 
  mutate(rr = Incidence_pos/Incidence_neg) %>% View

```

Who is re

```{r}
sim.results.treatment %>% 
  filter(Year == 2005, Age == 25) %>% 
  group_by(scenario_name, IP_Key.CMDStatus, sim.ix) %>% 
  summarize(Population = sum(Population * pop_scaling_factor), 
            Infected = sum(Infected * pop_scaling_factor),
            Newly.Infected = sum(Newly.Infected * pop_scaling_factor),
            .groups = 'drop_last') %>% 
  group_by(scenario_name, IP_Key.CMDStatus) %>% 
  summarize(
    Population = mean(Population),
    Infected = mean(Infected), 
    Newly.Infected = mean(Newly.Infected), .groups = 'drop_last') %>% 
  pivot_wider(
    id_cols = scenario_name,
    values_from = c(Population, Infected, Newly.Infected),
    names_from = IP_Key.CMDStatus
  ) %>% 
  mutate(Population_neg = Population_CMD_neg + Population_CMD_recovered + Population_CMD_treated,
         Infected_neg = Infected_CMD_neg + Infected_CMD_recovered + Infected_CMD_treated,
         Newly.Infected_neg = Newly.Infected_CMD_neg + Newly.Infected_CMD_recovered + Newly.Infected_CMD_treated) %>% 
  select(scenario_name, 
         Population_neg, Population_CMD_pos,
         Infected_neg, Infected_CMD_pos,
         Newly.Infected_neg, Newly.Infected_CMD_pos) %>% 
  mutate(PLWHIV_neg = Population_neg - Infected_neg,
         PLWHIV_pos = Population_CMD_pos - Infected_CMD_pos) %>% 
  mutate(Incidence_neg = Newly.Infected_neg/PLWHIV_neg,
         Incidence_pos = Newly.Infected_CMD_pos/PLWHIV_pos)
```



```{r}
sim.results.all$pop_scaling_factor <- sim.results.all$pop.scaling.factor 

sim.results.all %>% 
  filter(Year == 2005, Age == 25) %>% 
  group_by(scenario_name, IP_Key.CMDStatus, sim.ix) %>% 
  summarize(Population = sum(Population * pop_scaling_factor), 
            Infected = sum(Infected * pop_scaling_factor),
            Newly.Infected = sum(Newly.Infected * pop_scaling_factor),
            .groups = 'drop_last') %>% 
  group_by(scenario_name, IP_Key.CMDStatus) %>% 
  summarize(
    Population = mean(Population),
    Infected = mean(Infected), 
    Newly.Infected = mean(Newly.Infected), .groups = 'drop_last') %>% 
  pivot_wider(
    id_cols = scenario_name,
    values_from = c(Population, Infected, Newly.Infected),
    names_from = IP_Key.CMDStatus
  ) %>% 
  mutate(Population_neg = Population_CMD_neg + Population_CMD_recovered + Population_CMD_treated,
         Infected_neg = Infected_CMD_neg + Infected_CMD_recovered + Infected_CMD_treated,
         Newly.Infected_neg = Newly.Infected_CMD_neg + Newly.Infected_CMD_recovered + Newly.Infected_CMD_treated) %>% 
  select(scenario_name, 
         Population_neg, Population_CMD_pos,
         Infected_neg, Infected_CMD_pos,
         Newly.Infected_neg, Newly.Infected_CMD_pos) %>% 
  mutate(PLWHIV_neg = Population_neg - Infected_neg,
         PLWHIV_pos = Population_CMD_pos - Infected_CMD_pos) %>% 
  mutate(Incidence_neg = Newly.Infected_neg/PLWHIV_neg,
         Incidence_pos = Newly.Infected_CMD_pos/PLWHIV_pos,
         Incidence_neg_pop = Newly.Infected_neg/Population_neg,
         Incidence_pos_pop = Newly.Infected_CMD_pos/Population_CMD_pos)
```

```{r}
sim.results.all %>% 
  filter(scenario_name == 'baseline.art', Age == 50, Year > 2005) %>% 
  group_by(Year, IP_Key.CMDStatus, sim.ix) %>% 
  summarize(Population = sum(Population * pop_scaling_factor), 
            Infected = sum(Infected * pop_scaling_factor),
            Newly.Infected = sum(Newly.Infected * pop_scaling_factor),
            .groups = 'drop_last') %>% 
  group_by(Year, IP_Key.CMDStatus) %>% 
  summarize(
    Population = mean(Population),
    Infected = mean(Infected), 
    Newly.Infected = mean(Newly.Infected), .groups = 'drop_last') %>% 
  pivot_wider(
    id_cols = Year,
    values_from = c(Population, Infected, Newly.Infected),
    names_from = IP_Key.CMDStatus
  ) %>% 
  mutate(Population_neg = Population_CMD_neg + Population_CMD_recovered + Population_CMD_treated,
         Infected_neg = Infected_CMD_neg + Infected_CMD_recovered + Infected_CMD_treated,
         Newly.Infected_neg = Newly.Infected_CMD_neg + Newly.Infected_CMD_recovered + Newly.Infected_CMD_treated) %>% 
  select(Year, 
         Population_neg, Population_CMD_pos,
         Infected_neg, Infected_CMD_pos,
         Newly.Infected_neg, Newly.Infected_CMD_pos) %>% 
  mutate(PLWHIV_neg = Population_neg - Infected_neg,
         PLWHIV_pos = Population_CMD_pos - Infected_CMD_pos) %>% 
  mutate(Incidence_neg = Newly.Infected_neg/PLWHIV_neg,
         Incidence_pos = Newly.Infected_CMD_pos/PLWHIV_pos,
         Incidence_neg_pop = Newly.Infected_neg/Population_neg,
         Incidence_pos_pop = Newly.Infected_CMD_pos/Population_CMD_pos) %>% 
  mutate(rr = Incidence_pos/Incidence_neg,
         rr_pop = Incidence_pos_pop/Incidence_neg_pop)
```


# Results for DALY calculations

### Baseline

```{r}
experiment.path = "/gpfs/scratch/citrod01/experiments/MATUMAINI/CROI2025/Baseline-campaign_MATUMAINI_202305-baseline___2024_12_27_12_25_54_409114/"

daly.results.baseline <- EMODAnalyzeR::read.simulation.results.bigpurple(
  experiment_path = experiment.path,
  scenario_name = "baseline",
    summarize_columns = c("Population","Infected", "On_ART",
                        "Died", "Died_from_HIV",
                        "Newly.Infected","Diagnosed",
                       "CMD_Treat_staging", "CMD_Treat", "CMD_Incidence2", "CMD_Relapse2"),
  stratify_columns = c("Year", "Gender", "Age", "IP_Key.CMDStatus"),
  min_age_inclusive = 0,
  max_age_inclusive = 99
)
```

### Universal Treatment

```{r}
experiment.path = "/gpfs/scratch/citrod01/experiments/MATUMAINI/CROI2025/Baseline-campaign_MATUMAINI_202305_uni-uni___2024_12_26_18_23_40_050060/"
experiment.path = ""
daly.results.uni <- EMODAnalyzeR::read.simulation.results.bigpurple(
  experiment_path = experiment.path,
  scenario_name = "uni",
    summarize_columns = c("Population","Infected", "On_ART",
                        "Died", "Died_from_HIV",
                        "Newly.Infected","Diagnosed"),
  stratify_columns = c("Year", "Gender", "Age", "IP_Key.CMDStatus",  "HasHIV",
                       "CMD_Treat_staging", "CMD_Treat", "CMD_Incidence2", "CMD_Relapse2"),
  min_age_inclusive = 0,
  max_age_inclusive = 99
)
```

### ART Annual CMD Treatment


```{r}
#experiment.path = "/gpfs/scratch/citrod01/experiments/MATUMAINI/CROI2025/Baseline-campaign_MATUMAINI_202305_art-art___2024_12_26_18_21_11_286438/"
experiment.path = "/gpfs/scratch/citrod01/experiments/MATUMAINI/CROI2025/Baseline-campaign_MATUMAINI_202305_art-art___2025_01_14_15_36_49_614944/"

daly.results.art <- EMODAnalyzeR::read.simulation.results.bigpurple(
  experiment_path = experiment.path,
  scenario_name = "art",
    summarize_columns = c("Population","Infected", "On_ART",
                        "Died", "Died_from_HIV",
                        "Newly.Infected","Diagnosed"),
  stratify_columns = c("Year", "Gender", "Age", "IP_Key.CMDStatus",  "HasHIV",
                       "CMD_Treat_staging", "CMD_Treat", "CMD_Incidence2", "CMD_Relapse2"),
  min_age_inclusive = 0,
  max_age_inclusive = 99
)
```


### Status Neutral Annual CMD Treatment

```{r}
experiment.path <- "/gpfs/scratch/citrod01/experiments/MATUMAINI/CROI2025/Baseline-campaign_MATUMAINI_202305_neutral_annual-annual___2024_12_26_18_15_58_639286/"

daly.results.neutral.annual <- EMODAnalyzeR::read.simulation.results.bigpurple(
  experiment_path = experiment.path,
  scenario_name = "neutral.annual",
    summarize_columns = c("Population","Infected", "On_ART",
                        "Died", "Died_from_HIV",
                        "Newly.Infected","Diagnosed"),
  stratify_columns = c("Year", "Gender", "Age", "IP_Key.CMDStatus",  "HasHIV",
                       "CMD_Treat_staging", "CMD_Treat", "CMD_Incidence2", "CMD_Relapse2"),
  min_age_inclusive = 0,
  max_age_inclusive = 99
)
```

### Status Neutral CMD upon HIV test
Deprecating this scenario for now, it seems to affect fewer people and is not very impactful. Annual treatment enrollment is more optimistic and emphasizes that it really is less effective.

```{r}
# experiment.path <- "/gpfs/scratch/citrod01/experiments/MATUMAINI/CROI2025/Baseline-campaign_MATUMAINI_202305_neutral_testing-testing___2024_12_26_18_18_41_867421/"
# 
# daly.results.neutral.testing <- EMODAnalyzeR::read.simulation.results.bigpurple(
#   experiment_path = experiment.path,
#   scenario_name = "neutral.testing",
#     summarize_columns = c("Population","Infected", "On_ART",
#                         "Died", "Died_from_HIV",
#                         "Newly.Infected","Diagnosed"),
#   stratify_columns = c("Year", "Gender", "Age", "IP_Key.CMDStatus",  "HasHIV",
#                        "CMD_Treat_staging", "CMD_Treat", "CMD_Incidence2", "CMD_Relapse2"),
#   min_age_inclusive = 0,
#   max_age_inclusive = 99
# )
```

### ART-CETA - treatment for unsuppressed PLHIV on ART
```{r}
experiment.path <- "/gpfs/scratch/citrod01/experiments/MATUMAINI/CROI2025/Baseline-campaign_MATUMAINI_202305_art_ceta-art_ceta___2025_01_14_00_46_13_096598/"

daly.results.art.ceta <- EMODAnalyzeR::read.simulation.results.bigpurple(
  experiment_path = experiment.path,
  scenario_name = "art.ceta",
    summarize_columns = c("Population","Infected", "On_ART",
                        "Died", "Died_from_HIV",
                        "Newly.Infected","Diagnosed"),
  stratify_columns = c("Year", "Gender", "Age", "IP_Key.CMDStatus",  "HasHIV",
                       "CMD_Treat_staging", "CMD_Treat", "CMD_Incidence2", "CMD_Relapse2"),
  min_age_inclusive = 0,
  max_age_inclusive = 99
)
```

### ART-Neutral - combine these together, just for comparison's sake

```{r}
experiment.path <- "/gpfs/scratch/citrod01/experiments/MATUMAINI/CROI2025/Baseline-campaign_MATUMAINI_202305_art_neutral-art_neutral___2025_01_14_00_43_19_000664/"

daly.results.art.neutral <- EMODAnalyzeR::read.simulation.results.bigpurple(
  experiment_path = experiment.path,
  scenario_name = "art.neutral",
    summarize_columns = c("Population","Infected", "On_ART",
                        "Died", "Died_from_HIV",
                        "Newly.Infected","Diagnosed"),
  stratify_columns = c("Year", "Gender", "Age", "IP_Key.CMDStatus",  "HasHIV",
                       "CMD_Treat_staging", "CMD_Treat", "CMD_Incidence2", "CMD_Relapse2"),
  min_age_inclusive = 0,
  max_age_inclusive = 99
)
```


### Join Together

```{r}
# sim.results.all %>% 
#   filter(Year == 2020.5, scenario_name == 'baseline.art') %>% 
#   group_by(scenario_name, sim.ix) %>% 
#   summarize(Population = sum(Population * pop_scaling_factor)) %>% 
#   group_by(scenario_name) %>% 
#   summarize(Population = mean(Population))

daly.results.treatment <- rbind(
  daly.results.baseline, 
  daly.results.uni,
  daly.results.art,
  daly.results.neutral.annual, 
  daly.results.art.ceta,
  daly.results.art.neutral
  #daly.results.neutral.testing
)

#CENSUS_YEAR = 2009
#KEN_CENSUS_POP = 5352385

CENSUS_YEAR = 2020.5
KEN_CENSUS_POP = 6953951

sim.results.pop.scaling <- daly.results.treatment %>%
    filter(Year == CENSUS_YEAR) %>%
    group_by(sim.ix, scenario_name) %>%
    summarize(total.pop = sum(Population), .groups = 'drop_last') %>%
    mutate(pop_scaling_factor = KEN_CENSUS_POP/total.pop)

daly.results.treatment <- daly.results.treatment %>%
  inner_join(
    sim.results.pop.scaling,
    by = c("sim.ix", "scenario_name")
  )
```



# Analyze

### CMD_Treat over time
```{r}
cmdtreat.count <- daly.results.treatment %>% 
  #mutate(Year = ceiling(Year)) %>% 
  filter(Year >= 2020) %>% 
  group_by(Year, Gender, scenario_name, sim.ix) %>% 
  summarize(CMD_Treat = sum(CMD_Treat), .groups = 'drop_last') %>% 
  group_by(Year, Gender, scenario_name) %>% 
  summarize(CMD_Treat = mean(CMD_Treat), .groups = 'drop_last')

cmdtreat.count %>% 
  ggplot() + 
  geom_line(mapping = aes(x = Year, y = CMD_Treat, color = scenario_name)) + 
  facet_grid(cols = vars(Gender))
            
# sim.results.art %>% 
#   #mutate(Year = ceiling(Year)) %>% 
#   filter(Year >= 2020) %>% 
#   group_by(Year, Gender, scenario_name, sim.ix) %>% 
#   summarize(CMD_Treat = sum(CMD_Treat),
#             CMD_Treat_staging = sum(CMD_Treat_staging), .groups = 'drop_last') %>% 
#   group_by(Year, Gender, scenario_name) %>%  
#   summarize(CMD_Treat = mean(CMD_Treat),
#             CMD_Treat_staging = mean(CMD_Treat_staging), .groups = 'drop_last') %>% 
#   mutate(ratio = CMD_Treat/CMD_Treat_staging) %>% arrange(Gender, Year) %>% 
#   ggplot() + 
#   geom_line(mapping = aes(x = Year, y = ratio, color = scenario_name)) + 
#   facet_grid(cols = vars(Gender))

```

### Ratio of people staged for CMD treatment vs those who receive it

```{r}
cmdtreat.count <- sim.results.treatment %>% 
  #mutate(Year = ceiling(Year)) %>%
  filter(Year >= 2020) %>% 
  group_by(Year, Gender, scenario_name, sim.ix) %>% 
  summarize(CMD_Treat = sum(CMD_Treat), CMD_Treat_staging = sum(CMD_Treat_staging), .groups = 'drop_last') %>% 
  group_by(Year, Gender, scenario_name) %>% 
  summarize(CMD_Treat = mean(CMD_Treat), CMD_Treat_staging = mean(CMD_Treat_staging), .groups = 'drop_last') %>% 
  mutate(ratio = case_when(CMD_Treat_staging > 0 ~ CMD_Treat/CMD_Treat_staging, CMD_Treat_staging == 0 ~ 0))

cmdtreat.count %>% 
  ggplot() + 
  geom_line(mapping = aes(x = Year, y = ratio, color = scenario_name)) + 
  facet_grid(cols = vars(Gender))
```


## How many people are living with HIV, CMD in 2025?
```{r}
sim.results.neutral %>% 
  filter(Year == 2025, Age >= 15) %>% 
  group_by(Gender, scenario_name, sim.ix) %>% 
  summarize(Infected = sum(Infected * pop_scaling_factor)) %>% 
  group_by(Gender,scenario_name) %>% 
  summarize(Infected = mean(Infected)) %>%
  pivot_wider(id_cols = c("scenario_name"), values_from = c("Infected"), names_from = c("Gender"),
              names_prefix = "Infected_") %>% 
  mutate(Infected = Infected_0 + Infected_1)
```

```{r}
sim.results.neutral %>% 
  filter(Year == 2025, Age >= 15) %>% 
  filter(IP_Key.CMDStatus == "CMD_pos") %>% 
  group_by(Gender, scenario_name, sim.ix) %>% 
  summarize(Population = sum(Population * pop_scaling_factor)) %>% 
  group_by(Gender,scenario_name) %>% 
  summarize(Population = mean(Population)) %>%
  pivot_wider(id_cols = c("scenario_name"), values_from = c("Population"), names_from = c("Gender"),
              names_prefix = "Depressed_") %>% 
  mutate(Depressed = Depressed_0 + Depressed_1)
```

```{r}
sim.results.neutral %>% 
  filter(Year == 2025, Age >= 15) %>% 
  filter(IP_Key.CMDStatus == "CMD_pos") %>% 
  group_by(Gender, scenario_name, sim.ix) %>% 
  summarize(Infected = sum(Infected * pop_scaling_factor)) %>% 
  group_by(Gender,scenario_name) %>% 
  summarize(Infected = mean(Infected)) %>%
  pivot_wider(id_cols = c("scenario_name"), values_from = c("Infected"), names_from = c("Gender"),
              names_prefix = "Infected_") %>% 
  mutate(Infected = Infected_0 + Infected_1)
```

### Impact calculations

```{r}
bt_mean <- function(splits, colname){
  x <- as.data.frame(analysis(splits))
  mean(x[[colname]])
}

# Deaths and Infections
bt_resamples <- bootstraps(hiv.averted.data.scatter %>% filter(scenario_name == "final"), times = 500)

bt_resamples$mean.infected <- map_dbl(bt_resamples$splits, bt_mean, "Newly.Infected_averted")
bt_resamples$mean.infected.pct <- map_dbl(bt_resamples$splits, bt_mean, "Newly.Infected_averted.pct")
bt_resamples$mean.deaths<- map_dbl(bt_resamples$splits, bt_mean, "Died_from_HIV_averted")
bt_resamples$mean.deaths.pct <- map_dbl(bt_resamples$splits, bt_mean, "Died_from_HIV_averted.pct")

infected_95 <- quantile(bt_resamples$mean.infected, probs = c(.025, .975))
deaths_95 <- quantile(bt_resamples$mean.deaths, probs = c(.025, .975))
infected.pct_95 <- quantile(bt_resamples$mean.infected.pct, probs = c(.025, .975))
deaths.pct_95 <- quantile(bt_resamples$mean.deaths.pct, probs = c(.025, .975))

all.stats[all.stats$scenario_name == "final",]$Newly.Infected_averted.lb = infected_95[[1]]
all.stats[all.stats$scenario_name == "final",]$Newly.Infected_averted.ub = infected_95[[2]]
all.stats[all.stats$scenario_name == "final",]$Newly.Infected_averted.pct.lb = infected.pct_95[[1]]
all.stats[all.stats$scenario_name == "final",]$Newly.Infected_averted.pct.ub = infected.pct_95[[2]]

all.stats[all.stats$scenario_name == "final",]$Died_from_HIV_averted.lb = deaths_95[[1]]
all.stats[all.stats$scenario_name == "final",]$Died_from_HIV_averted.ub = deaths_95[[2]]
all.stats[all.stats$scenario_name == "final",]$Died_from_HIV_averted.pct.lb = deaths.pct_95[[1]]
all.stats[all.stats$scenario_name == "final",]$Died_from_HIV_averted.pct.ub = deaths.pct_95[[2]]

bt_resamples <- bootstraps(hiv.averted.data.scatter %>% filter(scenario_name == "neutral"), times = 500)

bt_resamples$mean.infected <- map_dbl(bt_resamples$splits, bt_mean, "Newly.Infected_averted")
bt_resamples$mean.infected.pct <- map_dbl(bt_resamples$splits, bt_mean, "Newly.Infected_averted.pct")
bt_resamples$mean.deaths<- map_dbl(bt_resamples$splits, bt_mean, "Died_from_HIV_averted")
bt_resamples$mean.deaths.pct <- map_dbl(bt_resamples$splits, bt_mean, "Died_from_HIV_averted.pct")

infected_95 <- quantile(bt_resamples$mean.infected, probs = c(.025, .975))
deaths_95 <- quantile(bt_resamples$mean.deaths, probs = c(.025, .975))
infected.pct_95 <- quantile(bt_resamples$mean.infected.pct, probs = c(.025, .975))
deaths.pct_95 <- quantile(bt_resamples$mean.deaths.pct, probs = c(.025, .975))

all.stats[all.stats$scenario_name == "neutral",]$Newly.Infected_averted.lb = infected_95[[1]]
all.stats[all.stats$scenario_name == "neutral",]$Newly.Infected_averted.ub = infected_95[[2]]
all.stats[all.stats$scenario_name == "neutral",]$Newly.Infected_averted.pct.lb = infected.pct_95[[1]]
all.stats[all.stats$scenario_name == "neutral",]$Newly.Infected_averted.pct.ub = infected.pct_95[[2]]

all.stats[all.stats$scenario_name == "neutral",]$Died_from_HIV_averted.lb = deaths_95[[1]]
all.stats[all.stats$scenario_name == "neutral",]$Died_from_HIV_averted.ub = deaths_95[[2]]
all.stats[all.stats$scenario_name == "neutral",]$Died_from_HIV_averted.pct.lb = deaths.pct_95[[1]]
all.stats[all.stats$scenario_name == "neutral",]$Died_from_HIV_averted.pct.ub = deaths.pct_95[[2]]

# cmd
bt_resamples <- bootstraps(cmd.treat.data.scatter %>% filter(scenario_name == "final"), times = 500)
bt_resamples$mean.cmd <- map_dbl(bt_resamples$splits, bt_mean, "CMD_Treat")
cmd_95 <- quantile(bt_resamples$mean.cmd, probs = c(.025, .975))
all.stats[all.stats$scenario_name == "final",]$CMD_Treat.lb = cmd_95[[1]]
all.stats[all.stats$scenario_name == "final",]$CMD_Treat.ub = cmd_95[[2]]

bt_resamples <- bootstraps(cmd.treat.data.scatter %>% filter(scenario_name == "neutral"), times = 500)
bt_resamples$mean.cmd <- map_dbl(bt_resamples$splits, bt_mean, "CMD_Treat")
cmd_95 <- quantile(bt_resamples$mean.cmd, probs = c(.025, .975))
all.stats[all.stats$scenario_name == "neutral",]$CMD_Treat.lb = cmd_95[[1]]
all.stats[all.stats$scenario_name == "neutral",]$CMD_Treat.ub = cmd_95[[2]]

all.stats
```

### Impact of treatment

```{r}
p <- all.stats %>% 
  mutate(scenario_ix = case_match(scenario_name, "baseline" ~ 0, "final" ~ 1, "neutral" ~ 2)) %>% 
  select(scenario_ix,scenario_name, Depression_averted.pct) %>% 
  filter(scenario_name %in% c("uni", "neutral", "art")) %>% 
  pivot_longer(cols = c(Depression_averted.pct), names_to = "metric") %>% 
  ggplot() +
  geom_bar(mapping = aes(x = metric, y = value*100, fill = factor(scenario_name)),
           position=position_dodge2(reverse = TRUE, padding = 0), stat = "identity") + 
  scale_y_continuous(breaks = seq(0,50,10), labels = c("0%", "10%", "20%", "30%", "40%","50%"), expand = expansion(mult = c(0.00,.1))) +
  scale_fill_manual("", values = c("#00671F", "#FF6600", "#0004E7"),
                    breaks = c("baseline", "final", "neutral"), 
                    labels = c("baseline", "final   ", "neutral")) + 
  scale_x_discrete(breaks=c("Depression_averted.pct"),
                   labels=c("Depression Episodes")) + 
  theme_minimal() + theme_bw() +
  theme(panel.grid = element_blank(),
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        axis.text.x = element_blank(),
        legend.position = "top")
# + 
#   guides(fill=guide_legend("Depression Treatment Distribution"))

all.stats.plot <- all.stats %>% 
  mutate(scenario_ix = case_match(scenario_name, "baseline" ~ 0, "final" ~ 1, "neutral" ~ 2)) %>% 
  select(scenario_ix,scenario_name, Newly.Infected_averted.pct, Died_from_HIV_averted.pct) %>% 
  filter(scenario_name %in% c("baseline", "final", "neutral")) %>% 
  pivot_longer(cols = c(Newly.Infected_averted.pct, Died_from_HIV_averted.pct), names_to = "metric", values_to = "mean") %>% 
  merge(
    all.stats %>% 
      mutate(scenario_ix = case_match(scenario_name, "baseline" ~ 0, "final" ~ 1, "neutral" ~ 2)) %>% 
      select(scenario_ix,scenario_name, Newly.Infected_averted.pct.lb, Died_from_HIV_averted.pct.lb) %>% 
  filter(scenario_name %in% c("baseline", "final", "neutral")) %>% 
      mutate(Newly.Infected_averted.pct = Newly.Infected_averted.pct.lb,
             Died_from_HIV_averted.pct = Died_from_HIV_averted.pct.lb) %>% 
      select(scenario_ix, scenario_name, Newly.Infected_averted.pct,Died_from_HIV_averted.pct) %>% 
      pivot_longer(cols = c(Newly.Infected_averted.pct, Died_from_HIV_averted.pct), names_to = "metric", values_to =  "lb"),
    by = c("scenario_ix", "scenario_name", "metric")
  ) %>% 
  merge(
    all.stats %>% 
      mutate(scenario_ix = case_match(scenario_name, "baseline" ~ 0, "final" ~ 1, "neutral" ~ 2)) %>% 
      select(scenario_ix,scenario_name, Newly.Infected_averted.pct.ub, Died_from_HIV_averted.pct.ub) %>% 
      filter(scenario_name %in% c("baseline", "final", "neutral")) %>% 
      mutate(Newly.Infected_averted.pct = Newly.Infected_averted.pct.ub,
             Died_from_HIV_averted.pct = Died_from_HIV_averted.pct.ub) %>% 
      select(scenario_ix, scenario_name, Newly.Infected_averted.pct,Died_from_HIV_averted.pct) %>% 
      pivot_longer(cols = c(Newly.Infected_averted.pct, Died_from_HIV_averted.pct), names_to = "metric", values_to =  "ub"),
    by = c("scenario_ix", "scenario_name", "metric")
  ) 


p1 <- all.stats.plot %>% 
  ggplot() +
  geom_bar(mapping = aes(x = metric, y = mean*100, fill = factor(scenario_name)),
           position=position_dodge2(reverse = TRUE, padding = 0), stat = "identity",
           show.legend = TRUE) + 
  geom_errorbar(mapping = aes(x = metric, ymin = lb*100, ymax = ub*100, color = factor(scenario_name)),
                position=position_dodge2(reverse = TRUE, padding = .25), stat = "identity",
                size = 1,# color = "black",
                show.legend = TRUE) + 
  #geom_label(mapping = aes(x = metric, y = value*100, label = metric)) + 
  #geom_text(mapping = aes(x = 1, y = 4.1, label = "HIV Deaths Averted")) + 
  #geom_text(mapping = aes(x = 2, y = 7, label = "HIV Infections Averted")) + 
  scale_y_continuous(
    "% Averted",
    breaks = seq(0,1,.2), 
    labels = c("0%", ".2%", ".4%", ".6%", ".8%",".10%"), 
    expand = expansion(mult = c(0.00,.2))) +
  scale_fill_manual("", values = c("#00671F", "#FF6600", "#0004E7"),
                    breaks = c("baseline", "final", "neutral"), 
                    labels = c("baseline", "final   ", "neutral")) + 
  scale_color_manual("", values = c("black", "black", "black"),
                    breaks = c("baseline", "final", "neutral"), 
                    labels = c("baseline", "final   ", "neutral")) + 
  scale_x_discrete( 
    breaks=c("Newly.Infected_averted.pct", "Died_from_HIV_averted.pct"),
    labels=c("HIV Infections", "HIV Deaths"),
      expand = expansion(mult = c(.6,.6))) +
  #ggtitle("HIV Outcome Improvements\nvs. Depression Treatment Strategy") + 
  theme_minimal() + theme_bw() +
  theme(panel.grid = element_blank(),
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        axis.text.x = element_blank(),
        legend.position = "bottom",
        plot.title = element_text(hjust = 0.5),
        text = element_text(family = "sans"))

p1 
# + 
#   guides(fill=guide_legend("Depression Treatment Distribution"))
```

```{r}
all.stats.plot
```

```{r}
p2 <- all.stats %>% 
  mutate(scenario_id = case_match(scenario_name, "baseline" ~ "", "final" ~ "final", "neutral" ~ "Status Neutral", "art" ~ "ART")) %>% 
  ggplot() +  
  geom_line(all.stats %>% filter(scenario_name != "neutral"),
            mapping = aes(x = CMD_Treat, y = Died_from_HIV_averted)) + 
  geom_point(mapping = aes(x = CMD_Treat, y = Died_from_HIV_averted, color = scenario_name), show.legend = FALSE,
             size = 3) + 
  geom_errorbar(all.stats %>% filter(scenario_name != "baseline"),
                mapping = aes(x = CMD_Treat, ymin = Died_from_HIV_averted.lb, ymax = Died_from_HIV_averted.ub)) + 
  # geom_errorbar(all.stats %>% filter(scenario_name != "baseline"),
  #               mapping = aes(xmin = CMD_Treat.lb, xmax = CMD_Treat.ub,  y = Died_from_HIV_averted)) + 
  #geom_text(mapping = aes(x = CMD_Treat, y = Died_from_HIV_averted, label = scenario_id),
  #          position = position_dodge(width = 1),  vjust =  -0.75) + 
  #ggtitle("HIV Outcome Improvements\nvs. Depression Treatments Administered") + 
  # scale_color_manual("", values = c("black", "#00671F", "#FF6600", "#0004E7"),
  #                 breaks = c("baseline", "uni", "neutral", "art"), 
  #                 labels = c("", "Universal", "Status Neutral   ", "ART")) +
  # scale_y_continuous(
  #   "HIV Infections Averted",
  #   breaks = seq(0,4000,1000), labels = seq(0,4000, 1000), expand = expansion(mult = c(0.01,.1))) +   scale_x_continuous(
  #   "Depression Treatments Administered", breaks = seq(0,4000000, 1000000), labels = c(0, "1M", "2M", "3M", "4M" ),
  #   expand = expansion(mult = c(0.01, .2))
  # ) + 
  theme_minimal() + theme_bw() +
  theme(panel.grid = element_blank(),
        axis.title.x = element_blank(),
        axis.text.x = element_blank(),
        plot.title = element_text(hjust = 0.5),
        text = element_text(family = "sans"))


p3 <- all.stats %>% 
  mutate(scenario_id = case_match(scenario_name, "baseline" ~ "", "final" ~ "final", "neutral" ~ "Status Neutral", "art" ~ "ART")) %>% 
  ggplot() +  
  geom_line(all.stats %>% filter(scenario_name != "neutral"),
            mapping = aes(x = CMD_Treat, y = Newly.Infected_averted)) + 
  geom_point(mapping = aes(x = CMD_Treat, y = Newly.Infected_averted, color = scenario_name), show.legend = FALSE,
             size = 3) + 
  geom_errorbar(all.stats %>% filter(scenario_name != "baseline"),
                mapping = aes(x = CMD_Treat, ymin = Newly.Infected_averted.lb, ymax = Newly.Infected_averted.ub)) + 
  # geom_text(mapping = aes(x = CMD_Treat, y = Newly.Infected_averted, label = scenario_id),
  #           position = position_dodge(width = 1),  vjust = -0.75) + 
  scale_color_manual("", values = c("black", "#00671F", "#FF6600", "#0004E7"),
                  breaks = c("baseline", "uni", "neutral", "art"), 
                  labels = c("", "Universal", "Status Neutral   ", "ART")) +
  # scale_y_continuous(
  #   "HIV Deaths Averted",
  #   breaks = seq(0,10000,2000), labels = seq(0,10000, 2000), expand = expansion(mult = c(0.01,.1))) + 
  # scale_x_continuous(
  #   "Depression Treatments Administered", breaks = seq(0,4000000, 1000000), labels = c(0, "1M", "2M", "3M", "4M" ),
  #   expand = expansion(mult = c(0.01, .2))
  # ) + 
  theme_minimal() + theme_bw() +
  theme(panel.grid = element_blank(),
        plot.title = element_text(hjust = 0.5),
        text = element_text(family = "sans")
        )

p2/p3
```

### Who is receiving CMD treatment?

Break down treatment delivery by age and sex and HIV status

```{r}
Age.bins = c(0, 15, 25,50,100)

cmd.treat.by.age <- daly.results.treatment %>% 
  filter(Year >=2025) %>% 
  mutate(Year = floor(Year)) %>% 
  mutate(Age_bin = cut(Age, Age.bins, right = FALSE)) %>% 
  group_by(scenario_name, sim.ix, Year, Gender, Age_bin, HasHIV) %>% 
  summarize(Population = sum(Population * pop_scaling_factor),
            CMD_Treat_staging = sum(CMD_Treat_staging * pop_scaling_factor), .groups = 'drop_last') %>% 
  group_by(scenario_name, Year, Gender, Age_bin, HasHIV) %>% 
  summarize(Population = mean(Population),
            CMD_Treat_Staging = mean(CMD_Treat_staging))

# Raw counts of treatment by age and HIV status and gender
cmd.treat.by.age %>%
  mutate(cov = CMD_Treat_Staging/Population) %>% 
  pivot_wider(id_cols = c(Year, Gender, Age_bin, HasHIV),
              values_from = c(CMD_Treat_Staging),
              names_from = c(scenario_name, ))  %>% 
  arrange(Age_bin, HasHIV, Gender, Year) %>% View

# Percent pop coverage of treatment by age and HIV status and gender
cmd.treat.by.age %>%
  mutate(cov = CMD_Treat_Staging/Population) %>% 
  pivot_wider(id_cols = c(Year, Gender, Age_bin, HasHIV),
              values_from = c(cov),
              names_from = c(scenario_name, ))  %>% 
  arrange(Age_bin, HasHIV, Gender, Year) %>% View


cmd.treat.by.age %>%
  mutate(cov = CMD_Treat_Staging/Population) %>% 
  pivot_wider(id_cols = c(Year.bin, Gender, Age_bin, HasHIV),
              values_from = c(cov),
              names_from = c(scenario_name, ))  %>% 
  arrange(Age_bin, HasHIV, Gender, Year.bin) %>% View

```


```{r}
cmd.treat.by.age <- daly.results.treatment %>% 
  filter(Year >=2025) %>% 
  mutate(Year = floor(Year)) %>% 
  mutate(Age_bin = cut(Age, Age.bins, right = FALSE)) %>% 
  group_by(scenario_name, sim.ix, Year, Age_bin, HasHIV) %>% 
  summarize(Population = sum(Population * pop_scaling_factor),
            Newly.Infected = sum(Newly.Infected * pop_scaling_factor),
            CMD_Treat_staging = sum(CMD_Treat_staging * pop_scaling_factor), .groups = 'drop_last') %>% 
  group_by(scenario_name, Year, Age_bin, HasHIV) %>% 
  summarize(Population = mean(Population),
            Newly.Infected = mean(Newly.Infected),
            CMD_Treat_Staging = mean(CMD_Treat_staging))

cmd.treat.by.age %>% 
  mutate(cov = CMD_Treat_Staging/Population,
         inc = Newly.Infected/Population) %>% 
  pivot_wider(id_cols = c(Year, Age_bin, HasHIV),
              values_from = c(cov, inc),
              names_from = c(scenario_name))  %>% 
  arrange(Age_bin, HasHIV, Year) %>% View

cmd.treat.by.age %>% 
  mutate(cov = CMD_Treat_Staging) %>% 
  pivot_wider(id_cols = c(Year, Age_bin, HasHIV),
              values_from = c(cov),
              names_from = c(scenario_name))  %>% 
  arrange(Age_bin, HasHIV, Year) %>% View
```

Compare the above metrics against incidence by age

```{r}

```


# Metrics

## What's going on in 2025?

### Population
```{r}
pop.2025 <- daly.results.treatment %>% 
  filter(Year == 2025, Age >= 15) %>% 
  group_by(scenario_name, sim.ix) %>% 
  summarize(Population = sum(Population * pop_scaling_factor), .groups = 'keep') %>% 
  group_by(scenario_name) %>% 
  summarize(Population = mean(Population), .groups = "keep") %>% ungroup()

pop.2025
```


### PLHIV 

```{r}
plhiv.2025 <- daly.results.treatment %>% 
  filter(Year == 2025, Age >= 15) %>% 
  group_by(Gender, scenario_name, sim.ix) %>% 
  summarize(Infected = sum(Infected * pop_scaling_factor), .groups = 'keep') %>% 
  group_by(Gender,scenario_name) %>% 
  summarize(Infected = mean(Infected), .groups = "keep") %>%
  pivot_wider(id_cols = c("scenario_name"), values_from = c("Infected"), names_from = c("Gender"),
              names_prefix = "Infected_") %>% 
  select(scenario_name, Infected_Male = Infected_0, Infected_Female = Infected_1) %>% 
  mutate(Infected = Infected_Male + Infected_Female)

plhiv.2025
```

### On ART

```{r}
onart.2025 <- daly.results.treatment %>% 
  filter(Year == 2025, Age >= 15) %>% 
  group_by(Gender, scenario_name, sim.ix) %>% 
  summarize(On_ART = sum(On_ART * pop_scaling_factor), .groups = 'keep') %>% 
  group_by(Gender,scenario_name) %>% 
  summarize(On_ART = mean(On_ART), .groups = "keep") %>%
  pivot_wider(id_cols = c("scenario_name"), values_from = c("On_ART"), names_from = c("Gender"),
              names_prefix = "On_ART_") %>% 
  select(scenario_name, On_ART_Male = On_ART_0, On_ART_Female = On_ART_1) %>% 
  mutate(On_ART = On_ART_Male + On_ART_Female)

onart.2025
```


### People living with depression

```{r}
pldep.2025 <- daly.results.treatment %>% 
  filter(Year == 2025, Age >=15) %>%
  filter(IP_Key.CMDStatus == "CMD_pos") %>%
  group_by(scenario_name, sim.ix) %>% 
  summarize(Population = sum(Population * pop_scaling_factor), .groups = "drop_last" ) %>% 
  group_by(scenario_name) %>% 
  summarize(Depression = mean(Population), .groups = "drop_last")

pldep.2025
```

### People with HIV living with depression

```{r}
plhiv.dep.2025 <-  daly.results.treatment %>% 
  filter(Year == 2025, Age >= 15) %>% 
  group_by(scenario_name, IP_Key.CMDStatus, sim.ix) %>% 
  summarize(Population = sum(Population * pop_scaling_factor),
            Infected = sum(Infected * pop_scaling_factor),
            .groups = 'drop_last') %>% 
  group_by(scenario_name, IP_Key.CMDStatus) %>% 
  summarize(Population = mean(Population),
            PLHIV = mean(Infected), .groups = 'drop_last') %>% 
  pivot_wider(
    id_cols = scenario_name,
    values_from = c("Population", "PLHIV"), 
    names_from = IP_Key.CMDStatus)

plhiv.dep.2025
```

## HIV prevalence over time

```{r}
prev.time.data <- daly.results.treatment %>%
  EMODAnalyzeR::calculate.prevalence(
    stratify_columns = c("Year", "Gender", "sim.ix", "scenario_name")
  ) %>% 
  group_by(Year, Gender, scenario_name) %>% 
  summarize(Infected = mean(Infected),
            Population = mean(Population),
            Prevalence = mean(Prevalence), .groups = 'drop_last') %>%
  mutate(Gender = case_when(Gender==0 ~ "Male", Gender==1 ~ "Female"))

p <- ggplot() +
      geom_line(data= prev.time.data %>% filter(Year > 1985),
              aes(x=Year, y=Prevalence, group=scenario_name, color=scenario_name), linewidth=.5) +
    facet_wrap(~ Gender, ncol=2) +
    #xlab("Year")+
    #xlim(c(date.start, date.end)) +
    #ylab("Prevalence") +
    theme_bw(base_size=16) +
    guides(color = guide_legend(ncol = 2, byrow = TRUE, keywidth = 2, keyheight = 1)) +
    theme(legend.position="top", legend.text=element_text(size=10)) +
    scale_x_continuous(breaks = seq(1985,2050,10)) +
    theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
    theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
    #scale_y_continuous(labels = scales::percent_format(accuracy = 1), breaks = seq(0,0.25,0.05), limits=c(0, 0.25)) +
    #ylab("HIV Prevalence (%)") +
    scale_color_manual(values=c("blue","red","darkgreen","orange","black","purple", "pink"))

p
```

## PLHIV over time

```{r}
plhiv.time.data <- daly.results.treatment %>% 
  filter(Age >= 15) %>% 
  group_by(Year, Gender, scenario_name, sim.ix) %>% 
  summarize(PLHIV = sum(Infected * pop_scaling_factor), .groups = 'drop_last') %>% 
  group_by(Year, Gender,scenario_name) %>% 
  summarize(PLHIV = mean(PLHIV), .groups = 'drop_last') %>%
  mutate(Gender = case_when(Gender==0 ~ "Male", Gender==1 ~ "Female"))

p <- ggplot() +
    geom_line(data= plhiv.time.data %>% filter(Year > 1985),
              aes(x=Year, y=PLHIV, group=scenario_name, color=scenario_name), linewidth=.5) +
    facet_wrap(~ Gender, ncol=2, scales = "free_y") +
    theme_bw(base_size=16) +
    guides(color = guide_legend(ncol = 2, byrow = TRUE, keywidth = 2, keyheight = 1)) +
    theme(legend.position="top", legend.text=element_text(size=10)) +
    scale_x_continuous(breaks = seq(1985,2050,10)) +
    theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
    theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
    #scale_y_continuous(labels = scales::percent_format(accuracy = 1), breaks = seq(0,0.25,0.05), limits=c(0, 0.25)) +
    #ylab("HIV Prevalence (%)") +
    scale_color_manual(values=c("blue","red","darkgreen","orange","black","purple", "pink"))

p
```

```{r}
p <- ggplot() +
    geom_line(data= plhiv.time.data %>% filter(Year > 2020),
              aes(x=Year, y=PLHIV, group=scenario_name, color=scenario_name), linewidth=.5) +
    facet_wrap(~ Gender, ncol=2, scales = "free_y") +
    theme_bw(base_size=16) +
    guides(color = guide_legend(ncol = 2, byrow = TRUE, keywidth = 2, keyheight = 1)) +
    theme(legend.position="top", legend.text=element_text(size=10)) +
    scale_x_continuous(breaks = seq(2020,2035,2)) +
    theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
    theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
    #scale_y_continuous(labels = scales::percent_format(accuracy = 1), breaks = seq(0,0.25,0.05), limits=c(0, 0.25)) +
    #ylab("HIV Prevalence (%)") +
    scale_color_manual(values=c("blue","red","darkgreen","orange","black","purple", "pink"))

p
```


## Calculate HIV infections and deaths averted

```{r}
hiv.averted.data <- daly.results.treatment %>% 
  filter(Age >=15) %>%
  group_by(Year, Gender, scenario_name, sim.ix) %>% 
  summarize(Died_from_HIV = sum(Died_from_HIV * pop_scaling_factor),
            Newly.Infected = sum(Newly.Infected * pop_scaling_factor), .groups = 'drop_last') %>% 
  group_by(Year, Gender, scenario_name) %>%
  summarize(Died_from_HIV = mean(Died_from_HIV),
            Newly.Infected = mean(Newly.Infected), .groups = 'drop_last') %>%
  mutate(Gender = case_when(Gender==0 ~ "Male", Gender==1 ~ "Female"))
```


## HIV new infections over time

```{r}
p <- ggplot() +
    geom_line(data= hiv.averted.data %>% filter(Year > 1985),
              aes(x=Year, y=Newly.Infected, group=scenario_name, color=scenario_name), linewidth=.5) +
    facet_wrap(~ Gender, ncol=2, scales = "free_y") +
    theme_bw(base_size=16) +
    guides(color = guide_legend(ncol = 2, byrow = TRUE, keywidth = 2, keyheight = 1)) +
    theme(legend.position="top", legend.text=element_text(size=10)) +
    scale_x_continuous(breaks = seq(1985,2050,10)) +
    theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
    theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
    #scale_y_continuous(labels = scales::percent_format(accuracy = 1), breaks = seq(0,0.25,0.05), limits=c(0, 0.25)) +
    #ylab("HIV Prevalence (%)") +
    scale_color_manual(values=c("blue","red","darkgreen","orange","black","purple", "pink"))

p
```

```{r}
p <- ggplot() +
    geom_line(data= hiv.averted.data %>% filter(Year > 2020),
              aes(x=Year, y=Newly.Infected, group=scenario_name, color=scenario_name), linewidth=.5) +
    facet_wrap(~ Gender, ncol=2, scales = "free_y") +
    theme_bw(base_size=16) +
    guides(color = guide_legend(ncol = 2, byrow = TRUE, keywidth = 2, keyheight = 1)) +
    theme(legend.position="top", legend.text=element_text(size=10)) +
    scale_x_continuous(breaks = seq(2020,2035,2)) +
    theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
    theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
    #scale_y_continuous(labels = scales::percent_format(accuracy = 1), breaks = seq(0,0.25,0.05), limits=c(0, 0.25)) +
    #ylab("HIV Prevalence (%)") +
    scale_color_manual(values=c("blue","red","darkgreen","orange","black","purple", "pink"))

p
```


## HIV deaths over time

```{r}
p <- ggplot() +
    geom_line(data= hiv.averted.data %>% filter(Year > 1985),
              aes(x=Year, y=Died_from_HIV, group=scenario_name, color=scenario_name), linewidth=.5) +
    facet_wrap(~ Gender, ncol=2, scales = "free_y") +
    theme_bw(base_size=16) +
    guides(color = guide_legend(ncol = 2, byrow = TRUE, keywidth = 2, keyheight = 1)) +
    theme(legend.position="top", legend.text=element_text(size=10)) +
    scale_x_continuous(breaks = seq(1985,2035,5)) +
    theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
    theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
    #scale_y_continuous(labels = scales::percent_format(accuracy = 1), breaks = seq(0,0.25,0.05), limits=c(0, 0.25)) +
    #ylab("HIV Prevalence (%)") +
    scale_color_manual(values=c("blue","red","darkgreen","orange","black","purple", "pink"))

p
```


```{r}
p <- ggplot() +
    geom_line(data= hiv.averted.data %>% filter(Year > 2020),
              aes(x=Year, y=Died_from_HIV, group=scenario_name, color=scenario_name), linewidth=.5) +
    facet_wrap(~ Gender, ncol=2, scales = "free_y") +
    theme_bw(base_size=16) +
    guides(color = guide_legend(ncol = 2, byrow = TRUE, keywidth = 2, keyheight = 1)) +
    theme(legend.position="top", legend.text=element_text(size=10)) +
    scale_x_continuous(breaks = seq(2020,2035,2)) +
    theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
    theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
    #scale_y_continuous(labels = scales::percent_format(accuracy = 1), breaks = seq(0,0.25,0.05), limits=c(0, 0.25)) +
    #ylab("HIV Prevalence (%)") +
    scale_color_manual(values=c("blue","red","darkgreen","orange","black","purple", "pink"))

p
```

## ON ART over time

```{r}
onart.time.data <- daly.results.treatment %>% 
  filter(Age >= 15) %>% 
  group_by(Year, Gender, scenario_name, sim.ix) %>% 
  summarize(On_ART = sum(On_ART * pop_scaling_factor), .groups = 'drop_last') %>% 
  group_by(Year, Gender,scenario_name) %>% 
  summarize(On_ART = mean(On_ART), .groups = 'drop_last') %>%
  mutate(Gender = case_when(Gender == 0 ~ "Male", Gender == 1 ~ "Female"))

p <- ggplot() +
    geom_line(data= onart.time.data %>% filter(Year > 1985),
              aes(x = Year, y = On_ART, group=scenario_name, color=scenario_name), linewidth=.5) +
    facet_wrap(~ Gender, ncol=2, scales = "free_y") +
    theme_bw(base_size=16) +
    guides(color = guide_legend(ncol = 2, byrow = TRUE, keywidth = 2, keyheight = 1)) +
    theme(legend.position="top", legend.text=element_text(size=10)) +
    scale_x_continuous(breaks = seq(1985,2050,10)) +
    theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
    theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
    #scale_y_continuous(labels = scales::percent_format(accuracy = 1), breaks = seq(0,0.25,0.05), limits=c(0, 0.25)) +
    #ylab("HIV Prevalence (%)") +
    scale_color_manual(values=c("blue","red","darkgreen","orange","black","purple", "pink"))

p
```

```{r}
onart.time.data
```


## HIV infections and deaths averted

```{r}
hiv.averted.data.agg <- hiv.averted.data %>% 
  filter(Year >= 2025) %>% 
  group_by(Gender, scenario_name) %>% 
  summarize(Died_from_HIV = sum(Died_from_HIV), 
            Newly.Infected = sum(Newly.Infected), .groups = 'drop_last')

hiv.averted.data.agg <- hiv.averted.data.agg %>% 
  merge(
    hiv.averted.data.agg %>% 
      filter(scenario_name == 'baseline') %>% 
      select(Gender, Died_from_HIV.baseline = Died_from_HIV, Newly.Infected.baseline = Newly.Infected), 
    by = c("Gender")
  ) %>% 
  mutate(
    Died_from_HIV.averted = Died_from_HIV.baseline - Died_from_HIV,
    Newly.Infected.averted = Newly.Infected.baseline - Newly.Infected,
    )

hiv.averted.data.agg %>% 
  group_by(scenario_name) %>% 
  summarize(Died_from_HIV.averted = sum(Died_from_HIV.averted),
            Newly.Infected.averted = sum(Newly.Infected.averted), .groups = 'drop_last')
```
### Generate CIs for infections and deaths averted

```{r}
hiv.averted.stats <- daly.results.treatment %>% 
  filter(Age >=15, Year >= 2025) %>%
  group_by(scenario_name, sim.ix) %>% 
  summarize(Died_from_HIV = sum(Died_from_HIV * pop_scaling_factor),
            Newly.Infected = sum(Newly.Infected * pop_scaling_factor), 
            Depression.episodes = sum((CMD_Incidence2 + CMD_Relapse2) * pop_scaling_factor),
            .groups = 'drop_last') %>% 
  ungroup()

hiv.averted.stats <- hiv.averted.stats %>% 
  merge(
    hiv.averted.stats %>% 
      filter(scenario_name == 'baseline') %>% 
      select(sim.ix, 
             Died_from_HIV.baseline = Died_from_HIV, 
             Newly.Infected.baseline = Newly.Infected,
             Depression.episodes.baseline = Depression.episodes), 
    by = c("sim.ix")
  ) %>% 
  mutate(
    Died_from_HIV.averted = Died_from_HIV.baseline - Died_from_HIV,
    Newly.Infected.averted = Newly.Infected.baseline - Newly.Infected,
    Depression.episodes.averted = Depression.episodes.baseline - Depression.episodes
    ) %>% 
  mutate(
    Died_from_HIV.averted.pct = Died_from_HIV.averted/Died_from_HIV.baseline,
    Newly.Infected.averted.pct = Newly.Infected.averted/Newly.Infected.baseline,
    Depression.episodes.averted.pct = Depression.episodes.averted/Depression.episodes.baseline
  )



metric.names = c(
  "Died_from_HIV.averted",
  "Died_from_HIV.averted.pct",
  "Newly.Infected.averted",
  "Newly.Infected.averted.pct",
  "Depression.episodes.averted",
  "Depression.episodes.averted.pct"
)

scenario_names = hiv.averted.stats$scenario_name %>% unique 

metrics = data.frame()

for (i in metric.names){
  for (j in scenario_names) {
    
    #print(c(i,j))
    h <- calculate.CI.by.metric(
      data = hiv.averted.stats, 
      scenario.name = j,
      metric = i)
    
    metrics = rbind(metrics, h)
  }
}

HIV.Depression.Averted.Data <- metrics

```

```{r}
hiv.averted.stats %>% View
```


```{r}
HIV.Depression.Averted.Data
```


## Depression prevalence over time

```{r}
cmd.prev.time.data <- daly.results.treatment %>% 
  mutate(Year = ceiling(Year)) %>% 
  filter(Age >= 15) %>% 
  group_by(Year, Gender, scenario_name, IP_Key.CMDStatus, sim.ix) %>% 
  summarize(Population = sum(Population* pop_scaling_factor), .groups = 'drop_last') %>% 
  pivot_wider(
    id_cols = c(Year, Gender, scenario_name, sim.ix) , 
    values_from = c(Population), 
    names_from = c(IP_Key.CMDStatus)
  ) %>% 
  mutate(Population = CMD_neg + CMD_pos + CMD_recovered + CMD_treated) %>% 
  mutate(CMD.prev = CMD_pos/Population) %>% 
  group_by(Year, Gender, scenario_name) %>% 
  summarize(
    CMD.prev = mean(CMD.prev), 
    Population = mean(Population), 
    CMD_neg = mean(CMD_neg), 
    CMD_pos = mean(CMD_pos), 
    CMD_recovered = mean(CMD_recovered), 
    CMD_treated = mean(CMD_treated), 
    .groups = 'drop_last') %>%
  mutate(Gender = case_when(Gender==0 ~ "Male", Gender==1 ~ "Female"))

p <- ggplot() + 
    geom_line(data= cmd.prev.time.data %>% filter(Year > 1985),
              aes(x=Year, y=CMD.prev, group=scenario_name, color=scenario_name), linewidth=.5) +
    facet_wrap(~ Gender, ncol=2) +
    theme_bw(base_size=16) +
    guides(color = guide_legend(ncol = 2, byrow = TRUE, keywidth = 2, keyheight = 1)) +
    theme(legend.position="top", legend.text=element_text(size=10)) +
    scale_x_continuous(breaks = seq(1985,2050,10)) +
    theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
    theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
    #scale_y_continuous(labels = scales::percent_format(accuracy = 1), breaks = seq(0,0.25,0.05), limits=c(0, 0.25)) +
    #ylab("HIV Prevalence (%)") +
    scale_color_manual(values=c("blue","red","darkgreen","orange","black","purple", "pink"))

p
```

## Depression episodes over time

```{r}
p <- ggplot() + 
    geom_line(data= cmd.prev.time.data %>% filter(Year > 1985),
              aes(x=Year, y=CMD_pos, group=scenario_name, color=scenario_name), linewidth=.5) +
    facet_wrap(~ Gender, ncol=2) +
    theme_bw(base_size=16) +
    guides(color = guide_legend(ncol = 2, byrow = TRUE, keywidth = 2, keyheight = 1)) +
    theme(legend.position="top", legend.text=element_text(size=10)) +
    scale_x_continuous(breaks = seq(1985,2050,10)) +
    theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
    theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
    #scale_y_continuous(labels = scales::percent_format(accuracy = 1), breaks = seq(0,0.25,0.05), limits=c(0, 0.25)) +
    #ylab("HIV Prevalence (%)") +
    scale_color_manual(values=c("blue","red","darkgreen","orange","black","purple", "pink"))

p
```


## HIV-related DALYs

```{r}
# Gotta remember to loop over sim.ix

DALYs <- EMODAnalyzeR::calculate.DALY(
  daly.results.treatment %>% filter(scenario_name == "baseline"),
  discount_start_year = 2025
)
DALYs$scenario_name <-  "baseline"

DALYs.art <- EMODAnalyzeR::calculate.DALY(
  daly.results.treatment %>% filter(scenario_name == "art"),
  discount_start_year = 2025
)
DALYs.art$scenario_name <- "art"

DALYs.uni <- EMODAnalyzeR::calculate.DALY(
  daly.results.treatment %>% filter(scenario_name == "uni"),
  discount_start_year = 2025
)
DALYs.uni$scenario_name <- "uni"

DALYs.neutral.annual <- EMODAnalyzeR::calculate.DALY(
  daly.results.treatment %>% filter(scenario_name == "neutral.annual"),
  discount_start_year = 2025
)
DALYs.neutral.annual$scenario_name <- "neutral.annual"

DALYs.neutral.testing <- EMODAnalyzeR::calculate.DALY(
  daly.results.treatment %>% filter(scenario_name == "neutral.testing"),
  discount_start_year = 2025
)
DALYs.neutral.annual$scenario_name <- "neutral.testing"


DALYs.neutral.annual

```

```{r}
data <- daly.results.treatment

data_by_age_year <- data %>%
  dplyr::group_by(Year, Age, sim.ix, scenario_name) %>%
  dplyr::summarise(
    Died_from_HIV = sum(Died_from_HIV),
     Infected = sum(Infected),
     On_ART = sum(On_ART),
     pop_scaling_factor = mean(pop_scaling_factor),
     .groups = "drop_last"
   )

data_by_age_year$Year_Integer <- floor((data_by_age_year$Year-0.5))

m2 <- data_by_age_year %>%
        dplyr::group_by(Year_Integer, Age, sim.ix, scenario_name) %>%
        dplyr::summarise(
          Died_from_HIV = sum(Died_from_HIV),
          Infected = mean(Infected),
          On_ART = mean(On_ART),
          pop_scaling_factor = mean(pop_scaling_factor),
          .groups = "drop_last"
         )

m2 <- m2 %>%
        mutate(On_ART_calib = On_ART*pop_scaling_factor,
        Infected_calib = Infected*pop_scaling_factor,
        Died_from_HIV_calib = Died_from_HIV*pop_scaling_factor,
        Infected_off_ART_calib = (Infected - On_ART)*pop_scaling_factor)

life_expectancy = 80
m2$Age <- ifelse(m2$Age >life_expectancy, life_expectancy, m2$Age)

m3 <- m2 %>%
      dplyr::group_by(Year_Integer, Age, scenario_name, sim.ix) %>%
      dplyr::select(Year_Integer, Age, scenario_name, sim.ix, 
                    Died_from_HIV_calib, Infected_off_ART_calib, On_ART_calib) %>%
      dplyr::summarise_all(list(median=median))

disability.tibble <- m3 %>%
  dplyr::group_by(Year_Integer, scenario_name, sim.ix) %>%
  dplyr::summarize(
    infected_untreated = sum(Infected_off_ART_calib_median),
    on_art = sum(On_ART_calib_median)
    ) %>%
  dplyr::rename(year = Year_Integer)

m4 <- m3 %>% mutate(year_applied = Year_Integer - (Age - (life_expectancy + 1)))


daly.tibble <- merge(
  tibble(scenario_name_ = scenario_names),
  tibble(
    year = seq(min(m4$Year_Integer), max(m4$Year_Integer))
  ),
  all = TRUE
) %>% 
  merge(  tibble(sim.ix = seq(1,10)), all=TRUE)

daly_expanded <- tibble(
    year = seq(min(m4$Year_Integer), max(m4$Year_Integer))
  ) %>% 
  crossing(
    sim.ix = unique(m4$sim.ix),
    scenario_name = unique(m4$scenario_name)
  )

yll <- daly_expanded %>%
  left_join(m4, by = c("sim.ix", "scenario_name")) %>%
  filter(Year_Integer <= year, year_applied > year) %>%
  group_by(year, sim.ix, scenario_name) %>%
  summarize(
    yll = sum(Died_from_HIV_calib_median, na.rm = TRUE),
    .groups = "drop"
  )

daly = left_join(
  yll, 
  disability.tibble, 
  by=c("year", "sim.ix", "scenario_name")
  ) %>%
 replace(is.na(.), 0)

discount_percent = 0.03
discount_start_year = 2025
infected_weight = 0.274
art_weight = 0.078

daly <- daly %>% mutate(daly = infected_untreated*infected_weight + on_art*art_weight + yll)
daly <- daly %>% mutate(discount_factor = (1 - discount_percent)^(year - discount_start_year) )
daly[daly$year < discount_start_year,'discount_factor'] <- 1.0
daly <- daly %>% mutate(daly_future_discounted = daly*discount_factor )

daly

```


### HIV-related DALYs averted

```{r}
HIV.DALYs.averted <- daly %>% 
  filter(year >= 2025) %>% 
  group_by(sim.ix, scenario_name) %>% 
  summarize(HIV.DALY = sum(daly_future_discounted),
            .groups = 'drop_last')

HIV.DALYs.averted <- HIV.DALYs.averted %>% 
  merge(
    HIV.DALYs.averted %>% 
      filter(scenario_name == 'baseline') %>% 
      select(sim.ix, HIV.DALY.baseline = HIV.DALY),
    by = c("sim.ix")
  ) %>% 
  mutate(HIV.DALY.averted = HIV.DALY.baseline - HIV.DALY)

HIV.DALYs.averted
```

### Calculate CIs

I am going to do this with three methods:
1. Good old fashioned Lower/Upper_CI calculations using SE
2. Bootstrapping
3. Something with median and percentiles

#### lower/upper CI

```{r}
HIV.DALYs.averted %>% 
  group_by(scenario_name) %>% 
  summarize(se = sd(HIV.DALY.averted), HIV.DALY.averted = mean(HIV.DALY.averted),
            .groups = 'drop_last') %>% 
  mutate(
    HIV.DALY.averted.lb = lower_ci(HIV.DALY.averted, se, 250, conf_level = 0.95),
    HIV.DALY.averted.ub = upper_ci(HIV.DALY.averted, se, 250, conf_level = 0.95)
      )
```


#### Bootstrapping
```{r}
bt_resamples <- bootstraps(HIV.DALYs.averted %>% filter(scenario_name == "art"), times = 250)
  
bt_resamples$mean.metric <- map_dbl(bt_resamples$splits, bt_mean, "HIV.DALY.averted")

bt_resamples$mean.metric %>% summary
  
```

```{r}
# Number of bootstrap samples
B <- 250

# Bootstrap resampling and mean calculation using map_dbl
bootstrap_means <- map_dbl(1:B, ~mean(sample(HIV.DALYs.averted[HIV.DALYs.averted$scenario_name == 'art',]$HIV.DALY.averted, replace = TRUE)))

# Calculate 95% confidence interval
ci <- quantile(bootstrap_means, probs = c(0.025, 0.975))

# Results
cat("Bootstrap Mean:", mean(bootstrap_means), "\n", "95% Confidence Interval:", ci, "\n")
```

```{r}
# Number of bootstrap samples
B <- 250

# Bootstrap resampling and mean calculation using map_dbl
bootstrap_means <- map_dbl(1:B, ~mean(sample(HIV.DALYs.averted[HIV.DALYs.averted$scenario_name == 'art.ceta',]$HIV.DALY.averted, replace = TRUE)))

# Calculate 95% confidence interval
ci <- quantile(bootstrap_means, probs = c(0.025, 0.975))

# Results
cat("Bootstrap Mean:", mean(bootstrap_means), "\n", "95% Confidence Interval:", ci, "\n")
```



```{r}
HIV.DALYs.averted.CI <- data.table()

for (i in scenario_names){
  h <- calculate.CI.by.metric(
    data = HIV.DALYs.averted,
    scenario.name = i,
    metric = "HIV.DALY"
  )
  
  HIV.DALYs.averted.CI = rbind(HIV.DALYs.averted.CI, h)
}

for (i in scenario_names){
  h <- calculate.CI.by.metric(
    data = HIV.DALYs.averted,
    scenario.name = i,
    metric = "HIV.DALY.averted"
  )
  
  HIV.DALYs.averted.CI = rbind(HIV.DALYs.averted.CI, h)
}

HIV.DALYs.averted.CI
```


## Depression-related DALYs

```{r}
daly.results.treatment %>% 
  filter(Year == floor(Year)) %>% 
  group_by(Year, sim.ix, scenario_name) %>% 
  summarize(Infected = sum(Infected * pop_scaling_factor)) %>% 
  group_by(Year, scenario_name) %>% 
  summarize(Infected = mean(Infected))
```


```{r}
Depression.DALYs <- daly.results.treatment %>% 
  filter(IP_Key.CMDStatus == "CMD_pos") %>% 
  mutate(Year_Integer = floor(Year-0.5)) %>% 
  group_by(Year_Integer, sim.ix, scenario_name) %>% 
  summarize(Depressed = sum(Population * pop_scaling_factor), .groups = 'drop_last') %>% 
  ungroup()

Depression.DALYs <- Depression.DALYs %>% 
  mutate(discount_factor = (1 - 0.03)^(pmax(Year_Integer - 2025, 0)) ) %>% 
  mutate(Depression.YLD = Depressed/2) %>% 
  mutate(Depression.DALY = 0.396*Depression.YLD*discount_factor/2)

Depression.DALYs.averted <- Depression.DALYs %>% 
  filter(Year_Integer >= 2025) %>% 
  group_by(sim.ix, scenario_name) %>% 
  summarize(Depression.DALY = sum(Depression.DALY), .groups = 'drop_last') %>% 
  merge(
    Depression.DALYs %>% 
      filter(Year_Integer >= 2025, scenario_name == "baseline") %>% 
      group_by(sim.ix) %>% 
      summarize(Depression.DALY.baseline = sum(Depression.DALY)),
    by = c("sim.ix")
  ) %>% 
  mutate(
    Depression.DALY.averted = Depression.DALY.baseline - Depression.DALY
  )

Depression.DALYs.averted
```

Adding error bars
```{r}
Depression.DALYs.averted.CI <- data.frame()

for (i in scenario_names){
  h <- calculate.CI.by.metric(
    data = Depression.DALYs.averted,
    scenario.name = i,
    metric = "Depression.DALY"
  )
  
  Depression.DALYs.averted.CI = rbind(Depression.DALYs.averted.CI, h)
}

for (i in scenario_names){
  h <- calculate.CI.by.metric(
    data = Depression.DALYs.averted,
    scenario.name = i,
    metric = "Depression.DALY.averted"
  )
  
  Depression.DALYs.averted.CI = rbind(Depression.DALYs.averted.CI, h)
}

Depression.DALYs.averted.CI

```

## Count number of depression treatments

Also calculate error bars on this because why not

```{r}
cmdtreat.count <- daly.results.treatment %>% 
  mutate(Year = ceiling(Year)) %>% 
  filter(Year >= 2025) %>% 
  group_by(Year, scenario_name, sim.ix) %>% 
  summarize(CMD_Treat = sum(CMD_Treat_staging*pop_scaling_factor), .groups = 'drop_last')

cmdtreat.count

CMD.Treatment.CI <- data.frame()

for (i in scenario_names){
  h <- calculate.CI.by.metric(
    data = cmdtreat.count,
    scenario.name = i,
    metric = "CMD_Treat"
  )
  
  CMD.Treatment.CI = rbind(CMD.Treatment.CI, h)
}

CMD.Treatment.CI
```

## ICER calculation

Dollars per DALY averted

```{r}
# cmdtreat.count <- daly.results.treatment %>% 
#   mutate(Year = ceiling(Year)) %>% 
#   filter(Year >= 2020) %>% 
#   group_by(scenario_name, sim.ix) %>% 
#   summarize(CMD_Treat = sum(CMD_Treat_staging*pop_scaling_factor), .groups = 'drop_last')

# Join together DALYs and Treatments administered
ICER.calculation <- merge(
  HIV.DALYs.averted,
  daly.results.treatment %>% 
    filter(Year >= 2025) %>%
    group_by(sim.ix, scenario_name) %>% 
    summarize(CMD_Treatment = sum(CMD_Treat_staging*pop_scaling_factor*14), .groups = 'drop_last'),
  by = c("sim.ix", "scenario_name")
) %>% 
  mutate(ICER = case_when(
    HIV.DALY.averted != 0 ~ CMD_Treatment/HIV.DALY.averted,
    HIV.DALY.averted == 0 ~ 0))

ICER.calculation.CI <- data.frame()

for (i in scenario_names){
  h <- calculate.CI.by.metric(
    data = ICER.calculation,
    scenario.name = i,
    metric = "ICER"
  )
  
  ICER.calculation.CI = rbind(ICER.calculation.CI, h)
}

calculate.CI.by.metric(
    data = ICER.calculation,
    scenario.name = scenario_names[[2]],
    metric = "ICER"
  )

ICER.calculation.CI

```

```{r}
ICER.calculation %>% filter(scenario_name == "neutral.annual")%>% .$HIV.DALY.averted %>% summary

```

```{r}
h <- calculate.CI.by.metric(
    data = ICER.calculation,
    scenario.name = "neutral.annual",
    metric = "HIV.DALY.averted"
  )

h

ICER.calculation %>% filter(scenario_name == "neutral.annual") %>% .$ICER %>% summary

ICER.calculation %>% filter(scenario_name == "neutral.annual") %>% .$HIV.DALY.averted %>% summary


```




## ART costs per scenario

Are we actually saving any money on ART in any of the scenarios?
One of the things that's perverse about this metric is how if fewer PLHIV are alive there are fewer people on ART

Count person years on ART

```{r}
pyoart.data <- daly.results.treatment %>% 
  mutate(Year = floor(Year)) %>%
  group_by(Year, scenario_name, sim.ix) %>% 
  summarize(On_ART = sum(On_ART * pop_scaling_factor)/2, .groups = 'drop_last') %>% 
  group_by(Year, scenario_name) %>% 
  summarize(On_ART = mean(On_ART), .groups = 'drop_last')

pyoart.data %>% 
  merge(
    pyoart.data %>%
      filter(scenario_name == "baseline") %>% 
      rename(On_ART_baseline = On_ART) %>% dplyr::select(Year, On_ART_baseline),
    by = c("Year")
  ) %>% 
  mutate(On_ART.averted = On_ART - On_ART_baseline) %>%
  #filter(Year == 2025) %>% 
  group_by(scenario_name) %>% 
  summarize(On_ART.averted = sum(On_ART.averted))

```



## Save your work

```{r}
rbind(HIV.DALYs.averted.CI, Depression.DALYs.averted.CI, CMD.Treatment.CI) %>% View

impact.DALYs.averted <- rbind(
  HIV.DALYs.averted.CI, 
  Depression.DALYs.averted.CI, 
  CMD.Treatment.CI)

write_csv(
  rbind(impact.DALYs.averted),
  file = "impact_DALY_calculated.csv"
)

impact.DALYs.averted <- read_csv("impact_DALY_calculated.csv")

write_csv(
  HIV.Depression.Averted.Data,
  file = "impact_HIV_Depression_averted.csv"
)
```

# Make plots

## Impact of treatment

### Version 1: Annual treatment for people in the testing loop

```{r}
plot.averted <- HIV.Depression.Averted.Data %>% 
  filter(
    (scenario_name != "neutral.testing") & 
    (scenario_name != "baseline")) %>% 
  filter(metric %in% c("Died_from_HIV.averted.pct", 
                       "Newly.Infected.averted.pct",
                       "Depression.episodes.averted.pct")) %>% 
  # mutate(
  #   mutate(scenario_ix = case_match(scenario_name, ) %>% 
  #     
  #   )
  # )
  ggplot() +
  # geom_bar(mapping = aes(x = metric, y = metric.mean*100, fill = factor(scenario_name)),
  #          position=position_dodge2(reverse = TRUE, padding = 0), 
  #          stat = "identity",
  #          show.legend = TRUE) + 
  # geom_errorbar(mapping = aes(x = metric, 
  #                             ymin = metric.lb*99.5, ymax = metric.ub*100),
  #               position=position_dodge2(reverse = TRUE, padding = .25), 
  #               stat = "identity",
  #               size = 1, color = "black",
  #               show.legend = FALSE) + 
  
  geom_bar(mapping = aes(x = metric, y = metric.mean * 100, fill = factor(scenario_name)),
           position = position_dodge2(reverse = TRUE, padding = 0), 
           stat = "identity",
           show.legend = TRUE) + 
  geom_errorbar(mapping = aes(x = metric, 
                              ymin = metric.lb * 99.5, ymax = metric.ub * 100,
                              group = factor(scenario_name)),
                position = position_dodge2(reverse = TRUE, padding = .25), 
                stat = "identity",
                size = 1, color = "black",
                show.legend = FALSE) + 

  scale_y_continuous(breaks = seq(0,20,5), 
                     labels = c("0%", "5%", "10%", "15%", "20%"), 
                     expand = expansion(mult = c(0.00,.1))) +
  scale_fill_manual("", values = c("#00671F", "#FF6600", "#0004E7", "red", "purple"),
                    breaks = c("uni", "neutral.annual", "art", "art.ceta", "art.neutral"), 
                    labels = c("Universal", "HIV Testing   ", "ART", "CETA", "ART & HIV Testing")) + 
  scale_x_discrete(
    breaks=c("Depression.episodes.averted.pct",
             "Died_from_HIV.averted.pct", 
             "Newly.Infected.averted.pct"),
    labels=c("Depression Episodes\nAverted",
             "HIV Deaths\nAverted", 
             "HIV Infections\nAverted")) + 
  theme_minimal() + theme_bw() +
  theme(panel.grid = element_blank(),
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        #axis.text.x = element_blank(),
        legend.position = "top")

plot.averted

```
Compare the above against number of treatments administered:
```{r}

impact.DALYs.averted  %>% 
  filter(
    (scenario_name != "neutral.testing") & 
    (scenario_name != "baseline")) %>% 
  filter(metric %in% c("CMD_Treat")) %>% 
  ggplot() +
  # geom_bar(mapping = aes(x = metric, y = metric.mean*100, fill = factor(scenario_name)),
  #          position=position_dodge2(reverse = TRUE, padding = 0), 
  #          stat = "identity",
  #          show.legend = TRUE) + 
  # geom_errorbar(mapping = aes(x = metric, 
  #                             ymin = metric.lb*99.5, ymax = metric.ub*100),
  #               position=position_dodge2(reverse = TRUE, padding = .25), 
  #               stat = "identity",
  #               size = 1, color = "black",
  #               show.legend = FALSE) + 
  
  geom_bar(mapping = aes(x = metric, y = metric.mean * 100, fill = factor(scenario_name)),
           position = position_dodge2(reverse = TRUE, padding = 0), 
           stat = "identity",
           show.legend = TRUE) + 
  geom_errorbar(mapping = aes(x = metric, 
                              ymin = metric.lb * 99.5, ymax = metric.ub * 100,
                              group = factor(scenario_name)),
                position = position_dodge2(reverse = TRUE, padding = .25), 
                stat = "identity",
                size = 1, color = "black",
                show.legend = FALSE) + 

  scale_y_continuous(breaks = seq(0,20,5), 
                     labels = c("0%", "5%", "10%", "15%", "20%"), 
                     expand = expansion(mult = c(0.00,.1))) +
  scale_fill_manual("", values = c("#00671F", "#FF6600", "#0004E7", "red", "purple"),
                    breaks = c("uni", "neutral.annual", "art", "art.ceta", "art.neutral"), 
                    labels = c("Universal", "HIV Testing   ", "ART", "CETA", "ART & HIV Testing")) + 
  scale_x_discrete(
    breaks=c("Depression.episodes.averted.pct",
             "Died_from_HIV.averted.pct", 
             "Newly.Infected.averted.pct"),
    labels=c("Depression Episodes\nAverted",
             "HIV Deaths\nAverted", 
             "HIV Infections\nAverted")) + 
  theme_minimal() + theme_bw() +
  theme(panel.grid = element_blank(),
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        #axis.text.x = element_blank(),
        legend.position = "top")
```


## ICER curves

### ICER for HIV DALYs
```{r}
impact.pivot <- impact.DALYs.averted %>% 
  filter(scenario_name != "neutral.testing") %>% 
  filter(metric %in% c("HIV.DALY.averted", "Depression.DALY.averted", "CMD_Treat")) %>%
  # mutate(scenario_id = case_match(
  #   scenario_name, 
  #   "baseline" ~ "", "uni" ~ "Universal", 
  #   "neutral.annual" ~ "HIV Testing", 
  #   "art" ~ "ART",
  #   "art.ceta" ~ "CETA",
  #   "art.neutral" ~ "ART & HIV Testing")) %>% 
  pivot_wider(
    id_cols = scenario_name,
    names_from = metric,
    values_from = c("metric.mean", "metric.lb", "metric.ub")
  )

plot.HIV.ICER <-  ggplot() + 
  geom_errorbar(
    data = impact.pivot %>% filter(scenario_name != 'baseline'),
    mapping = aes(x = metric.mean_CMD_Treat*14/1e6,
                  ymin = metric.lb_HIV.DALY.averted, 
                  ymax = metric.ub_HIV.DALY.averted),
    width = .25
    ) +
  geom_line(
    data = impact.pivot %>% 
      filter(scenario_name %in% c("baseline", "art.ceta", "art", "uni")),
    mapping = aes(x = metric.mean_CMD_Treat*14/1e6, 
                  y = metric.mean_HIV.DALY.averted)) + 
  geom_point(
    data = impact.pivot,
    mapping = aes(
      x = metric.mean_CMD_Treat*14/1e6,
      y = metric.mean_HIV.DALY.averted,
      color = scenario_name), 
    show.legend = TRUE, size = 3) + 
  scale_color_manual("", values = c("black", "#00671F", "#FF6600", "#0004E7", "red", "purple"),
                    breaks = c("baseline",  "uni", "neutral.annual", "art", "art.ceta", "art.neutral"), 
                    labels = c("Baseline", "Universal", "HIV Testing   ", "ART", "CETA", "ART & HIV Testing")) + 
  scale_x_continuous("Incremental Costs (Million USD)") + 
  scale_y_continuous("Incremental HIV-Related DALYs") + 
  theme_minimal() + theme_bw() +
  theme(panel.grid = element_blank(),
        #axis.title.x = element_blank(),
        #axis.text.x = element_blank(),
        plot.title = element_text(hjust = 0.5),
        text = element_text(family = "sans"))

plot.HIV.ICER  
```


```{r}
plot.DEP.ICER <-  ggplot() + 
  geom_errorbar(
    data = impact.pivot %>% filter(scenario_name != 'baseline'),
    mapping = aes(x = metric.mean_CMD_Treat*14/1e6,
                  ymin = metric.lb_Depression.DALY.averted, 
                  ymax = metric.ub_Depression.DALY.averted),
    width = .5
    ) +
  geom_line(
    data = impact.pivot %>% filter(scenario_name %in% c("baseline", "art.ceta", "uni")),
    mapping = aes(y = metric.mean_Depression.DALY.averted,
                  x = metric.mean_CMD_Treat*14/1e6)) +
  geom_point(
    data = impact.pivot,
    mapping = aes(
      x = metric.mean_CMD_Treat*14/1e6,
      y = metric.mean_Depression.DALY.averted,
      color = scenario_name), 
    show.legend = TRUE, size = 3) + 
  scale_color_manual("", values = c("black", "#00671F", "#FF6600", "#0004E7", "red", "purple"),
                    breaks = c("baseline",  "uni", "neutral.annual", "art", "art.ceta", "art.neutral"), 
                    labels = c("Baseline", "Universal", "HIV Testing   ", "ART", "CETA", "ART & HIV Testing")) + 
  scale_x_continuous("Incremental Costs (Million USD)") + 
  scale_y_continuous("Incremental Depression-Related DALYs") + 
  theme_minimal() + theme_bw() +
  theme(panel.grid = element_blank(),
        #axis.title.x = element_blank(),
        #axis.text.x = element_blank(),
        plot.title = element_text(hjust = 0.5),
        text = element_text(family = "sans"))

plot.DEP.ICER  
```
### ICER of combined HIV and DEP

```{r}
plot.HIV.DEP.ICER <- ggplot() + 
  geom_errorbar(
    data = impact.pivot %>% filter(scenario_name != 'baseline'),
    mapping = aes(x = metric.mean_CMD_Treat*14/1e6,
                  ymin = metric.lb_Depression.DALY.averted + metric.mean_HIV.DALY.averted,
                  ymax = metric.ub_Depression.DALY.averted + metric.mean_HIV.DALY.averted),
    width = .5
    ) +
  geom_line(
    data = impact.pivot %>% filter(scenario_name %in% c("baseline", "art.ceta", "uni")),
    mapping = aes(
      x = metric.mean_CMD_Treat*14/1e6,
      y = metric.mean_Depression.DALY.averted + metric.mean_HIV.DALY.averted)) +
  geom_point(
    data = impact.pivot,
    mapping = aes(
      x = metric.mean_CMD_Treat*14/1e6,
      y = metric.mean_Depression.DALY.averted + metric.mean_HIV.DALY.averted,
      color = scenario_name), 
    show.legend = TRUE, size = 3) + 
  scale_color_manual("", values = c("black", "#00671F", "#FF6600", "#0004E7", "red", "purple"),
                    breaks = c("baseline",  "uni", "neutral.annual", "art", "art.ceta", "art.neutral"), 
                    labels = c("Baseline", "Universal", "HIV Testing   ", "ART", "CETA", "ART & HIV Testing")) + 
  scale_x_continuous("Incremental Costs (Million USD)") + 
  scale_y_continuous("Incremental Depression-Related DALYs") + 
  theme_minimal() + theme_bw() +
  theme(panel.grid = element_blank(),
        #axis.title.x = element_blank(),
        #axis.text.x = element_blank(),
        plot.title = element_text(hjust = 0.5),
        text = element_text(family = "sans"))

plot.HIV.DEP.ICER
```


### Save Plots

```{r}
ggsave("impact_HIV_DALY_ICER.pdf", plot.HIV.ICER,
       width = 8, height = 4, units = 'in')

ggsave("impact_DEP_DALY_ICER.pdf", plot.DEP.ICER,
       width = 8, height = 4, units = 'in')

ggsave("impact_HIV_DEP_DALY_ICER.pdf", plot.HIV.DEP.ICER, 
       width = 8, height = 4, units = 'in')

ggsave("impact_averted.pdf", plot.averted,
       width = 8, height = 4, units = 'in')
```

