---
title: "treatment_effects.Rmd"
output: html_document
---


```{r Load Libraries}
library(tidyverse)
library(tidyr)
library(data.table)
library(magrittr)
library(ggplot2)
library(devtools)
library(readxl)
devtools::install_github("BershteynLab/EMODAnalyzeR")
```

```{r}
CENSUS_YEAR = 2009
KEN_CENSUS_POP = 5352385
```


```{r}
# Confidence interval functions
lower_ci <- function(mean, se, n, conf_level = 0.95){
  lower_ci <- mean - qt(1 - ((1 - conf_level) / 2), n - 1) * se
  return(lower_ci)
}
upper_ci <- function(mean, se, n, conf_level = 0.95){
  upper_ci <- mean + qt(1 - ((1 - conf_level) / 2), n - 1) * se
  return(upper_ci)
}
```


# HIV-Depression model postprocessing

The "minimal scenario" set of HIV-CMD interactions
1. Depression dynamics
  1. Age/sex-specific annual incidence of depression
  2. HIV+ status also increases depression incidence
  3. Relapse rate equal to incidence rate
2. Depression-caused increase to incidence - CoitalActRiskFactor increases from 1 to 1.646
3. Depression-caused delays to diagnosis (2/3 of depressed skip diagnosis)
4. Depression-caused dropout from ART (mean time 5 years for depressed, 10 years for non-depressed)
5. Depression-caused non-adherence to ART

We are going to compare the minimal scenario against a number of scenarios where treatment is implemented:

1. Minimal scenario, as described above
2. treat_uni - Universal testing and treatment of all people with depression
3. treat_screen - Testing and treatment for people who are screened for HIV
4. treat_uni_decouple - Universal testing and treatment with HIV and CMD decoupled from one another
5. treat_screen_decouple - Testing/treatment for people who are screened for HIV, with HIV and CMD decoupled from one another

# Read in the data

## Minimal scenario

```{r}
sim.results.minimal <- EMODAnalyzeR::read.simulation.results(
  results_path = "/gpfs/data/bershteynlab/EMOD/citrod01/MATUMAINI/202301_Nyanza_MATUMAINI_MalariaOngoing/treatment/Baseline-campaign_MATUMAINI_202305-baseline/ReportHIVByAgeAndGender/",
  scenario_name = 'baseline',
  summarize_columns = c("Population","Infected", "On_ART",
                        "Died", "Died_from_HIV",
                        "Newly.Infected","Diagnosed"),
  stratify_columns = c("Year", "Gender", "Age", "IP_Key.CMDStatus"),
  min_age_inclusive = 0,
  max_age_inclusive = 99
)

sim.results.pop.scaling <- sim.results.minimal %>% 
      filter(Year == CENSUS_YEAR) %>%
      group_by(sim.id) %>%
      summarize(total.pop = sum(Population), .groups = 'keep') %>% 
      mutate(pop.scaling.factor = KEN_CENSUS_POP/total.pop)

sim.results.minimal <- sim.results.minimal %>% 
  inner_join(
    sim.results.pop.scaling,
    by = c("sim.id")
  )
```

## Universal Test and Treat

```{r}
 sim.results.uni.tt <- EMODAnalyzeR::read.simulation.results(
  results_path = "/gpfs/data/bershteynlab/EMOD/citrod01/MATUMAINI/202301_Nyanza_MATUMAINI_MalariaOngoing/treatment/Baseline-campaign_MATUMAINI_202305-treat_uni/ReportHIVByAgeAndGender/",
  scenario_name = 'uni.tt',
  summarize_columns = c("Population","Infected", "On_ART",
                        "Died", "Died_from_HIV",
                        "Newly.Infected","Diagnosed"),
  stratify_columns = c("Year", "Gender", "Age", "IP_Key.CMDStatus"),
  min_age_inclusive = 0,
  max_age_inclusive = 99
)

sim.results.pop.scaling <- sim.results.uni.tt %>% 
      filter(Year == CENSUS_YEAR) %>%
      group_by(sim.id) %>%
      summarize(total.pop = sum(Population), .groups = 'keep') %>% 
      mutate(pop.scaling.factor = KEN_CENSUS_POP/total.pop)

sim.results.uni.tt <- sim.results.uni.tt %>% 
  inner_join(
    sim.results.pop.scaling,
    by = c("sim.id")
  )

```

## Minimal scanrio - Decoupled

```{r}
sim.results.base.decouple <- EMODAnalyzeR::read.simulation.results.bigpurple(
  experiment_path = "/gpfs/scratch/citrod01/experiments/MATUMAINI/Baseline-campaign_MATUMAINI_202305_decouple-baseline_decouple___2023_10_22_20_34_04_176287",
    scenario_name = 'uni.decouple',
  summarize_columns = c("Population","Infected", "On_ART",
                        "Died", "Died_from_HIV",
                        "Newly.Infected","Diagnosed"),
  stratify_columns = c("Year", "Gender", "Age", "IP_Key.CMDStatus"),
  min_age_inclusive = 0,
  max_age_inclusive = 99
)

sim.results.pop.scaling <- sim.results.base.decouple %>% 
      filter(Year == CENSUS_YEAR) %>%
      group_by(sim.id) %>%
      summarize(total.pop = sum(Population), .groups = 'keep') %>% 
      mutate(pop.scaling.factor = KEN_CENSUS_POP/total.pop)

sim.results.base.decouple <- sim.results.base.decouple %>% 
  inner_join(
    sim.results.pop.scaling,
    by = c("sim.id")
  )

```


## Universal Test and Treat - Decoupled

```{r}
 sim.results.uni.decouple <- EMODAnalyzeR::read.simulation.results(
  results_path = "/gpfs/data/bershteynlab/EMOD/citrod01/MATUMAINI/202301_Nyanza_MATUMAINI_MalariaOngoing/treatment/Baseline-campaign_MATUMAINI_202305_decouple-treat_uni_decouple/ReportHIVByAgeAndGender/",
  scenario_name = 'uni.decouple',
  summarize_columns = c("Population","Infected", "On_ART",
                        "Died", "Died_from_HIV",
                        "Newly.Infected","Diagnosed"),
  stratify_columns = c("Year", "Gender", "Age", "IP_Key.CMDStatus"),
  min_age_inclusive = 0,
  max_age_inclusive = 99
)

sim.results.pop.scaling <- sim.results.uni.decouple %>% 
      filter(Year == CENSUS_YEAR) %>%
      group_by(sim.id) %>%
      summarize(total.pop = sum(Population), .groups = 'keep') %>% 
      mutate(pop.scaling.factor = KEN_CENSUS_POP/total.pop)

sim.results.uni.decouple <- sim.results.uni.decouple %>% 
  inner_join(
    sim.results.pop.scaling,
    by = c("sim.id")
  )
```


## Screening upon HIV diagnosis

```{r}
 sim.results.screen.tt <- EMODAnalyzeR::read.simulation.results(
  results_path = "/gpfs/data/bershteynlab/EMOD/citrod01/MATUMAINI/202301_Nyanza_MATUMAINI_MalariaOngoing/treatment/Baseline-campaign_MATUMAINI_202305_screening-treat_screen/ReportHIVByAgeAndGender/",
  scenario_name = 'screen.tt',
  summarize_columns = c("Population","Infected", "On_ART",
                        "Died", "Died_from_HIV",
                        "Newly.Infected","Diagnosed"),
  stratify_columns = c("Year", "Gender", "Age", "IP_Key.CMDStatus"),
  min_age_inclusive = 0,
  max_age_inclusive = 99
)

sim.results.pop.scaling <- sim.results.screen.tt %>% 
      filter(Year == CENSUS_YEAR) %>%
      group_by(sim.id) %>%
      summarize(total.pop = sum(Population), .groups = 'keep') %>% 
      mutate(pop.scaling.factor = KEN_CENSUS_POP/total.pop)

sim.results.screen.tt <- sim.results.screen.tt %>% 
  inner_join(
    sim.results.pop.scaling,
    by = c("sim.id")
  )



```

## Combine datasets

```{r}
sim.results.all <- rbind(sim.results.minimal, sim.results.uni.tt, sim.results.screen.tt)
```


# Plots

## Prevalence

```{r}
ingest.file.base = "/gpfs/data/bershteynlab/EMOD/citrod01/MATUMAINI/202301_Nyanza_Baseline_MalariaOngoing_original/Data/calibration_ingest_form_Nyanza.xlsm"

obs.prev.sheet.base <- EMODAnalyzeR::read.ingest.sheet(ingest.file.base, "Obs-Prevalence")
```


```{r, fig.width=8}
data <- EMODAnalyzeR::calculate.prevalence(
  sim.results.all %>% filter(Age <= 50, Age >=15),
         stratify_columns = c("Year", "Gender", "sim.id", "scenario_name"),
         numerator = "Infected",
         denominator = "Population")

data.mean <- data %>% filter(Year >= 2004) %>% 
  group_by(Year, Gender, scenario_name) %>%
  summarize(sum(Infected))

data.mean <- data %>%
    dplyr::group_by(Year, Gender, scenario_name) %>%
    dplyr::summarise(Prevalence = mean(Prevalence), .groups = 'keep') %>% 
  mutate(Gender = case_when(Gender==0 ~ "Male", Gender==1 ~ "Female"))

ggplot(data.mean) +
    geom_line(data=subset(data.mean, (2000 <= Year) & (Year <= 2040)),
              aes(x=Year, y=Prevalence, group=scenario_name, color=scenario_name), linewidth=.75) +
    facet_wrap(~ Gender, ncol=2) +
    xlab("Year")+
    #xlim(c(date.start, date.end)) +
    ylab("Prevalence") +
    theme_bw(base_size=16) +
    guides(fill = guide_legend(keywidth = 2, keyheight = 1)) +
    scale_x_continuous(breaks = seq(1980,2040,10)) +
    theme(legend.position="bottom") +
    theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
    theme(strip.background = element_rect(colour="black", fill="white")) +
    theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
    scale_y_continuous(labels = scales::percent_format(accuracy = 1), breaks = seq(0,0.25,0.05), limits=c(0, 0.25)) +
      ylab("HIV Prevalence (%)") + 
    scale_color_manual(values=c("blue","red","darkgreen","orange")) +
    geom_point(data = obs.prev.sheet.base %>%
                 filter(Province == 'All', AgeBin == "[15:50)", Gender %in% c("Male", "Female")),
               mapping = aes(x = Year, y = Prevalence)) + 
    geom_errorbar(data = obs.prev.sheet.base %>%
               filter(Province == 'All', AgeBin == "[15:50)", Gender %in% c("Male", "Female")),
               mapping = aes(x = Year, ymin = lb, ymax = ub))

# ggsave(filename = "/gpfs/data/bershteynlab/EMOD/citrod01/MATUMAINI/Analysis/treat_HIV_prev.pdf",
#        width = 8, height = 6, units = "in")
```


## Depression

### Depression prevalence

```{r, fig.width=8, fig.height=8}
data.cmd <- sim.results.all %>% filter(Age > 18) %>% 
  mutate(HIVneg = Population - Infected) %>% 
  group_by(Year, Gender, sim.id, IP_Key.CMDStatus, scenario_name) %>% 
  summarize(Population = sum(Population),
            HIVneg = sum(HIVneg),
            Infected = sum(Infected), .groups = 'keep') %>% 
  ungroup() %>% 
  pivot_wider(id_cols = c(Year, Gender, sim.id, scenario_name),
              names_from = c(IP_Key.CMDStatus),
              values_from = c(Population, HIVneg, Infected))  %>% 
  mutate(Population_total = Population_CMD_pos + Population_CMD_neg + Population_CMD_recovered + Population_CMD_treated,
         HIVneg_total = HIVneg_CMD_pos + HIVneg_CMD_neg + HIVneg_CMD_recovered + HIVneg_CMD_treated,
         Infected_total = Infected_CMD_pos + Infected_CMD_neg + Infected_CMD_recovered + Infected_CMD_treated) %>% 
  mutate(CMD_prev_overall = case_when(Population_total == 0 ~ 0,
                                    Population_total > 0 ~ Population_CMD_pos/Population_total),
         CMD_prev_HIVneg = case_when(HIVneg_total == 0 ~ 0,
                                    HIVneg_total > 0 ~ HIVneg_CMD_pos/HIVneg_total),
         CMD_prev_Infected = case_when(Infected_total == 0 ~ 0,
                                    Infected_total > 0 ~ Infected_CMD_pos/Infected_total)) %>% 
  mutate(Gender = case_when(Gender==0 ~ "Male", Gender==1 ~ "Female"))

data.cmd.mean <- data.cmd %>% 
  group_by(Year, Gender, scenario_name) %>%
  summarize(Overall = mean(CMD_prev_overall), Overall_sd = sd(CMD_prev_overall),
            HIVneg = mean(CMD_prev_HIVneg), HIVneg_sd = sd(CMD_prev_HIVneg),
            Infected = mean(CMD_prev_Infected), Infected_sd = sd(CMD_prev_Infected),
            .groups = "keep") %>% 
  ungroup()

# Plot  
p = ggplot() +
  geom_line( data = data.cmd.mean %>% 
                    select(Year, Gender, Overall, Infected, HIVneg, scenario_name) %>% 
                    pivot_longer(cols = c(Overall, Infected, HIVneg),
                                 names_to = "Depression.Prevalence", 
                                 values_to = "CMD_prev"),
    mapping = aes(x = Year, y = CMD_prev, color = Depression.Prevalence), 
    size = 1.0) + 
  scale_y_continuous(limits = c(0.05,.22)) + 
  scale_color_manual(values=c("darkgreen","orange", "black")) +
  facet_wrap(scenario_name ~ Gender, ncol=2) +
  xlab("Year")+ylab("") + 
  ggtitle("Depression Prevalence by HIV status") + 
  theme_bw(base_size=16) +
  guides(fill = guide_legend(keywidth = 2, keyheight = 1)) +
  scale_x_continuous(breaks = seq(1980,2040,10)) +
  theme(legend.position="bottom") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  theme(strip.background = element_rect(colour="black", fill="white")) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())

p

# ggsave(filename = "/gpfs/data/bershteynlab/EMOD/citrod01/MATUMAINI/Analysis/treatment_depression_prev.pdf",
#       width = 8, height = 6, units = "in")
```
### Depression cases

```{r, fig.width=8in}
data <- sim.results.all %>% 
  #mutate(Year = ceiling(Year)) %>% 
  filter(Year >= 1985,
         IP_Key.CMDStatus == "CMD_pos") %>% 
  group_by(Year, Gender, scenario_name) %>% 
  summarize(deps = sum(Population * pop.scaling.factor), 
            .groups = 'keep') %>% 
  mutate(Gender = case_when(Gender==0 ~ "Male", Gender==1 ~ "Female"))

p = ggplot() +
  geom_line( data,
    mapping = aes(x = Year, y = deps, color = scenario_name), 
    size = 1.0) + 
  #scale_y_continuous(limits = c(0.05,.22)) + 
  facet_wrap( ~ Gender, ncol=2) +
  scale_color_manual(values=c("blue","red","darkgreen","orange")) +
  xlab("Year")+ylab("") + 
  ggtitle("Number of depressive episodes") + 
  theme_bw(base_size=16) +
  guides(fill = guide_legend(keywidth = 2, keyheight = 1)) +
  scale_x_continuous(breaks = seq(1980,2040,10)) +
  theme(legend.position="bottom") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  theme(strip.background = element_rect(colour="black", fill="white")) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())

p

# ggsave(filename = "/gpfs/data/bershteynlab/EMOD/citrod01/MATUMAINI/Analysis/treatment_depression_episodes.pdf",
#       width = 8, height = 6, units = "in")
```


## Incidence

### Deaths

```{r, fig.width=8in}
 data <- sim.results.all %>% 
  mutate(Year = ceiling(Year)) %>%
  filter(Year >= 1985, Year <=2040) %>% 
  group_by(Year, Gender, sim.ix, sim.id, scenario_name) %>% 
  summarize(Deaths = sum(Died_from_HIV * pop.scaling.factor), .groups = 'keep') %>%  
  ungroup()

data.mean <- data %>% 
  group_by(Year, Gender, scenario_name) %>% 
  dplyr::summarise(Deaths = mean(Deaths), .groups = 'keep') 

p <- EMODAnalyzeR::emodplot.by_gender(data, 2015, 2040, 
                        "Deaths", title = "HIV deaths") 

p + #scale_y_continuous(labels = scales::percent_format(accuracy = 1)) + 
    ylab("") + 
  #scale_color_manual(values = c("blue","red"))
  scale_color_manual(values = c("blue","red","darkgreen","orange"))

# ggsave(filename = "/gpfs/data/bershteynlab/EMOD/citrod01/MATUMAINI/Analysis/treatment_HIV_deaths.pdf",
#       width = 8, height = 6, units = "in")
```
Deaths by scenario
```{r}
data %>% group_by(Year, Gender, scenario_name) %>% summarize(mean(Deaths)) %>% filter(Year >= 2015)
```

### New cases

```{r, fig.width=8in}
 data <- sim.results.all %>% 
  mutate(Year = ceiling(Year)) %>%
  filter(Year >= 1985, Year <=2040) %>% 
  group_by(Year, Gender, sim.id, sim.ix, scenario_name) %>% 
  summarize(NewCases = sum(Newly.Infected * pop.scaling.factor), .groups = 'keep') %>%  
  ungroup() %>% 
  group_by(Year, Gender, sim.id, sim.ix, scenario_name) %>% 
  summarize(NewCases.sd = sd(NewCases), NewCases = mean(NewCases)) %>% 
  ungroup()# %>% 
  
p <- EMODAnalyzeR::emodplot.by_gender(data, 1990, 2040, 
                        "NewCases", title = "New HIV Infections") 

p + #scale_y_continuous(labels = scales::percent_format(accuracy = 1)) + 
    ylab("") + 
  scale_color_manual(values = c("blue","red","darkgreen","orange"))

# ggsave(filename = "/gpfs/data/bershteynlab/EMOD/citrod01/MATUMAINI/Analysis/treatment_HIV_casdes.pdf",
#       width = 8, height = 6, units = "in")

```

New cases by scenario
```{r}
data %>% group_by(Year, Gender, scenario_name) %>% summarize(mean(NewCases)) %>% filter(Year >= 2015)
```


## ART numbers over time

```{r}
ingest.file.base = "/gpfs/data/bershteynlab/EMOD/citrod01/MATUMAINI/202301_Nyanza_Baseline_MalariaOngoing_original/Data/calibration_ingest_form_Nyanza.xlsm"

obs.onart.sheet <- EMODAnalyzeR::read.ingest.sheet(ingest.file.base, "Obs-OnART")
```


```{r, fig.width=8}
sim.onart <- sim.results.all %>% 
  dplyr::group_by(Year, Gender, sim.id, scenario_name) %>% 
  dplyr::summarize(On_ART = sum(On_ART * pop.scaling.factor), .groups = "keep") %>% 
  ungroup()

p <- EMODAnalyzeR::emodplot.by_gender(sim.onart, 2000, 2025, 
                        "On_ART", title = "Population on ART") + 
    ylab("Number on ART")

p + 
  geom_point(data = obs.onart.sheet %>% 
               filter(Province != "All", 
                      Gender %in% c("Male", "Female"), 
                      AgeBin == "[15:100)") %>%
              group_by(Year, Gender) %>% 
              summarize(OnART = sum(OnART)) %>% ungroup(),
              mapping = aes(x = Year, y = OnART)) + 
  geom_errorbar(data = obs.onart.sheet %>% 
                  filter(Province != "All", 
                         Gender %in% c("Male", "Female"), 
                         AgeBin == "[15:100)") %>%
              group_by(Year, Gender) %>% 
              summarize(OnART = sum(OnART)) %>% ungroup() %>% 
              mutate(lb = OnART - OnART/5,
                     ub = OnART + OnART/5),
              mapping = aes(x = Year, ymin = lb, ymax = ub)) + 
  scale_color_manual(values = c("blue","red","darkgreen","orange"))

# ggsave(filename = "/gpfs/data/bershteynlab/EMOD/citrod01/MATUMAINI/Analysis/treatment_onART.pdf",
#        width = 8, height = 6, units = "in")
```

```{r}
sim.onart.mean <- sim.onart %>% group_by(Year, Gender, scenario_name) %>% summarize(mean(On_ART))

sim.onart.mean %>% filter(Year > 2015)
```

## 90-90-90 

### Diagnosis coverage over time

```{r}
data.diag <- sim.results.all %>% 
  filter(Age >=15) %>% 
  group_by(Year, Gender,sim.id,scenario_name) %>% 
  summarize(Diagnosed = sum(Diagnosed), Infected = sum(Infected), .groups = "keep") %>% 
  ungroup() %>% 
  mutate(Diagnosed = case_when(Infected == 0 ~ 0,
                               Infected > 0 ~ Diagnosed/Infected)) 

p <- EMODAnalyzeR::emodplot.by_gender(data.diag, 2000, 2040, 
                        "Diagnosed", title = "Diagnosed PLHIV") 

p + scale_y_continuous(labels = scales::percent_format(accuracy = 1)) + 
    ylab("% PLHIV Diagnosed") + 
  scale_color_manual(values = c("blue","red", "darkgreen"))

# ggsave(filename = "/gpfs/data/bershteynlab/EMOD/citrod01/MATUMAINI/Analysis/treatment_diagnosed.pdf",
#        width = 8, height = 6, units = "in")
```

```{r}
data.diag.mean <- data.diag %>% group_by(Year ,Gender, scenario_name) %>% summarize(mean(Diagnosed))

data.diag.mean %>% filter(Year > 2015)
```


### ART coverage over time

```{r}
data.artcov <- sim.results.all %>% 
  filter(Age >=15) %>% 
  group_by(Year, Gender,sim.id,scenario_name) %>% 
  summarize(On_ART = sum(On_ART), Diagnosed = sum(Diagnosed), .groups = "keep") %>% 
  ungroup() %>% 
  mutate(On_ART = case_when(On_ART == 0 ~ 0,
                               On_ART > 0 ~ On_ART/Diagnosed)) 

p <- EMODAnalyzeR::emodplot.by_gender(data.artcov, 2000, 2040, 
                        "On_ART", title = "ART Coverage") 

p + scale_y_continuous(labels = scales::percent_format(accuracy = 1)) + 
    ylab("% Diagnosed and On ART") + 
  scale_color_manual(values = c("blue","red", "darkgreen"))

# ggsave(filename = "/gpfs/data/bershteynlab/EMOD/citrod01/MATUMAINI/Analysis/treatment_art_coverage.pdf",
#        width = 8, height = 6, units = "in")
```

```{r}
data.artcov.mean <- data.artcov %>% group_by(Year ,Gender, scenario_name) %>% summarize(mean(On_ART))

data.artcov.mean %>% filter(Year > 2015)
```

## DALY calculations

```{r}
dalys.baseline <-  EMODAnalyzeR::calculate.DALY(sim.results.all %>% 
                                                 mutate(pop_scaling_factor = pop.scaling.factor) %>% 
                                                 filter(scenario_name =="baseline"),
                             infected_weight = 0.274, art_weight = 0.078, discount_start_year = 2023, discount_percent = 0.03, life_expectancy = 80)


dalys.uni.tt <-  EMODAnalyzeR::calculate.DALY(sim.results.all %>% 
                                                 mutate(pop_scaling_factor = pop.scaling.factor) %>% 
                                                 filter(scenario_name =="uni.tt"),
                             infected_weight = 0.274, art_weight = 0.078, discount_start_year = 2023, discount_percent = 0.03, life_expectancy = 80)

dalys.baseline$scenario_name  = "baseline"
dalys.uni.tt$scenario_name = "uni.tt"

dalys <- rbind(dalys.baseline, dalys.uni.tt)

dalys %>% filter(year > 2020) %>% group_by(scenario_name) %>% summarize(sum(daly))
```
```{r}
p = ggplot() +
  geom_line( dalys %>% filter(year >= 2015),
    mapping = aes(x = year, y = daly, color = scenario_name), 
    size = 1.0) + 
  #scale_y_continuous(limits = c(0.05,.22)) + 
  #facet_wrap( ~ Gender, ncol=2) +
  xlab("Year")+ylab("") + 
  ggtitle("HIV-related DALYs by year") + 
  theme_bw(base_size=16) +
  guides(fill = guide_legend(keywidth = 2, keyheight = 1)) +
  scale_x_continuous(breaks = seq(1980,2040,10)) + 
  scale_color_manual(values = c("blue","red")) +
  theme(legend.position="bottom") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  theme(strip.background = element_rect(colour="black", fill="white")) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())

p

ggsave(filename = "/gpfs/data/bershteynlab/EMOD/citrod01/MATUMAINI/Analysis/treatment_dalys.pdf",
       width = 8, height = 6, units = "in")

```

## Person-Years Lived with Depression

Calculate the number of person-years lived with depression
* For the baseline scenario, multiply all of the depressed people by 270/365
* For the treatment scenario, multiply all of hte depressed people by 90/365

```{r}
data <- sim.results.all %>% 
  #mutate(Year = ceiling(Year)) %>% 
  filter(Year >= 1985,
         IP_Key.CMDStatus == "CMD_pos") %>% 
  group_by(Year, Gender, scenario_name) %>% 
  summarize(deps = sum(Population * pop.scaling.factor), 
            .groups = 'keep') %>% 
  mutate(Gender = case_when(Gender==0 ~ "Male", Gender==1 ~ "Female"))


(data %>% filter(scenario_name == "baseline") %>% filter(Year <= 2020) %>% .$deps %>% sum)
(data %>% filter(scenario_name == "baseline") %>% filter(Year > 2020) %>% .$deps %>% sum)*270/365


(data %>% filter(scenario_name == "uni.tt") %>% filter(Year <= 2020) %>% .$deps %>% sum)
(data %>% filter(scenario_name == "uni.tt") %>% filter(Year > 2020) %>% .$deps %>% sum)*90/365
```



